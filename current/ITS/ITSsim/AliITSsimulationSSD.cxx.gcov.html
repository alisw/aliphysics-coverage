<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - ITS/ITSsim/AliITSsimulationSSD.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">ITS/ITSsim</a> - AliITSsimulationSSD.cxx<span style="font-size: 80%;"> (source / <a href="AliITSsimulationSSD.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">266</td>
            <td class="headerCovTableEntry">364</td>
            <td class="headerCovTableEntryLo">73.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">20</td>
            <td class="headerCovTableEntry">34</td>
            <td class="headerCovTableEntryLo">58.8 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : /* $Id$ */
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      19 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      20 </span>            : #include &lt;Riostream.h&gt;
<span class="lineNum">      21 </span>            : #include &lt;TObjArray.h&gt;
<span class="lineNum">      22 </span>            : #include &lt;TRandom.h&gt;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #include &lt;TGeoGlobalMagField.h&gt;
<span class="lineNum">      25 </span>            : #include &quot;AliITSmodule.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;AliITSMapA2.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;AliITSpList.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;AliITSCalibrationSSD.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;AliITSsegmentationSSD.h&quot;
<span class="lineNum">      30 </span>            : //#include &quot;AliITSdcsSSD.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;AliITS.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;AliITShit.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;AliITSdigitSSD.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;AliRun.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;AliMagF.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;AliITSgeom.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;AliITSsimulationSSD.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;AliITSTableSSD.h&quot;
<span class="lineNum">      39 </span>            : #include &lt;TF1.h&gt;
<span class="lineNum">      40 </span>            : #include &quot;AliMathBase.h&quot;
<span class="lineNum">      41 </span>            : 
<a name="42"><span class="lineNum">      42 </span>            : using std::endl;</a>
<span class="lineNum">      43 </span>            : using std::cout;
<span class="lineNum">      44 </span><span class="lineCov">        116 : ClassImp(AliITSsimulationSSD)</span>
<span class="lineNum">      45 </span>            : ////////////////////////////////////////////////////////////////////////
<span class="lineNum">      46 </span>            : //                                                                    //
<span class="lineNum">      47 </span>            : // Author: Enrico Fragiacomo                                          //
<span class="lineNum">      48 </span>            : //         enrico.fragiacomo@ts.infn.it                               //
<span class="lineNum">      49 </span>            : // Last revised: june 2008                                            // 
<span class="lineNum">      50 </span>            : //                                                                    //
<span class="lineNum">      51 </span>            : // AliITSsimulationSSD is the simulation of SSD.                     //
<span class="lineNum">      52 </span>            : ////////////////////////////////////////////////////////////////////////
<a name="53"><span class="lineNum">      53 </span>            : </a>
<span class="lineNum">      54 </span>            : //----------------------------------------------------------------------
<span class="lineNum">      55 </span><span class="lineNoCov">          0 : AliITSsimulationSSD::AliITSsimulationSSD():AliITSsimulation(),</span>
<span class="lineNum">      56 </span>            :                                            //fDCS(0),
<span class="lineNum">      57 </span><span class="lineNoCov">          0 : fMapA2(0),</span>
<span class="lineNum">      58 </span><span class="lineNoCov">          0 : fIonE(0.0),</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 : fDifConst(),</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 : fDriftVel(),</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 : fTimeResponse(NULL),</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 : fLorentz(kFALSE),</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 : fTanLorAngP(0),</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 : fTanLorAngN(0)</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      66 </span>            :     //default Constructor
<span class="lineNum">      67 </span>            :     //Inputs:
<span class="lineNum">      68 </span>            :     // none.
<span class="lineNum">      69 </span>            :     // Outputs:
<span class="lineNum">      70 </span>            :     // none.
<span class="lineNum">      71 </span>            :     // Return:
<span class="lineNum">      72 </span>            :     //  A default construction AliITSsimulationSSD class
<a name="73"><span class="lineNum">      73 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      74 </span>            : //----------------------------------------------------------------------
<span class="lineNum">      75 </span>            : AliITSsimulationSSD::AliITSsimulationSSD(AliITSDetTypeSim* dettyp):
<span class="lineNum">      76 </span><span class="lineCov">          1 : AliITSsimulation(dettyp),</span>
<span class="lineNum">      77 </span>            : //fDCS(0),
<span class="lineNum">      78 </span><span class="lineCov">          1 : fMapA2(0),</span>
<span class="lineNum">      79 </span><span class="lineCov">          1 : fIonE(0.0),</span>
<span class="lineNum">      80 </span><span class="lineCov">          1 : fDifConst(),</span>
<span class="lineNum">      81 </span><span class="lineCov">          1 : fDriftVel(),</span>
<span class="lineNum">      82 </span><span class="lineCov">          1 : fTimeResponse(NULL),</span>
<span class="lineNum">      83 </span><span class="lineCov">          1 : fLorentz(kFALSE),</span>
<span class="lineNum">      84 </span><span class="lineCov">          1 : fTanLorAngP(0),</span>
<span class="lineNum">      85 </span><span class="lineCov">          1 : fTanLorAngN(0)</span>
<span class="lineNum">      86 </span><span class="lineCov">          5 : {</span>
<span class="lineNum">      87 </span>            :     // Constructor 
<span class="lineNum">      88 </span>            :     // Input:
<span class="lineNum">      89 </span>            :     //   AliITSDetTypeSim    Pointer to the SSD dettype to be used
<span class="lineNum">      90 </span>            :     // Outputs:
<span class="lineNum">      91 </span>            :     //   none.
<span class="lineNum">      92 </span>            :     // Return
<span class="lineNum">      93 </span>            :     //   A standard constructed AliITSsimulationSSD class
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineCov">          3 :   fTimeResponse = new TF1(&quot;ftimeresponse&quot;,&quot;.5*x*exp(1.-.5*x)&quot;);</span>
<span class="lineNum">      96 </span><span class="lineCov">          1 :     Init();</span>
<a name="97"><span class="lineNum">      97 </span><span class="lineCov">          2 : }</span></a>
<span class="lineNum">      98 </span>            : //----------------------------------------------------------------------
<span class="lineNum">      99 </span>            : void AliITSsimulationSSD::Init(){
<span class="lineNum">     100 </span>            :   // Inilizer, Inilizes all of the variable as needed in a standard place.
<span class="lineNum">     101 </span>            :   // Input:
<span class="lineNum">     102 </span>            :   //   AliITSsegmentationSSD *seg  Pointer to the SSD segmentation to be used
<span class="lineNum">     103 </span>            :   //   AliITSCalibrationSSD   *resp Pointer to the SSD responce class to be used
<span class="lineNum">     104 </span>            :   // Outputs:
<span class="lineNum">     105 </span>            :   //   none.
<span class="lineNum">     106 </span>            :   // Return
<span class="lineNum">     107 </span>            :   //   none.
<span class="lineNum">     108 </span><span class="lineCov">          2 :   AliITSsegmentationSSD* seg = (AliITSsegmentationSSD*)GetSegmentationModel(2);</span>
<span class="lineNum">     109 </span><span class="lineCov">          1 :   AliITSSimuParam* simpar = fDetType-&gt;GetSimuParam();</span>
<span class="lineNum">     110 </span>            :   
<span class="lineNum">     111 </span><span class="lineCov">          1 :   SetDriftVelocity(); // use default values in .h file</span>
<span class="lineNum">     112 </span><span class="lineCov">          1 :   SetIonizeE();       // use default values in .h file</span>
<span class="lineNum">     113 </span><span class="lineCov">          1 :   SetDiffConst();     // use default values in .h file</span>
<span class="lineNum">     114 </span><span class="lineCov">          3 :   fpList           = new AliITSpList(2,GetNStrips());</span>
<span class="lineNum">     115 </span><span class="lineCov">          2 :   fMapA2           = new AliITSMapA2(seg);</span>
<span class="lineNum">     116 </span><span class="lineCov">          1 :   SetLorentzDrift(simpar-&gt;GetSSDLorentzDrift());</span>
<span class="lineNum">     117 </span><span class="lineCov">          2 :   if (fLorentz) SetTanLorAngle();</span>
<span class="lineNum">     118 </span><span class="lineCov">          1 : }</span>
<a name="119"><span class="lineNum">     119 </span>            : </a>
<span class="lineNum">     120 </span>            : //______________________________________________________________________
<span class="lineNum">     121 </span>            : Bool_t AliITSsimulationSSD::SetTanLorAngle() {
<span class="lineNum">     122 </span>            :     // This function set the Tangent of the Lorentz angles. 
<span class="lineNum">     123 </span>            :     // output: Bool_t : kTRUE in case of success
<span class="lineNum">     124 </span>            :     //
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span><span class="lineCov">          4 :     if(!fDetType) {</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :       AliError(&quot;AliITSsimulationSPD::SetTanLorAngle: AliITSDetTypeSim* fDetType not set &quot;);</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :       return kFALSE;}</span>
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span><span class="lineCov">          2 :     AliITSSimuParam* simpar = fDetType-&gt;GetSimuParam();</span>
<span class="lineNum">     131 </span><span class="lineCov">          2 :     AliMagF* fld = (AliMagF*)TGeoGlobalMagField::Instance()-&gt;GetField();</span>
<span class="lineNum">     132 </span><span class="lineCov">          2 :     if (!fld) AliFatal(&quot;The field is not initialized&quot;);</span>
<span class="lineNum">     133 </span><span class="lineCov">          2 :     Double_t bz = fld-&gt;SolenoidField();</span>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineCov">          2 :     fTanLorAngN = TMath::Tan( simpar-&gt;LorentzAngleElectron(bz) );</span>
<span class="lineNum">     136 </span><span class="lineCov">          2 :     fTanLorAngP = TMath::Tan( simpar-&gt;LorentzAngleHole(bz) );</span>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span>            :     return kTRUE;
<span class="lineNum">     139 </span><span class="lineCov">          2 : }</span>
<a name="140"><span class="lineNum">     140 </span>            : </a>
<span class="lineNum">     141 </span>            : //______________________________________________________________________
<span class="lineNum">     142 </span>            : AliITSsimulationSSD&amp; AliITSsimulationSSD::operator=(
<span class="lineNum">     143 </span>            :                                          const AliITSsimulationSSD &amp;s){
<span class="lineNum">     144 </span>            :   // Operator =
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :   if(this==&amp;s) return *this;</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            :   //  this-&gt;fDCS         = new AliITSdcsSSD(*(s.fDCS));
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :   this-&gt;fMapA2       = s.fMapA2;</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :   this-&gt;fIonE        = s.fIonE;</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   this-&gt;fDifConst[0] = s.fDifConst[0];</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :   this-&gt;fDifConst[1] = s.fDifConst[1];</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   this-&gt;fDriftVel[0] = s.fDriftVel[0];</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   this-&gt;fDriftVel[1] = s.fDriftVel[1];</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   this-&gt;fTimeResponse = s.fTimeResponse;</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   this-&gt;fLorentz   = s.fLorentz;</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   this-&gt;fTanLorAngP = s.fTanLorAngP;</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   this-&gt;fTanLorAngN = s.fTanLorAngN;</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :   return *this;</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     161 </span>            : /*
<span class="lineNum">     162 </span>            : //______________________________________________________________________
<span class="lineNum">     163 </span>            : AliITSsimulation&amp; AliITSsimulationSSD::operator=(
<span class="lineNum">     164 </span>            :                                          const AliITSsimulation &amp;s){
<span class="lineNum">     165 </span>            :   // Operator =
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span>            :   if(this==&amp;s) return *this;
<span class="lineNum">     168 </span>            :   Error(&quot;AliITSsimulationSSD&quot;,&quot;Not allowed to make a = with &quot;
<span class="lineNum">     169 </span>            :         &quot;AliITSsimulationSSD Using default creater instead&quot;);
<span class="lineNum">     170 </span>            :   
<span class="lineNum">     171 </span>            :   return *this;
<span class="lineNum">     172 </span>            : }
<a name="173"><span class="lineNum">     173 </span>            : */</a>
<span class="lineNum">     174 </span>            : //______________________________________________________________________
<span class="lineNum">     175 </span>            : AliITSsimulationSSD::AliITSsimulationSSD(const AliITSsimulationSSD &amp;source):
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     AliITSsimulation(source),</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 : fMapA2(source.fMapA2),</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 : fIonE(source.fIonE),</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 : fDifConst(),</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 : fDriftVel(),</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 : fTimeResponse(source.fTimeResponse),</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 : fLorentz(source.fLorentz),</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 : fTanLorAngP(source.fTanLorAngP),</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 : fTanLorAngN(source.fTanLorAngN)</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     186 </span>            :   // copy constructor
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   fDifConst[0] = source.fDifConst[0];</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   fDifConst[1] = source.fDifConst[1];</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :   fDriftVel[0] = source.fDriftVel[0];</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :   fDriftVel[1] = source.fDriftVel[1];</span>
<a name="191"><span class="lineNum">     191 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     192 </span>            : //______________________________________________________________________
<span class="lineNum">     193 </span><span class="lineCov">          6 : AliITSsimulationSSD::~AliITSsimulationSSD() {</span>
<span class="lineNum">     194 </span>            :   // destructor
<span class="lineNum">     195 </span><span class="lineCov">          2 :   delete fMapA2;</span>
<span class="lineNum">     196 </span><span class="lineCov">          2 :   delete fTimeResponse;</span>
<span class="lineNum">     197 </span>            :   //delete fDCS;
<a name="198"><span class="lineNum">     198 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">     199 </span>            : //______________________________________________________________________
<span class="lineNum">     200 </span>            : void AliITSsimulationSSD::InitSimulationModule(Int_t module,Int_t event){
<span class="lineNum">     201 </span>            :     // Creates maps to build the list of tracks for each sumable digit
<span class="lineNum">     202 </span>            :     // Inputs:
<span class="lineNum">     203 </span>            :     //   Int_t module    // Module number to be simulated
<span class="lineNum">     204 </span>            :     //   Int_t event     // Event number to be simulated
<span class="lineNum">     205 </span>            :     // Outputs:
<span class="lineNum">     206 </span>            :     //   none.
<span class="lineNum">     207 </span>            :     // Return
<span class="lineNum">     208 </span>            :     //    none.
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :     SetModuleNumber(module);</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :     SetEventNumber(event);</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :     fMapA2-&gt;ClearMap();</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     fpList-&gt;ClearMap();</span>
<a name="214"><span class="lineNum">     214 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     215 </span>            : //______________________________________________________________________
<span class="lineNum">     216 </span>            : void AliITSsimulationSSD::FinishSDigitiseModule(){
<span class="lineNum">     217 </span>            :     // Does the Sdigits to Digits work
<span class="lineNum">     218 </span>            :     // Inputs:
<span class="lineNum">     219 </span>            :     //   none.
<span class="lineNum">     220 </span>            :     // Outputs:
<span class="lineNum">     221 </span>            :     //   none.
<span class="lineNum">     222 </span>            :     // Return:
<span class="lineNum">     223 </span>            :     //   none.
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :   FillMapFrompList(fpList);  // need to check if needed here or not????</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   SDigitToDigit(fModule,fpList);</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :   fpList-&gt;ClearMap();</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   fMapA2-&gt;ClearMap();</span>
<a name="229"><span class="lineNum">     229 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     230 </span>            : //______________________________________________________________________
<span class="lineNum">     231 </span>            : void AliITSsimulationSSD::DigitiseModule(AliITSmodule *mod,Int_t,Int_t) {
<span class="lineNum">     232 </span>            :   // Digitizes hits for one SSD module
<span class="lineNum">     233 </span><span class="lineCov">      13584 :   SetModuleNumber(mod-&gt;GetIndex());</span>
<span class="lineNum">     234 </span>            :   
<span class="lineNum">     235 </span><span class="lineCov">       6792 :   HitsToAnalogDigits(mod,fpList);</span>
<span class="lineNum">     236 </span><span class="lineCov">       6792 :   SDigitToDigit(GetModuleNumber(),fpList);</span>
<span class="lineNum">     237 </span>            :   
<span class="lineNum">     238 </span><span class="lineCov">       6792 :   fpList-&gt;ClearMap();</span>
<span class="lineNum">     239 </span><span class="lineCov">       6792 :   fMapA2-&gt;ClearMap();</span>
<a name="240"><span class="lineNum">     240 </span><span class="lineCov">       6792 : }</span></a>
<span class="lineNum">     241 </span>            : //______________________________________________________________________
<span class="lineNum">     242 </span>            : void AliITSsimulationSSD::SDigitiseModule(AliITSmodule *mod,Int_t,Int_t) {
<span class="lineNum">     243 </span>            :   // Produces Summable/Analog digits and writes them to the SDigit tree. 
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :     HitsToAnalogDigits(mod,fpList);</span>
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     WriteSDigits(fpList);</span>
<span class="lineNum">     248 </span>            :     
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :     fpList-&gt;ClearMap();</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :     fMapA2-&gt;ClearMap();</span>
<a name="251"><span class="lineNum">     251 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     252 </span>            : //______________________________________________________________________
<span class="lineNum">     253 </span>            : void AliITSsimulationSSD::SDigitToDigit(Int_t module,AliITSpList *pList){
<span class="lineNum">     254 </span>            :   // Takes the pList and finishes the digitization.
<span class="lineNum">     255 </span>            :   
<span class="lineNum">     256 </span><span class="lineCov">      13584 :   ApplyNoise(pList,module);</span>
<span class="lineNum">     257 </span><span class="lineCov">       6792 :   ApplyCoupling(pList,module);</span>
<span class="lineNum">     258 </span><span class="lineCov">       6792 :   ApplyDeadChannels(module);</span>
<span class="lineNum">     259 </span>            :   
<span class="lineNum">     260 </span><span class="lineCov">       6792 :   ChargeToSignal(module,pList);</span>
<a name="261"><span class="lineNum">     261 </span><span class="lineCov">       6792 : }</span></a>
<span class="lineNum">     262 </span>            : //______________________________________________________________________
<span class="lineNum">     263 </span>            : void AliITSsimulationSSD::HitsToAnalogDigits(AliITSmodule *mod,
<span class="lineNum">     264 </span>            :                                              AliITSpList *pList){
<span class="lineNum">     265 </span>            :     // Loops over all hits to produce Analog/floating point digits. This
<span class="lineNum">     266 </span>            :     // is also the first task in producing standard digits.
<span class="lineNum">     267 </span>            :   Int_t lasttrack     = -2;
<span class="lineNum">     268 </span><span class="lineCov">      13584 :   Int_t idtrack       = -2;</span>
<span class="lineNum">     269 </span><span class="lineCov">       6792 :   Double_t x0=0.0, y0=0.0, z0=0.0;</span>
<span class="lineNum">     270 </span><span class="lineCov">       6792 :   Double_t x1=0.0, y1=0.0, z1=0.0;</span>
<span class="lineNum">     271 </span><span class="lineCov">       6792 :   Double_t de=0.0;</span>
<span class="lineNum">     272 </span><span class="lineCov">       6792 :   Int_t module = mod-&gt;GetIndex();</span>
<span class="lineNum">     273 </span>            :   Double_t tof = 0.;
<span class="lineNum">     274 </span>            :   
<span class="lineNum">     275 </span>            :   
<span class="lineNum">     276 </span><span class="lineCov">       6792 :   AliITSsegmentationSSD* seg = (AliITSsegmentationSSD*)GetSegmentationModel(2);</span>
<span class="lineNum">     277 </span>            :   
<span class="lineNum">     278 </span><span class="lineCov">       6792 :   TObjArray *hits = mod-&gt;GetHits();</span>
<span class="lineNum">     279 </span><span class="lineCov">       6792 :   Int_t nhits     = hits-&gt;GetEntriesFast();</span>
<span class="lineNum">     280 </span><span class="lineCov">      13429 :   if (nhits&lt;=0) return;</span>
<span class="lineNum">     281 </span><span class="lineCov">        310 :   AliITSTableSSD * tav = new AliITSTableSSD(GetNStrips());</span>
<span class="lineNum">     282 </span><span class="lineCov">        155 :   module = mod-&gt;GetIndex();</span>
<span class="lineNum">     283 </span><span class="lineCov">        236 :   if ( mod-&gt;GetLayer() == 6 ) seg-&gt;SetLayer(6);</span>
<span class="lineNum">     284 </span><span class="lineCov">        229 :   if ( mod-&gt;GetLayer() == 5 ) seg-&gt;SetLayer(5);</span>
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span><span class="lineCov">       1256 :   for(Int_t i=0; i&lt;nhits; i++) {    </span>
<span class="lineNum">     287 </span>            :     // LineSegmentL returns 0 if the hit is entering
<span class="lineNum">     288 </span>            :     // If hits is exiting returns positions of entering and exiting hits
<span class="lineNum">     289 </span>            :     // Returns also energy loss
<span class="lineNum">     290 </span><span class="lineCov">        473 :     if(GetDebug(4)){</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :       cout &lt;&lt; i &lt;&lt; &quot; &quot;;</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :       cout &lt;&lt; mod-&gt;GetHit(i)-&gt;GetXL() &lt;&lt; &quot; &quot;&lt;&lt;mod-&gt;GetHit(i)-&gt;GetYL();</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :       cout &lt;&lt; &quot; &quot; &lt;&lt; mod-&gt;GetHit(i)-&gt;GetZL();</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :       cout &lt;&lt; endl;</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :     } // end if</span>
<span class="lineNum">     296 </span><span class="lineCov">        473 :     if (mod-&gt;LineSegmentL(i, x0, x1, y0, y1, z0, z1, de, idtrack)) {</span>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span>            :       // Scale down dE/dx according to the hit's TOF wrt to the trigger
<span class="lineNum">     299 </span>            :       // Necessary for pileup simulation
<span class="lineNum">     300 </span>            :       // EF - 21/04/09
<span class="lineNum">     301 </span><span class="lineCov">        473 :       tof = mod-&gt;GetHit(i)-&gt;GetTOF();</span>
<span class="lineNum">     302 </span><span class="lineCov">        473 :       tof *= 1.E+6; // convert time in microsecond</span>
<span class="lineNum">     303 </span><span class="lineCov">        946 :       if(tof&lt;2.) de = de * fTimeResponse-&gt;Eval(-1.*tof+2.);</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :       else de = 0.;</span>
<span class="lineNum">     305 </span>            :       //
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineCov">        473 :       HitToDigit(module, x0, y0, z0, x1, y1, z1, de,tav);</span>
<span class="lineNum">     308 </span><span class="lineCov">        733 :       if (lasttrack != idtrack || i==(nhits-1)) {</span>
<span class="lineNum">     309 </span><span class="lineCov">        257 :         GetList(idtrack,i,module,pList,tav);</span>
<span class="lineNum">     310 </span><span class="lineCov">        257 :       } // end if</span>
<span class="lineNum">     311 </span><span class="lineCov">        473 :       lasttrack=idtrack;</span>
<span class="lineNum">     312 </span><span class="lineCov">        473 :     } // end if</span>
<span class="lineNum">     313 </span>            :   }  // end loop over hits
<span class="lineNum">     314 </span><span class="lineCov">        310 :   delete tav; tav=0;</span>
<span class="lineNum">     315 </span>            :   return;
<a name="316"><span class="lineNum">     316 </span><span class="lineCov">       6792 : }</span></a>
<span class="lineNum">     317 </span>            : //----------------------------------------------------------------------
<span class="lineNum">     318 </span>            : void AliITSsimulationSSD::HitToDigit(Int_t module, Double_t x0, Double_t y0, 
<span class="lineNum">     319 </span>            :                                      Double_t z0, Double_t x1, Double_t y1, 
<span class="lineNum">     320 </span>            :                                      Double_t z1, Double_t de,
<span class="lineNum">     321 </span>            :                                      AliITSTableSSD *tav) {
<span class="lineNum">     322 </span>            :   
<span class="lineNum">     323 </span>            :   // hit to digit conversion
<span class="lineNum">     324 </span>            :   
<span class="lineNum">     325 </span><span class="lineCov">        946 :   AliITSsegmentationSSD* seg = (AliITSsegmentationSSD*)GetSegmentationModel(2);</span>
<span class="lineNum">     326 </span>            :   // Turns hits in SSD module into one or more digits.
<span class="lineNum">     327 </span>            :   //Float_t tang[2] = {0.0,0.0};
<span class="lineNum">     328 </span>            :   //seg-&gt;Angles(tang[0], tang[1]);//stereo&lt;&lt;-&gt;tan(stereo)~=stereo
<span class="lineNum">     329 </span>            :   Double_t x, y, z;
<span class="lineNum">     330 </span><span class="lineCov">        473 :   Double_t dex=0.0, dey=0.0, dez=0.0; </span>
<span class="lineNum">     331 </span>            :   Double_t pairs; // pair generation energy per step.
<span class="lineNum">     332 </span><span class="lineCov">        473 :   Double_t sigma[2] = {0.,0.};// standard deviation of the diffusion gaussian</span>
<span class="lineNum">     333 </span><span class="lineCov">        473 :   Double_t tdrift[2] = {0.,0.}; // time of drift</span>
<span class="lineNum">     334 </span>            :   Double_t w;
<span class="lineNum">     335 </span><span class="lineCov">        473 :   Double_t inf[2], sup[2], par0[2];                 </span>
<span class="lineNum">     336 </span>            :  
<span class="lineNum">     337 </span>            :   // Set up corrections for Lorentz drift (ExB)
<span class="lineNum">     338 </span><span class="lineCov">        473 :   Double_t tanLorAngP = fTanLorAngP;</span>
<span class="lineNum">     339 </span><span class="lineCov">        473 :   Double_t tanLorAngN = fTanLorAngN;</span>
<span class="lineNum">     340 </span><span class="lineCov">        473 :   if(seg-&gt;GetLayer()==6) {</span>
<span class="lineNum">     341 </span><span class="lineCov">        263 :     tanLorAngP = -1.*fTanLorAngP;</span>
<span class="lineNum">     342 </span><span class="lineCov">        263 :     tanLorAngN = -1.*fTanLorAngN;</span>
<span class="lineNum">     343 </span><span class="lineCov">        263 :   }</span>
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span>            :   // Steps in the module are determined &quot;manually&quot; (i.e. No Geant)
<span class="lineNum">     346 </span>            :   // NumOfSteps divide path between entering and exiting hits in steps 
<span class="lineNum">     347 </span><span class="lineCov">        473 :   Int_t numOfSteps = NumOfSteps(x1, y1, z1, dex, dey, dez);</span>
<span class="lineNum">     348 </span>            :   // Enery loss is equally distributed among steps
<span class="lineNum">     349 </span><span class="lineCov">        473 :   de    = de/numOfSteps;</span>
<span class="lineNum">     350 </span><span class="lineCov">        473 :   pairs = de/GetIonizeE(); // e-h pairs generated</span>
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span>            :   //-----------------------------------------------------
<span class="lineNum">     353 </span>            :   // stepping
<span class="lineNum">     354 </span>            :   //-----------------------------------------------------
<span class="lineNum">     355 </span><span class="lineCov">       5721 :   for(Int_t j=0; j&lt;numOfSteps; j++) {     // stepping</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span><span class="lineCov">       2187 :     x = x0 + (j+0.5)*dex;</span>
<span class="lineNum">     358 </span><span class="lineCov">       2187 :     y = y0 + (j+0.5)*dey;</span>
<span class="lineNum">     359 </span><span class="lineCov">       2187 :     if ( y &gt; (seg-&gt;Dy()/2+10)*1.0E-4 ) {</span>
<span class="lineNum">     360 </span>            :       // check if particle is within the detector
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :       Warning(&quot;HitToDigit&quot;,</span>
<span class="lineNum">     362 </span>            :               &quot;hit out of detector y0=%e,y=%e,dey=%e,j =%d module=%d,  exceed=%e&quot;,
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :               y0,y,dey,j,module, y-(seg-&gt;Dy()/2+10)*1.0E-4);</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     365 </span>            :     } // end if
<span class="lineNum">     366 </span><span class="lineCov">       2187 :     z = z0 + (j+0.5)*dez;</span>
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span><span class="lineCov">       2187 :     if(GetDebug(4)) cout &lt;&lt;&quot;HitToDigit &quot;&lt;&lt;x&lt;&lt;&quot; &quot;&lt;&lt;y&lt;&lt;&quot; &quot;&lt;&lt;z&lt;&lt; &quot; &quot;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :                          &lt;&lt;dex&lt;&lt;&quot; &quot;&lt;&lt;dey&lt;&lt;&quot; &quot;&lt;&lt;dez&lt;&lt;endl;</span>
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span><span class="lineCov">       2187 :     if(seg-&gt;GetLayer()==6) {</span>
<span class="lineNum">     372 </span><span class="lineCov">       1140 :       y=-y; // Lay6 module has sensor up-side-down!!!</span>
<span class="lineNum">     373 </span><span class="lineCov">       1140 :     }</span>
<span class="lineNum">     374 </span>            :     
<span class="lineNum">     375 </span>            :     Int_t k;
<span class="lineNum">     376 </span>            :     //---------------------------------------------------------
<span class="lineNum">     377 </span>            :     // Pside
<span class="lineNum">     378 </span>            :     //------------------------------------------------------------
<span class="lineNum">     379 </span>            :     k=0;
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span>            :     // w is the coord. perpendicular to the strips
<span class="lineNum">     382 </span>            :     //    Float_t xp=x*1.e+4,zp=z*1.e+4; // microns    
<span class="lineNum">     383 </span><span class="lineCov">       2187 :     Float_t xp=x,zp=z; </span>
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span>            :     // correction for the Lorentz's angle
<span class="lineNum">     386 </span><span class="lineCov">       2187 :     if(fLorentz) {</span>
<span class="lineNum">     387 </span><span class="lineCov">       2187 :       Float_t deltaxp = (y+(seg-&gt;Dy()*1.0E-4)/2)*tanLorAngP;</span>
<span class="lineNum">     388 </span><span class="lineCov">       2187 :       xp+=deltaxp;  </span>
<span class="lineNum">     389 </span><span class="lineCov">       2187 :     }</span>
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span><span class="lineCov">       2187 :     seg-&gt;GetPadTxz(xp,zp);</span>
<span class="lineNum">     392 </span>            :     
<span class="lineNum">     393 </span>            :     // calculate drift time
<span class="lineNum">     394 </span>            :     // y is the minimum path
<span class="lineNum">     395 </span><span class="lineCov">       2187 :     tdrift[0] = (y+(seg-&gt;Dy()*1.0E-4)/2)/GetDriftVelocity(0);</span>
<span class="lineNum">     396 </span>            :     
<span class="lineNum">     397 </span><span class="lineCov">       2187 :     w = xp; // P side strip number</span>
<span class="lineNum">     398 </span>            :     
<span class="lineNum">     399 </span><span class="lineCov">       4374 :     if((w&lt;(-0.5)) || (w&gt;(GetNStrips()-0.5))) {</span>
<span class="lineNum">     400 </span>            :       // this check rejects hits in regions not covered by strips
<span class="lineNum">     401 </span>            :       // 0.5 takes into account boundaries 
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :       if(GetDebug(4)) cout &lt;&lt; &quot;Dead SSD region, x,z=&quot;&lt;&lt;x&lt;&lt;&quot;,&quot;&lt;&lt;z&lt;&lt;endl;</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :       return; // There are dead region on the SSD sensitive volume!!!</span>
<span class="lineNum">     404 </span>            :     } // end if
<span class="lineNum">     405 </span>            :     // sigma is the standard deviation of the diffusion gaussian
<span class="lineNum">     406 </span><span class="lineCov">       2192 :     if(tdrift[k]&lt;0) return;</span>
<span class="lineNum">     407 </span>            :     
<span class="lineNum">     408 </span><span class="lineCov">       2182 :     sigma[k] = TMath::Sqrt(2*GetDiffConst(k)*tdrift[k]);</span>
<span class="lineNum">     409 </span><span class="lineCov">       2182 :     sigma[k] /= (GetStripPitch()*1.0E-4);  //units of Pitch</span>
<span class="lineNum">     410 </span>            :     
<span class="lineNum">     411 </span><span class="lineCov">       2182 :     if(sigma[k]==0.0) {         </span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :       Error(&quot;HitToDigit&quot;,&quot; sigma[%d]=0&quot;,k);</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :       exit(0);</span>
<span class="lineNum">     414 </span>            :     } // end if
<span class="lineNum">     415 </span>            :     
<span class="lineNum">     416 </span><span class="lineCov">       2182 :     par0[k] = pairs;</span>
<span class="lineNum">     417 </span>            :     // we integrate the diffusion gaussian from -3sigma to 3sigma 
<span class="lineNum">     418 </span><span class="lineCov">       2182 :     inf[k] = w - 3*sigma[k]; // 3 sigma from the gaussian average  </span>
<span class="lineNum">     419 </span><span class="lineCov">       2182 :     sup[k] = w + 3*sigma[k]; // 3 sigma from the gaussian average</span>
<span class="lineNum">     420 </span>            :     // IntegrateGaussian does the actual
<span class="lineNum">     421 </span>            :     // integration of diffusion gaussian
<span class="lineNum">     422 </span><span class="lineCov">       2182 :     IntegrateGaussian(k, par0[k], w, sigma[k], inf[k], sup[k],tav);</span>
<span class="lineNum">     423 </span>            :     
<span class="lineNum">     424 </span>            :     //------------------------------------------------------
<span class="lineNum">     425 </span>            :     // end Pside
<span class="lineNum">     426 </span>            :     //-------------------------------------------------------
<span class="lineNum">     427 </span>            :     
<span class="lineNum">     428 </span>            :     //------------------------------------------------------
<span class="lineNum">     429 </span>            :     // Nside
<span class="lineNum">     430 </span>            :     //-------------------------------------------------------
<span class="lineNum">     431 </span>            :     k=1;
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span><span class="lineCov">       2182 :     xp=x; zp=z; </span>
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span>            :     // correction for the Lorentz's angle
<span class="lineNum">     436 </span><span class="lineCov">       2182 :     if(fLorentz) {</span>
<span class="lineNum">     437 </span><span class="lineCov">       2182 :       Float_t deltaxn = ((seg-&gt;Dy()*1.0E-4)/2-y)*tanLorAngN;</span>
<span class="lineNum">     438 </span><span class="lineCov">       2182 :       xp+=deltaxn;</span>
<span class="lineNum">     439 </span><span class="lineCov">       2182 :     }</span>
<span class="lineNum">     440 </span>            :     
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineCov">       2182 :     seg-&gt;GetPadTxz(xp,zp);</span>
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span><span class="lineCov">       2182 :     tdrift[1] = ((seg-&gt;Dy()*1.0E-4)/2-y)/GetDriftVelocity(1);</span>
<span class="lineNum">     445 </span>            :     
<span class="lineNum">     446 </span>            :     //tang[k]=TMath::Tan(tang[k]);
<span class="lineNum">     447 </span>            :     
<span class="lineNum">     448 </span><span class="lineCov">       2182 :     w = zp; // N side strip number</span>
<span class="lineNum">     449 </span>            :     
<span class="lineNum">     450 </span><span class="lineCov">       4359 :     if((w&lt;(-0.5)) || (w&gt;(GetNStrips()-0.5))) {</span>
<span class="lineNum">     451 </span>            :       // this check rejects hits in regions not covered by strips
<span class="lineNum">     452 </span>            :       // 0.5 takes into account boundaries 
<span class="lineNum">     453 </span><span class="lineCov">         11 :       if(GetDebug(4)) cout &lt;&lt; &quot;Dead SSD region, x,z=&quot;&lt;&lt;x&lt;&lt;&quot;,&quot;&lt;&lt;z&lt;&lt;endl;</span>
<span class="lineNum">     454 </span><span class="lineCov">         11 :       return; // There are dead region on the SSD sensitive volume.</span>
<span class="lineNum">     455 </span>            :     } // end if
<span class="lineNum">     456 </span>            :     
<span class="lineNum">     457 </span>            :       // sigma is the standard deviation of the diffusion gaussian
<span class="lineNum">     458 </span><span class="lineCov">       2179 :     if(tdrift[k]&lt;0) return;</span>
<span class="lineNum">     459 </span>            :     
<span class="lineNum">     460 </span><span class="lineCov">       2163 :     sigma[k] = TMath::Sqrt(2*GetDiffConst(k)*tdrift[k]);</span>
<span class="lineNum">     461 </span><span class="lineCov">       2163 :     sigma[k] /= (GetStripPitch()*1.0E-4);  //units of Pitch</span>
<span class="lineNum">     462 </span>            :     
<span class="lineNum">     463 </span><span class="lineCov">       2163 :     if(sigma[k]==0.0) {         </span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :       Error(&quot;HitToDigit&quot;,&quot; sigma[%d]=0&quot;,k);</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :       exit(0);</span>
<span class="lineNum">     466 </span>            :     } // end if
<span class="lineNum">     467 </span>            :     
<span class="lineNum">     468 </span><span class="lineCov">       2163 :     par0[k] = pairs;</span>
<span class="lineNum">     469 </span>            :     // we integrate the diffusion gaussian from -3sigma to 3sigma 
<span class="lineNum">     470 </span><span class="lineCov">       2163 :     inf[k] = w - 3*sigma[k]; // 3 sigma from the gaussian average  </span>
<span class="lineNum">     471 </span><span class="lineCov">       2163 :     sup[k] = w + 3*sigma[k]; // 3 sigma from the gaussian average</span>
<span class="lineNum">     472 </span>            :     // IntegrateGaussian does the actual
<span class="lineNum">     473 </span>            :     // integration of diffusion gaussian
<span class="lineNum">     474 </span><span class="lineCov">       2163 :     IntegrateGaussian(k, par0[k], w, sigma[k], inf[k], sup[k],tav);</span>
<span class="lineNum">     475 </span>            :     
<span class="lineNum">     476 </span>            :     //-------------------------------------------------
<span class="lineNum">     477 </span>            :     // end Nside
<span class="lineNum">     478 </span>            :     //-------------------------------------------------
<span class="lineNum">     479 </span>            :     
<span class="lineNum">     480 </span>            :     
<span class="lineNum">     481 </span><span class="lineCov">       4350 :   } // end stepping</span>
<span class="lineNum">     482 </span><span class="lineCov">        922 : }</span>
<a name="483"><span class="lineNum">     483 </span>            : </a>
<span class="lineNum">     484 </span>            : //______________________________________________________________________
<span class="lineNum">     485 </span>            : void AliITSsimulationSSD::ApplyNoise(AliITSpList *pList,Int_t module){
<span class="lineNum">     486 </span>            :   // Apply Noise.
<span class="lineNum">     487 </span>            :   Int_t ix;
<span class="lineNum">     488 </span>            :   Double_t signal,noise;
<span class="lineNum">     489 </span><span class="lineCov">      13584 :   AliITSCalibrationSSD* res =(AliITSCalibrationSSD*)GetCalibrationModel(module);</span>
<span class="lineNum">     490 </span>            :    
<span class="lineNum">     491 </span>            :   // Pside
<span class="lineNum">     492 </span><span class="lineCov">   10446096 :   for(ix=0;ix&lt;GetNStrips();ix++){      // loop over strips</span>
<span class="lineNum">     493 </span>            :     
<span class="lineNum">     494 </span>            :     // noise is gaussian
<span class="lineNum">     495 </span><span class="lineCov">    5216256 :     noise  = (Double_t) gRandom-&gt;Gaus(0,res-&gt;GetNoiseP(ix));</span>
<span class="lineNum">     496 </span>            :     
<span class="lineNum">     497 </span>            :     // need to calibrate noise 
<span class="lineNum">     498 </span>            :     // NOTE. noise from the calibration database comes uncalibrated, 
<span class="lineNum">     499 </span>            :     // it needs to be calibrated in order to be added
<span class="lineNum">     500 </span>            :     // to the signal. It will be decalibrated later on together with the noise    
<span class="lineNum">     501 </span><span class="lineCov">    5216256 :     noise *= (Double_t) res-&gt;GetGainP(ix); </span>
<span class="lineNum">     502 </span>            :     
<span class="lineNum">     503 </span>            :     // noise comes in ADC channels from the calibration database
<span class="lineNum">     504 </span>            :     // It needs to be converted back to electronVolts
<span class="lineNum">     505 </span><span class="lineCov">    5216256 :     noise /= res-&gt;GetSSDDEvToADC(1.);</span>
<span class="lineNum">     506 </span>            :     
<span class="lineNum">     507 </span>            :     // Finally, noise is added to the signal
<span class="lineNum">     508 </span><span class="lineCov">    5216256 :     signal = noise + fMapA2-&gt;GetSignal(0,ix);//get signal from map</span>
<span class="lineNum">     509 </span><span class="lineCov">    5216256 :     fMapA2-&gt;SetHit(0,ix,signal); // give back signal to map</span>
<span class="lineNum">     510 </span><span class="lineCov">    7703635 :     if(signal&gt;0.0) pList-&gt;AddNoise(0,ix,module,noise);</span>
<span class="lineNum">     511 </span>            :   } // loop over strip 
<span class="lineNum">     512 </span>            :   
<span class="lineNum">     513 </span>            :     // Nside
<span class="lineNum">     514 </span><span class="lineCov">   10446096 :   for(ix=0;ix&lt;GetNStrips();ix++){      // loop over strips</span>
<span class="lineNum">     515 </span><span class="lineCov">    5216256 :     noise  = (Double_t) gRandom-&gt;Gaus(0,res-&gt;GetNoiseN(ix));// give noise to signal</span>
<span class="lineNum">     516 </span><span class="lineCov">    5216256 :     noise *= (Double_t) res-&gt;GetGainN(ix); </span>
<span class="lineNum">     517 </span><span class="lineCov">    5216256 :     noise /= res-&gt;GetSSDDEvToADC(1.);</span>
<span class="lineNum">     518 </span><span class="lineCov">    5216256 :     signal = noise + fMapA2-&gt;GetSignal(1,ix);//get signal from map</span>
<span class="lineNum">     519 </span><span class="lineCov">    5216256 :     fMapA2-&gt;SetHit(1,ix,signal); // give back signal to map</span>
<span class="lineNum">     520 </span><span class="lineCov">    7703561 :     if(signal&gt;0.0) pList-&gt;AddNoise(1,ix,module,noise);</span>
<span class="lineNum">     521 </span>            :   } // loop over strip 
<span class="lineNum">     522 </span>            :   
<a name="523"><span class="lineNum">     523 </span><span class="lineCov">       6792 : }</span></a>
<span class="lineNum">     524 </span>            : //______________________________________________________________________
<span class="lineNum">     525 </span>            : void AliITSsimulationSSD::ApplyCoupling(AliITSpList *pList,Int_t module) {
<span class="lineNum">     526 </span>            :   // Apply the effect of electronic coupling between channels
<span class="lineNum">     527 </span>            :   Int_t ix;
<span class="lineNum">     528 </span>            :   Double_t signal=0;
<span class="lineNum">     529 </span>            :   //AliITSCalibrationSSD* res =(AliITSCalibrationSSD*)GetCalibrationModel(module);
<span class="lineNum">     530 </span><span class="lineCov">      13584 :   AliITSSimuParam* res = fDetType-&gt;GetSimuParam();</span>
<span class="lineNum">     531 </span>            :     
<span class="lineNum">     532 </span><span class="lineCov">       6792 :   Double_t *contrLeft  = new Double_t[GetNStrips()];</span>
<span class="lineNum">     533 </span><span class="lineCov">       6792 :   Double_t *contrRight = new Double_t[GetNStrips()];</span>
<span class="lineNum">     534 </span>            :   
<span class="lineNum">     535 </span>            :   // P side coupling
<span class="lineNum">     536 </span><span class="lineCov">   10446096 :   for(ix=0;ix&lt;GetNStrips();ix++){</span>
<span class="lineNum">     537 </span><span class="lineCov">   10425720 :     if(ix&gt;0) contrLeft[ix] = fMapA2-&gt;GetSignal(0,ix-1)*res-&gt;GetSSDCouplingPL();</span>
<span class="lineNum">     538 </span><span class="lineCov">       6792 :     else contrLeft[ix] = 0.0;</span>
<span class="lineNum">     539 </span><span class="lineCov">   10425720 :     if(ix&lt;(GetNStrips()-1)) contrRight[ix] = fMapA2-&gt;GetSignal(0,ix+1)*res-&gt;GetSSDCouplingPR();</span>
<span class="lineNum">     540 </span><span class="lineCov">       6792 :     else contrRight[ix] = 0.0;</span>
<span class="lineNum">     541 </span>            :   } // loop over strips 
<span class="lineNum">     542 </span>            :   
<span class="lineNum">     543 </span><span class="lineCov">   10446096 :   for(ix=0;ix&lt;GetNStrips();ix++){</span>
<span class="lineNum">     544 </span><span class="lineCov">    5216256 :     signal = contrLeft[ix] + contrRight[ix] - res-&gt;GetSSDCouplingPL() * fMapA2-&gt;GetSignal(0,ix)</span>
<span class="lineNum">     545 </span><span class="lineCov">    5216256 :       - res-&gt;GetSSDCouplingPR() * fMapA2-&gt;GetSignal(0,ix);</span>
<span class="lineNum">     546 </span><span class="lineCov">    5216256 :     fMapA2-&gt;AddSignal(0,ix,signal);</span>
<span class="lineNum">     547 </span><span class="lineCov">    7711341 :     if(signal&gt;0.0) pList-&gt;AddNoise(0,ix,module,signal);</span>
<span class="lineNum">     548 </span>            :   } // loop over strips 
<span class="lineNum">     549 </span>            :   
<span class="lineNum">     550 </span>            :   // N side coupling
<span class="lineNum">     551 </span><span class="lineCov">   10446096 :   for(ix=0;ix&lt;GetNStrips();ix++){</span>
<span class="lineNum">     552 </span><span class="lineCov">   10425720 :     if(ix&gt;0) contrLeft[ix] = fMapA2-&gt;GetSignal(1,ix-1)*res-&gt;GetSSDCouplingNL();</span>
<span class="lineNum">     553 </span><span class="lineCov">       6792 :     else contrLeft[ix] = 0.0;</span>
<span class="lineNum">     554 </span><span class="lineCov">   10425720 :     if(ix&lt;(GetNStrips()-1)) contrRight[ix] = fMapA2-&gt;GetSignal(1,ix+1)*res-&gt;GetSSDCouplingNR();</span>
<span class="lineNum">     555 </span><span class="lineCov">       6792 :     else contrRight[ix] = 0.0;</span>
<span class="lineNum">     556 </span>            :   } // loop over strips 
<span class="lineNum">     557 </span>            :   
<span class="lineNum">     558 </span><span class="lineCov">   10446096 :   for(ix=0;ix&lt;GetNStrips();ix++){</span>
<span class="lineNum">     559 </span><span class="lineCov">    5216256 :     signal = contrLeft[ix] + contrRight[ix] - res-&gt;GetSSDCouplingNL() * fMapA2-&gt;GetSignal(0,ix)</span>
<span class="lineNum">     560 </span><span class="lineCov">    5216256 :       - res-&gt;GetSSDCouplingNR() * fMapA2-&gt;GetSignal(0,ix);</span>
<span class="lineNum">     561 </span><span class="lineCov">    5216256 :     fMapA2-&gt;AddSignal(1,ix,signal);</span>
<span class="lineNum">     562 </span><span class="lineCov">    7742833 :     if(signal&gt;0.0) pList-&gt;AddNoise(1,ix,module,signal);</span>
<span class="lineNum">     563 </span>            :   } // loop over strips 
<span class="lineNum">     564 </span>            :   
<span class="lineNum">     565 </span>            : 
<span class="lineNum">     566 </span><span class="lineCov">      13584 :   delete [] contrLeft;</span>
<span class="lineNum">     567 </span><span class="lineCov">      13584 :   delete [] contrRight; </span>
<span class="lineNum">     568 </span><span class="lineCov">       6792 : }</span>
<a name="569"><span class="lineNum">     569 </span>            : </a>
<span class="lineNum">     570 </span>            : //______________________________________________________________________
<span class="lineNum">     571 </span>            : void AliITSsimulationSSD::ApplyDeadChannels(Int_t module) {
<span class="lineNum">     572 </span>            :   // Kill dead channels setting gain to zero
<span class="lineNum">     573 </span>            : 
<span class="lineNum">     574 </span><span class="lineCov">      13584 :   AliITSCalibrationSSD* res = (AliITSCalibrationSSD*)GetCalibrationModel(module);</span>
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span><span class="lineCov">   10446096 :   for(Int_t i=0;i&lt;GetNStrips();i++){</span>
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span><span class="lineCov">    5543396 :     if(res-&gt;IsPChannelBad(i)) res-&gt;SetGainP(i,0.0);</span>
<span class="lineNum">     579 </span><span class="lineCov">    5535644 :     if(res-&gt;IsNChannelBad(i)) res-&gt;SetGainN(i,0.0);</span>
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span>            :   } // loop over strips 
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span><span class="lineCov">       6792 : }</span>
<a name="584"><span class="lineNum">     584 </span>            : </a>
<span class="lineNum">     585 </span>            : //______________________________________________________________________
<span class="lineNum">     586 </span>            : Float_t AliITSsimulationSSD::F(Float_t av, Float_t x, Float_t s) {
<span class="lineNum">     587 </span>            :     // Computes the integral of a gaussian using Error Function
<span class="lineNum">     588 </span><span class="lineCov">      13752 :     Float_t sqrt2 = TMath::Sqrt(2.0);</span>
<span class="lineNum">     589 </span><span class="lineCov">       6876 :     Float_t sigm2 = sqrt2*s;</span>
<span class="lineNum">     590 </span>            :     Float_t integral;
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineCov">       6876 :     integral = 0.5 * AliMathBase::ErfFast( (x - av) / sigm2);</span>
<span class="lineNum">     593 </span><span class="lineCov">       6876 :     return integral;</span>
<a name="594"><span class="lineNum">     594 </span>            : }</a>
<span class="lineNum">     595 </span>            : //______________________________________________________________________
<span class="lineNum">     596 </span>            : void AliITSsimulationSSD::IntegrateGaussian(Int_t k,Double_t par, Double_t w,
<span class="lineNum">     597 </span>            :                                             Double_t sigma, 
<span class="lineNum">     598 </span>            :                                             Double_t inf, Double_t sup,
<span class="lineNum">     599 </span>            :                                             AliITSTableSSD *tav) {
<span class="lineNum">     600 </span>            :     // integrate the diffusion gaussian
<span class="lineNum">     601 </span>            :     // remind: inf and sup are w-3sigma and w+3sigma
<span class="lineNum">     602 </span>            :     //         we could define them here instead of passing them
<span class="lineNum">     603 </span>            :     //         this way we are free to introduce asimmetry
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span>            :     Double_t a=0.0, b=0.0;
<span class="lineNum">     606 </span>            :     Double_t dXCharge1 = 0.0, dXCharge2 = 0.0;
<span class="lineNum">     607 </span>            :     // dXCharge1 and 2 are the charge to two neighbouring strips
<span class="lineNum">     608 </span>            :     // Watch that we only involve at least two strips
<span class="lineNum">     609 </span>            :     // Numbers greater than 2 of strips in a cluster depend on
<span class="lineNum">     610 </span>            :     //  geometry of the track and delta rays, not charge diffusion!   
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span><span class="lineCov">       8690 :     Double_t strip = TMath::Floor(w);         // closest strip on the left</span>
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineCov">       4345 :     if ( TMath::Abs((strip - w)) &lt; 0.5) { </span>
<span class="lineNum">     615 </span>            :         // gaussian mean is closer to strip on the left
<span class="lineNum">     616 </span>            :         a = inf;                         // integration starting point
<span class="lineNum">     617 </span><span class="lineCov">       2203 :         if((strip+0.5)&lt;=sup) {</span>
<span class="lineNum">     618 </span>            :             // this means that the tail of the gaussian goes beyond
<span class="lineNum">     619 </span>            :             // the middle point between strips ---&gt; part of the signal
<span class="lineNum">     620 </span>            :             // is given to the strip on the right
<span class="lineNum">     621 </span>            :             b = strip + 0.5;               // integration stopping point
<span class="lineNum">     622 </span><span class="lineCov">        919 :             dXCharge1 = F( w, b, sigma) - F(w, a, sigma);</span>
<span class="lineNum">     623 </span><span class="lineCov">        919 :             dXCharge2 = F( w, sup, sigma) - F(w ,b, sigma); </span>
<span class="lineNum">     624 </span><span class="lineCov">        919 :         }else { </span>
<span class="lineNum">     625 </span>            :             // this means that all the charge is given to the strip on the left
<span class="lineNum">     626 </span>            :             b = sup;
<span class="lineNum">     627 </span>            :             dXCharge1 = 0.9973;   // gaussian integral at 3 sigmas
<span class="lineNum">     628 </span>            :             dXCharge2 = 0.0;
<span class="lineNum">     629 </span>            :         } // end if
<span class="lineNum">     630 </span><span class="lineCov">       2203 :         dXCharge1 = par * dXCharge1;// normalize by mean of number of carriers</span>
<span class="lineNum">     631 </span><span class="lineCov">       2203 :         dXCharge2 = par * dXCharge2;</span>
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span>            :         // for the time being, signal is the charge
<span class="lineNum">     634 </span>            :         // in ChargeToSignal signal is converted in ADC channel
<span class="lineNum">     635 </span><span class="lineCov">       2203 :         fMapA2-&gt;AddSignal(k,(Int_t)strip,dXCharge1);</span>
<span class="lineNum">     636 </span><span class="lineCov">       2203 :         tav-&gt;Add(k,(Int_t)strip);</span>
<span class="lineNum">     637 </span><span class="lineCov">       2203 :         if(((Int_t) strip) &lt; (GetNStrips()-1)) {</span>
<span class="lineNum">     638 </span>            :             // strip doesn't have to be the last (remind: last=GetNStrips()-1)
<span class="lineNum">     639 </span>            :             // otherwise part of the charge is lost
<span class="lineNum">     640 </span><span class="lineCov">       2203 :             fMapA2-&gt;AddSignal(k,((Int_t)strip+1),dXCharge2);</span>
<span class="lineNum">     641 </span><span class="lineCov">       2203 :             tav-&gt;Add(k,((Int_t)(strip+1)));</span>
<span class="lineNum">     642 </span><span class="lineCov">       2203 :         } // end if</span>
<span class="lineNum">     643 </span>            :     }else{
<span class="lineNum">     644 </span>            :         // gaussian mean is closer to strip on the right
<span class="lineNum">     645 </span><span class="lineCov">       2142 :         strip++;     // move to strip on the rigth</span>
<span class="lineNum">     646 </span>            :         b = sup;     // now you know where to stop integrating
<span class="lineNum">     647 </span><span class="lineCov">       2142 :         if((strip-0.5)&gt;=inf) { </span>
<span class="lineNum">     648 </span>            :             // tail of diffusion gaussian on the left goes left of
<span class="lineNum">     649 </span>            :             // middle point between strips
<span class="lineNum">     650 </span>            :             a = strip - 0.5;        // integration starting point
<span class="lineNum">     651 </span><span class="lineCov">        800 :             dXCharge1 = F(w, b, sigma) - F(w, a, sigma);</span>
<span class="lineNum">     652 </span><span class="lineCov">        800 :             dXCharge2 = F(w, a, sigma) - F(w, inf, sigma);</span>
<span class="lineNum">     653 </span><span class="lineCov">        800 :         }else {</span>
<span class="lineNum">     654 </span>            :             a = inf;
<span class="lineNum">     655 </span>            :             dXCharge1 = 0.9973;   // gaussian integral at 3 sigmas
<span class="lineNum">     656 </span>            :             dXCharge2 = 0.0;
<span class="lineNum">     657 </span>            :         } // end if
<span class="lineNum">     658 </span><span class="lineCov">       2142 :         dXCharge1 = par * dXCharge1;    // normalize by means of carriers</span>
<span class="lineNum">     659 </span><span class="lineCov">       2142 :         dXCharge2 = par * dXCharge2;</span>
<span class="lineNum">     660 </span>            :         // for the time being, signal is the charge
<span class="lineNum">     661 </span>            :         // in ChargeToSignal signal is converted in ADC channel
<span class="lineNum">     662 </span><span class="lineCov">       2142 :         fMapA2-&gt;AddSignal(k,(Int_t)strip,dXCharge1);</span>
<span class="lineNum">     663 </span><span class="lineCov">       2142 :         tav-&gt;Add(k,(Int_t)strip);</span>
<span class="lineNum">     664 </span><span class="lineCov">       2142 :         if(((Int_t) strip) &gt; 0) {</span>
<span class="lineNum">     665 </span>            :             // strip doesn't have to be the first
<span class="lineNum">     666 </span>            :             // otherwise part of the charge is lost
<span class="lineNum">     667 </span><span class="lineCov">       2142 :             fMapA2-&gt;AddSignal(k,((Int_t)strip-1),dXCharge2);</span>
<span class="lineNum">     668 </span><span class="lineCov">       2142 :             tav-&gt;Add(k,((Int_t)(strip-1)));</span>
<span class="lineNum">     669 </span><span class="lineCov">       2142 :         } // end if</span>
<span class="lineNum">     670 </span>            :     } // end if
<a name="671"><span class="lineNum">     671 </span><span class="lineCov">       4345 : }</span></a>
<span class="lineNum">     672 </span>            : //______________________________________________________________________
<span class="lineNum">     673 </span>            : Int_t AliITSsimulationSSD::NumOfSteps(Double_t x, Double_t y, Double_t z,
<span class="lineNum">     674 </span>            :                                       Double_t &amp;dex,Double_t &amp;dey,
<span class="lineNum">     675 </span>            :                                       Double_t &amp;dez){
<span class="lineNum">     676 </span>            :     // number of steps
<span class="lineNum">     677 </span>            :     // it also returns steps for each coord
<span class="lineNum">     678 </span>            :     //AliITSsegmentationSSD *seg = new AliITSsegmentationSSD();
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span>            :     Double_t step = 25E-4;
<span class="lineNum">     681 </span>            :     //step = (Double_t) seg-&gt;GetStepSize();  // step size (cm)
<span class="lineNum">     682 </span><span class="lineCov">        946 :     Int_t numOfSteps = (Int_t) (TMath::Sqrt(x*x+y*y+z*z)/step); </span>
<span class="lineNum">     683 </span>            : 
<span class="lineNum">     684 </span><span class="lineCov">        473 :     if (numOfSteps &lt; 1) numOfSteps = 1;       // one step, at least</span>
<span class="lineNum">     685 </span>            :     //numOfSteps=1;
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span>            :     // we could condition the stepping depending on the incident angle
<span class="lineNum">     688 </span>            :     // of the track
<span class="lineNum">     689 </span><span class="lineCov">        473 :     dex = x/numOfSteps;</span>
<span class="lineNum">     690 </span><span class="lineCov">        473 :     dey = y/numOfSteps;</span>
<span class="lineNum">     691 </span><span class="lineCov">        473 :     dez = z/numOfSteps;</span>
<span class="lineNum">     692 </span>            :     
<span class="lineNum">     693 </span><span class="lineCov">        473 :     return numOfSteps;</span>
<a name="694"><span class="lineNum">     694 </span>            : }</a>
<span class="lineNum">     695 </span>            : //----------------------------------------------------------------------
<span class="lineNum">     696 </span>            : void AliITSsimulationSSD::GetList(Int_t label,Int_t hit,Int_t mod,
<span class="lineNum">     697 </span>            :                                   AliITSpList *pList,AliITSTableSSD *tav) {
<span class="lineNum">     698 </span>            :     // loop over nonzero digits
<span class="lineNum">     699 </span>            :     Int_t ix,i;
<span class="lineNum">     700 </span>            :     Double_t signal=0.;
<span class="lineNum">     701 </span>            : 
<span class="lineNum">     702 </span><span class="lineCov">       1799 :     for(Int_t k=0; k&lt;2; k++) {</span>
<span class="lineNum">     703 </span><span class="lineCov">        514 :         ix=tav-&gt;Use(k);</span>
<span class="lineNum">     704 </span><span class="lineCov">       3081 :         while(ix&gt;-1){</span>
<span class="lineNum">     705 </span><span class="lineCov">       1162 :             signal = fMapA2-&gt;GetSignal(k,ix);</span>
<span class="lineNum">     706 </span><span class="lineCov">       1162 :             if(signal==0.0) {</span>
<span class="lineNum">     707 </span><span class="lineCov">        271 :                 ix=tav-&gt;Use(k);</span>
<span class="lineNum">     708 </span><span class="lineCov">        271 :                 continue;</span>
<span class="lineNum">     709 </span>            :             } // end if signal==0.0
<span class="lineNum">     710 </span>            :             // check the signal magnitude
<span class="lineNum">     711 </span><span class="lineCov">       7302 :             for(i=0;i&lt;pList-&gt;GetNSignals(k,ix);i++){</span>
<span class="lineNum">     712 </span><span class="lineCov">       2760 :                 signal -= pList-&gt;GetTSignal(k,ix,i);</span>
<span class="lineNum">     713 </span>            :             } // end for i
<span class="lineNum">     714 </span>            :             //  compare the new signal with already existing list
<span class="lineNum">     715 </span><span class="lineCov">       1755 :             if(signal&gt;0)pList-&gt;AddSignal(k,ix,label,hit,mod,signal);</span>
<span class="lineNum">     716 </span><span class="lineCov">        891 :             ix=tav-&gt;Use(k);</span>
<span class="lineNum">     717 </span>            :         } // end of loop on strips
<span class="lineNum">     718 </span>            :     } // end of loop on P/N side
<span class="lineNum">     719 </span><span class="lineCov">        257 :     tav-&gt;Clear();</span>
<a name="720"><span class="lineNum">     720 </span><span class="lineCov">        257 : }</span></a>
<span class="lineNum">     721 </span>            : //----------------------------------------------------------------------
<span class="lineNum">     722 </span>            : void AliITSsimulationSSD::ChargeToSignal(Int_t module,const AliITSpList *pList) {
<span class="lineNum">     723 </span>            :     // charge to signal
<span class="lineNum">     724 </span><span class="lineCov">      13587 :     static AliITS *aliITS = (AliITS*)gAlice-&gt;GetModule(&quot;ITS&quot;);</span>
<span class="lineNum">     725 </span>            :     Float_t threshold = 0.;
<span class="lineNum">     726 </span><span class="lineCov">       6792 :     Int_t size = AliITSdigitSSD::GetNTracks();</span>
<span class="lineNum">     727 </span><span class="lineCov">       6792 :     Int_t * digits = new Int_t[size];</span>
<span class="lineNum">     728 </span><span class="lineCov">       6792 :     Int_t * tracks = new Int_t[size];</span>
<span class="lineNum">     729 </span><span class="lineCov">       6792 :     Int_t * hits = new Int_t[size];</span>
<span class="lineNum">     730 </span>            :     Int_t j1;
<span class="lineNum">     731 </span><span class="lineCov">       6792 :     Float_t charges[3] = {0.0,0.0,0.0};</span>
<span class="lineNum">     732 </span>            :     Float_t signal;
<span class="lineNum">     733 </span><span class="lineCov">       6792 :     AliITSCalibrationSSD* res =(AliITSCalibrationSSD*)GetCalibrationModel(module);</span>
<span class="lineNum">     734 </span><span class="lineCov">       6792 :     AliITSSimuParam* simpar = fDetType-&gt;GetSimuParam();</span>
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span><span class="lineCov">      40752 :     for(Int_t k=0;k&lt;2;k++){         // both sides (0=Pside, 1=Nside)</span>
<span class="lineNum">     737 </span><span class="lineCov">   20892192 :       for(Int_t ix=0;ix&lt;GetNStrips();ix++){     // loop over strips</span>
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span>            :         // if strip is dead -&gt; gain=0
<span class="lineNum">     740 </span><span class="lineCov">   30970396 :         if( ((k==0)&amp;&amp;(res-&gt;GetGainP(ix)==0)) || ((k==1)&amp;&amp;(res-&gt;GetGainN(ix)==0))) continue;</span>
<span class="lineNum">     741 </span>            :         
<span class="lineNum">     742 </span><span class="lineCov">    9785984 :         signal = fMapA2-&gt;GetSignal(k,ix);</span>
<span class="lineNum">     743 </span>            :         // signal has to be uncalibrated
<span class="lineNum">     744 </span>            :         // In real life, gains are supposed to be calculated from calibration runs,
<span class="lineNum">     745 </span>            :         // stored in the calibration DB and used in the reconstruction
<span class="lineNum">     746 </span>            :         // (see AliITSClusterFinderSSD.cxx)
<span class="lineNum">     747 </span><span class="lineCov">   14675100 :         if(k==0) signal /= res-&gt;GetGainP(ix);</span>
<span class="lineNum">     748 </span><span class="lineCov">    4896868 :         else signal /= res-&gt;GetGainN(ix);</span>
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span>            :         // signal is converted in unit of ADC
<span class="lineNum">     751 </span><span class="lineCov">    9785984 :         signal = res-&gt;GetSSDDEvToADC(signal);</span>
<span class="lineNum">     752 </span><span class="lineCov">    9785984 :         if(signal&gt;4095.) signal = 4095.;//if exceeding, accumulate last one</span>
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span>            :         // threshold for zero suppression is set on the basis of the noise
<span class="lineNum">     755 </span>            :         // A good value is 3*sigma_noise
<span class="lineNum">     756 </span><span class="lineCov">   14675100 :         if(k==0) threshold = res-&gt;GetNoiseP(ix);</span>
<span class="lineNum">     757 </span><span class="lineCov">    4896868 :         else threshold = res-&gt;GetNoiseN(ix);</span>
<span class="lineNum">     758 </span>            : 
<span class="lineNum">     759 </span><span class="lineCov">    9785984 :         threshold *= simpar-&gt;GetSSDZSThreshold(); // threshold at 3 sigma noise</span>
<span class="lineNum">     760 </span>            : 
<span class="lineNum">     761 </span><span class="lineCov">    9785984 :         if(signal &lt; threshold) continue;</span>
<span class="lineNum">     762 </span>            :         //cout&lt;&lt;signal&lt;&lt;&quot; &quot;&lt;&lt;threshold&lt;&lt;endl;
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span><span class="lineCov">      12465 :         digits[0] = k;</span>
<span class="lineNum">     765 </span><span class="lineCov">      12465 :         digits[1] = ix;</span>
<span class="lineNum">     766 </span><span class="lineCov">      12465 :         digits[2] = TMath::Nint(signal);</span>
<span class="lineNum">     767 </span><span class="lineCov">     398880 :         for(j1=0;j1&lt;size;j1++)if(j1&lt;pList-&gt;GetNEntries()){</span>
<span class="lineNum">     768 </span>            :           // only three in digit.
<span class="lineNum">     769 </span><span class="lineCov">     124650 :           tracks[j1]  = pList-&gt;GetTrack(k,ix,j1);</span>
<span class="lineNum">     770 </span><span class="lineCov">     124650 :           hits[j1]    = pList-&gt;GetHit(k,ix,j1);</span>
<span class="lineNum">     771 </span><span class="lineCov">     124650 :         }else{</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :           tracks[j1]  = -3;</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :           hits[j1]    = -1;</span>
<span class="lineNum">     774 </span>            :         } // end for j1
<span class="lineNum">     775 </span>            :         // finally add digit
<span class="lineNum">     776 </span><span class="lineCov">      12465 :         aliITS-&gt;AddSimDigit(2,0,digits,tracks,hits,charges);</span>
<span class="lineNum">     777 </span><span class="lineCov">      12465 :       } // end for ix</span>
<span class="lineNum">     778 </span>            :     } // end for k
<span class="lineNum">     779 </span><span class="lineCov">      13584 :     delete [] digits;</span>
<span class="lineNum">     780 </span><span class="lineCov">      13584 :     delete [] tracks;</span>
<span class="lineNum">     781 </span><span class="lineCov">      13584 :     delete [] hits;</span>
<a name="782"><span class="lineNum">     782 </span><span class="lineCov">       6792 : }</span></a>
<span class="lineNum">     783 </span>            : //______________________________________________________________________
<span class="lineNum">     784 </span>            : void AliITSsimulationSSD::WriteSDigits(AliITSpList *pList){
<span class="lineNum">     785 </span>            :     // Fills the Summable digits Tree
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :     Int_t i,ni,j,nj;</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :     static AliITS *aliITS = (AliITS*)gAlice-&gt;GetModule(&quot;ITS&quot;);</span>
<span class="lineNum">     788 </span>            : 
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :     pList-&gt;GetMaxMapIndex(ni,nj);</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;ni;i++)for(j=0;j&lt;nj;j++){</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :         if(pList-&gt;GetSignalOnly(i,j)&gt;0.0){</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :             aliITS-&gt;AddSumDigit(*(pList-&gt;GetpListItem(i,j)));</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :             if(GetDebug(4)) cout &lt;&lt; &quot;pListSSD: &quot;&lt;&lt;*(pList-&gt;GetpListItem(i,j))</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :                                 &lt;&lt; endl;</span>
<span class="lineNum">     795 </span>            :         } // end if
<span class="lineNum">     796 </span>            :     } // end for i,j
<span class="lineNum">     797 </span>            :   return;
<a name="798"><span class="lineNum">     798 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     799 </span>            : //______________________________________________________________________
<span class="lineNum">     800 </span>            : void AliITSsimulationSSD::FillMapFrompList(AliITSpList *pList){
<span class="lineNum">     801 </span>            :     // Fills fMap2A from the pList of Summable digits
<span class="lineNum">     802 </span>            :     Int_t k,ix;
<span class="lineNum">     803 </span>            : 
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :     for(k=0;k&lt;2;k++)for(ix=0;ix&lt;GetNStrips();ix++) </span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :         fMapA2-&gt;AddSignal(k,ix,pList-&gt;GetSignal(k,ix));</span>
<span class="lineNum">     806 </span>            :     return;
<a name="807"><span class="lineNum">     807 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     808 </span>            : //______________________________________________________________________
<span class="lineNum">     809 </span>            : void AliITSsimulationSSD::Print(ostream *os){
<span class="lineNum">     810 </span>            :     //Standard output format for this class
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span>            :     //AliITSsimulation::Print(os);
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :     *os &lt;&lt; fIonE &lt;&lt;&quot;,&quot;;</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :     *os &lt;&lt; fDifConst[0] &lt;&lt;&quot;,&quot;&lt;&lt; fDifConst[1] &lt;&lt;&quot;,&quot;;</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :     *os &lt;&lt; fDriftVel[0] &lt;&lt;&quot;,&quot;&lt;&lt; fDriftVel[1];</span>
<span class="lineNum">     816 </span>            :     //*os &lt;&lt;&quot;,&quot;; fDCS-&gt;Print(os);
<span class="lineNum">     817 </span>            :     //*os &lt;&lt;&quot;,&quot;; fMapA2-&gt;Print(os);
<a name="818"><span class="lineNum">     818 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     819 </span>            : //______________________________________________________________________
<span class="lineNum">     820 </span>            : void AliITSsimulationSSD::Read(istream *is){
<span class="lineNum">     821 </span>            :     // Standard output streaming function.
<span class="lineNum">     822 </span>            : 
<span class="lineNum">     823 </span>            :     //AliITSsimulation::Read(is);
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :     *is &gt;&gt; fIonE;</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :     *is &gt;&gt; fDifConst[0] &gt;&gt; fDifConst[1];</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :     *is &gt;&gt; fDriftVel[0] &gt;&gt; fDriftVel[1];</span>
<span class="lineNum">     827 </span>            :     //fDCS-&gt;Read(is);
<span class="lineNum">     828 </span>            :     //fMapA2-&gt;Read(is);
<a name="829"><span class="lineNum">     829 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     830 </span>            : //______________________________________________________________________
<span class="lineNum">     831 </span>            : ostream &amp;operator&lt;&lt;(ostream &amp;os,AliITSsimulationSSD &amp;source){
<span class="lineNum">     832 </span>            :     // Standard output streaming function.
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :     source.Print(&amp;os);</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :     return os;</span>
<a name="836"><span class="lineNum">     836 </span>            : }</a>
<span class="lineNum">     837 </span>            : //______________________________________________________________________
<span class="lineNum">     838 </span>            : istream &amp;operator&gt;&gt;(istream &amp;os,AliITSsimulationSSD &amp;source){
<span class="lineNum">     839 </span>            :     // Standard output streaming function.
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :     source.Read(&amp;os);</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :     return os;</span>
<span class="lineNum">     843 </span>            : }
<span class="lineNum">     844 </span>            : //______________________________________________________________________
<span class="lineNum">     845 </span>            : 
<span class="lineNum">     846 </span>            : 
<span class="lineNum">     847 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
