<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - ITS/ITSbase/AliITStrackerSA.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">ITS/ITSbase</a> - AliITStrackerSA.cxx<span style="font-size: 80%;"> (source / <a href="AliITStrackerSA.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">500</td>
            <td class="headerCovTableEntry">640</td>
            <td class="headerCovTableEntryMed">78.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">26</td>
            <td class="headerCovTableEntry">29</td>
            <td class="headerCovTableEntryMed">89.7 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-2003, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : /* $Id$ */
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : ///////////////////////////////////////////////////////////
<span class="lineNum">      19 </span>            : //  Stand alone ITS tracker class                        //
<span class="lineNum">      20 </span>            : //  Origin:  Elisabetta Crescio - crescio@to.infn.it     //
<span class="lineNum">      21 </span>            : //  Updated: Francesco Prino    - prino@to.infn.it       //
<span class="lineNum">      22 </span>            : ///////////////////////////////////////////////////////////
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;TArrayI.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;TBranch.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;TObjArray.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;TTree.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;TStopwatch.h&gt;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : #include &quot;AliESDEvent.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;AliESDVertex.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;AliESDtrack.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;AliITSVertexer.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;AliITSclusterTable.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;AliITSRecPoint.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;AliITSgeomTGeo.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;AliITStrackSA.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;AliITStrackerSA.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;AliITSReconstructor.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;AliLog.h&quot;
<a name="43"><span class="lineNum">      43 </span>            : #include &quot;AliRun.h&quot;</a>
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span><span class="lineCov">        118 : ClassImp(AliITStrackerSA)</span>
<a name="46"><span class="lineNum">      46 </span>            : </a>
<span class="lineNum">      47 </span>            : //____________________________________________________________________________
<span class="lineNum">      48 </span><span class="lineNoCov">          0 : AliITStrackerSA::AliITStrackerSA():AliITStrackerMI(),</span>
<span class="lineNum">      49 </span><span class="lineNoCov">          0 : fPhiEstimate(0),</span>
<span class="lineNum">      50 </span><span class="lineNoCov">          0 : fITSStandAlone(0),</span>
<span class="lineNum">      51 </span><span class="lineNoCov">          0 : fLambdac(0),</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 : fPhic(0),</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 : fCoef1(0),</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 : fCoef2(0),</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 : fCoef3(0),</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 : fNloop(0),</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 : fPhiWin(0),</span>
<span class="lineNum">      58 </span><span class="lineNoCov">          0 : fLambdaWin(0),</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 : fListOfTracks(0),</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 : fListOfSATracks(0),</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 : fITSclusters(0),</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 : fInwardFlag(0),</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 : fOuterStartLayer(0),</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 : fInnerStartLayer(5),</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 : fMinNPoints(0),</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 : fMinQ(0.),</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 : fCluCoord(0){</span>
<span class="lineNum">      68 </span>            :   // Default constructor
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :   Init();</span>
<span class="lineNum">      70 </span>            :  
<a name="71"><span class="lineNum">      71 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      72 </span>            : //____________________________________________________________________________
<span class="lineNum">      73 </span><span class="lineCov">          2 : AliITStrackerSA::AliITStrackerSA(const Char_t *geom):AliITStrackerMI(0),</span>
<span class="lineNum">      74 </span><span class="lineCov">          2 : fPhiEstimate(0),</span>
<span class="lineNum">      75 </span><span class="lineCov">          2 : fITSStandAlone(0),</span>
<span class="lineNum">      76 </span><span class="lineCov">          2 : fLambdac(0),</span>
<span class="lineNum">      77 </span><span class="lineCov">          2 : fPhic(0),</span>
<span class="lineNum">      78 </span><span class="lineCov">          2 : fCoef1(0),</span>
<span class="lineNum">      79 </span><span class="lineCov">          2 : fCoef2(0),</span>
<span class="lineNum">      80 </span><span class="lineCov">          2 : fCoef3(0),</span>
<span class="lineNum">      81 </span><span class="lineCov">          2 : fNloop(0),</span>
<span class="lineNum">      82 </span><span class="lineCov">          2 : fPhiWin(0),</span>
<span class="lineNum">      83 </span><span class="lineCov">          2 : fLambdaWin(0),</span>
<span class="lineNum">      84 </span><span class="lineCov">          2 : fListOfTracks(0),</span>
<span class="lineNum">      85 </span><span class="lineCov">          2 : fListOfSATracks(0),</span>
<span class="lineNum">      86 </span><span class="lineCov">          2 : fITSclusters(0),</span>
<span class="lineNum">      87 </span><span class="lineCov">          2 : fInwardFlag(0),</span>
<span class="lineNum">      88 </span><span class="lineCov">          2 : fOuterStartLayer(0),</span>
<span class="lineNum">      89 </span><span class="lineCov">          2 : fInnerStartLayer(5),</span>
<span class="lineNum">      90 </span><span class="lineCov">          2 : fMinNPoints(0),</span>
<span class="lineNum">      91 </span><span class="lineCov">          2 : fMinQ(0.),</span>
<span class="lineNum">      92 </span><span class="lineCov">          2 : fCluCoord(0) </span>
<span class="lineNum">      93 </span><span class="lineCov">         10 : {</span>
<span class="lineNum">      94 </span>            :   // Standard constructor (Vertex is known and passed to this obj.)
<span class="lineNum">      95 </span><span class="lineCov">          2 :   if (geom) {</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :     AliWarning(&quot;\&quot;geom\&quot; is actually a dummy argument !&quot;);</span>
<span class="lineNum">      97 </span>            :   }
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineCov">          2 :   Init();</span>
<span class="lineNum">     100 </span>            :  
<span class="lineNum">     101 </span><span class="lineCov">          4 : }</span>
<a name="102"><span class="lineNum">     102 </span>            : </a>
<span class="lineNum">     103 </span>            : //____________________________________________________________________________
<span class="lineNum">     104 </span><span class="lineCov">         12 : AliITStrackerSA::~AliITStrackerSA(){</span>
<span class="lineNum">     105 </span>            :   // destructor
<span class="lineNum">     106 </span>            :  
<span class="lineNum">     107 </span><span class="lineCov">          6 :   if(fPhiWin)delete []fPhiWin;</span>
<span class="lineNum">     108 </span><span class="lineCov">          6 :   if(fLambdaWin)delete []fLambdaWin;</span>
<span class="lineNum">     109 </span><span class="lineCov">          2 :   fListOfTracks-&gt;Delete();</span>
<span class="lineNum">     110 </span><span class="lineCov">          4 :   delete fListOfTracks;</span>
<span class="lineNum">     111 </span><span class="lineCov">          2 :   fListOfSATracks-&gt;Delete();</span>
<span class="lineNum">     112 </span><span class="lineCov">          4 :   delete fListOfSATracks;</span>
<span class="lineNum">     113 </span><span class="lineCov">          2 :   if(fCluCoord){</span>
<span class="lineNum">     114 </span><span class="lineCov">         28 :     for(Int_t i=0;i&lt;AliITSgeomTGeo::GetNLayers();i++){</span>
<span class="lineNum">     115 </span><span class="lineCov">         12 :       if(fCluCoord[i]){</span>
<span class="lineNum">     116 </span><span class="lineCov">         12 :         fCluCoord[i]-&gt;Delete();</span>
<span class="lineNum">     117 </span><span class="lineCov">         24 :         delete fCluCoord[i];</span>
<span class="lineNum">     118 </span>            :       }
<span class="lineNum">     119 </span>            :     }
<span class="lineNum">     120 </span><span class="lineCov">          4 :     delete [] fCluCoord;</span>
<span class="lineNum">     121 </span>            :   }
<span class="lineNum">     122 </span><span class="lineCov">          6 : }</span>
<a name="123"><span class="lineNum">     123 </span>            : </a>
<span class="lineNum">     124 </span>            : //____________________________________________________________________________
<span class="lineNum">     125 </span>            : Int_t AliITStrackerSA::Clusters2Tracks(AliESDEvent *event){
<span class="lineNum">     126 </span>            : // This method is used to find and fit the tracks. By default the corresponding
<span class="lineNum">     127 </span>            : // method in the parent class is invoked. In this way a combined tracking
<span class="lineNum">     128 </span>            : // TPC+ITS is performed. If the flag fITSStandAlone is true, the tracking
<span class="lineNum">     129 </span>            : // is done in the ITS only. In the standard reconstruction chain this option
<span class="lineNum">     130 </span>            : // can be set via AliReconstruction::SetOption(&quot;ITS&quot;,&quot;onlyITS&quot;)
<span class="lineNum">     131 </span>            :   Int_t rc=0;
<span class="lineNum">     132 </span><span class="lineCov">         16 :   TStopwatch sw;</span>
<span class="lineNum">     133 </span><span class="lineCov">          8 :   ConfigureTrackFinding();</span>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineCov">          8 :   if(!fITSStandAlone){</span>
<span class="lineNum">     136 </span><span class="lineCov">          8 :     sw.Start();</span>
<span class="lineNum">     137 </span><span class="lineCov">          8 :     rc=AliITStrackerMI::Clusters2Tracks(event);</span>
<span class="lineNum">     138 </span><span class="lineCov">          8 :     sw.Stop();</span>
<span class="lineNum">     139 </span><span class="lineCov">         64 :     AliInfoF(&quot;timingMI: %e/%e real/cpu&quot;,sw.RealTime(),sw.CpuTime());</span>
<span class="lineNum">     140 </span><span class="lineCov">          8 :   }</span>
<span class="lineNum">     141 </span>            :   else {
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :     AliDebug(1,&quot;Stand Alone flag set: doing tracking in ITS alone\n&quot;);</span>
<span class="lineNum">     143 </span>            :   }
<span class="lineNum">     144 </span><span class="lineCov">          8 :   if(!rc){ </span>
<span class="lineNum">     145 </span><span class="lineCov">          8 :     if (event-&gt;GetNumberOfTPCClusters()) {</span>
<span class="lineNum">     146 </span><span class="lineCov">          8 :       sw.Start();</span>
<span class="lineNum">     147 </span><span class="lineCov">          8 :       rc=FindTracks(event,kFALSE); //RS: do complementary reco if there are TPC clusters</span>
<span class="lineNum">     148 </span><span class="lineCov">          8 :       sw.Stop();</span>
<span class="lineNum">     149 </span><span class="lineCov">         64 :       AliInfoF(&quot;timingSAcompl: %e/%e real/cpu&quot;,sw.RealTime(),sw.CpuTime());</span>
<span class="lineNum">     150 </span><span class="lineCov">          8 :     }</span>
<span class="lineNum">     151 </span>            :     Int_t nSPDcontr=0;
<span class="lineNum">     152 </span><span class="lineCov">          8 :     const AliESDVertex *spdv = event-&gt;GetPrimaryVertexSPD();</span>
<span class="lineNum">     153 </span><span class="lineCov">         24 :     if(spdv) nSPDcontr = spdv-&gt;GetNContributors();</span>
<span class="lineNum">     154 </span><span class="lineCov">         16 :     if(AliITSReconstructor::GetRecoParam()-&gt;GetSAUseAllClusters()==kTRUE &amp;&amp; </span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :        nSPDcontr&lt;=AliITSReconstructor::GetRecoParam()-&gt;GetMaxSPDcontrForSAToUseAllClusters()) {</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :       sw.Start();</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :       rc=FindTracks(event,kTRUE);</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :       sw.Stop();</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :       AliInfoF(&quot;timingSApure: %e/%e real/cpu&quot;,sw.RealTime(),sw.CpuTime());</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     161 </span><span class="lineCov">          8 :   }</span>
<span class="lineNum">     162 </span>            :   return rc;
<span class="lineNum">     163 </span><span class="lineCov">          8 : }</span>
<a name="164"><span class="lineNum">     164 </span>            : </a>
<span class="lineNum">     165 </span>            : //____________________________________________________________________________
<span class="lineNum">     166 </span>            : void AliITStrackerSA::Init(){
<span class="lineNum">     167 </span>            :   //  Reset all data members
<span class="lineNum">     168 </span><span class="lineCov">          4 :     fPhiEstimate=0;</span>
<span class="lineNum">     169 </span><span class="lineCov">         12 :     for(Int_t i=0;i&lt;2;i++){fPoint1[i]=0;fPoint2[i]=0;fPoint3[i]=0;}</span>
<span class="lineNum">     170 </span><span class="lineCov">          2 :     fLambdac=0;</span>
<span class="lineNum">     171 </span><span class="lineCov">          2 :     fPhic=0;</span>
<span class="lineNum">     172 </span><span class="lineCov">          2 :     fCoef1=0;</span>
<span class="lineNum">     173 </span><span class="lineCov">          2 :     fCoef2=0;</span>
<span class="lineNum">     174 </span><span class="lineCov">          2 :     fCoef3=0;</span>
<span class="lineNum">     175 </span><span class="lineCov">          2 :     fPointc[0]=0;</span>
<span class="lineNum">     176 </span><span class="lineCov">          2 :     fPointc[1]=0;</span>
<span class="lineNum">     177 </span><span class="lineCov">          2 :     fITSclusters = 0;</span>
<span class="lineNum">     178 </span><span class="lineCov">          2 :     SetOuterStartLayer(1);</span>
<span class="lineNum">     179 </span><span class="lineCov">          2 :     SetSAFlag(kFALSE);</span>
<span class="lineNum">     180 </span><span class="lineCov">          4 :     fListOfTracks=new TClonesArray(&quot;AliITStrackMI&quot;,100);</span>
<span class="lineNum">     181 </span><span class="lineCov">          4 :     fListOfSATracks=new TClonesArray(&quot;AliITStrackSA&quot;,100);</span>
<span class="lineNum">     182 </span><span class="lineCov">          2 :     fCluCoord = 0;</span>
<span class="lineNum">     183 </span><span class="lineCov">          2 :     fMinNPoints = 3;</span>
<a name="184"><span class="lineNum">     184 </span><span class="lineCov">          2 :  }</span></a>
<span class="lineNum">     185 </span>            : //_______________________________________________________________________
<span class="lineNum">     186 </span>            : void AliITStrackerSA::ResetForFinding(){
<span class="lineNum">     187 </span>            :   //  Reset data members used in all loops during track finding
<span class="lineNum">     188 </span><span class="lineCov">       3268 :     fPhiEstimate=0;</span>
<span class="lineNum">     189 </span><span class="lineCov">       9804 :     for(Int_t i=0;i&lt;2;i++){fPoint1[i]=0;fPoint2[i]=0;fPoint3[i]=0;}</span>
<span class="lineNum">     190 </span><span class="lineCov">       1634 :     fLambdac=0;</span>
<span class="lineNum">     191 </span><span class="lineCov">       1634 :     fPhic=0;</span>
<span class="lineNum">     192 </span><span class="lineCov">       1634 :     fCoef1=0;</span>
<span class="lineNum">     193 </span><span class="lineCov">       1634 :     fCoef2=0;</span>
<span class="lineNum">     194 </span><span class="lineCov">       1634 :     fCoef3=0;</span>
<span class="lineNum">     195 </span><span class="lineCov">       1634 :     fPointc[0]=0;</span>
<span class="lineNum">     196 </span><span class="lineCov">       1634 :     fPointc[1]=0;</span>
<span class="lineNum">     197 </span><span class="lineCov">       1634 :     fListOfTracks-&gt;Clear();</span>
<span class="lineNum">     198 </span><span class="lineCov">       1634 :     fListOfSATracks-&gt;Clear();</span>
<a name="199"><span class="lineNum">     199 </span><span class="lineCov">       1634 : }</span></a>
<span class="lineNum">     200 </span>            : //_______________________________________________________________________
<span class="lineNum">     201 </span>            : void AliITStrackerSA::ConfigureTrackFinding(){
<span class="lineNum">     202 </span>            :   // set windows for track search based on recoparam parameters
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span><span class="lineCov">         16 :   Int_t nLoops=AliITSReconstructor::GetRecoParam()-&gt;GetNLoopsSA();</span>
<span class="lineNum">     205 </span><span class="lineCov">          8 :   if(nLoops==32){</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :     SetFixedWindowSizes();</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :   }else{</span>
<span class="lineNum">     208 </span><span class="lineCov">          8 :     Double_t phimin=AliITSReconstructor::GetRecoParam()-&gt;GetMinPhiSA();</span>
<span class="lineNum">     209 </span><span class="lineCov">          8 :     Double_t phimax=AliITSReconstructor::GetRecoParam()-&gt;GetMaxPhiSA();</span>
<span class="lineNum">     210 </span><span class="lineCov">          8 :     Double_t lambmin=AliITSReconstructor::GetRecoParam()-&gt;GetMinLambdaSA();</span>
<span class="lineNum">     211 </span><span class="lineCov">          8 :     Double_t lambmax=AliITSReconstructor::GetRecoParam()-&gt;GetMaxLambdaSA();</span>
<span class="lineNum">     212 </span><span class="lineCov">          8 :     SetCalculatedWindowSizes(nLoops,phimin,phimax,lambmin,lambmax);</span>
<span class="lineNum">     213 </span>            :   }
<span class="lineNum">     214 </span><span class="lineCov">          8 :   fMinQ=AliITSReconstructor::GetRecoParam()-&gt;GetSAMinClusterCharge();</span>
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span><span class="lineCov">          8 : }</span>
<span class="lineNum">     217 </span>            :  
<a name="218"><span class="lineNum">     218 </span>            : </a>
<span class="lineNum">     219 </span>            : //______________________________________________________________________
<span class="lineNum">     220 </span>            : Int_t AliITStrackerSA::FindTracks(AliESDEvent* event, Bool_t useAllClusters){
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span>            : // Track finder using the ESD object
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span><span class="lineCov">         24 :   AliDebug(2,Form(&quot; field is %f&quot;,event-&gt;GetMagneticField()));</span>
<span class="lineNum">     225 </span><span class="lineCov">         24 :   AliDebug(2,Form(&quot;SKIPPING %d %d %d %d %d %d&quot;,ForceSkippingOfLayer(0),ForceSkippingOfLayer(1),ForceSkippingOfLayer(2),ForceSkippingOfLayer(3),ForceSkippingOfLayer(4),ForceSkippingOfLayer(5)));</span>
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span><span class="lineCov">          8 :   if(!fITSclusters){</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :     Fatal(&quot;FindTracks&quot;,&quot;ITS cluster tree is not accessed!!!\n Please use method SetClusterTree to pass the pointer to the tree\n&quot;);</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :     return -1;</span>
<span class="lineNum">     230 </span>            :   }
<span class="lineNum">     231 </span>            :   //Reads event and mark clusters of traks already found, with flag kITSin
<span class="lineNum">     232 </span><span class="lineCov">          8 :   Int_t nentr=event-&gt;GetNumberOfTracks();</span>
<span class="lineNum">     233 </span><span class="lineCov">          8 :   if(!useAllClusters) {</span>
<span class="lineNum">     234 </span><span class="lineCov">        280 :     while (nentr--) {</span>
<span class="lineNum">     235 </span><span class="lineCov">        136 :       AliESDtrack *track=event-&gt;GetTrack(nentr);</span>
<span class="lineNum">     236 </span><span class="lineCov">        136 :       if ((track-&gt;GetStatus()&amp;AliESDtrack::kITSin) == AliESDtrack::kITSin){</span>
<span class="lineNum">     237 </span><span class="lineCov">         82 :         Int_t idx[12];</span>
<span class="lineNum">     238 </span><span class="lineCov">         82 :         Int_t ncl = track-&gt;GetITSclusters(idx);</span>
<span class="lineNum">     239 </span><span class="lineCov">       1016 :         for(Int_t k=0;k&lt;ncl;k++){</span>
<span class="lineNum">     240 </span><span class="lineCov">        426 :           AliITSRecPoint* cll = (AliITSRecPoint*)GetCluster(idx[k]);</span>
<span class="lineNum">     241 </span><span class="lineCov">        426 :           cll-&gt;SetBit(kSAflag);</span>
<span class="lineNum">     242 </span>            :         }
<span class="lineNum">     243 </span><span class="lineCov">         82 :       }</span>
<span class="lineNum">     244 </span>            :     }
<span class="lineNum">     245 </span>            :   }else{
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :     while (nentr--) {</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :       AliESDtrack *track=event-&gt;GetTrack(nentr);</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :       if ((track-&gt;GetStatus()&amp;AliESDtrack::kITSin) == AliESDtrack::kITSin){</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :         Int_t idx[12];</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :         Int_t ncl = track-&gt;GetITSclusters(idx);</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :         for(Int_t k=0;k&lt;ncl;k++){</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :           AliITSRecPoint* cll = (AliITSRecPoint*)GetCluster(idx[k]);</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :           cll-&gt;ResetBit(kSAflag);</span>
<span class="lineNum">     254 </span>            :         }
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     256 </span>            :     }
<span class="lineNum">     257 </span>            :   }
<span class="lineNum">     258 </span>            :   //Get primary vertex
<span class="lineNum">     259 </span><span class="lineCov">          8 :   Double_t primaryVertex[3];</span>
<span class="lineNum">     260 </span><span class="lineCov">          8 :   event-&gt;GetVertex()-&gt;GetXYZ(primaryVertex);</span>
<span class="lineNum">     261 </span>            :   //Creates TClonesArray with clusters for each layer. The clusters already used
<span class="lineNum">     262 </span>            :   //by AliITStrackerMI are not considered
<span class="lineNum">     263 </span><span class="lineCov">          8 :   Int_t nclusters[AliITSgeomTGeo::kNLayers]={0,0,0,0,0,0};</span>
<span class="lineNum">     264 </span><span class="lineCov">          8 :   Int_t dmar[AliITSgeomTGeo::kNLayers]={0,0,0,0,0,0};</span>
<span class="lineNum">     265 </span><span class="lineCov">          8 :   if (fCluCoord == 0) {</span>
<span class="lineNum">     266 </span><span class="lineCov">          2 :     fCluCoord = new TClonesArray*[AliITSgeomTGeo::kNLayers];</span>
<span class="lineNum">     267 </span><span class="lineCov">         28 :     for(Int_t i=0;i&lt;AliITSgeomTGeo::GetNLayers();i++) {</span>
<span class="lineNum">     268 </span><span class="lineCov">         12 :       fCluCoord[i]=0;</span>
<span class="lineNum">     269 </span>            :     }
<span class="lineNum">     270 </span><span class="lineCov">          2 :   }</span>
<span class="lineNum">     271 </span><span class="lineCov">        112 :   for(Int_t i=0;i&lt;AliITSgeomTGeo::GetNLayers();i++){</span>
<span class="lineNum">     272 </span><span class="lineCov">         48 :     AliITSlayer &amp;layer=fgLayers[i];</span>
<span class="lineNum">     273 </span><span class="lineCov">         48 :     if (!ForceSkippingOfLayer(i)) {</span>
<span class="lineNum">     274 </span><span class="lineCov">       1428 :       for(Int_t cli=0;cli&lt;layer.GetNumberOfClusters();cli++){</span>
<span class="lineNum">     275 </span><span class="lineCov">        666 :         AliITSRecPoint* cls = (AliITSRecPoint*)layer.GetCluster(cli);</span>
<span class="lineNum">     276 </span><span class="lineCov">       1084 :         if(cls-&gt;TestBit(kSAflag)==kTRUE) continue; //clusters used by TPC prol.</span>
<span class="lineNum">     277 </span><span class="lineCov">        248 :         if(cls-&gt;GetQ()==0) continue; //fake clusters dead zones</span>
<span class="lineNum">     278 </span><span class="lineCov">        456 :         if(i&gt;1 &amp;&amp; cls-&gt;GetQ()&lt;=fMinQ) continue; // cut on SDD and SSD cluster charge</span>
<span class="lineNum">     279 </span><span class="lineCov">        248 :         nclusters[i]++;</span>
<span class="lineNum">     280 </span><span class="lineCov">        248 :       }</span>
<span class="lineNum">     281 </span><span class="lineCov">         48 :     }</span>
<span class="lineNum">     282 </span><span class="lineCov">         48 :     dmar[i]=0;</span>
<span class="lineNum">     283 </span><span class="lineCov">         48 :     if(!fCluCoord[i]){</span>
<span class="lineNum">     284 </span><span class="lineCov">         24 :       fCluCoord[i] = new TClonesArray(&quot;AliITSclusterTable&quot;,nclusters[i]);</span>
<span class="lineNum">     285 </span><span class="lineCov">         12 :     }else{</span>
<span class="lineNum">     286 </span><span class="lineCov">         36 :       fCluCoord[i]-&gt;Clear(); //Delete();</span>
<span class="lineNum">     287 </span>            :       //fCluCoord[i]-&gt;Expand(nclusters[i]); //RS will autoexpand
<span class="lineNum">     288 </span>            :     }
<span class="lineNum">     289 </span>            :   }
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span><span class="lineCov">        112 :   for(Int_t ilay=0;ilay&lt;AliITSgeomTGeo::GetNLayers();ilay++){</span>
<span class="lineNum">     292 </span><span class="lineCov">         48 :     TClonesArray &amp;clucoo = *fCluCoord[ilay];</span>
<span class="lineNum">     293 </span><span class="lineCov">         48 :     AliITSlayer &amp;layer=fgLayers[ilay];</span>
<span class="lineNum">     294 </span><span class="lineCov">         48 :     if (!ForceSkippingOfLayer(ilay)) {</span>
<span class="lineNum">     295 </span><span class="lineCov">       1428 :       for(Int_t cli=0;cli&lt;layer.GetNumberOfClusters();cli++){</span>
<span class="lineNum">     296 </span><span class="lineCov">        666 :         AliITSRecPoint* cls = (AliITSRecPoint*)layer.GetCluster(cli);</span>
<span class="lineNum">     297 </span><span class="lineCov">       1084 :         if(cls-&gt;TestBit(kSAflag)==kTRUE) continue;</span>
<span class="lineNum">     298 </span><span class="lineCov">        248 :         if(cls-&gt;GetQ()==0) continue;</span>
<span class="lineNum">     299 </span><span class="lineCov">        456 :         if(ilay&gt;1 &amp;&amp; cls-&gt;GetQ()&lt;=fMinQ) continue; </span>
<span class="lineNum">     300 </span><span class="lineCov">        248 :         Double_t phi=0;Double_t lambda=0;</span>
<span class="lineNum">     301 </span><span class="lineCov">        248 :         Double_t x=0;Double_t y=0;Double_t z=0;</span>
<span class="lineNum">     302 </span><span class="lineCov">        248 :         Double_t sx=0;Double_t sy=0;Double_t sz=0;</span>
<span class="lineNum">     303 </span><span class="lineCov">        248 :         GetCoorAngles(cls,phi,lambda,x,y,z,primaryVertex);</span>
<span class="lineNum">     304 </span><span class="lineCov">        248 :         GetCoorErrors(cls,sx,sy,sz);</span>
<span class="lineNum">     305 </span><span class="lineCov">        248 :         new (clucoo[dmar[ilay]]) AliITSclusterTable(x,y,z,sx,sy,sz,phi,lambda,cli);</span>
<span class="lineNum">     306 </span><span class="lineCov">        248 :         dmar[ilay]++;</span>
<span class="lineNum">     307 </span><span class="lineCov">        248 :       }</span>
<span class="lineNum">     308 </span><span class="lineCov">         48 :     }</span>
<span class="lineNum">     309 </span><span class="lineCov">         48 :     fCluCoord[ilay]-&gt;Sort();</span>
<span class="lineNum">     310 </span>            :   }
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            :   // track counter
<span class="lineNum">     313 </span>            :   Int_t ntrack=0;
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span>            :   static Int_t nClusLay[AliITSgeomTGeo::kNLayers];//counter for clusters on each layer
<span class="lineNum">     316 </span>            :   Int_t startLayForSeed=0;
<span class="lineNum">     317 </span><span class="lineCov">          8 :   Int_t lastLayForSeed=fOuterStartLayer;</span>
<span class="lineNum">     318 </span>            :   Int_t nSeedSteps=lastLayForSeed-startLayForSeed;
<span class="lineNum">     319 </span>            :   Int_t seedStep=1;
<span class="lineNum">     320 </span><span class="lineCov">          8 :   if(fInwardFlag){</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     startLayForSeed=AliITSgeomTGeo::GetNLayers()-1;</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :     lastLayForSeed=fInnerStartLayer;</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :     nSeedSteps=startLayForSeed-lastLayForSeed;</span>
<span class="lineNum">     324 </span>            :     seedStep=-1;
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span>            :   // loop on minimum number of points
<span class="lineNum">     328 </span><span class="lineCov">         80 :   for(Int_t iMinNPoints=AliITSgeomTGeo::GetNLayers(); iMinNPoints&gt;=fMinNPoints; iMinNPoints--) {</span>
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span>            :     // loop on starting layer for track finding 
<span class="lineNum">     331 </span><span class="lineCov">        256 :     for(Int_t iSeedLay=0; iSeedLay&lt;=nSeedSteps; iSeedLay++) {</span>
<span class="lineNum">     332 </span><span class="lineCov">         96 :       Int_t theLay=startLayForSeed+iSeedLay*seedStep;</span>
<span class="lineNum">     333 </span><span class="lineCov">         96 :       if(ForceSkippingOfLayer(theLay)) continue;</span>
<span class="lineNum">     334 </span><span class="lineCov">         96 :       Int_t minNPoints=iMinNPoints-theLay;</span>
<span class="lineNum">     335 </span><span class="lineCov">         96 :       if(fInwardFlag) minNPoints=iMinNPoints-(AliITSgeomTGeo::GetNLayers()-1-theLay);</span>
<span class="lineNum">     336 </span><span class="lineCov">        960 :       for(Int_t i=theLay+1;i&lt;AliITSgeomTGeo::GetNLayers();i++)</span>
<span class="lineNum">     337 </span><span class="lineCov">        384 :         if(ForceSkippingOfLayer(i)) </span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :           minNPoints--;</span>
<span class="lineNum">     339 </span><span class="lineCov">        120 :       if(minNPoints&lt;fMinNPoints) continue;</span>
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            :       // loop on phi and lambda window size
<span class="lineNum">     342 </span><span class="lineCov">       3024 :       for(Int_t nloop=0;nloop&lt;fNloop;nloop++){</span>
<span class="lineNum">     343 </span><span class="lineCov">       1440 :         Int_t nclTheLay=fCluCoord[theLay]-&gt;GetEntries();</span>
<span class="lineNum">     344 </span><span class="lineCov">       4506 :         while(nclTheLay--){ </span>
<span class="lineNum">     345 </span><span class="lineCov">       1626 :           ResetForFinding();</span>
<span class="lineNum">     346 </span><span class="lineCov">       1626 :           Bool_t useRP=SetFirstPoint(theLay,nclTheLay,primaryVertex);</span>
<span class="lineNum">     347 </span><span class="lineCov">       1626 :           if(!useRP) continue;      </span>
<span class="lineNum">     348 </span><span class="lineCov">       1626 :           AliITStrackSA trs;</span>
<span class="lineNum">     349 </span>            :             
<span class="lineNum">     350 </span>            :           Int_t pflag=0;            
<span class="lineNum">     351 </span>            :           Int_t kk;
<span class="lineNum">     352 </span><span class="lineCov">      22764 :           for(kk=0;kk&lt;AliITSgeomTGeo::GetNLayers();kk++) nClusLay[kk] = 0;</span>
<span class="lineNum">     353 </span>            :             
<span class="lineNum">     354 </span>            :           kk=0;
<span class="lineNum">     355 </span><span class="lineCov">       4878 :           nClusLay[kk] = SearchClusters(theLay,fPhiWin[nloop],fLambdaWin[nloop],</span>
<span class="lineNum">     356 </span><span class="lineCov">       1626 :                                         &amp;trs,primaryVertex[2],pflag);</span>
<span class="lineNum">     357 </span><span class="lineCov">       1626 :           Int_t nextLay=theLay+seedStep;</span>
<span class="lineNum">     358 </span>            :           Bool_t goon=kTRUE;
<span class="lineNum">     359 </span><span class="lineCov">       1626 :           if(nextLay&lt;0 || nextLay == 6) goon = kFALSE;</span>
<span class="lineNum">     360 </span><span class="lineCov">       8708 :           while(goon){</span>
<span class="lineNum">     361 </span><span class="lineCov">       7082 :             kk++;</span>
<span class="lineNum">     362 </span><span class="lineCov">      21246 :             nClusLay[kk] = SearchClusters(nextLay,fPhiWin[nloop],fLambdaWin[nloop],</span>
<span class="lineNum">     363 </span><span class="lineCov">       7082 :                                             &amp;trs,primaryVertex[2],pflag);</span>
<span class="lineNum">     364 </span><span class="lineCov">       7082 :             if(nClusLay[kk]!=0){</span>
<span class="lineNum">     365 </span>            :               pflag=1;
<span class="lineNum">     366 </span><span class="lineCov">        724 :               if(kk==1) {</span>
<span class="lineNum">     367 </span><span class="lineCov">        246 :                 fPoint3[0]=fPointc[0];</span>
<span class="lineNum">     368 </span><span class="lineCov">        246 :                 fPoint3[1]=fPointc[1];</span>
<span class="lineNum">     369 </span><span class="lineCov">        246 :               } else {</span>
<span class="lineNum">     370 </span><span class="lineCov">        478 :                 UpdatePoints();</span>
<span class="lineNum">     371 </span>            :               }
<span class="lineNum">     372 </span>            :             }
<span class="lineNum">     373 </span><span class="lineCov">       7082 :             nextLay+=seedStep;</span>
<span class="lineNum">     374 </span><span class="lineCov">       8708 :             if(nextLay&lt;0 || nextLay==6) goon=kFALSE;</span>
<span class="lineNum">     375 </span>            :           }
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span>            :             
<span class="lineNum">     378 </span>            :           Int_t layOK=0;
<span class="lineNum">     379 </span><span class="lineCov">       1626 :           if(!fInwardFlag){</span>
<span class="lineNum">     380 </span><span class="lineCov">      20668 :             for(Int_t nnp=0;nnp&lt;AliITSgeomTGeo::GetNLayers()-theLay;nnp++){</span>
<span class="lineNum">     381 </span><span class="lineCov">      11058 :               if(nClusLay[nnp]!=0) layOK+=1;</span>
<span class="lineNum">     382 </span>            :             }
<span class="lineNum">     383 </span><span class="lineCov">       1626 :           }else{</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :             for(Int_t nnp=theLay; nnp&gt;=0; nnp--){</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :               if(nClusLay[nnp]!=0) layOK+=1;</span>
<span class="lineNum">     386 </span>            :             }
<span class="lineNum">     387 </span>            :           }
<span class="lineNum">     388 </span><span class="lineCov">       1626 :           if(layOK&gt;=minNPoints){ </span>
<span class="lineNum">     389 </span><span class="lineCov">         80 :             AliDebug(2,Form(&quot;---NPOINTS: %d; MAP: %d %d %d %d %d %d\n&quot;,layOK,nClusLay[0],nClusLay[1],nClusLay[2],nClusLay[3],nClusLay[4],nClusLay[5]));</span>
<span class="lineNum">     390 </span>            :             AliITStrackV2* tr2 = 0;
<span class="lineNum">     391 </span><span class="lineCov">         16 :             tr2 = FitTrack(&amp;trs,primaryVertex);</span>
<span class="lineNum">     392 </span><span class="lineCov">         16 :             if(!tr2){ </span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">     394 </span>            :             }
<span class="lineNum">     395 </span><span class="lineCov">         80 :             AliDebug(2,Form(&quot;---NPOINTS fit: %d\n&quot;,tr2-&gt;GetNumberOfClusters()));</span>
<span class="lineNum">     396 </span>            :               
<span class="lineNum">     397 </span><span class="lineCov">         16 :             StoreTrack(tr2,event,useAllClusters);</span>
<span class="lineNum">     398 </span><span class="lineCov">         16 :             ntrack++;</span>
<span class="lineNum">     399 </span>            :               
<span class="lineNum">     400 </span><span class="lineCov">         16 :           }   </span>
<span class="lineNum">     401 </span>            :           
<span class="lineNum">     402 </span><span class="lineCov">       3252 :         }//end loop on clusters of theLay</span>
<span class="lineNum">     403 </span>            :       } //end loop on window sizes
<span class="lineNum">     404 </span><span class="lineCov">         72 :     } //end loop on theLay</span>
<span class="lineNum">     405 </span>            :   }//end loop on min points
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span>            :   // search for 1-point tracks in SPD, only for cosmics
<span class="lineNum">     408 </span>            :   // (A.Dainese 21.03.08)
<span class="lineNum">     409 </span><span class="lineCov">          8 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetSAOnePointTracks() &amp;&amp; </span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :      TMath::Abs(event-&gt;GetMagneticField())&lt;0.01) {</span>
<span class="lineNum">     411 </span>            :     Int_t outerLayer=1; // only SPD
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :     for(Int_t innLay=0; innLay&lt;=TMath::Min(1,fOuterStartLayer); innLay++) {</span>
<span class="lineNum">     413 </span>            :       //   counter for clusters on each layer  
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :       for(Int_t nloop=0;nloop&lt;fNloop;nloop++){</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :         Int_t nclInnLay=fCluCoord[innLay]-&gt;GetEntries();</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :         while(nclInnLay--){ //loop starting from layer innLay</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :           ResetForFinding();</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :           Bool_t useRP=SetFirstPoint(innLay,nclInnLay,primaryVertex);</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :           if(!useRP) continue;</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :           AliITStrackSA trs;</span>
<span class="lineNum">     422 </span>            :             
<span class="lineNum">     423 </span>            :           Int_t pflag=0;            
<span class="lineNum">     424 </span>            :           Int_t kk;
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :           for(kk=0;kk&lt;AliITSgeomTGeo::GetNLayers();kk++) nClusLay[kk] = 0;</span>
<span class="lineNum">     426 </span>            :           
<span class="lineNum">     427 </span>            :           kk=0;
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :           nClusLay[kk] = SearchClusters(innLay,fPhiWin[nloop],fLambdaWin[nloop],</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :                                   &amp;trs,primaryVertex[2],pflag);</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :           for(Int_t nextLay=innLay+1; nextLay&lt;=outerLayer; nextLay++) {</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :             kk++;</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :             nClusLay[kk] = SearchClusters(nextLay,fPhiWin[nloop],fLambdaWin[nloop],</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                                     &amp;trs,primaryVertex[2],pflag);</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :             if(nClusLay[kk]!=0){</span>
<span class="lineNum">     435 </span>            :               pflag=1;
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :               if(kk==1) {</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                 fPoint3[0]=fPointc[0];</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                 fPoint3[1]=fPointc[1];</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :               } else {</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :                 UpdatePoints();</span>
<span class="lineNum">     441 </span>            :               }
<span class="lineNum">     442 </span>            :             }
<span class="lineNum">     443 </span>            :           }
<span class="lineNum">     444 </span>            :           
<span class="lineNum">     445 </span>            :           Int_t layOK=0;
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :           for(Int_t nnp=0;nnp&lt;AliITSgeomTGeo::GetNLayers()-innLay;nnp++){</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :             if(nClusLay[nnp]!=0) layOK+=1;</span>
<span class="lineNum">     448 </span>            :           }
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :           if(layOK==1) {</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :             AliDebug(2,Form(&quot;----NPOINTS: %d; MAP: %d %d %d %d %d %d\n&quot;,layOK,nClusLay[0],nClusLay[1],nClusLay[2],nClusLay[3],nClusLay[4],nClusLay[5]));</span>
<span class="lineNum">     451 </span>            :             AliITStrackV2* tr2 = 0;
<span class="lineNum">     452 </span>            :             Bool_t onePoint = kTRUE;
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :             tr2 = FitTrack(&amp;trs,primaryVertex,onePoint);</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :             if(!tr2){</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">     456 </span>            :             }
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :             AliDebug(2,Form(&quot;----NPOINTS fit: %d\n&quot;,tr2-&gt;GetNumberOfClusters()));</span>
<span class="lineNum">     458 </span>            :             
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :             StoreTrack(tr2,event,useAllClusters);</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :             ntrack++;</span>
<span class="lineNum">     461 </span>            :             
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :           }   </span>
<span class="lineNum">     463 </span>            :           
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :         }//end loop on clusters of innLay</span>
<span class="lineNum">     465 </span>            :       } //end loop on window sizes
<span class="lineNum">     466 </span>            :       
<span class="lineNum">     467 </span>            :     } //end loop on innLay
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :   } // end search 1-point tracks</span>
<span class="lineNum">     469 </span>            :   
<span class="lineNum">     470 </span><span class="lineCov">         16 :   if(!useAllClusters) AliInfo(Form(&quot;Number of found tracks: %d&quot;,event-&gt;GetNumberOfTracks()));</span>
<span class="lineNum">     471 </span><span class="lineCov">          8 :   ResetForFinding();</span>
<span class="lineNum">     472 </span>            :   return 0;
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineCov">         16 : }</span>
<span class="lineNum">     475 </span>            :  
<a name="476"><span class="lineNum">     476 </span>            : //________________________________________________________________________</a>
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span>            : AliITStrackV2* AliITStrackerSA::FitTrack(AliITStrackSA* tr,Double_t *primaryVertex,Bool_t onePoint) {
<span class="lineNum">     479 </span>            :   //fit of the found track (most general case, also &lt;6 points, layers missing)
<span class="lineNum">     480 </span>            :   // A.Dainese 16.11.07 
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span>            :   
<span class="lineNum">     483 </span>            :   const Int_t kMaxClu=AliITStrackSA::kMaxNumberOfClusters;
<span class="lineNum">     484 </span>            : 
<span class="lineNum">     485 </span>            :   static Int_t firstmod[AliITSgeomTGeo::kNLayers];  
<span class="lineNum">     486 </span>            :   static Int_t clind[AliITSgeomTGeo::kNLayers][kMaxClu];
<span class="lineNum">     487 </span>            :   static Int_t clmark[AliITSgeomTGeo::kNLayers][kMaxClu];
<span class="lineNum">     488 </span>            :   static Int_t end[AliITSgeomTGeo::kNLayers];
<span class="lineNum">     489 </span>            :   static Int_t indices[AliITSgeomTGeo::kNLayers];
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span>            :   static AliITSRecPoint *listlayer[AliITSgeomTGeo::kNLayers][kMaxClu];
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span><span class="lineCov">        224 :   for(Int_t i=0;i&lt;AliITSgeomTGeo::GetNLayers();i++) {</span>
<span class="lineNum">     494 </span><span class="lineCov">         96 :     firstmod[i]=AliITSgeomTGeo::GetModuleIndex(i+1,1,1);</span>
<span class="lineNum">     495 </span><span class="lineCov">         96 :     end[i]=0;</span>
<span class="lineNum">     496 </span><span class="lineCov">       3072 :     for(Int_t j=0;j&lt;kMaxClu; j++){</span>
<span class="lineNum">     497 </span><span class="lineCov">       1440 :       clind[i][j]=0;</span>
<span class="lineNum">     498 </span><span class="lineCov">       1440 :       clmark[i][j]=0;</span>
<span class="lineNum">     499 </span><span class="lineCov">       1440 :       listlayer[i][j]=0;</span>
<span class="lineNum">     500 </span>            :    }
<span class="lineNum">     501 </span>            :   }
<span class="lineNum">     502 </span>            :   
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineCov">         16 :   Int_t nclusters = tr-&gt;GetNumberOfClustersSA();</span>
<span class="lineNum">     505 </span><span class="lineCov">        212 :   for(Int_t ncl=0;ncl&lt;nclusters;ncl++){</span>
<span class="lineNum">     506 </span><span class="lineCov">         90 :     Int_t index = tr-&gt;GetClusterIndexSA(ncl); </span>
<span class="lineNum">     507 </span><span class="lineCov">         90 :     AliITSRecPoint* cl = (AliITSRecPoint*)GetCluster(index);</span>
<span class="lineNum">     508 </span><span class="lineCov">         90 :     Int_t lay = (index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">     509 </span><span class="lineCov">         90 :     Int_t nInLay=end[lay];</span>
<span class="lineNum">     510 </span><span class="lineCov">         90 :     listlayer[lay][nInLay]=cl;</span>
<span class="lineNum">     511 </span><span class="lineCov">         90 :     clind[lay][nInLay]=index;</span>
<span class="lineNum">     512 </span><span class="lineCov">         90 :     end[lay]++;</span>
<span class="lineNum">     513 </span>            :   }
<span class="lineNum">     514 </span>            : 
<span class="lineNum">     515 </span><span class="lineCov">        224 :   for(Int_t nlay=0;nlay&lt;AliITSgeomTGeo::GetNLayers();nlay++){</span>
<span class="lineNum">     516 </span><span class="lineCov">        372 :     for(Int_t ncl=0;ncl&lt;tr-&gt;GetNumberOfMarked(nlay);ncl++){</span>
<span class="lineNum">     517 </span><span class="lineCov">         90 :       Int_t mark = tr-&gt;GetClusterMark(nlay,ncl);</span>
<span class="lineNum">     518 </span><span class="lineCov">         90 :       clmark[nlay][ncl]=mark;</span>
<span class="lineNum">     519 </span>            :     }
<span class="lineNum">     520 </span>            :   }
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :   Int_t firstLay=-1,secondLay=-1;
<span class="lineNum">     524 </span><span class="lineCov">        224 :   for(Int_t i=0;i&lt;AliITSgeomTGeo::GetNLayers();i++) {</span>
<span class="lineNum">     525 </span><span class="lineCov">         96 :     if(end[i]==0) {</span>
<span class="lineNum">     526 </span><span class="lineCov">          8 :       end[i]=1;</span>
<span class="lineNum">     527 </span><span class="lineCov">          8 :     }else{</span>
<span class="lineNum">     528 </span><span class="lineCov">         88 :       if(firstLay==-1) {</span>
<span class="lineNum">     529 </span>            :         firstLay=i;
<span class="lineNum">     530 </span><span class="lineCov">         88 :       } else if(secondLay==-1) {</span>
<span class="lineNum">     531 </span>            :         secondLay=i;
<span class="lineNum">     532 </span><span class="lineCov">         16 :       }</span>
<span class="lineNum">     533 </span>            :     }
<span class="lineNum">     534 </span>            :   }
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span><span class="lineCov">         32 :   if(firstLay==-1 || (secondLay==-1 &amp;&amp; !onePoint)) return 0;</span>
<span class="lineNum">     537 </span><span class="lineCov">         16 :   TClonesArray &amp;arrMI= *fListOfTracks;</span>
<span class="lineNum">     538 </span><span class="lineCov">         16 :   TClonesArray &amp;arrSA= *fListOfSATracks;</span>
<span class="lineNum">     539 </span>            :   Int_t nFoundTracks=0;
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span><span class="lineCov">         64 :   for(Int_t l0=0;l0&lt;end[0];l0++){ //loop on layer 1</span>
<span class="lineNum">     543 </span><span class="lineCov">         16 :     indices[0]=l0;</span>
<span class="lineNum">     544 </span><span class="lineCov">         64 :     for(Int_t l1=0;l1&lt;end[1];l1++){ //loop on layer 2</span>
<span class="lineNum">     545 </span><span class="lineCov">         16 :       indices[1]=l1;</span>
<span class="lineNum">     546 </span><span class="lineCov">         64 :       for(Int_t l2=0;l2&lt;end[2];l2++){  //loop on layer 3</span>
<span class="lineNum">     547 </span><span class="lineCov">         16 :         indices[2]=l2;</span>
<span class="lineNum">     548 </span><span class="lineCov">         64 :         for(Int_t l3=0;l3&lt;end[3];l3++){ //loop on layer 4   </span>
<span class="lineNum">     549 </span><span class="lineCov">         16 :           indices[3]=l3;</span>
<span class="lineNum">     550 </span><span class="lineCov">         64 :           for(Int_t l4=0;l4&lt;end[4];l4++){ //loop on layer 5</span>
<span class="lineNum">     551 </span><span class="lineCov">         16 :             indices[4]=l4;</span>
<span class="lineNum">     552 </span><span class="lineCov">         68 :             for(Int_t l5=0;l5&lt;end[5];l5++){ //loop on layer 6  </span>
<span class="lineNum">     553 </span><span class="lineCov">         18 :               indices[5]=l5;</span>
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span>            :               // estimate curvature from 2 innermost points (or innermost point + vertex)
<span class="lineNum">     556 </span>            : 
<span class="lineNum">     557 </span><span class="lineCov">         18 :               Int_t iFirstLay=indices[firstLay];</span>
<span class="lineNum">     558 </span><span class="lineCov">         18 :               Int_t mrk1=clmark[firstLay][iFirstLay];</span>
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span><span class="lineCov">         18 :               AliITSRecPoint* p1=(AliITSRecPoint*)listlayer[firstLay][iFirstLay];</span>
<span class="lineNum">     561 </span><span class="lineCov">         18 :               Int_t module1 = p1-&gt;GetDetectorIndex()+firstmod[firstLay]; </span>
<span class="lineNum">     562 </span><span class="lineCov">         18 :               Int_t layer,ladder,detector;</span>
<span class="lineNum">     563 </span><span class="lineCov">         18 :               AliITSgeomTGeo::GetModuleId(module1,layer,ladder,detector);</span>
<span class="lineNum">     564 </span><span class="lineCov">         18 :               Double_t yclu1 = p1-&gt;GetY();</span>
<span class="lineNum">     565 </span><span class="lineCov">         18 :               Double_t zclu1 = p1-&gt;GetZ();</span>
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span>            :               Double_t x1,y1,z1;
<span class="lineNum">     568 </span>            :               Double_t x2,y2,z2;
<span class="lineNum">     569 </span>            :               Double_t cv=0,tgl2=0,phi2=0;
<span class="lineNum">     570 </span><span class="lineCov">         18 :               AliITSclusterTable* arr1 = (AliITSclusterTable*)GetClusterCoord(firstLay,mrk1);</span>
<span class="lineNum">     571 </span><span class="lineCov">         18 :               x1 = arr1-&gt;GetX();</span>
<span class="lineNum">     572 </span><span class="lineCov">         18 :               y1 = arr1-&gt;GetY();</span>
<span class="lineNum">     573 </span><span class="lineCov">         18 :               z1 = arr1-&gt;GetZ();</span>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineCov">         18 :               if(secondLay&gt;0) {</span>
<span class="lineNum">     576 </span><span class="lineCov">         18 :                 Int_t iSecondLay=indices[secondLay];          </span>
<span class="lineNum">     577 </span><span class="lineCov">         18 :                 Int_t mrk2=clmark[secondLay][iSecondLay];</span>
<span class="lineNum">     578 </span><span class="lineCov">         18 :                 AliITSclusterTable* arr2 = (AliITSclusterTable*)GetClusterCoord(secondLay,mrk2);</span>
<span class="lineNum">     579 </span><span class="lineCov">         18 :                 x2 = arr2-&gt;GetX();</span>
<span class="lineNum">     580 </span><span class="lineCov">         18 :                 y2 = arr2-&gt;GetY();</span>
<span class="lineNum">     581 </span><span class="lineCov">         18 :                 z2 = arr2-&gt;GetZ();</span>
<span class="lineNum">     582 </span><span class="lineCov">         18 :                 cv = Curvature(primaryVertex[0],primaryVertex[1],x1,y1,x2,y2);</span>
<span class="lineNum">     583 </span><span class="lineCov">         18 :                 tgl2 = (z2-z1)/TMath::Sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));</span>
<span class="lineNum">     584 </span><span class="lineCov">         18 :                 phi2 = TMath::ATan2((y2-y1),(x2-x1));</span>
<span class="lineNum">     585 </span><span class="lineCov">         18 :               } else { // special case of 1-point tracks, only for cosmics (B=0)</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :                 x2 = primaryVertex[0];</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :                 y2 = primaryVertex[1];</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :                 z2 = primaryVertex[2];</span>
<span class="lineNum">     589 </span>            :                 cv = 0;
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :                 tgl2 = (z1-z2)/TMath::Sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :                 phi2 = TMath::ATan2((y1-y2),(x1-x2));</span>
<span class="lineNum">     592 </span>            :               }
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span>            :               // create track and attach it the RecPoints
<span class="lineNum">     595 </span><span class="lineCov">         18 :               AliITStrackSA trac(layer,ladder,detector,yclu1,zclu1,phi2,tgl2,cv,1);</span>
<span class="lineNum">     596 </span><span class="lineCov">        252 :               for(Int_t iLay=5; iLay&gt;=0; iLay--){</span>
<span class="lineNum">     597 </span><span class="lineCov">        108 :                 Int_t iInLay=indices[iLay];</span>
<span class="lineNum">     598 </span><span class="lineCov">        108 :                 AliITSRecPoint* cl=(AliITSRecPoint*)listlayer[iLay][iInLay];</span>
<span class="lineNum">     599 </span><span class="lineCov">        108 :                 if(cl!=0){</span>
<span class="lineNum">     600 </span><span class="lineCov">        100 :                   trac.AddClusterV2(iLay,(clind[iLay][iInLay] &amp; 0x0fffffff)&gt;&gt;0);</span>
<span class="lineNum">     601 </span><span class="lineCov">        104 :                   trac.AddClusterMark(iLay,clmark[iLay][iInLay]);</span>
<span class="lineNum">     602 </span>            :                 }
<span class="lineNum">     603 </span>            :               }
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span>            :               //fit with Kalman filter using AliITStrackerMI::RefitAt()
<span class="lineNum">     606 </span><span class="lineCov">         18 :               AliITStrackSA ot(trac);</span>
<span class="lineNum">     607 </span>            : 
<span class="lineNum">     608 </span><span class="lineCov">         18 :               ot.ResetCovariance(10.);</span>
<span class="lineNum">     609 </span><span class="lineCov">         18 :               ot.ResetClusters();</span>
<span class="lineNum">     610 </span>            :               
<span class="lineNum">     611 </span>            :               // Propagate inside the innermost layer with a cluster 
<span class="lineNum">     612 </span><span class="lineCov">         72 :               if(ot.Propagate(ot.GetX()-0.1*ot.GetX())) {</span>
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineCov">         36 :                 if(RefitAt(AliITSRecoParam::GetrInsideITSscreen(),&amp;ot,&amp;trac)){ //fit from layer 1 to layer 6</span>
<span class="lineNum">     615 </span><span class="lineCov">         18 :                   AliITStrackMI otrack2(ot);</span>
<span class="lineNum">     616 </span><span class="lineCov">         18 :                   otrack2.ResetCovariance(10.); </span>
<span class="lineNum">     617 </span><span class="lineCov">         18 :                   otrack2.ResetClusters();</span>
<span class="lineNum">     618 </span>            :                   //fit from layer 6 to layer 1
<span class="lineNum">     619 </span><span class="lineCov">         36 :                   if(RefitAt(AliITSRecoParam::GetrInsideSPD1(),&amp;otrack2,&amp;ot)) {</span>
<span class="lineNum">     620 </span><span class="lineCov">         54 :                     new(arrMI[nFoundTracks]) AliITStrackMI(otrack2);</span>
<span class="lineNum">     621 </span><span class="lineCov">         54 :                     new(arrSA[nFoundTracks]) AliITStrackSA(trac);</span>
<span class="lineNum">     622 </span><span class="lineCov">         18 :                     ++nFoundTracks;</span>
<span class="lineNum">     623 </span><span class="lineCov">         18 :                   }</span>
<span class="lineNum">     624 </span>            :                               
<span class="lineNum">     625 </span><span class="lineCov">         18 :                 }       </span>
<span class="lineNum">     626 </span>            :               }
<span class="lineNum">     627 </span><span class="lineCov">         18 :             }//end loop layer 6</span>
<span class="lineNum">     628 </span>            :           }//end loop layer 5
<span class="lineNum">     629 </span>            :         }//end loop layer 4        
<span class="lineNum">     630 </span>            :       }//end loop layer 3
<span class="lineNum">     631 </span>            :     }//end loop layer 2 
<span class="lineNum">     632 </span>            :   }//end loop layer 1
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineCov">         16 :   if(fListOfTracks-&gt;GetEntries()==0) return 0;</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span><span class="lineCov">         16 :   Int_t lowchi2 = FindTrackLowChiSquare();</span>
<span class="lineNum">     640 </span><span class="lineCov">         16 :   AliITStrackV2* otrack =(AliITStrackV2*)fListOfTracks-&gt;At(lowchi2);</span>
<span class="lineNum">     641 </span><span class="lineCov">         16 :   AliITStrackSA* trsa = (AliITStrackSA*)fListOfSATracks-&gt;At(lowchi2);</span>
<span class="lineNum">     642 </span>            :  
<span class="lineNum">     643 </span><span class="lineCov">         16 :   if(otrack==0) return 0;</span>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span><span class="lineCov">         16 :   CookLabel(otrack,0.); //MI change - to see fake ratio</span>
<span class="lineNum">     646 </span><span class="lineCov">         16 :   Int_t label=FindLabel(otrack);</span>
<span class="lineNum">     647 </span><span class="lineCov">         16 :   otrack-&gt;SetLabel(label);  </span>
<span class="lineNum">     648 </span>            :   Double_t low=0.;
<span class="lineNum">     649 </span>            :   Double_t up=0.51;    
<span class="lineNum">     650 </span><span class="lineCov">         16 :   otrack-&gt;CookdEdx(low,up);</span>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span>            :   //remove clusters of found track
<span class="lineNum">     653 </span><span class="lineCov">        224 :   for(Int_t nlay=0;nlay&lt;AliITSgeomTGeo::GetNLayers();nlay++){</span>
<span class="lineNum">     654 </span><span class="lineCov">        368 :     for(Int_t cln=0;cln&lt;trsa-&gt;GetNumberOfMarked(nlay);cln++){</span>
<span class="lineNum">     655 </span><span class="lineCov">         88 :       Int_t index = trsa-&gt;GetClusterMark(nlay,cln);</span>
<span class="lineNum">     656 </span><span class="lineCov">         88 :       RemoveClusterCoord(nlay,index);</span>
<span class="lineNum">     657 </span>            :     }    
<span class="lineNum">     658 </span>            :   }
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span>            :   return otrack;
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span><span class="lineCov">         16 : }</span>
<a name="663"><span class="lineNum">     663 </span>            : </a>
<span class="lineNum">     664 </span>            : //_______________________________________________________
<span class="lineNum">     665 </span>            : void AliITStrackerSA::StoreTrack(AliITStrackV2 *t,AliESDEvent *event, Bool_t pureSA) const 
<span class="lineNum">     666 </span>            : {
<span class="lineNum">     667 </span>            :   //
<span class="lineNum">     668 </span>            :   // Add new track to the ESD
<span class="lineNum">     669 </span>            :   //
<span class="lineNum">     670 </span><span class="lineCov">         16 :   AliESDtrack outtrack;</span>
<span class="lineNum">     671 </span><span class="lineCov">         16 :   outtrack.UpdateTrackParams(t,AliESDtrack::kITSin);</span>
<span class="lineNum">     672 </span><span class="lineCov">         16 :   if(pureSA) outtrack.SetStatus(AliESDtrack::kITSpureSA);</span>
<span class="lineNum">     673 </span><span class="lineCov">        416 :   for(Int_t i=0;i&lt;12;i++) {</span>
<span class="lineNum">     674 </span><span class="lineCov">        192 :     outtrack.SetITSModuleIndex(i,t-&gt;GetModuleIndex(i));</span>
<span class="lineNum">     675 </span>            :   }
<span class="lineNum">     676 </span><span class="lineCov">         16 :   Double_t sdedx[4]={0.,0.,0.,0.};</span>
<span class="lineNum">     677 </span><span class="lineCov">        160 :   for(Int_t i=0; i&lt;4; i++) sdedx[i]=t-&gt;GetSampledEdx(i);</span>
<span class="lineNum">     678 </span><span class="lineCov">         16 :   outtrack.SetITSdEdxSamples(sdedx);</span>
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span>            : 
<span class="lineNum">     681 </span><span class="lineCov">         32 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetSAUsedEdxInfo()){</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :     Double_t mom=t-&gt;P();</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :     Double_t ppid[AliPID::kSPECIES];</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :     for(Int_t isp=0;isp&lt;AliPID::kSPECIES;isp++) ppid[isp]=0.;</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :     ppid[AliPID::kPion]=1.;</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :     if(mom&lt;0.7){</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :       Double_t truncmean=t-&gt;GetdEdx();</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :       Int_t ide=fITSPid-&gt;GetParticleIdFromdEdxVsP(mom,truncmean,kTRUE);</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :       if(ide==AliPID::kProton){</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :         ppid[AliPID::kProton]=1.;</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :         ppid[AliPID::kPion]=0.;</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :       else if(ide==AliPID::kKaon){ </span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :         ppid[AliPID::kKaon]=1.; </span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :         ppid[AliPID::kPion]=0.;</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :     outtrack.SetITSpid(ppid);</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :     outtrack.SetESDpid(ppid);    </span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     701 </span><span class="lineCov">         16 :   event-&gt;AddTrack(&amp;outtrack);</span>
<span class="lineNum">     702 </span>            : 
<span class="lineNum">     703 </span>            :   return;
<span class="lineNum">     704 </span><span class="lineCov">         16 : }</span>
<span class="lineNum">     705 </span>            : 
<a name="706"><span class="lineNum">     706 </span>            : </a>
<span class="lineNum">     707 </span>            : //_______________________________________________________
<span class="lineNum">     708 </span>            : Int_t AliITStrackerSA::SearchClusters(Int_t layer,Double_t phiwindow,Double_t lambdawindow, AliITStrackSA* trs,Double_t /*zvertex*/,Int_t pflag){
<span class="lineNum">     709 </span>            :   //function used to to find the clusters associated to the track
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span><span class="lineCov">      17416 :   if(ForceSkippingOfLayer(layer)) return 0;</span>
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span>            :   Int_t nc=0;
<span class="lineNum">     715 </span><span class="lineCov">       8708 :   AliITSlayer &amp;lay = fgLayers[layer];</span>
<span class="lineNum">     716 </span><span class="lineCov">       8708 :   Double_t r=lay.GetR();</span>
<span class="lineNum">     717 </span><span class="lineCov">       8708 :   if(pflag==1){      </span>
<span class="lineNum">     718 </span><span class="lineCov">        866 :     Double_t cx1,cx2,cy1,cy2;</span>
<span class="lineNum">     719 </span><span class="lineCov">        866 :     FindEquation(fPoint1[0],fPoint1[1],fPoint2[0],fPoint2[1],fPoint3[0],fPoint3[1],fCoef1,fCoef2,fCoef3);</span>
<span class="lineNum">     720 </span><span class="lineCov">        866 :     if (FindIntersection(fCoef1,fCoef2,fCoef3,-r*r,cx1,cy1,cx2,cy2)==0)</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :        return 0;</span>
<span class="lineNum">     722 </span><span class="lineCov">        866 :     Double_t fi1=TMath::ATan2(cy1-fPoint1[1],cx1-fPoint1[0]);</span>
<span class="lineNum">     723 </span><span class="lineCov">        866 :     Double_t fi2=TMath::ATan2(cy2-fPoint1[1],cx2-fPoint1[0]);</span>
<span class="lineNum">     724 </span><span class="lineCov">        866 :     fPhiEstimate=ChoosePoint(fi1,fi2,fPhic);</span>
<span class="lineNum">     725 </span><span class="lineCov">       1732 :   }</span>
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span>            :  
<span class="lineNum">     728 </span><span class="lineCov">       8708 :   Double_t phiExpect=fPhiEstimate;</span>
<span class="lineNum">     729 </span><span class="lineCov">       8708 :   Double_t lamExpect=fLambdac;</span>
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span><span class="lineCov">       8708 :   Int_t ncl = fCluCoord[layer]-&gt;GetEntriesFast();</span>
<span class="lineNum">     732 </span><span class="lineCov">       8708 :   Int_t startcl=FindIndex(layer,lamExpect-lambdawindow*1.02);</span>
<span class="lineNum">     733 </span><span class="lineCov">       8708 :   Int_t endcl=FindIndex(layer,lamExpect+lambdawindow*1.02)+1;</span>
<span class="lineNum">     734 </span><span class="lineCov">      15184 :   if(endcl&gt;=ncl) endcl=ncl-1;</span>
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span><span class="lineCov">      50598 :   for (Int_t index=startcl; index&lt;=endcl; index++) {</span>
<span class="lineNum">     737 </span>            :     //for (Int_t index=0; index&lt;ncl; index++) {
<span class="lineNum">     738 </span><span class="lineCov">      12237 :     AliITSclusterTable* arr = (AliITSclusterTable*)GetClusterCoord(layer,index);</span>
<span class="lineNum">     739 </span>            : 
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span><span class="lineCov">      12237 :     Double_t phi = arr-&gt;GetPhi();</span>
<span class="lineNum">     742 </span><span class="lineCov">      12237 :     Double_t deltaPhi = phi-phiExpect;</span>
<span class="lineNum">     743 </span><span class="lineCov">      12997 :     if(deltaPhi&gt;TMath::Pi()) deltaPhi-=2*TMath::Pi();</span>
<span class="lineNum">     744 </span><span class="lineCov">      12219 :     else if(deltaPhi&lt;-TMath::Pi()) deltaPhi+=2*TMath::Pi();</span>
<span class="lineNum">     745 </span><span class="lineCov">      21364 :     if (TMath::Abs(deltaPhi)&gt;phiwindow) continue;</span>
<span class="lineNum">     746 </span>            :     
<span class="lineNum">     747 </span><span class="lineCov">       3110 :     Double_t lambda = arr-&gt;GetLambda();</span>
<span class="lineNum">     748 </span><span class="lineCov">       3868 :     if (TMath::Abs(lambda-lamExpect)&gt;lambdawindow) continue;</span>
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span><span class="lineCov">       2352 :     if(trs-&gt;GetNumberOfClustersSA()==trs-&gt;GetMaxNumberOfClusters()) return 0;</span>
<span class="lineNum">     751 </span><span class="lineCov">       2352 :     if(trs-&gt;GetNumberOfMarked(layer)==trs-&gt;GetMaxNMarkedPerLayer()) return 0;</span>
<span class="lineNum">     752 </span><span class="lineCov">       2352 :     Int_t orind = arr-&gt;GetOrInd();</span>
<span class="lineNum">     753 </span><span class="lineCov">       2352 :     trs-&gt;AddClusterSA(layer,orind);</span>
<span class="lineNum">     754 </span><span class="lineCov">       2352 :     trs-&gt;AddClusterMark(layer,index);</span>
<span class="lineNum">     755 </span><span class="lineCov">       2352 :     nc++;</span>
<span class="lineNum">     756 </span><span class="lineCov">       2352 :     fLambdac=lambda;</span>
<span class="lineNum">     757 </span><span class="lineCov">       2352 :     fPhiEstimate=phi;</span>
<span class="lineNum">     758 </span>            :     
<span class="lineNum">     759 </span><span class="lineCov">       2352 :     fPointc[0]=arr-&gt;GetX();</span>
<span class="lineNum">     760 </span><span class="lineCov">       2352 :     fPointc[1]=arr-&gt;GetY();</span>
<span class="lineNum">     761 </span>            :     
<span class="lineNum">     762 </span><span class="lineCov">       2352 :   }</span>
<span class="lineNum">     763 </span><span class="lineCov">       8708 :   return nc;</span>
<span class="lineNum">     764 </span><span class="lineCov">       8708 : }</span>
<a name="765"><span class="lineNum">     765 </span>            : </a>
<span class="lineNum">     766 </span>            : //________________________________________________________________
<span class="lineNum">     767 </span>            : Bool_t AliITStrackerSA::SetFirstPoint(Int_t lay, Int_t clu, Double_t* primaryVertex){
<span class="lineNum">     768 </span>            :   // Sets the first point (seed) for tracking
<span class="lineNum">     769 </span>            : 
<span class="lineNum">     770 </span><span class="lineCov">       3252 :   AliITSclusterTable* arr = (AliITSclusterTable*)GetClusterCoord(lay,clu);</span>
<span class="lineNum">     771 </span><span class="lineCov">       1626 :   fPhic = arr-&gt;GetPhi();</span>
<span class="lineNum">     772 </span><span class="lineCov">       1626 :   fLambdac = arr-&gt;GetLambda();</span>
<span class="lineNum">     773 </span><span class="lineCov">       1626 :   fPhiEstimate = fPhic;</span>
<span class="lineNum">     774 </span><span class="lineCov">       1626 :   fPoint1[0]=primaryVertex[0];</span>
<span class="lineNum">     775 </span><span class="lineCov">       1626 :   fPoint1[1]=primaryVertex[1];</span>
<span class="lineNum">     776 </span><span class="lineCov">       1626 :   fPoint2[0]=arr-&gt;GetX();</span>
<span class="lineNum">     777 </span><span class="lineCov">       1626 :   fPoint2[1]=arr-&gt;GetY();</span>
<span class="lineNum">     778 </span><span class="lineCov">       1626 :   return kTRUE; </span>
<span class="lineNum">     779 </span>            : }
<a name="780"><span class="lineNum">     780 </span>            : </a>
<span class="lineNum">     781 </span>            : //________________________________________________________________
<span class="lineNum">     782 </span>            : void AliITStrackerSA::UpdatePoints(){
<span class="lineNum">     783 </span>            :   //update of points for the estimation of the curvature  
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineCov">        956 :   fPoint2[0]=fPoint3[0];</span>
<span class="lineNum">     786 </span><span class="lineCov">        478 :   fPoint2[1]=fPoint3[1];</span>
<span class="lineNum">     787 </span><span class="lineCov">        478 :   fPoint3[0]=fPointc[0];</span>
<span class="lineNum">     788 </span><span class="lineCov">        478 :   fPoint3[1]=fPointc[1];</span>
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span>            :   
<span class="lineNum">     791 </span><span class="lineCov">        478 : }</span>
<a name="792"><span class="lineNum">     792 </span>            : </a>
<span class="lineNum">     793 </span>            : //___________________________________________________________________
<span class="lineNum">     794 </span>            : Int_t AliITStrackerSA::FindEquation(Double_t x1, Double_t y1, Double_t x2, Double_t y2, Double_t x3, Double_t y3,Double_t&amp; a, Double_t&amp; b, Double_t&amp; c){
<span class="lineNum">     795 </span>            : 
<span class="lineNum">     796 </span>            :    //given (x,y) of three recpoints (in global coordinates) 
<span class="lineNum">     797 </span>            :    //returns the parameters a,b,c of circonference x*x + y*y +a*x + b*y +c
<span class="lineNum">     798 </span><span class="lineCov">       1732 :    double dx31=x3-x1,dy31=y3-y1,dx21=x2-x1,dy21=y2-y1;</span>
<span class="lineNum">     799 </span><span class="lineCov">        866 :    Double_t den = dx31*dy21-dx21*dy31;</span>
<span class="lineNum">     800 </span><span class="lineCov">        866 :    if(den==0) return 0;</span>
<span class="lineNum">     801 </span><span class="lineCov">        866 :    else den = 1./den;</span>
<span class="lineNum">     802 </span>            :    //
<span class="lineNum">     803 </span><span class="lineCov">        866 :    double r31 = -dx31*(x1+x3) - dy31*(y1+y3);</span>
<span class="lineNum">     804 </span><span class="lineCov">        866 :    double r21 = -dx21*(x1+x2) - dy21*(y1+y2);</span>
<span class="lineNum">     805 </span>            :    //
<span class="lineNum">     806 </span><span class="lineCov">        866 :    double da = r31*dy21 - r21*dy31;</span>
<span class="lineNum">     807 </span><span class="lineCov">        866 :    double db = r21*dx31 - r31*dx21;</span>
<span class="lineNum">     808 </span><span class="lineCov">        866 :    a = da*den;</span>
<span class="lineNum">     809 </span><span class="lineCov">        866 :    b = db*den;</span>
<span class="lineNum">     810 </span><span class="lineCov">        866 :    c = -x1*x1-y1*y1-a*x1-b*y1;</span>
<span class="lineNum">     811 </span>            :    return 1;
<a name="812"><span class="lineNum">     812 </span><span class="lineCov">        866 :  }</span></a>
<span class="lineNum">     813 </span>            : //__________________________________________________________________________
<span class="lineNum">     814 </span>            :  Int_t AliITStrackerSA::FindIntersection(Double_t a1, Double_t b1, Double_t c1, Double_t c2,Double_t&amp; x1,Double_t&amp; y1, Double_t&amp; x2, Double_t&amp; y2){
<span class="lineNum">     815 </span>            :  
<span class="lineNum">     816 </span>            :  //Finds the intersection between the circonference of the track and the circonference centered in (0,0) represented by one layer
<span class="lineNum">     817 </span>            :  //c2 is -rlayer*rlayer
<span class="lineNum">     818 </span>            : 
<span class="lineNum">     819 </span><span class="lineCov">       1732 :   if(a1==0) return 0;</span>
<span class="lineNum">     820 </span><span class="lineCov">        866 :  Double_t m = c2-c1; </span>
<span class="lineNum">     821 </span><span class="lineCov">        866 :  Double_t aA = (b1*b1)/(a1*a1)+1;</span>
<span class="lineNum">     822 </span><span class="lineCov">        866 :  Double_t bB = (-2*m*b1/(a1*a1));</span>
<span class="lineNum">     823 </span><span class="lineCov">        866 :  Double_t cC = c2+(m*m)/(a1*a1);</span>
<span class="lineNum">     824 </span><span class="lineCov">        866 :  Double_t dD = bB*bB-4*aA*cC;</span>
<span class="lineNum">     825 </span><span class="lineCov">        866 :  if(dD&lt;0) return 0;</span>
<span class="lineNum">     826 </span>            :  
<span class="lineNum">     827 </span><span class="lineCov">        866 :  y1 = (-bB+TMath::Sqrt(dD))/(2*aA); </span>
<span class="lineNum">     828 </span><span class="lineCov">        866 :  y2 = (-bB-TMath::Sqrt(dD))/(2*aA); </span>
<span class="lineNum">     829 </span><span class="lineCov">        866 :  x1 = (c2-c1-b1*y1)/a1;</span>
<span class="lineNum">     830 </span><span class="lineCov">        866 :  x2 = (c2-c1-b1*y2)/a1;</span>
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span><span class="lineCov">        866 :  return 1; </span>
<a name="833"><span class="lineNum">     833 </span><span class="lineCov">        866 : }</span></a>
<span class="lineNum">     834 </span>            : //____________________________________________________________________
<span class="lineNum">     835 </span>            : Double_t AliITStrackerSA::Curvature(Double_t x1,Double_t y1,Double_t 
<span class="lineNum">     836 </span>            : x2,Double_t y2,Double_t x3,Double_t y3){
<span class="lineNum">     837 </span>            : 
<span class="lineNum">     838 </span>            :   //calculates the curvature of track  
<span class="lineNum">     839 </span><span class="lineCov">         36 :   double dy21 = y2-y1;</span>
<span class="lineNum">     840 </span><span class="lineCov">         18 :   if(TMath::Abs(dy21)&lt;kAlmost0) return 0;</span>
<span class="lineNum">     841 </span><span class="lineCov">         18 :   Double_t den = (x3-x1)*dy21-(x2-x1)*(y3-y1);</span>
<span class="lineNum">     842 </span><span class="lineCov">         18 :   if(TMath::Abs(den)&lt;kAlmost0) return 0;</span>
<span class="lineNum">     843 </span><span class="lineCov">         18 :   Double_t a = ((y3-y1)*(x2*x2+y2*y2-x1*x1-y1*y1)-(y2-y1)*(x3*x3+y3*y3-x1*x1-y1*y1))/den;</span>
<span class="lineNum">     844 </span><span class="lineCov">         18 :   Double_t b = -(x2*x2-x1*x1+y2*y2-y1*y1+a*(x2-x1))/dy21;</span>
<span class="lineNum">     845 </span><span class="lineCov">         18 :   Double_t c = -x1*x1-y1*y1-a*x1-b*y1;</span>
<span class="lineNum">     846 </span><span class="lineCov">         18 :   Double_t xc=-a/2.;</span>
<span class="lineNum">     847 </span><span class="lineCov">         18 :   double det = a*a+b*b-4*c;</span>
<span class="lineNum">     848 </span><span class="lineCov">         18 :   if(det&lt;0) return 0;</span>
<span class="lineNum">     849 </span><span class="lineCov">         54 :   Double_t rad = det&lt;kAlmost0 ? 0 :TMath::Sqrt(det)/2.;</span>
<span class="lineNum">     850 </span><span class="lineCov">         18 :   if(rad==0) return 0;</span>
<span class="lineNum">     851 </span>            :   
<span class="lineNum">     852 </span><span class="lineCov">         18 :   if((x1&gt;0 &amp;&amp; y1&gt;0 &amp;&amp; x1&lt;xc)) rad*=-1;</span>
<span class="lineNum">     853 </span><span class="lineCov">         36 :   if((x1&lt;0 &amp;&amp; y1&gt;0 &amp;&amp; x1&lt;xc)) rad*=-1;</span>
<span class="lineNum">     854 </span>            :   //  if((x1&lt;0 &amp;&amp; y1&lt;0 &amp;&amp; x1&lt;xc)) rad*=-1;
<span class="lineNum">     855 </span>            :   // if((x1&gt;0 &amp;&amp; y1&lt;0 &amp;&amp; x1&lt;xc)) rad*=-1;
<span class="lineNum">     856 </span>            :   
<span class="lineNum">     857 </span><span class="lineCov">         18 :   return 1/rad;</span>
<span class="lineNum">     858 </span>            :  
<span class="lineNum">     859 </span><span class="lineCov">         18 : }</span>
<span class="lineNum">     860 </span>            : 
<a name="861"><span class="lineNum">     861 </span>            : </a>
<span class="lineNum">     862 </span>            : //____________________________________________________________________
<span class="lineNum">     863 </span>            : Double_t AliITStrackerSA::ChoosePoint(Double_t p1, Double_t p2, Double_t pp){
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span>            :   //Returns the point closest to pp
<span class="lineNum">     866 </span>            : 
<span class="lineNum">     867 </span><span class="lineCov">       1732 :   Double_t diff1 = p1-pp;</span>
<span class="lineNum">     868 </span><span class="lineCov">        866 :   Double_t diff2 = p2-pp;</span>
<span class="lineNum">     869 </span>            :   
<span class="lineNum">     870 </span><span class="lineCov">       1598 :   if(TMath::Abs(diff1)&lt;TMath::Abs(diff2)) fPhiEstimate=p1;</span>
<span class="lineNum">     871 </span><span class="lineCov">        134 :   else fPhiEstimate=p2;  </span>
<span class="lineNum">     872 </span><span class="lineCov">        866 :   return fPhiEstimate;</span>
<span class="lineNum">     873 </span>            :   
<span class="lineNum">     874 </span>            : }
<span class="lineNum">     875 </span>            : 
<a name="876"><span class="lineNum">     876 </span>            : </a>
<span class="lineNum">     877 </span>            : //_________________________________________________________________
<span class="lineNum">     878 </span>            : Int_t AliITStrackerSA::FindTrackLowChiSquare() const {
<span class="lineNum">     879 </span>            :   // returns track with lowest chi square  
<span class="lineNum">     880 </span><span class="lineCov">         32 :   Int_t dim=fListOfTracks-&gt;GetEntries();</span>
<span class="lineNum">     881 </span><span class="lineCov">         30 :   if(dim&lt;=1) return 0;</span>
<span class="lineNum">     882 </span><span class="lineCov">          2 :   AliITStrackV2* trk = (AliITStrackV2*)fListOfTracks-&gt;At(0);</span>
<span class="lineNum">     883 </span><span class="lineCov">          2 :   Double_t minChi2=trk-&gt;GetChi2();</span>
<span class="lineNum">     884 </span>            :   Int_t index=0;
<span class="lineNum">     885 </span><span class="lineCov">          8 :   for(Int_t i=1;i&lt;dim;i++){</span>
<span class="lineNum">     886 </span><span class="lineCov">          2 :     trk = (AliITStrackV2*)fListOfTracks-&gt;At(i);</span>
<span class="lineNum">     887 </span><span class="lineCov">          2 :     Double_t chi2=trk-&gt;GetChi2();</span>
<span class="lineNum">     888 </span><span class="lineCov">          2 :     if(chi2&lt;minChi2){</span>
<span class="lineNum">     889 </span>            :       minChi2=chi2;
<span class="lineNum">     890 </span>            :       index=i;
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     892 </span>            :   }
<span class="lineNum">     893 </span>            :   return index;
<span class="lineNum">     894 </span><span class="lineCov">         16 : }</span>
<a name="895"><span class="lineNum">     895 </span>            : </a>
<span class="lineNum">     896 </span>            : //__________________________________________________________
<span class="lineNum">     897 </span>            : Int_t AliITStrackerSA::FindLabel(AliITStrackV2* track){
<span class="lineNum">     898 </span>            :   // compute the track label starting from cluster labels
<span class="lineNum">     899 </span>            :   
<span class="lineNum">     900 </span><span class="lineCov">         32 :   Int_t labl[AliITSgeomTGeo::kNLayers][3];</span>
<span class="lineNum">     901 </span><span class="lineCov">         16 :   Int_t cnts[AliITSgeomTGeo::kNLayers][3];</span>
<span class="lineNum">     902 </span><span class="lineCov">        224 :   for(Int_t j=0;j&lt;AliITSgeomTGeo::GetNLayers();j++){</span>
<span class="lineNum">     903 </span><span class="lineCov">        768 :     for(Int_t k=0;k&lt;3;k++){</span>
<span class="lineNum">     904 </span><span class="lineCov">        288 :       labl[j][k]=-2;</span>
<span class="lineNum">     905 </span><span class="lineCov">        288 :       cnts[j][k]=1;</span>
<span class="lineNum">     906 </span>            :     }
<span class="lineNum">     907 </span>            :   }
<span class="lineNum">     908 </span>            :   Int_t iNotLabel=0;
<span class="lineNum">     909 </span><span class="lineCov">        208 :   for(Int_t i=0;i&lt;track-&gt;GetNumberOfClusters(); i++) {</span>
<span class="lineNum">     910 </span><span class="lineCov">         88 :     Int_t indexc = track-&gt;GetClusterIndex(i);</span>
<span class="lineNum">     911 </span><span class="lineCov">         88 :     AliITSRecPoint* cl = (AliITSRecPoint*)GetCluster(indexc);</span>
<span class="lineNum">     912 </span><span class="lineCov">         88 :     Int_t iLayer=cl-&gt;GetLayer();</span>
<span class="lineNum">     913 </span><span class="lineCov">        704 :     for(Int_t k=0;k&lt;3;k++){</span>
<span class="lineNum">     914 </span><span class="lineCov">        264 :       labl[iLayer][k]=cl-&gt;GetLabel(k);</span>
<span class="lineNum">     915 </span><span class="lineCov">        452 :       if(labl[iLayer][k]&lt;0) iNotLabel++;</span>
<span class="lineNum">     916 </span>            :     }
<span class="lineNum">     917 </span>            :   }
<span class="lineNum">     918 </span><span class="lineCov">         16 :   if(iNotLabel==3*track-&gt;GetNumberOfClusters()) return -2;</span>
<span class="lineNum">     919 </span>            : 
<span class="lineNum">     920 </span><span class="lineCov">        224 :   for(Int_t j1=0;j1&lt;AliITSgeomTGeo::kNLayers; j1++) {</span>
<span class="lineNum">     921 </span><span class="lineCov">        672 :     for(Int_t j2=0; j2&lt;j1;  j2++){</span>
<span class="lineNum">     922 </span><span class="lineCov">       1920 :       for(Int_t k1=0; k1&lt;3; k1++){</span>
<span class="lineNum">     923 </span><span class="lineCov">       5760 :         for(Int_t k2=0; k2&lt;3; k2++){</span>
<span class="lineNum">     924 </span><span class="lineCov">       2816 :           if(labl[j1][k1]&gt;=0 &amp;&amp; labl[j1][k1]==labl[j2][k2] &amp;&amp; cnts[j2][k2]&gt;0){</span>
<span class="lineNum">     925 </span><span class="lineCov">         56 :             cnts[j2][k2]++;</span>
<span class="lineNum">     926 </span><span class="lineCov">         56 :             cnts[j1][k1]=0;</span>
<span class="lineNum">     927 </span><span class="lineCov">         56 :           }</span>
<span class="lineNum">     928 </span>            :         }
<span class="lineNum">     929 </span>            :       }
<span class="lineNum">     930 </span>            :     }
<span class="lineNum">     931 </span>            :   }
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span>            : 
<span class="lineNum">     934 </span>            :   Int_t cntMax=0;
<span class="lineNum">     935 </span>            :   Int_t label=-1;
<span class="lineNum">     936 </span><span class="lineCov">        224 :   for(Int_t j=0;j&lt;AliITSgeomTGeo::kNLayers;j++){</span>
<span class="lineNum">     937 </span><span class="lineCov">        768 :     for(Int_t k=0;k&lt;3;k++){</span>
<span class="lineNum">     938 </span><span class="lineCov">        360 :       if(cnts[j][k]&gt;cntMax &amp;&amp; labl[j][k]&gt;=0){</span>
<span class="lineNum">     939 </span>            :         cntMax=cnts[j][k];
<span class="lineNum">     940 </span>            :         label=labl[j][k];
<span class="lineNum">     941 </span><span class="lineCov">         18 :       }</span>
<span class="lineNum">     942 </span>            :     }
<span class="lineNum">     943 </span>            :   }
<span class="lineNum">     944 </span>            : 
<span class="lineNum">     945 </span>            :   Int_t lflag=0;
<span class="lineNum">     946 </span><span class="lineCov">        224 :   for(Int_t i=0;i&lt;AliITSgeomTGeo::kNLayers;i++)</span>
<span class="lineNum">     947 </span><span class="lineCov">        234 :     if(labl[i][0]==label || labl[i][1]==label || labl[i][2]==label) lflag++;</span>
<span class="lineNum">     948 </span>            :   
<span class="lineNum">     949 </span><span class="lineCov">         24 :   if(lflag&lt;track-&gt;GetNumberOfClusters()) label = -label;</span>
<span class="lineNum">     950 </span>            :   return label;
<a name="951"><span class="lineNum">     951 </span><span class="lineCov">         16 : }</span></a>
<span class="lineNum">     952 </span>            : //_____________________________________________________________________________
<span class="lineNum">     953 </span>            : void AliITStrackerSA::SetCalculatedWindowSizes(Int_t n, Double_t phimin, Double_t phimax, Double_t lambdamin, Double_t lambdamax){
<span class="lineNum">     954 </span>            :   // Set sizes of the phi and lambda windows used for track finding
<span class="lineNum">     955 </span>            : 
<span class="lineNum">     956 </span><span class="lineCov">         16 :   if( n != fNloop){</span>
<span class="lineNum">     957 </span><span class="lineCov">          2 :     if(fPhiWin){</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :       delete [] fPhiWin;</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :       fPhiWin=0x0;</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     961 </span><span class="lineCov">          2 :     if(fLambdaWin){</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :       delete [] fLambdaWin;</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :       fLambdaWin=0x0;</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     965 </span>            :   }
<span class="lineNum">     966 </span><span class="lineCov">          8 :   fNloop = n;</span>
<span class="lineNum">     967 </span><span class="lineCov">         10 :   if(!fPhiWin) fPhiWin = new Double_t[fNloop];</span>
<span class="lineNum">     968 </span><span class="lineCov">         10 :   if(!fLambdaWin) fLambdaWin = new Double_t[fNloop];</span>
<span class="lineNum">     969 </span>            : 
<span class="lineNum">     970 </span><span class="lineCov">          8 :   Double_t stepPhi=(phimax-phimin)/(Double_t)(fNloop-1);</span>
<span class="lineNum">     971 </span><span class="lineCov">          8 :   Double_t stepLambda=(lambdamax-lambdamin)/(Double_t)(fNloop-1);</span>
<span class="lineNum">     972 </span><span class="lineCov">        336 :   for(Int_t k=0;k&lt;fNloop;k++){</span>
<span class="lineNum">     973 </span><span class="lineCov">        160 :     Double_t phi=phimin+k*stepPhi;</span>
<span class="lineNum">     974 </span><span class="lineCov">        160 :     Double_t lam=lambdamin+k*stepLambda;</span>
<span class="lineNum">     975 </span><span class="lineCov">        160 :     fPhiWin[k]=phi;</span>
<span class="lineNum">     976 </span><span class="lineCov">        160 :     fLambdaWin[k]=lam;</span>
<span class="lineNum">     977 </span>            :   }
<a name="978"><span class="lineNum">     978 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">     979 </span>            : //_____________________________________________________________________________
<span class="lineNum">     980 </span>            : void AliITStrackerSA::SetFixedWindowSizes(Int_t n, Double_t *phi, Double_t *lam){
<span class="lineNum">     981 </span>            :   // Set sizes of the phi and lambda windows used for track finding
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :   fNloop = n;</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :   if(phi){ // user defined values</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :     fPhiWin = new Double_t[fNloop];</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :     fLambdaWin = new Double_t[fNloop];</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :     for(Int_t k=0;k&lt;fNloop;k++){</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :       fPhiWin[k]=phi[k];</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :       fLambdaWin[k]=lam[k];</span>
<span class="lineNum">     989 </span>            :     }
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     991 </span>            :   else {  // default values
<span class="lineNum">     992 </span>            :             
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :     Double_t phid[32]   = {0.002,0.003,0.004,0.0045,0.0047,</span>
<span class="lineNum">     994 </span>            :                            0.005,0.0053,0.0055,0.006,0.0063,
<span class="lineNum">     995 </span>            :                            0.0065,0.007,0.0073,0.0075,0.0077,
<span class="lineNum">     996 </span>            :                            0.008,0.0083,0.0085,0.0087,0.009,
<span class="lineNum">     997 </span>            :                            0.0095,0.0097,0.01,0.0105,0.011,
<span class="lineNum">     998 </span>            :                            0.0115,0.012,0.0125,0.013,0.0135,
<span class="lineNum">     999 </span>            :                            0.0140,0.0145};
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :     Double_t lambdad[32] = {0.003,0.004,0.005,0.005,0.005,</span>
<span class="lineNum">    1001 </span>            :                             0.005,0.005,0.006,0.006,0.006,
<span class="lineNum">    1002 </span>            :                             0.006,0.007,0.007,0.007,0.007,
<span class="lineNum">    1003 </span>            :                             0.007,0.007,0.007,0.007,0.007,
<span class="lineNum">    1004 </span>            :                             0.007,0.007,0.008,0.008,0.008,
<span class="lineNum">    1005 </span>            :                             0.008,0.008,0.008,0.008,0.008,
<span class="lineNum">    1006 </span>            :                             0.008,0.008};
<span class="lineNum">    1007 </span>            :     
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :     if(fNloop!=32){</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :       fNloop = 32;</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1011 </span>            :     
<span class="lineNum">    1012 </span>            :     
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :     fPhiWin = new Double_t[fNloop];</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :     fLambdaWin = new Double_t[fNloop];</span>
<span class="lineNum">    1015 </span>            : 
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :     Double_t factor=AliITSReconstructor::GetRecoParam()-&gt;GetFactorSAWindowSizes(); // possibility to enlarge windows for cosmics reco with large misalignments (A.Dainese)</span>
<span class="lineNum">    1017 </span>            :   
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :     for(Int_t k=0;k&lt;fNloop;k++){</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :       fPhiWin[k]=phid[k]*factor;</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :       fLambdaWin[k]=lambdad[k]*factor;</span>
<span class="lineNum">    1021 </span>            :     }
<span class="lineNum">    1022 </span>            :   
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1024 </span>            : 
<a name="1025"><span class="lineNum">    1025 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1026 </span>            : //_______________________________________________________________________
<span class="lineNum">    1027 </span>            : void AliITStrackerSA::GetCoorAngles(AliITSRecPoint* cl,Double_t &amp;phi,Double_t &amp;lambda, Double_t &amp;x, Double_t &amp;y,Double_t &amp;z, const Double_t* vertex){
<span class="lineNum">    1028 </span>            :   //Returns values of phi (azimuthal) and lambda angles for a given cluster
<span class="lineNum">    1029 </span>            : /*  
<span class="lineNum">    1030 </span>            :   Double_t rot[9];     fGeom-&gt;GetRotMatrix(module,rot);
<span class="lineNum">    1031 </span>            :   Int_t lay,lad,det; fGeom-&gt;GetModuleId(module,lay,lad,det);
<span class="lineNum">    1032 </span>            :   Double_t tx,ty,tz;  fGeom-&gt;GetTrans(lay,lad,det,tx,ty,tz);     
<span class="lineNum">    1033 </span>            : 
<span class="lineNum">    1034 </span>            :   Double_t alpha=TMath::ATan2(rot[1],rot[0])+TMath::Pi();
<span class="lineNum">    1035 </span>            :   Double_t phi1=TMath::Pi()/2+alpha;
<span class="lineNum">    1036 </span>            :   if (lay==1) phi1+=TMath::Pi();
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span>            :   Double_t cp=TMath::Cos(phi1), sp=TMath::Sin(phi1);
<span class="lineNum">    1039 </span>            :   Double_t r=tx*cp+ty*sp;
<span class="lineNum">    1040 </span>            : 
<span class="lineNum">    1041 </span>            :   xyz= r*cp - cl-&gt;GetY()*sp;
<span class="lineNum">    1042 </span>            :   y= r*sp + cl-&gt;GetY()*cp;
<span class="lineNum">    1043 </span>            :   z=cl-&gt;GetZ();
<span class="lineNum">    1044 </span>            : */
<span class="lineNum">    1045 </span><span class="lineCov">        496 :   Float_t xyz[3];</span>
<span class="lineNum">    1046 </span><span class="lineCov">        248 :   cl-&gt;GetGlobalXYZ(xyz);</span>
<span class="lineNum">    1047 </span><span class="lineCov">        248 :   x=xyz[0];</span>
<span class="lineNum">    1048 </span><span class="lineCov">        248 :   y=xyz[1];</span>
<span class="lineNum">    1049 </span><span class="lineCov">        248 :   z=xyz[2];</span>
<span class="lineNum">    1050 </span>            :  
<span class="lineNum">    1051 </span><span class="lineCov">        248 :   phi=TMath::ATan2(y-vertex[1],x-vertex[0]);</span>
<span class="lineNum">    1052 </span><span class="lineCov">        248 :   lambda=TMath::ATan2(z-vertex[2],TMath::Sqrt((x-vertex[0])*(x-vertex[0])+(y-vertex[1])*(y-vertex[1])));</span>
<span class="lineNum">    1053 </span><span class="lineCov">        248 : }</span>
<a name="1054"><span class="lineNum">    1054 </span>            : </a>
<span class="lineNum">    1055 </span>            : //________________________________________________________________________
<span class="lineNum">    1056 </span>            : void AliITStrackerSA::GetCoorErrors(AliITSRecPoint* cl,Double_t &amp;sx,Double_t &amp;sy, Double_t &amp;sz){
<span class="lineNum">    1057 </span>            : 
<span class="lineNum">    1058 </span>            :   //returns sigmax, y, z of cluster in global coordinates
<span class="lineNum">    1059 </span>            : /*
<span class="lineNum">    1060 </span>            :   Double_t rot[9];     fGeom-&gt;GetRotMatrix(module,rot);
<span class="lineNum">    1061 </span>            :   Int_t lay,lad,det; 
<span class="lineNum">    1062 </span>            :   AliITSgeomTGeo::GetModuleId(module,lay,lad,det);
<span class="lineNum">    1063 </span>            :  
<span class="lineNum">    1064 </span>            :   Double_t alpha=TMath::ATan2(rot[1],rot[0])+TMath::Pi();
<span class="lineNum">    1065 </span>            :   Double_t phi=TMath::Pi()/2+alpha;
<span class="lineNum">    1066 </span>            :   if (lay==1) phi+=TMath::Pi();
<span class="lineNum">    1067 </span>            : 
<span class="lineNum">    1068 </span>            :   Double_t cp=TMath::Cos(phi), sp=TMath::Sin(phi);
<span class="lineNum">    1069 </span>            : */
<span class="lineNum">    1070 </span><span class="lineCov">        496 :   Float_t covm[6];</span>
<span class="lineNum">    1071 </span><span class="lineCov">        248 :   cl-&gt;GetGlobalCov(covm);</span>
<span class="lineNum">    1072 </span><span class="lineCov">        248 :   sx=TMath::Sqrt(covm[0]);</span>
<span class="lineNum">    1073 </span><span class="lineCov">        248 :   sy=TMath::Sqrt(covm[3]);</span>
<span class="lineNum">    1074 </span><span class="lineCov">        248 :   sz=TMath::Sqrt(covm[5]);</span>
<span class="lineNum">    1075 </span>            : /*
<span class="lineNum">    1076 </span>            :   sx = TMath::Sqrt(sp*sp*cl-&gt;GetSigmaY2());
<span class="lineNum">    1077 </span>            :   sy = TMath::Sqrt(cp*cp*cl-&gt;GetSigmaY2());
<span class="lineNum">    1078 </span>            :   sz = TMath::Sqrt(cl-&gt;GetSigmaZ2());
<span class="lineNum">    1079 </span>            : */
<span class="lineNum">    1080 </span><span class="lineCov">        248 : }</span>
<a name="1081"><span class="lineNum">    1081 </span>            : </a>
<span class="lineNum">    1082 </span>            : //________________________________________________________________________
<span class="lineNum">    1083 </span>            : Int_t AliITStrackerSA::FindIndex(Int_t lay, Double_t lamVal) const {
<span class="lineNum">    1084 </span>            :   // Find the cluster at limit of lambda window 
<span class="lineNum">    1085 </span>            : 
<span class="lineNum">    1086 </span>            :   Int_t base = 0;
<span class="lineNum">    1087 </span><span class="lineCov">      34832 :   Int_t last = fCluCoord[lay]-&gt;GetEntriesFast()-1;</span>
<span class="lineNum">    1088 </span><span class="lineCov">      19440 :   if(last&lt;0) return 0;</span>
<span class="lineNum">    1089 </span>            :   Int_t position;
<span class="lineNum">    1090 </span><span class="lineCov">      15392 :   Double_t lamfirst=((AliITSclusterTable*)fCluCoord[lay]-&gt;At(base))-&gt;GetLambda();</span>
<span class="lineNum">    1091 </span><span class="lineCov">      17344 :   if(lamfirst&gt;lamVal) return base;</span>
<span class="lineNum">    1092 </span><span class="lineCov">      13440 :   Double_t lamlast=((AliITSclusterTable*)fCluCoord[lay]-&gt;At(last))-&gt;GetLambda();</span>
<span class="lineNum">    1093 </span><span class="lineCov">      22466 :   if(lamlast&lt;=lamVal) return last;</span>
<span class="lineNum">    1094 </span><span class="lineCov">       9029 :   while (last &gt;= base) {</span>
<span class="lineNum">    1095 </span><span class="lineCov">       9029 :     position = (base+last) / 2;</span>
<span class="lineNum">    1096 </span><span class="lineCov">       9029 :     Double_t a=((AliITSclusterTable*)fCluCoord[lay]-&gt;At(position))-&gt;GetLambda()-lamVal;</span>
<span class="lineNum">    1097 </span><span class="lineCov">       9029 :     Double_t b=((AliITSclusterTable*)fCluCoord[lay]-&gt;At(position+1))-&gt;GetLambda()-lamVal;</span>
<span class="lineNum">    1098 </span><span class="lineCov">      13443 :     if(a*b&lt;=0) return position;</span>
<span class="lineNum">    1099 </span><span class="lineCov">       7184 :     if(a&gt;0) last = position;</span>
<span class="lineNum">    1100 </span>            :     else  base = position;
<span class="lineNum">    1101 </span><span class="lineCov">       4615 :   }</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">    1103 </span><span class="lineCov">      17416 : }</span>
<span class="lineNum">    1104 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
