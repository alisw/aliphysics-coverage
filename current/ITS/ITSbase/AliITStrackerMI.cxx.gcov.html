<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - ITS/ITSbase/AliITStrackerMI.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">ITS/ITSbase</a> - AliITStrackerMI.cxx<span style="font-size: 80%;"> (source / <a href="AliITStrackerMI.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">2256</td>
            <td class="headerCovTableEntry">3118</td>
            <td class="headerCovTableEntryLo">72.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">69</td>
            <td class="headerCovTableEntry">88</td>
            <td class="headerCovTableEntryMed">78.4 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 2007-2009, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : /* $Id$ */
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">      18 </span>            : //               Implementation of the ITS tracker class
<span class="lineNum">      19 </span>            : //    It reads AliITSRecPoint clusters and creates AliITStrackMI tracks
<span class="lineNum">      20 </span>            : //                   and fills with them the ESD
<span class="lineNum">      21 </span>            : //          Origin: Marian Ivanov, CERN, Marian.Ivanov@cern.ch 
<span class="lineNum">      22 </span>            : //          Current support and development: 
<span class="lineNum">      23 </span>            : //                     Andrea Dainese, andrea.dainese@lnl.infn.it
<span class="lineNum">      24 </span>            : //     dE/dx analysis by: Boris Batyunya, JINR, Boris.Batiounia@cern.ch
<span class="lineNum">      25 </span>            : //     Params moved to AliITSRecoParam by: Andrea Dainese, INFN
<span class="lineNum">      26 </span>            : //     Material budget from TGeo by: Ludovic Gaudichet &amp; Andrea Dainese, INFN
<span class="lineNum">      27 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #include &lt;TMatrixD.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;TTree.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;TDatabasePDG.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;TString.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;TRandom.h&gt;
<span class="lineNum">      34 </span>            : #include &lt;TTreeStream.h&gt;
<span class="lineNum">      35 </span>            : #include &lt;TVector3.h&gt;
<span class="lineNum">      36 </span>            : #include &lt;TBits.h&gt;
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;AliGeomManager.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;AliITSPlaneEff.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;AliTrackPointArray.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;AliESDEvent.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;AliESDV0Params.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;AliESDtrack.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;AliV0.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;AliITSChannelStatus.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;AliITSDetTypeRec.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;AliITSRecPoint.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;AliITSRecPointContainer.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;AliITSgeomTGeo.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;AliITSReconstructor.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;AliITSClusterParam.h&quot;
<span class="lineNum">      53 </span>            : #include &quot;AliITSsegmentation.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;AliITSCalibration.h&quot;
<span class="lineNum">      55 </span>            : #include &quot;AliITSPlaneEffSPD.h&quot;
<span class="lineNum">      56 </span>            : #include &quot;AliITSPlaneEffSDD.h&quot;
<span class="lineNum">      57 </span>            : #include &quot;AliITSPlaneEffSSD.h&quot;
<span class="lineNum">      58 </span>            : #include &quot;AliITSV0Finder.h&quot;
<span class="lineNum">      59 </span>            : #include &quot;AliITStrackerMI.h&quot;
<span class="lineNum">      60 </span>            : #include &quot;AliMathBase.h&quot;
<span class="lineNum">      61 </span>            : #include &quot;AliPID.h&quot;
<a name="62"><span class="lineNum">      62 </span>            : </a>
<span class="lineNum">      63 </span>            : 
<a name="64"><span class="lineNum">      64 </span><span class="lineCov">        118 : ClassImp(AliITStrackerMI)</span></a>
<span class="lineNum">      65 </span>            : 
<a name="66"><span class="lineNum">      66 </span><span class="lineCov">       1062 : AliITStrackerMI::AliITSlayer AliITStrackerMI::fgLayers[AliITSgeomTGeo::kNLayers]; // ITS layers</span></a>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span><span class="lineNoCov">          0 : AliITStrackerMI::AliITStrackerMI():AliTracker(),</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 : fI(0),</span>
<span class="lineNum">      70 </span><span class="lineNoCov">          0 : fBestTrack(),</span>
<span class="lineNum">      71 </span><span class="lineNoCov">          0 : fTrackToFollow(),</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 : fTrackHypothesys(),</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 : fBestHypothesys(),</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 : fOriginal(),</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 : fCurrentEsdTrack(),</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 : fPass(0),</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 : fAfterV0(kFALSE),</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 : fLastLayerToTrackTo(0),</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 : fCoefficients(0),</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 : fEsd(0),</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 : fTrackingPhase(&quot;Default&quot;),</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 : fUseTGeo(3),</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 : fNtracks(0),</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 : fFlagFakes(kFALSE),</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 : fSelectBestMIP03(kFALSE),</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 : fUseImproveKalman(kFALSE),</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 : fxOverX0Pipe(-1.),</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 : fxTimesRhoPipe(-1.),</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 : fxOverX0PipeTrks(0),</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 : fxTimesRhoPipeTrks(0),</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 : fxOverX0ShieldTrks(0),</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 : fxTimesRhoShieldTrks(0),</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 : fxOverX0LayerTrks(0),</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 : fxTimesRhoLayerTrks(0),</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 : fDebugStreamer(0),</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 : fITSChannelStatus(0),</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 : fkDetTypeRec(0),</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 : fPlaneEff(0),</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 : fSPDChipIntPlaneEff(0),</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 : fITSPid(0)</span>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :  {</span>
<span class="lineNum">     103 </span>            :   //Default constructor
<span class="lineNum">     104 </span>            :   Int_t i;
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;4;i++) fSPDdetzcentre[i]=0.;</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;2;i++) {</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     fxOverX0Shield[i]=-1.;</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :     fxTimesRhoShield[i]=-1.;</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :     fConstraint[i]=0;</span>
<span class="lineNum">     110 </span>            :   }
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;6;i++) {fxOverX0Layer[i]=-1.;fxTimesRhoLayer[i]=-1.;}</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :   fOriginal.SetOwner();</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;AliITSgeomTGeo::kNLayers;i++)fForceSkippingOfLayer[i]=0;</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;100000;i++)fBestTrackIndex[i]=0;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :   fITSPid=new AliITSPIDResponse();</span>
<span class="lineNum">     116 </span>            : 
<a name="117"><span class="lineNum">     117 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     118 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     119 </span><span class="lineCov">         28 : AliITStrackerMI::AliITStrackerMI(const Char_t *geom) : AliTracker(),</span>
<span class="lineNum">     120 </span><span class="lineCov">          2 : fI(AliITSgeomTGeo::GetNLayers()),</span>
<span class="lineNum">     121 </span><span class="lineCov">          2 : fBestTrack(),</span>
<span class="lineNum">     122 </span><span class="lineCov">          2 : fTrackToFollow(),</span>
<span class="lineNum">     123 </span><span class="lineCov">          2 : fTrackHypothesys(),</span>
<span class="lineNum">     124 </span><span class="lineCov">          2 : fBestHypothesys(),</span>
<span class="lineNum">     125 </span><span class="lineCov">          2 : fOriginal(),</span>
<span class="lineNum">     126 </span><span class="lineCov">          2 : fCurrentEsdTrack(),</span>
<span class="lineNum">     127 </span><span class="lineCov">          2 : fPass(0),</span>
<span class="lineNum">     128 </span><span class="lineCov">          2 : fAfterV0(kFALSE),</span>
<span class="lineNum">     129 </span><span class="lineCov">          2 : fLastLayerToTrackTo(AliITSRecoParam::GetLastLayerToTrackTo()),</span>
<span class="lineNum">     130 </span><span class="lineCov">          2 : fCoefficients(0),</span>
<span class="lineNum">     131 </span><span class="lineCov">          2 : fEsd(0),</span>
<span class="lineNum">     132 </span><span class="lineCov">          2 : fTrackingPhase(&quot;Default&quot;),</span>
<span class="lineNum">     133 </span><span class="lineCov">          2 : fUseTGeo(3),</span>
<span class="lineNum">     134 </span><span class="lineCov">          2 : fNtracks(0),</span>
<span class="lineNum">     135 </span><span class="lineCov">          2 : fFlagFakes(kFALSE),</span>
<span class="lineNum">     136 </span><span class="lineCov">          2 : fSelectBestMIP03(kFALSE),</span>
<span class="lineNum">     137 </span><span class="lineCov">          2 : fUseImproveKalman(kFALSE),</span>
<span class="lineNum">     138 </span><span class="lineCov">          2 : fxOverX0Pipe(-1.),</span>
<span class="lineNum">     139 </span><span class="lineCov">          2 : fxTimesRhoPipe(-1.),</span>
<span class="lineNum">     140 </span><span class="lineCov">          2 : fxOverX0PipeTrks(0),</span>
<span class="lineNum">     141 </span><span class="lineCov">          2 : fxTimesRhoPipeTrks(0),</span>
<span class="lineNum">     142 </span><span class="lineCov">          2 : fxOverX0ShieldTrks(0),</span>
<span class="lineNum">     143 </span><span class="lineCov">          2 : fxTimesRhoShieldTrks(0),</span>
<span class="lineNum">     144 </span><span class="lineCov">          2 : fxOverX0LayerTrks(0),</span>
<span class="lineNum">     145 </span><span class="lineCov">          2 : fxTimesRhoLayerTrks(0),</span>
<span class="lineNum">     146 </span><span class="lineCov">          2 : fDebugStreamer(0),</span>
<span class="lineNum">     147 </span><span class="lineCov">          2 : fITSChannelStatus(0),</span>
<span class="lineNum">     148 </span><span class="lineCov">          2 : fkDetTypeRec(0),</span>
<span class="lineNum">     149 </span><span class="lineCov">          2 : fPlaneEff(0),</span>
<span class="lineNum">     150 </span><span class="lineCov">          2 : fSPDChipIntPlaneEff(0),</span>
<span class="lineNum">     151 </span><span class="lineCov">          8 : fITSPid(0) {</span>
<span class="lineNum">     152 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     153 </span>            :   //This is the AliITStrackerMI constructor
<span class="lineNum">     154 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     155 </span><span class="lineCov">          2 :   if (geom) {</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :     AliWarning(&quot;\&quot;geom\&quot; is actually a dummy argument !&quot;);</span>
<span class="lineNum">     157 </span>            :   }
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineCov">          2 :   fOriginal.SetOwner();</span>
<span class="lineNum">     160 </span><span class="lineCov">          2 :   fCoefficients = 0;</span>
<span class="lineNum">     161 </span><span class="lineCov">          2 :   fAfterV0     = kFALSE;</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineCov">         28 :   for (Int_t i=1; i&lt;AliITSgeomTGeo::GetNLayers()+1; i++) {</span>
<span class="lineNum">     164 </span><span class="lineCov">         12 :     Int_t nlad=AliITSgeomTGeo::GetNLadders(i);</span>
<span class="lineNum">     165 </span><span class="lineCov">         12 :     Int_t ndet=AliITSgeomTGeo::GetNDetectors(i);</span>
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span><span class="lineCov">         12 :     Double_t xyz[3]={0}, &amp;x=xyz[0], &amp;y=xyz[1], &amp;z=xyz[2];</span>
<span class="lineNum">     168 </span><span class="lineCov">         12 :     AliITSgeomTGeo::GetTranslation(i,1,1,xyz); </span>
<span class="lineNum">     169 </span><span class="lineCov">         12 :     Double_t poff=TMath::ATan2(y,x);</span>
<span class="lineNum">     170 </span><span class="lineCov">         12 :     Double_t zoff=z;</span>
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span><span class="lineCov">         12 :     AliITSgeomTGeo::GetOrigTranslation(i,1,1,xyz);</span>
<span class="lineNum">     173 </span><span class="lineCov">         12 :     Double_t r=TMath::Sqrt(x*x + y*y);</span>
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span><span class="lineCov">         12 :     AliITSgeomTGeo::GetOrigTranslation(i,1,2,xyz);</span>
<span class="lineNum">     176 </span><span class="lineCov">         12 :     r += TMath::Sqrt(x*x + y*y);</span>
<span class="lineNum">     177 </span><span class="lineCov">         12 :     AliITSgeomTGeo::GetOrigTranslation(i,2,1,xyz);</span>
<span class="lineNum">     178 </span><span class="lineCov">         12 :     r += TMath::Sqrt(x*x + y*y);</span>
<span class="lineNum">     179 </span><span class="lineCov">         12 :     AliITSgeomTGeo::GetOrigTranslation(i,2,2,xyz);</span>
<span class="lineNum">     180 </span><span class="lineCov">         12 :     r += TMath::Sqrt(x*x + y*y);</span>
<span class="lineNum">     181 </span><span class="lineCov">         12 :     r*=0.25;</span>
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span><span class="lineCov">         12 :     new (fgLayers+i-1) AliITSlayer(r,poff,zoff,nlad,ndet);</span>
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span><span class="lineCov">        696 :     for (Int_t j=1; j&lt;nlad+1; j++) {</span>
<span class="lineNum">     186 </span><span class="lineCov">       9464 :       for (Int_t k=1; k&lt;ndet+1; k++) { //Fill this layer with detectors</span>
<span class="lineNum">     187 </span><span class="lineCov">       8792 :         TGeoHMatrix m; AliITSgeomTGeo::GetOrigMatrix(i,j,k,m);</span>
<span class="lineNum">     188 </span><span class="lineCov">       4396 :         const TGeoHMatrix *tm=AliITSgeomTGeo::GetTracking2LocalMatrix(i,j,k);</span>
<span class="lineNum">     189 </span><span class="lineCov">       4396 :         m.Multiply(tm);</span>
<span class="lineNum">     190 </span><span class="lineCov">       4396 :         Double_t txyz[3]={0.};</span>
<span class="lineNum">     191 </span><span class="lineCov">       4396 :         xyz[0]=0.;xyz[1]=0.;xyz[2]=0.;</span>
<span class="lineNum">     192 </span><span class="lineCov">       4396 :         m.LocalToMaster(txyz,xyz);</span>
<span class="lineNum">     193 </span><span class="lineCov">       4396 :         r=TMath::Sqrt(xyz[0]*xyz[0] + xyz[1]*xyz[1]);</span>
<span class="lineNum">     194 </span><span class="lineCov">       4396 :         Double_t phi=TMath::ATan2(xyz[1],xyz[0]);</span>
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span><span class="lineCov">       8792 :         if (phi&lt;0) phi+=TMath::TwoPi();</span>
<span class="lineNum">     197 </span><span class="lineCov">       4396 :         else if (phi&gt;=TMath::TwoPi()) phi-=TMath::TwoPi();</span>
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span><span class="lineCov">       4396 :         AliITSdetector &amp;det=fgLayers[i-1].GetDetector((j-1)*ndet + k-1); </span>
<span class="lineNum">     200 </span><span class="lineCov">       4396 :         new(&amp;det) AliITSdetector(r,phi); </span>
<span class="lineNum">     201 </span>            :         // compute the real radius (with misalignment)
<span class="lineNum">     202 </span><span class="lineCov">       8792 :         TGeoHMatrix mmisal(*(AliITSgeomTGeo::GetMatrix(i,j,k)));</span>
<span class="lineNum">     203 </span><span class="lineCov">       4396 :         mmisal.Multiply(tm);</span>
<span class="lineNum">     204 </span><span class="lineCov">       4396 :         xyz[0]=0.;xyz[1]=0.;xyz[2]=0.;</span>
<span class="lineNum">     205 </span><span class="lineCov">       4396 :         mmisal.LocalToMaster(txyz,xyz);</span>
<span class="lineNum">     206 </span><span class="lineCov">       4396 :         Double_t rmisal=TMath::Sqrt(xyz[0]*xyz[0] + xyz[1]*xyz[1]);</span>
<span class="lineNum">     207 </span><span class="lineCov">       4396 :         det.SetRmisal(rmisal);</span>
<span class="lineNum">     208 </span>            :         
<span class="lineNum">     209 </span><span class="lineCov">       4396 :       } // end loop on detectors</span>
<span class="lineNum">     210 </span>            :     } // end loop on ladders
<span class="lineNum">     211 </span><span class="lineCov">         12 :     fForceSkippingOfLayer[i-1] = 0;</span>
<span class="lineNum">     212 </span><span class="lineCov">         12 :   } // end loop on layers</span>
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span><span class="lineCov">          2 :   fI=AliITSgeomTGeo::GetNLayers();</span>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineCov">          2 :   fPass=0;</span>
<span class="lineNum">     218 </span><span class="lineCov">          2 :   fConstraint[0]=1; fConstraint[1]=0;</span>
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span><span class="lineCov">          8 :   Double_t xyzVtx[]={AliITSReconstructor::GetRecoParam()-&gt;GetXVdef(),</span>
<span class="lineNum">     221 </span><span class="lineCov">          4 :                      AliITSReconstructor::GetRecoParam()-&gt;GetYVdef(),</span>
<span class="lineNum">     222 </span><span class="lineCov">          4 :                      AliITSReconstructor::GetRecoParam()-&gt;GetZVdef()}; </span>
<span class="lineNum">     223 </span><span class="lineCov">          8 :   Double_t ersVtx[]={AliITSReconstructor::GetRecoParam()-&gt;GetSigmaXVdef(),</span>
<span class="lineNum">     224 </span><span class="lineCov">          4 :                      AliITSReconstructor::GetRecoParam()-&gt;GetSigmaYVdef(),</span>
<span class="lineNum">     225 </span><span class="lineCov">          4 :                      AliITSReconstructor::GetRecoParam()-&gt;GetSigmaZVdef()}; </span>
<span class="lineNum">     226 </span><span class="lineCov">          2 :   SetVertex(xyzVtx,ersVtx);</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineCov">          2 :   fLastLayerToTrackTo=AliITSRecoParam::GetLastLayerToTrackTo();</span>
<span class="lineNum">     229 </span><span class="lineCov">     400004 :   for (Int_t i=0;i&lt;100000;i++){</span>
<span class="lineNum">     230 </span><span class="lineCov">     200000 :     fBestTrackIndex[i]=0;</span>
<span class="lineNum">     231 </span>            :   }
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span>            :   // store positions of centre of SPD modules (in z)
<span class="lineNum">     234 </span>            :   //  The convetion is that fSPDdetzcentre is ordered from -z to +z
<span class="lineNum">     235 </span><span class="lineCov">          2 :   Double_t tr[3]={0};</span>
<span class="lineNum">     236 </span><span class="lineCov">          2 :   AliITSgeomTGeo::GetTranslation(1,1,1,tr);</span>
<span class="lineNum">     237 </span><span class="lineCov">          2 :   if (tr[2]&lt;0) { // old geom (up to v5asymmPPR)</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :     AliITSgeomTGeo::GetTranslation(1,1,1,tr);</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :     fSPDdetzcentre[0] = tr[2];</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :     AliITSgeomTGeo::GetTranslation(1,1,2,tr);</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     fSPDdetzcentre[1] = tr[2];</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     AliITSgeomTGeo::GetTranslation(1,1,3,tr);</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :     fSPDdetzcentre[2] = tr[2];</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :     AliITSgeomTGeo::GetTranslation(1,1,4,tr);</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :     fSPDdetzcentre[3] = tr[2];</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :   } else { // new geom (from v11Hybrid)</span>
<span class="lineNum">     247 </span><span class="lineCov">          2 :     AliITSgeomTGeo::GetTranslation(1,1,4,tr);</span>
<span class="lineNum">     248 </span><span class="lineCov">          2 :     fSPDdetzcentre[0] = tr[2];</span>
<span class="lineNum">     249 </span><span class="lineCov">          2 :     AliITSgeomTGeo::GetTranslation(1,1,3,tr);</span>
<span class="lineNum">     250 </span><span class="lineCov">          2 :     fSPDdetzcentre[1] = tr[2];</span>
<span class="lineNum">     251 </span><span class="lineCov">          2 :     AliITSgeomTGeo::GetTranslation(1,1,2,tr);</span>
<span class="lineNum">     252 </span><span class="lineCov">          2 :     fSPDdetzcentre[2] = tr[2];</span>
<span class="lineNum">     253 </span><span class="lineCov">          2 :     AliITSgeomTGeo::GetTranslation(1,1,1,tr);</span>
<span class="lineNum">     254 </span><span class="lineCov">          2 :     fSPDdetzcentre[3] = tr[2];</span>
<span class="lineNum">     255 </span>            :   }
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span><span class="lineCov">          4 :   fUseTGeo = AliITSReconstructor::GetRecoParam()-&gt;GetUseTGeoInTracker();</span>
<span class="lineNum">     258 </span><span class="lineCov">          8 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetExtendedEtaAcceptance() &amp;&amp; fUseTGeo!=1 &amp;&amp; fUseTGeo!=3) {</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :     AliWarning(&quot;fUseTGeo changed to 3 because fExtendedEtaAcceptance is kTRUE&quot;);</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :     fUseTGeo = 3;</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span><span class="lineCov">         12 :   for(Int_t i=0;i&lt;2;i++) {fxOverX0Shield[i]=-1.;fxTimesRhoShield[i]=-1.;}</span>
<span class="lineNum">     264 </span><span class="lineCov">         28 :   for(Int_t i=0;i&lt;6;i++) {fxOverX0Layer[i]=-1.;fxTimesRhoLayer[i]=-1.;}</span>
<span class="lineNum">     265 </span>            :   
<span class="lineNum">     266 </span><span class="lineCov">          4 :   if (AliITSReconstructor::GetRecoParam()-&gt;GetESDV0Params()-&gt;StreamLevel()&gt;0)</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     fDebugStreamer = new TTreeSRedirector(&quot;ITSdebug.root&quot;);</span>
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span>            :   // only for plane efficiency evaluation
<span class="lineNum">     270 </span><span class="lineCov">          4 :   if (AliITSReconstructor::GetRecoParam()-&gt;GetComputePlaneEff() &amp;&amp;</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :       AliITSReconstructor::GetRecoParam()-&gt;GetIPlanePlaneEff()&gt;=0) {</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     Int_t iplane=AliITSReconstructor::GetRecoParam()-&gt;GetIPlanePlaneEff();</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     if(AliITSReconstructor::GetRecoParam()-&gt;GetLayersToSkip(iplane)!=1)</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot;Evaluation of Plane Eff for layer %d will be attempted without removing it from tracker&quot;,iplane));</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :     if (iplane&lt;2) {</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :       fPlaneEff = new AliITSPlaneEffSPD();</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :       fSPDChipIntPlaneEff = new Bool_t[AliITSPlaneEffSPD::kNModule*AliITSPlaneEffSPD::kNChip];</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :       for (UInt_t i=0; i&lt;AliITSPlaneEffSPD::kNModule*AliITSPlaneEffSPD::kNChip; i++) fSPDChipIntPlaneEff[i]=kFALSE;</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :     else if (iplane&lt;4) fPlaneEff = new AliITSPlaneEffSDD();</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :     else fPlaneEff = new AliITSPlaneEffSSD();</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :     if(AliITSReconstructor::GetRecoParam()-&gt;GetReadPlaneEffFromOCDB())</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :        if(!fPlaneEff-&gt;ReadFromCDB()) {AliWarning(&quot;AliITStrackerMI reading of AliITSPlaneEff from OCDB failed&quot;) ;}</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     if(AliITSReconstructor::GetRecoParam()-&gt;GetHistoPlaneEff()) fPlaneEff-&gt;SetCreateHistos(kTRUE);</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     286 </span>            :   //
<span class="lineNum">     287 </span>            :   // RS
<span class="lineNum">     288 </span><span class="lineCov">          2 :   fSelectBestMIP03  = kFALSE;//AliITSReconstructor::GetRecoParam()-&gt;GetSelectBestMIP03();</span>
<span class="lineNum">     289 </span><span class="lineCov">          4 :   fFlagFakes        = AliITSReconstructor::GetRecoParam()-&gt;GetFlagFakes();</span>
<span class="lineNum">     290 </span><span class="lineCov">          4 :   fUseImproveKalman = AliITSReconstructor::GetRecoParam()-&gt;GetUseImproveKalman();</span>
<span class="lineNum">     291 </span>            :   //
<span class="lineNum">     292 </span><span class="lineCov">          6 :   fITSPid=new AliITSPIDResponse();</span>
<span class="lineNum">     293 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">     294 </span>            : /*
<span class="lineNum">     295 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     296 </span>            : AliITStrackerMI::AliITStrackerMI(const AliITStrackerMI &amp;tracker):AliTracker(tracker),
<span class="lineNum">     297 </span>            : fI(tracker.fI),
<span class="lineNum">     298 </span>            : fBestTrack(tracker.fBestTrack),
<span class="lineNum">     299 </span>            : fTrackToFollow(tracker.fTrackToFollow),
<span class="lineNum">     300 </span>            : fTrackHypothesys(tracker.fTrackHypothesys),
<span class="lineNum">     301 </span>            : fBestHypothesys(tracker.fBestHypothesys),
<span class="lineNum">     302 </span>            : fOriginal(tracker.fOriginal),
<span class="lineNum">     303 </span>            : fCurrentEsdTrack(tracker.fCurrentEsdTrack),
<span class="lineNum">     304 </span>            : fPass(tracker.fPass),
<span class="lineNum">     305 </span>            : fAfterV0(tracker.fAfterV0),
<span class="lineNum">     306 </span>            : fLastLayerToTrackTo(tracker.fLastLayerToTrackTo),
<span class="lineNum">     307 </span>            : fCoefficients(tracker.fCoefficients),
<span class="lineNum">     308 </span>            : fEsd(tracker.fEsd),
<span class="lineNum">     309 </span>            : fTrackingPhase(tracker.fTrackingPhase),
<span class="lineNum">     310 </span>            : fUseTGeo(tracker.fUseTGeo),
<span class="lineNum">     311 </span>            : fNtracks(tracker.fNtracks),
<span class="lineNum">     312 </span>            : fFlagFakes(tracker.fFlagFakes),
<span class="lineNum">     313 </span>            : fSelectBestMIP03(tracker.fSelectBestMIP03),
<span class="lineNum">     314 </span>            : fxOverX0Pipe(tracker.fxOverX0Pipe),
<span class="lineNum">     315 </span>            : fxTimesRhoPipe(tracker.fxTimesRhoPipe),
<span class="lineNum">     316 </span>            : fxOverX0PipeTrks(0),
<span class="lineNum">     317 </span>            : fxTimesRhoPipeTrks(0),
<span class="lineNum">     318 </span>            : fxOverX0ShieldTrks(0),
<span class="lineNum">     319 </span>            : fxTimesRhoShieldTrks(0),
<span class="lineNum">     320 </span>            : fxOverX0LayerTrks(0),
<span class="lineNum">     321 </span>            : fxTimesRhoLayerTrks(0),
<span class="lineNum">     322 </span>            : fDebugStreamer(tracker.fDebugStreamer),
<span class="lineNum">     323 </span>            : fITSChannelStatus(tracker.fITSChannelStatus),
<span class="lineNum">     324 </span>            : fkDetTypeRec(tracker.fkDetTypeRec),
<span class="lineNum">     325 </span>            : fPlaneEff(tracker.fPlaneEff) {
<span class="lineNum">     326 </span>            :   //Copy constructor
<span class="lineNum">     327 </span>            :   fOriginal.SetOwner();
<span class="lineNum">     328 </span>            :   Int_t i;
<span class="lineNum">     329 </span>            :   for(i=0;i&lt;4;i++) {
<span class="lineNum">     330 </span>            :     fSPDdetzcentre[i]=tracker.fSPDdetzcentre[i];
<span class="lineNum">     331 </span>            :   }
<span class="lineNum">     332 </span>            :   for(i=0;i&lt;6;i++) {
<span class="lineNum">     333 </span>            :     fxOverX0Layer[i]=tracker.fxOverX0Layer[i];
<span class="lineNum">     334 </span>            :     fxTimesRhoLayer[i]=tracker.fxTimesRhoLayer[i];
<span class="lineNum">     335 </span>            :   }
<span class="lineNum">     336 </span>            :   for(i=0;i&lt;2;i++) {
<span class="lineNum">     337 </span>            :     fxOverX0Shield[i]=tracker.fxOverX0Shield[i];
<span class="lineNum">     338 </span>            :     fxTimesRhoShield[i]=tracker.fxTimesRhoShield[i];
<span class="lineNum">     339 </span>            :   }
<span class="lineNum">     340 </span>            : }
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     343 </span>            : AliITStrackerMI &amp; AliITStrackerMI::operator=(const AliITStrackerMI &amp;tracker){
<span class="lineNum">     344 </span>            :   //Assignment operator
<span class="lineNum">     345 </span>            :   this-&gt;~AliITStrackerMI();
<span class="lineNum">     346 </span>            :   new(this) AliITStrackerMI(tracker);
<span class="lineNum">     347 </span>            :   return *this;
<span class="lineNum">     348 </span>            : }
<a name="349"><span class="lineNum">     349 </span>            : */</a>
<span class="lineNum">     350 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     351 </span>            : AliITStrackerMI::~AliITStrackerMI()
<span class="lineNum">     352 </span><span class="lineCov">          4 : {</span>
<span class="lineNum">     353 </span>            :   //
<span class="lineNum">     354 </span>            :   //destructor
<span class="lineNum">     355 </span>            :   //
<span class="lineNum">     356 </span><span class="lineCov">          2 :   if (fCoefficients) delete [] fCoefficients;</span>
<span class="lineNum">     357 </span><span class="lineCov">          2 :   DeleteTrksMaterialLUT();</span>
<span class="lineNum">     358 </span><span class="lineCov">          2 :   if (fDebugStreamer) {</span>
<span class="lineNum">     359 </span>            :     //fDebugStreamer-&gt;Close();
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :     delete fDebugStreamer;</span>
<span class="lineNum">     361 </span>            :   }
<span class="lineNum">     362 </span><span class="lineCov">          6 :   if(fITSChannelStatus) delete fITSChannelStatus;</span>
<span class="lineNum">     363 </span><span class="lineCov">          2 :   if(fPlaneEff) delete fPlaneEff;</span>
<span class="lineNum">     364 </span><span class="lineCov">          6 :   if(fITSPid) delete fITSPid;</span>
<span class="lineNum">     365 </span><span class="lineCov">          2 :   if (fSPDChipIntPlaneEff) delete [] fSPDChipIntPlaneEff;</span>
<span class="lineNum">     366 </span>            : 
<a name="367"><span class="lineNum">     367 </span><span class="lineCov">         16 : }</span></a>
<span class="lineNum">     368 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     369 </span>            : void AliITStrackerMI::ReadBadFromDetTypeRec() {
<span class="lineNum">     370 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     371 </span>            :   //This function read ITS bad detectors, chips, channels from AliITSDetTypeRec
<span class="lineNum">     372 </span>            :   //i.e. from OCDB
<span class="lineNum">     373 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineCov">          4 :   if(!AliITSReconstructor::GetRecoParam()-&gt;GetUseBadZonesFromOCDB()) return;</span>
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span><span class="lineCov">          2 :   Info(&quot;ReadBadFromDetTypeRec&quot;,&quot;Reading info about bad ITS detectors and channels&quot;);</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineCov">          2 :   if(!fkDetTypeRec) Error(&quot;ReadBadFromDetTypeRec&quot;,&quot;AliITSDetTypeRec nof found!\n&quot;);</span>
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span>            :   // ITS channels map
<span class="lineNum">     382 </span><span class="lineCov">          2 :   if(fITSChannelStatus) delete fITSChannelStatus;</span>
<span class="lineNum">     383 </span><span class="lineCov">          4 :   fITSChannelStatus = new AliITSChannelStatus(fkDetTypeRec);</span>
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span>            :   // ITS detectors and chips
<span class="lineNum">     386 </span>            :   Int_t i=0,j=0,k=0,ndet=0;
<span class="lineNum">     387 </span><span class="lineCov">         28 :   for (i=1; i&lt;AliITSgeomTGeo::GetNLayers()+1; i++) {</span>
<span class="lineNum">     388 </span>            :     Int_t nBadDetsPerLayer=0;
<span class="lineNum">     389 </span><span class="lineCov">         12 :     ndet=AliITSgeomTGeo::GetNDetectors(i);    </span>
<span class="lineNum">     390 </span><span class="lineCov">        696 :     for (j=1; j&lt;AliITSgeomTGeo::GetNLadders(i)+1; j++) {</span>
<span class="lineNum">     391 </span><span class="lineCov">       9464 :       for (k=1; k&lt;ndet+1; k++) {</span>
<span class="lineNum">     392 </span><span class="lineCov">       4396 :         AliITSdetector &amp;det=fgLayers[i-1].GetDetector((j-1)*ndet + k-1);  </span>
<span class="lineNum">     393 </span><span class="lineCov">       4396 :         det.ReadBadDetectorAndChips(i-1,(j-1)*ndet + k-1,fkDetTypeRec);</span>
<span class="lineNum">     394 </span><span class="lineCov">       4576 :         if(det.IsBad()) {nBadDetsPerLayer++;}</span>
<span class="lineNum">     395 </span>            :       } // end loop on detectors
<span class="lineNum">     396 </span>            :     } // end loop on ladders
<span class="lineNum">     397 </span><span class="lineCov">         12 :     AliInfo(Form(&quot;Layer %d: %d bad out of %d&quot;,i-1,nBadDetsPerLayer,ndet*AliITSgeomTGeo::GetNLadders(i)));</span>
<span class="lineNum">     398 </span>            :   } // end loop on layers
<span class="lineNum">     399 </span>            :   
<span class="lineNum">     400 </span>            :   return;
<a name="401"><span class="lineNum">     401 </span><span class="lineCov">          2 : }</span></a>
<span class="lineNum">     402 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     403 </span>            : Int_t AliITStrackerMI::LoadClusters(TTree *cTree) {
<span class="lineNum">     404 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     405 </span>            :   //This function loads ITS clusters
<span class="lineNum">     406 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     407 </span>            :  
<span class="lineNum">     408 </span>            :   TClonesArray *clusters = NULL;
<span class="lineNum">     409 </span><span class="lineCov">         16 :   AliITSRecPointContainer* rpcont=AliITSRecPointContainer::Instance();</span>
<span class="lineNum">     410 </span><span class="lineCov">          8 :   clusters=rpcont-&gt;FetchClusters(0,cTree);</span>
<span class="lineNum">     411 </span><span class="lineCov">          8 :   if(!clusters) return 1;</span>
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span><span class="lineCov">          8 :   if(!(rpcont-&gt;IsSPDActive() || rpcont-&gt;IsSDDActive() || rpcont-&gt;IsSSDActive())){</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :       AliError(&quot;ITS is not in a known running configuration: SPD, SDD and SSD are not active&quot;);</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :       return 1;</span>
<span class="lineNum">     416 </span>            :   }
<span class="lineNum">     417 </span>            :   Int_t i=0,j=0,ndet=0;
<span class="lineNum">     418 </span>            :   Int_t detector=0;
<span class="lineNum">     419 </span><span class="lineCov">        112 :   for (i=0; i&lt;AliITSgeomTGeo::GetNLayers(); i++) {</span>
<span class="lineNum">     420 </span><span class="lineCov">         48 :     ndet=fgLayers[i].GetNdetectors();</span>
<span class="lineNum">     421 </span><span class="lineCov">         48 :     Int_t jmax = j + fgLayers[i].GetNladders()*ndet;</span>
<span class="lineNum">     422 </span><span class="lineCov">      35264 :     for (; j&lt;jmax; j++) {           </span>
<span class="lineNum">     423 </span>            :       //      if (!cTree-&gt;GetEvent(j)) continue;
<span class="lineNum">     424 </span><span class="lineCov">      17584 :       clusters = rpcont-&gt;UncheckedGetClusters(j);</span>
<span class="lineNum">     425 </span><span class="lineCov">      17584 :       if(!clusters)continue;</span>
<span class="lineNum">     426 </span><span class="lineCov">      17584 :       Int_t ncl=clusters-&gt;GetEntriesFast();</span>
<span class="lineNum">     427 </span><span class="lineCov">      17584 :       SignDeltas(clusters,GetZ());</span>
<span class="lineNum">     428 </span>            :  
<span class="lineNum">     429 </span><span class="lineCov">      35834 :       while (ncl--) {</span>
<span class="lineNum">     430 </span><span class="lineCov">        666 :         AliITSRecPoint *c=(AliITSRecPoint*)clusters-&gt;UncheckedAt(ncl);</span>
<span class="lineNum">     431 </span><span class="lineCov">        666 :         detector=c-&gt;GetDetectorIndex();</span>
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span><span class="lineCov">        666 :         if (!c-&gt;Misalign()) AliWarning(&quot;Can't misalign this cluster !&quot;);</span>
<span class="lineNum">     434 </span>            :         
<span class="lineNum">     435 </span><span class="lineCov">       1332 :         Int_t retval = fgLayers[i].InsertCluster(new AliITSRecPoint(*c));</span>
<span class="lineNum">     436 </span><span class="lineCov">        666 :         if(retval) {</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :           AliWarning(Form(&quot;Too many clusters on layer %d!&quot;,i));</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :           break;  </span>
<span class="lineNum">     439 </span>            :         } 
<span class="lineNum">     440 </span><span class="lineCov">        666 :       }</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span>            :       // add dead zone &quot;virtual&quot; cluster in SPD, if there is a cluster within 
<span class="lineNum">     443 </span>            :       // zwindow cm from the dead zone      
<span class="lineNum">     444 </span>            :       //  This method assumes that fSPDdetzcentre is ordered from -z to +z
<span class="lineNum">     445 </span><span class="lineCov">      19504 :       if (i&lt;2 &amp;&amp; AliITSReconstructor::GetRecoParam()-&gt;GetAddVirtualClustersInDeadZone()) {</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :         for (Float_t xdead = 0; xdead &lt; AliITSRecoParam::GetSPDdetxlength(); xdead += (i+1.)*AliITSReconstructor::GetRecoParam()-&gt;GetXPassDeadZoneHits()) {</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :           Int_t lab[4]   = {0,0,0,detector};</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :           Int_t info[3]  = {0,0,i};</span>
<span class="lineNum">     449 </span>            :           Float_t q      = 0.; // this identifies virtual clusters
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :           Float_t hit[6] = {xdead,</span>
<span class="lineNum">     451 </span>            :                             0.,
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :                             static_cast&lt;Float_t&gt;(AliITSReconstructor::GetRecoParam()-&gt;GetSigmaXDeadZoneHit2()),</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                             static_cast&lt;Float_t&gt;(AliITSReconstructor::GetRecoParam()-&gt;GetSigmaZDeadZoneHit2()),</span>
<span class="lineNum">     454 </span>            :                             q,
<span class="lineNum">     455 </span>            :                             0.};
<span class="lineNum">     456 </span>            :           Bool_t local   = kTRUE;
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :           Double_t zwindow = AliITSReconstructor::GetRecoParam()-&gt;GetZWindowDeadZone();</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :           hit[1] = fSPDdetzcentre[0]+0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :           if (TMath::Abs(fgLayers[i].GetDetector(detector).GetZmax()-hit[1])&lt;zwindow) </span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :             fgLayers[i].InsertCluster(new AliITSRecPoint(lab,hit,info,local));</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :           hit[1] = fSPDdetzcentre[1]-0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :           if (TMath::Abs(fgLayers[i].GetDetector(detector).GetZmax()-hit[1])&lt;zwindow) </span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :             fgLayers[i].InsertCluster(new AliITSRecPoint(lab,hit,info,local));</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :           hit[1] = fSPDdetzcentre[1]+0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :           if (TMath::Abs(fgLayers[i].GetDetector(detector).GetZmax()-hit[1])&lt;zwindow) </span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :             fgLayers[i].InsertCluster(new AliITSRecPoint(lab,hit,info,local));</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :           hit[1] = fSPDdetzcentre[2]-0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :           if (TMath::Abs(fgLayers[i].GetDetector(detector).GetZmax()-hit[1])&lt;zwindow) </span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :             fgLayers[i].InsertCluster(new AliITSRecPoint(lab,hit,info,local));</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :           hit[1] = fSPDdetzcentre[2]+0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :           if (TMath::Abs(fgLayers[i].GetDetector(detector).GetZmax()-hit[1])&lt;zwindow) </span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :             fgLayers[i].InsertCluster(new AliITSRecPoint(lab,hit,info,local));</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :           hit[1] = fSPDdetzcentre[3]-0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :           if (TMath::Abs(fgLayers[i].GetDetector(detector).GetZmax()-hit[1])&lt;zwindow) </span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :             fgLayers[i].InsertCluster(new AliITSRecPoint(lab,hit,info,local));</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :       } // &quot;virtual&quot; clusters in SPD</span>
<span class="lineNum">     478 </span>            :       
<span class="lineNum">     479 </span><span class="lineCov">      17584 :     }</span>
<span class="lineNum">     480 </span>            :     //
<span class="lineNum">     481 </span><span class="lineCov">         48 :     fgLayers[i].ResetRoad(); //road defined by the cluster density</span>
<span class="lineNum">     482 </span><span class="lineCov">         48 :     fgLayers[i].SortClusters();</span>
<span class="lineNum">     483 </span>            :   }
<span class="lineNum">     484 </span>            : 
<span class="lineNum">     485 </span>            :   // check whether we have to skip some layers
<span class="lineNum">     486 </span><span class="lineCov">          8 :   SetForceSkippingOfLayer();</span>
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span>            :   return 0;
<a name="489"><span class="lineNum">     489 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">     490 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     491 </span>            : void AliITStrackerMI::UnloadClusters() {
<span class="lineNum">     492 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     493 </span>            :   //This function unloads ITS clusters
<span class="lineNum">     494 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     495 </span><span class="lineCov">        120 :   for (Int_t i=0; i&lt;AliITSgeomTGeo::GetNLayers(); i++) fgLayers[i].ResetClusters();</span>
<a name="496"><span class="lineNum">     496 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">     497 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     498 </span>            : void AliITStrackerMI::FillClusterArray(TObjArray* array) const {
<span class="lineNum">     499 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     500 </span>            :   // Publishes all pointers to clusters known to the tracker into the
<span class="lineNum">     501 </span>            :   // passed object array.
<span class="lineNum">     502 </span>            :   // The ownership is not transfered - the caller is not expected to delete
<span class="lineNum">     503 </span>            :   // the clusters.
<span class="lineNum">     504 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :   for(Int_t i=0; i&lt;AliITSgeomTGeo::GetNLayers(); i++) {</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :     for(Int_t icl=0; icl&lt;fgLayers[i].GetNumberOfClusters(); icl++) {</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :       AliCluster *cl = (AliCluster*)fgLayers[i].GetCluster(icl);</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :       array-&gt;AddLast(cl);</span>
<span class="lineNum">     510 </span>            :     }
<span class="lineNum">     511 </span>            :   }
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :   return;</span>
<a name="514"><span class="lineNum">     514 </span>            : }</a>
<span class="lineNum">     515 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     516 </span>            : Int_t AliITStrackerMI::CorrectForTPCtoITSDeadZoneMaterial(AliITStrackMI *t) {
<span class="lineNum">     517 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     518 </span>            :   // Correction for the material between the TPC and the ITS
<span class="lineNum">     519 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     520 </span><span class="lineCov">        684 :   if (t-&gt;GetX() &gt; AliITSRecoParam::Getriw()) {   // inward direction </span>
<span class="lineNum">     521 </span><span class="lineCov">        246 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getriw(),1)) return 0;// TPC inner wall</span>
<span class="lineNum">     522 </span><span class="lineCov">        242 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getrcd(),1)) return 0;// TPC central drum</span>
<span class="lineNum">     523 </span><span class="lineCov">        242 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getrs(),1))  return 0;// ITS screen</span>
<span class="lineNum">     524 </span><span class="lineCov">         98 :   } else if (t-&gt;GetX() &lt; AliITSRecoParam::Getrs()) {  // outward direction</span>
<span class="lineNum">     525 </span><span class="lineCov">         98 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getrs(),1))        return 0;// ITS screen</span>
<span class="lineNum">     526 </span><span class="lineCov">         98 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getrcd(),1))       return 0;// TPC central drum</span>
<span class="lineNum">     527 </span><span class="lineCov">         98 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getriw()+0.001,1)) return 0;// TPC inner wall</span>
<span class="lineNum">     528 </span>            :   } else {
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :     printf(&quot;CorrectForTPCtoITSDeadZoneMaterial: Track is already in the dead zone !\n&quot;);</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     531 </span>            :   }
<span class="lineNum">     532 </span>            :   
<span class="lineNum">     533 </span><span class="lineCov">        340 :   return 1;</span>
<a name="534"><span class="lineNum">     534 </span><span class="lineCov">        342 : }</span></a>
<span class="lineNum">     535 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     536 </span>            : Int_t AliITStrackerMI::Clusters2Tracks(AliESDEvent *event) {
<span class="lineNum">     537 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     538 </span>            :   // This functions reconstructs ITS tracks
<span class="lineNum">     539 </span>            :   // The clusters must be already loaded !
<span class="lineNum">     540 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span><span class="lineCov">         32 :   AliDebug(2,Form(&quot;SKIPPING %d %d %d %d %d %d&quot;,ForceSkippingOfLayer(0),ForceSkippingOfLayer(1),ForceSkippingOfLayer(2),ForceSkippingOfLayer(3),ForceSkippingOfLayer(4),ForceSkippingOfLayer(5)));</span>
<span class="lineNum">     543 </span>            : 
<span class="lineNum">     544 </span><span class="lineCov">          8 :   fTrackingPhase=&quot;Clusters2Tracks&quot;;</span>
<span class="lineNum">     545 </span>            :   //
<span class="lineNum">     546 </span>            :   // RS
<span class="lineNum">     547 </span><span class="lineCov">          8 :   fSelectBestMIP03  = kFALSE;//AliITSReconstructor::GetRecoParam()-&gt;GetSelectBestMIP03();</span>
<span class="lineNum">     548 </span><span class="lineCov">          8 :   fFlagFakes        = AliITSReconstructor::GetRecoParam()-&gt;GetFlagFakes();</span>
<span class="lineNum">     549 </span><span class="lineCov">          8 :   fUseImproveKalman = AliITSReconstructor::GetRecoParam()-&gt;GetUseImproveKalman();</span>
<span class="lineNum">     550 </span>            :   //
<span class="lineNum">     551 </span><span class="lineCov">          8 :   double minPtCut = AliITSReconstructor::GetRecoParam()-&gt;GetMinPtForProlongation();</span>
<span class="lineNum">     552 </span>            :   // the pt cutoff is tuned for nominal 5kG field, scale it with real field
<span class="lineNum">     553 </span>            :   const double kNomField = 5.00668e+00;
<span class="lineNum">     554 </span><span class="lineCov">          8 :   minPtCut *= TMath::Abs(GetBz()/kNomField);</span>
<span class="lineNum">     555 </span>            :   //
<span class="lineNum">     556 </span><span class="lineCov">          8 :   TObjArray itsTracks(15000);</span>
<span class="lineNum">     557 </span><span class="lineCov">          8 :   fOriginal.Clear();</span>
<span class="lineNum">     558 </span><span class="lineCov">          8 :   fEsd = event;         // store pointer to the esd </span>
<span class="lineNum">     559 </span><span class="lineCov">          8 :   Bool_t checkInv = AliITSReconstructor::GetCheckInvariant(); // off in the special reco mode w/o invariant check</span>
<span class="lineNum">     560 </span>            :   // temporary (for cosmics)
<span class="lineNum">     561 </span><span class="lineCov">         16 :   if(event-&gt;GetVertex()) {</span>
<span class="lineNum">     562 </span><span class="lineCov">         24 :     TString title = event-&gt;GetVertex()-&gt;GetTitle();</span>
<span class="lineNum">     563 </span><span class="lineCov">         16 :     if(title.Contains(&quot;cosmics&quot;)) {</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :       Double_t xyz[3]={GetX(),GetY(),GetZ()};</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :       Double_t exyz[3]={0.1,0.1,0.1};</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :       SetVertex(xyz,exyz);</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     568 </span><span class="lineCov">          8 :   }</span>
<span class="lineNum">     569 </span>            :   // temporary
<span class="lineNum">     570 </span>            :   Int_t noesd = 0;
<span class="lineNum">     571 </span>            :   {/* Read ESD tracks */
<span class="lineNum">     572 </span><span class="lineCov">          8 :     Int_t nentr=event-&gt;GetNumberOfTracks();</span>
<span class="lineNum">     573 </span>            :     noesd=nentr;
<span class="lineNum">     574 </span>            :     //    Info(&quot;Clusters2Tracks&quot;, &quot;Number of ESD tracks: %d\n&quot;, nentr);
<span class="lineNum">     575 </span><span class="lineCov">        152 :     while (nentr--) {</span>
<span class="lineNum">     576 </span><span class="lineCov">        136 :       AliESDtrack *esd=event-&gt;GetTrack(nentr);</span>
<span class="lineNum">     577 </span>            :       //  ---- for debugging:
<span class="lineNum">     578 </span>            :       //if(TMath::Abs(esd-&gt;GetX()-83.65)&lt;0.1) { FILE *f=fopen(&quot;tpc.dat&quot;,&quot;a&quot;); fprintf(f,&quot;%f %f %f %f %f %f\n&quot;,(Float_t)event-&gt;GetEventNumberInFile(),(Float_t)TMath::Abs(esd-&gt;GetLabel()),(Float_t)esd-&gt;GetX(),(Float_t)esd-&gt;GetY(),(Float_t)esd-&gt;GetZ(),(Float_t)esd-&gt;Pt()); fclose(f); }
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span><span class="lineCov">        272 :       if ((esd-&gt;GetStatus()&amp;AliESDtrack::kTPCin)==0) continue;</span>
<span class="lineNum">     581 </span><span class="lineCov">        272 :       if (esd-&gt;GetStatus()&amp;AliESDtrack::kTPCout) continue;</span>
<span class="lineNum">     582 </span><span class="lineCov">        272 :       if (esd-&gt;GetStatus()&amp;AliESDtrack::kITSin) continue;</span>
<span class="lineNum">     583 </span><span class="lineCov">        276 :       if (esd-&gt;GetKinkIndex(0)&gt;0) continue;   //kink daughter</span>
<span class="lineNum">     584 </span><span class="lineCov">        264 :       AliITStrackMI *t = new AliITStrackMI(*esd);</span>
<span class="lineNum">     585 </span><span class="lineCov">        132 :       t-&gt;SetCheckInvariant(checkInv);</span>
<span class="lineNum">     586 </span><span class="lineCov">        132 :       t-&gt;GetDZ(GetX(),GetY(),GetZ(),t-&gt;GetDP());              //I.B.</span>
<span class="lineNum">     587 </span><span class="lineCov">        132 :       Double_t vdist = TMath::Sqrt(t-&gt;GetD(0)*t-&gt;GetD(0)+t-&gt;GetD(1)*t-&gt;GetD(1));</span>
<span class="lineNum">     588 </span>            : 
<span class="lineNum">     589 </span>            :       // write expected q
<span class="lineNum">     590 </span><span class="lineCov">        264 :       t-&gt;SetExpQ(TMath::Max(0.8*t-&gt;GetESDtrack()-&gt;GetTPCsignal(),30.));</span>
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineCov">        132 :       if (esd-&gt;GetV0Index(0)&gt;0 &amp;&amp; t-&gt;GetD(0)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxDforV0dghtrForProlongation()){</span>
<span class="lineNum">     593 </span>            :         //track - can be  V0 according to TPC
<span class="lineNum">     594 </span>            :       } else {  
<span class="lineNum">     595 </span><span class="lineCov">        264 :         if (TMath::Abs(t-&gt;GetD(0))&gt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxDForProlongation()) {</span>
<span class="lineNum">     596 </span><span class="lineCov">         12 :           delete t;</span>
<span class="lineNum">     597 </span><span class="lineCov">          6 :           continue;</span>
<span class="lineNum">     598 </span>            :         }       
<span class="lineNum">     599 </span><span class="lineCov">        252 :         if (TMath::Abs(vdist)&gt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxDZForProlongation()) {</span>
<span class="lineNum">     600 </span><span class="lineCov">          8 :           delete t;</span>
<span class="lineNum">     601 </span><span class="lineCov">          4 :           continue;</span>
<span class="lineNum">     602 </span>            :         }
<span class="lineNum">     603 </span><span class="lineCov">        244 :         if (t-&gt;Pt()&lt;minPtCut) {</span>
<span class="lineNum">     604 </span><span class="lineCov">         24 :           delete t;</span>
<span class="lineNum">     605 </span><span class="lineCov">         12 :           continue;</span>
<span class="lineNum">     606 </span>            :         }
<span class="lineNum">     607 </span><span class="lineCov">        220 :         if (!CorrectForTPCtoITSDeadZoneMaterial(t)) {</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :           delete t;</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     610 </span>            :         }
<span class="lineNum">     611 </span>            :       }
<span class="lineNum">     612 </span><span class="lineCov">        110 :       t-&gt;SetReconstructed(kFALSE);</span>
<span class="lineNum">     613 </span><span class="lineCov">        110 :       itsTracks.AddLast(t);</span>
<span class="lineNum">     614 </span><span class="lineCov">        110 :       fOriginal.AddLast(t);</span>
<span class="lineNum">     615 </span><span class="lineCov">        110 :     }</span>
<span class="lineNum">     616 </span>            :   } /* End Read ESD tracks */
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineCov">          8 :   itsTracks.Sort();</span>
<span class="lineNum">     619 </span><span class="lineCov">          8 :   fOriginal.Sort();</span>
<span class="lineNum">     620 </span><span class="lineCov">          8 :   Int_t nentr=itsTracks.GetEntriesFast();</span>
<span class="lineNum">     621 </span><span class="lineCov">          8 :   fTrackHypothesys.Expand(nentr);</span>
<span class="lineNum">     622 </span><span class="lineCov">          8 :   fBestHypothesys.Expand(nentr);</span>
<span class="lineNum">     623 </span><span class="lineCov">          8 :   MakeCoefficients(nentr);</span>
<span class="lineNum">     624 </span><span class="lineCov">         24 :   if(fUseTGeo==3 || fUseTGeo==4) MakeTrksMaterialLUT(event-&gt;GetNumberOfTracks());</span>
<span class="lineNum">     625 </span>            :   Int_t ntrk=0;
<span class="lineNum">     626 </span>            :   // THE TWO TRACKING PASSES
<span class="lineNum">     627 </span><span class="lineCov">         48 :   for (fPass=0; fPass&lt;2; fPass++) {</span>
<span class="lineNum">     628 </span><span class="lineCov">         16 :      Int_t &amp;constraint=fConstraint[fPass]; if (constraint&lt;0) continue;</span>
<span class="lineNum">     629 </span><span class="lineCov">        472 :      for (fCurrentEsdTrack=0; fCurrentEsdTrack&lt;nentr; fCurrentEsdTrack++) {</span>
<span class="lineNum">     630 </span><span class="lineCov">        220 :        AliITStrackMI *t=(AliITStrackMI*)itsTracks.UncheckedAt(fCurrentEsdTrack);</span>
<span class="lineNum">     631 </span><span class="lineCov">        220 :        if (t==0) continue;              //this track has been already tracked</span>
<span class="lineNum">     632 </span>            :        //cout&lt;&lt;&quot;========== &quot;&lt;&lt;fPass&lt;&lt;&quot;    &quot;&lt;&lt;fCurrentEsdTrack&lt;&lt;&quot; =========\n&quot;;
<span class="lineNum">     633 </span><span class="lineCov">        220 :        if (t-&gt;GetReconstructed()&amp;&amp;(t-&gt;GetNUsed()&lt;1.5)) continue;  //this track was  already  &quot;succesfully&quot; reconstructed</span>
<span class="lineNum">     634 </span><span class="lineCov">        220 :        Float_t dz[2]={0}; t-&gt;GetDZ(GetX(),GetY(),GetZ(),dz);              //I.B.</span>
<span class="lineNum">     635 </span><span class="lineCov">        220 :        if (fConstraint[fPass]) { </span>
<span class="lineNum">     636 </span><span class="lineCov">        316 :          if (TMath::Abs(dz[0])&gt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxDZToUseConstraint() ||</span>
<span class="lineNum">     637 </span><span class="lineCov">        206 :              TMath::Abs(dz[1])&gt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxDZToUseConstraint()) continue;</span>
<span class="lineNum">     638 </span>            :        }
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span><span class="lineCov">        206 :        Int_t tpcLabel=t-&gt;GetLabel(); //save the TPC track label       </span>
<span class="lineNum">     641 </span><span class="lineCov">       1030 :        AliDebug(2,Form(&quot;LABEL %d pass %d&quot;,tpcLabel,fPass));</span>
<span class="lineNum">     642 </span><span class="lineCov">        206 :        fI = 6;</span>
<span class="lineNum">     643 </span><span class="lineCov">        206 :        ResetTrackToFollow(*t);</span>
<span class="lineNum">     644 </span><span class="lineCov">        206 :        ResetBestTrack();</span>
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span><span class="lineCov">        206 :        FollowProlongationTree(t,fCurrentEsdTrack,fConstraint[fPass]);</span>
<span class="lineNum">     647 </span>            :  
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span><span class="lineCov">        206 :        SortTrackHypothesys(fCurrentEsdTrack,20,0);  //MI change</span>
<span class="lineNum">     650 </span>            :        //
<span class="lineNum">     651 </span><span class="lineCov">        206 :        AliITStrackMI *besttrack = GetBestHypothesys(fCurrentEsdTrack,t,15);</span>
<span class="lineNum">     652 </span><span class="lineCov">        254 :        if (!besttrack) continue;</span>
<span class="lineNum">     653 </span><span class="lineCov">        158 :        besttrack-&gt;SetLabel(tpcLabel);</span>
<span class="lineNum">     654 </span>            :        //       besttrack-&gt;CookdEdx();
<span class="lineNum">     655 </span><span class="lineCov">        158 :        CookdEdx(besttrack);</span>
<span class="lineNum">     656 </span><span class="lineCov">        158 :        besttrack-&gt;SetFakeRatio(1.);</span>
<span class="lineNum">     657 </span><span class="lineCov">        158 :        CookLabel(besttrack,0.); //For comparison only</span>
<span class="lineNum">     658 </span><span class="lineCov">        158 :        UpdateESDtrack(besttrack,AliESDtrack::kITSin);</span>
<span class="lineNum">     659 </span><span class="lineCov">        158 :        t-&gt;SetWinner(besttrack);</span>
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span><span class="lineCov">        386 :        if (fConstraint[fPass]&amp;&amp;(!besttrack-&gt;IsGoldPrimary())) continue;  //to be tracked also without vertex constrain </span>
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span><span class="lineCov">         82 :        t-&gt;SetReconstructed(kTRUE);</span>
<span class="lineNum">     664 </span><span class="lineCov">         82 :        ntrk++;  </span>
<span class="lineNum">     665 </span><span class="lineCov">        410 :        AliDebug(2,Form(&quot;TRACK! (label %d) ncls %d&quot;,besttrack-&gt;GetLabel(),besttrack-&gt;GetNumberOfClusters()));</span>
<span class="lineNum">     666 </span><span class="lineCov">        302 :      }</span>
<span class="lineNum">     667 </span><span class="lineCov">         16 :      GetBestHypothesysMIP(itsTracks); </span>
<span class="lineNum">     668 </span><span class="lineCov">         16 :   } // end loop on the two tracking passes</span>
<span class="lineNum">     669 </span>            :   //
<span class="lineNum">     670 </span><span class="lineCov">          8 :   if (fFlagFakes) FlagFakes(itsTracks);</span>
<span class="lineNum">     671 </span>            :   //
<span class="lineNum">     672 </span><span class="lineCov">         16 :   if(event-&gt;GetNumberOfV0s()&gt;0) AliITSV0Finder::UpdateTPCV0(event,this);</span>
<span class="lineNum">     673 </span><span class="lineCov">         24 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetFindV0s()) AliITSV0Finder::FindV02(event,this);</span>
<span class="lineNum">     674 </span><span class="lineCov">          8 :   fAfterV0 = kTRUE;</span>
<span class="lineNum">     675 </span>            :   //
<span class="lineNum">     676 </span><span class="lineCov">          8 :   itsTracks.Clear();</span>
<span class="lineNum">     677 </span>            :   //
<span class="lineNum">     678 </span><span class="lineCov">          8 :   Int_t entries = fTrackHypothesys.GetEntriesFast();</span>
<span class="lineNum">     679 </span><span class="lineCov">        228 :   for (Int_t ientry=0; ientry&lt;entries; ientry++) {</span>
<span class="lineNum">     680 </span><span class="lineCov">        212 :     TObjArray * array =(TObjArray*)fTrackHypothesys.At(ientry);</span>
<span class="lineNum">     681 </span><span class="lineCov">        188 :     if (array) array-&gt;Delete();</span>
<span class="lineNum">     682 </span><span class="lineCov">        294 :     delete fTrackHypothesys.RemoveAt(ientry); </span>
<span class="lineNum">     683 </span>            :   }
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span><span class="lineCov">          8 :   fTrackHypothesys.Delete();</span>
<span class="lineNum">     686 </span><span class="lineCov">          8 :   entries = fBestHypothesys.GetEntriesFast();</span>
<span class="lineNum">     687 </span><span class="lineCov">        236 :   for (Int_t ientry=0; ientry&lt;entries; ientry++) {</span>
<span class="lineNum">     688 </span><span class="lineCov">        220 :     TObjArray * array =(TObjArray*)fBestHypothesys.At(ientry);</span>
<span class="lineNum">     689 </span><span class="lineCov">        220 :     if (array) array-&gt;Delete();</span>
<span class="lineNum">     690 </span><span class="lineCov">        330 :     delete fBestHypothesys.RemoveAt(ientry);</span>
<span class="lineNum">     691 </span>            :   }
<span class="lineNum">     692 </span><span class="lineCov">          8 :   fBestHypothesys.Delete();</span>
<span class="lineNum">     693 </span><span class="lineCov">          8 :   fOriginal.Clear();</span>
<span class="lineNum">     694 </span><span class="lineCov">         16 :   delete [] fCoefficients;</span>
<span class="lineNum">     695 </span><span class="lineCov">          8 :   fCoefficients=0;</span>
<span class="lineNum">     696 </span><span class="lineCov">          8 :   DeleteTrksMaterialLUT();</span>
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineCov">         24 :   AliInfo(Form(&quot;Number of prolonged tracks: %d out of %d ESD tracks&quot;,ntrk,noesd));</span>
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span><span class="lineCov">          8 :   fTrackingPhase=&quot;Default&quot;;</span>
<span class="lineNum">     701 </span>            :   
<span class="lineNum">     702 </span>            :   return 0;
<a name="703"><span class="lineNum">     703 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">     704 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     705 </span>            : Int_t AliITStrackerMI::PropagateBack(AliESDEvent *event) {
<span class="lineNum">     706 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     707 </span>            :   // This functions propagates reconstructed ITS tracks back
<span class="lineNum">     708 </span>            :   // The clusters must be loaded !
<span class="lineNum">     709 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     710 </span><span class="lineCov">         16 :   fTrackingPhase=&quot;PropagateBack&quot;;</span>
<span class="lineNum">     711 </span><span class="lineCov">          8 :   Int_t nentr=event-&gt;GetNumberOfTracks();</span>
<span class="lineNum">     712 </span>            :   //  Info(&quot;PropagateBack&quot;, &quot;Number of ESD tracks: %d\n&quot;, nentr);
<span class="lineNum">     713 </span><span class="lineCov">          8 :   double bz0 = GetBz();</span>
<span class="lineNum">     714 </span>            :   const double kWatchStep=10.; // for larger steps watch arc vs segment difference
<span class="lineNum">     715 </span>            :   //
<span class="lineNum">     716 </span><span class="lineCov">          8 :   Bool_t checkInv = AliITSReconstructor::GetCheckInvariant(); // off in the special reco mode w/o invariant check</span>
<span class="lineNum">     717 </span>            :   Int_t ntrk=0;
<span class="lineNum">     718 </span><span class="lineCov">        320 :   for (Int_t i=0; i&lt;nentr; i++) {</span>
<span class="lineNum">     719 </span><span class="lineCov">        152 :      AliESDtrack *esd=event-&gt;GetTrack(i);</span>
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span>            :      // Start time integral and add distance from current position to vertex 
<span class="lineNum">     722 </span><span class="lineCov">        152 :      if (esd-&gt;GetStatus()&amp;AliESDtrack::kITSout) continue;</span>
<span class="lineNum">     723 </span><span class="lineCov">        152 :      AliITStrackMI t(*esd);</span>
<span class="lineNum">     724 </span><span class="lineCov">        152 :      t.SetCheckInvariant(checkInv);</span>
<span class="lineNum">     725 </span><span class="lineCov">        152 :      Double_t xyzTrk[3]={0},xyzVtx[3]={GetX(),GetY(),GetZ()};</span>
<span class="lineNum">     726 </span><span class="lineCov">        152 :      t.GetXYZ(xyzTrk); </span>
<span class="lineNum">     727 </span>            :      Double_t dst2 = 0.;
<span class="lineNum">     728 </span>            :      {
<span class="lineNum">     729 </span><span class="lineCov">        152 :        double dxs = xyzTrk[0] - xyzVtx[0];</span>
<span class="lineNum">     730 </span><span class="lineCov">        152 :        double dys = xyzTrk[1] - xyzVtx[1];</span>
<span class="lineNum">     731 </span><span class="lineCov">        152 :        double dzs = xyzTrk[2] - xyzVtx[2];</span>
<span class="lineNum">     732 </span>            :        // RS: for large segment steps d use approximation of cicrular arc s by
<span class="lineNum">     733 </span>            :        // s = 2R*asin(d/2R) = d/p asin(p) \approx d/p (p + 1/6 p^3) = d (1+1/6 p^2)
<span class="lineNum">     734 </span>            :        // where R is the track radius, p = d/2R = 2C*d (C is the abs curvature)
<span class="lineNum">     735 </span>            :        // Hence s^2/d^2 = (1+1/6 p^2)^2
<span class="lineNum">     736 </span><span class="lineCov">        152 :        dst2 = dxs*dxs + dys*dys;</span>
<span class="lineNum">     737 </span><span class="lineCov">        152 :        if (dst2 &gt; kWatchStep*kWatchStep) { // correct circular part for arc/segment factor</span>
<span class="lineNum">     738 </span><span class="lineCov">        120 :          double crv = TMath::Abs(esd-&gt;GetC(bz0));</span>
<span class="lineNum">     739 </span><span class="lineCov">         60 :          double fcarc = 1.+crv*crv*dst2/6.;</span>
<span class="lineNum">     740 </span><span class="lineCov">         60 :          dst2 *= fcarc*fcarc;</span>
<span class="lineNum">     741 </span><span class="lineCov">         60 :        }</span>
<span class="lineNum">     742 </span><span class="lineCov">        152 :        dst2 += dzs*dzs;</span>
<span class="lineNum">     743 </span>            :      }
<span class="lineNum">     744 </span><span class="lineCov">        152 :      t.StartTimeIntegral();</span>
<span class="lineNum">     745 </span><span class="lineCov">        152 :      t.AddTimeStep(TMath::Sqrt(dst2));</span>
<span class="lineNum">     746 </span>            :      //
<span class="lineNum">     747 </span>            :      // transfer the time integral to ESD track
<span class="lineNum">     748 </span><span class="lineCov">        152 :      esd-&gt;SetStatus(AliESDtrack::kTIME);</span>
<span class="lineNum">     749 </span><span class="lineCov">        152 :      Double_t times[AliPID::kSPECIESC]={0};</span>
<span class="lineNum">     750 </span><span class="lineCov">        152 :      t.GetIntegratedTimes(times,AliPID::kSPECIESC); </span>
<span class="lineNum">     751 </span><span class="lineCov">        152 :      esd-&gt;SetIntegratedTimes(times);</span>
<span class="lineNum">     752 </span><span class="lineCov">        304 :      esd-&gt;SetIntegratedLength(t.GetIntegratedLength());</span>
<span class="lineNum">     753 </span>            :      //
<span class="lineNum">     754 </span><span class="lineCov">        358 :      if ((esd-&gt;GetStatus()&amp;AliESDtrack::kITSin)==0) continue;</span>
<span class="lineNum">     755 </span>            : 
<span class="lineNum">     756 </span><span class="lineCov">        196 :      t.SetExpQ(TMath::Max(0.8*t.GetESDtrack()-&gt;GetTPCsignal(),30.));</span>
<span class="lineNum">     757 </span><span class="lineCov">         98 :      ResetTrackToFollow(t);</span>
<span class="lineNum">     758 </span>            :      //
<span class="lineNum">     759 </span><span class="lineCov">         98 :      fTrackToFollow.ResetCovariance(10.); fTrackToFollow.ResetClusters();</span>
<span class="lineNum">     760 </span><span class="lineCov">        196 :      if (RefitAt(AliITSRecoParam::GetrInsideITSscreen(),&amp;fTrackToFollow,&amp;t)) {</span>
<span class="lineNum">     761 </span><span class="lineCov">        196 :        if (!CorrectForTPCtoITSDeadZoneMaterial(&amp;fTrackToFollow)) continue;</span>
<span class="lineNum">     762 </span>            :        //       fTrackToFollow.SetLabel(t.GetLabel());              // why do we neet this
<span class="lineNum">     763 </span>            :        //fTrackToFollow.CookdEdx();
<span class="lineNum">     764 </span><span class="lineCov">         98 :        CookLabel(&amp;fTrackToFollow,0.); //For comparison only // why do we need this?</span>
<span class="lineNum">     765 </span><span class="lineCov">         98 :        fTrackToFollow.UpdateESDtrack(AliESDtrack::kITSout);</span>
<span class="lineNum">     766 </span>            :        //UseClusters(&amp;fTrackToFollow);
<span class="lineNum">     767 </span><span class="lineCov">         98 :        ntrk++;</span>
<span class="lineNum">     768 </span><span class="lineCov">         98 :      }</span>
<span class="lineNum">     769 </span><span class="lineCov">        250 :   }</span>
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span><span class="lineCov">          8 :   AliInfo(Form(&quot;Number of back propagated ITS tracks: %d out of %d ESD tracks&quot;,ntrk,nentr));</span>
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span><span class="lineCov">          8 :   fTrackingPhase=&quot;Default&quot;;</span>
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span><span class="lineCov">          8 :   return 0;</span>
<a name="776"><span class="lineNum">     776 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     777 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     778 </span>            : Int_t AliITStrackerMI::RefitInward(AliESDEvent *event) {
<span class="lineNum">     779 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     780 </span>            :   // This functions refits ITS tracks using the 
<span class="lineNum">     781 </span>            :   // &quot;inward propagated&quot; TPC tracks
<span class="lineNum">     782 </span>            :   // The clusters must be loaded !
<span class="lineNum">     783 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     784 </span><span class="lineCov">         16 :   fTrackingPhase=&quot;RefitInward&quot;;</span>
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span><span class="lineCov">         16 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetFindV0s()) AliITSV0Finder::RefitV02(event,this);</span>
<span class="lineNum">     787 </span>            : 
<span class="lineNum">     788 </span><span class="lineCov">          8 :   Bool_t doExtra=AliITSReconstructor::GetRecoParam()-&gt;GetSearchForExtraClusters();</span>
<span class="lineNum">     789 </span><span class="lineCov">          8 :   if(!doExtra) AliDebug(2,&quot;Do not search for extra clusters&quot;);</span>
<span class="lineNum">     790 </span>            : 
<span class="lineNum">     791 </span><span class="lineCov">          8 :   Int_t nentr=event-&gt;GetNumberOfTracks();</span>
<span class="lineNum">     792 </span>            :   //  Info(&quot;RefitInward&quot;, &quot;Number of ESD tracks: %d\n&quot;, nentr);
<span class="lineNum">     793 </span>            : 
<span class="lineNum">     794 </span>            :   // only for PlaneEff and in case of SPD (for FO studies)
<span class="lineNum">     795 </span><span class="lineCov">          8 :   if( AliITSReconstructor::GetRecoParam()-&gt;GetComputePlaneEff() &amp;&amp;</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :       AliITSReconstructor::GetRecoParam()-&gt;GetIPlanePlaneEff()&gt;=0 &amp;&amp; </span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :       AliITSReconstructor::GetRecoParam()-&gt;GetIPlanePlaneEff()&lt;2) {</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :       for (UInt_t i=0; i&lt;AliITSPlaneEffSPD::kNModule*AliITSPlaneEffSPD::kNChip; i++) fSPDChipIntPlaneEff[i]=kFALSE;     </span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     800 </span>            : 
<span class="lineNum">     801 </span><span class="lineCov">          8 :   Bool_t checkInv = AliITSReconstructor::GetCheckInvariant(); // off in the special reco mode w/o invariant check</span>
<span class="lineNum">     802 </span>            : 
<span class="lineNum">     803 </span>            :   Int_t ntrk=0;
<span class="lineNum">     804 </span><span class="lineCov">        320 :   for (Int_t i=0; i&lt;nentr; i++) {</span>
<span class="lineNum">     805 </span><span class="lineCov">        152 :     AliESDtrack *esd=event-&gt;GetTrack(i);</span>
<span class="lineNum">     806 </span>            : 
<span class="lineNum">     807 </span><span class="lineCov">        206 :     if ((esd-&gt;GetStatus()&amp;AliESDtrack::kITSout) == 0) continue;</span>
<span class="lineNum">     808 </span><span class="lineCov">         98 :     if (esd-&gt;GetStatus()&amp;AliESDtrack::kITSrefit) continue;</span>
<span class="lineNum">     809 </span><span class="lineCov">         98 :     if (esd-&gt;GetStatus()&amp;AliESDtrack::kTPCout)</span>
<span class="lineNum">     810 </span><span class="lineCov">         82 :       if ((esd-&gt;GetStatus()&amp;AliESDtrack::kTPCrefit)==0) continue;</span>
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span><span class="lineCov">         98 :     AliITStrackMI *t = new AliITStrackMI(*esd);</span>
<span class="lineNum">     813 </span><span class="lineCov">         98 :     t-&gt;SetCheckInvariant(checkInv);</span>
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span><span class="lineCov">         98 :     t-&gt;SetExpQ(TMath::Max(0.8*t-&gt;GetESDtrack()-&gt;GetTPCsignal(),30.));</span>
<span class="lineNum">     816 </span><span class="lineCov">         98 :     if (!CorrectForTPCtoITSDeadZoneMaterial(t)) {</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :        delete t;</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :        continue;</span>
<span class="lineNum">     819 </span>            :     }
<span class="lineNum">     820 </span>            : 
<span class="lineNum">     821 </span><span class="lineCov">         98 :     ResetTrackToFollow(*t);</span>
<span class="lineNum">     822 </span><span class="lineCov">         98 :     fTrackToFollow.ResetClusters();</span>
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span>            :     // ITS standalone tracks
<span class="lineNum">     825 </span><span class="lineCov">         98 :     if ((esd-&gt;GetStatus()&amp;AliESDtrack::kTPCin)==0) {</span>
<span class="lineNum">     826 </span><span class="lineCov">         16 :       fTrackToFollow.ResetCovariance(10.);</span>
<span class="lineNum">     827 </span>            :       // protection for loopers that can have parameters screwed up
<span class="lineNum">     828 </span><span class="lineCov">         32 :       if(TMath::Abs(fTrackToFollow.GetY())&gt;1000. ||</span>
<span class="lineNum">     829 </span><span class="lineCov">         16 :          TMath::Abs(fTrackToFollow.GetZ())&gt;1000.) {</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :         delete t;</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     832 </span>            :       }
<span class="lineNum">     833 </span>            :     }
<span class="lineNum">     834 </span>            : 
<span class="lineNum">     835 </span>            :     //Refitting...
<span class="lineNum">     836 </span><span class="lineCov">        196 :     Bool_t pe=(AliITSReconstructor::GetRecoParam()-&gt;GetComputePlaneEff() &amp;&amp;</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :                AliITSReconstructor::GetRecoParam()-&gt;GetIPlanePlaneEff()&gt;=0);</span>
<span class="lineNum">     838 </span>            : 
<span class="lineNum">     839 </span><span class="lineCov">        294 :     AliDebug(2,Form(&quot;Refit LABEL %d  %d&quot;,t-&gt;GetLabel(),t-&gt;GetNumberOfClusters()));</span>
<span class="lineNum">     840 </span><span class="lineCov">         98 :     if (RefitAt(AliITSRecoParam::GetrInsideSPD1(),&amp;fTrackToFollow,t,doExtra,pe)) {</span>
<span class="lineNum">     841 </span><span class="lineCov">        288 :        AliDebug(2,&quot;  refit OK&quot;);</span>
<span class="lineNum">     842 </span><span class="lineCov">         96 :        fTrackToFollow.SetLabel(t-&gt;GetLabel());</span>
<span class="lineNum">     843 </span>            :        //       fTrackToFollow.CookdEdx();
<span class="lineNum">     844 </span><span class="lineCov">         96 :        CookdEdx(&amp;fTrackToFollow);</span>
<span class="lineNum">     845 </span>            : 
<span class="lineNum">     846 </span><span class="lineCov">         96 :        CookLabel(&amp;fTrackToFollow,0.0); //For comparison only // RS why do we need this?</span>
<span class="lineNum">     847 </span>            : 
<span class="lineNum">     848 </span>            :        //The beam pipe
<span class="lineNum">     849 </span><span class="lineCov">        192 :        if (CorrectForPipeMaterial(&amp;fTrackToFollow,&quot;inward&quot;)) {</span>
<span class="lineNum">     850 </span><span class="lineCov">         92 :          fTrackToFollow.UpdateESDtrack(AliESDtrack::kITSrefit);</span>
<span class="lineNum">     851 </span><span class="lineCov">         92 :          AliESDtrack  *esdTrack =fTrackToFollow.GetESDtrack();</span>
<span class="lineNum">     852 </span>            :          //printf(&quot;                                       %d\n&quot;,esdTrack-&gt;GetITSModuleIndex(0));
<span class="lineNum">     853 </span>            :          //esdTrack-&gt;UpdateTrackParams(&amp;fTrackToFollow,AliESDtrack::kITSrefit); //original line
<span class="lineNum">     854 </span><span class="lineCov">         92 :          Double_t r[3]={0.,0.,0.};</span>
<span class="lineNum">     855 </span>            :          Double_t maxD=3.;
<span class="lineNum">     856 </span><span class="lineCov">         92 :          esdTrack-&gt;RelateToVertex(event-&gt;GetVertex(),GetBz(r),maxD);</span>
<span class="lineNum">     857 </span><span class="lineCov">         92 :          ntrk++;</span>
<span class="lineNum">     858 </span><span class="lineCov">         92 :        }</span>
<span class="lineNum">     859 </span>            :     }
<span class="lineNum">     860 </span><span class="lineCov">        196 :     delete t;</span>
<span class="lineNum">     861 </span><span class="lineCov">         98 :   }</span>
<span class="lineNum">     862 </span>            : 
<span class="lineNum">     863 </span><span class="lineCov">          8 :   AliInfo(Form(&quot;Number of refitted tracks: %d out of %d ESD tracks&quot;,ntrk,nentr));</span>
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span><span class="lineCov">          8 :   fTrackingPhase=&quot;Default&quot;;</span>
<span class="lineNum">     866 </span>            : 
<span class="lineNum">     867 </span><span class="lineCov">          8 :   return 0;</span>
<a name="868"><span class="lineNum">     868 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     869 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     870 </span>            : AliCluster *AliITStrackerMI::GetCluster(Int_t index) const {
<span class="lineNum">     871 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     872 </span>            :   //       Return pointer to a given cluster
<span class="lineNum">     873 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     874 </span><span class="lineCov">     106276 :   Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">     875 </span><span class="lineCov">      53138 :   Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">     876 </span><span class="lineCov">      53138 :   return fgLayers[l].GetCluster(c);</span>
<a name="877"><span class="lineNum">     877 </span>            : }</a>
<span class="lineNum">     878 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     879 </span>            : Bool_t AliITStrackerMI::GetTrackPoint(Int_t index, AliTrackPoint&amp; p) const {
<span class="lineNum">     880 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     881 </span>            :   // Get track space point with index i
<span class="lineNum">     882 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineCov">        534 :   Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">     885 </span><span class="lineCov">        267 :   Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">     886 </span><span class="lineCov">        267 :   AliITSRecPoint *cl = fgLayers[l].GetCluster(c);</span>
<span class="lineNum">     887 </span><span class="lineCov">        267 :   Int_t idet = cl-&gt;GetDetectorIndex();</span>
<span class="lineNum">     888 </span>            : 
<span class="lineNum">     889 </span><span class="lineCov">        267 :   Float_t xyz[3]={0};</span>
<span class="lineNum">     890 </span><span class="lineCov">        267 :   Float_t cov[6]={0};</span>
<span class="lineNum">     891 </span><span class="lineCov">        267 :   cl-&gt;GetGlobalXYZ(xyz);</span>
<span class="lineNum">     892 </span><span class="lineCov">        267 :   cl-&gt;GetGlobalCov(cov);</span>
<span class="lineNum">     893 </span><span class="lineCov">        267 :   p.SetXYZ(xyz, cov);</span>
<span class="lineNum">     894 </span><span class="lineCov">        267 :   p.SetCharge(cl-&gt;GetQ());</span>
<span class="lineNum">     895 </span><span class="lineCov">        267 :   p.SetDriftTime(cl-&gt;GetDriftTime());</span>
<span class="lineNum">     896 </span><span class="lineCov">        267 :   p.SetChargeRatio(cl-&gt;GetChargeRatio());</span>
<span class="lineNum">     897 </span><span class="lineCov">        267 :   p.SetClusterType(cl-&gt;GetClusterType());</span>
<span class="lineNum">     898 </span>            :   AliGeomManager::ELayerID iLayer = AliGeomManager::kInvalidLayer; 
<span class="lineNum">     899 </span><span class="lineCov">        267 :   switch (l) {</span>
<span class="lineNum">     900 </span>            :   case 0:
<span class="lineNum">     901 </span>            :     iLayer = AliGeomManager::kSPD1;
<span class="lineNum">     902 </span><span class="lineCov">         38 :     break;</span>
<span class="lineNum">     903 </span>            :   case 1:
<span class="lineNum">     904 </span>            :     iLayer = AliGeomManager::kSPD2;
<span class="lineNum">     905 </span><span class="lineCov">         29 :     break;</span>
<span class="lineNum">     906 </span>            :   case 2:
<span class="lineNum">     907 </span>            :     iLayer = AliGeomManager::kSDD1;
<span class="lineNum">     908 </span><span class="lineCov">         47 :     break;</span>
<span class="lineNum">     909 </span>            :   case 3:
<span class="lineNum">     910 </span>            :     iLayer = AliGeomManager::kSDD2;
<span class="lineNum">     911 </span><span class="lineCov">         52 :     break;</span>
<span class="lineNum">     912 </span>            :   case 4:
<span class="lineNum">     913 </span>            :     iLayer = AliGeomManager::kSSD1;
<span class="lineNum">     914 </span><span class="lineCov">         51 :     break;</span>
<span class="lineNum">     915 </span>            :   case 5:
<span class="lineNum">     916 </span>            :     iLayer = AliGeomManager::kSSD2;
<span class="lineNum">     917 </span><span class="lineCov">         50 :     break;</span>
<span class="lineNum">     918 </span>            :   default:
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Wrong layer index in ITS (%d) !&quot;,l));</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     921 </span>            :   };
<span class="lineNum">     922 </span><span class="lineCov">        267 :   UShort_t volid = AliGeomManager::LayerToVolUID(iLayer,idet);</span>
<span class="lineNum">     923 </span><span class="lineCov">        267 :   p.SetVolumeID((UShort_t)volid);</span>
<span class="lineNum">     924 </span><span class="lineCov">        267 :   return kTRUE;</span>
<a name="925"><span class="lineNum">     925 </span><span class="lineCov">        267 : }</span></a>
<span class="lineNum">     926 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     927 </span>            : Bool_t AliITStrackerMI::GetTrackPointTrackingError(Int_t index, 
<span class="lineNum">     928 </span>            :                         AliTrackPoint&amp; p, const AliESDtrack *t) {
<span class="lineNum">     929 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     930 </span>            :   // Get track space point with index i
<span class="lineNum">     931 </span>            :   // (assign error estimated during the tracking)
<span class="lineNum">     932 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     933 </span>            : 
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :   Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :   Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :   const AliITSRecPoint *cl = fgLayers[l].GetCluster(c);</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :   Int_t idet = cl-&gt;GetDetectorIndex();</span>
<span class="lineNum">     938 </span>            : 
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :   const AliITSdetector &amp;det=fgLayers[l].GetDetector(idet);</span>
<span class="lineNum">     940 </span>            : 
<span class="lineNum">     941 </span>            :   // tgphi and tglambda of the track in tracking frame with alpha=det.GetPhi
<span class="lineNum">     942 </span>            :   Float_t detxy[2]={0};
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :   detxy[0] = det.GetR()*TMath::Cos(det.GetPhi());</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :   detxy[1] = det.GetR()*TMath::Sin(det.GetPhi());</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :   Double_t alpha = t-&gt;GetAlpha();</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :   Double_t xdetintrackframe = detxy[0]*TMath::Cos(alpha)+detxy[1]*TMath::Sin(alpha);</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :   Float_t phi = TMath::ASin(t-&gt;GetSnpAt(xdetintrackframe+cl-&gt;GetX(),GetBz()));</span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :   phi += alpha-det.GetPhi();</span>
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :   Float_t tgphi = TMath::Tan(phi);</span>
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :   Float_t tgl = t-&gt;GetTgl(); // tgl about const along track</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :   Float_t expQ = TMath::Max(0.8*t-&gt;GetTPCsignal(),30.);</span>
<span class="lineNum">     953 </span>            : 
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :   Float_t errtrky,errtrkz,covyz;</span>
<span class="lineNum">     955 </span>            :   Bool_t addMisalErr=kFALSE;
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :   AliITSClusterParam::GetError(l,cl,tgl,tgphi,expQ,errtrky,errtrkz,covyz,addMisalErr);</span>
<span class="lineNum">     957 </span>            : 
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :   Float_t xyz[3]={0};</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :   Float_t cov[6]={0};</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :   cl-&gt;GetGlobalXYZ(xyz);</span>
<span class="lineNum">     961 </span>            :   //  cl-&gt;GetGlobalCov(cov);
<span class="lineNum">     962 </span>            :   Float_t pos[3] = {0.,0.,0.};
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :   AliCluster tmpcl((UShort_t)cl-&gt;GetVolumeId(),pos[0],pos[1],pos[2],errtrky*errtrky,errtrkz*errtrkz,covyz);</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :   tmpcl.GetGlobalCov(cov);</span>
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :   p.SetXYZ(xyz, cov);</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :   p.SetCharge(cl-&gt;GetQ());</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :   p.SetDriftTime(cl-&gt;GetDriftTime());</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :   p.SetChargeRatio(cl-&gt;GetChargeRatio());</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :   p.SetClusterType(cl-&gt;GetClusterType());</span>
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span>            :   AliGeomManager::ELayerID iLayer = AliGeomManager::kInvalidLayer; 
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :   switch (l) {</span>
<span class="lineNum">     974 </span>            :   case 0:
<span class="lineNum">     975 </span>            :     iLayer = AliGeomManager::kSPD1;
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     977 </span>            :   case 1:
<span class="lineNum">     978 </span>            :     iLayer = AliGeomManager::kSPD2;
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     980 </span>            :   case 2:
<span class="lineNum">     981 </span>            :     iLayer = AliGeomManager::kSDD1;
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     983 </span>            :   case 3:
<span class="lineNum">     984 </span>            :     iLayer = AliGeomManager::kSDD2;
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     986 </span>            :   case 4:
<span class="lineNum">     987 </span>            :     iLayer = AliGeomManager::kSSD1;
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     989 </span>            :   case 5:
<span class="lineNum">     990 </span>            :     iLayer = AliGeomManager::kSSD2;
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     992 </span>            :   default:
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Wrong layer index in ITS (%d) !&quot;,l));</span>
<span class="lineNum">     994 </span>            :     break;
<span class="lineNum">     995 </span>            :   };
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :   UShort_t volid = AliGeomManager::LayerToVolUID(iLayer,idet);</span>
<span class="lineNum">     997 </span>            : 
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :   p.SetVolumeID((UShort_t)volid);</span>
<span class="lineNum">     999 </span>            :   return kTRUE;
<a name="1000"><span class="lineNum">    1000 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1001 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1002 </span>            : void AliITStrackerMI::FollowProlongationTree(AliITStrackMI * otrack, Int_t esdindex, Bool_t constrain) 
<span class="lineNum">    1003 </span>            : {
<span class="lineNum">    1004 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1005 </span>            :   // Follow prolongation tree
<span class="lineNum">    1006 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1007 </span>            :   //
<span class="lineNum">    1008 </span><span class="lineCov">        206 :   Double_t xyzVtx[]={GetX(),GetY(),GetZ()};</span>
<span class="lineNum">    1009 </span><span class="lineCov">        206 :   Double_t ersVtx[]={GetSigmaX(),GetSigmaY(),GetSigmaZ()};</span>
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span><span class="lineCov">        206 :   AliESDtrack * esd = otrack-&gt;GetESDtrack();</span>
<span class="lineNum">    1013 </span><span class="lineCov">        206 :   if (esd-&gt;GetV0Index(0)&gt;0) {</span>
<span class="lineNum">    1014 </span>            :     // TEMPORARY SOLLUTION: map V0 indexes to point to proper track
<span class="lineNum">    1015 </span>            :     //                      mapping of ESD track is different as ITS track in Containers
<span class="lineNum">    1016 </span>            :     //                      Need something more stable
<span class="lineNum">    1017 </span>            :     //                      Indexes are set back again to the ESD track indexes in UpdateTPCV0
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :     for (Int_t i=0;i&lt;3;i++){</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :       Int_t  index = esd-&gt;GetV0Index(i);</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :       if (index==0) break;</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :       AliESDv0 * vertex = fEsd-&gt;GetV0(index);</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :       if (vertex-&gt;GetStatus()&lt;0) continue;     // rejected V0</span>
<span class="lineNum">    1023 </span>            :       //
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :       if (esd-&gt;GetSign()&gt;0) {</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :         vertex-&gt;SetIndex(0,esdindex);</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :       } else {</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :         vertex-&gt;SetIndex(1,esdindex);</span>
<span class="lineNum">    1028 </span>            :       }
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1031 </span><span class="lineCov">        206 :   TObjArray *bestarray = (TObjArray*)fBestHypothesys.At(esdindex);</span>
<span class="lineNum">    1032 </span><span class="lineCov">        206 :   if (!bestarray){</span>
<span class="lineNum">    1033 </span><span class="lineCov">        110 :     bestarray = new TObjArray(5);</span>
<span class="lineNum">    1034 </span><span class="lineCov">        110 :     bestarray-&gt;SetOwner();</span>
<span class="lineNum">    1035 </span><span class="lineCov">        110 :     fBestHypothesys.AddAt(bestarray,esdindex);</span>
<span class="lineNum">    1036 </span><span class="lineCov">        110 :   }</span>
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span>            :   //
<span class="lineNum">    1039 </span>            :   //setup tree of the prolongations
<span class="lineNum">    1040 </span>            :   //
<span class="lineNum">    1041 </span>            :   const int kMaxTr = 100; //RS
<span class="lineNum">    1042 </span><span class="lineCov">       3010 :   static AliITStrackMI tracks[7][kMaxTr];</span>
<span class="lineNum">    1043 </span>            :   AliITStrackMI *currenttrack;
<span class="lineNum">    1044 </span><span class="lineCov">        212 :   static AliITStrackMI currenttrack1;</span>
<span class="lineNum">    1045 </span><span class="lineCov">        212 :   static AliITStrackMI currenttrack2;  </span>
<span class="lineNum">    1046 </span><span class="lineCov">        212 :   static AliITStrackMI backuptrack;</span>
<span class="lineNum">    1047 </span><span class="lineCov">        206 :   Int_t ntracks[7]={0};</span>
<span class="lineNum">    1048 </span><span class="lineCov">        206 :   Int_t nindexes[7][kMaxTr];</span>
<span class="lineNum">    1049 </span><span class="lineCov">        206 :   Float_t normalizedchi2[kMaxTr]={0};</span>
<span class="lineNum">    1050 </span><span class="lineCov">       2884 :   for (Int_t ilayer=0;ilayer&lt;6;ilayer++) ntracks[ilayer]=0;</span>
<span class="lineNum">    1051 </span><span class="lineCov">        206 :   otrack-&gt;SetNSkipped(0);</span>
<span class="lineNum">    1052 </span><span class="lineCov">        206 :   new (&amp;(tracks[6][0])) AliITStrackMI(*otrack);</span>
<span class="lineNum">    1053 </span><span class="lineCov">        206 :   ntracks[6]=1;</span>
<span class="lineNum">    1054 </span><span class="lineCov">       3296 :   for (Int_t i=0;i&lt;7;i++) nindexes[i][0]=0;</span>
<span class="lineNum">    1055 </span>            :   Int_t modstatus = 1; // found 
<span class="lineNum">    1056 </span><span class="lineCov">        206 :   Float_t xloc,zloc;</span>
<span class="lineNum">    1057 </span>            :   // 
<span class="lineNum">    1058 </span>            :   //
<span class="lineNum">    1059 </span>            :   // follow prolongations
<span class="lineNum">    1060 </span><span class="lineCov">       2884 :   for (Int_t ilayer=5; ilayer&gt;=0; ilayer--) {</span>
<span class="lineNum">    1061 </span><span class="lineCov">       3708 :     AliDebug(2,Form(&quot;FollowProlongationTree: layer %d&quot;,ilayer));</span>
<span class="lineNum">    1062 </span><span class="lineCov">       1236 :     fI = ilayer;</span>
<span class="lineNum">    1063 </span>            :     //
<span class="lineNum">    1064 </span><span class="lineCov">       1236 :     AliITSlayer &amp;layer=fgLayers[ilayer];</span>
<span class="lineNum">    1065 </span><span class="lineCov">       1236 :     Double_t r = layer.GetR(); </span>
<span class="lineNum">    1066 </span><span class="lineCov">       1236 :     ntracks[ilayer]=0;</span>
<span class="lineNum">    1067 </span>            :     //
<span class="lineNum">    1068 </span>            :     //
<span class="lineNum">    1069 </span>            :     Int_t nskipped=0;
<span class="lineNum">    1070 </span>            :     Float_t nused =0;
<span class="lineNum">    1071 </span><span class="lineCov">       9184 :     for (Int_t itrack =0; itrack&lt;ntracks[ilayer+1]; itrack++) {</span>
<span class="lineNum">    1072 </span>            :       //      printf(&quot;LR %d Tr:%d NSeeds: %d\n&quot;,ilayer,itrack,ntracks[ilayer+1]);
<span class="lineNum">    1073 </span>            :       //set current track
<span class="lineNum">    1074 </span><span class="lineCov">       2738 :       if (ntracks[ilayer]&gt;=kMaxTr) break;  </span>
<span class="lineNum">    1075 </span><span class="lineCov">       4068 :       if (tracks[ilayer+1][nindexes[ilayer+1][itrack]].GetNSkipped()&gt;0) nskipped++;</span>
<span class="lineNum">    1076 </span><span class="lineCov">       2738 :       if (tracks[ilayer+1][nindexes[ilayer+1][itrack]].GetNUsed()&gt;2.) nused++;</span>
<span class="lineNum">    1077 </span><span class="lineCov">       2738 :       if (ntracks[ilayer]&gt;15+ilayer){</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :         if (itrack&gt;1&amp;&amp;tracks[ilayer+1][nindexes[ilayer+1][itrack]].GetNSkipped()&gt;0 &amp;&amp; nskipped&gt;4+ilayer) continue;</span>
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :         if (itrack&gt;1&amp;&amp;tracks[ilayer+1][nindexes[ilayer+1][itrack]].GetNUsed()&gt;2. &amp;&amp; nused&gt;3) continue;</span>
<span class="lineNum">    1080 </span>            :       }
<span class="lineNum">    1081 </span>            : 
<span class="lineNum">    1082 </span><span class="lineCov">       2738 :       new(&amp;currenttrack1)  AliITStrackMI(tracks[ilayer+1][nindexes[ilayer+1][itrack]]);</span>
<span class="lineNum">    1083 </span>            :   
<span class="lineNum">    1084 </span>            :       // material between SSD and SDD, SDD and SPD
<span class="lineNum">    1085 </span><span class="lineCov">       2738 :       if (ilayer==3) </span>
<span class="lineNum">    1086 </span><span class="lineCov">       1314 :         if(!CorrectForShieldMaterial(&amp;currenttrack1,&quot;SDD&quot;,&quot;inward&quot;)) continue;</span>
<span class="lineNum">    1087 </span><span class="lineCov">       2738 :       if (ilayer==1) </span>
<span class="lineNum">    1088 </span><span class="lineCov">       1764 :         if(!CorrectForShieldMaterial(&amp;currenttrack1,&quot;SPD&quot;,&quot;inward&quot;)) continue;</span>
<span class="lineNum">    1089 </span>            : 
<span class="lineNum">    1090 </span>            :       // detector number
<span class="lineNum">    1091 </span><span class="lineCov">       2732 :       Double_t phi,z;</span>
<span class="lineNum">    1092 </span><span class="lineCov">       2734 :       if (!currenttrack1.GetPhiZat(r,phi,z)) continue;</span>
<span class="lineNum">    1093 </span><span class="lineCov">       2730 :       Int_t idet=layer.FindDetectorIndex(phi,z);</span>
<span class="lineNum">    1094 </span>            : 
<span class="lineNum">    1095 </span><span class="lineCov">       2730 :       Double_t trackGlobXYZ1[3]={0};</span>
<span class="lineNum">    1096 </span><span class="lineCov">       2730 :       if (!currenttrack1.GetXYZ(trackGlobXYZ1)) continue;</span>
<span class="lineNum">    1097 </span>            : 
<span class="lineNum">    1098 </span>            :       // Get the budget to the primary vertex for the current track being prolonged
<span class="lineNum">    1099 </span>            :       Double_t budgetToPrimVertex = 0;
<span class="lineNum">    1100 </span><span class="lineCov">       2730 :       double xMSLrs[9]={0},x2X0MSLrs[9]={0}; // needed for ImproveKalman</span>
<span class="lineNum">    1101 </span>            :       int nMSLrs = 0;
<span class="lineNum">    1102 </span>            :       //
<span class="lineNum">    1103 </span><span class="lineCov">       2730 :       if (fUseImproveKalman) nMSLrs = GetEffectiveThicknessLbyL(xMSLrs,x2X0MSLrs);</span>
<span class="lineNum">    1104 </span><span class="lineCov">       2730 :       else budgetToPrimVertex = GetEffectiveThickness();</span>
<span class="lineNum">    1105 </span>            :       //
<span class="lineNum">    1106 </span>            :       // check if we allow a prolongation without point
<span class="lineNum">    1107 </span><span class="lineCov">       2730 :       Int_t skip = CheckSkipLayer(&amp;currenttrack1,ilayer,idet);</span>
<span class="lineNum">    1108 </span><span class="lineCov">       2730 :       if (skip) {</span>
<span class="lineNum">    1109 </span><span class="lineCov">          4 :         AliITStrackMI* vtrack = new (&amp;tracks[ilayer][ntracks[ilayer]]) AliITStrackMI(currenttrack1);</span>
<span class="lineNum">    1110 </span>            :         // propagate to the layer radius
<span class="lineNum">    1111 </span><span class="lineCov">          4 :         Double_t xToGo; if (!vtrack-&gt;GetLocalXat(r,xToGo)) continue;</span>
<span class="lineNum">    1112 </span><span class="lineCov">          4 :         if(!vtrack-&gt;Propagate(xToGo)) continue;</span>
<span class="lineNum">    1113 </span>            :         // apply correction for material of the current layer
<span class="lineNum">    1114 </span><span class="lineCov">          8 :         CorrectForLayerMaterial(vtrack,ilayer,trackGlobXYZ1,&quot;inward&quot;);</span>
<span class="lineNum">    1115 </span><span class="lineCov">          4 :         vtrack-&gt;SetNDeadZone(vtrack-&gt;GetNDeadZone()+1);</span>
<span class="lineNum">    1116 </span><span class="lineCov">          4 :         vtrack-&gt;SetDeadZoneProbability(ilayer,1.); // no penalty for missing cluster</span>
<span class="lineNum">    1117 </span><span class="lineCov">          4 :         vtrack-&gt;SetClIndex(ilayer,-1);</span>
<span class="lineNum">    1118 </span><span class="lineCov">          4 :         modstatus = (skip==1 ? 3 : 4); // skipped : out in z</span>
<span class="lineNum">    1119 </span><span class="lineCov">          4 :         if(LocalModuleCoord(ilayer,idet,vtrack,xloc,zloc)) { // local module coords</span>
<span class="lineNum">    1120 </span><span class="lineCov">          4 :           vtrack-&gt;SetModuleIndexInfo(ilayer,idet,modstatus,xloc,zloc);</span>
<span class="lineNum">    1121 </span><span class="lineCov">          4 :         }</span>
<span class="lineNum">    1122 </span><span class="lineCov">          4 :         if(constrain &amp;&amp; AliITSReconstructor::GetRecoParam()-&gt;GetImproveWithVertex()) {</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :           fUseImproveKalman ? </span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :             vtrack-&gt;ImproveKalman(xyzVtx,ersVtx,xMSLrs,x2X0MSLrs,nMSLrs) : </span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :             vtrack-&gt;Improve(budgetToPrimVertex,xyzVtx,ersVtx);</span>
<span class="lineNum">    1126 </span>            :         }
<span class="lineNum">    1127 </span><span class="lineCov">          4 :         ntracks[ilayer]++;</span>
<span class="lineNum">    1128 </span><span class="lineCov">          4 :         continue;</span>
<span class="lineNum">    1129 </span><span class="lineCov">          4 :       }</span>
<span class="lineNum">    1130 </span>            : 
<span class="lineNum">    1131 </span>            :       // track outside layer acceptance in z
<span class="lineNum">    1132 </span><span class="lineCov">       2726 :       if (idet&lt;0) continue;</span>
<span class="lineNum">    1133 </span>            :       
<span class="lineNum">    1134 </span>            :       //propagate to the intersection with the detector plane
<span class="lineNum">    1135 </span><span class="lineCov">       2726 :       const AliITSdetector &amp;det=layer.GetDetector(idet);</span>
<span class="lineNum">    1136 </span><span class="lineCov">       2726 :       new(&amp;currenttrack2)  AliITStrackMI(currenttrack1);</span>
<span class="lineNum">    1137 </span><span class="lineCov">       2726 :       if (!currenttrack1.Propagate(det.GetPhi(),det.GetR())) continue;</span>
<span class="lineNum">    1138 </span><span class="lineCov">       2726 :       if (!currenttrack2.Propagate(det.GetPhi(),det.GetR())) continue;</span>
<span class="lineNum">    1139 </span><span class="lineCov">       2726 :       currenttrack1.SetDetectorIndex(idet);</span>
<span class="lineNum">    1140 </span><span class="lineCov">       2726 :       currenttrack2.SetDetectorIndex(idet);</span>
<span class="lineNum">    1141 </span><span class="lineCov">       2726 :       if(!LocalModuleCoord(ilayer,idet,&amp;currenttrack1,xloc,zloc)) continue; // local module coords</span>
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span>            :       //***************
<span class="lineNum">    1144 </span>            :       // DEFINITION OF SEARCH ROAD AND CLUSTERS SELECTION
<span class="lineNum">    1145 </span>            :       //
<span class="lineNum">    1146 </span>            :       // road in global (rphi,z) [i.e. in tracking ref. system]
<span class="lineNum">    1147 </span><span class="lineCov">       2726 :       Double_t zmin,zmax,ymin,ymax;</span>
<span class="lineNum">    1148 </span><span class="lineCov">       2726 :       if (!ComputeRoad(&amp;currenttrack1,ilayer,idet,zmin,zmax,ymin,ymax)) continue;</span>
<span class="lineNum">    1149 </span>            : 
<span class="lineNum">    1150 </span>            :       // select clusters in road
<span class="lineNum">    1151 </span><span class="lineCov">       2726 :       layer.SelectClusters(zmin,zmax,ymin,ymax); </span>
<span class="lineNum">    1152 </span>            :       //********************
<span class="lineNum">    1153 </span>            : 
<span class="lineNum">    1154 </span>            :       // Define criteria for track-cluster association
<span class="lineNum">    1155 </span><span class="lineCov">       5452 :       Double_t msz = currenttrack1.GetSigmaZ2() + </span>
<span class="lineNum">    1156 </span><span class="lineCov">       5452 :         AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    1157 </span><span class="lineCov">       5452 :         AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    1158 </span><span class="lineCov">       2726 :         AliITSReconstructor::GetRecoParam()-&gt;GetSigmaZ2(ilayer);</span>
<span class="lineNum">    1159 </span><span class="lineCov">       5452 :       Double_t msy = currenttrack1.GetSigmaY2() + </span>
<span class="lineNum">    1160 </span><span class="lineCov">       5452 :         AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    1161 </span><span class="lineCov">       5452 :         AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    1162 </span><span class="lineCov">       2726 :         AliITSReconstructor::GetRecoParam()-&gt;GetSigmaY2(ilayer);</span>
<span class="lineNum">    1163 </span><span class="lineCov">       5452 :       if (constrain) {</span>
<span class="lineNum">    1164 </span><span class="lineCov">       4726 :         msz *= AliITSReconstructor::GetRecoParam()-&gt;GetNSigma2RoadZC();</span>
<span class="lineNum">    1165 </span><span class="lineCov">       2000 :         msy *= AliITSReconstructor::GetRecoParam()-&gt;GetNSigma2RoadYC(); </span>
<span class="lineNum">    1166 </span><span class="lineCov">       2000 :       }  else {</span>
<span class="lineNum">    1167 </span><span class="lineCov">        726 :         msz *= AliITSReconstructor::GetRecoParam()-&gt;GetNSigma2RoadZNonC();</span>
<span class="lineNum">    1168 </span><span class="lineCov">        726 :         msy *= AliITSReconstructor::GetRecoParam()-&gt;GetNSigma2RoadYNonC(); </span>
<span class="lineNum">    1169 </span>            :       }
<span class="lineNum">    1170 </span><span class="lineCov">       2726 :       msz = 1./msz; // 1/RoadZ^2</span>
<span class="lineNum">    1171 </span><span class="lineCov">       2726 :       msy = 1./msy; // 1/RoadY^2</span>
<span class="lineNum">    1172 </span>            : 
<span class="lineNum">    1173 </span>            :       //
<span class="lineNum">    1174 </span>            :       //
<span class="lineNum">    1175 </span>            :       // LOOP OVER ALL POSSIBLE TRACK PROLONGATIONS ON THIS LAYER
<span class="lineNum">    1176 </span>            :       //
<span class="lineNum">    1177 </span>            :       const AliITSRecPoint *cl=0; 
<span class="lineNum">    1178 </span><span class="lineCov">       2726 :       Int_t clidx=-1;</span>
<span class="lineNum">    1179 </span><span class="lineCov">       2726 :       Double_t chi2trkcl=AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2(); // init with big value</span>
<span class="lineNum">    1180 </span>            :       Bool_t deadzoneSPD=kFALSE;
<span class="lineNum">    1181 </span>            :       currenttrack = &amp;currenttrack1;
<span class="lineNum">    1182 </span>            : 
<span class="lineNum">    1183 </span>            :       // check if the road contains a dead zone 
<span class="lineNum">    1184 </span>            :       Bool_t noClusters = kFALSE;
<span class="lineNum">    1185 </span><span class="lineCov">       2880 :       if (!layer.GetNextCluster(clidx,kTRUE)) noClusters=kTRUE;</span>
<span class="lineNum">    1186 </span><span class="lineCov">       3188 :       if (noClusters) AliDebug(2,&quot;no clusters in road&quot;);</span>
<span class="lineNum">    1187 </span><span class="lineCov">       2726 :       Double_t dz=0.5*(zmax-zmin);</span>
<span class="lineNum">    1188 </span><span class="lineCov">       2726 :       Double_t dy=0.5*(ymax-ymin);</span>
<span class="lineNum">    1189 </span><span class="lineCov">       2726 :       Int_t dead = CheckDeadZone(&amp;currenttrack1,ilayer,idet,dz,dy,noClusters); </span>
<span class="lineNum">    1190 </span><span class="lineCov">       3860 :       if(dead) AliDebug(2,Form(&quot;DEAD (%d)\n&quot;,dead));</span>
<span class="lineNum">    1191 </span>            :       // create a prolongation without clusters (check also if there are no clusters in the road)
<span class="lineNum">    1192 </span><span class="lineCov">       2784 :       if (dead || </span>
<span class="lineNum">    1193 </span><span class="lineCov">       2348 :           (noClusters &amp;&amp; </span>
<span class="lineNum">    1194 </span><span class="lineCov">         58 :            AliITSReconstructor::GetRecoParam()-&gt;GetAllowProlongationWithEmptyRoad())) {</span>
<span class="lineNum">    1195 </span><span class="lineCov">        436 :         AliITStrackMI * updatetrack = new (&amp;tracks[ilayer][ntracks[ilayer]]) AliITStrackMI(*currenttrack);</span>
<span class="lineNum">    1196 </span><span class="lineCov">        436 :         updatetrack-&gt;SetClIndex(ilayer,-1);</span>
<span class="lineNum">    1197 </span><span class="lineCov">        436 :         if (dead==0) {</span>
<span class="lineNum">    1198 </span>            :           modstatus = 5; // no cls in road
<span class="lineNum">    1199 </span><span class="lineCov">        436 :         } else if (dead==1) {</span>
<span class="lineNum">    1200 </span>            :           modstatus = 7; // holes in z in SPD
<span class="lineNum">    1201 </span><span class="lineCov">        378 :         } else if (dead==2 || dead==3 || dead==4) {</span>
<span class="lineNum">    1202 </span>            :           modstatus = 2; // dead from OCDB
<span class="lineNum">    1203 </span><span class="lineCov">         96 :         }</span>
<span class="lineNum">    1204 </span><span class="lineCov">        436 :         updatetrack-&gt;SetModuleIndexInfo(ilayer,idet,modstatus,xloc,zloc);</span>
<span class="lineNum">    1205 </span>            :         // apply correction for material of the current layer
<span class="lineNum">    1206 </span><span class="lineCov">        872 :         CorrectForLayerMaterial(updatetrack,ilayer,trackGlobXYZ1,&quot;inward&quot;);</span>
<span class="lineNum">    1207 </span><span class="lineCov">        436 :         if (constrain) { // apply vertex constrain</span>
<span class="lineNum">    1208 </span><span class="lineCov">        326 :           updatetrack-&gt;SetConstrain(constrain);</span>
<span class="lineNum">    1209 </span>            :           Bool_t isPrim = kTRUE;
<span class="lineNum">    1210 </span><span class="lineCov">        326 :           if (ilayer&lt;4) { // check that it's close to the vertex</span>
<span class="lineNum">    1211 </span><span class="lineCov">        306 :             updatetrack-&gt;GetDZ(GetX(),GetY(),GetZ(),updatetrack-&gt;GetDP()); //I.B.</span>
<span class="lineNum">    1212 </span><span class="lineCov">        914 :             if (TMath::Abs(updatetrack-&gt;GetD(0)/(1.+ilayer)) &gt; // y</span>
<span class="lineNum">    1213 </span><span class="lineCov">        612 :                 AliITSReconstructor::GetRecoParam()-&gt;GetMaxDZforPrimTrk() || </span>
<span class="lineNum">    1214 </span><span class="lineCov">        604 :                 TMath::Abs(updatetrack-&gt;GetD(1)/(1.+ilayer)) &gt; // z</span>
<span class="lineNum">    1215 </span><span class="lineCov">        306 :                 AliITSReconstructor::GetRecoParam()-&gt;GetMaxDZforPrimTrk()) isPrim=kFALSE;</span>
<span class="lineNum">    1216 </span>            :           }
<span class="lineNum">    1217 </span><span class="lineCov">        648 :           if (isPrim &amp;&amp; AliITSReconstructor::GetRecoParam()-&gt;GetImproveWithVertex()) {</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :             fUseImproveKalman ? </span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :               updatetrack-&gt;ImproveKalman(xyzVtx,ersVtx,xMSLrs,x2X0MSLrs,nMSLrs) : </span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :               updatetrack-&gt;Improve(budgetToPrimVertex,xyzVtx,ersVtx);</span>
<span class="lineNum">    1221 </span>            :           }
<span class="lineNum">    1222 </span><span class="lineCov">        326 :         }</span>
<span class="lineNum">    1223 </span><span class="lineCov">        436 :         updatetrack-&gt;SetNDeadZone(updatetrack-&gt;GetNDeadZone()+1);</span>
<span class="lineNum">    1224 </span><span class="lineCov">        436 :         if (dead) {</span>
<span class="lineNum">    1225 </span><span class="lineCov">        378 :           if (dead==1) { // dead zone at z=0,+-7cm in SPD</span>
<span class="lineNum">    1226 </span><span class="lineCov">        282 :             updatetrack-&gt;SetDeadZoneProbability(ilayer,GetSPDDeadZoneProbability(updatetrack-&gt;GetZ(),TMath::Sqrt(updatetrack-&gt;GetSigmaZ2())));</span>
<span class="lineNum">    1227 </span>            :             deadzoneSPD=kTRUE;
<span class="lineNum">    1228 </span><span class="lineCov">        378 :           } else if (dead==2 || dead==3) { // dead module or chip from OCDB  </span>
<span class="lineNum">    1229 </span><span class="lineCov">         64 :             updatetrack-&gt;SetDeadZoneProbability(ilayer,1.); </span>
<span class="lineNum">    1230 </span><span class="lineCov">         96 :           } else if (dead==4) { // at least a single dead channel from OCDB  </span>
<span class="lineNum">    1231 </span><span class="lineCov">         32 :             updatetrack-&gt;SetDeadZoneProbability(ilayer,0.); </span>
<span class="lineNum">    1232 </span><span class="lineCov">         32 :           } </span>
<span class="lineNum">    1233 </span>            :         }
<span class="lineNum">    1234 </span><span class="lineCov">        436 :         ntracks[ilayer]++;</span>
<span class="lineNum">    1235 </span><span class="lineCov">        436 :       }</span>
<span class="lineNum">    1236 </span>            : 
<span class="lineNum">    1237 </span><span class="lineCov">       2726 :       clidx=-1;</span>
<span class="lineNum">    1238 </span>            :       // loop over clusters in the road
<span class="lineNum">    1239 </span><span class="lineCov">       8654 :       while ((cl=layer.GetNextCluster(clidx))!=0) { </span>
<span class="lineNum">    1240 </span><span class="lineCov">       3202 :         if (ntracks[ilayer]&gt;int(0.95*kMaxTr)) break; //space for skipped clusters  </span>
<span class="lineNum">    1241 </span>            :         Bool_t changedet =kFALSE;  
<span class="lineNum">    1242 </span><span class="lineCov">       3202 :         if (TMath::Abs(cl-&gt;GetQ())&lt;1.e-13 &amp;&amp; deadzoneSPD==kTRUE) continue;</span>
<span class="lineNum">    1243 </span><span class="lineCov">       3202 :         Int_t idetc=cl-&gt;GetDetectorIndex();</span>
<span class="lineNum">    1244 </span>            : 
<span class="lineNum">    1245 </span><span class="lineCov">       3202 :         if (currenttrack-&gt;GetDetectorIndex()==idetc) { // track already on the cluster's detector</span>
<span class="lineNum">    1246 </span>            :           // take into account misalignment (bring track to real detector plane)
<span class="lineNum">    1247 </span><span class="lineCov">       2466 :           Double_t xTrOrig = currenttrack-&gt;GetX();</span>
<span class="lineNum">    1248 </span><span class="lineCov">       2466 :           if (!currenttrack-&gt;Propagate(xTrOrig+cl-&gt;GetX())) continue;</span>
<span class="lineNum">    1249 </span>            :           // a first cut on track-cluster distance
<span class="lineNum">    1250 </span><span class="lineCov">       7398 :           if ( (currenttrack-&gt;GetZ()-cl-&gt;GetZ())*(currenttrack-&gt;GetZ()-cl-&gt;GetZ())*msz + </span>
<span class="lineNum">    1251 </span><span class="lineCov">       4932 :                (currenttrack-&gt;GetY()-cl-&gt;GetY())*(currenttrack-&gt;GetY()-cl-&gt;GetY())*msy &gt; 1. ) </span>
<span class="lineNum">    1252 </span>            :             {  // cluster not associated to track
<span class="lineNum">    1253 </span><span class="lineCov">       1224 :               AliDebug(2,&quot;not associated&quot;);</span>
<span class="lineNum">    1254 </span>            :               // MvL: added here as well
<span class="lineNum">    1255 </span>            :               // bring track back to ideal detector plane
<span class="lineNum">    1256 </span><span class="lineCov">        408 :               currenttrack-&gt;Propagate(xTrOrig);</span>
<span class="lineNum">    1257 </span><span class="lineCov">        408 :               continue;</span>
<span class="lineNum">    1258 </span>            :             }
<span class="lineNum">    1259 </span>            :           // bring track back to ideal detector plane
<span class="lineNum">    1260 </span><span class="lineCov">       2058 :           if (!currenttrack-&gt;Propagate(xTrOrig)) continue;</span>
<span class="lineNum">    1261 </span><span class="lineCov">       2058 :         } else {                                      // have to move track to cluster's detector</span>
<span class="lineNum">    1262 </span><span class="lineCov">        736 :           const AliITSdetector &amp;detc=layer.GetDetector(idetc);</span>
<span class="lineNum">    1263 </span>            :           // a first cut on track-cluster distance
<span class="lineNum">    1264 </span><span class="lineCov">        736 :           Double_t y;</span>
<span class="lineNum">    1265 </span><span class="lineCov">        736 :           if (!currenttrack2.GetProlongationFast(detc.GetPhi(),detc.GetR()+cl-&gt;GetX(),y,z)) continue;</span>
<span class="lineNum">    1266 </span><span class="lineCov">       2208 :           if ( (z-cl-&gt;GetZ())*(z-cl-&gt;GetZ())*msz + </span>
<span class="lineNum">    1267 </span><span class="lineCov">       1472 :                (y-cl-&gt;GetY())*(y-cl-&gt;GetY())*msy &gt; 1. ) </span>
<span class="lineNum">    1268 </span><span class="lineCov">        316 :             continue; // cluster not associated to track</span>
<span class="lineNum">    1269 </span>            :           //
<span class="lineNum">    1270 </span><span class="lineCov">        420 :           new (&amp;backuptrack) AliITStrackMI(currenttrack2);</span>
<span class="lineNum">    1271 </span>            :           changedet = kTRUE;
<span class="lineNum">    1272 </span>            :           currenttrack =&amp;currenttrack2;
<span class="lineNum">    1273 </span><span class="lineCov">        420 :           if (!currenttrack-&gt;Propagate(detc.GetPhi(),detc.GetR())) {</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :             new (currenttrack) AliITStrackMI(backuptrack);</span>
<span class="lineNum">    1275 </span>            :             changedet = kFALSE;
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    1277 </span>            :           }
<span class="lineNum">    1278 </span><span class="lineCov">        420 :           currenttrack-&gt;SetDetectorIndex(idetc);</span>
<span class="lineNum">    1279 </span>            :           // Get again the budget to the primary vertex 
<span class="lineNum">    1280 </span>            :           // for the current track being prolonged, if had to change detector 
<span class="lineNum">    1281 </span>            :           //budgetToPrimVertex = GetEffectiveThickness();// not needed at the moment because anyway we take a mean material for this correction
<span class="lineNum">    1282 </span><span class="lineCov">       1156 :         }</span>
<span class="lineNum">    1283 </span>            : 
<span class="lineNum">    1284 </span>            :         // calculate track-clusters chi2
<span class="lineNum">    1285 </span><span class="lineCov">       2478 :         chi2trkcl = GetPredictedChi2MI(currenttrack,cl,ilayer); </span>
<span class="lineNum">    1286 </span>            :         // chi2 cut
<span class="lineNum">    1287 </span><span class="lineCov">       7434 :         AliDebug(2,Form(&quot;chi2 %f max %f&quot;,chi2trkcl,AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2s(ilayer)));</span>
<span class="lineNum">    1288 </span><span class="lineCov">       2478 :         if (chi2trkcl &lt; AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2s(ilayer)) {</span>
<span class="lineNum">    1289 </span><span class="lineCov">       2378 :           if (TMath::Abs(cl-&gt;GetQ())&lt;1.e-13) deadzoneSPD=kTRUE; // only 1 prolongation with virtual cluster         </span>
<span class="lineNum">    1290 </span><span class="lineCov">       2378 :           if (ntracks[ilayer]&gt;=kMaxTr) continue;</span>
<span class="lineNum">    1291 </span><span class="lineCov">       2378 :           AliITStrackMI * updatetrack = new (&amp;tracks[ilayer][ntracks[ilayer]]) AliITStrackMI(*currenttrack);</span>
<span class="lineNum">    1292 </span><span class="lineCov">       2378 :           updatetrack-&gt;SetClIndex(ilayer,-1);</span>
<span class="lineNum">    1293 </span><span class="lineCov">       2772 :           if (changedet) new (&amp;currenttrack2) AliITStrackMI(backuptrack);</span>
<span class="lineNum">    1294 </span>            : 
<span class="lineNum">    1295 </span><span class="lineCov">       2378 :           if (TMath::Abs(cl-&gt;GetQ())&gt;1.e-13) { // real cluster</span>
<span class="lineNum">    1296 </span><span class="lineCov">       2378 :             if (!UpdateMI(updatetrack,cl,chi2trkcl,(ilayer&lt;&lt;28)+clidx)) {</span>
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :               AliDebug(2,&quot;update failed&quot;);</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">    1299 </span>            :             } 
<span class="lineNum">    1300 </span><span class="lineCov">       2378 :             updatetrack-&gt;SetSampledEdx(cl-&gt;GetQ(),ilayer-2); </span>
<span class="lineNum">    1301 </span>            :             modstatus = 1; // found
<span class="lineNum">    1302 </span><span class="lineCov">       2378 :           } else {             // virtual cluster in dead zone</span>
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :             updatetrack-&gt;SetNDeadZone(updatetrack-&gt;GetNDeadZone()+1);</span>
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :             updatetrack-&gt;SetDeadZoneProbability(ilayer,GetSPDDeadZoneProbability(updatetrack-&gt;GetZ(),TMath::Sqrt(updatetrack-&gt;GetSigmaZ2())));</span>
<span class="lineNum">    1305 </span>            :             modstatus = 7; // holes in z in SPD
<span class="lineNum">    1306 </span>            :           }
<span class="lineNum">    1307 </span>            : 
<span class="lineNum">    1308 </span><span class="lineCov">       2378 :           if (changedet) {</span>
<span class="lineNum">    1309 </span><span class="lineCov">        394 :             Float_t xlocnewdet,zlocnewdet;</span>
<span class="lineNum">    1310 </span><span class="lineCov">        394 :             if(LocalModuleCoord(ilayer,idet,updatetrack,xlocnewdet,zlocnewdet)) { // local module coords</span>
<span class="lineNum">    1311 </span><span class="lineCov">        394 :               updatetrack-&gt;SetModuleIndexInfo(ilayer,idet,modstatus,xlocnewdet,zlocnewdet);</span>
<span class="lineNum">    1312 </span><span class="lineCov">        394 :             }</span>
<span class="lineNum">    1313 </span><span class="lineCov">        394 :           } else {</span>
<span class="lineNum">    1314 </span><span class="lineCov">       1984 :             updatetrack-&gt;SetModuleIndexInfo(ilayer,idet,modstatus,xloc,zloc);</span>
<span class="lineNum">    1315 </span>            :           }
<span class="lineNum">    1316 </span><span class="lineCov">       2378 :           if (cl-&gt;IsUsed()) updatetrack-&gt;IncrementNUsed();</span>
<span class="lineNum">    1317 </span>            : 
<span class="lineNum">    1318 </span>            :           // apply correction for material of the current layer
<span class="lineNum">    1319 </span><span class="lineCov">       4756 :           CorrectForLayerMaterial(updatetrack,ilayer,trackGlobXYZ1,&quot;inward&quot;);</span>
<span class="lineNum">    1320 </span>            : 
<span class="lineNum">    1321 </span><span class="lineCov">       2378 :           if (constrain) { // apply vertex constrain</span>
<span class="lineNum">    1322 </span><span class="lineCov">       1726 :             updatetrack-&gt;SetConstrain(constrain);</span>
<span class="lineNum">    1323 </span>            :             Bool_t isPrim = kTRUE;
<span class="lineNum">    1324 </span><span class="lineCov">       1726 :             if (ilayer&lt;4) { // check that it's close to the vertex</span>
<span class="lineNum">    1325 </span><span class="lineCov">       1370 :               updatetrack-&gt;GetDZ(GetX(),GetY(),GetZ(),updatetrack-&gt;GetDP()); //I.B.</span>
<span class="lineNum">    1326 </span><span class="lineCov">       4110 :               if (TMath::Abs(updatetrack-&gt;GetD(0)/(1.+ilayer)) &gt; // y</span>
<span class="lineNum">    1327 </span><span class="lineCov">       2740 :                   AliITSReconstructor::GetRecoParam()-&gt;GetMaxDZforPrimTrk() || </span>
<span class="lineNum">    1328 </span><span class="lineCov">       2740 :                   TMath::Abs(updatetrack-&gt;GetD(1)/(1.+ilayer)) &gt; // z</span>
<span class="lineNum">    1329 </span><span class="lineCov">       1370 :                   AliITSReconstructor::GetRecoParam()-&gt;GetMaxDZforPrimTrk()) isPrim=kFALSE;</span>
<span class="lineNum">    1330 </span>            :             }
<span class="lineNum">    1331 </span><span class="lineCov">       3452 :             if (isPrim &amp;&amp; AliITSReconstructor::GetRecoParam()-&gt;GetImproveWithVertex()) {</span>
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :               fUseImproveKalman ? </span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :                 updatetrack-&gt;ImproveKalman(xyzVtx,ersVtx,xMSLrs,x2X0MSLrs,nMSLrs) : </span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :                 updatetrack-&gt;Improve(budgetToPrimVertex,xyzVtx,ersVtx);</span>
<span class="lineNum">    1335 </span>            :             }
<span class="lineNum">    1336 </span><span class="lineCov">       1726 :           } //apply vertex constrain              </span>
<span class="lineNum">    1337 </span><span class="lineCov">       2378 :           ntracks[ilayer]++;</span>
<span class="lineNum">    1338 </span><span class="lineCov">       2378 :         }  // create new hypothesis</span>
<span class="lineNum">    1339 </span>            :         else {
<span class="lineNum">    1340 </span><span class="lineCov">        300 :           AliDebug(2,&quot;chi2 too large&quot;);</span>
<span class="lineNum">    1341 </span>            :         }
<span class="lineNum">    1342 </span>            : 
<span class="lineNum">    1343 </span><span class="lineCov">       2478 :       } // loop over possible prolongations </span>
<span class="lineNum">    1344 </span>            :      
<span class="lineNum">    1345 </span>            :       // allow one prolongation without clusters
<span class="lineNum">    1346 </span><span class="lineCov">       4814 :       if (constrain &amp;&amp; itrack&lt;=1 &amp;&amp; TMath::Abs(currenttrack1.GetNSkipped())&lt;1.e-13 &amp;&amp; deadzoneSPD==kFALSE &amp;&amp; ntracks[ilayer]&lt;kMaxTr) {</span>
<span class="lineNum">    1347 </span><span class="lineCov">        554 :         AliITStrackMI* vtrack = new (&amp;tracks[ilayer][ntracks[ilayer]]) AliITStrackMI(currenttrack1);</span>
<span class="lineNum">    1348 </span>            :         // apply correction for material of the current layer
<span class="lineNum">    1349 </span><span class="lineCov">       1108 :         CorrectForLayerMaterial(vtrack,ilayer,trackGlobXYZ1,&quot;inward&quot;);</span>
<span class="lineNum">    1350 </span><span class="lineCov">        554 :         vtrack-&gt;SetClIndex(ilayer,-1);</span>
<span class="lineNum">    1351 </span>            :         modstatus = 3; // skipped 
<span class="lineNum">    1352 </span><span class="lineCov">        554 :         vtrack-&gt;SetModuleIndexInfo(ilayer,idet,modstatus,xloc,zloc);</span>
<span class="lineNum">    1353 </span><span class="lineCov">        554 :         if(AliITSReconstructor::GetRecoParam()-&gt;GetImproveWithVertex()) {</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :           fUseImproveKalman ? </span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :             vtrack-&gt;ImproveKalman(xyzVtx,ersVtx,xMSLrs,x2X0MSLrs,nMSLrs) : </span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :             vtrack-&gt;Improve(budgetToPrimVertex,xyzVtx,ersVtx);</span>
<span class="lineNum">    1357 </span>            :         }
<span class="lineNum">    1358 </span><span class="lineCov">        554 :         vtrack-&gt;IncrementNSkipped();</span>
<span class="lineNum">    1359 </span><span class="lineCov">        554 :         ntracks[ilayer]++;</span>
<span class="lineNum">    1360 </span><span class="lineCov">        554 :       }</span>
<span class="lineNum">    1361 </span>            :       
<span class="lineNum">    1362 </span>            : 
<span class="lineNum">    1363 </span><span class="lineCov">      13644 :     } // loop over tracks in layer ilayer+1</span>
<span class="lineNum">    1364 </span>            : 
<span class="lineNum">    1365 </span>            :     //loop over track candidates for the current layer
<span class="lineNum">    1366 </span>            :     //
<span class="lineNum">    1367 </span>            :     //
<span class="lineNum">    1368 </span>            :     Int_t accepted=0;
<span class="lineNum">    1369 </span>            :     
<span class="lineNum">    1370 </span>            :     Int_t golden=0;
<span class="lineNum">    1371 </span><span class="lineCov">       9216 :     for (Int_t itrack=0;itrack&lt;ntracks[ilayer];itrack++){</span>
<span class="lineNum">    1372 </span><span class="lineCov">       3372 :       normalizedchi2[itrack] = NormalizedChi2(&amp;tracks[ilayer][itrack],ilayer); </span>
<span class="lineNum">    1373 </span><span class="lineCov">       6744 :       if (normalizedchi2[itrack] &lt; </span>
<span class="lineNum">    1374 </span><span class="lineCov">       5125 :           AliITSReconstructor::GetRecoParam()-&gt;GetMaxNormChi2ForGolden(ilayer)) golden++;</span>
<span class="lineNum">    1375 </span><span class="lineCov">       3372 :       if (ilayer&gt;4) {</span>
<span class="lineNum">    1376 </span><span class="lineCov">        378 :         accepted++;</span>
<span class="lineNum">    1377 </span><span class="lineCov">        378 :       } else {</span>
<span class="lineNum">    1378 </span><span class="lineCov">       5988 :         if (constrain) { // constrain</span>
<span class="lineNum">    1379 </span><span class="lineCov">       5374 :           if (normalizedchi2[itrack]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxNormChi2C(ilayer)+1) </span>
<span class="lineNum">    1380 </span><span class="lineCov">       2312 :             accepted++;</span>
<span class="lineNum">    1381 </span>            :         } else {        // !constrain
<span class="lineNum">    1382 </span><span class="lineCov">        614 :           if (normalizedchi2[itrack]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxNormChi2NonC(ilayer)+1) </span>
<span class="lineNum">    1383 </span><span class="lineCov">        580 :             accepted++;</span>
<span class="lineNum">    1384 </span>            :         }
<span class="lineNum">    1385 </span>            :       }
<span class="lineNum">    1386 </span>            :     }
<span class="lineNum">    1387 </span>            :     // sort tracks by increasing normalized chi2
<span class="lineNum">    1388 </span><span class="lineCov">       1236 :     TMath::Sort(ntracks[ilayer],normalizedchi2,nindexes[ilayer],kFALSE); </span>
<span class="lineNum">    1389 </span><span class="lineCov">       1236 :     ntracks[ilayer] = TMath::Min(accepted,7+2*ilayer);</span>
<span class="lineNum">    1390 </span><span class="lineCov">       2302 :     if (ntracks[ilayer]&lt;golden+2+ilayer) ntracks[ilayer]=TMath::Min(golden+2+ilayer,accepted);</span>
<span class="lineNum">    1391 </span>            :     //    if (ntracks[ilayer]&gt;90) ntracks[ilayer]=90; 
<span class="lineNum">    1392 </span><span class="lineCov">       1236 :     if (ntracks[ilayer]&gt;int(kMaxTr*0.9)) ntracks[ilayer]=int(kMaxTr*0.9); </span>
<span class="lineNum">    1393 </span>            :   } // end loop over layers
<span class="lineNum">    1394 </span>            : 
<span class="lineNum">    1395 </span>            : 
<span class="lineNum">    1396 </span>            :   //
<span class="lineNum">    1397 </span>            :   // Now select tracks to be kept
<span class="lineNum">    1398 </span>            :   //
<span class="lineNum">    1399 </span><span class="lineCov">        206 :   Int_t max = constrain ? 20 : 5;</span>
<span class="lineNum">    1400 </span>            : 
<span class="lineNum">    1401 </span>            :   // tracks that reach layer 0 (SPD inner)
<span class="lineNum">    1402 </span><span class="lineCov">       1648 :   for (Int_t i=0; i&lt;TMath::Min(max,ntracks[0]); i++) {</span>
<span class="lineNum">    1403 </span><span class="lineCov">        618 :     AliITStrackMI &amp; track= tracks[0][nindexes[0][i]];</span>
<span class="lineNum">    1404 </span><span class="lineCov">        624 :     if (track.GetNumberOfClusters()&lt;2) continue;</span>
<span class="lineNum">    1405 </span><span class="lineCov">        816 :     if (!constrain &amp;&amp; track.GetNormChi2(0) &gt;</span>
<span class="lineNum">    1406 </span><span class="lineCov">        102 :         AliITSReconstructor::GetRecoParam()-&gt;GetMaxNormChi2NonCForHypothesis()) {</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    1408 </span>            :     }
<span class="lineNum">    1409 </span><span class="lineCov">       1224 :     AddTrackHypothesys(new AliITStrackMI(track), esdindex);</span>
<span class="lineNum">    1410 </span><span class="lineCov">        612 :   }</span>
<span class="lineNum">    1411 </span>            : 
<span class="lineNum">    1412 </span>            :   // tracks that reach layer 1 (SPD outer)
<span class="lineNum">    1413 </span><span class="lineCov">        920 :   for (Int_t i=0;i&lt;TMath::Min(2,ntracks[1]);i++) {</span>
<span class="lineNum">    1414 </span><span class="lineCov">        254 :     AliITStrackMI &amp; track= tracks[1][nindexes[1][i]];</span>
<span class="lineNum">    1415 </span><span class="lineCov">        276 :     if (track.GetNumberOfClusters()&lt;4) continue;</span>
<span class="lineNum">    1416 </span><span class="lineCov">        424 :     if (!constrain &amp;&amp; track.GetNormChi2(1) &gt;</span>
<span class="lineNum">    1417 </span><span class="lineCov">         96 :         AliITSReconstructor::GetRecoParam()-&gt;GetMaxNormChi2NonCForHypothesis()) continue;</span>
<span class="lineNum">    1418 </span><span class="lineCov">        368 :     if (constrain) track.IncrementNSkipped();</span>
<span class="lineNum">    1419 </span><span class="lineCov">        232 :     if (!constrain) {</span>
<span class="lineNum">    1420 </span><span class="lineCov">         96 :       track.SetD(0,track.GetD(GetX(),GetY()));   </span>
<span class="lineNum">    1421 </span><span class="lineCov">         96 :       track.SetNSkipped(track.GetNSkipped()+4./(4.+8.*TMath::Abs(track.GetD(0))));</span>
<span class="lineNum">    1422 </span><span class="lineCov">         96 :       if (track.GetNumberOfClusters()+track.GetNDeadZone()+track.GetNSkipped()&gt;6) {</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :         track.SetNSkipped(6-track.GetNumberOfClusters()+track.GetNDeadZone());</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1425 </span>            :     }
<span class="lineNum">    1426 </span><span class="lineCov">        464 :     AddTrackHypothesys(new AliITStrackMI(track), esdindex);</span>
<span class="lineNum">    1427 </span><span class="lineCov">        232 :   }</span>
<span class="lineNum">    1428 </span>            : 
<span class="lineNum">    1429 </span>            :   // tracks that reach layer 2 (SDD inner), only during non-constrained pass
<span class="lineNum">    1430 </span><span class="lineCov">        206 :   if (!constrain){  </span>
<span class="lineNum">    1431 </span><span class="lineCov">        444 :     for (Int_t i=0;i&lt;TMath::Min(2,ntracks[2]);i++) {</span>
<span class="lineNum">    1432 </span><span class="lineCov">        112 :       AliITStrackMI &amp; track= tracks[2][nindexes[2][i]];</span>
<span class="lineNum">    1433 </span><span class="lineCov">        118 :       if (track.GetNumberOfClusters()&lt;3) continue;</span>
<span class="lineNum">    1434 </span><span class="lineCov">        212 :       if (track.GetNormChi2(2) &gt;</span>
<span class="lineNum">    1435 </span><span class="lineCov">        106 :           AliITSReconstructor::GetRecoParam()-&gt;GetMaxNormChi2NonCForHypothesis()) continue;</span>
<span class="lineNum">    1436 </span><span class="lineCov">        106 :       track.SetD(0,track.GetD(GetX(),GetY()));</span>
<span class="lineNum">    1437 </span><span class="lineCov">        106 :       track.SetNSkipped(track.GetNSkipped()+7./(7.+8.*TMath::Abs(track.GetD(0))));</span>
<span class="lineNum">    1438 </span><span class="lineCov">        106 :       if (track.GetNumberOfClusters()+track.GetNDeadZone()+track.GetNSkipped()&gt;6) {</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :         track.SetNSkipped(6-track.GetNumberOfClusters()+track.GetNDeadZone());</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1441 </span><span class="lineCov">        212 :       AddTrackHypothesys(new AliITStrackMI(track), esdindex);</span>
<span class="lineNum">    1442 </span><span class="lineCov">        106 :     }</span>
<span class="lineNum">    1443 </span><span class="lineCov">        110 :   }</span>
<span class="lineNum">    1444 </span>            :   
<span class="lineNum">    1445 </span><span class="lineCov">        206 :   if (!constrain) {</span>
<span class="lineNum">    1446 </span>            :     //
<span class="lineNum">    1447 </span>            :     // register best track of each layer - important for V0 finder
<span class="lineNum">    1448 </span>            :     //
<span class="lineNum">    1449 </span><span class="lineCov">       1320 :     for (Int_t ilayer=0;ilayer&lt;5;ilayer++){</span>
<span class="lineNum">    1450 </span><span class="lineCov">        550 :       if (ntracks[ilayer]==0) continue;</span>
<span class="lineNum">    1451 </span><span class="lineCov">        420 :       AliITStrackMI &amp; track= tracks[ilayer][nindexes[ilayer][0]];</span>
<span class="lineNum">    1452 </span><span class="lineCov">        426 :       if (track.GetNumberOfClusters()&lt;1) continue;</span>
<span class="lineNum">    1453 </span><span class="lineCov">        414 :       CookLabel(&amp;track,0);</span>
<span class="lineNum">    1454 </span><span class="lineCov">        828 :       bestarray-&gt;AddAt(new AliITStrackMI(track),ilayer);</span>
<span class="lineNum">    1455 </span><span class="lineCov">        414 :     }</span>
<span class="lineNum">    1456 </span><span class="lineCov">        110 :   }</span>
<span class="lineNum">    1457 </span>            :   //
<span class="lineNum">    1458 </span>            :   // update TPC V0 information
<span class="lineNum">    1459 </span>            :   //
<span class="lineNum">    1460 </span><span class="lineCov">        206 :   if (otrack-&gt;GetESDtrack()-&gt;GetV0Index(0)&gt;0){    </span>
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :     Float_t fprimvertex[3]={static_cast&lt;Float_t&gt;(GetX()),static_cast&lt;Float_t&gt;(GetY()),static_cast&lt;Float_t&gt;(GetZ())};</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :     for (Int_t i=0;i&lt;3;i++){</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :       Int_t  index = otrack-&gt;GetESDtrack()-&gt;GetV0Index(i); </span>
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :       if (index==0) break;</span>
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :       AliV0 *vertex = (AliV0*)fEsd-&gt;GetV0(index);</span>
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 :       if (vertex-&gt;GetStatus()&lt;0) continue;     // rejected V0</span>
<span class="lineNum">    1467 </span>            :       //
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :       if (otrack-&gt;GetSign()&gt;0) {</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :         vertex-&gt;SetIndex(0,esdindex);</span>
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1471 </span>            :       else{
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :         vertex-&gt;SetIndex(1,esdindex);</span>
<span class="lineNum">    1473 </span>            :       }
<span class="lineNum">    1474 </span>            :       //find nearest layer with track info
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :       Double_t xrp[3]={0}; vertex-&gt;GetXYZ(xrp[0],xrp[1],xrp[2]);  //I.B.</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :       Int_t nearestold  = GetNearestLayer(xrp);               //I.B.</span>
<span class="lineNum">    1477 </span>            :       Int_t nearest     = nearestold; 
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :       for (Int_t ilayer =nearest;ilayer&lt;7;ilayer++){</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :         if (ntracks[nearest]==0){</span>
<span class="lineNum">    1480 </span>            :           nearest = ilayer;
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1482 </span>            :       }
<span class="lineNum">    1483 </span>            :       //
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :       AliITStrackMI &amp; track= tracks[nearest][nindexes[nearest][0]];</span>
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :       if (nearestold&lt;5&amp;&amp;nearest&lt;5){</span>
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :         Bool_t accept = track.GetNormChi2(nearest)&lt;10; </span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :         if (accept){</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :           if (track.GetSign()&gt;0) {</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :             vertex-&gt;SetParamP(track);</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :             vertex-&gt;Update(fprimvertex);</span>
<span class="lineNum">    1491 </span>            :             //vertex-&gt;SetIndex(0,track.fESDtrack-&gt;GetID()); 
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :             if (track.GetNumberOfClusters()&gt;2) AddTrackHypothesys(new AliITStrackMI(track), esdindex);</span>
<span class="lineNum">    1493 </span>            :           }else{
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 :             vertex-&gt;SetParamN(track);</span>
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :             vertex-&gt;Update(fprimvertex);</span>
<span class="lineNum">    1496 </span>            :             //vertex-&gt;SetIndex(1,track.fESDtrack-&gt;GetID());
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :             if (track.GetNumberOfClusters()&gt;2) AddTrackHypothesys(new AliITStrackMI(track), esdindex);</span>
<span class="lineNum">    1498 </span>            :           }
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :           vertex-&gt;SetStatus(vertex-&gt;GetStatus()+1);</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :         }else{</span>
<span class="lineNum">    1501 </span>            :           //vertex-&gt;SetStatus(-2);  // reject V0  - not enough clusters
<span class="lineNum">    1502 </span>            :         }
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :     }</span>
<a name="1505"><span class="lineNum">    1505 </span><span class="lineNoCov">          0 :   } </span></a>
<span class="lineNum">    1506 </span>            :   
<a name="1507"><span class="lineNum">    1507 </span><span class="lineCov">       1612 : }</span></a>
<span class="lineNum">    1508 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1509 </span>            : AliITStrackerMI::AliITSlayer &amp; AliITStrackerMI::GetLayer(Int_t layer) const
<span class="lineNum">    1510 </span>            : {
<span class="lineNum">    1511 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1512 </span>            :   //
<span class="lineNum">    1513 </span>            :   //
<span class="lineNum">    1514 </span><span class="lineCov">        100 :   return fgLayers[layer];</span>
<a name="1515"><span class="lineNum">    1515 </span>            : }</a>
<span class="lineNum">    1516 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1517 </span>            : AliITStrackerMI::AliITSlayer::AliITSlayer():
<span class="lineNum">    1518 </span><span class="lineCov">        708 : fR(0),</span>
<span class="lineNum">    1519 </span><span class="lineCov">        354 : fPhiOffset(0),</span>
<span class="lineNum">    1520 </span><span class="lineCov">        354 : fNladders(0),</span>
<span class="lineNum">    1521 </span><span class="lineCov">        354 : fZOffset(0),</span>
<span class="lineNum">    1522 </span><span class="lineCov">        354 : fNdetectors(0),</span>
<span class="lineNum">    1523 </span><span class="lineCov">        354 : fDetectors(0),</span>
<span class="lineNum">    1524 </span><span class="lineCov">        354 : fN(0),</span>
<span class="lineNum">    1525 </span><span class="lineCov">        354 : fDy5(0),</span>
<span class="lineNum">    1526 </span><span class="lineCov">        354 : fDy10(0),</span>
<span class="lineNum">    1527 </span><span class="lineCov">        354 : fDy20(0),</span>
<span class="lineNum">    1528 </span><span class="lineCov">        354 : fClustersCs(0),</span>
<span class="lineNum">    1529 </span><span class="lineCov">        354 : fClusterIndexCs(0),</span>
<span class="lineNum">    1530 </span><span class="lineCov">        354 : fYcs(0),</span>
<span class="lineNum">    1531 </span><span class="lineCov">        354 : fZcs(0),</span>
<span class="lineNum">    1532 </span><span class="lineCov">        354 : fNcs(0),</span>
<span class="lineNum">    1533 </span><span class="lineCov">        354 : fCurrentSlice(-1),</span>
<span class="lineNum">    1534 </span><span class="lineCov">        354 : fZmin(0),</span>
<span class="lineNum">    1535 </span><span class="lineCov">        354 : fZmax(0),</span>
<span class="lineNum">    1536 </span><span class="lineCov">        354 : fYmin(0),</span>
<span class="lineNum">    1537 </span><span class="lineCov">        354 : fYmax(0),</span>
<span class="lineNum">    1538 </span><span class="lineCov">        354 : fI(0),</span>
<span class="lineNum">    1539 </span><span class="lineCov">        354 : fImax(0),</span>
<span class="lineNum">    1540 </span><span class="lineCov">        354 : fSkip(0),</span>
<span class="lineNum">    1541 </span><span class="lineCov">        354 : fAccepted(0),</span>
<span class="lineNum">    1542 </span><span class="lineCov">        354 : fRoad(0),</span>
<span class="lineNum">    1543 </span><span class="lineCov">        354 : fMaxSigmaClY(0),</span>
<span class="lineNum">    1544 </span><span class="lineCov">        354 : fMaxSigmaClZ(0),</span>
<span class="lineNum">    1545 </span><span class="lineCov">        354 : fNMaxSigmaCl(3)</span>
<span class="lineNum">    1546 </span><span class="lineCov">        708 : {</span>
<span class="lineNum">    1547 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1548 </span>            :   //default AliITSlayer constructor
<span class="lineNum">    1549 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1550 </span>            :   //
<span class="lineNum">    1551 </span>            :   // RS speedup reseting
<span class="lineNum">    1552 </span>            :   //  memset(fClusterWeight,0,sizeof(Float_t)*AliITSRecoParam::kMaxClusterPerLayer);
<span class="lineNum">    1553 </span><span class="lineCov">        354 :   memset(fClusterTracks,0,sizeof(UShort_t)*AliITSRecoParam::kMaxClusterPerLayer*4);</span>
<span class="lineNum">    1554 </span><span class="lineCov">        354 :   memset(fY,0,sizeof(Float_t)*AliITSRecoParam::kMaxClusterPerLayer);</span>
<span class="lineNum">    1555 </span><span class="lineCov">        354 :   memset(fZ,0,sizeof(Float_t)*AliITSRecoParam::kMaxClusterPerLayer);</span>
<span class="lineNum">    1556 </span>            :   /*
<span class="lineNum">    1557 </span>            :   for (Int_t i=0; i&lt;AliITSRecoParam::GetMaxClusterPerLayer(); i++) {
<span class="lineNum">    1558 </span>            :     fClusterWeight[i]=0;
<span class="lineNum">    1559 </span>            :     fClusterTracks[0][i]=-1;
<span class="lineNum">    1560 </span>            :     fClusterTracks[1][i]=-1;
<span class="lineNum">    1561 </span>            :     fClusterTracks[2][i]=-1;    
<span class="lineNum">    1562 </span>            :     fClusterTracks[3][i]=-1;
<span class="lineNum">    1563 </span>            :     fY[i]=0;    
<span class="lineNum">    1564 </span>            :     fZ[i]=0;    
<span class="lineNum">    1565 </span>            :   }
<span class="lineNum">    1566 </span>            :   */
<span class="lineNum">    1567 </span><span class="lineCov">        354 :   fYB[0]=0;</span>
<span class="lineNum">    1568 </span><span class="lineCov">        354 :   fYB[1]=0;</span>
<span class="lineNum">    1569 </span>            : 
<span class="lineNum">    1570 </span><span class="lineCov">    9063108 :   for (Int_t j=0; j&lt;AliITSRecoParam::kMaxClusterPerLayer5; j++) {</span>
<span class="lineNum">    1571 </span><span class="lineCov">   63436800 :     for (Int_t j1=0; j1&lt;6; j1++) {</span>
<span class="lineNum">    1572 </span><span class="lineCov">   27187200 :       fClusters5[j1][j]=0;</span>
<span class="lineNum">    1573 </span><span class="lineCov">   27187200 :       fClusterIndex5[j1][j]=0;//RS -1;</span>
<span class="lineNum">    1574 </span><span class="lineCov">   27187200 :       fY5[j1][j]=0;</span>
<span class="lineNum">    1575 </span><span class="lineCov">   27187200 :       fZ5[j1][j]=0;</span>
<span class="lineNum">    1576 </span><span class="lineCov">   27187200 :       fN5[j1]=0;</span>
<span class="lineNum">    1577 </span><span class="lineCov">   27187200 :       fBy5[j1][0]=0;</span>
<span class="lineNum">    1578 </span><span class="lineCov">   27187200 :       fBy5[j1][1]=0;</span>
<span class="lineNum">    1579 </span>            :     }
<span class="lineNum">    1580 </span>            :   }
<span class="lineNum">    1581 </span>            : 
<span class="lineNum">    1582 </span><span class="lineCov">    4531908 :   for (Int_t j=0; j&lt;AliITSRecoParam::kMaxClusterPerLayer10; j++) {</span>
<span class="lineNum">    1583 </span><span class="lineCov">   54374400 :     for (Int_t j1=0; j1&lt;11; j1++) {</span>
<span class="lineNum">    1584 </span><span class="lineCov">   24921600 :       fClusters10[j1][j]=0;</span>
<span class="lineNum">    1585 </span><span class="lineCov">   24921600 :       fClusterIndex10[j1][j]=0;//RS-1;</span>
<span class="lineNum">    1586 </span><span class="lineCov">   24921600 :       fY10[j1][j]=0;</span>
<span class="lineNum">    1587 </span><span class="lineCov">   24921600 :       fZ10[j1][j]=0;</span>
<span class="lineNum">    1588 </span><span class="lineCov">   24921600 :       fN10[j1]=0;</span>
<span class="lineNum">    1589 </span><span class="lineCov">   24921600 :       fBy10[j1][0]=0;</span>
<span class="lineNum">    1590 </span><span class="lineCov">   24921600 :       fBy10[j1][1]=0;</span>
<span class="lineNum">    1591 </span>            :     }
<span class="lineNum">    1592 </span>            :   }
<span class="lineNum">    1593 </span>            : 
<span class="lineNum">    1594 </span><span class="lineCov">    2266308 :   for (Int_t j=0; j&lt;AliITSRecoParam::kMaxClusterPerLayer20; j++) {</span>
<span class="lineNum">    1595 </span><span class="lineCov">   49843200 :     for (Int_t j1=0; j1&lt;21; j1++) {</span>
<span class="lineNum">    1596 </span><span class="lineCov">   23788800 :       fClusters20[j1][j]=0;</span>
<span class="lineNum">    1597 </span><span class="lineCov">   23788800 :       fClusterIndex20[j1][j]=0;//RS-1;</span>
<span class="lineNum">    1598 </span><span class="lineCov">   23788800 :       fY20[j1][j]=0;</span>
<span class="lineNum">    1599 </span><span class="lineCov">   23788800 :       fZ20[j1][j]=0;</span>
<span class="lineNum">    1600 </span><span class="lineCov">   23788800 :       fN20[j1]=0;</span>
<span class="lineNum">    1601 </span><span class="lineCov">   23788800 :       fBy20[j1][0]=0;</span>
<span class="lineNum">    1602 </span><span class="lineCov">   23788800 :       fBy20[j1][1]=0;</span>
<span class="lineNum">    1603 </span>            :     }
<span class="lineNum">    1604 </span>            :   }
<span class="lineNum">    1605 </span><span class="lineCov">   22656708 :   for(Int_t i=0;i&lt;AliITSRecoParam::kMaxClusterPerLayer;i++){</span>
<span class="lineNum">    1606 </span><span class="lineCov">   11328000 :     fClusters[i]=NULL;</span>
<span class="lineNum">    1607 </span><span class="lineCov">   11328000 :     fClusterIndex[i]=0;</span>
<span class="lineNum">    1608 </span>            :   }
<span class="lineNum">    1609 </span><span class="lineCov">        708 : }</span>
<a name="1610"><span class="lineNum">    1610 </span>            : //------------------------------------------------------------------------</a>
<span class="lineNum">    1611 </span>            : AliITStrackerMI::AliITSlayer::
<span class="lineNum">    1612 </span>            : AliITSlayer(Double_t r,Double_t p,Double_t z,Int_t nl,Int_t nd):
<span class="lineNum">    1613 </span><span class="lineCov">         24 : fR(r),</span>
<span class="lineNum">    1614 </span><span class="lineCov">         12 : fPhiOffset(p),</span>
<span class="lineNum">    1615 </span><span class="lineCov">         12 : fNladders(nl),</span>
<span class="lineNum">    1616 </span><span class="lineCov">         12 : fZOffset(z),</span>
<span class="lineNum">    1617 </span><span class="lineCov">         12 : fNdetectors(nd),</span>
<span class="lineNum">    1618 </span><span class="lineCov">         12 : fDetectors(0),</span>
<span class="lineNum">    1619 </span><span class="lineCov">         12 : fN(0),</span>
<span class="lineNum">    1620 </span><span class="lineCov">         12 : fDy5(0),</span>
<span class="lineNum">    1621 </span><span class="lineCov">         12 : fDy10(0),</span>
<span class="lineNum">    1622 </span><span class="lineCov">         12 : fDy20(0),</span>
<span class="lineNum">    1623 </span><span class="lineCov">         12 : fClustersCs(0),</span>
<span class="lineNum">    1624 </span><span class="lineCov">         12 : fClusterIndexCs(0),</span>
<span class="lineNum">    1625 </span><span class="lineCov">         12 : fYcs(0),</span>
<span class="lineNum">    1626 </span><span class="lineCov">         12 : fZcs(0),</span>
<span class="lineNum">    1627 </span><span class="lineCov">         12 : fNcs(0),</span>
<span class="lineNum">    1628 </span><span class="lineCov">         12 : fCurrentSlice(-1),</span>
<span class="lineNum">    1629 </span><span class="lineCov">         12 : fZmin(0),</span>
<span class="lineNum">    1630 </span><span class="lineCov">         12 : fZmax(0),</span>
<span class="lineNum">    1631 </span><span class="lineCov">         12 : fYmin(0),</span>
<span class="lineNum">    1632 </span><span class="lineCov">         12 : fYmax(0),</span>
<span class="lineNum">    1633 </span><span class="lineCov">         12 : fI(0),</span>
<span class="lineNum">    1634 </span><span class="lineCov">         12 : fImax(0),</span>
<span class="lineNum">    1635 </span><span class="lineCov">         12 : fSkip(0),</span>
<span class="lineNum">    1636 </span><span class="lineCov">         12 : fAccepted(0),</span>
<span class="lineNum">    1637 </span><span class="lineCov">         12 : fRoad(0),</span>
<span class="lineNum">    1638 </span><span class="lineCov">         12 : fMaxSigmaClY(0),</span>
<span class="lineNum">    1639 </span><span class="lineCov">         12 : fMaxSigmaClZ(0),</span>
<span class="lineNum">    1640 </span><span class="lineCov">         36 : fNMaxSigmaCl(3) {</span>
<span class="lineNum">    1641 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1642 </span>            :   //main AliITSlayer constructor
<span class="lineNum">    1643 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1644 </span><span class="lineCov">       8828 :   fDetectors=new AliITSdetector[fNladders*fNdetectors];</span>
<span class="lineNum">    1645 </span><span class="lineCov">         12 :   fRoad=2*fR*TMath::Sqrt(TMath::Pi()/1.);//assuming that there's only one cluster</span>
<span class="lineNum">    1646 </span>            :   //
<span class="lineNum">    1647 </span>            :   // RS speedup reseting
<span class="lineNum">    1648 </span>            :   //  memset(fClusterWeight,0,sizeof(Float_t)*AliITSRecoParam::kMaxClusterPerLayer);
<span class="lineNum">    1649 </span><span class="lineCov">         12 :   memset(fClusterTracks,0,sizeof(UShort_t)*AliITSRecoParam::kMaxClusterPerLayer*4);</span>
<span class="lineNum">    1650 </span><span class="lineCov">         12 :   memset(fY,0,sizeof(Float_t)*AliITSRecoParam::kMaxClusterPerLayer);</span>
<span class="lineNum">    1651 </span><span class="lineCov">         12 :   memset(fZ,0,sizeof(Float_t)*AliITSRecoParam::kMaxClusterPerLayer);</span>
<span class="lineNum">    1652 </span>            :   /*
<span class="lineNum">    1653 </span>            :   for (Int_t i=0; i&lt;AliITSRecoParam::GetMaxClusterPerLayer(); i++) {
<span class="lineNum">    1654 </span>            :     fClusterWeight[i]=0;
<span class="lineNum">    1655 </span>            :     fClusterTracks[0][i]=-1;
<span class="lineNum">    1656 </span>            :     fClusterTracks[1][i]=-1;
<span class="lineNum">    1657 </span>            :     fClusterTracks[2][i]=-1;    
<span class="lineNum">    1658 </span>            :     fClusterTracks[3][i]=-1;
<span class="lineNum">    1659 </span>            :     fY[i]=0;    
<span class="lineNum">    1660 </span>            :     fZ[i]=0;    
<span class="lineNum">    1661 </span>            :   }
<span class="lineNum">    1662 </span>            :   */
<span class="lineNum">    1663 </span><span class="lineCov">         12 :   fYB[0]=0;</span>
<span class="lineNum">    1664 </span><span class="lineCov">         12 :   fYB[1]=0;</span>
<span class="lineNum">    1665 </span>            : 
<span class="lineNum">    1666 </span><span class="lineCov">     307224 :  for (Int_t j=0; j&lt;AliITSRecoParam::kMaxClusterPerLayer5; j++) {</span>
<span class="lineNum">    1667 </span><span class="lineCov">    2150400 :     for (Int_t j1=0; j1&lt;6; j1++) {</span>
<span class="lineNum">    1668 </span><span class="lineCov">     921600 :       fClusters5[j1][j]=0;</span>
<span class="lineNum">    1669 </span><span class="lineCov">     921600 :       fClusterIndex5[j1][j]=0;//RS-1;</span>
<span class="lineNum">    1670 </span><span class="lineCov">     921600 :       fY5[j1][j]=0;</span>
<span class="lineNum">    1671 </span><span class="lineCov">     921600 :       fZ5[j1][j]=0;</span>
<span class="lineNum">    1672 </span><span class="lineCov">     921600 :       fN5[j1]=0;</span>
<span class="lineNum">    1673 </span><span class="lineCov">     921600 :       fBy5[j1][0]=0;</span>
<span class="lineNum">    1674 </span><span class="lineCov">     921600 :       fBy5[j1][1]=0;</span>
<span class="lineNum">    1675 </span>            :     }
<span class="lineNum">    1676 </span>            :   }
<span class="lineNum">    1677 </span>            : 
<span class="lineNum">    1678 </span><span class="lineCov">     153624 :   for (Int_t j=0; j&lt;AliITSRecoParam::kMaxClusterPerLayer10; j++) {</span>
<span class="lineNum">    1679 </span><span class="lineCov">    1843200 :     for (Int_t j1=0; j1&lt;11; j1++) {</span>
<span class="lineNum">    1680 </span><span class="lineCov">     844800 :       fClusters10[j1][j]=0;</span>
<span class="lineNum">    1681 </span><span class="lineCov">     844800 :       fClusterIndex10[j1][j]=0;//RS-1;</span>
<span class="lineNum">    1682 </span><span class="lineCov">     844800 :       fY10[j1][j]=0;</span>
<span class="lineNum">    1683 </span><span class="lineCov">     844800 :       fZ10[j1][j]=0;</span>
<span class="lineNum">    1684 </span><span class="lineCov">     844800 :       fN10[j1]=0;</span>
<span class="lineNum">    1685 </span><span class="lineCov">     844800 :       fBy10[j1][0]=0;</span>
<span class="lineNum">    1686 </span><span class="lineCov">     844800 :       fBy10[j1][1]=0;</span>
<span class="lineNum">    1687 </span>            :     }
<span class="lineNum">    1688 </span>            :   }
<span class="lineNum">    1689 </span>            : 
<span class="lineNum">    1690 </span><span class="lineCov">      76824 :   for (Int_t j=0; j&lt;AliITSRecoParam::kMaxClusterPerLayer20; j++) {</span>
<span class="lineNum">    1691 </span><span class="lineCov">    1689600 :     for (Int_t j1=0; j1&lt;21; j1++) {</span>
<span class="lineNum">    1692 </span><span class="lineCov">     806400 :       fClusters20[j1][j]=0;</span>
<span class="lineNum">    1693 </span><span class="lineCov">     806400 :       fClusterIndex20[j1][j]=0;//RS-1;</span>
<span class="lineNum">    1694 </span><span class="lineCov">     806400 :       fY20[j1][j]=0;</span>
<span class="lineNum">    1695 </span><span class="lineCov">     806400 :       fZ20[j1][j]=0;</span>
<span class="lineNum">    1696 </span><span class="lineCov">     806400 :       fN20[j1]=0;</span>
<span class="lineNum">    1697 </span><span class="lineCov">     806400 :       fBy20[j1][0]=0;</span>
<span class="lineNum">    1698 </span><span class="lineCov">     806400 :       fBy20[j1][1]=0;</span>
<span class="lineNum">    1699 </span>            :     }
<span class="lineNum">    1700 </span>            :   }
<span class="lineNum">    1701 </span><span class="lineCov">     768024 :   for(Int_t i=0;i&lt;AliITSRecoParam::kMaxClusterPerLayer;i++){</span>
<span class="lineNum">    1702 </span><span class="lineCov">     384000 :     fClusters[i]=NULL;</span>
<span class="lineNum">    1703 </span><span class="lineCov">     384000 :     fClusterIndex[i]=0;</span>
<span class="lineNum">    1704 </span>            :   }
<span class="lineNum">    1705 </span><span class="lineCov">         24 : }</span>
<span class="lineNum">    1706 </span>            : /*
<span class="lineNum">    1707 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1708 </span>            : AliITStrackerMI::AliITSlayer::AliITSlayer(const AliITSlayer&amp; layer):
<span class="lineNum">    1709 </span>            : fR(layer.fR),
<span class="lineNum">    1710 </span>            : fPhiOffset(layer.fPhiOffset),
<span class="lineNum">    1711 </span>            : fNladders(layer.fNladders),
<span class="lineNum">    1712 </span>            : fZOffset(layer.fZOffset),
<span class="lineNum">    1713 </span>            : fNdetectors(layer.fNdetectors),
<span class="lineNum">    1714 </span>            : fDetectors(layer.fDetectors),
<span class="lineNum">    1715 </span>            : fN(layer.fN),
<span class="lineNum">    1716 </span>            : fDy5(layer.fDy5),
<span class="lineNum">    1717 </span>            : fDy10(layer.fDy10),
<span class="lineNum">    1718 </span>            : fDy20(layer.fDy20),
<span class="lineNum">    1719 </span>            : fClustersCs(layer.fClustersCs),
<span class="lineNum">    1720 </span>            : fClusterIndexCs(layer.fClusterIndexCs),
<span class="lineNum">    1721 </span>            : fYcs(layer.fYcs),
<span class="lineNum">    1722 </span>            : fZcs(layer.fZcs),
<span class="lineNum">    1723 </span>            : fNcs(layer.fNcs),
<span class="lineNum">    1724 </span>            : fCurrentSlice(layer.fCurrentSlice),
<span class="lineNum">    1725 </span>            : fZmin(layer.fZmin),
<span class="lineNum">    1726 </span>            : fZmax(layer.fZmax),
<span class="lineNum">    1727 </span>            : fYmin(layer.fYmin),
<span class="lineNum">    1728 </span>            : fYmax(layer.fYmax),
<span class="lineNum">    1729 </span>            : fI(layer.fI),
<span class="lineNum">    1730 </span>            : fImax(layer.fImax),
<span class="lineNum">    1731 </span>            : fSkip(layer.fSkip),
<span class="lineNum">    1732 </span>            : fAccepted(layer.fAccepted),
<span class="lineNum">    1733 </span>            : fRoad(layer.fRoad),
<span class="lineNum">    1734 </span>            : fMaxSigmaClY(layer.fMaxSigmaClY),
<span class="lineNum">    1735 </span>            : fMaxSigmaClZ(layer.fMaxSigmaClZ),
<span class="lineNum">    1736 </span>            : fNMaxSigmaCl(layer.fNMaxSigmaCl)
<span class="lineNum">    1737 </span>            : {
<span class="lineNum">    1738 </span>            :   //Copy constructor
<span class="lineNum">    1739 </span>            : }
<a name="1740"><span class="lineNum">    1740 </span>            : */</a>
<span class="lineNum">    1741 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1742 </span><span class="lineCov">        708 : AliITStrackerMI::AliITSlayer::~AliITSlayer() {</span>
<span class="lineNum">    1743 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1744 </span>            :   // AliITSlayer destructor
<span class="lineNum">    1745 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1746 </span><span class="lineCov">       5128 :   delete [] fDetectors;</span>
<span class="lineNum">    1747 </span><span class="lineCov">        708 :   for (Int_t i=0; i&lt;fN; i++) delete fClusters[i];</span>
<span class="lineNum">    1748 </span>            :   /* RS: Why?
<span class="lineNum">    1749 </span>            :   for (Int_t i=0; i&lt;AliITSRecoParam::GetMaxClusterPerLayer(); i++) {
<span class="lineNum">    1750 </span>            :     fClusterWeight[i]=0;
<span class="lineNum">    1751 </span>            :     fClusterTracks[0][i]=-1;
<span class="lineNum">    1752 </span>            :     fClusterTracks[1][i]=-1;
<span class="lineNum">    1753 </span>            :     fClusterTracks[2][i]=-1;    
<span class="lineNum">    1754 </span>            :     fClusterTracks[3][i]=-1;    
<span class="lineNum">    1755 </span>            :   }
<span class="lineNum">    1756 </span>            :   */
<a name="1757"><span class="lineNum">    1757 </span><span class="lineCov">        708 : }</span></a>
<span class="lineNum">    1758 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1759 </span>            : void AliITStrackerMI::AliITSlayer::ResetClusters() {
<span class="lineNum">    1760 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1761 </span>            :   // This function removes loaded clusters
<span class="lineNum">    1762 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1763 </span><span class="lineCov">       2142 :   for (Int_t i=fN; i--;) delete fClusters[i];</span>
<span class="lineNum">    1764 </span>            :   // RS speedup reseting
<span class="lineNum">    1765 </span>            :   //  memset(fClusterWeight,0,sizeof(Float_t)*AliITSRecoParam::kMaxClusterPerLayer);
<span class="lineNum">    1766 </span><span class="lineCov">         48 :   memset(fClusterTracks,0,sizeof(UShort_t)*AliITSRecoParam::kMaxClusterPerLayer*4);</span>
<span class="lineNum">    1767 </span>            :   /*  
<span class="lineNum">    1768 </span>            :   for (Int_t i=0; i&lt;AliITSRecoParam::GetMaxClusterPerLayer(); i++){
<span class="lineNum">    1769 </span>            :     fClusterWeight[i]=0;
<span class="lineNum">    1770 </span>            :     fClusterTracks[0][i]=-1;
<span class="lineNum">    1771 </span>            :     fClusterTracks[1][i]=-1;
<span class="lineNum">    1772 </span>            :     fClusterTracks[2][i]=-1;    
<span class="lineNum">    1773 </span>            :     fClusterTracks[3][i]=-1;  
<span class="lineNum">    1774 </span>            :   }
<span class="lineNum">    1775 </span>            :   */  
<span class="lineNum">    1776 </span><span class="lineCov">         48 :   fN=0;</span>
<span class="lineNum">    1777 </span><span class="lineCov">         48 :   fI=0;</span>
<a name="1778"><span class="lineNum">    1778 </span><span class="lineCov">         48 : }</span></a>
<span class="lineNum">    1779 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1780 </span>            : void AliITStrackerMI::AliITSlayer::ResetWeights() {
<span class="lineNum">    1781 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1782 </span>            :   // This function reset weights of the clusters
<span class="lineNum">    1783 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1784 </span>            :   // RS speedup reseting
<span class="lineNum">    1785 </span>            :   //  memset(fClusterWeight,0,sizeof(Float_t)*AliITSRecoParam::kMaxClusterPerLayer);
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :   memset(fClusterTracks,0,sizeof(UShort_t)*AliITSRecoParam::kMaxClusterPerLayer*4);</span>
<span class="lineNum">    1787 </span>            :   /*
<span class="lineNum">    1788 </span>            :   for (Int_t i=0; i&lt;AliITSRecoParam::GetMaxClusterPerLayer(); i++) {
<span class="lineNum">    1789 </span>            :     fClusterWeight[i]=0;
<span class="lineNum">    1790 </span>            :     fClusterTracks[0][i]=-1;
<span class="lineNum">    1791 </span>            :     fClusterTracks[1][i]=-1;
<span class="lineNum">    1792 </span>            :     fClusterTracks[2][i]=-1;    
<span class="lineNum">    1793 </span>            :     fClusterTracks[3][i]=-1;  
<span class="lineNum">    1794 </span>            :   }
<span class="lineNum">    1795 </span>            :   */
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :   for (Int_t i=fN;i--;) {</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :     AliITSRecPoint * cl = (AliITSRecPoint*)GetCluster(i);</span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :     if (cl&amp;&amp;cl-&gt;IsUsed()) cl-&gt;Use();</span>
<span class="lineNum">    1799 </span>            :   }
<span class="lineNum">    1800 </span>            : 
<a name="1801"><span class="lineNum">    1801 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1802 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1803 </span>            : void AliITStrackerMI::AliITSlayer::ResetRoad() {
<span class="lineNum">    1804 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1805 </span>            :   // This function calculates the road defined by the cluster density
<span class="lineNum">    1806 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1807 </span>            :   Int_t n=0;
<span class="lineNum">    1808 </span><span class="lineCov">        810 :   for (Int_t i=fN; i--;) {</span>
<span class="lineNum">    1809 </span><span class="lineCov">       1312 :     if (TMath::Abs(fClusters[i]-&gt;GetZ())&lt;fR) n++;</span>
<span class="lineNum">    1810 </span>            :   }
<span class="lineNum">    1811 </span><span class="lineCov">         96 :   if (n&gt;1) fRoad=2*fR*TMath::Sqrt(TMath::Pi()/n);</span>
<a name="1812"><span class="lineNum">    1812 </span><span class="lineCov">         48 : }</span></a>
<span class="lineNum">    1813 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1814 </span>            : Int_t AliITStrackerMI::AliITSlayer::InsertCluster(AliITSRecPoint *cl) {
<span class="lineNum">    1815 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1816 </span>            :   //This function adds a cluster to this layer
<span class="lineNum">    1817 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1818 </span><span class="lineCov">       1332 :   if (fN==AliITSRecoParam::GetMaxClusterPerLayer()) {</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :     AliWarningGeneralF(&quot;AliITStrackerMI::AliITSlayer&quot;,&quot;Number of clusters for layer R=%.2f exceeds limit of %d&quot;,fR,fN);</span>
<span class="lineNum">    1820 </span><span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">    1821 </span>            :   }
<span class="lineNum">    1822 </span><span class="lineCov">        666 :   fCurrentSlice=-1;</span>
<span class="lineNum">    1823 </span><span class="lineCov">        666 :   fClusters[fN]=cl;</span>
<span class="lineNum">    1824 </span><span class="lineCov">        666 :   fN++;</span>
<span class="lineNum">    1825 </span><span class="lineCov">        666 :   AliITSdetector &amp;det=GetDetector(cl-&gt;GetDetectorIndex());    </span>
<span class="lineNum">    1826 </span>            :   //AD
<span class="lineNum">    1827 </span><span class="lineCov">        666 :   Double_t nSigmaY=fNMaxSigmaCl*TMath::Sqrt(cl-&gt;GetSigmaY2());</span>
<span class="lineNum">    1828 </span><span class="lineCov">        666 :   Double_t nSigmaZ=fNMaxSigmaCl*TMath::Sqrt(cl-&gt;GetSigmaZ2()); </span>
<span class="lineNum">    1829 </span><span class="lineCov">       1012 :   if (cl-&gt;GetY()-nSigmaY&lt;det.GetYmin()) det.SetYmin(cl-&gt;GetY()-nSigmaY);</span>
<span class="lineNum">    1830 </span><span class="lineCov">       1032 :   if (cl-&gt;GetY()+nSigmaY&gt;det.GetYmax()) det.SetYmax(cl-&gt;GetY()+nSigmaY);</span>
<span class="lineNum">    1831 </span><span class="lineCov">       1040 :   if (cl-&gt;GetZ()-nSigmaZ&lt;det.GetZmin()) det.SetZmin(cl-&gt;GetZ()-nSigmaZ);</span>
<span class="lineNum">    1832 </span><span class="lineCov">       1021 :   if (cl-&gt;GetZ()+nSigmaZ&gt;det.GetZmax()) det.SetZmax(cl-&gt;GetZ()+nSigmaZ);</span>
<span class="lineNum">    1833 </span>            :   //AD               
<span class="lineNum">    1834 </span>            :   /*
<span class="lineNum">    1835 </span>            :   if (cl-&gt;GetY()&lt;det.GetYmin()) det.SetYmin(cl-&gt;GetY());
<span class="lineNum">    1836 </span>            :   if (cl-&gt;GetY()&gt;det.GetYmax()) det.SetYmax(cl-&gt;GetY());
<span class="lineNum">    1837 </span>            :   if (cl-&gt;GetZ()&lt;det.GetZmin()) det.SetZmin(cl-&gt;GetZ());
<span class="lineNum">    1838 </span>            :   if (cl-&gt;GetZ()&gt;det.GetZmax()) det.SetZmax(cl-&gt;GetZ());
<span class="lineNum">    1839 </span>            :   */                 
<span class="lineNum">    1840 </span>            :   return 0;
<a name="1841"><span class="lineNum">    1841 </span><span class="lineCov">        666 : }</span></a>
<span class="lineNum">    1842 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1843 </span>            : void  AliITStrackerMI::AliITSlayer::SortClusters()
<span class="lineNum">    1844 </span>            : {
<span class="lineNum">    1845 </span>            :   //
<span class="lineNum">    1846 </span>            :   //sort clusters
<span class="lineNum">    1847 </span>            :   //
<span class="lineNum">    1848 </span>            :   //
<span class="lineNum">    1849 </span><span class="lineCov">         96 :   fMaxSigmaClY=0.; //AD</span>
<span class="lineNum">    1850 </span><span class="lineCov">         48 :   fMaxSigmaClZ=0.; //AD</span>
<span class="lineNum">    1851 </span><span class="lineCov">         48 :   AliITSRecPoint *clusters[fN];</span>
<span class="lineNum">    1852 </span><span class="lineCov">         48 :   Float_t z[fN];</span>
<span class="lineNum">    1853 </span><span class="lineCov">         48 :   Int_t   index[fN];</span>
<span class="lineNum">    1854 </span>            : 
<span class="lineNum">    1855 </span><span class="lineCov">       1428 :   for (Int_t i=0;i&lt;fN;i++){</span>
<span class="lineNum">    1856 </span><span class="lineCov">        666 :     z[i] = fClusters[i]-&gt;GetZ();</span>
<span class="lineNum">    1857 </span>            :     // save largest errors in y and z for this layer
<span class="lineNum">    1858 </span><span class="lineCov">        666 :     fMaxSigmaClY=TMath::Max(fMaxSigmaClY,TMath::Sqrt(fClusters[i]-&gt;GetSigmaY2()));</span>
<span class="lineNum">    1859 </span><span class="lineCov">        666 :     fMaxSigmaClZ=TMath::Max(fMaxSigmaClZ,TMath::Sqrt(fClusters[i]-&gt;GetSigmaZ2()));</span>
<span class="lineNum">    1860 </span>            :   }
<span class="lineNum">    1861 </span><span class="lineCov">         48 :   TMath::Sort(fN,z,index,kFALSE);</span>
<span class="lineNum">    1862 </span><span class="lineCov">       1428 :   for (Int_t i=fN;i--;) {</span>
<span class="lineNum">    1863 </span><span class="lineCov">        666 :     clusters[i] = fClusters[index[i]];</span>
<span class="lineNum">    1864 </span>            :   }
<span class="lineNum">    1865 </span>            :   //
<span class="lineNum">    1866 </span><span class="lineCov">       1428 :   for (Int_t i=fN;i--;){</span>
<span class="lineNum">    1867 </span><span class="lineCov">        666 :     fClusters[i] = clusters[i];</span>
<span class="lineNum">    1868 </span><span class="lineCov">        666 :     fZ[i]        = fClusters[i]-&gt;GetZ();</span>
<span class="lineNum">    1869 </span><span class="lineCov">        666 :     AliITSdetector &amp;det=GetDetector(fClusters[i]-&gt;GetDetectorIndex());    </span>
<span class="lineNum">    1870 </span><span class="lineCov">        666 :     Double_t y=fR*det.GetPhi() + fClusters[i]-&gt;GetY();</span>
<span class="lineNum">    1871 </span><span class="lineCov">        674 :     if (y&gt;2.*fR*TMath::Pi()) y -= 2.*fR*TMath::Pi();</span>
<span class="lineNum">    1872 </span><span class="lineCov">        666 :     fY[i] = y;</span>
<span class="lineNum">    1873 </span>            :   }
<span class="lineNum">    1874 </span>            :   //  delete[] index; // RS Moved to stack
<span class="lineNum">    1875 </span>            :   //  delete[] z;
<span class="lineNum">    1876 </span>            :   //  delete[] clusters;
<span class="lineNum">    1877 </span>            :   //
<span class="lineNum">    1878 </span>            : 
<span class="lineNum">    1879 </span><span class="lineCov">         48 :   fYB[0]=10000000;</span>
<span class="lineNum">    1880 </span><span class="lineCov">         48 :   fYB[1]=-10000000;</span>
<span class="lineNum">    1881 </span><span class="lineCov">       1428 :   for (Int_t i=0;i&lt;fN;i++){</span>
<span class="lineNum">    1882 </span><span class="lineCov">        770 :     if (fY[i]&lt;fYB[0]) fYB[0]=fY[i];</span>
<span class="lineNum">    1883 </span><span class="lineCov">        826 :     if (fY[i]&gt;fYB[1]) fYB[1]=fY[i];</span>
<span class="lineNum">    1884 </span><span class="lineCov">        666 :     fClusterIndex[i] = i;</span>
<span class="lineNum">    1885 </span>            :   }
<span class="lineNum">    1886 </span>            :   //
<span class="lineNum">    1887 </span>            :   // fill slices
<span class="lineNum">    1888 </span><span class="lineCov">         48 :   fDy5 = (fYB[1]-fYB[0])/5.;</span>
<span class="lineNum">    1889 </span><span class="lineCov">         48 :   fDy10 = (fYB[1]-fYB[0])/10.;</span>
<span class="lineNum">    1890 </span><span class="lineCov">         48 :   fDy20 = (fYB[1]-fYB[0])/20.;</span>
<span class="lineNum">    1891 </span><span class="lineCov">        672 :   for (Int_t i=6;i--;)  fN5[i] =0;  </span>
<span class="lineNum">    1892 </span><span class="lineCov">       1152 :   for (Int_t i=11;i--;) fN10[i]=0;  </span>
<span class="lineNum">    1893 </span><span class="lineCov">       2112 :   for (Int_t i=21;i--;) fN20[i]=0;</span>
<span class="lineNum">    1894 </span>            :   //  
<span class="lineNum">    1895 </span><span class="lineCov">        672 :   for (Int_t i=6;i--;)  {fBy5[i][0]  =  fYB[0]+(i-0.75)*fDy5;  fBy5[i][1]  =  fYB[0]+(i+0.75)*fDy5;}</span>
<span class="lineNum">    1896 </span><span class="lineCov">       1152 :   for (Int_t i=11;i--;) {fBy10[i][0] =  fYB[0]+(i-0.75)*fDy10; fBy10[i][1] =  fYB[0]+(i+0.75)*fDy10;} </span>
<span class="lineNum">    1897 </span><span class="lineCov">       2112 :   for (Int_t i=21;i--;) {fBy20[i][0] =  fYB[0]+(i-0.75)*fDy20; fBy20[i][1] =  fYB[0]+(i+0.75)*fDy20;}</span>
<span class="lineNum">    1898 </span>            :   //
<span class="lineNum">    1899 </span>            :   //
<span class="lineNum">    1900 </span><span class="lineCov">       1428 :   for (Int_t i=0;i&lt;fN;i++)</span>
<span class="lineNum">    1901 </span><span class="lineCov">       5328 :     for (Int_t irot=-1;irot&lt;=1;irot++){</span>
<span class="lineNum">    1902 </span><span class="lineCov">       1998 :       Float_t curY = fY[i]+irot*TMath::TwoPi()*fR; </span>
<span class="lineNum">    1903 </span>            :       // slice 5
<span class="lineNum">    1904 </span><span class="lineCov">      27972 :       for (Int_t slice=0; slice&lt;6;slice++){</span>
<span class="lineNum">    1905 </span><span class="lineCov">      19112 :         if (fBy5[slice][0]&lt;curY &amp;&amp; curY&lt;fBy5[slice][1]&amp;&amp;fN5[slice]&lt;AliITSRecoParam::GetMaxClusterPerLayer5()){</span>
<span class="lineNum">    1906 </span><span class="lineCov">       1232 :           fClusters5[slice][fN5[slice]] = fClusters[i];</span>
<span class="lineNum">    1907 </span><span class="lineCov">       1232 :           fY5[slice][fN5[slice]] = curY;</span>
<span class="lineNum">    1908 </span><span class="lineCov">       1232 :           fZ5[slice][fN5[slice]] = fZ[i];</span>
<span class="lineNum">    1909 </span><span class="lineCov">       1232 :           fClusterIndex5[slice][fN5[slice]]=i;</span>
<span class="lineNum">    1910 </span><span class="lineCov">       1232 :           fN5[slice]++;</span>
<span class="lineNum">    1911 </span><span class="lineCov">       1232 :         }</span>
<span class="lineNum">    1912 </span>            :       }
<span class="lineNum">    1913 </span>            :       // slice 10
<span class="lineNum">    1914 </span><span class="lineCov">      47952 :       for (Int_t slice=0; slice&lt;11;slice++){</span>
<span class="lineNum">    1915 </span><span class="lineCov">      33154 :         if (fBy10[slice][0]&lt;curY &amp;&amp; curY&lt;fBy10[slice][1]&amp;&amp;fN10[slice]&lt;AliITSRecoParam::GetMaxClusterPerLayer10()){</span>
<span class="lineNum">    1916 </span><span class="lineCov">       1000 :           fClusters10[slice][fN10[slice]] = fClusters[i];</span>
<span class="lineNum">    1917 </span><span class="lineCov">       1000 :           fY10[slice][fN10[slice]] = curY;</span>
<span class="lineNum">    1918 </span><span class="lineCov">       1000 :           fZ10[slice][fN10[slice]] = fZ[i];</span>
<span class="lineNum">    1919 </span><span class="lineCov">       1000 :           fClusterIndex10[slice][fN10[slice]]=i;</span>
<span class="lineNum">    1920 </span><span class="lineCov">       1000 :           fN10[slice]++;</span>
<span class="lineNum">    1921 </span><span class="lineCov">       1000 :         }</span>
<span class="lineNum">    1922 </span>            :       }
<span class="lineNum">    1923 </span>            :       // slice 20
<span class="lineNum">    1924 </span><span class="lineCov">      87912 :       for (Int_t slice=0; slice&lt;21;slice++){</span>
<span class="lineNum">    1925 </span><span class="lineCov">      61652 :         if (fBy20[slice][0]&lt;curY &amp;&amp; curY&lt;fBy20[slice][1]&amp;&amp;fN20[slice]&lt;AliITSRecoParam::GetMaxClusterPerLayer20()){</span>
<span class="lineNum">    1926 </span><span class="lineCov">        858 :           fClusters20[slice][fN20[slice]] = fClusters[i];</span>
<span class="lineNum">    1927 </span><span class="lineCov">        858 :           fY20[slice][fN20[slice]] = curY;</span>
<span class="lineNum">    1928 </span><span class="lineCov">        858 :           fZ20[slice][fN20[slice]] = fZ[i];</span>
<span class="lineNum">    1929 </span><span class="lineCov">        858 :           fClusterIndex20[slice][fN20[slice]]=i;</span>
<span class="lineNum">    1930 </span><span class="lineCov">        858 :           fN20[slice]++;</span>
<span class="lineNum">    1931 </span><span class="lineCov">        858 :         }</span>
<span class="lineNum">    1932 </span>            :       }      
<span class="lineNum">    1933 </span>            :     }
<span class="lineNum">    1934 </span>            : 
<span class="lineNum">    1935 </span>            :   //
<span class="lineNum">    1936 </span>            :   // consistency check
<span class="lineNum">    1937 </span>            :   //
<span class="lineNum">    1938 </span><span class="lineCov">       1332 :   for (Int_t i=0;i&lt;fN-1;i++){</span>
<span class="lineNum">    1939 </span><span class="lineCov">        618 :     if (fZ[i]&gt;fZ[i+1]){</span>
<span class="lineNum">    1940 </span><span class="lineNoCov">          0 :       printf(&quot;Bug\n&quot;);</span>
<span class="lineNum">    1941 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1942 </span>            :   }
<span class="lineNum">    1943 </span>            :   //
<span class="lineNum">    1944 </span><span class="lineCov">       2112 :   for (Int_t slice=0;slice&lt;21;slice++)</span>
<span class="lineNum">    1945 </span><span class="lineCov">       2912 :   for (Int_t i=0;i&lt;fN20[slice]-1;i++){</span>
<span class="lineNum">    1946 </span><span class="lineCov">        448 :     if (fZ20[slice][i]&gt;fZ20[slice][i+1]){</span>
<span class="lineNum">    1947 </span><span class="lineNoCov">          0 :       printf(&quot;Bug\n&quot;);</span>
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1949 </span>            :   }
<span class="lineNum">    1950 </span>            : 
<span class="lineNum">    1951 </span>            : 
<a name="1952"><span class="lineNum">    1952 </span><span class="lineCov">         48 : }</span></a>
<span class="lineNum">    1953 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1954 </span>            : Int_t AliITStrackerMI::AliITSlayer::FindClusterIndex(Float_t z) const {
<span class="lineNum">    1955 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1956 </span>            :   // This function returns the index of the nearest cluster 
<span class="lineNum">    1957 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1958 </span>            :   Int_t ncl=0;
<span class="lineNum">    1959 </span>            :   const Float_t *zcl;  
<span class="lineNum">    1960 </span><span class="lineCov">      12960 :   if (fCurrentSlice&lt;0) {</span>
<span class="lineNum">    1961 </span><span class="lineCov">        144 :     ncl = fN;</span>
<span class="lineNum">    1962 </span><span class="lineCov">        144 :     zcl   = fZ;</span>
<span class="lineNum">    1963 </span><span class="lineCov">        144 :   }</span>
<span class="lineNum">    1964 </span>            :   else{
<span class="lineNum">    1965 </span><span class="lineCov">       6336 :     ncl   = fNcs;</span>
<span class="lineNum">    1966 </span><span class="lineCov">       6336 :     zcl   = fZcs;;</span>
<span class="lineNum">    1967 </span>            :   }
<span class="lineNum">    1968 </span>            :   
<span class="lineNum">    1969 </span><span class="lineCov">       6532 :   if (ncl==0) return 0;</span>
<span class="lineNum">    1970 </span><span class="lineCov">       6428 :   Int_t b=0, e=ncl-1, m=(b+e)/2;</span>
<span class="lineNum">    1971 </span><span class="lineCov">      29200 :   for (; b&lt;e; m=(b+e)/2) {</span>
<span class="lineNum">    1972 </span>            :     //    if (z &gt; fClusters[m]-&gt;GetZ()) b=m+1;
<span class="lineNum">    1973 </span><span class="lineCov">      12976 :     if (z &gt; zcl[m]) b=m+1;</span>
<span class="lineNum">    1974 </span>            :     else e=m; 
<span class="lineNum">    1975 </span>            :   }
<span class="lineNum">    1976 </span>            :   return m;
<a name="1977"><span class="lineNum">    1977 </span><span class="lineCov">       6480 : }</span></a>
<span class="lineNum">    1978 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1979 </span>            : Bool_t AliITStrackerMI::ComputeRoad(AliITStrackMI* track,Int_t ilayer,Int_t idet,Double_t &amp;zmin,Double_t &amp;zmax,Double_t &amp;ymin,Double_t &amp;ymax) const {
<span class="lineNum">    1980 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1981 </span>            :   // This function computes the rectangular road for this track
<span class="lineNum">    1982 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1983 </span>            : 
<span class="lineNum">    1984 </span>            : 
<span class="lineNum">    1985 </span><span class="lineCov">       9700 :   AliITSdetector &amp;det = fgLayers[ilayer].GetDetector(idet);</span>
<span class="lineNum">    1986 </span>            :   // take into account the misalignment: propagate track to misaligned detector plane
<span class="lineNum">    1987 </span><span class="lineCov">       4850 :   if (!track-&gt;Propagate(det.GetPhi(),det.GetRmisal())) return kFALSE;</span>
<span class="lineNum">    1988 </span>            : 
<span class="lineNum">    1989 </span><span class="lineCov">       9700 :   Double_t dz=AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaRoadZ()*</span>
<span class="lineNum">    1990 </span><span class="lineCov">       9700 :                     TMath::Sqrt(track-&gt;GetSigmaZ2() + </span>
<span class="lineNum">    1991 </span><span class="lineCov">       9700 :                     AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    1992 </span><span class="lineCov">       9700 :                     AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    1993 </span><span class="lineCov">       4850 :                     AliITSReconstructor::GetRecoParam()-&gt;GetSigmaZ2(ilayer));</span>
<span class="lineNum">    1994 </span><span class="lineCov">       9700 :   Double_t dy=AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaRoadY()*</span>
<span class="lineNum">    1995 </span><span class="lineCov">       9700 :                     TMath::Sqrt(track-&gt;GetSigmaY2() + </span>
<span class="lineNum">    1996 </span><span class="lineCov">       9700 :                     AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    1997 </span><span class="lineCov">       9700 :                     AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    1998 </span><span class="lineCov">       4850 :                     AliITSReconstructor::GetRecoParam()-&gt;GetSigmaY2(ilayer));</span>
<span class="lineNum">    1999 </span>            :       
<span class="lineNum">    2000 </span>            :   // track at boundary between detectors, enlarge road
<span class="lineNum">    2001 </span><span class="lineCov">       4850 :   Double_t boundaryWidth=AliITSRecoParam::GetBoundaryWidth();</span>
<span class="lineNum">    2002 </span><span class="lineCov">       4850 :   if ( (track-&gt;GetY()-dy &lt; det.GetYmin()+boundaryWidth) || </span>
<span class="lineNum">    2003 </span><span class="lineCov">        256 :        (track-&gt;GetY()+dy &gt; det.GetYmax()-boundaryWidth) || </span>
<span class="lineNum">    2004 </span><span class="lineCov">         48 :        (track-&gt;GetZ()-dz &lt; det.GetZmin()+boundaryWidth) ||</span>
<span class="lineNum">    2005 </span><span class="lineNoCov">          0 :        (track-&gt;GetZ()+dz &gt; det.GetZmax()-boundaryWidth) ) {</span>
<span class="lineNum">    2006 </span><span class="lineCov">       4850 :     Float_t tgl = TMath::Abs(track-&gt;GetTgl());</span>
<span class="lineNum">    2007 </span><span class="lineCov">       4850 :     if (tgl &gt; 1.) tgl=1.;</span>
<span class="lineNum">    2008 </span><span class="lineCov">       4850 :     Double_t deltaXNeighbDets=AliITSRecoParam::GetDeltaXNeighbDets();</span>
<span class="lineNum">    2009 </span><span class="lineCov">       4850 :     dz = TMath::Sqrt(dz*dz+deltaXNeighbDets*deltaXNeighbDets*tgl*tgl);</span>
<span class="lineNum">    2010 </span><span class="lineCov">       4850 :     Float_t snp = TMath::Abs(track-&gt;GetSnp());</span>
<span class="lineNum">    2011 </span><span class="lineCov">       4850 :     if (snp &gt; AliITSReconstructor::GetRecoParam()-&gt;GetMaxSnp()) return kFALSE;</span>
<span class="lineNum">    2012 </span><span class="lineCov">       4850 :     dy = TMath::Sqrt(dy*dy+deltaXNeighbDets*deltaXNeighbDets*snp*snp);</span>
<span class="lineNum">    2013 </span><span class="lineCov">       4850 :   } // boundary</span>
<span class="lineNum">    2014 </span>            :   
<span class="lineNum">    2015 </span>            :   // add to the road a term (up to 2-3 mm) to deal with misalignments
<span class="lineNum">    2016 </span><span class="lineCov">       4850 :   dy = TMath::Sqrt(dy*dy + AliITSReconstructor::GetRecoParam()-&gt;GetRoadMisal()*AliITSReconstructor::GetRecoParam()-&gt;GetRoadMisal());</span>
<span class="lineNum">    2017 </span><span class="lineCov">       4850 :   dz = TMath::Sqrt(dz*dz + AliITSReconstructor::GetRecoParam()-&gt;GetRoadMisal()*AliITSReconstructor::GetRecoParam()-&gt;GetRoadMisal());</span>
<span class="lineNum">    2018 </span>            : 
<span class="lineNum">    2019 </span><span class="lineCov">       4850 :   Double_t r = fgLayers[ilayer].GetR();</span>
<span class="lineNum">    2020 </span><span class="lineCov">       4850 :   zmin = track-&gt;GetZ() - dz; </span>
<span class="lineNum">    2021 </span><span class="lineCov">       4850 :   zmax = track-&gt;GetZ() + dz;</span>
<span class="lineNum">    2022 </span><span class="lineCov">       4850 :   ymin = track-&gt;GetY() + r*det.GetPhi() - dy;</span>
<span class="lineNum">    2023 </span><span class="lineCov">       4850 :   ymax = track-&gt;GetY() + r*det.GetPhi() + dy;</span>
<span class="lineNum">    2024 </span>            : 
<span class="lineNum">    2025 </span>            :   // bring track back to idead detector plane
<span class="lineNum">    2026 </span><span class="lineCov">       4850 :   if (!track-&gt;Propagate(det.GetPhi(),det.GetR())) return kFALSE;</span>
<span class="lineNum">    2027 </span>            : 
<span class="lineNum">    2028 </span><span class="lineCov">       4850 :   return kTRUE;</span>
<span class="lineNum">    2029 </span><span class="lineCov">       4850 : }</span>
<a name="2030"><span class="lineNum">    2030 </span>            : //------------------------------------------------------------------------</a>
<span class="lineNum">    2031 </span>            : void AliITStrackerMI::AliITSlayer::
<span class="lineNum">    2032 </span>            : SelectClusters(Double_t zmin,Double_t zmax,Double_t ymin, Double_t ymax) {
<span class="lineNum">    2033 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2034 </span>            :   // This function sets the &quot;window&quot;
<span class="lineNum">    2035 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2036 </span>            :  
<span class="lineNum">    2037 </span><span class="lineCov">       6480 :   Double_t circle=2*TMath::Pi()*fR;</span>
<span class="lineNum">    2038 </span><span class="lineCov">       3240 :   fYmin = ymin; </span>
<span class="lineNum">    2039 </span><span class="lineCov">       3240 :   fYmax = ymax;</span>
<span class="lineNum">    2040 </span><span class="lineCov">       3240 :   fZmin = zmin;</span>
<span class="lineNum">    2041 </span><span class="lineCov">       3240 :   fZmax = zmax;</span>
<span class="lineNum">    2042 </span>            :   // AD
<span class="lineNum">    2043 </span>            :   // enlarge road in y by maximum cluster error on this layer (3 sigma)
<span class="lineNum">    2044 </span><span class="lineCov">       3240 :   fYmin -= fNMaxSigmaCl*fMaxSigmaClY;</span>
<span class="lineNum">    2045 </span><span class="lineCov">       3240 :   fYmax += fNMaxSigmaCl*fMaxSigmaClY;</span>
<span class="lineNum">    2046 </span><span class="lineCov">       3240 :   fZmin -= fNMaxSigmaCl*fMaxSigmaClZ;</span>
<span class="lineNum">    2047 </span><span class="lineCov">       3240 :   fZmax += fNMaxSigmaCl*fMaxSigmaClZ;</span>
<span class="lineNum">    2048 </span>            : 
<span class="lineNum">    2049 </span><span class="lineCov">       3240 :   Float_t ymiddle = (fYmin+fYmax)*0.5;</span>
<span class="lineNum">    2050 </span><span class="lineCov">       3240 :   if (ymiddle&lt;fYB[0]) {</span>
<span class="lineNum">    2051 </span><span class="lineCov">        202 :     fYmin+=circle; fYmax+=circle; ymiddle+=circle;</span>
<span class="lineNum">    2052 </span><span class="lineCov">       3240 :   } else if (ymiddle&gt;fYB[1]) {</span>
<span class="lineNum">    2053 </span><span class="lineCov">        344 :     fYmin-=circle; fYmax-=circle; ymiddle-=circle;</span>
<span class="lineNum">    2054 </span><span class="lineCov">        344 :   }</span>
<span class="lineNum">    2055 </span>            :   
<span class="lineNum">    2056 </span>            :   //
<span class="lineNum">    2057 </span><span class="lineCov">       3240 :   fCurrentSlice =-1;</span>
<span class="lineNum">    2058 </span>            :   // defualt take all
<span class="lineNum">    2059 </span><span class="lineCov">       3240 :   fClustersCs = fClusters;</span>
<span class="lineNum">    2060 </span><span class="lineCov">       3240 :   fClusterIndexCs = fClusterIndex;</span>
<span class="lineNum">    2061 </span><span class="lineCov">       3240 :   fYcs  = fY;</span>
<span class="lineNum">    2062 </span><span class="lineCov">       3240 :   fZcs  = fZ;</span>
<span class="lineNum">    2063 </span><span class="lineCov">       3240 :   fNcs  = fN;</span>
<span class="lineNum">    2064 </span>            :   //
<span class="lineNum">    2065 </span>            :   //is in 20 slice?
<span class="lineNum">    2066 </span><span class="lineCov">       6480 :   if (fCurrentSlice&lt;0&amp;&amp;TMath::Abs(fYmax-fYmin)&lt;1.49*fDy20){</span>
<span class="lineNum">    2067 </span><span class="lineCov">       3232 :     Int_t slice = int(0.5+(ymiddle-fYB[0])/fDy20);</span>
<span class="lineNum">    2068 </span><span class="lineCov">       3232 :     if (slice&lt;0) slice=0;</span>
<span class="lineNum">    2069 </span><span class="lineCov">       3232 :     if (slice&gt;20) slice=20;</span>
<span class="lineNum">    2070 </span><span class="lineCov">       9520 :     Bool_t isOK = (fYmin&gt;fBy20[slice][0]&amp;&amp;fYmax&lt;fBy20[slice][1]);</span>
<span class="lineNum">    2071 </span><span class="lineCov">       3232 :     if (isOK) {</span>
<span class="lineNum">    2072 </span><span class="lineCov">       2852 :       fCurrentSlice=slice;</span>
<span class="lineNum">    2073 </span><span class="lineCov">       2852 :       fClustersCs = fClusters20[fCurrentSlice];</span>
<span class="lineNum">    2074 </span><span class="lineCov">       2852 :       fClusterIndexCs = fClusterIndex20[fCurrentSlice];</span>
<span class="lineNum">    2075 </span><span class="lineCov">       2852 :       fYcs  = fY20[fCurrentSlice];</span>
<span class="lineNum">    2076 </span><span class="lineCov">       2852 :       fZcs  = fZ20[fCurrentSlice];</span>
<span class="lineNum">    2077 </span><span class="lineCov">       2852 :       fNcs  = fN20[fCurrentSlice];</span>
<span class="lineNum">    2078 </span><span class="lineCov">       2852 :     }</span>
<span class="lineNum">    2079 </span><span class="lineCov">       3232 :   }  </span>
<span class="lineNum">    2080 </span>            :   //
<span class="lineNum">    2081 </span>            :   //is in 10 slice?
<span class="lineNum">    2082 </span><span class="lineCov">       3628 :   if (fCurrentSlice&lt;0&amp;&amp;TMath::Abs(fYmax-fYmin)&lt;1.49*fDy10){</span>
<span class="lineNum">    2083 </span><span class="lineCov">        385 :     Int_t slice = int(0.5+(ymiddle-fYB[0])/fDy10);</span>
<span class="lineNum">    2084 </span><span class="lineCov">        385 :     if (slice&lt;0) slice=0;</span>
<span class="lineNum">    2085 </span><span class="lineCov">        385 :     if (slice&gt;10) slice=10;</span>
<span class="lineNum">    2086 </span><span class="lineCov">        979 :     Bool_t isOK = (fYmin&gt;fBy10[slice][0]&amp;&amp;fYmax&lt;fBy10[slice][1]);</span>
<span class="lineNum">    2087 </span><span class="lineCov">        385 :     if (isOK) {</span>
<span class="lineNum">    2088 </span><span class="lineCov">          6 :       fCurrentSlice=slice;</span>
<span class="lineNum">    2089 </span><span class="lineCov">          6 :       fClustersCs = fClusters10[fCurrentSlice];</span>
<span class="lineNum">    2090 </span><span class="lineCov">          6 :       fClusterIndexCs = fClusterIndex10[fCurrentSlice];</span>
<span class="lineNum">    2091 </span><span class="lineCov">          6 :       fYcs  = fY10[fCurrentSlice];</span>
<span class="lineNum">    2092 </span><span class="lineCov">          6 :       fZcs  = fZ10[fCurrentSlice];</span>
<span class="lineNum">    2093 </span><span class="lineCov">          6 :       fNcs  = fN10[fCurrentSlice];</span>
<span class="lineNum">    2094 </span><span class="lineCov">          6 :     }</span>
<span class="lineNum">    2095 </span><span class="lineCov">        385 :   }  </span>
<span class="lineNum">    2096 </span>            :   //
<span class="lineNum">    2097 </span>            :   //is in 5 slice?
<span class="lineNum">    2098 </span><span class="lineCov">       3622 :   if (fCurrentSlice&lt;0&amp;&amp;TMath::Abs(fYmax-fYmin)&lt;1.49*fDy5){</span>
<span class="lineNum">    2099 </span><span class="lineCov">        382 :     Int_t slice = int(0.5+(ymiddle-fYB[0])/fDy5);</span>
<span class="lineNum">    2100 </span><span class="lineCov">        382 :     if (slice&lt;0) slice=0;</span>
<span class="lineNum">    2101 </span><span class="lineCov">        382 :     if (slice&gt;5) slice=5;</span>
<span class="lineNum">    2102 </span><span class="lineCov">       1074 :     Bool_t isOK = (fYmin&gt;fBy5[slice][0]&amp;&amp;fYmax&lt;fBy5[slice][1]);</span>
<span class="lineNum">    2103 </span><span class="lineCov">        382 :     if (isOK) {</span>
<span class="lineNum">    2104 </span><span class="lineCov">        310 :       fCurrentSlice=slice;</span>
<span class="lineNum">    2105 </span><span class="lineCov">        310 :       fClustersCs = fClusters5[fCurrentSlice];</span>
<span class="lineNum">    2106 </span><span class="lineCov">        310 :       fClusterIndexCs = fClusterIndex5[fCurrentSlice];</span>
<span class="lineNum">    2107 </span><span class="lineCov">        310 :       fYcs  = fY5[fCurrentSlice];</span>
<span class="lineNum">    2108 </span><span class="lineCov">        310 :       fZcs  = fZ5[fCurrentSlice];</span>
<span class="lineNum">    2109 </span><span class="lineCov">        310 :       fNcs  = fN5[fCurrentSlice];</span>
<span class="lineNum">    2110 </span><span class="lineCov">        310 :     }</span>
<span class="lineNum">    2111 </span><span class="lineCov">        382 :   }  </span>
<span class="lineNum">    2112 </span>            :   //  
<span class="lineNum">    2113 </span><span class="lineCov">       3240 :   fI        = FindClusterIndex(fZmin); </span>
<span class="lineNum">    2114 </span><span class="lineCov">       3240 :   fImax     = TMath::Min(FindClusterIndex(fZmax)+1,fNcs);</span>
<span class="lineNum">    2115 </span><span class="lineCov">       3240 :   fSkip     = 0;</span>
<span class="lineNum">    2116 </span><span class="lineCov">       3240 :   fAccepted = 0;</span>
<span class="lineNum">    2117 </span>            : 
<span class="lineNum">    2118 </span>            :   return;
<span class="lineNum">    2119 </span><span class="lineCov">       3240 : }</span>
<a name="2120"><span class="lineNum">    2120 </span>            : //------------------------------------------------------------------------</a>
<span class="lineNum">    2121 </span>            : Int_t AliITStrackerMI::AliITSlayer::
<span class="lineNum">    2122 </span>            : FindDetectorIndex(Double_t phi, Double_t z) const {
<span class="lineNum">    2123 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2124 </span>            :   //This function finds the detector crossed by the track
<span class="lineNum">    2125 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2126 </span>            :   Double_t dphi;
<span class="lineNum">    2127 </span><span class="lineCov">      41490 :   if (fZOffset&lt;0)            // old geometry</span>
<span class="lineNum">    2128 </span><span class="lineCov">      13830 :     dphi = -(phi-fPhiOffset);</span>
<span class="lineNum">    2129 </span>            :   else                       // new geometry
<span class="lineNum">    2130 </span>            :     dphi = phi-fPhiOffset;
<span class="lineNum">    2131 </span>            : 
<span class="lineNum">    2132 </span>            : 
<span class="lineNum">    2133 </span><span class="lineCov">      14924 :   if      (dphi &lt;  0) dphi += 2*TMath::Pi();</span>
<span class="lineNum">    2134 </span><span class="lineCov">      12736 :   else if (dphi &gt;= 2*TMath::Pi()) dphi -= 2*TMath::Pi();</span>
<span class="lineNum">    2135 </span><span class="lineCov">      13830 :   Int_t np=Int_t(dphi*fNladders*0.5/TMath::Pi()+0.5);</span>
<span class="lineNum">    2136 </span><span class="lineCov">      14924 :   if (np&gt;=fNladders) np-=fNladders;</span>
<span class="lineNum">    2137 </span><span class="lineCov">      13830 :   if (np&lt;0)          np+=fNladders;</span>
<span class="lineNum">    2138 </span>            : 
<span class="lineNum">    2139 </span>            : 
<span class="lineNum">    2140 </span><span class="lineCov">      13830 :   Double_t dz=fZOffset-z;</span>
<span class="lineNum">    2141 </span><span class="lineCov">      13830 :   Double_t nnz = dz*(fNdetectors-1)*0.5/fZOffset+0.5;</span>
<span class="lineNum">    2142 </span><span class="lineCov">      13830 :   Int_t nz = (nnz&lt;0 ? -1 : (Int_t)nnz);</span>
<span class="lineNum">    2143 </span><span class="lineCov">      13830 :   if (nz&gt;=fNdetectors || nz&lt;0) {</span>
<span class="lineNum">    2144 </span>            :     //printf(&quot;ndet %d phi %f z %f  np %d nz %d\n&quot;,fNdetectors,phi,z,np,nz);
<span class="lineNum">    2145 </span><span class="lineCov">          4 :     return -1;</span>
<span class="lineNum">    2146 </span>            :   }
<span class="lineNum">    2147 </span>            : 
<span class="lineNum">    2148 </span>            :   // ad hoc correction for 3rd ladder of SDD inner layer,
<span class="lineNum">    2149 </span>            :   // which is reversed (rotated by pi around local y)
<span class="lineNum">    2150 </span>            :   // this correction is OK only from AliITSv11Hybrid onwards
<span class="lineNum">    2151 </span><span class="lineCov">      32694 :   if (GetR()&gt;12. &amp;&amp; GetR()&lt;20.) { // SDD inner</span>
<span class="lineNum">    2152 </span><span class="lineCov">       9434 :     if(np==2) { // 3rd ladder</span>
<span class="lineNum">    2153 </span><span class="lineNoCov">          0 :       Double_t posMod252[3]={0};</span>
<span class="lineNum">    2154 </span><span class="lineNoCov">          0 :       AliITSgeomTGeo::GetTranslation(252,posMod252);</span>
<span class="lineNum">    2155 </span>            :       // check the Z coordinate of Mod 252: if negative 
<span class="lineNum">    2156 </span>            :       // (old SDD geometry in AliITSv11Hybrid)
<span class="lineNum">    2157 </span>            :       // the swap of numeration whould be applied
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :       if(posMod252[2]&lt;0.){</span>
<span class="lineNum">    2159 </span><span class="lineNoCov">          0 :         nz = (fNdetectors-1) - nz;</span>
<span class="lineNum">    2160 </span><span class="lineNoCov">          0 :       } </span>
<span class="lineNum">    2161 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2162 </span>            :   }
<span class="lineNum">    2163 </span>            :   //printf(&quot;ndet %d phi %f z %f  np %d nz %d\n&quot;,fNdetectors,phi,z,np,nz);
<span class="lineNum">    2164 </span>            : 
<span class="lineNum">    2165 </span>            : 
<span class="lineNum">    2166 </span><span class="lineCov">      13826 :   return np*fNdetectors + nz;</span>
<a name="2167"><span class="lineNum">    2167 </span><span class="lineCov">      13830 : }</span></a>
<span class="lineNum">    2168 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2169 </span>            : const AliITSRecPoint *AliITStrackerMI::AliITSlayer::GetNextCluster(Int_t &amp;ci,Bool_t test)
<span class="lineNum">    2170 </span>            : {
<span class="lineNum">    2171 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2172 </span>            :   // This function returns clusters within the &quot;window&quot; 
<span class="lineNum">    2173 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2174 </span>            : 
<span class="lineNum">    2175 </span><span class="lineCov">       9770 :   if (fCurrentSlice&lt;0) {</span>
<span class="lineNum">    2176 </span><span class="lineCov">        176 :     Double_t rpi2 = 2.*fR*TMath::Pi();</span>
<span class="lineNum">    2177 </span><span class="lineCov">        884 :     for (Int_t i=fI; i&lt;fImax; i++) {</span>
<span class="lineNum">    2178 </span><span class="lineCov">        286 :       Double_t y = fY[i];</span>
<span class="lineNum">    2179 </span><span class="lineCov">        286 :       Double_t z = fZ[i];</span>
<span class="lineNum">    2180 </span><span class="lineCov">        572 :       if (fYmax&lt;y) y -= rpi2;</span>
<span class="lineNum">    2181 </span><span class="lineCov">        500 :       if (fYmin&gt;y) y += rpi2;</span>
<span class="lineNum">    2182 </span><span class="lineCov">        286 :       if (y&lt;fYmin) continue;</span>
<span class="lineNum">    2183 </span><span class="lineCov">        500 :       if (y&gt;fYmax) continue;</span>
<span class="lineNum">    2184 </span>            :       // AD
<span class="lineNum">    2185 </span>            :       // skip clusters that are in &quot;extended&quot; road but they 
<span class="lineNum">    2186 </span>            :       // 3sigma error does not touch the original road
<span class="lineNum">    2187 </span><span class="lineCov">         72 :       if (z+fNMaxSigmaCl*TMath::Sqrt(fClusters[i]-&gt;GetSigmaZ2())&lt;fZmin+fNMaxSigmaCl*fMaxSigmaClZ) continue;</span>
<span class="lineNum">    2188 </span><span class="lineCov">         72 :       if (z-fNMaxSigmaCl*TMath::Sqrt(fClusters[i]-&gt;GetSigmaZ2())&gt;fZmax-fNMaxSigmaCl*fMaxSigmaClZ) continue;</span>
<span class="lineNum">    2189 </span>            :       //
<span class="lineNum">    2190 </span><span class="lineCov">         72 :       if (TMath::Abs(fClusters[i]-&gt;GetQ())&lt;1.e-13 &amp;&amp; fSkip==2) continue;</span>
<span class="lineNum">    2191 </span><span class="lineCov">         72 :       ci=i;</span>
<span class="lineNum">    2192 </span><span class="lineCov">        112 :       if (!test) fI=i+1;</span>
<span class="lineNum">    2193 </span><span class="lineCov">         72 :       return fClusters[i];</span>
<span class="lineNum">    2194 </span>            :     }
<span class="lineNum">    2195 </span><span class="lineCov">        104 :   } else {</span>
<span class="lineNum">    2196 </span><span class="lineCov">      26242 :     for (Int_t i=fI; i&lt;fImax; i++) {</span>
<span class="lineNum">    2197 </span><span class="lineCov">       8186 :       if (fYcs[i]&lt;fYmin) continue;</span>
<span class="lineNum">    2198 </span><span class="lineCov">       7126 :       if (fYcs[i]&gt;fYmax) continue;</span>
<span class="lineNum">    2199 </span><span class="lineCov">       6304 :       if (TMath::Abs(fClustersCs[i]-&gt;GetQ())&lt;1.e-13 &amp;&amp; fSkip==2) continue;</span>
<span class="lineNum">    2200 </span><span class="lineCov">       6304 :       ci=fClusterIndexCs[i];</span>
<span class="lineNum">    2201 </span><span class="lineCov">      10068 :       if (!test) fI=i+1;</span>
<span class="lineNum">    2202 </span><span class="lineCov">       6304 :       return fClustersCs[i];</span>
<span class="lineNum">    2203 </span>            :     }
<span class="lineNum">    2204 </span>            :   }
<span class="lineNum">    2205 </span><span class="lineCov">       3394 :   return 0;</span>
<a name="2206"><span class="lineNum">    2206 </span><span class="lineCov">       9770 : }</span></a>
<span class="lineNum">    2207 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2208 </span>            : Double_t AliITStrackerMI::AliITSlayer::GetThickness(Double_t y,Double_t z,Double_t &amp;x0)
<span class="lineNum">    2209 </span>            : const {
<span class="lineNum">    2210 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2211 </span>            :   // This function returns the layer thickness at this point (units X0)
<span class="lineNum">    2212 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2213 </span>            :   Double_t d=0.0085;
<span class="lineNum">    2214 </span><span class="lineCov">        424 :   x0=AliITSRecoParam::GetX0Air();</span>
<span class="lineNum">    2215 </span><span class="lineCov">        248 :   if (43&lt;fR&amp;&amp;fR&lt;45) { //SSD2</span>
<span class="lineNum">    2216 </span>            :      Double_t dd=0.0034;
<span class="lineNum">    2217 </span>            :      d=dd;
<span class="lineNum">    2218 </span><span class="lineCov">         40 :      if (TMath::Abs(y-0.00)&gt;3.40) d+=dd;</span>
<span class="lineNum">    2219 </span><span class="lineCov">         36 :      if (TMath::Abs(y-1.90)&lt;0.45) {d+=(0.013-0.0034);}</span>
<span class="lineNum">    2220 </span><span class="lineCov">         36 :      if (TMath::Abs(y+1.90)&lt;0.45) {d+=(0.013-0.0034);}</span>
<span class="lineNum">    2221 </span><span class="lineCov">        334 :      for (Int_t i=0; i&lt;12; i++) {</span>
<span class="lineNum">    2222 </span><span class="lineCov">        152 :        if (TMath::Abs(z-3.9*(i+0.5))&lt;0.15) {</span>
<span class="lineNum">    2223 </span><span class="lineNoCov">          0 :           if (TMath::Abs(y-0.00)&gt;3.40) d+=dd;</span>
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 :           d+=0.0034; </span>
<span class="lineNum">    2225 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    2226 </span>            :        }
<span class="lineNum">    2227 </span><span class="lineCov">        152 :        if (TMath::Abs(z+3.9*(i+0.5))&lt;0.15) {</span>
<span class="lineNum">    2228 </span><span class="lineNoCov">          0 :           if (TMath::Abs(y-0.00)&gt;3.40) d+=dd;</span>
<span class="lineNum">    2229 </span><span class="lineNoCov">          0 :           d+=0.0034; </span>
<span class="lineNum">    2230 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    2231 </span>            :        }         
<span class="lineNum">    2232 </span><span class="lineCov">        152 :        if (TMath::Abs(z-3.4-3.9*i)&lt;0.50) {d+=(0.016-0.0034); break;}</span>
<span class="lineNum">    2233 </span><span class="lineCov">        178 :        if (TMath::Abs(z+0.5+3.9*i)&lt;0.50) {d+=(0.016-0.0034); break;}</span>
<span class="lineNum">    2234 </span>            :      }
<span class="lineNum">    2235 </span><span class="lineCov">         36 :   } else </span>
<span class="lineNum">    2236 </span><span class="lineCov">        212 :   if (37&lt;fR&amp;&amp;fR&lt;41) { //SSD1</span>
<span class="lineNum">    2237 </span>            :      Double_t dd=0.0034;
<span class="lineNum">    2238 </span>            :      d=dd;
<span class="lineNum">    2239 </span><span class="lineCov">         36 :      if (TMath::Abs(y-0.00)&gt;3.40) d+=dd;</span>
<span class="lineNum">    2240 </span><span class="lineCov">         44 :      if (TMath::Abs(y-1.90)&lt;0.45) {d+=(0.013-0.0034);}</span>
<span class="lineNum">    2241 </span><span class="lineCov">         38 :      if (TMath::Abs(y+1.90)&lt;0.45) {d+=(0.013-0.0034);}</span>
<span class="lineNum">    2242 </span><span class="lineCov">        410 :      for (Int_t i=0; i&lt;11; i++) {</span>
<span class="lineNum">    2243 </span><span class="lineCov">        184 :        if (TMath::Abs(z-3.9*i)&lt;0.15) {</span>
<span class="lineNum">    2244 </span><span class="lineCov">         20 :           if (TMath::Abs(y-0.00)&gt;3.40) d+=dd;</span>
<span class="lineNum">    2245 </span><span class="lineCov">         20 :           d+=dd; </span>
<span class="lineNum">    2246 </span><span class="lineCov">         20 :           break;</span>
<span class="lineNum">    2247 </span>            :        }
<span class="lineNum">    2248 </span><span class="lineCov">        164 :        if (TMath::Abs(z+3.9*i)&lt;0.15) {</span>
<span class="lineNum">    2249 </span><span class="lineNoCov">          0 :           if (TMath::Abs(y-0.00)&gt;3.40) d+=dd;</span>
<span class="lineNum">    2250 </span><span class="lineNoCov">          0 :           d+=dd; </span>
<span class="lineNum">    2251 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    2252 </span>            :        }         
<span class="lineNum">    2253 </span><span class="lineCov">        166 :        if (TMath::Abs(z-1.85-3.9*i)&lt;0.50) {d+=(0.016-0.0034); break;}</span>
<span class="lineNum">    2254 </span><span class="lineCov">        162 :        if (TMath::Abs(z+2.05+3.9*i)&lt;0.50) {d+=(0.016-0.0034); break;}         </span>
<span class="lineNum">    2255 </span>            :      }
<span class="lineNum">    2256 </span><span class="lineCov">         36 :   } else</span>
<span class="lineNum">    2257 </span><span class="lineCov">        212 :   if (13&lt;fR&amp;&amp;fR&lt;26) { //SDD</span>
<span class="lineNum">    2258 </span>            :      Double_t dd=0.0033;
<span class="lineNum">    2259 </span>            :      d=dd;
<span class="lineNum">    2260 </span><span class="lineCov">         74 :      if (TMath::Abs(y-0.00)&gt;3.30) d+=dd;</span>
<span class="lineNum">    2261 </span>            : 
<span class="lineNum">    2262 </span><span class="lineCov">         72 :      if (TMath::Abs(y-1.80)&lt;0.55) {</span>
<span class="lineNum">    2263 </span><span class="lineCov">          8 :         d+=0.016;</span>
<span class="lineNum">    2264 </span><span class="lineCov">        266 :         for (Int_t j=0; j&lt;20; j++) {</span>
<span class="lineNum">    2265 </span><span class="lineCov">        126 :           if (TMath::Abs(z+0.7+1.47*j)&lt;0.12) {d+=0.08; x0=9.; break;}</span>
<span class="lineNum">    2266 </span><span class="lineCov">        122 :           if (TMath::Abs(z-0.7-1.47*j)&lt;0.12) {d+=0.08; x0=9.; break;}</span>
<span class="lineNum">    2267 </span>            :         } 
<span class="lineNum">    2268 </span><span class="lineCov">          8 :      }</span>
<span class="lineNum">    2269 </span><span class="lineCov">         72 :      if (TMath::Abs(y+1.80)&lt;0.55) {</span>
<span class="lineNum">    2270 </span><span class="lineCov">          8 :         d+=0.016;</span>
<span class="lineNum">    2271 </span><span class="lineCov">        344 :         for (Int_t j=0; j&lt;20; j++) {</span>
<span class="lineNum">    2272 </span><span class="lineCov">        160 :           if (TMath::Abs(z-0.7-1.47*j)&lt;0.12) {d+=0.08; x0=9.; break;}</span>
<span class="lineNum">    2273 </span><span class="lineCov">        160 :           if (TMath::Abs(z+0.7+1.47*j)&lt;0.12) {d+=0.08; x0=9.; break;}</span>
<span class="lineNum">    2274 </span>            :         } 
<span class="lineNum">    2275 </span><span class="lineCov">          8 :      }</span>
<span class="lineNum">    2276 </span>            : 
<span class="lineNum">    2277 </span><span class="lineCov">        418 :      for (Int_t i=0; i&lt;4; i++) {</span>
<span class="lineNum">    2278 </span><span class="lineCov">        164 :        if (TMath::Abs(z-7.3*i)&lt;0.60) {</span>
<span class="lineNum">    2279 </span><span class="lineCov">         42 :           d+=dd;</span>
<span class="lineNum">    2280 </span><span class="lineCov">         42 :           if (TMath::Abs(y-0.00)&gt;3.30) d+=dd; </span>
<span class="lineNum">    2281 </span><span class="lineCov">         42 :           break;</span>
<span class="lineNum">    2282 </span>            :        }
<span class="lineNum">    2283 </span><span class="lineCov">        122 :        if (TMath::Abs(z+7.3*i)&lt;0.60) {</span>
<span class="lineNum">    2284 </span><span class="lineNoCov">          0 :           d+=dd; </span>
<span class="lineNum">    2285 </span><span class="lineNoCov">          0 :           if (TMath::Abs(y-0.00)&gt;3.30) d+=dd; </span>
<span class="lineNum">    2286 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    2287 </span>            :        }
<span class="lineNum">    2288 </span>            :      }
<span class="lineNum">    2289 </span><span class="lineCov">         72 :   } else</span>
<span class="lineNum">    2290 </span><span class="lineCov">        102 :   if (6&lt;fR&amp;&amp;fR&lt;8) {   //SPD2</span>
<span class="lineNum">    2291 </span><span class="lineCov">         34 :      Double_t dd=0.0063; x0=21.5;</span>
<span class="lineNum">    2292 </span>            :      d=dd;
<span class="lineNum">    2293 </span><span class="lineCov">         52 :      if (TMath::Abs(y-3.08)&gt;0.5) d+=dd;</span>
<span class="lineNum">    2294 </span><span class="lineCov">         34 :      if (TMath::Abs(y-3.03)&lt;0.10) d+=0.014;</span>
<span class="lineNum">    2295 </span><span class="lineCov">         34 :   } else</span>
<span class="lineNum">    2296 </span><span class="lineCov">         68 :   if (3&lt;fR&amp;&amp;fR&lt;5) {   //SPD1</span>
<span class="lineNum">    2297 </span><span class="lineCov">         34 :      Double_t dd=0.0063; x0=21.5;</span>
<span class="lineNum">    2298 </span>            :      d=dd;
<span class="lineNum">    2299 </span><span class="lineCov">         56 :      if (TMath::Abs(y+0.21)&gt;0.6) d+=dd;</span>
<span class="lineNum">    2300 </span><span class="lineCov">         40 :      if (TMath::Abs(y+0.10)&lt;0.10) d+=0.014;</span>
<span class="lineNum">    2301 </span><span class="lineCov">         34 :   }</span>
<span class="lineNum">    2302 </span>            : 
<span class="lineNum">    2303 </span><span class="lineCov">        212 :   return d;</span>
<a name="2304"><span class="lineNum">    2304 </span>            : }</a>
<span class="lineNum">    2305 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2306 </span>            : AliITStrackerMI::AliITSdetector::AliITSdetector(const AliITSdetector&amp; det):
<span class="lineNum">    2307 </span><span class="lineNoCov">          0 : fR(det.fR),</span>
<span class="lineNum">    2308 </span><span class="lineNoCov">          0 : fRmisal(det.fRmisal),</span>
<span class="lineNum">    2309 </span><span class="lineNoCov">          0 : fPhi(det.fPhi),</span>
<span class="lineNum">    2310 </span><span class="lineNoCov">          0 : fSinPhi(det.fSinPhi),</span>
<span class="lineNum">    2311 </span><span class="lineNoCov">          0 : fCosPhi(det.fCosPhi),</span>
<span class="lineNum">    2312 </span><span class="lineNoCov">          0 : fYmin(det.fYmin),</span>
<span class="lineNum">    2313 </span><span class="lineNoCov">          0 : fYmax(det.fYmax),</span>
<span class="lineNum">    2314 </span><span class="lineNoCov">          0 : fZmin(det.fZmin),</span>
<span class="lineNum">    2315 </span><span class="lineNoCov">          0 : fZmax(det.fZmax),</span>
<span class="lineNum">    2316 </span><span class="lineNoCov">          0 : fIsBad(det.fIsBad),</span>
<span class="lineNum">    2317 </span><span class="lineNoCov">          0 : fNChips(det.fNChips),</span>
<span class="lineNum">    2318 </span><span class="lineNoCov">          0 : fChipIsBad(det.fChipIsBad)</span>
<span class="lineNum">    2319 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">    2320 </span>            :   //Copy constructor
<a name="2321"><span class="lineNum">    2321 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2322 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2323 </span>            : void AliITStrackerMI::AliITSdetector::ReadBadDetectorAndChips(Int_t ilayer,Int_t idet,
<span class="lineNum">    2324 </span>            :                                                const AliITSDetTypeRec *detTypeRec)
<span class="lineNum">    2325 </span>            : {
<span class="lineNum">    2326 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2327 </span>            :   // Read bad detectors and chips from calibration objects in AliITSDetTypeRec
<span class="lineNum">    2328 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2329 </span>            : 
<span class="lineNum">    2330 </span>            :   // In AliITSDetTypeRec, detector numbers go from 0 to 2197
<span class="lineNum">    2331 </span>            :   // while in the tracker they start from 0 for each layer
<span class="lineNum">    2332 </span><span class="lineCov">      47580 :   for(Int_t il=0; il&lt;ilayer; il++) </span>
<span class="lineNum">    2333 </span><span class="lineCov">      17196 :     idet += AliITSgeomTGeo::GetNLadders(il+1)*AliITSgeomTGeo::GetNDetectors(il+1);</span>
<span class="lineNum">    2334 </span>            : 
<span class="lineNum">    2335 </span>            :   Int_t detType;
<span class="lineNum">    2336 </span><span class="lineCov">       4396 :   if (ilayer==0 || ilayer==1) {        // ----------  SPD</span>
<span class="lineNum">    2337 </span>            :     detType = 0;
<span class="lineNum">    2338 </span><span class="lineCov">       4396 :   } else if (ilayer==2 || ilayer==3) { // ----------  SDD</span>
<span class="lineNum">    2339 </span>            :     detType = 1;
<span class="lineNum">    2340 </span><span class="lineCov">       3916 :   } else if (ilayer==4 || ilayer==5) { // ----------  SSD</span>
<span class="lineNum">    2341 </span>            :     detType = 2;
<span class="lineNum">    2342 </span>            :   } else {
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :     printf(&quot;AliITStrackerMI::AliITSdetector::InitBadFromOCDB: Wrong layer number %d\n&quot;,ilayer);</span>
<span class="lineNum">    2344 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    2345 </span>            :   }
<span class="lineNum">    2346 </span>            : 
<span class="lineNum">    2347 </span>            :   // Get calibration from AliITSDetTypeRec
<span class="lineNum">    2348 </span><span class="lineCov">       4396 :   AliITSCalibration *calib = (AliITSCalibration*)detTypeRec-&gt;GetCalibrationModel(idet);</span>
<span class="lineNum">    2349 </span><span class="lineCov">       4396 :   calib-&gt;SetModuleIndex(idet);</span>
<span class="lineNum">    2350 </span>            :   AliITSCalibration *calibSPDdead = 0;
<span class="lineNum">    2351 </span><span class="lineCov">       4876 :   if(detType==0) calibSPDdead = (AliITSCalibration*)detTypeRec-&gt;GetSPDDeadModel(idet); // TEMPORARY</span>
<span class="lineNum">    2352 </span><span class="lineCov">       4876 :   if (calib-&gt;IsBad() ||</span>
<span class="lineNum">    2353 </span><span class="lineCov">       4744 :       (detType==0 &amp;&amp; calibSPDdead-&gt;IsBad())) // TEMPORARY</span>
<span class="lineNum">    2354 </span>            :     {
<span class="lineNum">    2355 </span><span class="lineCov">        180 :       SetBad();</span>
<span class="lineNum">    2356 </span>            :       //      printf(&quot;lay %d bad %d\n&quot;,ilayer,idet);
<span class="lineNum">    2357 </span><span class="lineCov">        180 :     }</span>
<span class="lineNum">    2358 </span>            : 
<span class="lineNum">    2359 </span>            :   // Get segmentation from AliITSDetTypeRec
<span class="lineNum">    2360 </span><span class="lineCov">       4396 :   AliITSsegmentation *segm = (AliITSsegmentation*)detTypeRec-&gt;GetSegmentationModel(detType);</span>
<span class="lineNum">    2361 </span>            : 
<span class="lineNum">    2362 </span>            :   // Read info about bad chips
<span class="lineNum">    2363 </span><span class="lineCov">       4396 :   fNChips = segm-&gt;GetMaximumChipIndex()+1;</span>
<span class="lineNum">    2364 </span>            :   //printf(&quot;ilayer %d  detType %d idet %d fNChips %d %d  GetNumberOfChips %d\n&quot;,ilayer,detType,idet,fNChips,segm-&gt;GetMaximumChipIndex(),segm-&gt;GetNumberOfChips());
<span class="lineNum">    2365 </span><span class="lineCov">       4396 :   if(fChipIsBad) { delete [] fChipIsBad; fChipIsBad=NULL; }</span>
<span class="lineNum">    2366 </span><span class="lineCov">       4396 :   fChipIsBad = new Bool_t[fNChips];</span>
<span class="lineNum">    2367 </span><span class="lineCov">     103416 :   for (Int_t iCh=0;iCh&lt;fNChips;iCh++) {</span>
<span class="lineNum">    2368 </span><span class="lineCov">      47312 :     fChipIsBad[iCh] = calib-&gt;IsChipBad(iCh);</span>
<span class="lineNum">    2369 </span><span class="lineCov">      49952 :     if (detType==0 &amp;&amp; calibSPDdead-&gt;IsChipBad(iCh)) fChipIsBad[iCh] = kTRUE; // TEMPORARY</span>
<span class="lineNum">    2370 </span>            :     //if(fChipIsBad[iCh]) {printf(&quot;lay %d det %d bad chip %d\n&quot;,ilayer,idet,iCh);}
<span class="lineNum">    2371 </span>            :   }
<span class="lineNum">    2372 </span>            : 
<span class="lineNum">    2373 </span>            :   return;
<a name="2374"><span class="lineNum">    2374 </span><span class="lineCov">       4396 : }</span></a>
<span class="lineNum">    2375 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2376 </span>            : Double_t AliITStrackerMI::GetEffectiveThickness()
<span class="lineNum">    2377 </span>            : {
<span class="lineNum">    2378 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2379 </span>            :   // Returns the thickness between the current layer and the vertex (units X0)
<span class="lineNum">    2380 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2381 </span>            : 
<span class="lineNum">    2382 </span><span class="lineCov">       5460 :   if(fUseTGeo!=0) {</span>
<span class="lineNum">    2383 </span><span class="lineCov">       2734 :     if(fxOverX0Layer[0]&lt;0) BuildMaterialLUT(&quot;Layers&quot;);</span>
<span class="lineNum">    2384 </span><span class="lineCov">       2734 :     if(fxOverX0Shield[0]&lt;0) BuildMaterialLUT(&quot;Shields&quot;);</span>
<span class="lineNum">    2385 </span><span class="lineCov">       2734 :     if(fxOverX0Pipe&lt;0) BuildMaterialLUT(&quot;Pipe&quot;);</span>
<span class="lineNum">    2386 </span>            :   }
<span class="lineNum">    2387 </span>            : 
<span class="lineNum">    2388 </span>            :   // beam pipe
<span class="lineNum">    2389 </span><span class="lineCov">       8190 :   Double_t dPipe = (fUseTGeo==0 ? AliITSRecoParam::GetdPipe() : fxOverX0Pipe);</span>
<span class="lineNum">    2390 </span><span class="lineCov">       2730 :   Double_t d=dPipe*AliITSRecoParam::GetrPipe()*AliITSRecoParam::GetrPipe();</span>
<span class="lineNum">    2391 </span>            : 
<span class="lineNum">    2392 </span>            :   // layers
<span class="lineNum">    2393 </span><span class="lineCov">       2730 :   Double_t x0=0;</span>
<span class="lineNum">    2394 </span><span class="lineCov">       2730 :   Double_t xn=fgLayers[fI].GetR();</span>
<span class="lineNum">    2395 </span><span class="lineCov">      16384 :   for (Int_t i=0; i&lt;fI; i++) {</span>
<span class="lineNum">    2396 </span><span class="lineCov">       5462 :     Double_t xi=fgLayers[i].GetR();</span>
<span class="lineNum">    2397 </span><span class="lineCov">      16386 :     Double_t dLayer = (fUseTGeo==0 ? fgLayers[i].GetThickness(0,0,x0) : fxOverX0Layer[i]);</span>
<span class="lineNum">    2398 </span><span class="lineCov">       5462 :     d+=dLayer*xi*xi;</span>
<span class="lineNum">    2399 </span>            :   }
<span class="lineNum">    2400 </span>            : 
<span class="lineNum">    2401 </span>            :   // shields
<span class="lineNum">    2402 </span><span class="lineCov">       2730 :   if (fI&gt;1) {</span>
<span class="lineNum">    2403 </span><span class="lineCov">       4602 :     Double_t dshieldSPD = (fUseTGeo==0 ? AliITSRecoParam::Getdshield(0) : fxOverX0Shield[0]);</span>
<span class="lineNum">    2404 </span><span class="lineCov">       1534 :     d+=dshieldSPD*AliITSRecoParam::GetrInsideShield(0)*AliITSRecoParam::GetrInsideShield(0);</span>
<span class="lineNum">    2405 </span><span class="lineCov">       1534 :   }</span>
<span class="lineNum">    2406 </span><span class="lineCov">       2730 :   if (fI&gt;3) {</span>
<span class="lineNum">    2407 </span><span class="lineCov">       1752 :     Double_t dshieldSDD = (fUseTGeo==0 ? AliITSRecoParam::Getdshield(1) : fxOverX0Shield[1]);</span>
<span class="lineNum">    2408 </span><span class="lineCov">        584 :     d+=dshieldSDD*AliITSRecoParam::GetrInsideShield(1)*AliITSRecoParam::GetrInsideShield(1);</span>
<span class="lineNum">    2409 </span><span class="lineCov">        584 :   }</span>
<span class="lineNum">    2410 </span><span class="lineCov">       5460 :   return d/(xn*xn);</span>
<span class="lineNum">    2411 </span><span class="lineCov">       2730 : }</span>
<a name="2412"><span class="lineNum">    2412 </span>            : </a>
<span class="lineNum">    2413 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2414 </span>            : Int_t AliITStrackerMI::GetEffectiveThicknessLbyL(Double_t* xMS, Double_t* x2x0MS)
<span class="lineNum">    2415 </span>            : {
<span class="lineNum">    2416 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2417 </span>            :   // Returns the array of layers between the current layer and the vertex
<span class="lineNum">    2418 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2419 </span>            :   //
<span class="lineNum">    2420 </span><span class="lineNoCov">          0 :   if(fUseTGeo!=0) {</span>
<span class="lineNum">    2421 </span><span class="lineNoCov">          0 :     if(fxOverX0Layer[0]&lt;0) BuildMaterialLUT(&quot;Layers&quot;);</span>
<span class="lineNum">    2422 </span><span class="lineNoCov">          0 :     if(fxOverX0Shield[0]&lt;0) BuildMaterialLUT(&quot;Shields&quot;);</span>
<span class="lineNum">    2423 </span><span class="lineNoCov">          0 :     if(fxOverX0Pipe&lt;0) BuildMaterialLUT(&quot;Pipe&quot;);</span>
<span class="lineNum">    2424 </span>            :   }
<span class="lineNum">    2425 </span>            : 
<span class="lineNum">    2426 </span>            :   int nl = 0;
<span class="lineNum">    2427 </span><span class="lineNoCov">          0 :   double x0 = 0;</span>
<span class="lineNum">    2428 </span><span class="lineNoCov">          0 :   for (int il=fI;il--;) {</span>
<span class="lineNum">    2429 </span>            :     //
<span class="lineNum">    2430 </span><span class="lineNoCov">          0 :     if (il==3) {</span>
<span class="lineNum">    2431 </span><span class="lineNoCov">          0 :       x2x0MS[nl] = (fUseTGeo==0 ? AliITSRecoParam::Getdshield(1) : fxOverX0Shield[1]);</span>
<span class="lineNum">    2432 </span><span class="lineNoCov">          0 :       xMS[nl++]  = AliITSRecoParam::GetrInsideShield(1);</span>
<span class="lineNum">    2433 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2434 </span><span class="lineNoCov">          0 :     else if (il==1) {</span>
<span class="lineNum">    2435 </span><span class="lineNoCov">          0 :       x2x0MS[nl] = (fUseTGeo==0 ? AliITSRecoParam::Getdshield(0) : fxOverX0Shield[0]);</span>
<span class="lineNum">    2436 </span><span class="lineNoCov">          0 :       xMS[nl++]  = AliITSRecoParam::GetrInsideShield(0);</span>
<span class="lineNum">    2437 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2438 </span>            :     //
<span class="lineNum">    2439 </span><span class="lineNoCov">          0 :     x2x0MS[nl] = (fUseTGeo==0 ? fgLayers[il].GetThickness(0,0,x0) : fxOverX0Layer[il]);</span>
<span class="lineNum">    2440 </span><span class="lineNoCov">          0 :     xMS[nl++]  = fgLayers[il].GetR();</span>
<span class="lineNum">    2441 </span>            :     //
<span class="lineNum">    2442 </span>            :   }
<span class="lineNum">    2443 </span>            :   //
<span class="lineNum">    2444 </span>            :   // beam pipe
<span class="lineNum">    2445 </span><span class="lineNoCov">          0 :   x2x0MS[nl]  = (fUseTGeo==0 ? AliITSRecoParam::GetdPipe() : fxOverX0Pipe);</span>
<span class="lineNum">    2446 </span><span class="lineNoCov">          0 :   xMS[nl++]  = AliITSRecoParam::GetrPipe();</span>
<span class="lineNum">    2447 </span>            :   //
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :   return nl;</span>
<span class="lineNum">    2449 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2450 </span>            : 
<a name="2451"><span class="lineNum">    2451 </span>            : </a>
<span class="lineNum">    2452 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2453 </span>            : Int_t AliITStrackerMI::AliITSlayer::InRoad() const {
<span class="lineNum">    2454 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    2455 </span>            :   // This function returns number of clusters within the &quot;window&quot; 
<span class="lineNum">    2456 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2457 </span>            :   Int_t ncl=0;
<span class="lineNum">    2458 </span><span class="lineNoCov">          0 :   for (Int_t i=fI; i&lt;fN; i++) {</span>
<span class="lineNum">    2459 </span><span class="lineNoCov">          0 :     const AliITSRecPoint *c=fClusters[i];</span>
<span class="lineNum">    2460 </span><span class="lineNoCov">          0 :     if (c-&gt;GetZ() &gt; fZmax) break;</span>
<span class="lineNum">    2461 </span><span class="lineNoCov">          0 :     if (c-&gt;IsUsed()) continue;</span>
<span class="lineNum">    2462 </span><span class="lineNoCov">          0 :     const AliITSdetector &amp;det=GetDetector(c-&gt;GetDetectorIndex());    </span>
<span class="lineNum">    2463 </span><span class="lineNoCov">          0 :     Double_t y=fR*det.GetPhi() + c-&gt;GetY();</span>
<span class="lineNum">    2464 </span>            : 
<span class="lineNum">    2465 </span><span class="lineNoCov">          0 :     if (y&gt;2.*fR*TMath::Pi()) y -= 2*fR*TMath::Pi();</span>
<span class="lineNum">    2466 </span><span class="lineNoCov">          0 :     if (y&gt;1.*fR*TMath::Pi() &amp;&amp; fYmax&lt;y) y -= 2*fR*TMath::Pi();</span>
<span class="lineNum">    2467 </span>            : 
<span class="lineNum">    2468 </span><span class="lineNoCov">          0 :     if (y&lt;fYmin) continue;</span>
<span class="lineNum">    2469 </span><span class="lineNoCov">          0 :     if (y&gt;fYmax) continue;</span>
<span class="lineNum">    2470 </span><span class="lineNoCov">          0 :     ncl++;</span>
<span class="lineNum">    2471 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2472 </span><span class="lineNoCov">          0 :   return ncl;</span>
<a name="2473"><span class="lineNum">    2473 </span>            : }</a>
<span class="lineNum">    2474 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2475 </span>            : Bool_t AliITStrackerMI::RefitAt(Double_t xx,AliITStrackMI *track,
<span class="lineNum">    2476 </span>            :                                 const AliITStrackMI *clusters,Bool_t extra, Bool_t planeeff) 
<span class="lineNum">    2477 </span>            : {
<span class="lineNum">    2478 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2479 </span>            :   // This function refits the track &quot;track&quot; at the position &quot;x&quot; using
<span class="lineNum">    2480 </span>            :   // the clusters from &quot;clusters&quot;
<span class="lineNum">    2481 </span>            :   // If &quot;extra&quot;==kTRUE, 
<span class="lineNum">    2482 </span>            :   //    the clusters from overlapped modules get attached to &quot;track&quot; 
<span class="lineNum">    2483 </span>            :   // If &quot;planeff&quot;==kTRUE,
<span class="lineNum">    2484 </span>            :   //    special approach for plane efficiency evaluation is applyed
<span class="lineNum">    2485 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2486 </span>            : 
<span class="lineNum">    2487 </span><span class="lineCov">       1970 :   Int_t index[AliITSgeomTGeo::kNLayers]={0};</span>
<span class="lineNum">    2488 </span>            :   Int_t k;
<span class="lineNum">    2489 </span><span class="lineCov">      27580 :   for (k=0; k&lt;AliITSgeomTGeo::GetNLayers(); k++) index[k]=-1;</span>
<span class="lineNum">    2490 </span><span class="lineCov">       1970 :   Int_t nc=clusters-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    2491 </span><span class="lineCov">      22872 :   for (k=0; k&lt;nc; k++) { </span>
<span class="lineNum">    2492 </span><span class="lineCov">       9466 :     Int_t idx=clusters-&gt;GetClusterIndex(k);</span>
<span class="lineNum">    2493 </span><span class="lineCov">       9466 :     Int_t ilayer=(idx&amp;0xf0000000)&gt;&gt;28;</span>
<span class="lineNum">    2494 </span><span class="lineCov">       9466 :     index[ilayer]=idx; </span>
<span class="lineNum">    2495 </span>            :   }
<span class="lineNum">    2496 </span>            : 
<span class="lineNum">    2497 </span><span class="lineCov">       3940 :   return RefitAt(xx,track,index,extra,planeeff); // call the method below</span>
<a name="2498"><span class="lineNum">    2498 </span><span class="lineCov">       1970 : }</span></a>
<span class="lineNum">    2499 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2500 </span>            : Bool_t AliITStrackerMI::RefitAt(Double_t xx,AliITStrackMI *track,
<span class="lineNum">    2501 </span>            :                                 const Int_t *clusters,Bool_t extra, Bool_t planeeff) 
<span class="lineNum">    2502 </span>            : {
<span class="lineNum">    2503 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2504 </span>            :   // This function refits the track &quot;track&quot; at the position &quot;x&quot; using
<span class="lineNum">    2505 </span>            :   // the clusters from array
<span class="lineNum">    2506 </span>            :   // If &quot;extra&quot;==kTRUE, 
<span class="lineNum">    2507 </span>            :   //    the clusters from overlapped modules get attached to &quot;track&quot; 
<span class="lineNum">    2508 </span>            :   // If &quot;planeff&quot;==kTRUE,
<span class="lineNum">    2509 </span>            :   //    special approach for plane efficiency evaluation is applyed
<span class="lineNum">    2510 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2511 </span><span class="lineCov">       1978 :   Int_t index[AliITSgeomTGeo::kNLayers]={0};</span>
<span class="lineNum">    2512 </span>            :   Int_t k;
<span class="lineNum">    2513 </span><span class="lineCov">      27692 :   for (k=0; k&lt;AliITSgeomTGeo::GetNLayers(); k++) index[k]=-1;</span>
<span class="lineNum">    2514 </span>            :   //
<span class="lineNum">    2515 </span><span class="lineCov">      27692 :   for (k=0; k&lt;AliITSgeomTGeo::GetNLayers(); k++) { </span>
<span class="lineNum">    2516 </span><span class="lineCov">      11868 :     index[k]=clusters[k]; </span>
<span class="lineNum">    2517 </span>            :   }
<span class="lineNum">    2518 </span>            : 
<span class="lineNum">    2519 </span>            :   // special for cosmics and TPC prolonged tracks: 
<span class="lineNum">    2520 </span>            :   // propagate to the innermost of:
<span class="lineNum">    2521 </span>            :   // - innermost layer crossed by the track
<span class="lineNum">    2522 </span>            :   // - innermost layer where a cluster was associated to the track
<span class="lineNum">    2523 </span>            :   static AliITSRecoParam *repa = NULL;
<span class="lineNum">    2524 </span><span class="lineCov">       1978 :   if(!repa){</span>
<span class="lineNum">    2525 </span><span class="lineCov">          2 :     repa = (AliITSRecoParam*) AliITSReconstructor::GetRecoParam();</span>
<span class="lineNum">    2526 </span><span class="lineCov">          2 :     if(!repa){</span>
<span class="lineNum">    2527 </span><span class="lineNoCov">          0 :       repa = AliITSRecoParam::GetHighFluxParam();</span>
<span class="lineNum">    2528 </span><span class="lineNoCov">          0 :       AliWarning(&quot;Using default AliITSRecoParam class&quot;);</span>
<span class="lineNum">    2529 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2530 </span>            :   }
<span class="lineNum">    2531 </span><span class="lineCov">       1978 :   Int_t evsp=repa-&gt;GetEventSpecie();</span>
<span class="lineNum">    2532 </span>            :   ULong_t trStatus=0;
<span class="lineNum">    2533 </span><span class="lineCov">       3920 :   if(track-&gt;GetESDtrack()) trStatus=track-&gt;GetStatus();</span>
<span class="lineNum">    2534 </span>            :   Int_t innermostlayer=0;
<span class="lineNum">    2535 </span><span class="lineCov">       3956 :   if((evsp&amp;AliRecoParam::kCosmic) || (trStatus&amp;AliESDtrack::kTPCin))  {</span>
<span class="lineNum">    2536 </span>            :     innermostlayer=5;
<span class="lineNum">    2537 </span><span class="lineCov">       1910 :     Double_t drphi = TMath::Abs(track-&gt;GetD(0.,0.));</span>
<span class="lineNum">    2538 </span><span class="lineCov">       3896 :     for(innermostlayer=0; innermostlayer&lt;AliITSgeomTGeo::GetNLayers(); innermostlayer++) {</span>
<span class="lineNum">    2539 </span><span class="lineCov">       1986 :       if( (drphi &lt; (fgLayers[innermostlayer].GetR()+1.)) ||</span>
<span class="lineNum">    2540 </span><span class="lineCov">         38 :           index[innermostlayer] &gt;= 0 ) break;</span>
<span class="lineNum">    2541 </span>            :     }
<span class="lineNum">    2542 </span>            : 
<span class="lineNum">    2543 </span><span class="lineCov">       5730 :     AliDebug(2,Form(&quot; drphi  %f  innermost %d&quot;,drphi,innermostlayer));</span>
<span class="lineNum">    2544 </span><span class="lineCov">       1910 :   }</span>
<span class="lineNum">    2545 </span>            : 
<span class="lineNum">    2546 </span>            :   Int_t modstatus=1; // found
<span class="lineNum">    2547 </span><span class="lineCov">       1978 :   Float_t xloc,zloc;</span>
<span class="lineNum">    2548 </span>            :   Int_t from, to, step;
<span class="lineNum">    2549 </span><span class="lineCov">       1978 :   if (xx &gt; track-&gt;GetX()) {</span>
<span class="lineNum">    2550 </span><span class="lineCov">        986 :       from=innermostlayer; to=AliITSgeomTGeo::GetNLayers();</span>
<span class="lineNum">    2551 </span>            :       step=+1;
<span class="lineNum">    2552 </span><span class="lineCov">        986 :   } else {</span>
<span class="lineNum">    2553 </span><span class="lineCov">        992 :       from=AliITSgeomTGeo::GetNLayers()-1; to=innermostlayer-1;</span>
<span class="lineNum">    2554 </span>            :       step=-1;
<span class="lineNum">    2555 </span>            :   }
<span class="lineNum">    2556 </span><span class="lineCov">       1978 :   TString dir = (step&gt;0 ? &quot;outward&quot; : &quot;inward&quot;);</span>
<span class="lineNum">    2557 </span>            : 
<span class="lineNum">    2558 </span><span class="lineCov">      28437 :   for (Int_t ilayer = from; ilayer != to; ilayer += step) {</span>
<span class="lineNum">    2559 </span><span class="lineCov">      11718 :      AliITSlayer &amp;layer=fgLayers[ilayer];</span>
<span class="lineNum">    2560 </span><span class="lineCov">      11718 :      Double_t r=layer.GetR();</span>
<span class="lineNum">    2561 </span>            : 
<span class="lineNum">    2562 </span><span class="lineCov">      17846 :      if (step&lt;0 &amp;&amp; xx&gt;r) break;</span>
<span class="lineNum">    2563 </span>            : 
<span class="lineNum">    2564 </span>            :      // material between SSD and SDD, SDD and SPD
<span class="lineNum">    2565 </span><span class="lineCov">      11408 :      Double_t hI=ilayer-0.5*step; </span>
<span class="lineNum">    2566 </span><span class="lineCov">      11408 :      if (TMath::Abs(hI-3.5)&lt;0.01) // SDDouter</span>
<span class="lineNum">    2567 </span><span class="lineCov">       7896 :        if(!CorrectForShieldMaterial(track,&quot;SDD&quot;,dir)) return kFALSE;</span>
<span class="lineNum">    2568 </span><span class="lineCov">      11408 :      if (TMath::Abs(hI-1.5)&lt;0.01) // SPDouter</span>
<span class="lineNum">    2569 </span><span class="lineCov">       7448 :        if(!CorrectForShieldMaterial(track,&quot;SPD&quot;,dir)) return kFALSE;</span>
<span class="lineNum">    2570 </span>            : 
<span class="lineNum">    2571 </span>            : 
<span class="lineNum">    2572 </span><span class="lineCov">      11408 :      Double_t oldGlobXYZ[3]={0};</span>
<span class="lineNum">    2573 </span><span class="lineCov">      22816 :      if (!track-&gt;GetXYZ(oldGlobXYZ)) return kFALSE;</span>
<span class="lineNum">    2574 </span>            : 
<span class="lineNum">    2575 </span>            :      // continue if we are already beyond this layer
<span class="lineNum">    2576 </span><span class="lineCov">      11408 :      Double_t oldGlobR = TMath::Sqrt(oldGlobXYZ[0]*oldGlobXYZ[0]+oldGlobXYZ[1]*oldGlobXYZ[1]);</span>
<span class="lineNum">    2577 </span><span class="lineCov">      17616 :      if(step&gt;0 &amp;&amp; oldGlobR &gt; r) continue; // going outward</span>
<span class="lineNum">    2578 </span><span class="lineCov">      16608 :      if(step&lt;0 &amp;&amp; oldGlobR &lt; r) continue; // going inward</span>
<span class="lineNum">    2579 </span>            : 
<span class="lineNum">    2580 </span><span class="lineCov">      11100 :      Double_t phi,z;</span>
<span class="lineNum">    2581 </span><span class="lineCov">      22200 :      if (!track-&gt;GetPhiZat(r,phi,z)) return kFALSE;</span>
<span class="lineNum">    2582 </span>            : 
<span class="lineNum">    2583 </span><span class="lineCov">      11100 :      Int_t idet=layer.FindDetectorIndex(phi,z);</span>
<span class="lineNum">    2584 </span>            : 
<span class="lineNum">    2585 </span>            :      // check if we allow a prolongation without point for large-eta tracks
<span class="lineNum">    2586 </span><span class="lineCov">      11100 :      Int_t skip = CheckSkipLayer(track,ilayer,idet);</span>
<span class="lineNum">    2587 </span><span class="lineCov">      11100 :      if (skip==2) {</span>
<span class="lineNum">    2588 </span>            :        modstatus = 4; // out in z
<span class="lineNum">    2589 </span><span class="lineNoCov">          0 :        if(LocalModuleCoord(ilayer,idet,track,xloc,zloc)) { // local module coords</span>
<span class="lineNum">    2590 </span><span class="lineNoCov">          0 :          track-&gt;SetModuleIndexInfo(ilayer,idet,modstatus,xloc,zloc);</span>
<span class="lineNum">    2591 </span>            :        }
<span class="lineNum">    2592 </span>            :        // cross layer
<span class="lineNum">    2593 </span>            :        // apply correction for material of the current layer
<span class="lineNum">    2594 </span>            :        // add time if going outward
<span class="lineNum">    2595 </span><span class="lineNoCov">          0 :        CorrectForLayerMaterial(track,ilayer,oldGlobXYZ,dir);</span>
<span class="lineNum">    2596 </span><span class="lineNoCov">          0 :        continue;</span>
<span class="lineNum">    2597 </span>            :      }
<span class="lineNum">    2598 </span>            : 
<span class="lineNum">    2599 </span><span class="lineCov">      11100 :      if (idet&lt;0) return kFALSE;</span>
<span class="lineNum">    2600 </span>            : 
<span class="lineNum">    2601 </span>            : 
<span class="lineNum">    2602 </span><span class="lineCov">      11100 :      const AliITSdetector &amp;det=layer.GetDetector(idet);</span>
<span class="lineNum">    2603 </span>            :      // only for ITS-SA tracks refit
<span class="lineNum">    2604 </span>            :      Bool_t saveCheckInv = kTRUE;
<span class="lineNum">    2605 </span><span class="lineCov">      27740 :      if (ilayer&gt;1 &amp;&amp; fTrackingPhase.Contains(&quot;RefitInward&quot;) &amp;&amp; !(track-&gt;GetStatus()&amp;AliESDtrack::kTPCin)) {</span>
<span class="lineNum">    2606 </span><span class="lineCov">         64 :        saveCheckInv = track-&gt;GetCheckInvariant();</span>
<span class="lineNum">    2607 </span><span class="lineCov">         64 :        track-&gt;SetCheckInvariant(kFALSE);</span>
<span class="lineNum">    2608 </span><span class="lineCov">         64 :      }</span>
<span class="lineNum">    2609 </span>            :      // 
<span class="lineNum">    2610 </span><span class="lineCov">      22200 :      if (!track-&gt;Propagate(det.GetPhi(),det.GetR())) return kFALSE;</span>
<span class="lineNum">    2611 </span>            : 
<span class="lineNum">    2612 </span><span class="lineCov">      11100 :      track-&gt;SetDetectorIndex(idet);</span>
<span class="lineNum">    2613 </span><span class="lineCov">      22200 :      if(!LocalModuleCoord(ilayer,idet,track,xloc,zloc)) return kFALSE; // local module coords</span>
<span class="lineNum">    2614 </span>            : 
<span class="lineNum">    2615 </span><span class="lineCov">      11100 :      Double_t dz,zmin,zmax,dy,ymin,ymax;</span>
<span class="lineNum">    2616 </span>            : 
<span class="lineNum">    2617 </span>            :      const AliITSRecPoint *clAcc=0;
<span class="lineNum">    2618 </span><span class="lineCov">      22200 :      Double_t maxchi2=1000.*AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2();</span>
<span class="lineNum">    2619 </span>            : 
<span class="lineNum">    2620 </span><span class="lineCov">      11100 :      Int_t idx=index[ilayer];</span>
<span class="lineNum">    2621 </span><span class="lineCov">      11100 :      if (idx&gt;=0) { // cluster in this layer</span>
<span class="lineNum">    2622 </span>            :        modstatus = 6; // no refit
<span class="lineNum">    2623 </span><span class="lineCov">      18980 :        const AliITSRecPoint *cl=(AliITSRecPoint *)GetCluster(idx); </span>
<span class="lineNum">    2624 </span><span class="lineCov">       9490 :        if (cl) {</span>
<span class="lineNum">    2625 </span><span class="lineCov">       9490 :          if (idet != cl-&gt;GetDetectorIndex()) {</span>
<span class="lineNum">    2626 </span><span class="lineCov">       1430 :            idet=cl-&gt;GetDetectorIndex();</span>
<span class="lineNum">    2627 </span><span class="lineCov">       1430 :            const AliITSdetector &amp;detc=layer.GetDetector(idet);</span>
<span class="lineNum">    2628 </span><span class="lineCov">       2860 :            if (!track-&gt;Propagate(detc.GetPhi(),detc.GetR())) return kFALSE;</span>
<span class="lineNum">    2629 </span><span class="lineCov">       1430 :            track-&gt;SetDetectorIndex(idet);</span>
<span class="lineNum">    2630 </span><span class="lineCov">       2860 :            if(!LocalModuleCoord(ilayer,idet,track,xloc,zloc)) return kFALSE; // local module coords</span>
<span class="lineNum">    2631 </span><span class="lineCov">       1430 :          }</span>
<span class="lineNum">    2632 </span><span class="lineCov">       9490 :          Int_t cllayer = (idx &amp; 0xf0000000) &gt;&gt; 28;;</span>
<span class="lineNum">    2633 </span><span class="lineCov">       9490 :          Double_t chi2=GetPredictedChi2MI(track,cl,cllayer);</span>
<span class="lineNum">    2634 </span><span class="lineCov">       9490 :          if (chi2&lt;maxchi2) { </span>
<span class="lineNum">    2635 </span>            :            clAcc=cl; 
<span class="lineNum">    2636 </span>            :            maxchi2=chi2; 
<span class="lineNum">    2637 </span>            :            modstatus = 1; // found
<span class="lineNum">    2638 </span>            :          } else {
<span class="lineNum">    2639 </span><span class="lineNoCov">          0 :             return kFALSE; //</span>
<span class="lineNum">    2640 </span>            :          }
<span class="lineNum">    2641 </span><span class="lineCov">       9490 :        }</span>
<span class="lineNum">    2642 </span><span class="lineCov">       9490 :      } else { // no cluster in this layer</span>
<span class="lineNum">    2643 </span><span class="lineCov">       1610 :        if (skip==1) {</span>
<span class="lineNum">    2644 </span>            :          modstatus = 3; // skipped
<span class="lineNum">    2645 </span>            :          // Plane Eff determination:
<span class="lineNum">    2646 </span><span class="lineNoCov">          0 :          if (planeeff &amp;&amp; ilayer==AliITSReconstructor::GetRecoParam()-&gt;GetIPlanePlaneEff()) {</span>
<span class="lineNum">    2647 </span><span class="lineNoCov">          0 :            if (IsOKForPlaneEff(track,clusters,ilayer))  // only adequate track for plane eff. evaluation</span>
<span class="lineNum">    2648 </span><span class="lineNoCov">          0 :               UseTrackForPlaneEff(track,ilayer);</span>
<span class="lineNum">    2649 </span>            :          }
<span class="lineNum">    2650 </span>            :        } else {
<span class="lineNum">    2651 </span>            :          modstatus = 5; // no cls in road
<span class="lineNum">    2652 </span>            :          // check dead
<span class="lineNum">    2653 </span><span class="lineCov">       3220 :          if (!ComputeRoad(track,ilayer,idet,zmin,zmax,ymin,ymax)) return kFALSE;</span>
<span class="lineNum">    2654 </span><span class="lineCov">       1610 :          dz = 0.5*(zmax-zmin);</span>
<span class="lineNum">    2655 </span><span class="lineCov">       1610 :          dy = 0.5*(ymax-ymin);</span>
<span class="lineNum">    2656 </span><span class="lineCov">       1610 :          Int_t dead = CheckDeadZone(track,ilayer,idet,dz,dy,kTRUE);</span>
<span class="lineNum">    2657 </span><span class="lineCov">       2362 :          if (dead==1) modstatus = 7; // holes in z in SPD</span>
<span class="lineNum">    2658 </span><span class="lineCov">       1962 :          if (dead==2 || dead==3 || dead==4) modstatus = 2; // dead from OCDB</span>
<span class="lineNum">    2659 </span>            :        }
<span class="lineNum">    2660 </span>            :      }
<span class="lineNum">    2661 </span>            :      
<span class="lineNum">    2662 </span><span class="lineCov">      11100 :      if (clAcc) {</span>
<span class="lineNum">    2663 </span><span class="lineCov">      18980 :        if (!UpdateMI(track,clAcc,maxchi2,idx)) return kFALSE;</span>
<span class="lineNum">    2664 </span><span class="lineCov">       9490 :        track-&gt;SetSampledEdx(clAcc-&gt;GetQ(),ilayer-2);</span>
<span class="lineNum">    2665 </span>            :      }
<span class="lineNum">    2666 </span><span class="lineCov">      11100 :      track-&gt;SetModuleIndexInfo(ilayer,idet,modstatus,xloc,zloc);</span>
<span class="lineNum">    2667 </span>            : 
<span class="lineNum">    2668 </span>            : 
<span class="lineNum">    2669 </span><span class="lineCov">      11100 :      if (extra &amp;&amp; clAcc) { // search for extra clusters in overlapped modules</span>
<span class="lineNum">    2670 </span><span class="lineCov">        514 :        AliITStrackV2 tmp(*track);</span>
<span class="lineNum">    2671 </span><span class="lineCov">       1028 :        if (!ComputeRoad(track,ilayer,idet,zmin,zmax,ymin,ymax)) return kFALSE;</span>
<span class="lineNum">    2672 </span><span class="lineCov">        514 :        layer.SelectClusters(zmin,zmax,ymin,ymax);</span>
<span class="lineNum">    2673 </span>            :        
<span class="lineNum">    2674 </span><span class="lineCov">        514 :        const AliITSRecPoint *clExtra=0; Int_t ci=-1,cci=-1;</span>
<span class="lineNum">    2675 </span>            :        Int_t idetExtra=-1;  
<span class="lineNum">    2676 </span><span class="lineCov">       1028 :        maxchi2=1000.*AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2();</span>
<span class="lineNum">    2677 </span>            :        Double_t tolerance=0.1;
<span class="lineNum">    2678 </span><span class="lineCov">       2746 :        while ((clExtra=layer.GetNextCluster(ci))!=0) {</span>
<span class="lineNum">    2679 </span>            :          // only clusters in another module! (overlaps)
<span class="lineNum">    2680 </span><span class="lineCov">        602 :          idetExtra = clExtra-&gt;GetDetectorIndex();</span>
<span class="lineNum">    2681 </span><span class="lineCov">        602 :          if (idet == idetExtra) continue;</span>
<span class="lineNum">    2682 </span>            :          
<span class="lineNum">    2683 </span><span class="lineCov">         68 :          const AliITSdetector &amp;detx=layer.GetDetector(idetExtra);</span>
<span class="lineNum">    2684 </span>            :          
<span class="lineNum">    2685 </span><span class="lineCov">        136 :          if (!tmp.Propagate(detx.GetPhi(),detx.GetR()+clExtra-&gt;GetX())) continue;</span>
<span class="lineNum">    2686 </span><span class="lineCov">        184 :          if (TMath::Abs(tmp.GetZ() - clExtra-&gt;GetZ()) &gt; tolerance) continue;</span>
<span class="lineNum">    2687 </span><span class="lineCov">         40 :          if (TMath::Abs(tmp.GetY() - clExtra-&gt;GetY()) &gt; tolerance) continue;</span>
<span class="lineNum">    2688 </span><span class="lineCov">         40 :          if (!tmp.Propagate(detx.GetPhi(),detx.GetR())) continue;</span>
<span class="lineNum">    2689 </span>            :          
<span class="lineNum">    2690 </span><span class="lineCov">         20 :          Double_t chi2=tmp.GetPredictedChi2(clExtra);</span>
<span class="lineNum">    2691 </span><span class="lineCov">         40 :          if (chi2&lt;maxchi2) { maxchi2=chi2; cci=ci; }</span>
<span class="lineNum">    2692 </span><span class="lineCov">         20 :        }</span>
<span class="lineNum">    2693 </span><span class="lineCov">        514 :        if (cci&gt;=0) {</span>
<span class="lineNum">    2694 </span><span class="lineCov">         20 :          track-&gt;SetExtraCluster(ilayer,(ilayer&lt;&lt;28)+cci);</span>
<span class="lineNum">    2695 </span><span class="lineCov">         20 :          track-&gt;SetExtraModule(ilayer,idetExtra);</span>
<span class="lineNum">    2696 </span><span class="lineCov">         20 :        }</span>
<span class="lineNum">    2697 </span><span class="lineCov">       1028 :      } // end search for extra clusters in overlapped modules</span>
<span class="lineNum">    2698 </span>            :      
<span class="lineNum">    2699 </span>            :      // Correct for material of the current layer
<span class="lineNum">    2700 </span>            :      // cross material
<span class="lineNum">    2701 </span>            :      // add time if going outward
<span class="lineNum">    2702 </span><span class="lineCov">      33301 :      if(!CorrectForLayerMaterial(track,ilayer,oldGlobXYZ,dir)) return kFALSE;</span>
<span class="lineNum">    2703 </span><span class="lineCov">      11099 :      track-&gt;SetCheckInvariant(saveCheckInv);</span>
<span class="lineNum">    2704 </span><span class="lineCov">      44707 :   } // end loop on layers</span>
<span class="lineNum">    2705 </span>            : 
<span class="lineNum">    2706 </span><span class="lineCov">       3955 :   if (!track-&gt;PropagateTo(xx,0.,0.)) return kFALSE;</span>
<span class="lineNum">    2707 </span>            : 
<span class="lineNum">    2708 </span><span class="lineCov">       1976 :   return kTRUE;</span>
<a name="2709"><span class="lineNum">    2709 </span><span class="lineCov">       1978 : }</span></a>
<span class="lineNum">    2710 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2711 </span>            : Double_t AliITStrackerMI::GetNormalizedChi2(AliITStrackMI * track, Int_t mode)
<span class="lineNum">    2712 </span>            : {
<span class="lineNum">    2713 </span>            :   //
<span class="lineNum">    2714 </span>            :   // calculate normalized chi2
<span class="lineNum">    2715 </span>            :   //  return NormalizedChi2(track,0);
<span class="lineNum">    2716 </span>            :   Float_t chi2 = 0;
<span class="lineNum">    2717 </span>            :   Float_t sum=0;
<span class="lineNum">    2718 </span><span class="lineCov">      10636 :   Float_t *erry = GetErrY(fCurrentEsdTrack), *errz = GetErrZ(fCurrentEsdTrack);</span>
<span class="lineNum">    2719 </span>            :   //  track-&gt;fdEdxMismatch=0;
<span class="lineNum">    2720 </span>            :   Float_t dedxmismatch =0;
<span class="lineNum">    2721 </span><span class="lineCov">       5318 :   Float_t *ny = GetNy(fCurrentEsdTrack), *nz = GetNz(fCurrentEsdTrack); </span>
<span class="lineNum">    2722 </span><span class="lineCov">       5318 :   if (mode&lt;100){</span>
<span class="lineNum">    2723 </span><span class="lineCov">      74452 :     for (Int_t i = 0;i&lt;6;i++){</span>
<span class="lineNum">    2724 </span><span class="lineCov">      31908 :       if (track-&gt;GetClIndex(i)&gt;=0){</span>
<span class="lineNum">    2725 </span>            :         Float_t cerry, cerrz;
<span class="lineNum">    2726 </span><span class="lineCov">      50706 :         if (ny[i]&gt;0) {cerry = erry[i]; cerrz=errz[i];}</span>
<span class="lineNum">    2727 </span>            :         else 
<span class="lineNum">    2728 </span><span class="lineCov">         74 :           { cerry= track-&gt;GetSigmaY(i); cerrz = track-&gt;GetSigmaZ(i);}</span>
<span class="lineNum">    2729 </span><span class="lineCov">      25390 :         cerry*=cerry;</span>
<span class="lineNum">    2730 </span><span class="lineCov">      25390 :         cerrz*=cerrz;   </span>
<span class="lineNum">    2731 </span><span class="lineCov">      25390 :         Float_t cchi2 = (track-&gt;GetDy(i)*track-&gt;GetDy(i)/cerry)+(track-&gt;GetDz(i)*track-&gt;GetDz(i)/cerrz);</span>
<span class="lineNum">    2732 </span><span class="lineCov">      45498 :         if (i&gt;1 &amp;&amp; AliITSReconstructor::GetRecoParam()-&gt;GetUseAmplitudeInfo(i)) {</span>
<span class="lineNum">    2733 </span><span class="lineCov">      20108 :           Float_t ratio = track-&gt;GetNormQ(i)/track-&gt;GetExpQ();</span>
<span class="lineNum">    2734 </span><span class="lineCov">      20108 :           if (ratio&lt;0.5) {</span>
<span class="lineNum">    2735 </span><span class="lineNoCov">          0 :             cchi2+=(0.5-ratio)*10.;</span>
<span class="lineNum">    2736 </span>            :             //track-&gt;fdEdxMismatch+=(0.5-ratio)*10.;
<span class="lineNum">    2737 </span><span class="lineNoCov">          0 :             dedxmismatch+=(0.5-ratio)*10.;          </span>
<span class="lineNum">    2738 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    2739 </span><span class="lineCov">      20108 :         }</span>
<span class="lineNum">    2740 </span><span class="lineCov">      25390 :         if (i&lt;2 ||i&gt;3){</span>
<span class="lineNum">    2741 </span><span class="lineCov">      15190 :           AliITSRecPoint * cl = (AliITSRecPoint*)GetCluster( track-&gt;GetClIndex(i));  </span>
<span class="lineNum">    2742 </span><span class="lineCov">      15190 :           Double_t delta = cl-&gt;GetNy()+cl-&gt;GetNz()-ny[i]-nz[i];</span>
<span class="lineNum">    2743 </span><span class="lineCov">      15680 :           if (delta&gt;1) chi2 +=0.5*TMath::Min(delta/2,2.); </span>
<span class="lineNum">    2744 </span><span class="lineCov">      20472 :           if (i&lt;2) chi2+=2*cl-&gt;GetDeltaProbability();</span>
<span class="lineNum">    2745 </span><span class="lineCov">      15190 :         }</span>
<span class="lineNum">    2746 </span><span class="lineCov">      25390 :         chi2+=cchi2;</span>
<span class="lineNum">    2747 </span><span class="lineCov">      25390 :         sum++;</span>
<span class="lineNum">    2748 </span><span class="lineCov">      25390 :       }</span>
<span class="lineNum">    2749 </span>            :     }
<span class="lineNum">    2750 </span><span class="lineCov">       5318 :     if (TMath::Abs(track-&gt;GetdEdxMismatch()-dedxmismatch)&gt;0.0001){</span>
<span class="lineNum">    2751 </span><span class="lineNoCov">          0 :       track-&gt;SetdEdxMismatch(dedxmismatch);</span>
<span class="lineNum">    2752 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2753 </span>            :   }
<span class="lineNum">    2754 </span>            :   else{
<span class="lineNum">    2755 </span><span class="lineNoCov">          0 :     for (Int_t i = 0;i&lt;4;i++){</span>
<span class="lineNum">    2756 </span><span class="lineNoCov">          0 :       if (track-&gt;GetClIndex(i)&gt;=0){</span>
<span class="lineNum">    2757 </span>            :         Float_t cerry, cerrz;
<span class="lineNum">    2758 </span><span class="lineNoCov">          0 :         if (ny[i]&gt;0) {cerry = erry[i]; cerrz=errz[i];}</span>
<span class="lineNum">    2759 </span><span class="lineNoCov">          0 :         else { cerry= track-&gt;GetSigmaY(i); cerrz = track-&gt;GetSigmaZ(i);}</span>
<span class="lineNum">    2760 </span><span class="lineNoCov">          0 :         cerry*=cerry;</span>
<span class="lineNum">    2761 </span><span class="lineNoCov">          0 :         cerrz*=cerrz;</span>
<span class="lineNum">    2762 </span><span class="lineNoCov">          0 :         chi2+= (track-&gt;GetDy(i)*track-&gt;GetDy(i)/cerry);</span>
<span class="lineNum">    2763 </span><span class="lineNoCov">          0 :         chi2+= (track-&gt;GetDz(i)*track-&gt;GetDz(i)/cerrz);      </span>
<span class="lineNum">    2764 </span><span class="lineNoCov">          0 :         sum++;</span>
<span class="lineNum">    2765 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    2766 </span>            :     }
<span class="lineNum">    2767 </span><span class="lineNoCov">          0 :     for (Int_t i = 4;i&lt;6;i++){</span>
<span class="lineNum">    2768 </span><span class="lineNoCov">          0 :       if (track-&gt;GetClIndex(i)&gt;=0){       </span>
<span class="lineNum">    2769 </span>            :         Float_t cerry, cerrz;
<span class="lineNum">    2770 </span><span class="lineNoCov">          0 :         if (ny[i]&gt;0) {cerry = erry[i]; cerrz=errz[i];}</span>
<span class="lineNum">    2771 </span><span class="lineNoCov">          0 :         else { cerry= track-&gt;GetSigmaY(i); cerrz = track-&gt;GetSigmaZ(i);}</span>
<span class="lineNum">    2772 </span><span class="lineNoCov">          0 :         cerry*=cerry;</span>
<span class="lineNum">    2773 </span><span class="lineNoCov">          0 :         cerrz*=cerrz;   </span>
<span class="lineNum">    2774 </span>            :         Float_t cerryb, cerrzb;
<span class="lineNum">    2775 </span><span class="lineNoCov">          0 :         if (ny[i+6]&gt;0) {cerryb = erry[i+6]; cerrzb=errz[i+6];}</span>
<span class="lineNum">    2776 </span><span class="lineNoCov">          0 :         else { cerryb= track-&gt;GetSigmaY(i+6); cerrzb = track-&gt;GetSigmaZ(i+6);}</span>
<span class="lineNum">    2777 </span><span class="lineNoCov">          0 :         cerryb*=cerryb;</span>
<span class="lineNum">    2778 </span><span class="lineNoCov">          0 :         cerrzb*=cerrzb;</span>
<span class="lineNum">    2779 </span><span class="lineNoCov">          0 :         chi2+= TMath::Min((track-&gt;GetDy(i+6)*track-&gt;GetDy(i+6)/cerryb),track-&gt;GetDy(i)*track-&gt;GetDy(i)/cerry);</span>
<span class="lineNum">    2780 </span><span class="lineNoCov">          0 :         chi2+= TMath::Min((track-&gt;GetDz(i+6)*track-&gt;GetDz(i+6)/cerrzb),track-&gt;GetDz(i)*track-&gt;GetDz(i)/cerrz);      </span>
<span class="lineNum">    2781 </span><span class="lineNoCov">          0 :         sum++;</span>
<span class="lineNum">    2782 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    2783 </span>            :     }
<span class="lineNum">    2784 </span>            :   }
<span class="lineNum">    2785 </span><span class="lineCov">       5318 :   if (track-&gt;GetESDtrack()-&gt;GetTPCsignal()&gt;85){</span>
<span class="lineNum">    2786 </span><span class="lineNoCov">          0 :     Float_t ratio = track-&gt;GetdEdx()/track-&gt;GetESDtrack()-&gt;GetTPCsignal();</span>
<span class="lineNum">    2787 </span><span class="lineNoCov">          0 :     if (ratio&lt;0.5) {</span>
<span class="lineNum">    2788 </span><span class="lineNoCov">          0 :       chi2+=(0.5-ratio)*5.;      </span>
<span class="lineNum">    2789 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2790 </span><span class="lineNoCov">          0 :     if (ratio&gt;2){</span>
<span class="lineNum">    2791 </span><span class="lineNoCov">          0 :       chi2+=(ratio-2.0)*3; </span>
<span class="lineNum">    2792 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2793 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2794 </span>            :   //
<span class="lineNum">    2795 </span><span class="lineCov">       5318 :   Double_t match = TMath::Sqrt(track-&gt;GetChi22());</span>
<span class="lineNum">    2796 </span><span class="lineCov">       8724 :   if (track-&gt;GetConstrain())  match/=track-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    2797 </span><span class="lineCov">       5318 :   if (!track-&gt;GetConstrain()) { </span>
<span class="lineNum">    2798 </span><span class="lineCov">       1912 :     if (track-&gt;GetNumberOfClusters()&gt;2) {</span>
<span class="lineNum">    2799 </span><span class="lineCov">       1912 :       match/=track-&gt;GetNumberOfClusters()-2.;</span>
<span class="lineNum">    2800 </span><span class="lineCov">       1912 :     } else {</span>
<span class="lineNum">    2801 </span>            :       match=0;
<span class="lineNum">    2802 </span>            :     }
<span class="lineNum">    2803 </span>            :   }
<span class="lineNum">    2804 </span><span class="lineCov">       5318 :   if (match&lt;0) match=0;</span>
<span class="lineNum">    2805 </span>            : 
<span class="lineNum">    2806 </span>            :   // penalty factor for missing points (NDeadZone&gt;0), but no penalty
<span class="lineNum">    2807 </span>            :   // for layer with deadZoneProb close to 1 (either we wanted to skip layer
<span class="lineNum">    2808 </span>            :   // or there is a dead from OCDB)
<span class="lineNum">    2809 </span>            :   Float_t deadzonefactor = 0.; 
<span class="lineNum">    2810 </span><span class="lineCov">       5318 :   if (track-&gt;GetNDeadZone()&gt;0.) {    </span>
<span class="lineNum">    2811 </span>            :     Int_t sumDeadZoneProbability=0; 
<span class="lineNum">    2812 </span><span class="lineCov">      35420 :     for(Int_t ilay=0;ilay&lt;6;ilay++) {</span>
<span class="lineNum">    2813 </span><span class="lineCov">      17508 :       if(track-&gt;GetDeadZoneProbability(ilay)&gt;0.) sumDeadZoneProbability++;</span>
<span class="lineNum">    2814 </span>            :     }
<span class="lineNum">    2815 </span><span class="lineCov">       2530 :     Int_t nDeadZoneWithProbNot1=(Int_t)(track-&gt;GetNDeadZone())-sumDeadZoneProbability;</span>
<span class="lineNum">    2816 </span><span class="lineCov">       2530 :     if(nDeadZoneWithProbNot1&gt;0) {</span>
<span class="lineNum">    2817 </span><span class="lineCov">        272 :       Float_t deadZoneProbability = track-&gt;GetNDeadZone()-(Float_t)sumDeadZoneProbability;</span>
<span class="lineNum">    2818 </span><span class="lineCov">        816 :       AliDebug(2,Form(&quot;nDeadZone %f sumDZProbability %d nDZWithProbNot1 %d deadZoneProb %f\n&quot;,track-&gt;GetNDeadZone(),sumDeadZoneProbability,nDeadZoneWithProbNot1,deadZoneProbability));</span>
<span class="lineNum">    2819 </span><span class="lineCov">        272 :       deadZoneProbability /= (Float_t)nDeadZoneWithProbNot1;</span>
<span class="lineNum">    2820 </span>            :       Float_t one = 1.;
<span class="lineNum">    2821 </span><span class="lineCov">        272 :       deadZoneProbability = TMath::Min(deadZoneProbability,one);</span>
<span class="lineNum">    2822 </span><span class="lineCov">        272 :       deadzonefactor = 3.*(1.1-deadZoneProbability);  </span>
<span class="lineNum">    2823 </span><span class="lineCov">        272 :     }</span>
<span class="lineNum">    2824 </span><span class="lineCov">       2530 :   }  </span>
<span class="lineNum">    2825 </span>            : 
<span class="lineNum">    2826 </span><span class="lineCov">      10636 :   Double_t normchi2 = 2*track-&gt;GetNSkipped()+match+deadzonefactor+(1+(2*track-&gt;GetNSkipped()+deadzonefactor)/track-&gt;GetNumberOfClusters())*</span>
<span class="lineNum">    2827 </span><span class="lineCov">      10636 :     (chi2)/TMath::Max(double(sum-track-&gt;GetNSkipped()),</span>
<span class="lineNum">    2828 </span><span class="lineCov">       5318 :                                 1./(1.+track-&gt;GetNSkipped()));     </span>
<span class="lineNum">    2829 </span><span class="lineCov">      15954 :   AliDebug(2,Form(&quot;match %f deadzonefactor %f chi2 %f sum %f skipped %f\n&quot;,match,deadzonefactor,chi2,sum,track-&gt;GetNSkipped()));</span>
<span class="lineNum">    2830 </span><span class="lineCov">      15954 :   AliDebug(2,Form(&quot;NormChi2 %f  cls %d\n&quot;,normchi2,track-&gt;GetNumberOfClusters()));</span>
<span class="lineNum">    2831 </span><span class="lineCov">       5318 :   return normchi2;</span>
<a name="2832"><span class="lineNum">    2832 </span>            : }</a>
<span class="lineNum">    2833 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2834 </span>            : Double_t AliITStrackerMI::GetMatchingChi2(const AliITStrackMI * track1,const AliITStrackMI * track2)
<span class="lineNum">    2835 </span>            : {
<span class="lineNum">    2836 </span>            :   //
<span class="lineNum">    2837 </span>            :   // return matching chi2 between two tracks
<span class="lineNum">    2838 </span>            :   Double_t largeChi2=1000.;
<span class="lineNum">    2839 </span>            : 
<span class="lineNum">    2840 </span><span class="lineCov">       1740 :   AliITStrackMI track3(*track2);</span>
<span class="lineNum">    2841 </span><span class="lineCov">       3480 :   if (!track3.Propagate(track1-&gt;GetAlpha(),track1-&gt;GetX())) return largeChi2;</span>
<span class="lineNum">    2842 </span><span class="lineCov">        870 :   TMatrixD vec(5,1);</span>
<span class="lineNum">    2843 </span><span class="lineCov">       3480 :   vec(0,0)=track1-&gt;GetY()   - track3.GetY();</span>
<span class="lineNum">    2844 </span><span class="lineCov">       3480 :   vec(1,0)=track1-&gt;GetZ()   - track3.GetZ();</span>
<span class="lineNum">    2845 </span><span class="lineCov">       3480 :   vec(2,0)=track1-&gt;GetSnp() - track3.GetSnp();</span>
<span class="lineNum">    2846 </span><span class="lineCov">       3480 :   vec(3,0)=track1-&gt;GetTgl() - track3.GetTgl();</span>
<span class="lineNum">    2847 </span><span class="lineCov">       3480 :   vec(4,0)=track1-&gt;GetSigned1Pt() - track3.GetSigned1Pt();</span>
<span class="lineNum">    2848 </span>            :   //
<span class="lineNum">    2849 </span><span class="lineCov">        870 :   TMatrixD cov(5,5);</span>
<span class="lineNum">    2850 </span><span class="lineCov">       1740 :   cov(0,0) = track1-&gt;GetSigmaY2()+track3.GetSigmaY2();</span>
<span class="lineNum">    2851 </span><span class="lineCov">       1740 :   cov(1,1) = track1-&gt;GetSigmaZ2()+track3.GetSigmaZ2();</span>
<span class="lineNum">    2852 </span><span class="lineCov">       3480 :   cov(2,2) = track1-&gt;GetSigmaSnp2()+track3.GetSigmaSnp2();</span>
<span class="lineNum">    2853 </span><span class="lineCov">       1740 :   cov(3,3) = track1-&gt;GetSigmaTgl2()+track3.GetSigmaTgl2();</span>
<span class="lineNum">    2854 </span><span class="lineCov">       1740 :   cov(4,4) = track1-&gt;GetSigma1Pt2()+track3.GetSigma1Pt2();</span>
<span class="lineNum">    2855 </span>            :   
<span class="lineNum">    2856 </span><span class="lineCov">       2610 :   cov(0,1)=cov(1,0) = track1-&gt;GetSigmaZY()+track3.GetSigmaZY();</span>
<span class="lineNum">    2857 </span><span class="lineCov">       2610 :   cov(0,2)=cov(2,0) = track1-&gt;GetSigmaSnpY()+track3.GetSigmaSnpY();</span>
<span class="lineNum">    2858 </span><span class="lineCov">       2610 :   cov(0,3)=cov(3,0) = track1-&gt;GetSigmaTglY()+track3.GetSigmaTglY();</span>
<span class="lineNum">    2859 </span><span class="lineCov">       2610 :   cov(0,4)=cov(4,0) = track1-&gt;GetSigma1PtY()+track3.GetSigma1PtY();</span>
<span class="lineNum">    2860 </span>            :   //
<span class="lineNum">    2861 </span><span class="lineCov">       2610 :   cov(1,2)=cov(2,1) = track1-&gt;GetSigmaSnpZ()+track3.GetSigmaSnpZ();</span>
<span class="lineNum">    2862 </span><span class="lineCov">       2610 :   cov(1,3)=cov(3,1) = track1-&gt;GetSigmaTglZ()+track3.GetSigmaTglZ();</span>
<span class="lineNum">    2863 </span><span class="lineCov">       2610 :   cov(1,4)=cov(4,1) = track1-&gt;GetSigma1PtZ()+track3.GetSigma1PtZ();</span>
<span class="lineNum">    2864 </span>            :   //
<span class="lineNum">    2865 </span><span class="lineCov">       2610 :   cov(2,3)=cov(3,2) = track1-&gt;GetSigmaTglSnp()+track3.GetSigmaTglSnp();</span>
<span class="lineNum">    2866 </span><span class="lineCov">       2610 :   cov(2,4)=cov(4,2) = track1-&gt;GetSigma1PtSnp()+track3.GetSigma1PtSnp();</span>
<span class="lineNum">    2867 </span>            :   //
<span class="lineNum">    2868 </span><span class="lineCov">       2610 :   cov(3,4)=cov(4,3) = track1-&gt;GetSigma1PtTgl()+track3.GetSigma1PtTgl();</span>
<span class="lineNum">    2869 </span>            :   
<span class="lineNum">    2870 </span><span class="lineCov">        870 :   cov.Invert();</span>
<span class="lineNum">    2871 </span><span class="lineCov">        870 :   TMatrixD vec2(cov,TMatrixD::kMult,vec);</span>
<span class="lineNum">    2872 </span><span class="lineCov">        870 :   TMatrixD chi2(vec2,TMatrixD::kTransposeMult,vec);</span>
<span class="lineNum">    2873 </span><span class="lineCov">       1740 :   return chi2(0,0);</span>
<a name="2874"><span class="lineNum">    2874 </span><span class="lineCov">       1740 : }</span></a>
<span class="lineNum">    2875 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2876 </span>            : Double_t  AliITStrackerMI::GetSPDDeadZoneProbability(Double_t zpos, Double_t zerr) const
<span class="lineNum">    2877 </span>            : {
<span class="lineNum">    2878 </span>            :   //
<span class="lineNum">    2879 </span>            :   //  return probability that given point (characterized by z position and error) 
<span class="lineNum">    2880 </span>            :   //  is in SPD dead zone
<span class="lineNum">    2881 </span>            :   //     This method assumes that fSPDdetzcentre is ordered from -z to +z
<span class="lineNum">    2882 </span>            :   //
<span class="lineNum">    2883 </span>            :   Double_t probability = 0.;
<span class="lineNum">    2884 </span>            :   Double_t nearestz = 0.,distz=0.;
<span class="lineNum">    2885 </span>            :   Int_t    nearestzone = -1;
<span class="lineNum">    2886 </span>            :   Double_t mindistz = 1000.;
<span class="lineNum">    2887 </span>            : 
<span class="lineNum">    2888 </span>            :   // find closest dead zone
<span class="lineNum">    2889 </span><span class="lineCov">      15570 :   for (Int_t i=0; i&lt;3; i++) {</span>
<span class="lineNum">    2890 </span><span class="lineCov">       5190 :     distz=TMath::Abs(zpos-0.5*(fSPDdetzcentre[i]+fSPDdetzcentre[i+1]));</span>
<span class="lineNum">    2891 </span><span class="lineCov">       5190 :     if (distz&lt;mindistz) {</span>
<span class="lineNum">    2892 </span>            :       nearestzone=i;
<span class="lineNum">    2893 </span><span class="lineCov">       3460 :       nearestz=0.5*(fSPDdetzcentre[i]+fSPDdetzcentre[i+1]);</span>
<span class="lineNum">    2894 </span>            :       mindistz=distz;
<span class="lineNum">    2895 </span><span class="lineCov">       3460 :     }</span>
<span class="lineNum">    2896 </span>            :   }
<span class="lineNum">    2897 </span>            : 
<span class="lineNum">    2898 </span>            :   // too far from dead zone
<span class="lineNum">    2899 </span><span class="lineCov">       1852 :   if (TMath::Abs(zpos-nearestz)&gt;0.25+3.*zerr) return probability;</span>
<span class="lineNum">    2900 </span>            : 
<span class="lineNum">    2901 </span>            : 
<span class="lineNum">    2902 </span>            :   Double_t zmin, zmax;   
<span class="lineNum">    2903 </span><span class="lineCov">       1608 :   if (nearestzone==0) { // dead zone at z = -7</span>
<span class="lineNum">    2904 </span><span class="lineNoCov">          0 :     zmin = fSPDdetzcentre[0] + 0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">    2905 </span><span class="lineNoCov">          0 :     zmax = fSPDdetzcentre[1] - 0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">    2906 </span><span class="lineCov">       1608 :   } else if (nearestzone==1) { // dead zone at z = 0</span>
<span class="lineNum">    2907 </span><span class="lineCov">       1608 :     zmin = fSPDdetzcentre[1] + 0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">    2908 </span><span class="lineCov">       1608 :     zmax = fSPDdetzcentre[2] - 0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">    2909 </span><span class="lineCov">       1608 :   } else if (nearestzone==2) { // dead zone at z = +7</span>
<span class="lineNum">    2910 </span><span class="lineNoCov">          0 :     zmin = fSPDdetzcentre[2] + 0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">    2911 </span><span class="lineNoCov">          0 :     zmax = fSPDdetzcentre[3] - 0.5*AliITSRecoParam::GetSPDdetzlength();</span>
<span class="lineNum">    2912 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    2913 </span>            :     zmin = 0.;
<span class="lineNum">    2914 </span>            :     zmax = 0.;
<span class="lineNum">    2915 </span>            :   }
<span class="lineNum">    2916 </span>            :   // probability that the true z is in the range [zmin,zmax] (i.e. inside 
<span class="lineNum">    2917 </span>            :   // dead zone)
<span class="lineNum">    2918 </span><span class="lineCov">       3216 :   probability = 0.5*( AliMathBase::ErfFast((zpos-zmin)/zerr/TMath::Sqrt(2.)) - </span>
<span class="lineNum">    2919 </span><span class="lineCov">       1608 :                       AliMathBase::ErfFast((zpos-zmax)/zerr/TMath::Sqrt(2.)) );</span>
<span class="lineNum">    2920 </span><span class="lineCov">       4824 :   AliDebug(2,Form(&quot;zpos %f +- %f nearestzone %d  zmin zmax %f %f prob %f\n&quot;,zpos,zerr,nearestzone,zmin,zmax,probability));</span>
<span class="lineNum">    2921 </span>            :   return probability;
<a name="2922"><span class="lineNum">    2922 </span><span class="lineCov">       1730 : }</span></a>
<span class="lineNum">    2923 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2924 </span>            : Double_t AliITStrackerMI::GetTruncatedChi2(const AliITStrackMI * track, Float_t fac)
<span class="lineNum">    2925 </span>            : {
<span class="lineNum">    2926 </span>            :   //
<span class="lineNum">    2927 </span>            :   // calculate normalized chi2
<span class="lineNum">    2928 </span><span class="lineNoCov">          0 :   Float_t chi2[6]={0};</span>
<span class="lineNum">    2929 </span><span class="lineNoCov">          0 :   Float_t *erry = GetErrY(fCurrentEsdTrack), *errz = GetErrZ(fCurrentEsdTrack);</span>
<span class="lineNum">    2930 </span>            :   Float_t ncl = 0;
<span class="lineNum">    2931 </span><span class="lineNoCov">          0 :   for (Int_t i = 0;i&lt;6;i++){</span>
<span class="lineNum">    2932 </span><span class="lineNoCov">          0 :     if (TMath::Abs(track-&gt;GetDy(i))&gt;0){      </span>
<span class="lineNum">    2933 </span><span class="lineNoCov">          0 :       chi2[i]= (track-&gt;GetDy(i)/erry[i])*(track-&gt;GetDy(i)/erry[i]);</span>
<span class="lineNum">    2934 </span><span class="lineNoCov">          0 :       chi2[i]+= (track-&gt;GetDz(i)/errz[i])*(track-&gt;GetDz(i)/errz[i]);</span>
<span class="lineNum">    2935 </span><span class="lineNoCov">          0 :       ncl++;</span>
<span class="lineNum">    2936 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2937 </span><span class="lineNoCov">          0 :     else{chi2[i]=10000;}</span>
<span class="lineNum">    2938 </span>            :   }
<span class="lineNum">    2939 </span><span class="lineNoCov">          0 :   Int_t index[6]={0};</span>
<span class="lineNum">    2940 </span><span class="lineNoCov">          0 :   TMath::Sort(6,chi2,index,kFALSE);</span>
<span class="lineNum">    2941 </span><span class="lineNoCov">          0 :   Float_t max = float(ncl)*fac-1.;</span>
<span class="lineNum">    2942 </span>            :   Float_t sumchi=0, sumweight=0; 
<span class="lineNum">    2943 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;max+1;i++){</span>
<span class="lineNum">    2944 </span><span class="lineNoCov">          0 :     Float_t weight = (i&lt;max)?1.:(max+1.-i);</span>
<span class="lineNum">    2945 </span><span class="lineNoCov">          0 :     sumchi+=weight*chi2[index[i]];</span>
<span class="lineNum">    2946 </span><span class="lineNoCov">          0 :     sumweight+=weight;</span>
<span class="lineNum">    2947 </span>            :   }
<span class="lineNum">    2948 </span><span class="lineNoCov">          0 :   Double_t normchi2 = sumchi/sumweight;</span>
<span class="lineNum">    2949 </span><span class="lineNoCov">          0 :   return normchi2;</span>
<a name="2950"><span class="lineNum">    2950 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2951 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2952 </span>            : Double_t AliITStrackerMI::GetInterpolatedChi2(const AliITStrackMI * forwardtrack,const AliITStrackMI * backtrack)
<span class="lineNum">    2953 </span>            : {
<span class="lineNum">    2954 </span>            :   //
<span class="lineNum">    2955 </span>            :   // calculate normalized chi2
<span class="lineNum">    2956 </span>            :   //  if (forwardtrack-&gt;fNUsed&gt;0.3*float(forwardtrack-&gt;GetNumberOfClusters())) return 10000;
<span class="lineNum">    2957 </span>            :   Int_t npoints = 0;
<span class="lineNum">    2958 </span>            :   Double_t res =0;
<span class="lineNum">    2959 </span><span class="lineCov">      13020 :   for (Int_t i=0;i&lt;6;i++){</span>
<span class="lineNum">    2960 </span><span class="lineCov">       9538 :     if ( (backtrack-&gt;GetSigmaY(i)&lt;0.000000001) || (forwardtrack-&gt;GetSigmaY(i)&lt;0.000000001)) continue;</span>
<span class="lineNum">    2961 </span><span class="lineCov">       4116 :     Double_t sy1 = forwardtrack-&gt;GetSigmaY(i);</span>
<span class="lineNum">    2962 </span><span class="lineCov">       4116 :     Double_t sz1 = forwardtrack-&gt;GetSigmaZ(i);</span>
<span class="lineNum">    2963 </span><span class="lineCov">       4116 :     Double_t sy2 = backtrack-&gt;GetSigmaY(i);</span>
<span class="lineNum">    2964 </span><span class="lineCov">       4116 :     Double_t sz2 = backtrack-&gt;GetSigmaZ(i);</span>
<span class="lineNum">    2965 </span><span class="lineCov">       4942 :     if (i&lt;2){ sy2=1000.;sz2=1000;}</span>
<span class="lineNum">    2966 </span>            :     //    
<span class="lineNum">    2967 </span><span class="lineCov">       4116 :     Double_t dy0 = (forwardtrack-&gt;GetDy(i)/(sy1*sy1) +backtrack-&gt;GetDy(i)/(sy2*sy2))/(1./(sy1*sy1)+1./(sy2*sy2));</span>
<span class="lineNum">    2968 </span><span class="lineCov">       4116 :     Double_t dz0 = (forwardtrack-&gt;GetDz(i)/(sz1*sz1) +backtrack-&gt;GetDz(i)/(sz2*sz2))/(1./(sz1*sz1)+1./(sz2*sz2));</span>
<span class="lineNum">    2969 </span>            :     // 
<span class="lineNum">    2970 </span><span class="lineCov">       4116 :     Double_t nz0 = dz0*TMath::Sqrt((1./(sz1*sz1)+1./(sz2*sz2)));</span>
<span class="lineNum">    2971 </span><span class="lineCov">       4116 :     Double_t ny0 = dy0*TMath::Sqrt((1./(sy1*sy1)+1./(sy2*sy2)));</span>
<span class="lineNum">    2972 </span>            :     //
<span class="lineNum">    2973 </span><span class="lineCov">       4116 :     res+= nz0*nz0+ny0*ny0;</span>
<span class="lineNum">    2974 </span><span class="lineCov">       4116 :     npoints++;</span>
<span class="lineNum">    2975 </span><span class="lineCov">       4116 :   }</span>
<span class="lineNum">    2976 </span><span class="lineCov">       1736 :   if (npoints&gt;1) return </span>
<span class="lineNum">    2977 </span><span class="lineCov">       1736 :                    TMath::Max(0.3*forwardtrack-&gt;OneOverPt()-0.5,0.)+</span>
<span class="lineNum">    2978 </span>            :                    //2*forwardtrack-&gt;fNUsed+
<span class="lineNum">    2979 </span><span class="lineCov">       1736 :                    res/TMath::Max(double(npoints-forwardtrack-&gt;GetNSkipped()),</span>
<span class="lineNum">    2980 </span><span class="lineCov">        868 :                                   1./(1.+forwardtrack-&gt;GetNSkipped()));</span>
<span class="lineNum">    2981 </span><span class="lineNoCov">          0 :   return 1000;</span>
<span class="lineNum">    2982 </span><span class="lineCov">        868 : }</span>
<span class="lineNum">    2983 </span>            : /*
<span class="lineNum">    2984 </span>            :   RS: Not used
<span class="lineNum">    2985 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2986 </span>            : Float_t  *AliITStrackerMI::GetWeight(Int_t index) {
<span class="lineNum">    2987 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2988 </span>            :   //       Return pointer to a given cluster
<span class="lineNum">    2989 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2990 </span>            :   Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;
<span class="lineNum">    2991 </span>            :   Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;
<span class="lineNum">    2992 </span>            :   return fgLayers[l].GetWeight(c);
<span class="lineNum">    2993 </span>            : }
<span class="lineNum">    2994 </span>            : */
<a name="2995"><span class="lineNum">    2995 </span>            : </a>
<span class="lineNum">    2996 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    2997 </span>            : void AliITStrackerMI::RegisterClusterTracks(const AliITStrackMI* track,Int_t id)
<span class="lineNum">    2998 </span>            : {
<span class="lineNum">    2999 </span>            :   //---------------------------------------------
<span class="lineNum">    3000 </span>            :   // register track to the list
<span class="lineNum">    3001 </span>            :   //
<span class="lineNum">    3002 </span><span class="lineCov">        512 :   if (track-&gt;GetESDtrack()-&gt;GetKinkIndex(0)!=0) return;  //don't register kink tracks</span>
<span class="lineNum">    3003 </span>            :   //
<span class="lineNum">    3004 </span>            :   //
<span class="lineNum">    3005 </span><span class="lineCov">       2960 :   for (Int_t icluster=0;icluster&lt;track-&gt;GetNumberOfClusters();icluster++){</span>
<span class="lineNum">    3006 </span><span class="lineCov">       1224 :     Int_t index = track-&gt;GetClusterIndex(icluster);</span>
<span class="lineNum">    3007 </span><span class="lineCov">       1224 :     Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">    3008 </span><span class="lineCov">       1224 :     Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">    3009 </span><span class="lineCov">       1224 :     if (c&gt;fgLayers[l].GetNumberOfClusters()) continue;</span>
<span class="lineNum">    3010 </span><span class="lineCov">       3304 :     for (Int_t itrack=0;itrack&lt;4;itrack++){</span>
<span class="lineNum">    3011 </span><span class="lineCov">       1652 :       if (fgLayers[l].GetClusterTracks(itrack,c)&lt;0){</span>
<span class="lineNum">    3012 </span><span class="lineCov">       1224 :         fgLayers[l].SetClusterTracks(itrack,c,id);</span>
<span class="lineNum">    3013 </span><span class="lineCov">       1224 :         break;</span>
<span class="lineNum">    3014 </span>            :       }
<span class="lineNum">    3015 </span>            :     }
<span class="lineNum">    3016 </span><span class="lineCov">       1224 :   }</span>
<a name="3017"><span class="lineNum">    3017 </span><span class="lineCov">        256 : }</span></a>
<span class="lineNum">    3018 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3019 </span>            : void AliITStrackerMI::UnRegisterClusterTracks(const AliITStrackMI* track, Int_t id)
<span class="lineNum">    3020 </span>            : {
<span class="lineNum">    3021 </span>            :   //---------------------------------------------
<span class="lineNum">    3022 </span>            :   // unregister track from the list
<span class="lineNum">    3023 </span><span class="lineCov">       2218 :   for (Int_t icluster=0;icluster&lt;track-&gt;GetNumberOfClusters();icluster++){</span>
<span class="lineNum">    3024 </span><span class="lineCov">        812 :     Int_t index = track-&gt;GetClusterIndex(icluster);</span>
<span class="lineNum">    3025 </span><span class="lineCov">        812 :     Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">    3026 </span><span class="lineCov">        812 :     Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">    3027 </span><span class="lineCov">        812 :     if (c&gt;fgLayers[l].GetNumberOfClusters()) continue;</span>
<span class="lineNum">    3028 </span><span class="lineCov">       8120 :     for (Int_t itrack=0;itrack&lt;4;itrack++){</span>
<span class="lineNum">    3029 </span><span class="lineCov">       3248 :       if (fgLayers[l].GetClusterTracks(itrack,c)==id){</span>
<span class="lineNum">    3030 </span><span class="lineCov">        464 :         fgLayers[l].SetClusterTracks(itrack,c,-1);</span>
<span class="lineNum">    3031 </span><span class="lineCov">        464 :       }</span>
<span class="lineNum">    3032 </span>            :     }
<span class="lineNum">    3033 </span><span class="lineCov">        812 :   }</span>
<a name="3034"><span class="lineNum">    3034 </span><span class="lineCov">        198 : }</span></a>
<span class="lineNum">    3035 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3036 </span>            : Float_t AliITStrackerMI::GetNumberOfSharedClusters(AliITStrackMI* track,Int_t id, Int_t list[6], AliITSRecPoint *clist[6])
<span class="lineNum">    3037 </span>            : {
<span class="lineNum">    3038 </span>            :   //-------------------------------------------------------------
<span class="lineNum">    3039 </span>            :   //get number of shared clusters
<span class="lineNum">    3040 </span>            :   //-------------------------------------------------------------
<span class="lineNum">    3041 </span>            :   Float_t shared=0;
<span class="lineNum">    3042 </span><span class="lineCov">      19620 :   for (Int_t i=0;i&lt;6;i++) { list[i]=-1, clist[i]=0;}</span>
<span class="lineNum">    3043 </span>            :   // mean  number of clusters
<span class="lineNum">    3044 </span><span class="lineCov">       1308 :   Float_t *ny = GetNy(id), *nz = GetNz(id); </span>
<span class="lineNum">    3045 </span>            : 
<span class="lineNum">    3046 </span>            :  
<span class="lineNum">    3047 </span><span class="lineCov">      15180 :   for (Int_t icluster=0;icluster&lt;track-&gt;GetNumberOfClusters();icluster++){</span>
<span class="lineNum">    3048 </span><span class="lineCov">       6282 :     Int_t index = track-&gt;GetClusterIndex(icluster);</span>
<span class="lineNum">    3049 </span><span class="lineCov">       6282 :     Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">    3050 </span><span class="lineCov">       6282 :     Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">    3051 </span><span class="lineCov">       6282 :     if (c&gt;fgLayers[l].GetNumberOfClusters()) continue;</span>
<span class="lineNum">    3052 </span>            :     // if (ny[l]&lt;1.e-13){
<span class="lineNum">    3053 </span>            :     //   printf(&quot;problem\n&quot;);
<span class="lineNum">    3054 </span>            :     // }
<span class="lineNum">    3055 </span><span class="lineCov">       6282 :     AliITSRecPoint *cl = (AliITSRecPoint*)GetCluster(index);</span>
<span class="lineNum">    3056 </span>            :     Float_t weight=1;
<span class="lineNum">    3057 </span>            :     //
<span class="lineNum">    3058 </span>            :     Float_t deltan = 0;
<span class="lineNum">    3059 </span><span class="lineCov">       8818 :     if (l&gt;3&amp;&amp;cl-&gt;GetNy()+cl-&gt;GetNz()&gt;6) continue;</span>
<span class="lineNum">    3060 </span><span class="lineCov">       9954 :     if (l&gt;2&amp;&amp;AliITSReconstructor::GetRecoParam()-&gt;GetUseAmplitudeInfo(l))</span>
<span class="lineNum">    3061 </span><span class="lineCov">       5353 :       if (track-&gt;GetNormQ(l)/track-&gt;GetExpQ()&gt;3.5) continue;</span>
<span class="lineNum">    3062 </span><span class="lineCov">       4601 :     if (l&lt;2 || l&gt;3){      </span>
<span class="lineNum">    3063 </span><span class="lineCov">       2638 :       deltan = (cl-&gt;GetNy()+cl-&gt;GetNz()-ny[l]-nz[l]);</span>
<span class="lineNum">    3064 </span><span class="lineCov">       2638 :     }</span>
<span class="lineNum">    3065 </span>            :     else{
<span class="lineNum">    3066 </span><span class="lineCov">       1963 :       deltan = (cl-&gt;GetNz()-nz[l]);</span>
<span class="lineNum">    3067 </span>            :     }
<span class="lineNum">    3068 </span><span class="lineCov">       4633 :     if (deltan&gt;2.0) continue;  // extended - highly probable shared cluster</span>
<span class="lineNum">    3069 </span><span class="lineCov">       4569 :     weight = 2./TMath::Max(3.+deltan,2.);</span>
<span class="lineNum">    3070 </span>            :     //
<span class="lineNum">    3071 </span><span class="lineCov">      49339 :     for (Int_t itrack=0;itrack&lt;4;itrack++){</span>
<span class="lineNum">    3072 </span><span class="lineCov">      21018 :       if (fgLayers[l].GetClusterTracks(itrack,c)&gt;=0 &amp;&amp; fgLayers[l].GetClusterTracks(itrack,c)!=id){</span>
<span class="lineNum">    3073 </span><span class="lineCov">        112 :         list[l]=index;</span>
<span class="lineNum">    3074 </span><span class="lineCov">        112 :         clist[l] = (AliITSRecPoint*)GetCluster(index);</span>
<span class="lineNum">    3075 </span><span class="lineCov">        112 :         track-&gt;SetSharedWeight(l,weight);</span>
<span class="lineNum">    3076 </span><span class="lineCov">        112 :         shared+=weight; </span>
<span class="lineNum">    3077 </span><span class="lineCov">        112 :         break;</span>
<span class="lineNum">    3078 </span>            :       }
<span class="lineNum">    3079 </span>            :     }
<span class="lineNum">    3080 </span><span class="lineCov">       4569 :   }</span>
<span class="lineNum">    3081 </span><span class="lineCov">       1308 :   track-&gt;SetNUsed(shared);</span>
<span class="lineNum">    3082 </span><span class="lineCov">       1308 :   return shared;</span>
<a name="3083"><span class="lineNum">    3083 </span>            : }</a>
<span class="lineNum">    3084 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3085 </span>            : Int_t AliITStrackerMI::GetOverlapTrack(const AliITStrackMI *track, Int_t trackID, Int_t &amp;shared, Int_t clusterlist[6],Int_t overlist[6])
<span class="lineNum">    3086 </span>            : {
<span class="lineNum">    3087 </span>            :   //
<span class="lineNum">    3088 </span>            :   // find first shared track 
<span class="lineNum">    3089 </span>            :   //
<span class="lineNum">    3090 </span>            :   // mean  number of clusters
<span class="lineNum">    3091 </span><span class="lineCov">         20 :   Float_t *ny = GetNy(trackID), *nz = GetNz(trackID); </span>
<span class="lineNum">    3092 </span>            :   //
<span class="lineNum">    3093 </span><span class="lineCov">        140 :   for (Int_t i=0;i&lt;6;i++) overlist[i]=-1;</span>
<span class="lineNum">    3094 </span>            :   Int_t sharedtrack=100000;
<span class="lineNum">    3095 </span><span class="lineCov">         10 :   Int_t tracks[24]={0},trackindex=0;</span>
<span class="lineNum">    3096 </span><span class="lineCov">        500 :   for (Int_t i=0;i&lt;24;i++) {tracks[i]=-1;}</span>
<span class="lineNum">    3097 </span>            :   //
<span class="lineNum">    3098 </span><span class="lineCov">        140 :   for (Int_t icluster=0;icluster&lt;6;icluster++){</span>
<span class="lineNum">    3099 </span><span class="lineCov">         60 :     if (clusterlist[icluster]&lt;0) continue;</span>
<span class="lineNum">    3100 </span>            :     Int_t index = clusterlist[icluster];
<span class="lineNum">    3101 </span><span class="lineCov">         10 :     Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">    3102 </span><span class="lineCov">         10 :     Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">    3103 </span>            :     // if (ny[l]&lt;1.e-13){
<span class="lineNum">    3104 </span>            :     //   printf(&quot;problem\n&quot;);
<span class="lineNum">    3105 </span>            :     // }
<span class="lineNum">    3106 </span><span class="lineCov">         10 :     if (c&gt;fgLayers[l].GetNumberOfClusters()) continue;</span>
<span class="lineNum">    3107 </span>            :     //if (l&gt;3) continue;
<span class="lineNum">    3108 </span><span class="lineCov">         10 :     AliITSRecPoint *cl = (AliITSRecPoint*)GetCluster(index);</span>
<span class="lineNum">    3109 </span>            :     //
<span class="lineNum">    3110 </span>            :     Float_t deltan = 0;
<span class="lineNum">    3111 </span><span class="lineCov">         10 :     if (l&gt;3&amp;&amp;cl-&gt;GetNy()+cl-&gt;GetNz()&gt;6) continue;</span>
<span class="lineNum">    3112 </span><span class="lineCov">         14 :     if (l&gt;2&amp;&amp;AliITSReconstructor::GetRecoParam()-&gt;GetUseAmplitudeInfo(l))</span>
<span class="lineNum">    3113 </span><span class="lineCov">          4 :       if (track-&gt;GetNormQ(l)/track-&gt;GetExpQ()&gt;3.5) continue;</span>
<span class="lineNum">    3114 </span><span class="lineCov">         10 :     if (l&lt;2 || l&gt;3){      </span>
<span class="lineNum">    3115 </span><span class="lineNoCov">          0 :       deltan = (cl-&gt;GetNy()+cl-&gt;GetNz()-ny[l]-nz[l]);</span>
<span class="lineNum">    3116 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3117 </span>            :     else{
<span class="lineNum">    3118 </span><span class="lineCov">         10 :       deltan = (cl-&gt;GetNz()-nz[l]);</span>
<span class="lineNum">    3119 </span>            :     }
<span class="lineNum">    3120 </span><span class="lineCov">         10 :     if (deltan&gt;2.0) continue;  // extended - highly probable shared cluster</span>
<span class="lineNum">    3121 </span>            :     //
<span class="lineNum">    3122 </span><span class="lineCov">        100 :     for (Int_t itrack=3;itrack&gt;=0;itrack--){</span>
<span class="lineNum">    3123 </span><span class="lineCov">         40 :       if (fgLayers[l].GetClusterTracks(itrack,c)&lt;0) continue;</span>
<span class="lineNum">    3124 </span><span class="lineCov">         12 :       if (fgLayers[l].GetClusterTracks(itrack,c)!=trackID){</span>
<span class="lineNum">    3125 </span><span class="lineCov">         12 :        tracks[trackindex]  = fgLayers[l].GetClusterTracks(itrack,c);</span>
<span class="lineNum">    3126 </span><span class="lineCov">         12 :        trackindex++;</span>
<span class="lineNum">    3127 </span><span class="lineCov">         12 :       }</span>
<span class="lineNum">    3128 </span>            :     }
<span class="lineNum">    3129 </span><span class="lineCov">         10 :   }</span>
<span class="lineNum">    3130 </span><span class="lineCov">         10 :   if (trackindex==0) return -1;</span>
<span class="lineNum">    3131 </span><span class="lineCov">         10 :   if (trackindex==1){    </span>
<span class="lineNum">    3132 </span><span class="lineCov">          8 :     sharedtrack = tracks[0];</span>
<span class="lineNum">    3133 </span><span class="lineCov">          8 :   }else{</span>
<span class="lineNum">    3134 </span><span class="lineCov">          4 :     if (trackindex==2) sharedtrack =TMath::Min(tracks[0],tracks[1]);</span>
<span class="lineNum">    3135 </span>            :     else{
<span class="lineNum">    3136 </span>            :       //
<span class="lineNum">    3137 </span><span class="lineNoCov">          0 :       Int_t tracks2[24]={0}, cluster[24]={0};</span>
<span class="lineNum">    3138 </span><span class="lineNoCov">          0 :       for (Int_t i=0;i&lt;24;i++){ tracks2[i]=-1; cluster[i]=0;}</span>
<span class="lineNum">    3139 </span>            :       Int_t index =0;
<span class="lineNum">    3140 </span>            :       //
<span class="lineNum">    3141 </span><span class="lineNoCov">          0 :       for (Int_t i=0;i&lt;trackindex;i++){</span>
<span class="lineNum">    3142 </span><span class="lineNoCov">          0 :         if (tracks[i]&lt;0) continue;</span>
<span class="lineNum">    3143 </span><span class="lineNoCov">          0 :         tracks2[index] = tracks[i];</span>
<span class="lineNum">    3144 </span><span class="lineNoCov">          0 :         cluster[index]++;       </span>
<span class="lineNum">    3145 </span><span class="lineNoCov">          0 :         for (Int_t j=i+1;j&lt;trackindex;j++){</span>
<span class="lineNum">    3146 </span><span class="lineNoCov">          0 :           if (tracks[j]&lt;0) continue;</span>
<span class="lineNum">    3147 </span><span class="lineNoCov">          0 :           if (tracks[j]==tracks[i]){</span>
<span class="lineNum">    3148 </span><span class="lineNoCov">          0 :             cluster[index]++;</span>
<span class="lineNum">    3149 </span><span class="lineNoCov">          0 :             tracks[j]=-1;</span>
<span class="lineNum">    3150 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    3151 </span>            :         }
<span class="lineNum">    3152 </span><span class="lineNoCov">          0 :         index++;</span>
<span class="lineNum">    3153 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3154 </span>            :       Int_t max=0;
<span class="lineNum">    3155 </span><span class="lineNoCov">          0 :       for (Int_t i=0;i&lt;index;i++){</span>
<span class="lineNum">    3156 </span><span class="lineNoCov">          0 :         if (cluster[index]&gt;max) {</span>
<span class="lineNum">    3157 </span><span class="lineNoCov">          0 :           sharedtrack=tracks2[index];</span>
<span class="lineNum">    3158 </span>            :           max=cluster[index];
<span class="lineNum">    3159 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3160 </span>            :       }
<span class="lineNum">    3161 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3162 </span>            :   }
<span class="lineNum">    3163 </span>            :   
<span class="lineNum">    3164 </span><span class="lineCov">         10 :   if (sharedtrack&gt;=100000) return -1;</span>
<span class="lineNum">    3165 </span>            :   //
<span class="lineNum">    3166 </span>            :   // make list of overlaps
<span class="lineNum">    3167 </span><span class="lineCov">         10 :   shared =0;</span>
<span class="lineNum">    3168 </span><span class="lineCov">        140 :   for (Int_t icluster=0;icluster&lt;6;icluster++){</span>
<span class="lineNum">    3169 </span><span class="lineCov">         60 :     if (clusterlist[icluster]&lt;0) continue;</span>
<span class="lineNum">    3170 </span>            :     Int_t index = clusterlist[icluster];
<span class="lineNum">    3171 </span><span class="lineCov">         10 :     Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">    3172 </span><span class="lineCov">         10 :     Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">    3173 </span><span class="lineCov">         10 :     if (c&gt;fgLayers[l].GetNumberOfClusters()) continue;</span>
<span class="lineNum">    3174 </span><span class="lineCov">         10 :     AliITSRecPoint *cl = (AliITSRecPoint*)GetCluster(index);</span>
<span class="lineNum">    3175 </span><span class="lineCov">         10 :     if (l==0 || l==1){</span>
<span class="lineNum">    3176 </span><span class="lineNoCov">          0 :       if (cl-&gt;GetNy()&gt;2) continue;</span>
<span class="lineNum">    3177 </span><span class="lineNoCov">          0 :       if (cl-&gt;GetNz()&gt;2) continue;</span>
<span class="lineNum">    3178 </span>            :     }
<span class="lineNum">    3179 </span><span class="lineCov">         10 :     if (l==4 || l==5){</span>
<span class="lineNum">    3180 </span><span class="lineNoCov">          0 :       if (cl-&gt;GetNy()&gt;3) continue;</span>
<span class="lineNum">    3181 </span><span class="lineNoCov">          0 :       if (cl-&gt;GetNz()&gt;3) continue;</span>
<span class="lineNum">    3182 </span>            :     }
<span class="lineNum">    3183 </span>            :     //
<span class="lineNum">    3184 </span><span class="lineCov">        100 :     for (Int_t itrack=3;itrack&gt;=0;itrack--){</span>
<span class="lineNum">    3185 </span><span class="lineCov">         40 :       if (fgLayers[l].GetClusterTracks(itrack,c)&lt;0) continue;</span>
<span class="lineNum">    3186 </span><span class="lineCov">         12 :       if (fgLayers[l].GetClusterTracks(itrack,c)==sharedtrack){</span>
<span class="lineNum">    3187 </span><span class="lineCov">         12 :         overlist[l]=index;</span>
<span class="lineNum">    3188 </span><span class="lineCov">         12 :         shared++;      </span>
<span class="lineNum">    3189 </span><span class="lineCov">         12 :       }</span>
<span class="lineNum">    3190 </span>            :     }
<span class="lineNum">    3191 </span><span class="lineCov">         10 :   }</span>
<span class="lineNum">    3192 </span><span class="lineCov">         10 :   return sharedtrack;</span>
<a name="3193"><span class="lineNum">    3193 </span><span class="lineCov">         10 : }</span></a>
<span class="lineNum">    3194 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3195 </span>            : AliITStrackMI *  AliITStrackerMI::GetBest2Tracks(Int_t trackID1, Int_t trackID2, Float_t th0, Float_t th1,AliITStrackMI* original){
<span class="lineNum">    3196 </span>            :   //
<span class="lineNum">    3197 </span>            :   // try to find track hypothesys without conflicts
<span class="lineNum">    3198 </span>            :   // with minimal chi2;
<span class="lineNum">    3199 </span><span class="lineCov">         20 :   TClonesArray *arr1 = (TClonesArray*)fTrackHypothesys.At(trackID1);</span>
<span class="lineNum">    3200 </span><span class="lineCov">         10 :   Int_t entries1 = arr1-&gt;GetEntriesFast();</span>
<span class="lineNum">    3201 </span><span class="lineCov">         10 :   TClonesArray *arr2 = (TClonesArray*)fTrackHypothesys.At(trackID2);</span>
<span class="lineNum">    3202 </span><span class="lineCov">         10 :   if (!arr2) return (AliITStrackMI*) arr1-&gt;UncheckedAt(0);</span>
<span class="lineNum">    3203 </span><span class="lineCov">         10 :   Int_t entries2 = arr2-&gt;GetEntriesFast();</span>
<span class="lineNum">    3204 </span><span class="lineCov">         10 :   if (entries2&lt;=0) return (AliITStrackMI*) arr1-&gt;UncheckedAt(0);</span>
<span class="lineNum">    3205 </span>            :   //
<span class="lineNum">    3206 </span><span class="lineCov">         10 :   AliITStrackMI * track10=(AliITStrackMI*) arr1-&gt;UncheckedAt(0);</span>
<span class="lineNum">    3207 </span><span class="lineCov">         10 :   AliITStrackMI * track20=(AliITStrackMI*) arr2-&gt;UncheckedAt(0);</span>
<span class="lineNum">    3208 </span><span class="lineCov">         10 :   if (track10-&gt;Pt()&gt;0.5+track20-&gt;Pt()) return track10;</span>
<span class="lineNum">    3209 </span>            :   //
<span class="lineNum">    3210 </span><span class="lineCov">         84 :   for (Int_t itrack=0;itrack&lt;entries1;itrack++){</span>
<span class="lineNum">    3211 </span><span class="lineCov">         32 :     AliITStrackMI * track=(AliITStrackMI*) arr1-&gt;UncheckedAt(itrack);</span>
<span class="lineNum">    3212 </span><span class="lineCov">         32 :     UnRegisterClusterTracks(track,trackID1);</span>
<span class="lineNum">    3213 </span>            :   }
<span class="lineNum">    3214 </span>            :   //
<span class="lineNum">    3215 </span><span class="lineCov">         52 :   for (Int_t itrack=0;itrack&lt;entries2;itrack++){</span>
<span class="lineNum">    3216 </span><span class="lineCov">         16 :     AliITStrackMI * track=(AliITStrackMI*) arr2-&gt;UncheckedAt(itrack);</span>
<span class="lineNum">    3217 </span><span class="lineCov">         16 :     UnRegisterClusterTracks(track,trackID2);</span>
<span class="lineNum">    3218 </span>            :   }
<span class="lineNum">    3219 </span>            :   Int_t index1=0;
<span class="lineNum">    3220 </span>            :   Int_t index2=0;
<span class="lineNum">    3221 </span>            :   Float_t maxconflicts=6;
<span class="lineNum">    3222 </span>            :   Double_t maxchi2 =1000.;
<span class="lineNum">    3223 </span>            :   //
<span class="lineNum">    3224 </span>            :   // get weight of hypothesys - using best hypothesy
<span class="lineNum">    3225 </span>            :   Double_t w1,w2;
<span class="lineNum">    3226 </span>            :  
<span class="lineNum">    3227 </span><span class="lineCov">         10 :   Int_t list1[6]={0},list2[6]={0};</span>
<span class="lineNum">    3228 </span><span class="lineCov">         10 :   AliITSRecPoint *clist1[6]={0}, *clist2[6]={0} ;</span>
<span class="lineNum">    3229 </span><span class="lineCov">         10 :   RegisterClusterTracks(track10,trackID1);</span>
<span class="lineNum">    3230 </span><span class="lineCov">         10 :   RegisterClusterTracks(track20,trackID2);</span>
<span class="lineNum">    3231 </span><span class="lineCov">         10 :   Float_t conflict1 = GetNumberOfSharedClusters(track10,trackID1,list1,clist1);</span>
<span class="lineNum">    3232 </span><span class="lineCov">         10 :   Float_t conflict2 = GetNumberOfSharedClusters(track20,trackID2,list2,clist2);</span>
<span class="lineNum">    3233 </span><span class="lineCov">         10 :   UnRegisterClusterTracks(track10,trackID1);</span>
<span class="lineNum">    3234 </span><span class="lineCov">         10 :   UnRegisterClusterTracks(track20,trackID2);</span>
<span class="lineNum">    3235 </span>            :   //
<span class="lineNum">    3236 </span>            :   // normalized chi2
<span class="lineNum">    3237 </span>            :   Float_t chi21 =0,chi22=0,ncl1=0,ncl2=0;
<span class="lineNum">    3238 </span><span class="lineCov">         10 :   Float_t nerry[6]={0},nerrz[6]={0};</span>
<span class="lineNum">    3239 </span><span class="lineCov">         10 :   Float_t *erry1=GetErrY(trackID1),*errz1 = GetErrZ(trackID1);</span>
<span class="lineNum">    3240 </span><span class="lineCov">         10 :   Float_t *erry2=GetErrY(trackID2),*errz2 = GetErrZ(trackID2);</span>
<span class="lineNum">    3241 </span><span class="lineCov">        140 :   for (Int_t i=0;i&lt;6;i++){</span>
<span class="lineNum">    3242 </span><span class="lineCov">        102 :      if ( (erry1[i]&gt;0) &amp;&amp; (erry2[i]&gt;0)) {</span>
<span class="lineNum">    3243 </span><span class="lineCov">         42 :        nerry[i] = TMath::Min(erry1[i],erry2[i]);</span>
<span class="lineNum">    3244 </span><span class="lineCov">         42 :        nerrz[i] = TMath::Min(errz1[i],errz2[i]);</span>
<span class="lineNum">    3245 </span><span class="lineCov">         42 :      }else{</span>
<span class="lineNum">    3246 </span><span class="lineCov">         18 :        nerry[i] = TMath::Max(erry1[i],erry2[i]);</span>
<span class="lineNum">    3247 </span><span class="lineCov">         18 :        nerrz[i] = TMath::Max(errz1[i],errz2[i]);</span>
<span class="lineNum">    3248 </span>            :      }
<span class="lineNum">    3249 </span><span class="lineCov">         60 :      if (TMath::Abs(track10-&gt;GetDy(i))&gt;0.000000000000001){</span>
<span class="lineNum">    3250 </span><span class="lineCov">         42 :        chi21 += track10-&gt;GetDy(i)*track10-&gt;GetDy(i)/(nerry[i]*nerry[i]);</span>
<span class="lineNum">    3251 </span><span class="lineCov">         42 :        chi21 += track10-&gt;GetDz(i)*track10-&gt;GetDz(i)/(nerrz[i]*nerrz[i]);</span>
<span class="lineNum">    3252 </span><span class="lineCov">         42 :        ncl1++;</span>
<span class="lineNum">    3253 </span><span class="lineCov">         42 :      }</span>
<span class="lineNum">    3254 </span><span class="lineCov">         60 :      if (TMath::Abs(track20-&gt;GetDy(i))&gt;0.000000000000001){</span>
<span class="lineNum">    3255 </span><span class="lineCov">         40 :        chi22 += track20-&gt;GetDy(i)*track20-&gt;GetDy(i)/(nerry[i]*nerry[i]);</span>
<span class="lineNum">    3256 </span><span class="lineCov">         40 :        chi22 += track20-&gt;GetDz(i)*track20-&gt;GetDz(i)/(nerrz[i]*nerrz[i]);</span>
<span class="lineNum">    3257 </span><span class="lineCov">         40 :        ncl2++;</span>
<span class="lineNum">    3258 </span><span class="lineCov">         40 :      }</span>
<span class="lineNum">    3259 </span>            :   }
<span class="lineNum">    3260 </span><span class="lineCov">         10 :   chi21/=ncl1;</span>
<span class="lineNum">    3261 </span><span class="lineCov">         10 :   chi22/=ncl2;</span>
<span class="lineNum">    3262 </span>            :   //
<span class="lineNum">    3263 </span>            :   // 
<span class="lineNum">    3264 </span><span class="lineCov">         10 :   Float_t d1 = TMath::Sqrt(track10-&gt;GetD(0)*track10-&gt;GetD(0)+track10-&gt;GetD(1)*track10-&gt;GetD(1))+0.1;</span>
<span class="lineNum">    3265 </span><span class="lineCov">         10 :   Float_t d2 = TMath::Sqrt(track20-&gt;GetD(0)*track20-&gt;GetD(0)+track20-&gt;GetD(1)*track20-&gt;GetD(1))+0.1;</span>
<span class="lineNum">    3266 </span><span class="lineCov">         10 :   Float_t s1 = TMath::Sqrt(track10-&gt;GetSigmaY2()*track10-&gt;GetSigmaZ2());</span>
<span class="lineNum">    3267 </span><span class="lineCov">         10 :   Float_t s2 = TMath::Sqrt(track20-&gt;GetSigmaY2()*track20-&gt;GetSigmaZ2());</span>
<span class="lineNum">    3268 </span>            :   //
<span class="lineNum">    3269 </span><span class="lineCov">         20 :   w1 = (d2/(d1+d2)+ 2*s2/(s1+s2)+</span>
<span class="lineNum">    3270 </span><span class="lineCov">         10 :         +s2/(s1+s2)*0.5*(chi22+2.)/(chi21+chi22+4.)</span>
<span class="lineNum">    3271 </span><span class="lineCov">         10 :         +1.*track10-&gt;Pt()/(track10-&gt;Pt()+track20-&gt;Pt())</span>
<span class="lineNum">    3272 </span>            :         );
<span class="lineNum">    3273 </span><span class="lineCov">         20 :   w2 = (d1/(d1+d2)+ 2*s1/(s1+s2)+</span>
<span class="lineNum">    3274 </span><span class="lineCov">         10 :         s1/(s1+s2)*0.5*(chi21+2.)/(chi21+chi22+4.)</span>
<span class="lineNum">    3275 </span><span class="lineCov">         10 :         +1.*track20-&gt;Pt()/(track10-&gt;Pt()+track20-&gt;Pt())</span>
<span class="lineNum">    3276 </span>            :         );
<span class="lineNum">    3277 </span>            : 
<span class="lineNum">    3278 </span><span class="lineCov">         10 :   Double_t sumw = w1+w2;</span>
<span class="lineNum">    3279 </span><span class="lineCov">         10 :   w1/=sumw;</span>
<span class="lineNum">    3280 </span><span class="lineCov">         10 :   w2/=sumw;</span>
<span class="lineNum">    3281 </span><span class="lineCov">         10 :   if (w1&lt;w2*0.5) {</span>
<span class="lineNum">    3282 </span><span class="lineCov">          4 :     w1 = (d2+0.5)/(d1+d2+1.);</span>
<span class="lineNum">    3283 </span><span class="lineCov">          4 :     w2 = (d1+0.5)/(d1+d2+1.);</span>
<span class="lineNum">    3284 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">    3285 </span>            :   //  Float_t maxmax       = w1*track10-&gt;fChi2MIP[0]+w2*track20-&gt;fChi2MIP[0]+w1*conflict1+w2*conflict2+1.;
<span class="lineNum">    3286 </span>            :   //Float_t maxconflicts0 = w1*conflict1+w2*conflict2;
<span class="lineNum">    3287 </span>            :   //
<span class="lineNum">    3288 </span>            :   // get pair of &quot;best&quot; hypothesys
<span class="lineNum">    3289 </span>            :   //  
<span class="lineNum">    3290 </span><span class="lineCov">         10 :   Float_t * ny1 = GetNy(trackID1), * nz1 = GetNz(trackID1); </span>
<span class="lineNum">    3291 </span><span class="lineCov">         10 :   Float_t * ny2 = GetNy(trackID2), * nz2 = GetNz(trackID2); </span>
<span class="lineNum">    3292 </span>            : 
<span class="lineNum">    3293 </span><span class="lineCov">         84 :   for (Int_t itrack1=0;itrack1&lt;entries1;itrack1++){</span>
<span class="lineNum">    3294 </span><span class="lineCov">         32 :     AliITStrackMI * track1=(AliITStrackMI*) arr1-&gt;UncheckedAt(itrack1);</span>
<span class="lineNum">    3295 </span>            :     //if (track1-&gt;fFakeRatio&gt;0) continue;
<span class="lineNum">    3296 </span><span class="lineCov">         32 :     RegisterClusterTracks(track1,trackID1);</span>
<span class="lineNum">    3297 </span><span class="lineCov">        164 :     for (Int_t itrack2=0;itrack2&lt;entries2;itrack2++){</span>
<span class="lineNum">    3298 </span><span class="lineCov">         50 :       AliITStrackMI * track2=(AliITStrackMI*) arr2-&gt;UncheckedAt(itrack2);</span>
<span class="lineNum">    3299 </span>            : 
<span class="lineNum">    3300 </span>            :       //      Float_t current = w1*track1-&gt;fChi2MIP[0]+w2*track2-&gt;fChi2MIP[0];
<span class="lineNum">    3301 </span>            :       //if (track2-&gt;fFakeRatio&gt;0) continue;
<span class="lineNum">    3302 </span>            :       Float_t nskipped=0;            
<span class="lineNum">    3303 </span><span class="lineCov">         50 :       RegisterClusterTracks(track2,trackID2);</span>
<span class="lineNum">    3304 </span><span class="lineCov">         50 :       Float_t cconflict1 = GetNumberOfSharedClusters(track1,trackID1,list1,clist1);</span>
<span class="lineNum">    3305 </span><span class="lineCov">         50 :       Float_t cconflict2 = GetNumberOfSharedClusters(track2,trackID2,list2,clist2);</span>
<span class="lineNum">    3306 </span><span class="lineCov">         50 :       UnRegisterClusterTracks(track2,trackID2);</span>
<span class="lineNum">    3307 </span>            :       //
<span class="lineNum">    3308 </span><span class="lineCov">         66 :       if (track1-&gt;GetConstrain()) nskipped+=w1*track1-&gt;GetNSkipped();</span>
<span class="lineNum">    3309 </span><span class="lineCov">         82 :       if (track2-&gt;GetConstrain()) nskipped+=w2*track2-&gt;GetNSkipped();</span>
<span class="lineNum">    3310 </span><span class="lineCov">         66 :       if (nskipped&gt;0.5) continue;</span>
<span class="lineNum">    3311 </span>            :       //
<span class="lineNum">    3312 </span>            :       //if ( w1*conflict1+w2*conflict2&gt;maxconflicts0) continue;
<span class="lineNum">    3313 </span><span class="lineCov">         34 :       if (conflict1+1&lt;cconflict1) continue;</span>
<span class="lineNum">    3314 </span><span class="lineCov">         34 :       if (conflict2+1&lt;cconflict2) continue;</span>
<span class="lineNum">    3315 </span>            :       Float_t conflict=0;
<span class="lineNum">    3316 </span>            :       Float_t sumchi2=0;
<span class="lineNum">    3317 </span>            :       Float_t sum=0;
<span class="lineNum">    3318 </span><span class="lineCov">        476 :       for (Int_t i=0;i&lt;6;i++){</span>
<span class="lineNum">    3319 </span>            :         //
<span class="lineNum">    3320 </span>            :         Float_t c1 =0.; // conflict coeficients
<span class="lineNum">    3321 </span>            :         Float_t c2 =0.; 
<span class="lineNum">    3322 </span><span class="lineCov">        234 :         if (clist1[i]&amp;&amp;clist2[i]){</span>
<span class="lineNum">    3323 </span>            :           Float_t deltan = 0;
<span class="lineNum">    3324 </span><span class="lineCov">         30 :           if (i&lt;2 || i&gt;3){      </span>
<span class="lineNum">    3325 </span><span class="lineNoCov">          0 :             deltan = (clist1[i]-&gt;GetNy()+clist1[i]-&gt;GetNz()-TMath::Max(ny1[i],ny2[i])-TMath::Max(nz1[i],nz2[i]));</span>
<span class="lineNum">    3326 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    3327 </span>            :           else{
<span class="lineNum">    3328 </span><span class="lineCov">         30 :             deltan = (clist1[i]-&gt;GetNz()-TMath::Max(nz1[i],nz2[i]));</span>
<span class="lineNum">    3329 </span>            :           }
<span class="lineNum">    3330 </span><span class="lineCov">         30 :           c1  = 2./TMath::Max(3.+deltan,2.);      </span>
<span class="lineNum">    3331 </span><span class="lineCov">         30 :           c2  = 2./TMath::Max(3.+deltan,2.);      </span>
<span class="lineNum">    3332 </span><span class="lineCov">         30 :         }</span>
<span class="lineNum">    3333 </span>            :         else{
<span class="lineNum">    3334 </span><span class="lineCov">        174 :           if (clist1[i]){</span>
<span class="lineNum">    3335 </span>            :             Float_t deltan = 0;
<span class="lineNum">    3336 </span><span class="lineNoCov">          0 :             if (i&lt;2 || i&gt;3){      </span>
<span class="lineNum">    3337 </span><span class="lineNoCov">          0 :               deltan = (clist1[i]-&gt;GetNy()+clist1[i]-&gt;GetNz()-ny1[i]-nz1[i]);</span>
<span class="lineNum">    3338 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    3339 </span>            :             else{
<span class="lineNum">    3340 </span><span class="lineNoCov">          0 :               deltan = (clist1[i]-&gt;GetNz()-nz1[i]);</span>
<span class="lineNum">    3341 </span>            :             }
<span class="lineNum">    3342 </span><span class="lineNoCov">          0 :             c1  = 2./TMath::Max(3.+deltan,2.);    </span>
<span class="lineNum">    3343 </span>            :             c2  = 0;
<span class="lineNum">    3344 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    3345 </span>            : 
<span class="lineNum">    3346 </span><span class="lineCov">        174 :           if (clist2[i]){</span>
<span class="lineNum">    3347 </span>            :             Float_t deltan = 0;
<span class="lineNum">    3348 </span><span class="lineNoCov">          0 :             if (i&lt;2 || i&gt;3){      </span>
<span class="lineNum">    3349 </span><span class="lineNoCov">          0 :               deltan = (clist2[i]-&gt;GetNy()+clist2[i]-&gt;GetNz()-ny2[i]-nz2[i]);</span>
<span class="lineNum">    3350 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    3351 </span>            :             else{
<span class="lineNum">    3352 </span><span class="lineNoCov">          0 :               deltan = (clist2[i]-&gt;GetNz()-nz2[i]);</span>
<span class="lineNum">    3353 </span>            :             }
<span class="lineNum">    3354 </span><span class="lineNoCov">          0 :             c2  = 2./TMath::Max(3.+deltan,2.);    </span>
<span class="lineNum">    3355 </span>            :             c1  = 0;
<span class="lineNum">    3356 </span><span class="lineNoCov">          0 :           }       </span>
<span class="lineNum">    3357 </span>            :         }
<span class="lineNum">    3358 </span>            :         //
<span class="lineNum">    3359 </span>            :         chi21=0;chi22=0;
<span class="lineNum">    3360 </span><span class="lineCov">        204 :         if (TMath::Abs(track1-&gt;GetDy(i))&gt;0.) {</span>
<span class="lineNum">    3361 </span><span class="lineCov">        296 :           chi21 = (track1-&gt;GetDy(i)/track1-&gt;GetSigmaY(i))*(track1-&gt;GetDy(i)/track1-&gt;GetSigmaY(i))+</span>
<span class="lineNum">    3362 </span><span class="lineCov">        148 :             (track1-&gt;GetDz(i)/track1-&gt;GetSigmaZ(i))*(track1-&gt;GetDz(i)/track1-&gt;GetSigmaZ(i));</span>
<span class="lineNum">    3363 </span>            :           //chi21 = (track1-&gt;fDy[i]*track1-&gt;fDy[i])/(nerry[i]*nerry[i])+
<span class="lineNum">    3364 </span>            :           //  (track1-&gt;GetDz(i)*track1-&gt;GetDz(i))/(nerrz[i]*nerrz[i]);
<span class="lineNum">    3365 </span><span class="lineCov">        148 :         }else{</span>
<span class="lineNum">    3366 </span><span class="lineCov">         56 :           if (TMath::Abs(track1-&gt;GetSigmaY(i)&gt;0.)) c1=1;</span>
<span class="lineNum">    3367 </span>            :         }
<span class="lineNum">    3368 </span>            :         //
<span class="lineNum">    3369 </span><span class="lineCov">        204 :         if (TMath::Abs(track2-&gt;GetDy(i))&gt;0.) {</span>
<span class="lineNum">    3370 </span><span class="lineCov">        272 :           chi22 = (track2-&gt;GetDy(i)/track2-&gt;GetSigmaY(i))*(track2-&gt;GetDy(i)/track2-&gt;GetSigmaY(i))+</span>
<span class="lineNum">    3371 </span><span class="lineCov">        136 :             (track2-&gt;GetDz(i)/track2-&gt;GetSigmaZ(i))*(track2-&gt;GetDz(i)/track2-&gt;GetSigmaZ(i));</span>
<span class="lineNum">    3372 </span>            :           //chi22 = (track2-&gt;fDy[i]*track2-&gt;fDy[i])/(nerry[i]*nerry[i])+
<span class="lineNum">    3373 </span>            :           //  (track2-&gt;fDz[i]*track2-&gt;fDz[i])/(nerrz[i]*nerrz[i]);
<span class="lineNum">    3374 </span><span class="lineCov">        136 :         }</span>
<span class="lineNum">    3375 </span>            :         else{
<span class="lineNum">    3376 </span><span class="lineCov">         86 :           if (TMath::Abs(track2-&gt;GetSigmaY(i)&gt;0.)) c2=1;</span>
<span class="lineNum">    3377 </span>            :         }
<span class="lineNum">    3378 </span><span class="lineCov">        204 :         sumchi2+=w1*(1.+c1)*(1+c1)*(chi21+c1)+w2*(1.+c2)*(1+c2)*(chi22+c2);</span>
<span class="lineNum">    3379 </span><span class="lineCov">        352 :         if (chi21&gt;0) sum+=w1;</span>
<span class="lineNum">    3380 </span><span class="lineCov">        340 :         if (chi22&gt;0) sum+=w2;</span>
<span class="lineNum">    3381 </span><span class="lineCov">        204 :         conflict+=(c1+c2);</span>
<span class="lineNum">    3382 </span>            :       }
<span class="lineNum">    3383 </span><span class="lineCov">         34 :       Double_t norm = sum-w1*track1-&gt;GetNSkipped()-w2*track2-&gt;GetNSkipped();</span>
<span class="lineNum">    3384 </span><span class="lineCov">         34 :       if (norm&lt;0) norm =1/(w1*track1-&gt;GetNSkipped()+w2*track2-&gt;GetNSkipped());</span>
<span class="lineNum">    3385 </span><span class="lineCov">         34 :       Double_t normchi2 = 2*conflict+sumchi2/sum;</span>
<span class="lineNum">    3386 </span><span class="lineCov">         34 :       if ( normchi2 &lt;maxchi2 ){        </span>
<span class="lineNum">    3387 </span>            :         index1 = itrack1;
<span class="lineNum">    3388 </span>            :         index2 = itrack2;
<span class="lineNum">    3389 </span>            :         maxconflicts = conflict;
<span class="lineNum">    3390 </span>            :         maxchi2 = normchi2;
<span class="lineNum">    3391 </span><span class="lineCov">         20 :       }      </span>
<span class="lineNum">    3392 </span><span class="lineCov">         34 :     }</span>
<span class="lineNum">    3393 </span><span class="lineCov">         32 :     UnRegisterClusterTracks(track1,trackID1);</span>
<span class="lineNum">    3394 </span>            :   }
<span class="lineNum">    3395 </span>            :   //
<span class="lineNum">    3396 </span>            :   //  if (maxconflicts&lt;4 &amp;&amp; maxchi2&lt;th0){   
<span class="lineNum">    3397 </span><span class="lineCov">         10 :   if (maxchi2&lt;th0*2.){   </span>
<span class="lineNum">    3398 </span><span class="lineCov">         10 :     Float_t orig = track10-&gt;GetFakeRatio()*track10-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    3399 </span><span class="lineCov">         10 :     AliITStrackMI* track1=(AliITStrackMI*) arr1-&gt;UncheckedAt(index1);</span>
<span class="lineNum">    3400 </span><span class="lineCov">         10 :     track1-&gt;SetChi2MIP(5,maxconflicts);</span>
<span class="lineNum">    3401 </span><span class="lineCov">         10 :     track1-&gt;SetChi2MIP(6,maxchi2);</span>
<span class="lineNum">    3402 </span><span class="lineCov">         10 :     track1-&gt;SetChi2MIP(7,0.01+orig-(track1-&gt;GetFakeRatio()*track1-&gt;GetNumberOfClusters()));</span>
<span class="lineNum">    3403 </span>            :     //    track1-&gt;UpdateESDtrack(AliESDtrack::kITSin);
<span class="lineNum">    3404 </span><span class="lineCov">         10 :     track1-&gt;SetChi2MIP(8,index1);</span>
<span class="lineNum">    3405 </span><span class="lineCov">         10 :     fBestTrackIndex[trackID1] =index1;</span>
<span class="lineNum">    3406 </span><span class="lineCov">         10 :     UpdateESDtrack(track1, AliESDtrack::kITSin);</span>
<span class="lineNum">    3407 </span><span class="lineCov">         10 :     original-&gt;SetWinner(track1);</span>
<span class="lineNum">    3408 </span><span class="lineCov">         10 :   }  </span>
<span class="lineNum">    3409 </span><span class="lineNoCov">          0 :   else if (track10-&gt;GetChi2MIP(0)&lt;th1){</span>
<span class="lineNum">    3410 </span><span class="lineNoCov">          0 :     track10-&gt;SetChi2MIP(5,maxconflicts);</span>
<span class="lineNum">    3411 </span><span class="lineNoCov">          0 :     track10-&gt;SetChi2MIP(6,maxchi2);    </span>
<span class="lineNum">    3412 </span>            :     //    track10-&gt;UpdateESDtrack(AliESDtrack::kITSin);
<span class="lineNum">    3413 </span><span class="lineNoCov">          0 :     UpdateESDtrack(track10,AliESDtrack::kITSin);</span>
<span class="lineNum">    3414 </span><span class="lineNoCov">          0 :     original-&gt;SetWinner(track10);</span>
<span class="lineNum">    3415 </span><span class="lineNoCov">          0 :   }   </span>
<span class="lineNum">    3416 </span>            :   
<span class="lineNum">    3417 </span><span class="lineCov">         84 :   for (Int_t itrack=0;itrack&lt;entries1;itrack++){</span>
<span class="lineNum">    3418 </span><span class="lineCov">         32 :     AliITStrackMI * track=(AliITStrackMI*) arr1-&gt;UncheckedAt(itrack);</span>
<span class="lineNum">    3419 </span><span class="lineCov">         32 :     UnRegisterClusterTracks(track,trackID1);</span>
<span class="lineNum">    3420 </span>            :   }
<span class="lineNum">    3421 </span>            :   //
<span class="lineNum">    3422 </span><span class="lineCov">         52 :   for (Int_t itrack=0;itrack&lt;entries2;itrack++){</span>
<span class="lineNum">    3423 </span><span class="lineCov">         16 :     AliITStrackMI * track=(AliITStrackMI*) arr2-&gt;UncheckedAt(itrack);</span>
<span class="lineNum">    3424 </span><span class="lineCov">         16 :     UnRegisterClusterTracks(track,trackID2);</span>
<span class="lineNum">    3425 </span>            :   }
<span class="lineNum">    3426 </span>            : 
<span class="lineNum">    3427 </span><span class="lineCov">         28 :   if (track10-&gt;GetConstrain()&amp;&amp;track10-&gt;GetChi2MIP(0)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)&amp;&amp;track10-&gt;GetChi2MIP(1)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(1)</span>
<span class="lineNum">    3428 </span><span class="lineCov">         18 :       &amp;&amp;track10-&gt;GetChi2MIP(2)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(2)&amp;&amp;track10-&gt;GetChi2MIP(3)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(3)){ </span>
<span class="lineNum">    3429 </span>            :     //  if (track10-&gt;fChi2MIP[0]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)&amp;&amp;track10-&gt;fChi2MIP[1]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(1)
<span class="lineNum">    3430 </span>            :   //    &amp;&amp;track10-&gt;fChi2MIP[2]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(2)&amp;&amp;track10-&gt;fChi2MIP[3]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(3)){ 
<span class="lineNum">    3431 </span><span class="lineNoCov">          0 :     RegisterClusterTracks(track10,trackID1);</span>
<span class="lineNum">    3432 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    3433 </span><span class="lineCov">         40 :   if (track20-&gt;GetConstrain()&amp;&amp;track20-&gt;GetChi2MIP(0)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)&amp;&amp;track20-&gt;GetChi2MIP(1)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(1)</span>
<span class="lineNum">    3434 </span><span class="lineCov">         30 :       &amp;&amp;track20-&gt;GetChi2MIP(2)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(2)&amp;&amp;track20-&gt;GetChi2MIP(3)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(3)){ </span>
<span class="lineNum">    3435 </span>            :     //if (track20-&gt;fChi2MIP[0]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)&amp;&amp;track20-&gt;fChi2MIP[1]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(1)
<span class="lineNum">    3436 </span>            :     //  &amp;&amp;track20-&gt;fChi2MIP[2]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(2)&amp;&amp;track20-&gt;fChi2MIP[3]&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(3)){ 
<span class="lineNum">    3437 </span><span class="lineCov">         10 :     RegisterClusterTracks(track20,trackID2);  </span>
<span class="lineNum">    3438 </span><span class="lineCov">         10 :   }</span>
<span class="lineNum">    3439 </span>            :   return track10; 
<span class="lineNum">    3440 </span>            :  
<a name="3441"><span class="lineNum">    3441 </span><span class="lineCov">         20 : }</span></a>
<span class="lineNum">    3442 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3443 </span>            : void AliITStrackerMI::UseClusters(const AliKalmanTrack *t, Int_t from) const {
<span class="lineNum">    3444 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    3445 </span>            :   // This function marks clusters assigned to the track
<span class="lineNum">    3446 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    3447 </span><span class="lineNoCov">          0 :   AliTracker::UseClusters(t,from);</span>
<span class="lineNum">    3448 </span>            : 
<span class="lineNum">    3449 </span><span class="lineNoCov">          0 :   AliITSRecPoint *c=(AliITSRecPoint *)GetCluster(t-&gt;GetClusterIndex(0));</span>
<span class="lineNum">    3450 </span>            :   //if (c-&gt;GetQ()&gt;2) c-&gt;Use();
<span class="lineNum">    3451 </span><span class="lineNoCov">          0 :   if (c-&gt;GetSigmaZ2()&gt;0.1) c-&gt;Use();</span>
<span class="lineNum">    3452 </span><span class="lineNoCov">          0 :   c=(AliITSRecPoint *)GetCluster(t-&gt;GetClusterIndex(1));</span>
<span class="lineNum">    3453 </span>            :   //if (c-&gt;GetQ()&gt;2) c-&gt;Use();
<span class="lineNum">    3454 </span><span class="lineNoCov">          0 :   if (c-&gt;GetSigmaZ2()&gt;0.1) c-&gt;Use();</span>
<span class="lineNum">    3455 </span>            : 
<a name="3456"><span class="lineNum">    3456 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3457 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3458 </span>            : void AliITStrackerMI::AddTrackHypothesys(AliITStrackMI * track, Int_t esdindex)
<span class="lineNum">    3459 </span>            : {
<span class="lineNum">    3460 </span>            :   //------------------------------------------------------------------
<span class="lineNum">    3461 </span>            :   // add track to the list of hypothesys
<span class="lineNum">    3462 </span>            :   //------------------------------------------------------------------
<span class="lineNum">    3463 </span>            : 
<span class="lineNum">    3464 </span>            :   //
<span class="lineNum">    3465 </span><span class="lineCov">       1900 :   TObjArray * array = (TObjArray*) fTrackHypothesys.At(esdindex);</span>
<span class="lineNum">    3466 </span><span class="lineCov">        950 :   if (!array) {</span>
<span class="lineNum">    3467 </span><span class="lineCov">         82 :     array = new TObjArray(10);</span>
<span class="lineNum">    3468 </span><span class="lineCov">         82 :     fTrackHypothesys.AddAtAndExpand(array,esdindex);</span>
<span class="lineNum">    3469 </span><span class="lineCov">         82 :   }</span>
<span class="lineNum">    3470 </span><span class="lineCov">        950 :   array-&gt;AddLast(track);</span>
<a name="3471"><span class="lineNum">    3471 </span><span class="lineCov">        950 : }</span></a>
<span class="lineNum">    3472 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3473 </span>            : void AliITStrackerMI::SortTrackHypothesys(Int_t esdindex, Int_t maxcut, Int_t mode)
<span class="lineNum">    3474 </span>            : {
<span class="lineNum">    3475 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    3476 </span>            :   // compress array of track hypothesys
<span class="lineNum">    3477 </span>            :   // keep only maxsize best hypothesys
<span class="lineNum">    3478 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    3479 </span><span class="lineCov">        728 :   if (esdindex&gt;fTrackHypothesys.GetEntriesFast()) return;</span>
<span class="lineNum">    3480 </span><span class="lineCov">        362 :   if (! (fTrackHypothesys.At(esdindex)) ) return;</span>
<span class="lineNum">    3481 </span><span class="lineCov">        316 :   TObjArray * array = (TObjArray*) fTrackHypothesys.At(esdindex);</span>
<span class="lineNum">    3482 </span><span class="lineCov">        316 :   Int_t entries = array-&gt;GetEntriesFast();</span>
<span class="lineNum">    3483 </span>            :   //
<span class="lineNum">    3484 </span>            :   //- find preliminary besttrack as a reference
<span class="lineNum">    3485 </span>            :   Float_t minchi2=10000;
<span class="lineNum">    3486 </span>            :   Int_t maxn=0;
<span class="lineNum">    3487 </span>            :   AliITStrackMI * besttrack=0;
<span class="lineNum">    3488 </span>            :   //
<span class="lineNum">    3489 </span><span class="lineCov">       4164 :   for (Int_t itrack=0;itrack&lt;array-&gt;GetEntriesFast();itrack++){</span>
<span class="lineNum">    3490 </span><span class="lineCov">       1766 :     AliITStrackMI * track = (AliITStrackMI*)array-&gt;At(itrack);</span>
<span class="lineNum">    3491 </span><span class="lineCov">       1766 :     if (!track) continue;</span>
<span class="lineNum">    3492 </span><span class="lineCov">       1766 :     Float_t chi2 = NormalizedChi2(track,0);</span>
<span class="lineNum">    3493 </span>            :     //
<span class="lineNum">    3494 </span><span class="lineCov">       1766 :     Int_t tpcLabel=track-&gt;GetESDtrack()-&gt;GetTPCLabel();</span>
<span class="lineNum">    3495 </span><span class="lineCov">       1766 :     track-&gt;SetLabel(tpcLabel);</span>
<span class="lineNum">    3496 </span><span class="lineCov">       1766 :     CookdEdx(track);</span>
<span class="lineNum">    3497 </span><span class="lineCov">       1766 :     track-&gt;SetFakeRatio(1.);</span>
<span class="lineNum">    3498 </span><span class="lineCov">       1766 :     CookLabel(track,0.); //For comparison only</span>
<span class="lineNum">    3499 </span>            :     //
<span class="lineNum">    3500 </span>            :     //if (chi2&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)&amp;&amp;track-&gt;fFakeRatio==0){
<span class="lineNum">    3501 </span><span class="lineCov">       1766 :     if (chi2&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)){</span>
<span class="lineNum">    3502 </span><span class="lineCov">       2824 :       if (track-&gt;GetNumberOfClusters()&lt;maxn) continue;</span>
<span class="lineNum">    3503 </span><span class="lineCov">        704 :       maxn = track-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    3504 </span>            :       //      if (fSelectBestMIP03 &amp;&amp; track-&gt;GetChi2MIP(3)&gt;0) chi2 *= track-&gt;GetChi2MIP(3); // RS    
<span class="lineNum">    3505 </span><span class="lineCov">        704 :       if (chi2&lt;minchi2){</span>
<span class="lineNum">    3506 </span>            :         minchi2=chi2;
<span class="lineNum">    3507 </span>            :         besttrack=track;
<span class="lineNum">    3508 </span><span class="lineCov">        392 :       }</span>
<span class="lineNum">    3509 </span>            :     }
<span class="lineNum">    3510 </span>            :     else{
<span class="lineNum">    3511 </span><span class="lineCov">          2 :       if (track-&gt;GetConstrain() || track-&gt;GetNumberOfClusters()&gt;5){  //keep best short tracks - without vertex constrain</span>
<span class="lineNum">    3512 </span><span class="lineCov">          4 :         delete array-&gt;RemoveAt(itrack);</span>
<span class="lineNum">    3513 </span>            :       }  
<span class="lineNum">    3514 </span>            :     }
<span class="lineNum">    3515 </span><span class="lineCov">        706 :   }</span>
<span class="lineNum">    3516 </span><span class="lineCov">        316 :   if (!besttrack) return;</span>
<span class="lineNum">    3517 </span>            :   //
<span class="lineNum">    3518 </span>            :   //
<span class="lineNum">    3519 </span>            :   //take errors of best track as a reference
<span class="lineNum">    3520 </span><span class="lineCov">        316 :   Float_t *erry = GetErrY(esdindex), *errz = GetErrZ(esdindex);</span>
<span class="lineNum">    3521 </span><span class="lineCov">        316 :   Float_t *ny = GetNy(esdindex), *nz = GetNz(esdindex);</span>
<span class="lineNum">    3522 </span><span class="lineCov">       4424 :   for (Int_t j=0;j&lt;6;j++) {</span>
<span class="lineNum">    3523 </span><span class="lineCov">       1896 :     if (besttrack-&gt;GetClIndex(j)&gt;=0){</span>
<span class="lineNum">    3524 </span><span class="lineCov">       1660 :       erry[j] = besttrack-&gt;GetSigmaY(j); erry[j+6] = besttrack-&gt;GetSigmaY(j+6);</span>
<span class="lineNum">    3525 </span><span class="lineCov">       1660 :       errz[j] = besttrack-&gt;GetSigmaZ(j); errz[j+6] = besttrack-&gt;GetSigmaZ(j+6);</span>
<span class="lineNum">    3526 </span><span class="lineCov">       1660 :       ny[j]   = besttrack-&gt;GetNy(j);</span>
<span class="lineNum">    3527 </span><span class="lineCov">       1660 :       nz[j]   = besttrack-&gt;GetNz(j);</span>
<span class="lineNum">    3528 </span><span class="lineCov">       1660 :     }</span>
<span class="lineNum">    3529 </span>            :   }
<span class="lineNum">    3530 </span>            :   //
<span class="lineNum">    3531 </span>            :   // calculate normalized chi2
<span class="lineNum">    3532 </span>            :   //
<span class="lineNum">    3533 </span><span class="lineCov">        316 :   Float_t * chi2        = new Float_t[entries];</span>
<span class="lineNum">    3534 </span><span class="lineCov">        316 :   Int_t * index         = new Int_t[entries];  </span>
<span class="lineNum">    3535 </span><span class="lineCov">       4164 :   for (Int_t i=0;i&lt;entries;i++) chi2[i] =10000;</span>
<span class="lineNum">    3536 </span><span class="lineCov">       4164 :   for (Int_t itrack=0;itrack&lt;entries;itrack++){</span>
<span class="lineNum">    3537 </span><span class="lineCov">       1766 :     AliITStrackMI * track = (AliITStrackMI*)array-&gt;At(itrack);</span>
<span class="lineNum">    3538 </span><span class="lineCov">       1766 :     if (track){</span>
<span class="lineNum">    3539 </span><span class="lineCov">       5292 :       AliDebug(2,Form(&quot;track %d  ncls %d\n&quot;,itrack,track-&gt;GetNumberOfClusters()));      </span>
<span class="lineNum">    3540 </span><span class="lineCov">       1764 :       double chi2t = GetNormalizedChi2(track, mode);</span>
<span class="lineNum">    3541 </span><span class="lineCov">       1764 :       track-&gt;SetChi2MIP(0,chi2t);</span>
<span class="lineNum">    3542 </span><span class="lineCov">       1764 :       if (chi2t&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)) {</span>
<span class="lineNum">    3543 </span><span class="lineCov">       1616 :         if (fSelectBestMIP03 &amp;&amp; track-&gt;GetChi2MIP(3)&gt;0) chi2t *= track-&gt;GetChi2MIP(3); // RS</span>
<span class="lineNum">    3544 </span><span class="lineCov">       1616 :         chi2[itrack] = chi2t;</span>
<span class="lineNum">    3545 </span><span class="lineCov">       1616 :       }</span>
<span class="lineNum">    3546 </span>            :       else{
<span class="lineNum">    3547 </span><span class="lineCov">        154 :         if (track-&gt;GetConstrain() || track-&gt;GetNumberOfClusters()&gt;5){  //keep best short tracks - without vertex constrain</span>
<span class="lineNum">    3548 </span><span class="lineCov">        284 :           delete array-&gt;RemoveAt(itrack);         </span>
<span class="lineNum">    3549 </span>            :         }
<span class="lineNum">    3550 </span>            :       }
<span class="lineNum">    3551 </span><span class="lineCov">       1764 :     }</span>
<span class="lineNum">    3552 </span>            :   }
<span class="lineNum">    3553 </span>            :   //
<span class="lineNum">    3554 </span><span class="lineCov">        316 :   TMath::Sort(entries,chi2,index,kFALSE);</span>
<span class="lineNum">    3555 </span><span class="lineCov">        316 :   besttrack = (AliITStrackMI*)array-&gt;At(index[0]);</span>
<span class="lineNum">    3556 </span><span class="lineCov">       1264 :   if(besttrack) AliDebug(2,Form(&quot;ncls best track %d\n&quot;,besttrack-&gt;GetNumberOfClusters()));</span>
<span class="lineNum">    3557 </span><span class="lineCov">        632 :   if (besttrack&amp;&amp;besttrack-&gt;GetChi2MIP(0)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)){</span>
<span class="lineNum">    3558 </span><span class="lineCov">       4424 :     for (Int_t j=0;j&lt;6;j++){</span>
<span class="lineNum">    3559 </span><span class="lineCov">       1896 :       if (besttrack-&gt;GetClIndex(j)&gt;=0){</span>
<span class="lineNum">    3560 </span><span class="lineCov">       1664 :         erry[j] = besttrack-&gt;GetSigmaY(j); erry[j+6] = besttrack-&gt;GetSigmaY(j+6);</span>
<span class="lineNum">    3561 </span><span class="lineCov">       1664 :         errz[j] = besttrack-&gt;GetSigmaZ(j); erry[j+6] = besttrack-&gt;GetSigmaY(j+6);</span>
<span class="lineNum">    3562 </span><span class="lineCov">       1664 :         ny[j]   = besttrack-&gt;GetNy(j);</span>
<span class="lineNum">    3563 </span><span class="lineCov">       1664 :         nz[j]   = besttrack-&gt;GetNz(j);</span>
<span class="lineNum">    3564 </span><span class="lineCov">       1664 :       }</span>
<span class="lineNum">    3565 </span>            :     }
<span class="lineNum">    3566 </span><span class="lineCov">        316 :   }</span>
<span class="lineNum">    3567 </span>            :   //
<span class="lineNum">    3568 </span>            :   // calculate one more time with updated normalized errors
<span class="lineNum">    3569 </span><span class="lineCov">       4164 :   for (Int_t i=0;i&lt;entries;i++) chi2[i] =10000;  </span>
<span class="lineNum">    3570 </span><span class="lineCov">       4164 :   for (Int_t itrack=0;itrack&lt;entries;itrack++){</span>
<span class="lineNum">    3571 </span><span class="lineCov">       1766 :     AliITStrackMI * track = (AliITStrackMI*)array-&gt;At(itrack);</span>
<span class="lineNum">    3572 </span><span class="lineCov">       1766 :     if (track){      </span>
<span class="lineNum">    3573 </span><span class="lineCov">       1622 :       double chi2t = GetNormalizedChi2(track, mode);</span>
<span class="lineNum">    3574 </span><span class="lineCov">       1622 :       track-&gt;SetChi2MIP(0,chi2t);</span>
<span class="lineNum">    3575 </span><span class="lineCov">       4866 :       AliDebug(2,Form(&quot;track %d  ncls %d\n&quot;,itrack,track-&gt;GetNumberOfClusters()));            </span>
<span class="lineNum">    3576 </span><span class="lineCov">       1622 :       if (track-&gt;GetChi2MIP(0)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)) {</span>
<span class="lineNum">    3577 </span><span class="lineCov">       1610 :         if (fSelectBestMIP03 &amp;&amp; track-&gt;GetChi2MIP(3)&gt;0) chi2t *= track-&gt;GetChi2MIP(3); // RS</span>
<span class="lineNum">    3578 </span><span class="lineCov">       1610 :         chi2[itrack] = chi2t;  //-0*(track-&gt;GetNumberOfClusters()+track-&gt;GetNDeadZone()); </span>
<span class="lineNum">    3579 </span><span class="lineCov">       1610 :       }</span>
<span class="lineNum">    3580 </span>            :       else {
<span class="lineNum">    3581 </span><span class="lineCov">         18 :         if (track-&gt;GetConstrain() || track-&gt;GetNumberOfClusters()&gt;5){  //keep best short tracks - without vertex constrain</span>
<span class="lineNum">    3582 </span><span class="lineCov">         12 :           delete array-&gt;RemoveAt(itrack);    </span>
<span class="lineNum">    3583 </span>            :         }
<span class="lineNum">    3584 </span>            :       }
<span class="lineNum">    3585 </span><span class="lineCov">       1622 :     }   </span>
<span class="lineNum">    3586 </span>            :   }
<span class="lineNum">    3587 </span><span class="lineCov">        316 :   entries = array-&gt;GetEntriesFast();  </span>
<span class="lineNum">    3588 </span>            :   //
<span class="lineNum">    3589 </span>            :   //
<span class="lineNum">    3590 </span><span class="lineCov">        316 :   if (entries&gt;0){</span>
<span class="lineNum">    3591 </span><span class="lineCov">        316 :     TObjArray * newarray = new TObjArray();  </span>
<span class="lineNum">    3592 </span><span class="lineCov">        316 :     TMath::Sort(entries,chi2,index,kFALSE);</span>
<span class="lineNum">    3593 </span><span class="lineCov">        316 :     besttrack = (AliITStrackMI*)array-&gt;At(index[0]);</span>
<span class="lineNum">    3594 </span><span class="lineCov">        316 :     if (besttrack){</span>
<span class="lineNum">    3595 </span><span class="lineCov">        948 :       AliDebug(2,Form(&quot;ncls best track %d     %f   %f\n&quot;,besttrack-&gt;GetNumberOfClusters(),besttrack-&gt;GetChi2MIP(0),chi2[index[0]]));</span>
<span class="lineNum">    3596 </span>            :       //
<span class="lineNum">    3597 </span><span class="lineCov">       4424 :       for (Int_t j=0;j&lt;6;j++){</span>
<span class="lineNum">    3598 </span><span class="lineCov">       3562 :         if (besttrack-&gt;GetNz(j)&gt;0&amp;&amp;besttrack-&gt;GetNy(j)&gt;0){</span>
<span class="lineNum">    3599 </span><span class="lineCov">       1666 :           erry[j] = besttrack-&gt;GetSigmaY(j); erry[j+6] = besttrack-&gt;GetSigmaY(j+6);</span>
<span class="lineNum">    3600 </span><span class="lineCov">       1666 :           errz[j] = besttrack-&gt;GetSigmaZ(j); errz[j+6] = besttrack-&gt;GetSigmaZ(j+6);</span>
<span class="lineNum">    3601 </span><span class="lineCov">       1666 :           ny[j]   = besttrack-&gt;GetNy(j);</span>
<span class="lineNum">    3602 </span><span class="lineCov">       1666 :           nz[j]   = besttrack-&gt;GetNz(j);</span>
<span class="lineNum">    3603 </span><span class="lineCov">       1666 :         }</span>
<span class="lineNum">    3604 </span>            :       }
<span class="lineNum">    3605 </span><span class="lineCov">        316 :       besttrack-&gt;SetChi2MIP(0,GetNormalizedChi2(besttrack,mode));</span>
<span class="lineNum">    3606 </span><span class="lineCov">        316 :       minchi2 = TMath::Min(besttrack-&gt;GetChi2MIP(0)+5.+besttrack-&gt;GetNUsed(), double(AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)));</span>
<span class="lineNum">    3607 </span><span class="lineCov">        316 :       Float_t minn = besttrack-&gt;GetNumberOfClusters()-3;</span>
<span class="lineNum">    3608 </span>            :       Int_t accepted=0;
<span class="lineNum">    3609 </span><span class="lineCov">       4444 :       for (Int_t i=0;i&lt;entries;i++){</span>
<span class="lineNum">    3610 </span><span class="lineCov">       1748 :         AliITStrackMI * track = (AliITStrackMI*)array-&gt;At(index[i]); </span>
<span class="lineNum">    3611 </span><span class="lineCov">       1880 :         if (!track) continue;</span>
<span class="lineNum">    3612 </span><span class="lineCov">       1616 :         if (accepted&gt;maxcut) break;</span>
<span class="lineNum">    3613 </span><span class="lineCov">       1616 :         track-&gt;SetChi2MIP(0,GetNormalizedChi2(track,mode));</span>
<span class="lineNum">    3614 </span><span class="lineCov">       2224 :         if (track-&gt;GetConstrain() || track-&gt;GetNumberOfClusters()&gt;5){  //keep best short tracks - without vertex constrain</span>
<span class="lineNum">    3615 </span><span class="lineCov">       1928 :           if (track-&gt;GetNumberOfClusters()&lt;6 &amp;&amp; (track-&gt;GetChi2MIP(0)+track-&gt;GetNUsed()&gt;minchi2)){</span>
<span class="lineNum">    3616 </span><span class="lineCov">        220 :             delete array-&gt;RemoveAt(index[i]);</span>
<span class="lineNum">    3617 </span><span class="lineCov">        110 :             continue;</span>
<span class="lineNum">    3618 </span>            :           }
<span class="lineNum">    3619 </span>            :         }
<span class="lineNum">    3620 </span><span class="lineCov">       3620 :         Bool_t shortbest = !track-&gt;GetConstrain() &amp;&amp; track-&gt;GetNumberOfClusters()&lt;6;</span>
<span class="lineNum">    3621 </span><span class="lineCov">       3012 :         if ((track-&gt;GetChi2MIP(0)+track-&gt;GetNUsed()&lt;minchi2 &amp;&amp; track-&gt;GetNumberOfClusters()&gt;=minn) ||shortbest){</span>
<span class="lineNum">    3622 </span><span class="lineCov">       2492 :           if (!shortbest) accepted++;</span>
<span class="lineNum">    3623 </span>            :           //
<span class="lineNum">    3624 </span><span class="lineCov">       1506 :           newarray-&gt;AddLast(array-&gt;RemoveAt(index[i]));      </span>
<span class="lineNum">    3625 </span><span class="lineCov">      21084 :           for (Int_t j=0;j&lt;6;j++){</span>
<span class="lineNum">    3626 </span><span class="lineCov">       9036 :             if (nz[j]==0){</span>
<span class="lineNum">    3627 </span><span class="lineNoCov">          0 :               erry[j] = track-&gt;GetSigmaY(j); erry[j+6] = track-&gt;GetSigmaY(j+6);</span>
<span class="lineNum">    3628 </span><span class="lineNoCov">          0 :               errz[j] = track-&gt;GetSigmaZ(j); errz[j]   = track-&gt;GetSigmaZ(j+6);</span>
<span class="lineNum">    3629 </span><span class="lineNoCov">          0 :               ny[j]   = track-&gt;GetNy(j);</span>
<span class="lineNum">    3630 </span><span class="lineNoCov">          0 :               nz[j]   = track-&gt;GetNz(j);</span>
<span class="lineNum">    3631 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    3632 </span>            :           }
<span class="lineNum">    3633 </span><span class="lineCov">       1506 :         }</span>
<span class="lineNum">    3634 </span>            :         else{
<span class="lineNum">    3635 </span><span class="lineNoCov">          0 :           delete array-&gt;RemoveAt(index[i]);</span>
<span class="lineNum">    3636 </span>            :         }
<span class="lineNum">    3637 </span><span class="lineCov">       1506 :       }</span>
<span class="lineNum">    3638 </span><span class="lineCov">        316 :       array-&gt;Delete();</span>
<span class="lineNum">    3639 </span><span class="lineCov">        632 :       delete fTrackHypothesys.RemoveAt(esdindex);</span>
<span class="lineNum">    3640 </span><span class="lineCov">        316 :       fTrackHypothesys.AddAt(newarray,esdindex);</span>
<span class="lineNum">    3641 </span><span class="lineCov">        316 :     }</span>
<span class="lineNum">    3642 </span>            :     else{
<span class="lineNum">    3643 </span><span class="lineNoCov">          0 :       array-&gt;Delete();</span>
<span class="lineNum">    3644 </span><span class="lineNoCov">          0 :       delete fTrackHypothesys.RemoveAt(esdindex);</span>
<span class="lineNum">    3645 </span>            :     }
<span class="lineNum">    3646 </span><span class="lineCov">        316 :   }</span>
<span class="lineNum">    3647 </span><span class="lineCov">        632 :   delete [] chi2;</span>
<span class="lineNum">    3648 </span><span class="lineCov">        632 :   delete [] index;</span>
<a name="3649"><span class="lineNum">    3649 </span><span class="lineCov">        680 : }</span></a>
<span class="lineNum">    3650 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3651 </span>            : AliITStrackMI * AliITStrackerMI::GetBestHypothesys(Int_t esdindex, AliITStrackMI * original, Int_t checkmax)
<span class="lineNum">    3652 </span>            : {
<span class="lineNum">    3653 </span>            :   //-------------------------------------------------------------
<span class="lineNum">    3654 </span>            :   // try to find best hypothesy
<span class="lineNum">    3655 </span>            :   // currently - minimal chi2 of track+backpropagated track+matching to the tpc track
<span class="lineNum">    3656 </span>            :   // RS: optionally changing this to product of Chi2MIP(0)*Chi2MIP(3) == (chi2*chi2_interpolated)
<span class="lineNum">    3657 </span>            :   //-------------------------------------------------------------
<span class="lineNum">    3658 </span><span class="lineCov">        442 :   if (fTrackHypothesys.GetEntriesFast()&lt;=esdindex) return 0;</span>
<span class="lineNum">    3659 </span><span class="lineCov">        176 :   TObjArray * array = (TObjArray*) fTrackHypothesys.At(esdindex);</span>
<span class="lineNum">    3660 </span><span class="lineCov">        194 :   if (!array) return 0;</span>
<span class="lineNum">    3661 </span><span class="lineCov">        158 :   Int_t entries = array-&gt;GetEntriesFast();</span>
<span class="lineNum">    3662 </span><span class="lineCov">        158 :   if (!entries) return 0;  </span>
<span class="lineNum">    3663 </span>            :   Float_t minchi2 = 100000;
<span class="lineNum">    3664 </span>            :   AliITStrackMI * besttrack=0;
<span class="lineNum">    3665 </span>            :   //
<span class="lineNum">    3666 </span><span class="lineCov">        158 :   AliITStrackMI * backtrack    = new AliITStrackMI(*original);</span>
<span class="lineNum">    3667 </span><span class="lineCov">        158 :   AliITStrackMI * forwardtrack = new AliITStrackMI(*original);</span>
<span class="lineNum">    3668 </span><span class="lineCov">        158 :   Double_t xyzVtx[]={GetX(),GetY(),GetZ()};     </span>
<span class="lineNum">    3669 </span><span class="lineCov">        158 :   Double_t ersVtx[]={GetSigmaX()/3.,GetSigmaY()/3.,GetSigmaZ()/3.};</span>
<span class="lineNum">    3670 </span>            :   //
<span class="lineNum">    3671 </span><span class="lineCov">       2056 :   for (Int_t i=0;i&lt;entries;i++){    </span>
<span class="lineNum">    3672 </span><span class="lineCov">        870 :     AliITStrackMI * track = (AliITStrackMI*)array-&gt;At(i);    </span>
<span class="lineNum">    3673 </span><span class="lineCov">        870 :     if (!track) continue;</span>
<span class="lineNum">    3674 </span><span class="lineCov">        870 :     Float_t sigmarfi,sigmaz;</span>
<span class="lineNum">    3675 </span><span class="lineCov">        870 :     GetDCASigma(track,sigmarfi,sigmaz);</span>
<span class="lineNum">    3676 </span><span class="lineCov">        870 :     track-&gt;SetDnorm(0,sigmarfi);</span>
<span class="lineNum">    3677 </span><span class="lineCov">        870 :     track-&gt;SetDnorm(1,sigmaz);</span>
<span class="lineNum">    3678 </span>            :     //
<span class="lineNum">    3679 </span><span class="lineCov">        870 :     track-&gt;SetChi2MIP(1,1000000);</span>
<span class="lineNum">    3680 </span><span class="lineCov">        870 :     track-&gt;SetChi2MIP(2,1000000);</span>
<span class="lineNum">    3681 </span><span class="lineCov">        870 :     track-&gt;SetChi2MIP(3,1000000);</span>
<span class="lineNum">    3682 </span>            :     //
<span class="lineNum">    3683 </span>            :     // backtrack
<span class="lineNum">    3684 </span><span class="lineCov">        870 :     backtrack = new(backtrack) AliITStrackMI(*track); </span>
<span class="lineNum">    3685 </span><span class="lineCov">        870 :     if (track-&gt;GetConstrain()) {</span>
<span class="lineNum">    3686 </span><span class="lineCov">       1132 :       if (!CorrectForPipeMaterial(backtrack,&quot;inward&quot;)) continue;</span>
<span class="lineNum">    3687 </span><span class="lineCov">        566 :       if (AliITSReconstructor::GetRecoParam()-&gt;GetImproveWithVertex()) {</span>
<span class="lineNum">    3688 </span><span class="lineNoCov">          0 :         if (fUseImproveKalman) {if (!backtrack-&gt;ImproveKalman(xyzVtx,ersVtx,0,0,0)) continue;}</span>
<span class="lineNum">    3689 </span><span class="lineNoCov">          0 :         else                   {if (!backtrack-&gt;Improve(0,xyzVtx,ersVtx)) continue;}</span>
<span class="lineNum">    3690 </span>            :       }
<span class="lineNum">    3691 </span><span class="lineCov">        566 :       backtrack-&gt;ResetCovariance(10.);      </span>
<span class="lineNum">    3692 </span><span class="lineCov">        566 :     }else{</span>
<span class="lineNum">    3693 </span><span class="lineCov">        304 :       backtrack-&gt;ResetCovariance(10.);</span>
<span class="lineNum">    3694 </span>            :     }
<span class="lineNum">    3695 </span><span class="lineCov">        870 :     backtrack-&gt;ResetClusters();</span>
<span class="lineNum">    3696 </span>            : 
<span class="lineNum">    3697 </span><span class="lineCov">        870 :     Double_t x = original-&gt;GetX();</span>
<span class="lineNum">    3698 </span><span class="lineCov">        870 :     if (!RefitAt(x,backtrack,track)) continue;</span>
<span class="lineNum">    3699 </span>            :     //
<span class="lineNum">    3700 </span><span class="lineCov">        870 :     track-&gt;SetChi2MIP(1,NormalizedChi2(backtrack,0));</span>
<span class="lineNum">    3701 </span>            :     //for (Int_t i=2;i&lt;6;i++){track-&gt;fDy[i]+=backtrack-&gt;fDy[i]; track-&gt;fDz[i]+=backtrack-&gt;fDz[i];}
<span class="lineNum">    3702 </span><span class="lineCov">        870 :     if (track-&gt;GetChi2MIP(1)&gt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(1)*6.)  continue;</span>
<span class="lineNum">    3703 </span><span class="lineCov">        870 :     track-&gt;SetChi22(GetMatchingChi2(backtrack,original));</span>
<span class="lineNum">    3704 </span>            : 
<span class="lineNum">    3705 </span><span class="lineCov">       1436 :     if ((track-&gt;GetConstrain()) &amp;&amp; track-&gt;GetChi22()&gt;90.)  continue;</span>
<span class="lineNum">    3706 </span><span class="lineCov">       1176 :     if ((!track-&gt;GetConstrain()) &amp;&amp; track-&gt;GetChi22()&gt;30.)  continue;</span>
<span class="lineNum">    3707 </span><span class="lineCov">        868 :     if ( track-&gt;GetChi22()/track-&gt;GetNumberOfClusters()&gt;11.)  continue;</span>
<span class="lineNum">    3708 </span>            : 
<span class="lineNum">    3709 </span>            : 
<span class="lineNum">    3710 </span><span class="lineCov">       1170 :     if  (!(track-&gt;GetConstrain())&amp;&amp;track-&gt;GetChi2MIP(1)&gt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(1))  continue;</span>
<span class="lineNum">    3711 </span>            :     //
<span class="lineNum">    3712 </span>            :     //forward track - without constraint
<span class="lineNum">    3713 </span><span class="lineCov">        868 :     forwardtrack = new(forwardtrack) AliITStrackMI(*original);</span>
<span class="lineNum">    3714 </span><span class="lineCov">        868 :     forwardtrack-&gt;ResetClusters();</span>
<span class="lineNum">    3715 </span><span class="lineCov">        868 :     x = track-&gt;GetX();</span>
<span class="lineNum">    3716 </span><span class="lineCov">        868 :     if (!RefitAt(x,forwardtrack,track) &amp;&amp; fSelectBestMIP03) continue;  // w/o fwd track MIP03 is meaningless</span>
<span class="lineNum">    3717 </span><span class="lineCov">        868 :     track-&gt;SetChi2MIP(2,NormalizedChi2(forwardtrack,0));    </span>
<span class="lineNum">    3718 </span><span class="lineCov">        868 :     if  (track-&gt;GetChi2MIP(2)&gt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(2)*6.0)  continue;</span>
<span class="lineNum">    3719 </span><span class="lineCov">       1170 :     if  (!(track-&gt;GetConstrain())&amp;&amp;track-&gt;GetChi2MIP(2)&gt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(2))  continue;</span>
<span class="lineNum">    3720 </span>            :     
<span class="lineNum">    3721 </span>            :     //track-&gt;fD[0] = forwardtrack-&gt;GetD(GetX(),GetY());
<span class="lineNum">    3722 </span>            :     //track-&gt;fD[1] = forwardtrack-&gt;GetZat(GetX())-GetZ();
<span class="lineNum">    3723 </span><span class="lineCov">        868 :     forwardtrack-&gt;GetDZ(GetX(),GetY(),GetZ(),track-&gt;GetDP());   //I.B.</span>
<span class="lineNum">    3724 </span><span class="lineCov">        868 :     forwardtrack-&gt;SetD(0,track-&gt;GetD(0));</span>
<span class="lineNum">    3725 </span><span class="lineCov">        868 :     forwardtrack-&gt;SetD(1,track-&gt;GetD(1));    </span>
<span class="lineNum">    3726 </span>            :     {
<span class="lineNum">    3727 </span><span class="lineCov">        868 :       Int_t list[6]={0};</span>
<span class="lineNum">    3728 </span><span class="lineCov">        868 :       AliITSRecPoint* clist[6]={0};</span>
<span class="lineNum">    3729 </span><span class="lineCov">        868 :       track-&gt;SetChi2MIP(4,GetNumberOfSharedClusters(track,esdindex,list,clist));      </span>
<span class="lineNum">    3730 </span><span class="lineCov">       1170 :       if ( (!track-&gt;GetConstrain()) &amp;&amp; track-&gt;GetChi2MIP(4)&gt;1.0) continue;</span>
<span class="lineNum">    3731 </span><span class="lineCov">       1736 :     }</span>
<span class="lineNum">    3732 </span>            :     
<span class="lineNum">    3733 </span><span class="lineCov">        868 :     track-&gt;SetChi2MIP(3,GetInterpolatedChi2(forwardtrack,backtrack));</span>
<span class="lineNum">    3734 </span><span class="lineCov">        868 :     if  ( (track-&gt;GetChi2MIP(3)&gt;6.*AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(3))) continue;    </span>
<span class="lineNum">    3735 </span><span class="lineCov">       1170 :     if  ( (!track-&gt;GetConstrain()) &amp;&amp; (track-&gt;GetChi2MIP(3)&gt;2*AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(3))) {</span>
<span class="lineNum">    3736 </span><span class="lineNoCov">          0 :       track-&gt;SetChi2MIP(3,1000);</span>
<span class="lineNum">    3737 </span><span class="lineNoCov">          0 :       continue; </span>
<span class="lineNum">    3738 </span>            :     }
<span class="lineNum">    3739 </span><span class="lineCov">        868 :     Double_t chi2 = track-&gt;GetChi2MIP(0); // +track-&gt;GetNUsed();    //RS</span>
<span class="lineNum">    3740 </span><span class="lineCov">        868 :     if (fSelectBestMIP03) chi2 *= track-&gt;GetChi2MIP(3);</span>
<span class="lineNum">    3741 </span><span class="lineCov">        868 :     else chi2 += track-&gt;GetNUsed();</span>
<span class="lineNum">    3742 </span>            :     //
<span class="lineNum">    3743 </span><span class="lineCov">      10416 :     for (Int_t ichi=0;ichi&lt;5;ichi++){</span>
<span class="lineNum">    3744 </span><span class="lineCov">       4340 :       forwardtrack-&gt;SetChi2MIP(ichi, track-&gt;GetChi2MIP(ichi));</span>
<span class="lineNum">    3745 </span>            :     }
<span class="lineNum">    3746 </span><span class="lineCov">        868 :     if (chi2 &lt; minchi2){</span>
<span class="lineNum">    3747 </span>            :       //besttrack = new AliITStrackMI(*forwardtrack);
<span class="lineNum">    3748 </span>            :       besttrack = track;
<span class="lineNum">    3749 </span><span class="lineCov">        158 :       besttrack-&gt;SetLabel(track-&gt;GetLabel());</span>
<span class="lineNum">    3750 </span><span class="lineCov">        158 :       besttrack-&gt;SetFakeRatio(track-&gt;GetFakeRatio());</span>
<span class="lineNum">    3751 </span><span class="lineCov">        158 :       minchi2   = chi2;</span>
<span class="lineNum">    3752 </span>            :       //original-&gt;fD[0] = forwardtrack-&gt;GetD(GetX(),GetY());
<span class="lineNum">    3753 </span>            :       //original-&gt;fD[1] = forwardtrack-&gt;GetZat(GetX())-GetZ();
<span class="lineNum">    3754 </span><span class="lineCov">        158 :       forwardtrack-&gt;GetDZ(GetX(),GetY(),GetZ(),original-&gt;GetDP());    //I.B.</span>
<span class="lineNum">    3755 </span><span class="lineCov">        158 :     }    </span>
<span class="lineNum">    3756 </span><span class="lineCov">       1738 :   }</span>
<span class="lineNum">    3757 </span><span class="lineCov">        316 :   delete backtrack;</span>
<span class="lineNum">    3758 </span><span class="lineCov">        316 :   delete forwardtrack;</span>
<span class="lineNum">    3759 </span>            : 
<span class="lineNum">    3760 </span><span class="lineCov">        158 :   if (!besttrack)  return 0;</span>
<span class="lineNum">    3761 </span>            : 
<span class="lineNum">    3762 </span>            :   Int_t accepted=0;
<span class="lineNum">    3763 </span><span class="lineCov">       2056 :   for (Int_t i=0;i&lt;entries;i++){    </span>
<span class="lineNum">    3764 </span><span class="lineCov">        870 :     AliITStrackMI * track = (AliITStrackMI*)array-&gt;At(i);</span>
<span class="lineNum">    3765 </span>            :    
<span class="lineNum">    3766 </span><span class="lineCov">        870 :     if (!track) continue;</span>
<span class="lineNum">    3767 </span>            :     
<span class="lineNum">    3768 </span><span class="lineCov">       2560 :     if (accepted&gt;checkmax || track-&gt;GetChi2MIP(3)&gt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(3)*6. || </span>
<span class="lineNum">    3769 </span><span class="lineCov">        868 :         (track-&gt;GetNumberOfClusters()&lt;besttrack-&gt;GetNumberOfClusters()-1.)</span>
<span class="lineNum">    3770 </span>            :         // RS: don't apply this cut when fSelectBestMIP03 is on
<span class="lineNum">    3771 </span><span class="lineCov">       2508 :         || (!fSelectBestMIP03 &amp;&amp; (track-&gt;GetChi2MIP(0)&gt;besttrack-&gt;GetChi2MIP(0)+2.*besttrack-&gt;GetNUsed()+3.))</span>
<span class="lineNum">    3772 </span>            :         ){
<span class="lineNum">    3773 </span><span class="lineCov">        530 :       if (track-&gt;GetConstrain() || track-&gt;GetNumberOfClusters()&gt;5){  //keep best short tracks - without vertex constrain</span>
<span class="lineNum">    3774 </span><span class="lineCov">        468 :         delete array-&gt;RemoveAt(i);    </span>
<span class="lineNum">    3775 </span><span class="lineCov">        234 :         continue;</span>
<span class="lineNum">    3776 </span>            :       }
<span class="lineNum">    3777 </span>            :     }
<span class="lineNum">    3778 </span>            :     else{
<span class="lineNum">    3779 </span><span class="lineCov">        488 :       accepted++;</span>
<span class="lineNum">    3780 </span>            :     }
<span class="lineNum">    3781 </span><span class="lineCov">        636 :   }</span>
<span class="lineNum">    3782 </span>            :   //
<span class="lineNum">    3783 </span><span class="lineCov">        158 :   array-&gt;Compress();</span>
<span class="lineNum">    3784 </span><span class="lineCov">        158 :   SortTrackHypothesys(esdindex,checkmax,1);</span>
<span class="lineNum">    3785 </span>            : 
<span class="lineNum">    3786 </span><span class="lineCov">        158 :   array = (TObjArray*) fTrackHypothesys.At(esdindex);</span>
<span class="lineNum">    3787 </span><span class="lineCov">        158 :   if (!array) return 0; // PH What can be the reason? Check SortTrackHypothesys</span>
<span class="lineNum">    3788 </span><span class="lineCov">        158 :   besttrack = (AliITStrackMI*)array-&gt;At(0);  </span>
<span class="lineNum">    3789 </span><span class="lineCov">        158 :   if (!besttrack)  return 0;</span>
<span class="lineNum">    3790 </span><span class="lineCov">        158 :   besttrack-&gt;SetChi2MIP(8,0);</span>
<span class="lineNum">    3791 </span><span class="lineCov">        158 :   fBestTrackIndex[esdindex]=0;</span>
<span class="lineNum">    3792 </span><span class="lineCov">        158 :   entries = array-&gt;GetEntriesFast();</span>
<span class="lineNum">    3793 </span>            :   AliITStrackMI *longtrack =0;
<span class="lineNum">    3794 </span>            :   minchi2 =1000;
<span class="lineNum">    3795 </span><span class="lineCov">        158 :   Float_t minn=besttrack-&gt;GetNumberOfClusters()+besttrack-&gt;GetNDeadZone();</span>
<span class="lineNum">    3796 </span><span class="lineCov">       1272 :   for (Int_t itrack=entries-1;itrack&gt;0;itrack--) {</span>
<span class="lineNum">    3797 </span><span class="lineCov">        478 :     AliITStrackMI * track = (AliITStrackMI*)array-&gt;At(itrack);</span>
<span class="lineNum">    3798 </span><span class="lineCov">        776 :     if (!track-&gt;GetConstrain()) continue;</span>
<span class="lineNum">    3799 </span><span class="lineCov">        304 :     if (track-&gt;GetNumberOfClusters()+track-&gt;GetNDeadZone()&lt;minn) continue;</span>
<span class="lineNum">    3800 </span><span class="lineCov">        112 :     if (track-&gt;GetChi2MIP(0)-besttrack-&gt;GetChi2MIP(0)&gt;0.0) continue;</span>
<span class="lineNum">    3801 </span><span class="lineNoCov">          0 :     if (track-&gt;GetChi2MIP(0)&gt;4.) continue;</span>
<span class="lineNum">    3802 </span><span class="lineNoCov">          0 :     minn = track-&gt;GetNumberOfClusters()+track-&gt;GetNDeadZone();</span>
<span class="lineNum">    3803 </span>            :     longtrack =track;
<span class="lineNum">    3804 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    3805 </span>            :   //if (longtrack) besttrack=longtrack;
<span class="lineNum">    3806 </span>            :   //
<span class="lineNum">    3807 </span>            :   // RS do shared cluster analysis here only if the new sharing analysis is not requested
<span class="lineNum">    3808 </span>            :   //RRR if (fFlagFakes) return besttrack;
<span class="lineNum">    3809 </span>            : 
<span class="lineNum">    3810 </span><span class="lineCov">        158 :   Int_t list[6]={0};</span>
<span class="lineNum">    3811 </span><span class="lineCov">        158 :   AliITSRecPoint * clist[6]={0};</span>
<span class="lineNum">    3812 </span><span class="lineCov">        158 :   Float_t shared = GetNumberOfSharedClusters(besttrack,esdindex,list,clist);</span>
<span class="lineNum">    3813 </span><span class="lineCov">        614 :   if (besttrack-&gt;GetConstrain()&amp;&amp;besttrack-&gt;GetChi2MIP(0)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(0)&amp;&amp;besttrack-&gt;GetChi2MIP(1)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(1)</span>
<span class="lineNum">    3814 </span><span class="lineCov">        456 :       &amp;&amp;besttrack-&gt;GetChi2MIP(2)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(2)&amp;&amp;besttrack-&gt;GetChi2MIP(3)&lt;AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2PerCluster(3)){ </span>
<span class="lineNum">    3815 </span><span class="lineCov">        144 :     RegisterClusterTracks(besttrack,esdindex);</span>
<span class="lineNum">    3816 </span><span class="lineCov">        144 :   }</span>
<span class="lineNum">    3817 </span>            :   //
<span class="lineNum">    3818 </span>            :   //
<span class="lineNum">    3819 </span><span class="lineCov">        158 :   if (shared&gt;0.0){</span>
<span class="lineNum">    3820 </span><span class="lineCov">          4 :     Int_t nshared;</span>
<span class="lineNum">    3821 </span><span class="lineCov">          4 :     Int_t overlist[6]={0};</span>
<span class="lineNum">    3822 </span><span class="lineCov">          4 :     Int_t sharedtrack = GetOverlapTrack(besttrack, esdindex, nshared, list, overlist);</span>
<span class="lineNum">    3823 </span><span class="lineCov">          4 :     if (sharedtrack&gt;=0){</span>
<span class="lineNum">    3824 </span>            :       //
<span class="lineNum">    3825 </span><span class="lineCov">          4 :       besttrack = GetBest2Tracks(esdindex,sharedtrack,10,5.5,original);     </span>
<span class="lineNum">    3826 </span><span class="lineCov">          4 :       if (besttrack){</span>
<span class="lineNum">    3827 </span><span class="lineCov">          4 :         shared = GetNumberOfSharedClusters(besttrack,esdindex,list,clist);</span>
<span class="lineNum">    3828 </span>            :       }
<span class="lineNum">    3829 </span><span class="lineNoCov">          0 :       else return 0;</span>
<span class="lineNum">    3830 </span><span class="lineCov">          4 :     }</span>
<span class="lineNum">    3831 </span><span class="lineCov">          8 :   }  </span>
<span class="lineNum">    3832 </span>            :   
<span class="lineNum">    3833 </span><span class="lineCov">        158 :   if (shared&gt;2.5) return 0;</span>
<span class="lineNum">    3834 </span><span class="lineCov">        158 :   if (shared&gt;1.0) return besttrack;</span>
<span class="lineNum">    3835 </span>            :   //
<span class="lineNum">    3836 </span>            :   // Don't sign clusters if not gold track
<span class="lineNum">    3837 </span>            :   //
<span class="lineNum">    3838 </span><span class="lineCov">        316 :   if (!besttrack-&gt;IsGoldPrimary()) return besttrack;</span>
<span class="lineNum">    3839 </span><span class="lineNoCov">          0 :   if (besttrack-&gt;GetESDtrack()-&gt;GetKinkIndex(0)!=0) return besttrack;   //track belong to kink</span>
<span class="lineNum">    3840 </span>            :   //
<span class="lineNum">    3841 </span><span class="lineNoCov">          0 :   if (fConstraint[fPass]){</span>
<span class="lineNum">    3842 </span>            :     //
<span class="lineNum">    3843 </span>            :     // sign clusters
<span class="lineNum">    3844 </span>            :     //
<span class="lineNum">    3845 </span><span class="lineNoCov">          0 :     Float_t *ny = GetNy(esdindex), *nz = GetNz(esdindex);</span>
<span class="lineNum">    3846 </span><span class="lineNoCov">          0 :     for (Int_t i=0;i&lt;6;i++){</span>
<span class="lineNum">    3847 </span><span class="lineNoCov">          0 :       Int_t index = besttrack-&gt;GetClIndex(i);</span>
<span class="lineNum">    3848 </span><span class="lineNoCov">          0 :       if (index&lt;0) continue; </span>
<span class="lineNum">    3849 </span><span class="lineNoCov">          0 :       Int_t ilayer =  (index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">    3850 </span><span class="lineNoCov">          0 :       if (besttrack-&gt;GetSigmaY(ilayer)&lt;0.00000000001) continue;</span>
<span class="lineNum">    3851 </span><span class="lineNoCov">          0 :       AliITSRecPoint *c = (AliITSRecPoint*)GetCluster(index);     </span>
<span class="lineNum">    3852 </span><span class="lineNoCov">          0 :       if (!c) continue;</span>
<span class="lineNum">    3853 </span><span class="lineNoCov">          0 :       if (ilayer&gt;3&amp;&amp;c-&gt;GetNy()+c-&gt;GetNz()&gt;6) continue;</span>
<span class="lineNum">    3854 </span><span class="lineNoCov">          0 :       if ( (c-&gt;GetNy()+c-&gt;GetNz() )&gt; ny[i]+nz[i]+0.7) continue; //shared track</span>
<span class="lineNum">    3855 </span><span class="lineNoCov">          0 :       if (  c-&gt;GetNz()&gt; nz[i]+0.7) continue; //shared track</span>
<span class="lineNum">    3856 </span><span class="lineNoCov">          0 :       if ( ilayer&gt;2&amp;&amp; AliITSReconstructor::GetRecoParam()-&gt;GetUseAmplitudeInfo(ilayer)) </span>
<span class="lineNum">    3857 </span><span class="lineNoCov">          0 :         if (besttrack-&gt;GetNormQ(ilayer)/besttrack-&gt;GetExpQ()&gt;1.5) continue;</span>
<span class="lineNum">    3858 </span>            :       //if (  c-&gt;GetNy()&gt; ny[i]+0.7) continue; //shared track
<span class="lineNum">    3859 </span>            : 
<span class="lineNum">    3860 </span>            :       Bool_t cansign = kTRUE;
<span class="lineNum">    3861 </span><span class="lineNoCov">          0 :       for (Int_t itrack=0;itrack&lt;entries; itrack++){</span>
<span class="lineNum">    3862 </span><span class="lineNoCov">          0 :         AliITStrackMI * track = (AliITStrackMI*)array-&gt;At(i);   </span>
<span class="lineNum">    3863 </span><span class="lineNoCov">          0 :         if (!track) continue;</span>
<span class="lineNum">    3864 </span><span class="lineNoCov">          0 :         if (track-&gt;GetChi2MIP(0)&gt;besttrack-&gt;GetChi2MIP(0)+2.*shared+1.) break;</span>
<span class="lineNum">    3865 </span><span class="lineNoCov">          0 :         if ( (track-&gt;GetClIndex(ilayer)&gt;=0) &amp;&amp; (track-&gt;GetClIndex(ilayer)!=besttrack-&gt;GetClIndex(ilayer))){</span>
<span class="lineNum">    3866 </span>            :           cansign = kFALSE;
<span class="lineNum">    3867 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    3868 </span>            :         }
<span class="lineNum">    3869 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3870 </span><span class="lineNoCov">          0 :       if (cansign){</span>
<span class="lineNum">    3871 </span><span class="lineNoCov">          0 :         if (TMath::Abs(besttrack-&gt;GetDy(ilayer)/besttrack-&gt;GetSigmaY(ilayer))&gt;3.) continue;</span>
<span class="lineNum">    3872 </span><span class="lineNoCov">          0 :         if (TMath::Abs(besttrack-&gt;GetDz(ilayer)/besttrack-&gt;GetSigmaZ(ilayer))&gt;3.) continue;    </span>
<span class="lineNum">    3873 </span><span class="lineNoCov">          0 :         if (!c-&gt;IsUsed()) c-&gt;Use();</span>
<span class="lineNum">    3874 </span>            :       }
<span class="lineNum">    3875 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3876 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    3877 </span><span class="lineNoCov">          0 :   return besttrack;</span>
<a name="3878"><span class="lineNum">    3878 </span><span class="lineCov">        522 : } </span></a>
<span class="lineNum">    3879 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3880 </span>            : void  AliITStrackerMI::GetBestHypothesysMIP(TObjArray &amp;itsTracks)
<span class="lineNum">    3881 </span>            : {
<span class="lineNum">    3882 </span>            :   //
<span class="lineNum">    3883 </span>            :   // get &quot;best&quot; hypothesys
<span class="lineNum">    3884 </span>            :   //
<span class="lineNum">    3885 </span>            : 
<span class="lineNum">    3886 </span><span class="lineCov">         32 :   Int_t nentries = itsTracks.GetEntriesFast();</span>
<span class="lineNum">    3887 </span><span class="lineCov">        472 :   for (Int_t i=0;i&lt;nentries;i++){</span>
<span class="lineNum">    3888 </span><span class="lineCov">        220 :     AliITStrackMI* track = (AliITStrackMI*)itsTracks.At(i);</span>
<span class="lineNum">    3889 </span><span class="lineCov">        220 :     if (!track) continue;</span>
<span class="lineNum">    3890 </span><span class="lineCov">        220 :     TObjArray * array = (TObjArray*) fTrackHypothesys.At(i);</span>
<span class="lineNum">    3891 </span><span class="lineCov">        282 :     if (!array) continue;</span>
<span class="lineNum">    3892 </span><span class="lineCov">        158 :     if (array-&gt;GetEntriesFast()&lt;=0) continue;</span>
<span class="lineNum">    3893 </span>            :     //
<span class="lineNum">    3894 </span>            :     AliITStrackMI* longtrack=0;
<span class="lineNum">    3895 </span>            :     Float_t minn=0;
<span class="lineNum">    3896 </span>            :     Float_t maxchi2=1000;
<span class="lineNum">    3897 </span><span class="lineCov">       1746 :     for (Int_t j=0;j&lt;array-&gt;GetEntriesFast();j++){</span>
<span class="lineNum">    3898 </span><span class="lineCov">        636 :       AliITStrackMI* trackHyp = (AliITStrackMI*)array-&gt;At(j);</span>
<span class="lineNum">    3899 </span><span class="lineCov">        636 :       if (!trackHyp) continue;</span>
<span class="lineNum">    3900 </span><span class="lineCov">        636 :       if (trackHyp-&gt;GetGoldV0()) {</span>
<span class="lineNum">    3901 </span>            :         longtrack = trackHyp;   //gold V0 track taken
<span class="lineNum">    3902 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    3903 </span>            :       }
<span class="lineNum">    3904 </span><span class="lineCov">        954 :       if (trackHyp-&gt;GetNumberOfClusters()+trackHyp-&gt;GetNDeadZone()&lt;minn) continue;</span>
<span class="lineNum">    3905 </span><span class="lineCov">        318 :       Float_t chi2 = trackHyp-&gt;GetChi2MIP(0);</span>
<span class="lineNum">    3906 </span><span class="lineCov">        318 :       if (fSelectBestMIP03) chi2 *= trackHyp-&gt;GetChi2MIP(3);</span>
<span class="lineNum">    3907 </span><span class="lineCov">        478 :       if (trackHyp-&gt;GetNumberOfClusters()+trackHyp-&gt;GetNDeadZone()&gt;minn) maxchi2 = chi2; //trackHyp-&gt;GetChi2MIP(0);</span>
<span class="lineNum">    3908 </span>            :       //
<span class="lineNum">    3909 </span><span class="lineCov">        318 :       if (fAfterV0){ // ??? RS</span>
<span class="lineNum">    3910 </span><span class="lineCov">        578 :         if (!trackHyp-&gt;GetGoldV0()&amp;&amp;trackHyp-&gt;GetConstrain()==kFALSE) chi2+=5;</span>
<span class="lineNum">    3911 </span>            :       }
<span class="lineNum">    3912 </span><span class="lineCov">        484 :       if (chi2 &gt; maxchi2) continue;</span>
<span class="lineNum">    3913 </span><span class="lineCov">        152 :       minn = trackHyp-&gt;GetNumberOfClusters()+trackHyp-&gt;GetNDeadZone();</span>
<span class="lineNum">    3914 </span><span class="lineCov">        152 :       if (fSelectBestMIP03) minn++; // allow next to longest to win</span>
<span class="lineNum">    3915 </span>            :       maxchi2 = chi2;
<span class="lineNum">    3916 </span>            :       longtrack=trackHyp;
<span class="lineNum">    3917 </span><span class="lineCov">        152 :     }    </span>
<span class="lineNum">    3918 </span>            :     //
<span class="lineNum">    3919 </span>            :     //
<span class="lineNum">    3920 </span>            :     //
<span class="lineNum">    3921 </span><span class="lineCov">        158 :     AliITStrackMI * besttrack = (AliITStrackMI*)array-&gt;At(0);</span>
<span class="lineNum">    3922 </span><span class="lineCov">        164 :     if (!longtrack) {longtrack = besttrack;}</span>
<span class="lineNum">    3923 </span>            :     else besttrack= longtrack;
<span class="lineNum">    3924 </span>            :     //
<span class="lineNum">    3925 </span><span class="lineCov">        158 :     if (besttrack) {</span>
<span class="lineNum">    3926 </span><span class="lineCov">        158 :       Int_t list[6]={0};</span>
<span class="lineNum">    3927 </span><span class="lineCov">        158 :       AliITSRecPoint * clist[6]={0};</span>
<span class="lineNum">    3928 </span><span class="lineCov">        158 :       Float_t shared = GetNumberOfSharedClusters(longtrack,i,list,clist);</span>
<span class="lineNum">    3929 </span>            :       //
<span class="lineNum">    3930 </span><span class="lineCov">        158 :       track-&gt;SetNUsed(shared);      </span>
<span class="lineNum">    3931 </span><span class="lineCov">        158 :       track-&gt;SetNSkipped(besttrack-&gt;GetNSkipped());</span>
<span class="lineNum">    3932 </span><span class="lineCov">        158 :       track-&gt;SetChi2MIP(0,besttrack-&gt;GetChi2MIP(0));</span>
<span class="lineNum">    3933 </span><span class="lineCov">        158 :       if (shared&gt;0) {</span>
<span class="lineNum">    3934 </span><span class="lineCov">          6 :         if(!AliITSReconstructor::GetRecoParam()-&gt;GetAllowSharedClusters()) continue;</span>
<span class="lineNum">    3935 </span><span class="lineCov">          6 :         Int_t nshared;</span>
<span class="lineNum">    3936 </span><span class="lineCov">          6 :         Int_t overlist[6]={0}; </span>
<span class="lineNum">    3937 </span>            :         //
<span class="lineNum">    3938 </span><span class="lineCov">          6 :         Int_t sharedtrack = GetOverlapTrack(longtrack, i, nshared, list, overlist);</span>
<span class="lineNum">    3939 </span>            :         //if (sharedtrack==-1) sharedtrack=0;
<span class="lineNum">    3940 </span><span class="lineCov">          6 :         if (sharedtrack&gt;=0) {       </span>
<span class="lineNum">    3941 </span><span class="lineCov">          6 :           besttrack = GetBest2Tracks(i,sharedtrack,10,5.5,track);                         </span>
<span class="lineNum">    3942 </span><span class="lineCov">          6 :         }</span>
<span class="lineNum">    3943 </span><span class="lineCov">          6 :       }   </span>
<span class="lineNum">    3944 </span><span class="lineCov">        316 :       if (besttrack&amp;&amp;fAfterV0) {</span>
<span class="lineNum">    3945 </span><span class="lineCov">        122 :         UpdateESDtrack(besttrack,AliESDtrack::kITSin);</span>
<span class="lineNum">    3946 </span><span class="lineCov">        122 :         track-&gt;SetWinner(besttrack);</span>
<span class="lineNum">    3947 </span><span class="lineCov">        122 :       }</span>
<span class="lineNum">    3948 </span><span class="lineCov">        158 :       if (besttrack) {</span>
<span class="lineNum">    3949 </span><span class="lineCov">        158 :         if (fConstraint[fPass]) {</span>
<span class="lineNum">    3950 </span><span class="lineCov">         76 :           UpdateESDtrack(besttrack,AliESDtrack::kITSin);</span>
<span class="lineNum">    3951 </span><span class="lineCov">         76 :           track-&gt;SetWinner(besttrack);</span>
<span class="lineNum">    3952 </span><span class="lineCov">         76 :         }</span>
<span class="lineNum">    3953 </span><span class="lineCov">        280 :         if (besttrack-&gt;GetChi2MIP(0)+besttrack-&gt;GetNUsed()&gt;1.5 &amp;&amp; fConstraint[fPass]) {</span>
<span class="lineNum">    3954 </span><span class="lineCov">        116 :           if ( TMath::Abs(besttrack-&gt;GetD(0))&gt;0.1 || </span>
<span class="lineNum">    3955 </span><span class="lineCov">         58 :                TMath::Abs(besttrack-&gt;GetD(1))&gt;0.1 ) track-&gt;SetReconstructed(kFALSE);   </span>
<span class="lineNum">    3956 </span>            :         }       
<span class="lineNum">    3957 </span>            :       }
<span class="lineNum">    3958 </span><span class="lineCov">        316 :     }</span>
<span class="lineNum">    3959 </span><span class="lineCov">        158 :   }</span>
<span class="lineNum">    3960 </span><span class="lineCov">         16 : } </span>
<a name="3961"><span class="lineNum">    3961 </span>            : </a>
<span class="lineNum">    3962 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    3963 </span>            : void AliITStrackerMI::FlagFakes(const TObjArray &amp;itsTracks)
<span class="lineNum">    3964 </span>            : {
<span class="lineNum">    3965 </span>            :   //
<span class="lineNum">    3966 </span>            :   // RS: flag those tracks which are suxpected to have fake clusters
<span class="lineNum">    3967 </span>            :   //
<span class="lineNum">    3968 </span>            :   const double kThreshPt = 0.5;
<span class="lineNum">    3969 </span><span class="lineNoCov">          0 :   AliRefArray *refArr[6]={0};</span>
<span class="lineNum">    3970 </span>            :   //
<span class="lineNum">    3971 </span><span class="lineNoCov">          0 :   for (int i=0;i&lt;6;i++) {</span>
<span class="lineNum">    3972 </span><span class="lineNoCov">          0 :     int ncl = fgLayers[i].GetNumberOfClusters();</span>
<span class="lineNum">    3973 </span><span class="lineNoCov">          0 :     refArr[i] = new AliRefArray(ncl,TMath::Min(ncl,1000));</span>
<span class="lineNum">    3974 </span>            :   }
<span class="lineNum">    3975 </span><span class="lineNoCov">          0 :   Int_t nentries = itsTracks.GetEntriesFast();</span>
<span class="lineNum">    3976 </span>            :   //
<span class="lineNum">    3977 </span>            :   // fill cluster-&gt;track associations
<span class="lineNum">    3978 </span><span class="lineNoCov">          0 :   for (Int_t itr=0;itr&lt;nentries;itr++){</span>
<span class="lineNum">    3979 </span><span class="lineNoCov">          0 :     AliITStrackMI* track = (AliITStrackMI*)itsTracks.UncheckedAt(itr);   </span>
<span class="lineNum">    3980 </span><span class="lineNoCov">          0 :     if (!track) continue;</span>
<span class="lineNum">    3981 </span><span class="lineNoCov">          0 :     AliITStrackMI* trackITS = track-&gt;GetWinner();</span>
<span class="lineNum">    3982 </span><span class="lineNoCov">          0 :     if (!trackITS) continue;</span>
<span class="lineNum">    3983 </span><span class="lineNoCov">          0 :     for (int il=trackITS-&gt;GetNumberOfClusters();il--;) {</span>
<span class="lineNum">    3984 </span><span class="lineNoCov">          0 :       int idx = trackITS-&gt;GetClusterIndex(il);</span>
<span class="lineNum">    3985 </span><span class="lineNoCov">          0 :       Int_t l=(idx &amp; 0xf0000000) &gt;&gt; 28, c=(idx &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">    3986 </span>            :       //      if (c&gt;fgLayers[l].GetNumberOfClusters()) continue;
<span class="lineNum">    3987 </span><span class="lineNoCov">          0 :       refArr[l]-&gt;AddReference(c, itr);</span>
<span class="lineNum">    3988 </span>            :     }
<span class="lineNum">    3989 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    3990 </span>            :   //
<span class="lineNum">    3991 </span>            :   const UInt_t kMaxRef = 100;
<span class="lineNum">    3992 </span><span class="lineNoCov">          0 :   UInt_t crefs[kMaxRef]={0};</span>
<span class="lineNum">    3993 </span>            :   Int_t ncrefs=0;
<span class="lineNum">    3994 </span>            :   // process tracks with shared clusters
<span class="lineNum">    3995 </span><span class="lineNoCov">          0 :   for (int itr=0;itr&lt;nentries;itr++){</span>
<span class="lineNum">    3996 </span><span class="lineNoCov">          0 :     AliITStrackMI* track0 = (AliITStrackMI*)itsTracks.UncheckedAt(itr);  </span>
<span class="lineNum">    3997 </span><span class="lineNoCov">          0 :     AliITStrackMI* trackH0 = track0-&gt;GetWinner(); </span>
<span class="lineNum">    3998 </span><span class="lineNoCov">          0 :     if (!trackH0) continue;</span>
<span class="lineNum">    3999 </span><span class="lineNoCov">          0 :     AliESDtrack* esd0 = track0-&gt;GetESDtrack();</span>
<span class="lineNum">    4000 </span>            :     //
<span class="lineNum">    4001 </span><span class="lineNoCov">          0 :     for (int il=0;il&lt;trackH0-&gt;GetNumberOfClusters();il++) {</span>
<span class="lineNum">    4002 </span><span class="lineNoCov">          0 :       int idx = trackH0-&gt;GetClusterIndex(il);</span>
<span class="lineNum">    4003 </span><span class="lineNoCov">          0 :       Int_t l=(idx &amp; 0xf0000000) &gt;&gt; 28, c=(idx &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">    4004 </span><span class="lineNoCov">          0 :       ncrefs = refArr[l]-&gt;GetReferences(c,crefs,kMaxRef);                </span>
<span class="lineNum">    4005 </span><span class="lineNoCov">          0 :       if (ncrefs&lt;2) continue; // there will be always self-reference, for sharing needs at least 2</span>
<span class="lineNum">    4006 </span><span class="lineNoCov">          0 :       esd0-&gt;SetITSSharedFlag(l); </span>
<span class="lineNum">    4007 </span><span class="lineNoCov">          0 :       for (int ir=ncrefs;ir--;) {</span>
<span class="lineNum">    4008 </span><span class="lineNoCov">          0 :         if (int(crefs[ir]) &lt;= itr) continue; // ==:selfreference, &lt;: the same pair will be checked with &gt;</span>
<span class="lineNum">    4009 </span><span class="lineNoCov">          0 :         AliITStrackMI* track1 = (AliITStrackMI*)itsTracks.UncheckedAt(crefs[ir]);</span>
<span class="lineNum">    4010 </span><span class="lineNoCov">          0 :         AliITStrackMI* trackH1 = track1-&gt;GetWinner(); </span>
<span class="lineNum">    4011 </span><span class="lineNoCov">          0 :         AliESDtrack* esd1 = track1-&gt;GetESDtrack();</span>
<span class="lineNum">    4012 </span><span class="lineNoCov">          0 :         esd1-&gt;SetITSSharedFlag(l);</span>
<span class="lineNum">    4013 </span>            :         //
<span class="lineNum">    4014 </span><span class="lineNoCov">          0 :         double pt0 = trackH0-&gt;Pt(), pt1 = trackH1-&gt;Pt(), res = 0.;        </span>
<span class="lineNum">    4015 </span><span class="lineNoCov">          0 :         if      (pt0&gt;kThreshPt &amp;&amp; pt0-pt1&gt;0.2+0.2*(pt0-kThreshPt) ) res = -100;</span>
<span class="lineNum">    4016 </span><span class="lineNoCov">          0 :         else if (pt1&gt;kThreshPt &amp;&amp; pt1-pt0&gt;0.2+0.2*(pt1-kThreshPt) ) res = 100;</span>
<span class="lineNum">    4017 </span>            : 
<span class="lineNum">    4018 </span>            :         // select the one with smallest chi2's product
<span class="lineNum">    4019 </span><span class="lineNoCov">          0 :         res += trackH0-&gt;GetChi2MIP(0)*trackH0-&gt;GetChi2MIP(3); </span>
<span class="lineNum">    4020 </span><span class="lineNoCov">          0 :         res -= trackH1-&gt;GetChi2MIP(0)*trackH1-&gt;GetChi2MIP(3);</span>
<span class="lineNum">    4021 </span>            :         //
<span class="lineNum">    4022 </span><span class="lineNoCov">          0 :         if (res&lt;0) esd1-&gt;SetITSFakeFlag();  // esd0 is winner</span>
<span class="lineNum">    4023 </span><span class="lineNoCov">          0 :         else       esd0-&gt;SetITSFakeFlag();  // esd1 is winner</span>
<span class="lineNum">    4024 </span>            :       }
<span class="lineNum">    4025 </span>            :       //
<span class="lineNum">    4026 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    4027 </span>            :     //
<span class="lineNum">    4028 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    4029 </span>            :   //
<span class="lineNum">    4030 </span><span class="lineNoCov">          0 :   for (int i=6;i--;) delete refArr[i];</span>
<span class="lineNum">    4031 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4032 </span>            : 
<span class="lineNum">    4033 </span>            : 
<a name="4034"><span class="lineNum">    4034 </span>            : </a>
<span class="lineNum">    4035 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4036 </span>            : void AliITStrackerMI::CookLabel(AliITStrackMI *track,Float_t wrong) const {
<span class="lineNum">    4037 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    4038 </span>            :   //This function &quot;cooks&quot; a track label. If label&lt;0, this track is fake.
<span class="lineNum">    4039 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    4040 </span>            :   const int kMaxLbPerCl = 3;
<span class="lineNum">    4041 </span><span class="lineCov">       5064 :   int lbID[36]={0},lbStat[36]={0};</span>
<span class="lineNum">    4042 </span><span class="lineCov">       2532 :   Int_t nLab=0, nCl = track-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    4043 </span>            :   //
<span class="lineNum">    4044 </span>            :   //  track-&gt;SetLabel(-1);
<span class="lineNum">    4045 </span>            :   //  track-&gt;SetFakeRatio(0);
<span class="lineNum">    4046 </span>            :   //
<span class="lineNum">    4047 </span><span class="lineCov">      28420 :   for (Int_t i=0;i&lt;nCl;i++) { // fill all labels</span>
<span class="lineNum">    4048 </span><span class="lineCov">      11678 :     Int_t cindex = track-&gt;GetClusterIndex(i);</span>
<span class="lineNum">    4049 </span>            :     //    Int_t l=(cindex &amp; 0xf0000000) &gt;&gt; 28;
<span class="lineNum">    4050 </span><span class="lineCov">      11678 :     AliITSRecPoint *cl = (AliITSRecPoint*)GetCluster(cindex);</span>
<span class="lineNum">    4051 </span>            :     //
<span class="lineNum">    4052 </span><span class="lineCov">      40014 :     for (int imc=0;imc&lt;kMaxLbPerCl;imc++) { // labels within single cluster</span>
<span class="lineNum">    4053 </span><span class="lineCov">      19968 :       int trLb = cl-&gt;GetLabel(imc);</span>
<span class="lineNum">    4054 </span><span class="lineCov">      31620 :       if (trLb&lt;0) break;</span>
<span class="lineNum">    4055 </span>            :       // search this mc track in already accounted ones
<span class="lineNum">    4056 </span>            :       int iLab;
<span class="lineNum">    4057 </span><span class="lineCov">      23201 :       for (iLab=0;iLab&lt;nLab;iLab++) if (lbID[iLab]==trLb) break;</span>
<span class="lineNum">    4058 </span><span class="lineCov">      13985 :       if (iLab&lt;nLab) lbStat[iLab]++;</span>
<span class="lineNum">    4059 </span>            :       else {
<span class="lineNum">    4060 </span><span class="lineCov">       2647 :         lbID[nLab] = trLb;</span>
<span class="lineNum">    4061 </span><span class="lineCov">       2647 :         lbStat[nLab++] = 1;</span>
<span class="lineNum">    4062 </span>            :       }
<span class="lineNum">    4063 </span><span class="lineCov">       8316 :     } // loop over given cluster's labels   </span>
<span class="lineNum">    4064 </span>            :   } // loop over clusters
<span class="lineNum">    4065 </span>            :   //
<span class="lineNum">    4066 </span><span class="lineCov">       2579 :   if (nLab&lt;1) return; // no labels at all</span>
<span class="lineNum">    4067 </span>            :   //
<span class="lineNum">    4068 </span>            :   Int_t tpcLabel=-1; 
<span class="lineNum">    4069 </span><span class="lineCov">       4970 :   if (track-&gt;GetESDtrack() &amp;&amp; track-&gt;GetESDtrack()-&gt;IsOn(AliESDtrack::kTPCin)){</span>
<span class="lineNum">    4070 </span><span class="lineCov">       2453 :     tpcLabel = TMath::Abs(track-&gt;GetESDtrack()-&gt;GetTPCLabel());</span>
<span class="lineNum">    4071 </span><span class="lineCov">       2453 :   }</span>
<span class="lineNum">    4072 </span>            :   //
<span class="lineNum">    4073 </span>            :   // find majority label
<span class="lineNum">    4074 </span><span class="lineCov">       2485 :   if (nCl &amp;&amp; nLab) {</span>
<span class="lineNum">    4075 </span>            :     int maxLab=0,tpcLabID=-1;
<span class="lineNum">    4076 </span><span class="lineCov">      10264 :     for (int ilb=nLab;ilb--;) {</span>
<span class="lineNum">    4077 </span><span class="lineCov">       2647 :       int st = lbStat[ilb];</span>
<span class="lineNum">    4078 </span><span class="lineCov">       2651 :       if (lbStat[maxLab]&lt;st) maxLab = ilb;</span>
<span class="lineNum">    4079 </span><span class="lineCov">       3884 :       if (lbID[ilb] == tpcLabel) tpcLabID = ilb;</span>
<span class="lineNum">    4080 </span>            :     }
<span class="lineNum">    4081 </span>            :     // if there is an equal choice, prefer ITS label consistent with TPC label
<span class="lineNum">    4082 </span><span class="lineCov">       3722 :     if (tpcLabID&gt;=0 &amp;&amp; (tpcLabID!=maxLab) &amp;&amp; lbStat[maxLab]==lbStat[tpcLabID]) maxLab=tpcLabID;</span>
<span class="lineNum">    4083 </span>            :                                                                                
<span class="lineNum">    4084 </span><span class="lineCov">       2485 :     track-&gt;SetFakeRatio(1.-float(lbStat[maxLab])/nCl);</span>
<span class="lineNum">    4085 </span><span class="lineCov">       2485 :     track-&gt;SetLabel( lbStat[maxLab]&gt;=nCl-wrong ? lbID[maxLab] : -lbID[maxLab]);</span>
<span class="lineNum">    4086 </span><span class="lineCov">       2485 :   }</span>
<span class="lineNum">    4087 </span>            :   //
<span class="lineNum">    4088 </span><span class="lineCov">       5017 : }</span>
<span class="lineNum">    4089 </span>            : 
<span class="lineNum">    4090 </span>            : /*
<span class="lineNum">    4091 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4092 </span>            : void AliITStrackerMI::CookLabel(AliITStrackMI *track,Float_t wrong) const {
<span class="lineNum">    4093 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    4094 </span>            :   //This function &quot;cooks&quot; a track label. If label&lt;0, this track is fake.
<span class="lineNum">    4095 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    4096 </span>            :   Int_t tpcLabel=-1; 
<span class="lineNum">    4097 </span>            :      
<span class="lineNum">    4098 </span>            :   if (track-&gt;GetESDtrack()){
<span class="lineNum">    4099 </span>            :     tpcLabel = track-&gt;GetESDtrack()-&gt;GetTPCLabel();
<span class="lineNum">    4100 </span>            :     ULong_t trStatus=track-&gt;GetESDtrack()-&gt;GetStatus();
<span class="lineNum">    4101 </span>            :     if(!(trStatus&amp;AliESDtrack::kTPCin)) tpcLabel=track-&gt;GetLabel(); // for ITSsa tracks
<span class="lineNum">    4102 </span>            :   }
<span class="lineNum">    4103 </span>            :    track-&gt;SetChi2MIP(9,0);
<span class="lineNum">    4104 </span>            :    Int_t nwrong=0;
<span class="lineNum">    4105 </span>            :    for (Int_t i=0;i&lt;track-&gt;GetNumberOfClusters();i++){
<span class="lineNum">    4106 </span>            :      Int_t cindex = track-&gt;GetClusterIndex(i);
<span class="lineNum">    4107 </span>            :      Int_t l=(cindex &amp; 0xf0000000) &gt;&gt; 28;
<span class="lineNum">    4108 </span>            :      AliITSRecPoint *cl = (AliITSRecPoint*)GetCluster(cindex);
<span class="lineNum">    4109 </span>            :      Int_t isWrong=1;
<span class="lineNum">    4110 </span>            :      for (Int_t ind=0;ind&lt;3;ind++){
<span class="lineNum">    4111 </span>            :        if (cl-&gt;GetLabel(ind)==TMath::Abs(tpcLabel)) isWrong=0;
<span class="lineNum">    4112 </span>            :        //AliDebug(2,Form(&quot;icl %d  ilab %d lab %d&quot;,i,ind,cl-&gt;GetLabel(ind)));
<span class="lineNum">    4113 </span>            :      }
<span class="lineNum">    4114 </span>            :      track-&gt;SetChi2MIP(9,track-&gt;GetChi2MIP(9)+isWrong*(2&lt;&lt;l));
<span class="lineNum">    4115 </span>            :      nwrong+=isWrong;
<span class="lineNum">    4116 </span>            :    }
<span class="lineNum">    4117 </span>            :    Int_t nclusters = track-&gt;GetNumberOfClusters();
<span class="lineNum">    4118 </span>            :    if (nclusters &gt; 0) //PH Some tracks don't have any cluster
<span class="lineNum">    4119 </span>            :      track-&gt;SetFakeRatio(double(nwrong)/double(nclusters));
<span class="lineNum">    4120 </span>            :    if (tpcLabel&gt;0 &amp;&amp; track-&gt;GetFakeRatio()&gt;wrong) {
<span class="lineNum">    4121 </span>            :      track-&gt;SetLabel(-tpcLabel);
<span class="lineNum">    4122 </span>            :    } else {
<span class="lineNum">    4123 </span>            :      track-&gt;SetLabel(tpcLabel);
<span class="lineNum">    4124 </span>            :    }
<span class="lineNum">    4125 </span>            :    AliDebug(2,Form(&quot; nls %d wrong %d  label %d  tpcLabel %d\n&quot;,nclusters,nwrong,track-&gt;GetLabel(),tpcLabel)); 
<span class="lineNum">    4126 </span>            : }
<span class="lineNum">    4127 </span>            : */
<a name="4128"><span class="lineNum">    4128 </span>            : </a>
<span class="lineNum">    4129 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4130 </span>            : void AliITStrackerMI::CookdEdx(AliITStrackMI* track){
<span class="lineNum">    4131 </span>            :   //
<span class="lineNum">    4132 </span>            :   // Fill the dE/dx in this track
<span class="lineNum">    4133 </span>            :   //
<span class="lineNum">    4134 </span><span class="lineCov">       4040 :   track-&gt;SetChi2MIP(9,0);</span>
<span class="lineNum">    4135 </span><span class="lineCov">      23388 :   for (Int_t i=0;i&lt;track-&gt;GetNumberOfClusters();i++){</span>
<span class="lineNum">    4136 </span><span class="lineCov">       9674 :     Int_t cindex = track-&gt;GetClusterIndex(i);</span>
<span class="lineNum">    4137 </span><span class="lineCov">       9674 :     Int_t l=(cindex &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">    4138 </span><span class="lineCov">       9674 :     AliITSRecPoint *cl = (AliITSRecPoint*)GetCluster(cindex);</span>
<span class="lineNum">    4139 </span><span class="lineCov">       9674 :     Int_t lab = TMath::Abs(track-&gt;GetESDtrack()-&gt;GetTPCLabel());</span>
<span class="lineNum">    4140 </span>            :     Int_t isWrong=1;
<span class="lineNum">    4141 </span><span class="lineCov">      77392 :     for (Int_t ind=0;ind&lt;3;ind++){</span>
<span class="lineNum">    4142 </span><span class="lineCov">      33780 :       if (cl-&gt;GetLabel(ind)==lab) isWrong=0;</span>
<span class="lineNum">    4143 </span>            :     }
<span class="lineNum">    4144 </span><span class="lineCov">       9674 :     track-&gt;SetChi2MIP(9,track-&gt;GetChi2MIP(9)+isWrong*(2&lt;&lt;l));</span>
<span class="lineNum">    4145 </span>            :   }
<span class="lineNum">    4146 </span>            :   Double_t low=0.;
<span class="lineNum">    4147 </span>            :   Double_t up=0.51;    
<span class="lineNum">    4148 </span><span class="lineCov">       2020 :   track-&gt;CookdEdx(low,up);</span>
<a name="4149"><span class="lineNum">    4149 </span><span class="lineCov">       2020 : }</span></a>
<span class="lineNum">    4150 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4151 </span>            : void AliITStrackerMI::MakeCoefficients(Int_t ntracks){
<span class="lineNum">    4152 </span>            :   //
<span class="lineNum">    4153 </span>            :   // Create some arrays
<span class="lineNum">    4154 </span>            :   //
<span class="lineNum">    4155 </span><span class="lineCov">         16 :   if (fCoefficients) delete []fCoefficients;</span>
<span class="lineNum">    4156 </span><span class="lineCov">          8 :   fCoefficients = new Float_t[ntracks*48];</span>
<span class="lineNum">    4157 </span><span class="lineCov">      10576 :   for (Int_t i=0;i&lt;ntracks*48;i++) fCoefficients[i]=-1.;</span>
<a name="4158"><span class="lineNum">    4158 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">    4159 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4160 </span>            : Double_t AliITStrackerMI::GetPredictedChi2MI(AliITStrackMI* track, const AliITSRecPoint *cluster,Int_t layer) 
<span class="lineNum">    4161 </span>            : {
<span class="lineNum">    4162 </span>            :   //
<span class="lineNum">    4163 </span>            :   // Compute predicted chi2
<span class="lineNum">    4164 </span>            :   //
<span class="lineNum">    4165 </span>            :   // Take into account the mis-alignment (bring track to cluster plane)
<span class="lineNum">    4166 </span><span class="lineCov">      23936 :   Double_t xTrOrig=track-&gt;GetX();</span>
<span class="lineNum">    4167 </span><span class="lineCov">      11968 :   if (!track-&gt;Propagate(xTrOrig+cluster-&gt;GetX())) return 1000.;</span>
<span class="lineNum">    4168 </span><span class="lineCov">      11968 :   Float_t erry,errz,covyz;</span>
<span class="lineNum">    4169 </span><span class="lineCov">      11968 :   Float_t theta = track-&gt;GetTgl();</span>
<span class="lineNum">    4170 </span><span class="lineCov">      11968 :   Float_t phi   = track-&gt;GetSnp();</span>
<span class="lineNum">    4171 </span><span class="lineCov">      11968 :   phi *= TMath::Sqrt(1./((1.-phi)*(1.+phi)));</span>
<span class="lineNum">    4172 </span><span class="lineCov">      11968 :   AliITSClusterParam::GetError(layer,cluster,theta,phi,track-&gt;GetExpQ(),erry,errz,covyz);</span>
<span class="lineNum">    4173 </span><span class="lineCov">      35904 :   AliDebug(2,Form(&quot; chi2: tr-cl   %f  %f   tr X %f cl X %f&quot;,track-&gt;GetY()-cluster-&gt;GetY(),track-&gt;GetZ()-cluster-&gt;GetZ(),track-&gt;GetX(),cluster-&gt;GetX()));</span>
<span class="lineNum">    4174 </span><span class="lineCov">      35904 :   AliDebug(2,Form(&quot; chi2: tr-cl   %f  %f   tr X %f cl X %f&quot;,track-&gt;GetY()-cluster-&gt;GetY(),track-&gt;GetZ()-cluster-&gt;GetZ(),track-&gt;GetX(),cluster-&gt;GetX()));</span>
<span class="lineNum">    4175 </span><span class="lineCov">      11968 :   Double_t chi2 = track-&gt;GetPredictedChi2MI(cluster-&gt;GetY(),cluster-&gt;GetZ(),erry,errz,covyz);</span>
<span class="lineNum">    4176 </span>            :   // Bring the track back to detector plane in ideal geometry
<span class="lineNum">    4177 </span>            :   // [mis-alignment will be accounted for in UpdateMI()]
<span class="lineNum">    4178 </span><span class="lineCov">      11968 :   if (!track-&gt;Propagate(xTrOrig)) return 1000.;</span>
<span class="lineNum">    4179 </span><span class="lineCov">      11968 :   Float_t ny,nz;</span>
<span class="lineNum">    4180 </span><span class="lineCov">      11968 :   AliITSClusterParam::GetNTeor(layer,cluster,theta,phi,ny,nz);  </span>
<span class="lineNum">    4181 </span><span class="lineCov">      11968 :   Double_t delta = cluster-&gt;GetNy()+cluster-&gt;GetNz()-nz-ny;</span>
<span class="lineNum">    4182 </span><span class="lineCov">      11968 :   if (delta&gt;1){</span>
<span class="lineNum">    4183 </span><span class="lineCov">        202 :     chi2+=0.5*TMath::Min(delta/2,2.);</span>
<span class="lineNum">    4184 </span><span class="lineCov">        202 :     chi2+=2.*cluster-&gt;GetDeltaProbability();</span>
<span class="lineNum">    4185 </span><span class="lineCov">        202 :   }</span>
<span class="lineNum">    4186 </span>            :   //
<span class="lineNum">    4187 </span><span class="lineCov">      11968 :   track-&gt;SetNy(layer,ny);</span>
<span class="lineNum">    4188 </span><span class="lineCov">      11968 :   track-&gt;SetNz(layer,nz);</span>
<span class="lineNum">    4189 </span><span class="lineCov">      11968 :   track-&gt;SetSigmaY(layer,erry);</span>
<span class="lineNum">    4190 </span><span class="lineCov">      11968 :   track-&gt;SetSigmaZ(layer, errz);</span>
<span class="lineNum">    4191 </span><span class="lineCov">      11968 :   track-&gt;SetSigmaYZ(layer,covyz);</span>
<span class="lineNum">    4192 </span>            :   //track-&gt;fNormQ[layer] = cluster-&gt;GetQ()/TMath::Sqrt(1+theta*theta+phi*phi);
<span class="lineNum">    4193 </span><span class="lineCov">      11968 :   track-&gt;SetNormQ(layer,cluster-&gt;GetQ()/TMath::Sqrt((1.+ track-&gt;GetTgl()*track-&gt;GetTgl())/((1.-track-&gt;GetSnp())*(1.+track-&gt;GetSnp()))));</span>
<span class="lineNum">    4194 </span>            :   return chi2;
<span class="lineNum">    4195 </span>            : 
<a name="4196"><span class="lineNum">    4196 </span><span class="lineCov">      35904 : }</span></a>
<span class="lineNum">    4197 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4198 </span>            : Int_t AliITStrackerMI::UpdateMI(AliITStrackMI* track, const AliITSRecPoint* cl,Double_t chi2,Int_t index) const 
<span class="lineNum">    4199 </span>            : {
<span class="lineNum">    4200 </span>            :   //
<span class="lineNum">    4201 </span>            :   // Update ITS track
<span class="lineNum">    4202 </span>            :   //
<span class="lineNum">    4203 </span><span class="lineCov">      23736 :   Int_t layer = (index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">    4204 </span><span class="lineCov">      11868 :   track-&gt;SetClIndex(layer, index);</span>
<span class="lineNum">    4205 </span><span class="lineCov">      20902 :   if (layer&gt;1&amp;&amp;AliITSReconstructor::GetRecoParam()-&gt;GetUseAmplitudeInfo(layer)) {</span>
<span class="lineNum">    4206 </span><span class="lineCov">       9034 :     if (track-&gt;GetNormQ(layer)/track-&gt;GetExpQ()&lt;0.5 ) {</span>
<span class="lineNum">    4207 </span><span class="lineNoCov">          0 :       chi2+= (0.5-track-&gt;GetNormQ(layer)/track-&gt;GetExpQ())*10.;</span>
<span class="lineNum">    4208 </span><span class="lineNoCov">          0 :       track-&gt;SetdEdxMismatch(track-&gt;GetdEdxMismatch()+(0.5-track-&gt;GetNormQ(layer)/track-&gt;GetExpQ())*10.);</span>
<span class="lineNum">    4209 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    4210 </span>            :   }
<span class="lineNum">    4211 </span>            : 
<span class="lineNum">    4212 </span><span class="lineCov">      11868 :   if (TMath::Abs(cl-&gt;GetQ())&lt;1.e-13) return 0;  // ingore the &quot;virtual&quot; clusters</span>
<span class="lineNum">    4213 </span>            : 
<span class="lineNum">    4214 </span>            : 
<span class="lineNum">    4215 </span>            :   // Take into account the mis-alignment (bring track to cluster plane)
<span class="lineNum">    4216 </span><span class="lineCov">      11868 :   Double_t xTrOrig=track-&gt;GetX();</span>
<span class="lineNum">    4217 </span><span class="lineCov">      11868 :   Float_t clxyz[3]={0}; cl-&gt;GetGlobalXYZ(clxyz);Double_t trxyz[3]={0}; track-&gt;GetXYZ(trxyz);</span>
<span class="lineNum">    4218 </span><span class="lineCov">      35604 :   AliDebug(2,Form(&quot;gtr %f %f %f&quot;,trxyz[0],trxyz[1],trxyz[2]));</span>
<span class="lineNum">    4219 </span><span class="lineCov">      35604 :   AliDebug(2,Form(&quot;gcl %f %f %f&quot;,clxyz[0],clxyz[1],clxyz[2]));</span>
<span class="lineNum">    4220 </span><span class="lineCov">      35604 :   AliDebug(2,Form(&quot; xtr %f  xcl %f&quot;,track-&gt;GetX(),cl-&gt;GetX()));</span>
<span class="lineNum">    4221 </span>            : 
<span class="lineNum">    4222 </span><span class="lineCov">      11868 :   if (!track-&gt;Propagate(xTrOrig+cl-&gt;GetX())) return 0;</span>
<span class="lineNum">    4223 </span>            :   
<span class="lineNum">    4224 </span><span class="lineCov">      11868 :   AliCluster c(*cl);</span>
<span class="lineNum">    4225 </span><span class="lineCov">      11868 :   c.SetSigmaY2(track-&gt;GetSigmaY(layer)*track-&gt;GetSigmaY(layer));</span>
<span class="lineNum">    4226 </span><span class="lineCov">      11868 :   c.SetSigmaZ2(track-&gt;GetSigmaZ(layer)*track-&gt;GetSigmaZ(layer));</span>
<span class="lineNum">    4227 </span><span class="lineCov">      11868 :   c.SetSigmaYZ(track-&gt;GetSigmaYZ(layer));</span>
<span class="lineNum">    4228 </span>            : 
<span class="lineNum">    4229 </span>            : 
<span class="lineNum">    4230 </span><span class="lineCov">      23736 :   Int_t updated = track-&gt;UpdateMI(&amp;c,chi2,index);</span>
<span class="lineNum">    4231 </span>            :   // Bring the track back to detector plane in ideal geometry
<span class="lineNum">    4232 </span><span class="lineCov">      23736 :   if (!track-&gt;Propagate(xTrOrig)) return 0;</span>
<span class="lineNum">    4233 </span>            :  
<span class="lineNum">    4234 </span><span class="lineCov">      11868 :   if(!updated) AliDebug(2,&quot;update failed&quot;);</span>
<span class="lineNum">    4235 </span><span class="lineCov">      11868 :   return updated;</span>
<span class="lineNum">    4236 </span><span class="lineCov">      35604 : }</span>
<a name="4237"><span class="lineNum">    4237 </span>            : </a>
<span class="lineNum">    4238 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4239 </span>            : void AliITStrackerMI::GetDCASigma(const AliITStrackMI* track, Float_t &amp; sigmarfi, Float_t &amp;sigmaz)
<span class="lineNum">    4240 </span>            : {
<span class="lineNum">    4241 </span>            :   //
<span class="lineNum">    4242 </span>            :   //DCA sigmas parameterization
<span class="lineNum">    4243 </span>            :   //to be paramterized using external parameters in future 
<span class="lineNum">    4244 </span>            :   //
<span class="lineNum">    4245 </span>            :   // 
<span class="lineNum">    4246 </span><span class="lineCov">       1740 :   Double_t curv=track-&gt;GetC();</span>
<span class="lineNum">    4247 </span><span class="lineCov">        870 :   sigmarfi = 0.0040+1.4 *TMath::Abs(curv)+332.*curv*curv;</span>
<span class="lineNum">    4248 </span><span class="lineCov">        870 :   sigmaz   = 0.0110+4.37*TMath::Abs(curv);</span>
<a name="4249"><span class="lineNum">    4249 </span><span class="lineCov">        870 : }</span></a>
<span class="lineNum">    4250 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4251 </span>            : void AliITStrackerMI::SignDeltas(const TObjArray *clusterArray, Float_t vz)
<span class="lineNum">    4252 </span>            : {
<span class="lineNum">    4253 </span>            :   //
<span class="lineNum">    4254 </span>            :   // Clusters from delta electrons?
<span class="lineNum">    4255 </span>            :   //  
<span class="lineNum">    4256 </span><span class="lineCov">      35168 :   Int_t entries = clusterArray-&gt;GetEntriesFast();</span>
<span class="lineNum">    4257 </span><span class="lineCov">      35158 :   if (entries&lt;4) return;</span>
<span class="lineNum">    4258 </span><span class="lineCov">         10 :   AliITSRecPoint* cluster = (AliITSRecPoint*)clusterArray-&gt;At(0);</span>
<span class="lineNum">    4259 </span><span class="lineCov">         10 :   Int_t layer = cluster-&gt;GetLayer();</span>
<span class="lineNum">    4260 </span><span class="lineCov">         20 :   if (layer&gt;1) return;</span>
<span class="lineNum">    4261 </span><span class="lineNoCov">          0 :   Int_t index[10000]={0};</span>
<span class="lineNum">    4262 </span>            :   Int_t ncandidates=0;
<span class="lineNum">    4263 </span><span class="lineNoCov">          0 :   Float_t r = (layer&gt;0)? 7:4;</span>
<span class="lineNum">    4264 </span>            :   // 
<span class="lineNum">    4265 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;entries;i++){</span>
<span class="lineNum">    4266 </span><span class="lineNoCov">          0 :     AliITSRecPoint* cl0 = (AliITSRecPoint*)clusterArray-&gt;At(i);</span>
<span class="lineNum">    4267 </span><span class="lineNoCov">          0 :     Float_t nz = 1+TMath::Abs((cl0-&gt;GetZ()-vz)/r);</span>
<span class="lineNum">    4268 </span><span class="lineNoCov">          0 :     if (cl0-&gt;GetNy()+cl0-&gt;GetNz()&lt;=5+2*layer+nz) continue;</span>
<span class="lineNum">    4269 </span><span class="lineNoCov">          0 :     index[ncandidates] = i;  //candidate to belong to delta electron track</span>
<span class="lineNum">    4270 </span><span class="lineNoCov">          0 :     ncandidates++;</span>
<span class="lineNum">    4271 </span><span class="lineNoCov">          0 :     if (cl0-&gt;GetNy()+cl0-&gt;GetNz()&gt;9+2*layer+nz) {</span>
<span class="lineNum">    4272 </span><span class="lineNoCov">          0 :       cl0-&gt;SetDeltaProbability(1);</span>
<span class="lineNum">    4273 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    4274 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    4275 </span>            :   //
<span class="lineNum">    4276 </span>            :   //  
<span class="lineNum">    4277 </span>            :   //
<span class="lineNum">    4278 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;ncandidates;i++){</span>
<span class="lineNum">    4279 </span><span class="lineNoCov">          0 :     AliITSRecPoint* cl0 = (AliITSRecPoint*)clusterArray-&gt;At(index[i]);</span>
<span class="lineNum">    4280 </span><span class="lineNoCov">          0 :     if (cl0-&gt;GetDeltaProbability()&gt;0.8) continue;</span>
<span class="lineNum">    4281 </span>            :     // 
<span class="lineNum">    4282 </span>            :     Int_t ncl = 0;
<span class="lineNum">    4283 </span><span class="lineNoCov">          0 :     Float_t y[100]={0},z[100]={0},sumy,sumz,sumy2, sumyz, sumw;</span>
<span class="lineNum">    4284 </span>            :     sumy=sumz=sumy2=sumyz=sumw=0.0;
<span class="lineNum">    4285 </span><span class="lineNoCov">          0 :     for (Int_t j=0;j&lt;ncandidates;j++){</span>
<span class="lineNum">    4286 </span><span class="lineNoCov">          0 :       if (i==j) continue;</span>
<span class="lineNum">    4287 </span><span class="lineNoCov">          0 :       AliITSRecPoint* cl1 = (AliITSRecPoint*)clusterArray-&gt;At(index[j]);</span>
<span class="lineNum">    4288 </span>            :       //
<span class="lineNum">    4289 </span><span class="lineNoCov">          0 :       Float_t dz = cl0-&gt;GetZ()-cl1-&gt;GetZ();</span>
<span class="lineNum">    4290 </span><span class="lineNoCov">          0 :       Float_t dy = cl0-&gt;GetY()-cl1-&gt;GetY();</span>
<span class="lineNum">    4291 </span><span class="lineNoCov">          0 :       if (TMath::Sqrt(dz*dz+dy*dy)&lt;0.2){</span>
<span class="lineNum">    4292 </span><span class="lineNoCov">          0 :         Float_t weight = cl1-&gt;GetNy()+cl1-&gt;GetNz()-2;</span>
<span class="lineNum">    4293 </span><span class="lineNoCov">          0 :         y[ncl] = cl1-&gt;GetY();</span>
<span class="lineNum">    4294 </span><span class="lineNoCov">          0 :         z[ncl] = cl1-&gt;GetZ();</span>
<span class="lineNum">    4295 </span><span class="lineNoCov">          0 :         sumy+= y[ncl]*weight;</span>
<span class="lineNum">    4296 </span><span class="lineNoCov">          0 :         sumz+= z[ncl]*weight;</span>
<span class="lineNum">    4297 </span><span class="lineNoCov">          0 :         sumy2+=y[ncl]*y[ncl]*weight;</span>
<span class="lineNum">    4298 </span><span class="lineNoCov">          0 :         sumyz+=y[ncl]*z[ncl]*weight;</span>
<span class="lineNum">    4299 </span><span class="lineNoCov">          0 :         sumw+=weight;</span>
<span class="lineNum">    4300 </span><span class="lineNoCov">          0 :         ncl++;</span>
<span class="lineNum">    4301 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4302 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    4303 </span><span class="lineNoCov">          0 :     if (ncl&lt;4) continue;</span>
<span class="lineNum">    4304 </span><span class="lineNoCov">          0 :     Float_t det = sumw*sumy2  - sumy*sumy;</span>
<span class="lineNum">    4305 </span>            :     Float_t delta=1000;
<span class="lineNum">    4306 </span><span class="lineNoCov">          0 :     if (TMath::Abs(det)&gt;0.01){</span>
<span class="lineNum">    4307 </span><span class="lineNoCov">          0 :       Float_t z0  = (sumy2*sumz - sumy*sumyz)/det;</span>
<span class="lineNum">    4308 </span><span class="lineNoCov">          0 :       Float_t k   = (sumyz*sumw - sumy*sumz)/det;</span>
<span class="lineNum">    4309 </span><span class="lineNoCov">          0 :       delta = TMath::Abs(cl0-&gt;GetZ()-(z0+k*cl0-&gt;GetY()));</span>
<span class="lineNum">    4310 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    4311 </span>            :     else{
<span class="lineNum">    4312 </span><span class="lineNoCov">          0 :       Float_t z0  = sumyz/sumy;</span>
<span class="lineNum">    4313 </span><span class="lineNoCov">          0 :       delta = TMath::Abs(cl0-&gt;GetZ()-z0);</span>
<span class="lineNum">    4314 </span>            :     }
<span class="lineNum">    4315 </span><span class="lineNoCov">          0 :     if ( delta&lt;0.05) {</span>
<span class="lineNum">    4316 </span><span class="lineNoCov">          0 :       cl0-&gt;SetDeltaProbability(1-20.*delta);</span>
<span class="lineNum">    4317 </span><span class="lineNoCov">          0 :     }   </span>
<span class="lineNum">    4318 </span><span class="lineNoCov">          0 :   }</span>
<a name="4319"><span class="lineNum">    4319 </span><span class="lineCov">      17584 : }</span></a>
<span class="lineNum">    4320 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4321 </span>            : void AliITStrackerMI::UpdateESDtrack(AliITStrackMI* track, ULong_t flags) const
<span class="lineNum">    4322 </span>            : {
<span class="lineNum">    4323 </span>            :   //
<span class="lineNum">    4324 </span>            :   // Update ESD track
<span class="lineNum">    4325 </span>            :   //
<span class="lineNum">    4326 </span><span class="lineCov">        732 :   track-&gt;UpdateESDtrack(flags);</span>
<span class="lineNum">    4327 </span><span class="lineCov">        366 :   AliITStrackMI * oldtrack = (AliITStrackMI*)(track-&gt;GetESDtrack()-&gt;GetITStrack());</span>
<span class="lineNum">    4328 </span><span class="lineCov">        934 :   if (oldtrack) delete oldtrack; </span>
<span class="lineNum">    4329 </span><span class="lineCov">        732 :   track-&gt;GetESDtrack()-&gt;SetITStrack(new AliITStrackMI(*track));</span>
<span class="lineNum">    4330 </span>            :   // if (TMath::Abs(track-&gt;GetDnorm(1))&lt;0.000000001){
<span class="lineNum">    4331 </span>            :   //   printf(&quot;Problem\n&quot;);
<span class="lineNum">    4332 </span>            :   // }
<a name="4333"><span class="lineNum">    4333 </span><span class="lineCov">        366 : }</span></a>
<span class="lineNum">    4334 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4335 </span>            : Int_t AliITStrackerMI::GetNearestLayer(const Double_t *xr) const{
<span class="lineNum">    4336 </span>            :   //
<span class="lineNum">    4337 </span>            :   // Get nearest upper layer close to the point xr.
<span class="lineNum">    4338 </span>            :   // rough approximation 
<span class="lineNum">    4339 </span>            :   //
<span class="lineNum">    4340 </span>            :   const Float_t kRadiuses[6]={4,6.5,15.03,24.,38.5,43.7};
<span class="lineNum">    4341 </span><span class="lineCov">         28 :   Float_t radius = TMath::Sqrt(xr[0]*xr[0]+xr[1]*xr[1]);</span>
<span class="lineNum">    4342 </span>            :   Int_t res =6;
<span class="lineNum">    4343 </span><span class="lineCov">        172 :   for (Int_t i=0;i&lt;6;i++){</span>
<span class="lineNum">    4344 </span><span class="lineCov">         74 :     if (radius&lt;kRadiuses[i]){</span>
<span class="lineNum">    4345 </span>            :       res =i;
<span class="lineNum">    4346 </span><span class="lineCov">          6 :       break;</span>
<span class="lineNum">    4347 </span>            :     }
<span class="lineNum">    4348 </span>            :   }
<span class="lineNum">    4349 </span><span class="lineCov">         14 :   return res;</span>
<a name="4350"><span class="lineNum">    4350 </span>            : }</a>
<span class="lineNum">    4351 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4352 </span>            : void AliITStrackerMI::BuildMaterialLUT(TString material) {
<span class="lineNum">    4353 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    4354 </span>            :   // Fill a look-up table with mean material
<span class="lineNum">    4355 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    4356 </span>            : 
<span class="lineNum">    4357 </span>            :   Int_t n=1000;
<span class="lineNum">    4358 </span><span class="lineCov">         12 :   Double_t mparam[7]={0};</span>
<span class="lineNum">    4359 </span><span class="lineCov">          6 :   Double_t point1[3]={0},point2[3]={0};</span>
<span class="lineNum">    4360 </span>            :   Double_t phi,cosphi,sinphi,z;
<span class="lineNum">    4361 </span>            :   // 0-5 layers, 6 pipe, 7-8 shields 
<span class="lineNum">    4362 </span><span class="lineCov">          6 :   Double_t rmin[9]={ 3.5, 5.5,13.0,22.0,35.0,41.0, 2.0, 8.0,25.0};</span>
<span class="lineNum">    4363 </span><span class="lineCov">          6 :   Double_t rmax[9]={ 5.5, 8.0,17.0,26.0,41.0,47.0, 3.0,10.5,30.0};</span>
<span class="lineNum">    4364 </span>            : 
<span class="lineNum">    4365 </span>            :   Int_t ifirst=0,ilast=0;  
<span class="lineNum">    4366 </span><span class="lineCov">          6 :   if(material.Contains(&quot;Pipe&quot;)) {</span>
<span class="lineNum">    4367 </span>            :     ifirst=6; ilast=6;
<span class="lineNum">    4368 </span><span class="lineCov">          6 :   } else if(material.Contains(&quot;Shields&quot;)) {</span>
<span class="lineNum">    4369 </span>            :     ifirst=7; ilast=8;
<span class="lineNum">    4370 </span><span class="lineCov">          4 :   } else if(material.Contains(&quot;Layers&quot;)) {</span>
<span class="lineNum">    4371 </span>            :     ifirst=0; ilast=5;
<span class="lineNum">    4372 </span><span class="lineCov">          2 :   } else {</span>
<span class="lineNum">    4373 </span><span class="lineNoCov">          0 :     Error(&quot;BuildMaterialLUT&quot;,&quot;Wrong layer name\n&quot;);</span>
<span class="lineNum">    4374 </span>            :   }
<span class="lineNum">    4375 </span>            :   const double kAngEps = 1e-4; // tiny slope to avoid tracks strictly normal to Z axis
<span class="lineNum">    4376 </span><span class="lineCov">         48 :   for(Int_t imat=ifirst; imat&lt;=ilast; imat++) {</span>
<span class="lineNum">    4377 </span><span class="lineCov">         18 :     Double_t param[5]={0.,0.,0.,0.,0.};</span>
<span class="lineNum">    4378 </span><span class="lineCov">      36036 :     for (Int_t i=0; i&lt;n; i++) {</span>
<span class="lineNum">    4379 </span><span class="lineCov">      18000 :       phi = 2.*TMath::Pi()*gRandom-&gt;Rndm();</span>
<span class="lineNum">    4380 </span><span class="lineCov">      18000 :       cosphi = TMath::Cos(phi); sinphi = TMath::Sin(phi); </span>
<span class="lineNum">    4381 </span><span class="lineCov">      18000 :       z = 14.*(-1.+2.*gRandom-&gt;Rndm()); // SPD barrel</span>
<span class="lineNum">    4382 </span><span class="lineCov">      18000 :       point1[0] = rmin[imat]*cosphi;</span>
<span class="lineNum">    4383 </span><span class="lineCov">      18000 :       point1[1] = rmin[imat]*sinphi;</span>
<span class="lineNum">    4384 </span><span class="lineCov">      18000 :       point1[2] = z;</span>
<span class="lineNum">    4385 </span><span class="lineCov">      18000 :       point2[0] = rmax[imat]*cosphi;</span>
<span class="lineNum">    4386 </span><span class="lineCov">      18000 :       point2[1] = rmax[imat]*sinphi;</span>
<span class="lineNum">    4387 </span><span class="lineCov">      18000 :       point2[2] = z+(rmax[imat]-rmin[imat])*kAngEps;</span>
<span class="lineNum">    4388 </span><span class="lineCov">      18000 :       AliTracker::MeanMaterialBudget(point1,point2,mparam);</span>
<span class="lineNum">    4389 </span><span class="lineCov">      18000 :       if (mparam[1]&gt;999) {n--; continue;}  // skip anomalous values in failed propagation</span>
<span class="lineNum">    4390 </span><span class="lineCov">     216000 :       for(Int_t j=0;j&lt;5;j++) param[j]+=mparam[j];</span>
<span class="lineNum">    4391 </span><span class="lineCov">      18000 :     }</span>
<span class="lineNum">    4392 </span><span class="lineCov">        216 :     for(Int_t j=0;j&lt;5;j++) param[j]/=(Float_t)n;</span>
<span class="lineNum">    4393 </span><span class="lineCov">         18 :     if(imat&lt;=5) {</span>
<span class="lineNum">    4394 </span><span class="lineCov">         12 :       fxOverX0Layer[imat] = param[1];</span>
<span class="lineNum">    4395 </span><span class="lineCov">         12 :       fxTimesRhoLayer[imat] = param[0]*param[4];</span>
<span class="lineNum">    4396 </span><span class="lineCov">         18 :     } else if(imat==6) {</span>
<span class="lineNum">    4397 </span><span class="lineCov">          2 :       fxOverX0Pipe = param[1];</span>
<span class="lineNum">    4398 </span><span class="lineCov">          2 :       fxTimesRhoPipe = param[0]*param[4];</span>
<span class="lineNum">    4399 </span><span class="lineCov">          6 :     } else if(imat==7) {</span>
<span class="lineNum">    4400 </span><span class="lineCov">          2 :       fxOverX0Shield[0] = param[1];</span>
<span class="lineNum">    4401 </span><span class="lineCov">          2 :       fxTimesRhoShield[0] = param[0]*param[4];</span>
<span class="lineNum">    4402 </span><span class="lineCov">          4 :     } else if(imat==8) {</span>
<span class="lineNum">    4403 </span><span class="lineCov">          2 :       fxOverX0Shield[1] = param[1];</span>
<span class="lineNum">    4404 </span><span class="lineCov">          2 :       fxTimesRhoShield[1] = param[0]*param[4];</span>
<span class="lineNum">    4405 </span><span class="lineCov">          2 :     }</span>
<span class="lineNum">    4406 </span><span class="lineCov">         18 :   }</span>
<span class="lineNum">    4407 </span>            :   /*
<span class="lineNum">    4408 </span>            :   printf(&quot;%s\n&quot;,material.Data());
<span class="lineNum">    4409 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Pipe,fxTimesRhoPipe);
<span class="lineNum">    4410 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Shield[0],fxTimesRhoShield[0]);
<span class="lineNum">    4411 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Shield[1],fxTimesRhoShield[1]);
<span class="lineNum">    4412 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[0],fxTimesRhoLayer[0]);
<span class="lineNum">    4413 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[1],fxTimesRhoLayer[1]);
<span class="lineNum">    4414 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[2],fxTimesRhoLayer[2]);
<span class="lineNum">    4415 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[3],fxTimesRhoLayer[3]);
<span class="lineNum">    4416 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[4],fxTimesRhoLayer[4]);
<span class="lineNum">    4417 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[5],fxTimesRhoLayer[5]);
<span class="lineNum">    4418 </span>            :   */
<span class="lineNum">    4419 </span>            :   return;
<a name="4420"><span class="lineNum">    4420 </span><span class="lineCov">          6 : }</span></a>
<span class="lineNum">    4421 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4422 </span>            : Int_t AliITStrackerMI::CorrectForPipeMaterial(AliITStrackMI *t,
<span class="lineNum">    4423 </span>            :                                               TString direction) {
<span class="lineNum">    4424 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    4425 </span>            :   // Propagate beyond beam pipe and correct for material
<span class="lineNum">    4426 </span>            :   // (material budget in different ways according to fUseTGeo value)
<span class="lineNum">    4427 </span>            :   // Add time if going outward (PropagateTo or PropagateToTGeo)
<span class="lineNum">    4428 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    4429 </span>            : 
<span class="lineNum">    4430 </span>            :   // Define budget mode:
<span class="lineNum">    4431 </span>            :   // 0: material from AliITSRecoParam (hard coded)
<span class="lineNum">    4432 </span>            :   // 1: material from TGeo in one step (on the fly)
<span class="lineNum">    4433 </span>            :   // 2: material from lut
<span class="lineNum">    4434 </span>            :   // 3: material from TGeo in one step (same for all hypotheses)
<span class="lineNum">    4435 </span>            :   Int_t mode;
<span class="lineNum">    4436 </span><span class="lineCov">       1324 :   switch(fUseTGeo) {</span>
<span class="lineNum">    4437 </span>            :   case 0:
<span class="lineNum">    4438 </span>            :     mode=0; 
<span class="lineNum">    4439 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">    4440 </span>            :   case 1:
<span class="lineNum">    4441 </span>            :     mode=1;
<span class="lineNum">    4442 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">    4443 </span>            :   case 2:
<span class="lineNum">    4444 </span>            :     mode=2;
<span class="lineNum">    4445 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4446 </span>            :   case 3:
<span class="lineNum">    4447 </span><span class="lineCov">        662 :     if(fTrackingPhase.Contains(&quot;Clusters2Tracks&quot;)) </span>
<span class="lineNum">    4448 </span><span class="lineCov">        566 :       { mode=3; } else { mode=1; }</span>
<span class="lineNum">    4449 </span>            :     break;
<span class="lineNum">    4450 </span>            :   case 4:
<span class="lineNum">    4451 </span><span class="lineNoCov">          0 :     if(fTrackingPhase.Contains(&quot;Clusters2Tracks&quot;)) </span>
<span class="lineNum">    4452 </span><span class="lineNoCov">          0 :       { mode=3; } else { mode=2; }</span>
<span class="lineNum">    4453 </span>            :     break;
<span class="lineNum">    4454 </span>            :   default:
<span class="lineNum">    4455 </span>            :     mode=0;
<span class="lineNum">    4456 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4457 </span>            :   }
<span class="lineNum">    4458 </span><span class="lineCov">        662 :   if(fTrackingPhase.Contains(&quot;Default&quot;)) mode=0;</span>
<span class="lineNum">    4459 </span>            : 
<span class="lineNum">    4460 </span><span class="lineCov">        662 :   Int_t index=fCurrentEsdTrack;</span>
<span class="lineNum">    4461 </span>            : 
<span class="lineNum">    4462 </span><span class="lineCov">        662 :   Float_t  dir = (direction.Contains(&quot;inward&quot;) ? 1. : -1.);</span>
<span class="lineNum">    4463 </span><span class="lineCov">       1986 :   Double_t rToGo=(dir&gt;0 ? AliITSRecoParam::GetrInsidePipe() : AliITSRecoParam::GetrOutsidePipe());</span>
<span class="lineNum">    4464 </span><span class="lineCov">        662 :   Double_t xToGo;</span>
<span class="lineNum">    4465 </span><span class="lineCov">        666 :   if (!t-&gt;GetLocalXat(rToGo,xToGo)) return 0;</span>
<span class="lineNum">    4466 </span>            : 
<span class="lineNum">    4467 </span><span class="lineCov">       1240 :   Double_t xOverX0,x0,lengthTimesMeanDensity;</span>
<span class="lineNum">    4468 </span>            : 
<span class="lineNum">    4469 </span><span class="lineCov">       1240 :   switch(mode) {</span>
<span class="lineNum">    4470 </span>            :   case 0:
<span class="lineNum">    4471 </span><span class="lineNoCov">          0 :     xOverX0 = AliITSRecoParam::GetdPipe();</span>
<span class="lineNum">    4472 </span><span class="lineNoCov">          0 :     x0 = AliITSRecoParam::GetX0Be();</span>
<span class="lineNum">    4473 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity = xOverX0*x0;</span>
<span class="lineNum">    4474 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">    4475 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">    4476 </span>            :     break;
<span class="lineNum">    4477 </span>            :   case 1:
<span class="lineNum">    4478 </span><span class="lineCov">         92 :     if (!t-&gt;PropagateToTGeo(xToGo,1)) return 0;</span>
<span class="lineNum">    4479 </span>            :     break;
<span class="lineNum">    4480 </span>            :   case 2:
<span class="lineNum">    4481 </span><span class="lineNoCov">          0 :     if(fxOverX0Pipe&lt;0) BuildMaterialLUT(&quot;Pipe&quot;);  </span>
<span class="lineNum">    4482 </span><span class="lineNoCov">          0 :     xOverX0 = fxOverX0Pipe;</span>
<span class="lineNum">    4483 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity = fxTimesRhoPipe;</span>
<span class="lineNum">    4484 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">    4485 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">    4486 </span>            :     break;
<span class="lineNum">    4487 </span>            :   case 3:
<span class="lineNum">    4488 </span><span class="lineCov">       1132 :     if(!fxOverX0PipeTrks || index&lt;0 || index&gt;=fNtracks) Error(&quot;CorrectForPipeMaterial&quot;,&quot;Incorrect usage of UseTGeo option!\n&quot;);</span>
<span class="lineNum">    4489 </span><span class="lineCov">        566 :     if(fxOverX0PipeTrks[index]&lt;0) {</span>
<span class="lineNum">    4490 </span><span class="lineCov">         76 :       if (!t-&gt;PropagateToTGeo(xToGo,1,xOverX0,lengthTimesMeanDensity)) return 0;</span>
<span class="lineNum">    4491 </span><span class="lineCov">        152 :       Double_t angle=TMath::Sqrt((1.+t-&gt;GetTgl()*t-&gt;GetTgl())/</span>
<span class="lineNum">    4492 </span><span class="lineCov">         76 :                                  ((1.-t-&gt;GetSnp())*(1.+t-&gt;GetSnp())));</span>
<span class="lineNum">    4493 </span><span class="lineCov">         76 :       fxOverX0PipeTrks[index] = TMath::Abs(xOverX0)/angle;</span>
<span class="lineNum">    4494 </span><span class="lineCov">         76 :       fxTimesRhoPipeTrks[index] = TMath::Abs(lengthTimesMeanDensity)/angle;</span>
<span class="lineNum">    4495 </span>            :       return 1;
<span class="lineNum">    4496 </span>            :     }
<span class="lineNum">    4497 </span><span class="lineCov">        490 :     xOverX0 = fxOverX0PipeTrks[index];</span>
<span class="lineNum">    4498 </span><span class="lineCov">        490 :     lengthTimesMeanDensity = fxTimesRhoPipeTrks[index];</span>
<span class="lineNum">    4499 </span><span class="lineCov">        490 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">    4500 </span><span class="lineCov">        490 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">    4501 </span>            :     break;
<span class="lineNum">    4502 </span>            :   }
<span class="lineNum">    4503 </span>            : 
<span class="lineNum">    4504 </span><span class="lineCov">        582 :   return 1;</span>
<a name="4505"><span class="lineNum">    4505 </span><span class="lineCov">       1320 : }</span></a>
<span class="lineNum">    4506 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4507 </span>            : Int_t AliITStrackerMI::CorrectForShieldMaterial(AliITStrackMI *t,
<span class="lineNum">    4508 </span>            :                                                 TString shield,
<span class="lineNum">    4509 </span>            :                                                 TString direction) {
<span class="lineNum">    4510 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    4511 </span>            :   // Propagate beyond SPD or SDD shield and correct for material
<span class="lineNum">    4512 </span>            :   // (material budget in different ways according to fUseTGeo value)
<span class="lineNum">    4513 </span>            :   // Add time if going outward (PropagateTo or PropagateToTGeo)
<span class="lineNum">    4514 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    4515 </span>            : 
<span class="lineNum">    4516 </span>            :   // Define budget mode:
<span class="lineNum">    4517 </span>            :   // 0: material from AliITSRecoParam (hard coded)
<span class="lineNum">    4518 </span>            :   // 1: material from TGeo in steps of X cm (on the fly)
<span class="lineNum">    4519 </span>            :   //    X = AliITSRecoParam::GetStepSizeTGeo()
<span class="lineNum">    4520 </span>            :   // 2: material from lut
<span class="lineNum">    4521 </span>            :   // 3: material from TGeo in one step (same for all hypotheses)
<span class="lineNum">    4522 </span>            :   Int_t mode;
<span class="lineNum">    4523 </span><span class="lineCov">       9724 :   switch(fUseTGeo) {</span>
<span class="lineNum">    4524 </span>            :   case 0:
<span class="lineNum">    4525 </span>            :     mode=0; 
<span class="lineNum">    4526 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">    4527 </span>            :   case 1:
<span class="lineNum">    4528 </span>            :     mode=1;
<span class="lineNum">    4529 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">    4530 </span>            :   case 2:
<span class="lineNum">    4531 </span>            :     mode=2;
<span class="lineNum">    4532 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4533 </span>            :   case 3:
<span class="lineNum">    4534 </span><span class="lineCov">       4862 :     if(fTrackingPhase.Contains(&quot;Clusters2Tracks&quot;)) </span>
<span class="lineNum">    4535 </span><span class="lineCov">       4398 :       { mode=3; } else { mode=1; }</span>
<span class="lineNum">    4536 </span>            :     break;
<span class="lineNum">    4537 </span>            :   case 4:
<span class="lineNum">    4538 </span><span class="lineNoCov">          0 :     if(fTrackingPhase.Contains(&quot;Clusters2Tracks&quot;)) </span>
<span class="lineNum">    4539 </span><span class="lineNoCov">          0 :       { mode=3; } else { mode=2; }</span>
<span class="lineNum">    4540 </span>            :     break;
<span class="lineNum">    4541 </span>            :   default:
<span class="lineNum">    4542 </span>            :     mode=0;
<span class="lineNum">    4543 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4544 </span>            :   }
<span class="lineNum">    4545 </span><span class="lineCov">       4934 :   if(fTrackingPhase.Contains(&quot;Default&quot;)) mode=0;</span>
<span class="lineNum">    4546 </span>            : 
<span class="lineNum">    4547 </span><span class="lineCov">       4862 :   Float_t  dir = (direction.Contains(&quot;inward&quot;) ? 1. : -1.);</span>
<span class="lineNum">    4548 </span>            :   Double_t rToGo;
<span class="lineNum">    4549 </span>            :   Int_t    shieldindex=0;
<span class="lineNum">    4550 </span><span class="lineCov">       4862 :   if (shield.Contains(&quot;SDD&quot;)) { // SDDouter</span>
<span class="lineNum">    4551 </span><span class="lineCov">       7236 :     rToGo=(dir&gt;0 ? AliITSRecoParam::GetrInsideShield(1) : AliITSRecoParam::GetrOutsideShield(1));</span>
<span class="lineNum">    4552 </span>            :     shieldindex=1;
<span class="lineNum">    4553 </span><span class="lineCov">       4862 :   } else if (shield.Contains(&quot;SPD&quot;)) {        // SPDouter</span>
<span class="lineNum">    4554 </span><span class="lineCov">       7350 :     rToGo=(dir&gt;0 ? AliITSRecoParam::GetrInsideShield(0) : AliITSRecoParam::GetrOutsideShield(0)); </span>
<span class="lineNum">    4555 </span>            :     shieldindex=0;
<span class="lineNum">    4556 </span>            :   } else {
<span class="lineNum">    4557 </span><span class="lineNoCov">          0 :     Error(&quot;CorrectForShieldMaterial&quot;,&quot; Wrong shield name\n&quot;);</span>
<span class="lineNum">    4558 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">    4559 </span>            :   }
<span class="lineNum">    4560 </span>            : 
<span class="lineNum">    4561 </span>            :   // do nothing if we are already beyond the shield
<span class="lineNum">    4562 </span><span class="lineCov">       4862 :   Double_t rTrack = TMath::Sqrt(t-&gt;GetX()*t-&gt;GetX()+t-&gt;GetY()*t-&gt;GetY());</span>
<span class="lineNum">    4563 </span><span class="lineCov">       6948 :   if(dir&lt;0 &amp;&amp; rTrack &gt; rToGo) return 1; // going outward</span>
<span class="lineNum">    4564 </span><span class="lineCov">       7638 :   if(dir&gt;0 &amp;&amp; rTrack &lt; rToGo) return 1; // going inward</span>
<span class="lineNum">    4565 </span>            : 
<span class="lineNum">    4566 </span>            : 
<span class="lineNum">    4567 </span><span class="lineCov">       4748 :   Double_t xToGo;</span>
<span class="lineNum">    4568 </span><span class="lineCov">       4754 :   if (!t-&gt;GetLocalXat(rToGo,xToGo)) return 0;</span>
<span class="lineNum">    4569 </span>            : 
<span class="lineNum">    4570 </span><span class="lineCov">       9296 :   Int_t index=2*fCurrentEsdTrack+shieldindex;</span>
<span class="lineNum">    4571 </span>            : 
<span class="lineNum">    4572 </span><span class="lineCov">       9296 :   Double_t xOverX0,x0,lengthTimesMeanDensity;</span>
<span class="lineNum">    4573 </span>            :   Int_t nsteps=1;
<span class="lineNum">    4574 </span>            : 
<span class="lineNum">    4575 </span><span class="lineCov">       9296 :   switch(mode) {</span>
<span class="lineNum">    4576 </span>            :   case 0:
<span class="lineNum">    4577 </span><span class="lineCov">         70 :     xOverX0 = AliITSRecoParam::Getdshield(shieldindex);</span>
<span class="lineNum">    4578 </span><span class="lineCov">         70 :     x0 = AliITSRecoParam::GetX0shield(shieldindex);</span>
<span class="lineNum">    4579 </span><span class="lineCov">         70 :     lengthTimesMeanDensity = xOverX0*x0;</span>
<span class="lineNum">    4580 </span><span class="lineCov">         70 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">    4581 </span><span class="lineCov">         70 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">    4582 </span>            :     break;
<span class="lineNum">    4583 </span>            :   case 1:
<span class="lineNum">    4584 </span><span class="lineCov">        386 :     nsteps= (Int_t)(TMath::Abs(t-&gt;GetX()-xToGo)/AliITSReconstructor::GetRecoParam()-&gt;GetStepSizeTGeo())+1;</span>
<span class="lineNum">    4585 </span><span class="lineCov">        386 :     if (!t-&gt;PropagateToTGeo(xToGo,nsteps)) return 0; // cross the material and apply correction</span>
<span class="lineNum">    4586 </span>            :     break;
<span class="lineNum">    4587 </span>            :   case 2:
<span class="lineNum">    4588 </span><span class="lineNoCov">          0 :     if(fxOverX0Shield[shieldindex]&lt;0) BuildMaterialLUT(&quot;Shields&quot;);  </span>
<span class="lineNum">    4589 </span><span class="lineNoCov">          0 :     xOverX0 = fxOverX0Shield[shieldindex];</span>
<span class="lineNum">    4590 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity = fxTimesRhoShield[shieldindex];</span>
<span class="lineNum">    4591 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">    4592 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">    4593 </span>            :     break;
<span class="lineNum">    4594 </span>            :   case 3:
<span class="lineNum">    4595 </span><span class="lineCov">       8572 :     if(!fxOverX0ShieldTrks || index&lt;0 || index&gt;=2*fNtracks) Error(&quot;CorrectForShieldMaterial&quot;,&quot;Incorrect usage of UseTGeo option!\n&quot;);</span>
<span class="lineNum">    4596 </span><span class="lineCov">       4286 :     if(fxOverX0ShieldTrks[index]&lt;0) {</span>
<span class="lineNum">    4597 </span><span class="lineCov">        188 :       if (!t-&gt;PropagateToTGeo(xToGo,1,xOverX0,lengthTimesMeanDensity)) return 0;</span>
<span class="lineNum">    4598 </span><span class="lineCov">        376 :       Double_t angle=TMath::Sqrt((1.+t-&gt;GetTgl()*t-&gt;GetTgl())/</span>
<span class="lineNum">    4599 </span><span class="lineCov">        188 :                                  ((1.-t-&gt;GetSnp())*(1.+t-&gt;GetSnp())));</span>
<span class="lineNum">    4600 </span><span class="lineCov">        188 :       fxOverX0ShieldTrks[index] = TMath::Abs(xOverX0)/angle;</span>
<span class="lineNum">    4601 </span><span class="lineCov">        188 :       fxTimesRhoShieldTrks[index] = TMath::Abs(lengthTimesMeanDensity)/angle;</span>
<span class="lineNum">    4602 </span>            :       return 1;
<span class="lineNum">    4603 </span>            :     }
<span class="lineNum">    4604 </span><span class="lineCov">       4098 :     xOverX0 = fxOverX0ShieldTrks[index];</span>
<span class="lineNum">    4605 </span><span class="lineCov">       4098 :     lengthTimesMeanDensity = fxTimesRhoShieldTrks[index];</span>
<span class="lineNum">    4606 </span><span class="lineCov">       4098 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">    4607 </span><span class="lineCov">       4098 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">    4608 </span>            :     break;
<span class="lineNum">    4609 </span>            :   }
<span class="lineNum">    4610 </span>            : 
<span class="lineNum">    4611 </span><span class="lineCov">       4554 :   return 1;</span>
<a name="4612"><span class="lineNum">    4612 </span><span class="lineCov">      14352 : }</span></a>
<span class="lineNum">    4613 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4614 </span>            : Int_t AliITStrackerMI::CorrectForLayerMaterial(AliITStrackMI *t,
<span class="lineNum">    4615 </span>            :                                                Int_t layerindex,
<span class="lineNum">    4616 </span>            :                                                Double_t oldGlobXYZ[3],
<span class="lineNum">    4617 </span>            :                                                TString direction) {
<span class="lineNum">    4618 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    4619 </span>            :   // Propagate beyond layer and correct for material
<span class="lineNum">    4620 </span>            :   // (material budget in different ways according to fUseTGeo value)
<span class="lineNum">    4621 </span>            :   // Add time if going outward (PropagateTo or PropagateToTGeo)
<span class="lineNum">    4622 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    4623 </span>            : 
<span class="lineNum">    4624 </span>            :   // Define budget mode:
<span class="lineNum">    4625 </span>            :   // 0: material from AliITSRecoParam (hard coded)
<span class="lineNum">    4626 </span>            :   // 1: material from TGeo in stepsof X cm (on the fly)
<span class="lineNum">    4627 </span>            :   //    X = AliITSRecoParam::GetStepSizeTGeo()
<span class="lineNum">    4628 </span>            :   // 2: material from lut
<span class="lineNum">    4629 </span>            :   // 3: material from TGeo in one step (same for all hypotheses)
<span class="lineNum">    4630 </span>            :   Int_t mode;
<span class="lineNum">    4631 </span><span class="lineCov">      28944 :   switch(fUseTGeo) {</span>
<span class="lineNum">    4632 </span>            :   case 0:
<span class="lineNum">    4633 </span>            :     mode=0; 
<span class="lineNum">    4634 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">    4635 </span>            :   case 1:
<span class="lineNum">    4636 </span>            :     mode=1;
<span class="lineNum">    4637 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">    4638 </span>            :   case 2:
<span class="lineNum">    4639 </span>            :     mode=2;
<span class="lineNum">    4640 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4641 </span>            :   case 3:
<span class="lineNum">    4642 </span><span class="lineCov">      14472 :     if(fTrackingPhase.Contains(&quot;Clusters2Tracks&quot;))</span>
<span class="lineNum">    4643 </span><span class="lineCov">      13082 :       { mode=3; } else { mode=1; }</span>
<span class="lineNum">    4644 </span>            :     break;
<span class="lineNum">    4645 </span>            :   case 4:
<span class="lineNum">    4646 </span><span class="lineNoCov">          0 :     if(fTrackingPhase.Contains(&quot;Clusters2Tracks&quot;)) </span>
<span class="lineNum">    4647 </span><span class="lineNoCov">          0 :       { mode=3; } else { mode=2; }</span>
<span class="lineNum">    4648 </span>            :     break;
<span class="lineNum">    4649 </span>            :   default:
<span class="lineNum">    4650 </span>            :     mode=0;
<span class="lineNum">    4651 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">    4652 </span>            :   }
<span class="lineNum">    4653 </span><span class="lineCov">      14684 :   if(fTrackingPhase.Contains(&quot;Default&quot;)) mode=0;</span>
<span class="lineNum">    4654 </span>            : 
<span class="lineNum">    4655 </span><span class="lineCov">      14472 :   Float_t  dir = (direction.Contains(&quot;inward&quot;) ? 1. : -1.);</span>
<span class="lineNum">    4656 </span>            : 
<span class="lineNum">    4657 </span><span class="lineCov">      14472 :   Double_t r=fgLayers[layerindex].GetR();</span>
<span class="lineNum">    4658 </span><span class="lineCov">      14472 :   Double_t deltar=(layerindex&lt;2 ? 0.10*r : 0.05*r);</span>
<span class="lineNum">    4659 </span>            : 
<span class="lineNum">    4660 </span><span class="lineCov">      14472 :   Double_t rToGo=TMath::Sqrt(t-&gt;GetX()*t-&gt;GetX()+t-&gt;GetY()*t-&gt;GetY())-deltar*dir;</span>
<span class="lineNum">    4661 </span><span class="lineCov">      14472 :   Double_t xToGo;</span>
<span class="lineNum">    4662 </span><span class="lineCov">      14473 :   if (!t-&gt;GetLocalXat(rToGo,xToGo)) return 0;</span>
<span class="lineNum">    4663 </span>            : 
<span class="lineNum">    4664 </span><span class="lineCov">      14471 :   Int_t index=6*fCurrentEsdTrack+layerindex;</span>
<span class="lineNum">    4665 </span>            : 
<span class="lineNum">    4666 </span>            : 
<span class="lineNum">    4667 </span><span class="lineCov">      14471 :   Double_t xOverX0=0.0,x0=0.0,lengthTimesMeanDensity=0.0;</span>
<span class="lineNum">    4668 </span>            :   Int_t nsteps=1;
<span class="lineNum">    4669 </span>            : 
<span class="lineNum">    4670 </span>            :   // back before material (no correction)
<span class="lineNum">    4671 </span><span class="lineCov">      14471 :   Double_t rOld,xOld;</span>
<span class="lineNum">    4672 </span><span class="lineCov">      14471 :   rOld=TMath::Sqrt(oldGlobXYZ[0]*oldGlobXYZ[0]+oldGlobXYZ[1]*oldGlobXYZ[1]);</span>
<span class="lineNum">    4673 </span><span class="lineCov">      14471 :   if (!t-&gt;GetLocalXat(rOld,xOld)) return 0;</span>
<span class="lineNum">    4674 </span><span class="lineCov">      14471 :   if (!t-&gt;Propagate(xOld)) return 0;</span>
<span class="lineNum">    4675 </span>            : 
<span class="lineNum">    4676 </span><span class="lineCov">      28374 :   switch(mode) {</span>
<span class="lineNum">    4677 </span>            :   case 0:
<span class="lineNum">    4678 </span><span class="lineCov">        212 :     xOverX0 = fgLayers[layerindex].GetThickness(t-&gt;GetY(),t-&gt;GetZ(),x0);</span>
<span class="lineNum">    4679 </span><span class="lineCov">        212 :     lengthTimesMeanDensity = xOverX0*x0;</span>
<span class="lineNum">    4680 </span><span class="lineCov">        212 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">    4681 </span>            :     // Bring the track beyond the material
<span class="lineNum">    4682 </span><span class="lineCov">        212 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">    4683 </span>            :     break;
<span class="lineNum">    4684 </span>            :   case 1:
<span class="lineNum">    4685 </span><span class="lineCov">       1177 :     nsteps = (Int_t)(TMath::Abs(xOld-xToGo)/AliITSReconstructor::GetRecoParam()-&gt;GetStepSizeTGeo())+1;</span>
<span class="lineNum">    4686 </span><span class="lineCov">       1177 :     if (!t-&gt;PropagateToTGeo(xToGo,nsteps)) return 0; // cross the material and apply correction</span>
<span class="lineNum">    4687 </span>            :     break;
<span class="lineNum">    4688 </span>            :   case 2:
<span class="lineNum">    4689 </span><span class="lineNoCov">          0 :     if(fxOverX0Layer[layerindex]&lt;0) BuildMaterialLUT(&quot;Layers&quot;);  </span>
<span class="lineNum">    4690 </span><span class="lineNoCov">          0 :     xOverX0 = fxOverX0Layer[layerindex];</span>
<span class="lineNum">    4691 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity = fxTimesRhoLayer[layerindex];</span>
<span class="lineNum">    4692 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">    4693 </span>            :     // Bring the track beyond the material
<span class="lineNum">    4694 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">    4695 </span>            :     break;
<span class="lineNum">    4696 </span>            :   case 3:
<span class="lineNum">    4697 </span><span class="lineCov">      26164 :     if(!fxOverX0LayerTrks || index&lt;0 || index&gt;=6*fNtracks) Error(&quot;CorrectForLayerMaterial&quot;,&quot;Incorrect usage of UseTGeo option!\n&quot;);</span>
<span class="lineNum">    4698 </span><span class="lineCov">      13082 :     if(fxOverX0LayerTrks[index]&lt;0) {</span>
<span class="lineNum">    4699 </span><span class="lineCov">        568 :       nsteps = (Int_t)(TMath::Abs(xOld-xToGo)/AliITSReconstructor::GetRecoParam()-&gt;GetStepSizeTGeo())+1;</span>
<span class="lineNum">    4700 </span><span class="lineCov">        568 :       if (!t-&gt;PropagateToTGeo(xToGo,nsteps,xOverX0,lengthTimesMeanDensity)) return 0;</span>
<span class="lineNum">    4701 </span><span class="lineCov">       1136 :       Double_t angle=TMath::Sqrt((1.+t-&gt;GetTgl()*t-&gt;GetTgl())/</span>
<span class="lineNum">    4702 </span><span class="lineCov">        568 :                                  ((1.-t-&gt;GetSnp())*(1.+t-&gt;GetSnp())));</span>
<span class="lineNum">    4703 </span><span class="lineCov">        568 :       fxOverX0LayerTrks[index] = TMath::Abs(xOverX0)/angle;</span>
<span class="lineNum">    4704 </span><span class="lineCov">        568 :       fxTimesRhoLayerTrks[index] = TMath::Abs(lengthTimesMeanDensity)/angle;</span>
<span class="lineNum">    4705 </span>            :       return 1;
<span class="lineNum">    4706 </span>            :     }
<span class="lineNum">    4707 </span><span class="lineCov">      12514 :     xOverX0 = fxOverX0LayerTrks[index];</span>
<span class="lineNum">    4708 </span><span class="lineCov">      12514 :     lengthTimesMeanDensity = fxTimesRhoLayerTrks[index];</span>
<span class="lineNum">    4709 </span><span class="lineCov">      12514 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">    4710 </span><span class="lineCov">      12514 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">    4711 </span>            :     break;
<span class="lineNum">    4712 </span>            :   }
<span class="lineNum">    4713 </span>            : 
<span class="lineNum">    4714 </span>            : 
<span class="lineNum">    4715 </span><span class="lineCov">      13903 :   return 1;</span>
<a name="4716"><span class="lineNum">    4716 </span><span class="lineCov">      28943 : }</span></a>
<span class="lineNum">    4717 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4718 </span>            : void AliITStrackerMI::MakeTrksMaterialLUT(Int_t ntracks) {
<span class="lineNum">    4719 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4720 </span>            :   // Initialize LUT for storing material for each prolonged track
<span class="lineNum">    4721 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4722 </span><span class="lineCov">         16 :   fxOverX0PipeTrks = new Float_t[ntracks]; </span>
<span class="lineNum">    4723 </span><span class="lineCov">          8 :   fxTimesRhoPipeTrks = new Float_t[ntracks]; </span>
<span class="lineNum">    4724 </span><span class="lineCov">          8 :   fxOverX0ShieldTrks = new Float_t[ntracks*2]; </span>
<span class="lineNum">    4725 </span><span class="lineCov">          8 :   fxTimesRhoShieldTrks = new Float_t[ntracks*2]; </span>
<span class="lineNum">    4726 </span><span class="lineCov">          8 :   fxOverX0LayerTrks = new Float_t[ntracks*6]; </span>
<span class="lineNum">    4727 </span><span class="lineCov">          8 :   fxTimesRhoLayerTrks = new Float_t[ntracks*6]; </span>
<span class="lineNum">    4728 </span>            : 
<span class="lineNum">    4729 </span><span class="lineCov">        288 :   for(Int_t i=0; i&lt;ntracks; i++) {</span>
<span class="lineNum">    4730 </span><span class="lineCov">        136 :     fxOverX0PipeTrks[i] = -1.;</span>
<span class="lineNum">    4731 </span><span class="lineCov">        136 :     fxTimesRhoPipeTrks[i] = -1.;</span>
<span class="lineNum">    4732 </span>            :   }
<span class="lineNum">    4733 </span><span class="lineCov">        560 :   for(Int_t j=0; j&lt;ntracks*2; j++) {</span>
<span class="lineNum">    4734 </span><span class="lineCov">        272 :     fxOverX0ShieldTrks[j] = -1.;</span>
<span class="lineNum">    4735 </span><span class="lineCov">        272 :     fxTimesRhoShieldTrks[j] = -1.;</span>
<span class="lineNum">    4736 </span>            :   }
<span class="lineNum">    4737 </span><span class="lineCov">       1648 :   for(Int_t k=0; k&lt;ntracks*6; k++) {</span>
<span class="lineNum">    4738 </span><span class="lineCov">        816 :     fxOverX0LayerTrks[k] = -1.;</span>
<span class="lineNum">    4739 </span><span class="lineCov">        816 :     fxTimesRhoLayerTrks[k] = -1.;</span>
<span class="lineNum">    4740 </span>            :   }
<span class="lineNum">    4741 </span>            : 
<span class="lineNum">    4742 </span><span class="lineCov">          8 :   fNtracks = ntracks;  </span>
<span class="lineNum">    4743 </span>            : 
<span class="lineNum">    4744 </span><span class="lineCov">          8 :   return;</span>
<a name="4745"><span class="lineNum">    4745 </span>            : }</a>
<span class="lineNum">    4746 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4747 </span>            : void AliITStrackerMI::DeleteTrksMaterialLUT() {
<span class="lineNum">    4748 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4749 </span>            :   // Delete LUT for storing material for each prolonged track
<span class="lineNum">    4750 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4751 </span><span class="lineCov">         20 :   if(fxOverX0PipeTrks) { </span>
<span class="lineNum">    4752 </span><span class="lineCov">         24 :     delete [] fxOverX0PipeTrks; fxOverX0PipeTrks = 0; </span>
<span class="lineNum">    4753 </span><span class="lineCov">          8 :   } </span>
<span class="lineNum">    4754 </span><span class="lineCov">         10 :   if(fxOverX0ShieldTrks) { </span>
<span class="lineNum">    4755 </span><span class="lineCov">         24 :     delete [] fxOverX0ShieldTrks; fxOverX0ShieldTrks = 0; </span>
<span class="lineNum">    4756 </span><span class="lineCov">          8 :   } </span>
<span class="lineNum">    4757 </span>            :   
<span class="lineNum">    4758 </span><span class="lineCov">         10 :   if(fxOverX0LayerTrks) { </span>
<span class="lineNum">    4759 </span><span class="lineCov">         24 :     delete [] fxOverX0LayerTrks;  fxOverX0LayerTrks = 0; </span>
<span class="lineNum">    4760 </span><span class="lineCov">          8 :   } </span>
<span class="lineNum">    4761 </span><span class="lineCov">         10 :   if(fxTimesRhoPipeTrks) { </span>
<span class="lineNum">    4762 </span><span class="lineCov">         24 :     delete [] fxTimesRhoPipeTrks;  fxTimesRhoPipeTrks = 0; </span>
<span class="lineNum">    4763 </span><span class="lineCov">          8 :   } </span>
<span class="lineNum">    4764 </span><span class="lineCov">         10 :   if(fxTimesRhoShieldTrks) { </span>
<span class="lineNum">    4765 </span><span class="lineCov">         24 :     delete [] fxTimesRhoShieldTrks; fxTimesRhoShieldTrks = 0; </span>
<span class="lineNum">    4766 </span><span class="lineCov">          8 :   } </span>
<span class="lineNum">    4767 </span><span class="lineCov">         10 :   if(fxTimesRhoLayerTrks) { </span>
<span class="lineNum">    4768 </span><span class="lineCov">         24 :     delete [] fxTimesRhoLayerTrks; fxTimesRhoLayerTrks = 0; </span>
<span class="lineNum">    4769 </span><span class="lineCov">          8 :   } </span>
<span class="lineNum">    4770 </span><span class="lineCov">         10 :   return;</span>
<a name="4771"><span class="lineNum">    4771 </span>            : }</a>
<span class="lineNum">    4772 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4773 </span>            : void AliITStrackerMI::SetForceSkippingOfLayer() {
<span class="lineNum">    4774 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4775 </span>            :   // Check if we are forced to skip layers
<span class="lineNum">    4776 </span>            :   // either we set to skip them in RecoParam
<span class="lineNum">    4777 </span>            :   // or they were off during data-taking
<span class="lineNum">    4778 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4779 </span>            : 
<span class="lineNum">    4780 </span><span class="lineCov">         16 :   const AliEventInfo *eventInfo = GetEventInfo();</span>
<span class="lineNum">    4781 </span>            :   
<span class="lineNum">    4782 </span><span class="lineCov">        112 :   for(Int_t l=0; l&lt;AliITSgeomTGeo::kNLayers; l++) {</span>
<span class="lineNum">    4783 </span><span class="lineCov">         48 :     fForceSkippingOfLayer[l] = 0;</span>
<span class="lineNum">    4784 </span>            :     // check reco param
<span class="lineNum">    4785 </span><span class="lineCov">         48 :     if(AliITSReconstructor::GetRecoParam()-&gt;GetLayersToSkip(l)) fForceSkippingOfLayer[l] = 1;</span>
<span class="lineNum">    4786 </span>            :     // check run info
<span class="lineNum">    4787 </span>            : 
<span class="lineNum">    4788 </span><span class="lineCov">         96 :     if(eventInfo &amp;&amp; </span>
<span class="lineNum">    4789 </span><span class="lineCov">         48 :        AliITSReconstructor::GetRecoParam()-&gt;GetSkipSubdetsNotInTriggerCluster()) {</span>
<span class="lineNum">    4790 </span><span class="lineCov">        144 :       AliDebug(2,Form(&quot;GetEventInfo-&gt;GetTriggerCluster: %s&quot;,eventInfo-&gt;GetTriggerCluster()));</span>
<span class="lineNum">    4791 </span><span class="lineCov">         48 :       if(l==0 || l==1)  {</span>
<span class="lineNum">    4792 </span><span class="lineCov">         16 :         if(!strstr(eventInfo-&gt;GetTriggerCluster(),&quot;ITSSPD&quot;)) fForceSkippingOfLayer[l] = 1;</span>
<span class="lineNum">    4793 </span><span class="lineCov">         64 :       } else if(l==2 || l==3) {</span>
<span class="lineNum">    4794 </span><span class="lineCov">         48 :         if(!strstr(eventInfo-&gt;GetTriggerCluster(),&quot;ITSSDD&quot;)) fForceSkippingOfLayer[l] = 1; </span>
<span class="lineNum">    4795 </span>            :       } else {
<span class="lineNum">    4796 </span><span class="lineCov">         16 :         if(!strstr(eventInfo-&gt;GetTriggerCluster(),&quot;ITSSSD&quot;)) fForceSkippingOfLayer[l] = 1;</span>
<span class="lineNum">    4797 </span>            :       } 
<span class="lineNum">    4798 </span>            :     }
<span class="lineNum">    4799 </span>            :   }
<span class="lineNum">    4800 </span>            :   return;
<a name="4801"><span class="lineNum">    4801 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">    4802 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4803 </span>            : Int_t AliITStrackerMI::CheckSkipLayer(const AliITStrackMI *track,
<span class="lineNum">    4804 </span>            :                                       Int_t ilayer,Int_t idet) const {
<span class="lineNum">    4805 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4806 </span>            :   // This method is used to decide whether to allow a prolongation 
<span class="lineNum">    4807 </span>            :   // without clusters, because we want to skip the layer.
<span class="lineNum">    4808 </span>            :   // In this case the return value is &gt; 0:
<span class="lineNum">    4809 </span>            :   // return 1: the user requested to skip a layer
<span class="lineNum">    4810 </span>            :   // return 2: track outside z acceptance
<span class="lineNum">    4811 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4812 </span>            : 
<span class="lineNum">    4813 </span><span class="lineCov">      27660 :   if (ForceSkippingOfLayer(ilayer)) return 1;</span>
<span class="lineNum">    4814 </span>            : 
<span class="lineNum">    4815 </span>            :   Int_t innerLayCanSkip=0; // was 2, changed on 05.11.2009
<span class="lineNum">    4816 </span>            : 
<span class="lineNum">    4817 </span><span class="lineCov">      13834 :   if (idet&lt;0 &amp;&amp;  // out in z</span>
<span class="lineNum">    4818 </span><span class="lineCov">          4 :       ilayer&gt;innerLayCanSkip &amp;&amp; </span>
<span class="lineNum">    4819 </span><span class="lineCov">          4 :       AliITSReconstructor::GetRecoParam()-&gt;GetExtendedEtaAcceptance()) {</span>
<span class="lineNum">    4820 </span>            :     // check if track will cross SPD outer layer
<span class="lineNum">    4821 </span><span class="lineCov">          4 :     Double_t phiAtSPD2,zAtSPD2;</span>
<span class="lineNum">    4822 </span><span class="lineCov">          4 :     if (track-&gt;GetPhiZat(fgLayers[1].GetR(),phiAtSPD2,zAtSPD2)) {</span>
<span class="lineNum">    4823 </span><span class="lineNoCov">          0 :       if (TMath::Abs(zAtSPD2)&lt;2.*AliITSRecoParam::GetSPDdetzlength()) return 2;</span>
<span class="lineNum">    4824 </span>            :     }
<span class="lineNum">    4825 </span><span class="lineCov">          4 :     return 2; // always allow skipping, changed on 05.11.2009</span>
<span class="lineNum">    4826 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">    4827 </span>            : 
<span class="lineNum">    4828 </span><span class="lineCov">      13826 :   return 0;</span>
<a name="4829"><span class="lineNum">    4829 </span><span class="lineCov">      13830 : }</span></a>
<span class="lineNum">    4830 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4831 </span>            : Int_t AliITStrackerMI::CheckDeadZone(AliITStrackMI *track,
<span class="lineNum">    4832 </span>            :                                      Int_t ilayer,Int_t idet,
<span class="lineNum">    4833 </span>            :                                      Double_t dz,Double_t dy,
<span class="lineNum">    4834 </span>            :                                      Bool_t noClusters) const {
<span class="lineNum">    4835 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4836 </span>            :   // This method is used to decide whether to allow a prolongation 
<span class="lineNum">    4837 </span>            :   // without clusters, because there is a dead zone in the road.
<span class="lineNum">    4838 </span>            :   // In this case the return value is &gt; 0:
<span class="lineNum">    4839 </span>            :   // return 1: dead zone at z=0,+-7cm in SPD
<span class="lineNum">    4840 </span>            :   //     This method assumes that fSPDdetzcentre is ordered from -z to +z
<span class="lineNum">    4841 </span>            :   // return 2: all road is &quot;bad&quot; (dead or noisy) from the OCDB
<span class="lineNum">    4842 </span>            :   // return 3: at least a chip is &quot;bad&quot; (dead or noisy) from the OCDB
<span class="lineNum">    4843 </span>            :   // return 4: at least a single channel is &quot;bad&quot; (dead or noisy) from the OCDB
<span class="lineNum">    4844 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4845 </span>            : 
<span class="lineNum">    4846 </span>            :   // check dead zones at z=0,+-7cm in the SPD
<span class="lineNum">    4847 </span><span class="lineCov">       6744 :   if (ilayer&lt;2 &amp;&amp; !AliITSReconstructor::GetRecoParam()-&gt;GetAddVirtualClustersInDeadZone()) {</span>
<span class="lineNum">    4848 </span><span class="lineCov">       7224 :     Double_t zmindead[3]={fSPDdetzcentre[0] + 0.5*AliITSRecoParam::GetSPDdetzlength(),</span>
<span class="lineNum">    4849 </span><span class="lineCov">       2408 :                           fSPDdetzcentre[1] + 0.5*AliITSRecoParam::GetSPDdetzlength(),</span>
<span class="lineNum">    4850 </span><span class="lineCov">       2408 :                           fSPDdetzcentre[2] + 0.5*AliITSRecoParam::GetSPDdetzlength()};</span>
<span class="lineNum">    4851 </span><span class="lineCov">       7224 :     Double_t zmaxdead[3]={fSPDdetzcentre[1] - 0.5*AliITSRecoParam::GetSPDdetzlength(),</span>
<span class="lineNum">    4852 </span><span class="lineCov">       2408 :                           fSPDdetzcentre[2] - 0.5*AliITSRecoParam::GetSPDdetzlength(),</span>
<span class="lineNum">    4853 </span><span class="lineCov">       2408 :                           fSPDdetzcentre[3] - 0.5*AliITSRecoParam::GetSPDdetzlength()};</span>
<span class="lineNum">    4854 </span><span class="lineCov">      16502 :     for (Int_t i=0; i&lt;3; i++)</span>
<span class="lineNum">    4855 </span><span class="lineCov">       9690 :       if (track-&gt;GetZ()-dz&lt;zmaxdead[i] &amp;&amp; track-&gt;GetZ()+dz&gt;zmindead[i]) {</span>
<span class="lineNum">    4856 </span><span class="lineCov">       4344 :         AliDebug(2,Form(&quot;crack SPD %d track z %f   %f   %f  %f\n&quot;,ilayer,track-&gt;GetZ(),dz,zmaxdead[i],zmindead[i]));</span>
<span class="lineNum">    4857 </span><span class="lineCov">       2482 :         if (GetSPDDeadZoneProbability(track-&gt;GetZ(),TMath::Sqrt(track-&gt;GetSigmaZ2()))&gt;0.1) return 1; </span>
<span class="lineNum">    4858 </span>            :       } 
<span class="lineNum">    4859 </span><span class="lineCov">       3782 :   }</span>
<span class="lineNum">    4860 </span>            : 
<span class="lineNum">    4861 </span>            :   // check bad zones from OCDB
<span class="lineNum">    4862 </span><span class="lineCov">       3302 :   if (!AliITSReconstructor::GetRecoParam()-&gt;GetUseBadZonesFromOCDB()) return 0;</span>
<span class="lineNum">    4863 </span>            : 
<span class="lineNum">    4864 </span><span class="lineCov">       3302 :   if (idet&lt;0) return 0;</span>
<span class="lineNum">    4865 </span>            : 
<span class="lineNum">    4866 </span><span class="lineCov">       3302 :   AliITSdetector &amp;det=fgLayers[ilayer].GetDetector(idet);  </span>
<span class="lineNum">    4867 </span>            : 
<span class="lineNum">    4868 </span>            :   Int_t detType=-1;
<span class="lineNum">    4869 </span>            :   Float_t detSizeFactorX=0.0001,detSizeFactorZ=0.0001;
<span class="lineNum">    4870 </span><span class="lineCov">       3302 :   if (ilayer==0 || ilayer==1) {        // ----------  SPD</span>
<span class="lineNum">    4871 </span>            :     detType = 0;
<span class="lineNum">    4872 </span><span class="lineCov">       3302 :   } else if (ilayer==2 || ilayer==3) { // ----------  SDD</span>
<span class="lineNum">    4873 </span>            :     detType = 1;
<span class="lineNum">    4874 </span>            :     detSizeFactorX *= 2.;
<span class="lineNum">    4875 </span><span class="lineCov">       1928 :   } else if (ilayer==4 || ilayer==5) { // ----------  SSD</span>
<span class="lineNum">    4876 </span>            :     detType = 2;
<span class="lineNum">    4877 </span><span class="lineCov">        836 :   }</span>
<span class="lineNum">    4878 </span><span class="lineCov">       3302 :   AliITSsegmentation *segm = (AliITSsegmentation*)fkDetTypeRec-&gt;GetSegmentationModel(detType);</span>
<span class="lineNum">    4879 </span><span class="lineCov">       4138 :   if (detType==2) segm-&gt;SetLayer(ilayer+1);</span>
<span class="lineNum">    4880 </span><span class="lineCov">       3302 :   Float_t detSizeX = detSizeFactorX*segm-&gt;Dx(); </span>
<span class="lineNum">    4881 </span><span class="lineCov">       3302 :   Float_t detSizeZ = detSizeFactorZ*segm-&gt;Dz(); </span>
<span class="lineNum">    4882 </span>            : 
<span class="lineNum">    4883 </span>            :   // check if the road overlaps with bad chips
<span class="lineNum">    4884 </span><span class="lineCov">       3302 :   Float_t xloc,zloc;</span>
<span class="lineNum">    4885 </span><span class="lineCov">       3302 :   if(!(LocalModuleCoord(ilayer,idet,track,xloc,zloc)))return 0;</span>
<span class="lineNum">    4886 </span><span class="lineCov">       3302 :   Float_t zlocmin = zloc-dz;</span>
<span class="lineNum">    4887 </span><span class="lineCov">       3302 :   Float_t zlocmax = zloc+dz;</span>
<span class="lineNum">    4888 </span><span class="lineCov">       3302 :   Float_t xlocmin = xloc-dy;</span>
<span class="lineNum">    4889 </span><span class="lineCov">       3302 :   Float_t xlocmax = xloc+dy;</span>
<span class="lineNum">    4890 </span><span class="lineCov">       3302 :   Int_t chipsInRoad[100]={0};</span>
<span class="lineNum">    4891 </span>            : 
<span class="lineNum">    4892 </span>            :   // check if road goes out of detector
<span class="lineNum">    4893 </span>            :   Bool_t touchNeighbourDet=kFALSE; 
<span class="lineNum">    4894 </span><span class="lineCov">       3567 :   if (TMath::Abs(xlocmin)&gt;0.5*detSizeX) {xlocmin=-0.4999*detSizeX; touchNeighbourDet=kTRUE;} </span>
<span class="lineNum">    4895 </span><span class="lineCov">       3545 :   if (TMath::Abs(xlocmax)&gt;0.5*detSizeX) {xlocmax=+0.4999*detSizeX; touchNeighbourDet=kTRUE;} </span>
<span class="lineNum">    4896 </span><span class="lineCov">       4072 :   if (TMath::Abs(zlocmin)&gt;0.5*detSizeZ) {zlocmin=-0.4999*detSizeZ; touchNeighbourDet=kTRUE;} </span>
<span class="lineNum">    4897 </span><span class="lineCov">       4234 :   if (TMath::Abs(zlocmax)&gt;0.5*detSizeZ) {zlocmax=+0.4999*detSizeZ; touchNeighbourDet=kTRUE;} </span>
<span class="lineNum">    4898 </span><span class="lineCov">       9906 :   AliDebug(2,Form(&quot;layer %d det %d zmim zmax %f %f xmin xmax %f %f   %f %f&quot;,ilayer,idet,zlocmin,zlocmax,xlocmin,xlocmax,detSizeZ,detSizeX));</span>
<span class="lineNum">    4899 </span>            : 
<span class="lineNum">    4900 </span>            :   // check if this detector is bad
<span class="lineNum">    4901 </span><span class="lineCov">       3302 :   if (det.IsBad()) {</span>
<span class="lineNum">    4902 </span><span class="lineCov">        684 :     AliDebug(2,Form(&quot;lay %d  bad detector %d&quot;,ilayer,idet));</span>
<span class="lineNum">    4903 </span><span class="lineCov">        228 :     if(!touchNeighbourDet) {</span>
<span class="lineNum">    4904 </span><span class="lineCov">        162 :       return 2; // all detectors in road are bad</span>
<span class="lineNum">    4905 </span>            :     } else { 
<span class="lineNum">    4906 </span><span class="lineCov">         66 :       return 3; // at least one is bad</span>
<span class="lineNum">    4907 </span>            :     }
<span class="lineNum">    4908 </span>            :   }
<span class="lineNum">    4909 </span>            : 
<span class="lineNum">    4910 </span><span class="lineCov">       3074 :   if(zlocmin&gt;zlocmax)return 0;</span>
<span class="lineNum">    4911 </span><span class="lineCov">       3074 :   Int_t nChipsInRoad = segm-&gt;GetChipsInLocalWindow(chipsInRoad,zlocmin,zlocmax,xlocmin,xlocmax);</span>
<span class="lineNum">    4912 </span><span class="lineCov">       9222 :   AliDebug(2,Form(&quot;lay %d nChipsInRoad %d&quot;,ilayer,nChipsInRoad));</span>
<span class="lineNum">    4913 </span><span class="lineCov">       3076 :   if (!nChipsInRoad) return 0;</span>
<span class="lineNum">    4914 </span>            : 
<span class="lineNum">    4915 </span>            :   Bool_t anyBad=kFALSE,anyGood=kFALSE;
<span class="lineNum">    4916 </span><span class="lineCov">      17200 :   for (Int_t iCh=0; iCh&lt;nChipsInRoad; iCh++) {</span>
<span class="lineNum">    4917 </span><span class="lineCov">      11056 :     if (chipsInRoad[iCh]&lt;0 || chipsInRoad[iCh]&gt;det.GetNChips()-1) continue;</span>
<span class="lineNum">    4918 </span><span class="lineCov">      16584 :     AliDebug(2,Form(&quot;  chip %d bad %d&quot;,chipsInRoad[iCh],(Int_t)det.IsChipBad(chipsInRoad[iCh])));</span>
<span class="lineNum">    4919 </span><span class="lineCov">       5528 :     if (det.IsChipBad(chipsInRoad[iCh])) {</span>
<span class="lineNum">    4920 </span>            :       anyBad=kTRUE;
<span class="lineNum">    4921 </span><span class="lineCov">         19 :     } else {</span>
<span class="lineNum">    4922 </span>            :       anyGood=kTRUE;
<span class="lineNum">    4923 </span>            :     } 
<span class="lineNum">    4924 </span>            :   }
<span class="lineNum">    4925 </span>            : 
<span class="lineNum">    4926 </span><span class="lineCov">       3072 :   if (!anyGood) {</span>
<span class="lineNum">    4927 </span><span class="lineNoCov">          0 :     if(!touchNeighbourDet) {</span>
<span class="lineNum">    4928 </span><span class="lineNoCov">          0 :       AliDebug(2,&quot;all bad in road&quot;);</span>
<span class="lineNum">    4929 </span><span class="lineNoCov">          0 :       return 2;  // all chips in road are bad</span>
<span class="lineNum">    4930 </span>            :     } else {
<span class="lineNum">    4931 </span><span class="lineNoCov">          0 :       return 3; // at least a bad chip in road</span>
<span class="lineNum">    4932 </span>            :     }
<span class="lineNum">    4933 </span>            :   }
<span class="lineNum">    4934 </span>            : 
<span class="lineNum">    4935 </span><span class="lineCov">       3072 :   if (anyBad) {</span>
<span class="lineNum">    4936 </span><span class="lineCov">         30 :     AliDebug(2,&quot;at least a bad in road&quot;);</span>
<span class="lineNum">    4937 </span><span class="lineCov">         10 :     return 3; // at least a bad chip in road</span>
<span class="lineNum">    4938 </span>            :   } 
<span class="lineNum">    4939 </span>            : 
<span class="lineNum">    4940 </span>            : 
<span class="lineNum">    4941 </span><span class="lineCov">       6124 :   if (!AliITSReconstructor::GetRecoParam()-&gt;GetUseSingleBadChannelsFromOCDB()</span>
<span class="lineNum">    4942 </span><span class="lineCov">       8414 :       || !noClusters) return 0;</span>
<span class="lineNum">    4943 </span>            : 
<span class="lineNum">    4944 </span>            :   // There are no clusters in road: check if there is at least 
<span class="lineNum">    4945 </span>            :   // a bad SPD pixel or SDD anode or SSD strips on both sides
<span class="lineNum">    4946 </span>            : 
<span class="lineNum">    4947 </span>            :   Int_t idetInITS=idet;
<span class="lineNum">    4948 </span><span class="lineCov">       5132 :   for(Int_t l=0;l&lt;ilayer;l++) idetInITS+=AliITSgeomTGeo::GetNLadders(l+1)*AliITSgeomTGeo::GetNDetectors(l+1);</span>
<span class="lineNum">    4949 </span>            : 
<span class="lineNum">    4950 </span><span class="lineCov">        772 :   if (fITSChannelStatus-&gt;AnyBadInRoad(idetInITS,zlocmin,zlocmax,xlocmin,xlocmax)) {</span>
<span class="lineNum">    4951 </span><span class="lineCov">        630 :     AliDebug(2,Form(&quot;Bad channel in det %d of layer %d\n&quot;,idet,ilayer));</span>
<span class="lineNum">    4952 </span><span class="lineCov">        210 :     return 4;</span>
<span class="lineNum">    4953 </span>            :   }
<span class="lineNum">    4954 </span>            :   //if (fITSChannelStatus-&gt;FractionOfBadInRoad(idet,zlocmin,zlocmax,xlocmin,xlocmax) &gt; AliITSReconstructor::GetRecoParam()-&gt;GetMinFractionOfBadInRoad()) return 3;
<span class="lineNum">    4955 </span>            : 
<span class="lineNum">    4956 </span><span class="lineCov">        562 :   return 0;</span>
<a name="4957"><span class="lineNum">    4957 </span><span class="lineCov">      10940 : }</span></a>
<span class="lineNum">    4958 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4959 </span>            : Bool_t AliITStrackerMI::LocalModuleCoord(Int_t ilayer,Int_t idet,
<span class="lineNum">    4960 </span>            :                                        const AliITStrackMI *track,
<span class="lineNum">    4961 </span>            :                                        Float_t &amp;xloc,Float_t &amp;zloc) const {
<span class="lineNum">    4962 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4963 </span>            :   // Gives position of track in local module ref. frame
<span class="lineNum">    4964 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4965 </span>            : 
<span class="lineNum">    4966 </span><span class="lineCov">      37912 :   xloc=0.; </span>
<span class="lineNum">    4967 </span><span class="lineCov">      18956 :   zloc=0.;</span>
<span class="lineNum">    4968 </span>            : 
<span class="lineNum">    4969 </span><span class="lineCov">      18960 :   if(idet&lt;0) return kTRUE; // track out of z acceptance of layer</span>
<span class="lineNum">    4970 </span>            : 
<span class="lineNum">    4971 </span><span class="lineCov">      18952 :   Int_t ndet=AliITSgeomTGeo::GetNDetectors(ilayer+1); // layers from 1 to 6 </span>
<span class="lineNum">    4972 </span>            : 
<span class="lineNum">    4973 </span><span class="lineCov">      18952 :   Int_t lad = Int_t(idet/ndet) + 1;</span>
<span class="lineNum">    4974 </span>            : 
<span class="lineNum">    4975 </span><span class="lineCov">      18952 :   Int_t det = idet - (lad-1)*ndet + 1;</span>
<span class="lineNum">    4976 </span>            : 
<span class="lineNum">    4977 </span><span class="lineCov">      18952 :   Double_t xyzGlob[3]={0},xyzLoc[3]={0};</span>
<span class="lineNum">    4978 </span>            : 
<span class="lineNum">    4979 </span><span class="lineCov">      18952 :   AliITSdetector &amp;detector = fgLayers[ilayer].GetDetector(idet);</span>
<span class="lineNum">    4980 </span>            :   // take into account the misalignment: xyz at real detector plane
<span class="lineNum">    4981 </span><span class="lineCov">      18952 :   if(!track-&gt;GetXYZAt(detector.GetRmisal(),GetBz(),xyzGlob)) return kFALSE;</span>
<span class="lineNum">    4982 </span>            : 
<span class="lineNum">    4983 </span><span class="lineCov">      18952 :   if(!AliITSgeomTGeo::GlobalToLocal(ilayer+1,lad,det,xyzGlob,xyzLoc)) return kFALSE;</span>
<span class="lineNum">    4984 </span>            : 
<span class="lineNum">    4985 </span><span class="lineCov">      18952 :   xloc = (Float_t)xyzLoc[0];</span>
<span class="lineNum">    4986 </span><span class="lineCov">      18952 :   zloc = (Float_t)xyzLoc[2];</span>
<span class="lineNum">    4987 </span>            : 
<span class="lineNum">    4988 </span><span class="lineCov">      18952 :   return kTRUE;</span>
<span class="lineNum">    4989 </span><span class="lineCov">      37908 : }</span>
<a name="4990"><span class="lineNum">    4990 </span>            : //------------------------------------------------------------------------</a>
<span class="lineNum">    4991 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    4992 </span>            : Bool_t AliITStrackerMI::IsOKForPlaneEff(const AliITStrackMI* track, const Int_t *clusters, Int_t ilayer){
<span class="lineNum">    4993 </span>            : //
<span class="lineNum">    4994 </span>            : // Method to be optimized further: 
<span class="lineNum">    4995 </span>            : // Aim: decide whether a track can be used for PlaneEff evaluation
<span class="lineNum">    4996 </span>            : //      the decision is taken based on the track quality at the layer under study
<span class="lineNum">    4997 </span>            : //      no information on the clusters on this layer has to be used
<span class="lineNum">    4998 </span>            : //      The criterium is to reject tracks at boundaries between basic block (e.g. SPD chip)
<span class="lineNum">    4999 </span>            : //      the cut is done on number of sigmas from the boundaries
<span class="lineNum">    5000 </span>            : //
<span class="lineNum">    5001 </span>            : //  Input: Actual track, layer [0,5] under study
<span class="lineNum">    5002 </span>            : //  Output: none
<span class="lineNum">    5003 </span>            : //  Return: kTRUE if this is a good track
<span class="lineNum">    5004 </span>            : //
<span class="lineNum">    5005 </span>            : // it will apply a pre-selection to obtain good quality tracks.  
<span class="lineNum">    5006 </span>            : // Here also  you will have the possibility to put a control on the 
<span class="lineNum">    5007 </span>            : // impact point of the track on the basic block, in order to exclude border regions 
<span class="lineNum">    5008 </span>            : // this will be done by calling a proper method of the AliITSPlaneEff class.  
<span class="lineNum">    5009 </span>            : //
<span class="lineNum">    5010 </span>            : // input: AliITStrackMI* track, ilayer= layer number [0,5]
<span class="lineNum">    5011 </span>            : // return: Bool_t   -&gt; kTRUE if usable track, kFALSE if not usable. 
<span class="lineNum">    5012 </span>            : //
<span class="lineNum">    5013 </span><span class="lineNoCov">          0 :   Int_t index[AliITSgeomTGeo::kNLayers]={0};</span>
<span class="lineNum">    5014 </span>            :   Int_t k;
<span class="lineNum">    5015 </span><span class="lineNoCov">          0 :   for (k=0; k&lt;AliITSgeomTGeo::GetNLayers(); k++) index[k]=-1;</span>
<span class="lineNum">    5016 </span>            :   //
<span class="lineNum">    5017 </span><span class="lineNoCov">          0 :   for (k=0; k&lt;AliITSgeomTGeo::GetNLayers(); k++) {</span>
<span class="lineNum">    5018 </span><span class="lineNoCov">          0 :     index[k]=clusters[k];</span>
<span class="lineNum">    5019 </span>            :   }
<span class="lineNum">    5020 </span>            : 
<span class="lineNum">    5021 </span><span class="lineNoCov">          0 :   if(!fPlaneEff)</span>
<span class="lineNum">    5022 </span><span class="lineNoCov">          0 :     {AliWarning(&quot;IsOKForPlaneEff: null pointer to AliITSPlaneEff&quot;); return kFALSE;}</span>
<span class="lineNum">    5023 </span><span class="lineNoCov">          0 :   AliITSlayer &amp;layer=fgLayers[ilayer];</span>
<span class="lineNum">    5024 </span><span class="lineNoCov">          0 :   Double_t r=layer.GetR();</span>
<span class="lineNum">    5025 </span><span class="lineNoCov">          0 :   AliITStrackMI tmp(*track);</span>
<span class="lineNum">    5026 </span>            : 
<span class="lineNum">    5027 </span>            : // require a minimal number of cluster in other layers and eventually clusters in closest layers 
<span class="lineNum">    5028 </span>            :   Int_t nclout=0; Int_t nclin=0;
<span class="lineNum">    5029 </span><span class="lineNoCov">          0 :   for(Int_t lay=AliITSgeomTGeo::kNLayers-1;lay&gt;ilayer;lay--) { // count n. of cluster in outermost layers</span>
<span class="lineNum">    5030 </span><span class="lineNoCov">          0 :  AliDebug(2,Form(&quot;trak=%d  lay=%d  ; index=%d ESD label= %d&quot;,tmp.GetLabel(),lay,</span>
<span class="lineNum">    5031 </span>            :                     tmp.GetClIndex(lay),((AliESDtrack*)tmp.GetESDtrack())-&gt;GetLabel())) ;
<span class="lineNum">    5032 </span>            :    // if (tmp.GetClIndex(lay)&gt;=0) nclout++;
<span class="lineNum">    5033 </span><span class="lineNoCov">          0 : if(index[lay]&gt;=0)nclout++;</span>
<span class="lineNum">    5034 </span>            :   }
<span class="lineNum">    5035 </span><span class="lineNoCov">          0 :   for(Int_t lay=ilayer-1; lay&gt;=0;lay--) { // count n. of cluster in innermost layers</span>
<span class="lineNum">    5036 </span><span class="lineNoCov">          0 :     AliDebug(2,Form(&quot;trak=%d  lay=%d  ; index=%d ESD label= %d&quot;,tmp.GetLabel(),lay,</span>
<span class="lineNum">    5037 </span>            :                     tmp.GetClIndex(lay),((AliESDtrack*)tmp.GetESDtrack())-&gt;GetLabel())) ;
<span class="lineNum">    5038 </span><span class="lineNoCov">          0 :    if (index[lay]&gt;=0) nclin++; </span>
<span class="lineNum">    5039 </span>            :   }
<span class="lineNum">    5040 </span><span class="lineNoCov">          0 :   Int_t ncl=nclout+nclin;</span>
<span class="lineNum">    5041 </span>            :   Bool_t nextout = kFALSE;
<span class="lineNum">    5042 </span><span class="lineNoCov">          0 :   if(ilayer==AliITSgeomTGeo::kNLayers-1) nextout=kTRUE; // you are already on the outermost layer</span>
<span class="lineNum">    5043 </span><span class="lineNoCov">          0 :   else nextout = ((tmp.GetClIndex(ilayer+1)&gt;=0)? kTRUE : kFALSE );</span>
<span class="lineNum">    5044 </span>            :   Bool_t nextin = kFALSE;
<span class="lineNum">    5045 </span><span class="lineNoCov">          0 :   if(ilayer==0) nextin=kTRUE; // you are already on the innermost layer</span>
<span class="lineNum">    5046 </span><span class="lineNoCov">          0 :   else nextin = ((index[ilayer-1]&gt;=0)? kTRUE : kFALSE );</span>
<span class="lineNum">    5047 </span>            :   // maximum number of missing clusters allowed in outermost layers
<span class="lineNum">    5048 </span><span class="lineNoCov">          0 :   if(nclout&lt;AliITSgeomTGeo::kNLayers-(ilayer+1)-AliITSReconstructor::GetRecoParam()-&gt;GetMaxMissingClustersOutPlaneEff()) </span>
<span class="lineNum">    5049 </span><span class="lineNoCov">          0 :      return kFALSE; </span>
<span class="lineNum">    5050 </span>            :   // maximum number of missing clusters allowed (both in innermost and in outermost layers)
<span class="lineNum">    5051 </span><span class="lineNoCov">          0 :   if(ncl&lt;AliITSgeomTGeo::kNLayers-1-AliITSReconstructor::GetRecoParam()-&gt;GetMaxMissingClustersPlaneEff()) </span>
<span class="lineNum">    5052 </span><span class="lineNoCov">          0 :      return kFALSE; </span>
<span class="lineNum">    5053 </span><span class="lineNoCov">          0 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetRequireClusterInOuterLayerPlaneEff() &amp;&amp; !nextout)  return kFALSE;</span>
<span class="lineNum">    5054 </span><span class="lineNoCov">          0 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetRequireClusterInInnerLayerPlaneEff() &amp;&amp; !nextin)   return kFALSE;</span>
<span class="lineNum">    5055 </span><span class="lineNoCov">          0 :   if(tmp.Pt() &lt; AliITSReconstructor::GetRecoParam()-&gt;GetMinPtPlaneEff()) return kFALSE;</span>
<span class="lineNum">    5056 </span>            :  //  if(AliITSReconstructor::GetRecoParam()-&gt;GetOnlyConstraintPlaneEff()  &amp;&amp; !tmp.GetConstrain()) return kFALSE;
<span class="lineNum">    5057 </span>            : 
<span class="lineNum">    5058 </span>            : // detector number
<span class="lineNum">    5059 </span><span class="lineNoCov">          0 :   Double_t phi,z;</span>
<span class="lineNum">    5060 </span><span class="lineNoCov">          0 :   if (!tmp.GetPhiZat(r,phi,z)) return kFALSE;</span>
<span class="lineNum">    5061 </span><span class="lineNoCov">          0 :   Int_t idet=layer.FindDetectorIndex(phi,z);</span>
<span class="lineNum">    5062 </span><span class="lineNoCov">          0 :   if(idet&lt;0) { AliInfo(Form(&quot;cannot find detector&quot;));</span>
<span class="lineNum">    5063 </span><span class="lineNoCov">          0 :     return kFALSE;}</span>
<span class="lineNum">    5064 </span>            : 
<span class="lineNum">    5065 </span>            :   // here check if it has good Chi Square.
<span class="lineNum">    5066 </span>            : 
<span class="lineNum">    5067 </span>            :   //propagate to the intersection with the detector plane
<span class="lineNum">    5068 </span><span class="lineNoCov">          0 :   const AliITSdetector &amp;det=layer.GetDetector(idet);</span>
<span class="lineNum">    5069 </span><span class="lineNoCov">          0 :   if (!tmp.Propagate(det.GetPhi(),det.GetR())) return kFALSE;</span>
<span class="lineNum">    5070 </span>            : 
<span class="lineNum">    5071 </span><span class="lineNoCov">          0 :   Float_t locx; //</span>
<span class="lineNum">    5072 </span><span class="lineNoCov">          0 :   Float_t locz; //</span>
<span class="lineNum">    5073 </span><span class="lineNoCov">          0 :   if(!LocalModuleCoord(ilayer,idet,&amp;tmp,locx,locz)) return kFALSE;</span>
<span class="lineNum">    5074 </span><span class="lineNoCov">          0 :   UInt_t key=fPlaneEff-&gt;GetKeyFromDetLocCoord(ilayer,idet,locx,locz);</span>
<span class="lineNum">    5075 </span><span class="lineNoCov">          0 :   if(key&gt;fPlaneEff-&gt;Nblock()) return kFALSE;</span>
<span class="lineNum">    5076 </span><span class="lineNoCov">          0 :   Float_t blockXmn,blockXmx,blockZmn,blockZmx;</span>
<span class="lineNum">    5077 </span><span class="lineNoCov">          0 :   if (!fPlaneEff-&gt;GetBlockBoundaries(key,blockXmn,blockXmx,blockZmn,blockZmx)) return kFALSE;</span>
<span class="lineNum">    5078 </span>            :   //***************
<span class="lineNum">    5079 </span>            :   // DEFINITION OF SEARCH ROAD FOR accepting a track
<span class="lineNum">    5080 </span>            :   //
<span class="lineNum">    5081 </span><span class="lineNoCov">          0 :   Double_t nsigx=AliITSReconstructor::GetRecoParam()-&gt;GetNSigXFromBoundaryPlaneEff();</span>
<span class="lineNum">    5082 </span><span class="lineNoCov">          0 :   Double_t nsigz=AliITSReconstructor::GetRecoParam()-&gt;GetNSigZFromBoundaryPlaneEff();</span>
<span class="lineNum">    5083 </span><span class="lineNoCov">          0 :   Double_t distx=AliITSReconstructor::GetRecoParam()-&gt;GetDistXFromBoundaryPlaneEff();</span>
<span class="lineNum">    5084 </span><span class="lineNoCov">          0 :   Double_t distz=AliITSReconstructor::GetRecoParam()-&gt;GetDistZFromBoundaryPlaneEff();</span>
<span class="lineNum">    5085 </span><span class="lineNoCov">          0 :   Double_t dx=nsigx*TMath::Sqrt(tmp.GetSigmaY2()) + distx;</span>
<span class="lineNum">    5086 </span>            :   // those are precisions in the tracking reference system
<span class="lineNum">    5087 </span><span class="lineNoCov">          0 :   Double_t dz=nsigz*TMath::Sqrt(tmp.GetSigmaZ2()) + distz;</span>
<span class="lineNum">    5088 </span>            :   // Use it also for the module reference system, as it is done for RecPoints
<span class="lineNum">    5089 </span>            : 
<span class="lineNum">    5090 </span><span class="lineNoCov">          0 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetSwitchOnMaxDistNSigFrmBndPlaneEff()){</span>
<span class="lineNum">    5091 </span><span class="lineNoCov">          0 :    if(nsigx*TMath::Sqrt(tmp.GetSigmaY2())&lt;=distx) dx -= nsigx*TMath::Sqrt(tmp.GetSigmaY2());</span>
<span class="lineNum">    5092 </span><span class="lineNoCov">          0 :    else dx -= distx;</span>
<span class="lineNum">    5093 </span>            : 
<span class="lineNum">    5094 </span><span class="lineNoCov">          0 :    if(nsigz*TMath::Sqrt(tmp.GetSigmaZ2())&lt;=distz) dz -= nsigz*TMath::Sqrt(tmp.GetSigmaZ2());</span>
<span class="lineNum">    5095 </span><span class="lineNoCov">          0 :    else dz -= distz;</span>
<span class="lineNum">    5096 </span>            :   }
<span class="lineNum">    5097 </span>            : 
<span class="lineNum">    5098 </span>            :   // exclude tracks at boundary between detectors
<span class="lineNum">    5099 </span>            :   //Double_t boundaryWidth=AliITSRecoParam::GetBoundaryWidthPlaneEff();
<span class="lineNum">    5100 </span>            :   Double_t boundaryWidth=0; // for the time being hard-wired, later on from AliITSRecoParam
<span class="lineNum">    5101 </span><span class="lineNoCov">          0 :   AliDebug(2,Form(&quot;Tracking: track impact x=%f, y=%f, z=%f&quot;,tmp.GetX(), tmp.GetY(), tmp.GetZ()));</span>
<span class="lineNum">    5102 </span><span class="lineNoCov">          0 :   AliDebug(2,Form(&quot;Local:    track impact x=%f, z=%f&quot;,locx,locz));</span>
<span class="lineNum">    5103 </span><span class="lineNoCov">          0 :   AliDebug(2,Form(&quot;Search Road. Tracking: dy=%f , dz=%f&quot;,dx,dz));</span>
<span class="lineNum">    5104 </span><span class="lineNoCov">          0 :   if ( (locx-dx &lt; blockXmn+boundaryWidth) ||</span>
<span class="lineNum">    5105 </span><span class="lineNoCov">          0 :        (locx+dx &gt; blockXmx-boundaryWidth) ||</span>
<span class="lineNum">    5106 </span><span class="lineNoCov">          0 :        (locz-dz &lt; blockZmn+boundaryWidth) ||</span>
<span class="lineNum">    5107 </span><span class="lineNoCov">          0 :        (locz+dz &gt; blockZmx-boundaryWidth) ) return kFALSE;</span>
<span class="lineNum">    5108 </span>            : 
<span class="lineNum">    5109 </span><span class="lineNoCov">          0 :   if(ilayer==0){</span>
<span class="lineNum">    5110 </span><span class="lineNoCov">          0 :        const AliESDEvent *myesd = ((AliESDtrack*)tmp.GetESDtrack())-&gt;GetESDEvent();</span>
<span class="lineNum">    5111 </span>            :        //The beam pipe
<span class="lineNum">    5112 </span><span class="lineNoCov">          0 :        if (CorrectForPipeMaterial(&amp;tmp,&quot;inward&quot;)) {</span>
<span class="lineNum">    5113 </span><span class="lineNoCov">          0 :           const AliESDVertex* vtx = myesd-&gt;GetVertex();</span>
<span class="lineNum">    5114 </span><span class="lineNoCov">          0 :           if(!vtx) return kFALSE;</span>
<span class="lineNum">    5115 </span><span class="lineNoCov">          0 :           Double_t ddz[2]={0},cov[3]={0};</span>
<span class="lineNum">    5116 </span>            :           Double_t maxD=3.;
<span class="lineNum">    5117 </span><span class="lineNoCov">          0 :           if(!tmp.PropagateToDCA(vtx,AliTracker::GetBz(),maxD,ddz,cov)) return kFALSE;</span>
<span class="lineNum">    5118 </span><span class="lineNoCov">          0 :           if(TMath::Abs(ddz[0])&gt;=AliITSReconstructor::GetRecoParam()-&gt;GetDCACutPlaneEff()) return kFALSE;</span>
<span class="lineNum">    5119 </span>            : 
<span class="lineNum">    5120 </span><span class="lineNoCov">          0 :           Double_t covar[6]; vtx-&gt;GetCovMatrix(covar);</span>
<span class="lineNum">    5121 </span><span class="lineNoCov">          0 :           Double_t p[2]={tmp.GetParameter()[0]-ddz[0],tmp.GetParameter()[1]-ddz[1]};</span>
<span class="lineNum">    5122 </span><span class="lineNoCov">          0 :           Double_t c[3]={covar[2],0.,covar[5]};</span>
<span class="lineNum">    5123 </span><span class="lineNoCov">          0 :           Double_t chi2= ((AliESDtrack*)tmp.GetESDtrack())-&gt;GetPredictedChi2(p,c);</span>
<span class="lineNum">    5124 </span><span class="lineNoCov">          0 :           if (chi2&gt;AliITSReconstructor::GetRecoParam()-&gt;GetVertexChi2CutPlaneEff()) return kFALSE;  // Use this to cut on chi^2</span>
<span class="lineNum">    5125 </span>            : 
<span class="lineNum">    5126 </span><span class="lineNoCov">          0 :        } else return kFALSE;</span>
<span class="lineNum">    5127 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    5128 </span>            : 
<span class="lineNum">    5129 </span>            : 
<span class="lineNum">    5130 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<a name="5131"><span class="lineNum">    5131 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5132 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    5133 </span>            : void AliITStrackerMI::UseTrackForPlaneEff(const AliITStrackMI* track, Int_t ilayer) {
<span class="lineNum">    5134 </span>            : //
<span class="lineNum">    5135 </span>            : // This Method has to be optimized! For the time-being it uses the same criteria
<span class="lineNum">    5136 </span>            : // as those used in the search of extra clusters for overlapping modules.
<span class="lineNum">    5137 </span>            : //
<span class="lineNum">    5138 </span>            : // Method Purpose: estabilish whether a track has produced a recpoint or not
<span class="lineNum">    5139 </span>            : //                 in the layer under study (For Plane efficiency)
<span class="lineNum">    5140 </span>            : //
<span class="lineNum">    5141 </span>            : // inputs: AliITStrackMI* track  (pointer to a usable track)
<span class="lineNum">    5142 </span>            : // outputs: none
<span class="lineNum">    5143 </span>            : // side effects: update (by 1 count) the Plane Efficiency statistics of the basic block
<span class="lineNum">    5144 </span>            : //               traversed by this very track. In details:
<span class="lineNum">    5145 </span>            : //               - if a cluster can be associated to the track then call
<span class="lineNum">    5146 </span>            : //                  AliITSPlaneEff::UpDatePlaneEff(key,kTRUE);
<span class="lineNum">    5147 </span>            : //               - if not, the AliITSPlaneEff::UpDatePlaneEff(key,kFALSE) is called
<span class="lineNum">    5148 </span>            : //
<span class="lineNum">    5149 </span><span class="lineNoCov">          0 :   if(!fPlaneEff)</span>
<span class="lineNum">    5150 </span><span class="lineNoCov">          0 :     {AliWarning(&quot;UseTrackForPlaneEff: null pointer to AliITSPlaneEff&quot;); return;}</span>
<span class="lineNum">    5151 </span><span class="lineNoCov">          0 :   AliITSlayer &amp;layer=fgLayers[ilayer];</span>
<span class="lineNum">    5152 </span><span class="lineNoCov">          0 :   Double_t r=layer.GetR();</span>
<span class="lineNum">    5153 </span><span class="lineNoCov">          0 :   AliITStrackMI tmp(*track);</span>
<span class="lineNum">    5154 </span>            : 
<span class="lineNum">    5155 </span>            : // detector number
<span class="lineNum">    5156 </span><span class="lineNoCov">          0 :   Double_t phi,z;</span>
<span class="lineNum">    5157 </span><span class="lineNoCov">          0 :   if (!tmp.GetPhiZat(r,phi,z)) return;</span>
<span class="lineNum">    5158 </span><span class="lineNoCov">          0 :   Int_t idet=layer.FindDetectorIndex(phi,z);</span>
<span class="lineNum">    5159 </span>            : 
<span class="lineNum">    5160 </span><span class="lineNoCov">          0 :   if(idet&lt;0) { AliInfo(Form(&quot;cannot find detector&quot;));</span>
<span class="lineNum">    5161 </span><span class="lineNoCov">          0 :     return;}</span>
<span class="lineNum">    5162 </span>            : 
<span class="lineNum">    5163 </span>            : 
<span class="lineNum">    5164 </span>            : //propagate to the intersection with the detector plane
<span class="lineNum">    5165 </span><span class="lineNoCov">          0 :   const AliITSdetector &amp;det=layer.GetDetector(idet);</span>
<span class="lineNum">    5166 </span><span class="lineNoCov">          0 :   if (!tmp.Propagate(det.GetPhi(),det.GetR())) return;</span>
<span class="lineNum">    5167 </span>            : 
<span class="lineNum">    5168 </span>            : 
<span class="lineNum">    5169 </span>            : //***************
<span class="lineNum">    5170 </span>            : // DEFINITION OF SEARCH ROAD FOR CLUSTERS SELECTION
<span class="lineNum">    5171 </span>            : //
<span class="lineNum">    5172 </span><span class="lineNoCov">          0 :   Double_t dz=AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaRoadZ()*</span>
<span class="lineNum">    5173 </span><span class="lineNoCov">          0 :                     TMath::Sqrt(tmp.GetSigmaZ2() +</span>
<span class="lineNum">    5174 </span><span class="lineNoCov">          0 :                     AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    5175 </span><span class="lineNoCov">          0 :                     AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    5176 </span><span class="lineNoCov">          0 :                     AliITSReconstructor::GetRecoParam()-&gt;GetSigmaZ2(ilayer));</span>
<span class="lineNum">    5177 </span><span class="lineNoCov">          0 :   Double_t dy=AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaRoadY()*</span>
<span class="lineNum">    5178 </span><span class="lineNoCov">          0 :                     TMath::Sqrt(tmp.GetSigmaY2() +</span>
<span class="lineNum">    5179 </span><span class="lineNoCov">          0 :                     AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    5180 </span><span class="lineNoCov">          0 :                     AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    5181 </span><span class="lineNoCov">          0 :                     AliITSReconstructor::GetRecoParam()-&gt;GetSigmaY2(ilayer));</span>
<span class="lineNum">    5182 </span>            : 
<span class="lineNum">    5183 </span>            : // road in global (rphi,z) [i.e. in tracking ref. system]
<span class="lineNum">    5184 </span><span class="lineNoCov">          0 :   Double_t zmin = tmp.GetZ() - dz;</span>
<span class="lineNum">    5185 </span><span class="lineNoCov">          0 :   Double_t zmax = tmp.GetZ() + dz;</span>
<span class="lineNum">    5186 </span><span class="lineNoCov">          0 :   Double_t ymin = tmp.GetY() + r*det.GetPhi() - dy;</span>
<span class="lineNum">    5187 </span><span class="lineNoCov">          0 :   Double_t ymax = tmp.GetY() + r*det.GetPhi() + dy;</span>
<span class="lineNum">    5188 </span>            : 
<span class="lineNum">    5189 </span>            : // select clusters in road
<span class="lineNum">    5190 </span><span class="lineNoCov">          0 :   layer.SelectClusters(zmin,zmax,ymin,ymax);</span>
<span class="lineNum">    5191 </span>            : 
<span class="lineNum">    5192 </span>            : // Define criteria for track-cluster association
<span class="lineNum">    5193 </span><span class="lineNoCov">          0 :   Double_t msz = tmp.GetSigmaZ2() +</span>
<span class="lineNum">    5194 </span><span class="lineNoCov">          0 :   AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    5195 </span><span class="lineNoCov">          0 :   AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    5196 </span><span class="lineNoCov">          0 :   AliITSReconstructor::GetRecoParam()-&gt;GetSigmaZ2(ilayer);</span>
<span class="lineNum">    5197 </span><span class="lineNoCov">          0 :   Double_t msy = tmp.GetSigmaY2() +</span>
<span class="lineNum">    5198 </span><span class="lineNoCov">          0 :   AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    5199 </span><span class="lineNoCov">          0 :   AliITSReconstructor::GetRecoParam()-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    5200 </span><span class="lineNoCov">          0 :   AliITSReconstructor::GetRecoParam()-&gt;GetSigmaY2(ilayer);</span>
<span class="lineNum">    5201 </span><span class="lineNoCov">          0 :   if (tmp.GetConstrain()) {</span>
<span class="lineNum">    5202 </span><span class="lineNoCov">          0 :     msz *= AliITSReconstructor::GetRecoParam()-&gt;GetNSigma2RoadZC();</span>
<span class="lineNum">    5203 </span><span class="lineNoCov">          0 :     msy *= AliITSReconstructor::GetRecoParam()-&gt;GetNSigma2RoadYC();</span>
<span class="lineNum">    5204 </span><span class="lineNoCov">          0 :   }  else {</span>
<span class="lineNum">    5205 </span><span class="lineNoCov">          0 :     msz *= AliITSReconstructor::GetRecoParam()-&gt;GetNSigma2RoadZNonC();</span>
<span class="lineNum">    5206 </span><span class="lineNoCov">          0 :     msy *= AliITSReconstructor::GetRecoParam()-&gt;GetNSigma2RoadYNonC();</span>
<span class="lineNum">    5207 </span>            :   }
<span class="lineNum">    5208 </span>            : 
<span class="lineNum">    5209 </span><span class="lineNoCov">          0 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetSwitchOffStdSearchClusPlaneEff()){</span>
<span class="lineNum">    5210 </span><span class="lineNoCov">          0 :      Double_t nsigx=AliITSReconstructor::GetRecoParam()-&gt;GetNSigXSearchClusterPlaneEff();</span>
<span class="lineNum">    5211 </span><span class="lineNoCov">          0 :      Double_t nsigz=AliITSReconstructor::GetRecoParam()-&gt;GetNSigZSearchClusterPlaneEff();</span>
<span class="lineNum">    5212 </span><span class="lineNoCov">          0 :      Double_t distx=AliITSReconstructor::GetRecoParam()-&gt;GetDistXSearchClusterPlaneEff();</span>
<span class="lineNum">    5213 </span><span class="lineNoCov">          0 :      Double_t distz=AliITSReconstructor::GetRecoParam()-&gt;GetDistZSearchClusterPlaneEff();</span>
<span class="lineNum">    5214 </span><span class="lineNoCov">          0 :      msy = nsigx*TMath::Sqrt(tmp.GetSigmaY2()) + distx;</span>
<span class="lineNum">    5215 </span><span class="lineNoCov">          0 :      msz = nsigz*TMath::Sqrt(tmp.GetSigmaZ2()) + distz;</span>
<span class="lineNum">    5216 </span>            : 
<span class="lineNum">    5217 </span><span class="lineNoCov">          0 :   if(AliITSReconstructor::GetRecoParam()-&gt;GetSwitchOnMaxDistNSigSrhClusPlaneEff()){</span>
<span class="lineNum">    5218 </span><span class="lineNoCov">          0 :      if(nsigx*TMath::Sqrt(tmp.GetSigmaY2())&lt;=distx) msy -= nsigx*TMath::Sqrt(tmp.GetSigmaY2());</span>
<span class="lineNum">    5219 </span><span class="lineNoCov">          0 :      else msy -= distx;</span>
<span class="lineNum">    5220 </span>            : 
<span class="lineNum">    5221 </span><span class="lineNoCov">          0 :      if(nsigz*TMath::Sqrt(tmp.GetSigmaZ2())&lt;=distz) msz -= nsigz*TMath::Sqrt(tmp.GetSigmaZ2());</span>
<span class="lineNum">    5222 </span><span class="lineNoCov">          0 :      else msz -= distz;</span>
<span class="lineNum">    5223 </span>            :   }
<span class="lineNum">    5224 </span>            : 
<span class="lineNum">    5225 </span><span class="lineNoCov">          0 :   msy *= msy;</span>
<span class="lineNum">    5226 </span><span class="lineNoCov">          0 :   msz *= msz;</span>
<span class="lineNum">    5227 </span>            : 
<span class="lineNum">    5228 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5229 </span>            : 
<span class="lineNum">    5230 </span><span class="lineNoCov">          0 :   if(msz==0 || msy==0){AliWarning(&quot;UseTrackForPlaneEff: null search frame&quot;); return;}</span>
<span class="lineNum">    5231 </span>            :     
<span class="lineNum">    5232 </span><span class="lineNoCov">          0 :   msz = 1./msz; // 1/RoadZ^2</span>
<span class="lineNum">    5233 </span><span class="lineNoCov">          0 :   msy = 1./msy; // 1/RoadY^2</span>
<span class="lineNum">    5234 </span>            : 
<span class="lineNum">    5235 </span><span class="lineNoCov">          0 :   const AliITSRecPoint *cl=0; Int_t clidx=-1, ci=-1;</span>
<span class="lineNum">    5236 </span>            :   Int_t idetc=-1;
<span class="lineNum">    5237 </span><span class="lineNoCov">          0 :   Double_t chi2trkcl=1000.*AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2();</span>
<span class="lineNum">    5238 </span>            :   //Double_t  tolerance=0.2;
<span class="lineNum">    5239 </span>            :   /*while ((cl=layer.GetNextCluster(clidx))!=0) {
<span class="lineNum">    5240 </span>            :     idetc = cl-&gt;GetDetectorIndex();
<span class="lineNum">    5241 </span>            :     if(idet!=idetc) continue;
<span class="lineNum">    5242 </span>            :     //Int_t ilay = cl-&gt;GetLayer();
<span class="lineNum">    5243 </span>            : 
<span class="lineNum">    5244 </span>            :     if (TMath::Abs(tmp.GetZ() - cl-&gt;GetZ()) &gt; tolerance) continue;
<span class="lineNum">    5245 </span>            :     if (TMath::Abs(tmp.GetY() - cl-&gt;GetY()) &gt; tolerance) continue;
<span class="lineNum">    5246 </span>            : 
<span class="lineNum">    5247 </span>            :     Double_t chi2=tmp.GetPredictedChi2(cl);
<span class="lineNum">    5248 </span>            :     if (chi2&lt;chi2trkcl) { chi2trkcl=chi2; ci=clidx; }
<span class="lineNum">    5249 </span>            :   }*/
<span class="lineNum">    5250 </span><span class="lineNoCov">          0 :   Float_t locx; //</span>
<span class="lineNum">    5251 </span><span class="lineNoCov">          0 :   Float_t locz; //</span>
<span class="lineNum">    5252 </span><span class="lineNoCov">          0 :   if(!LocalModuleCoord(ilayer,idet,&amp;tmp,locx,locz)) return;</span>
<span class="lineNum">    5253 </span>            : //
<span class="lineNum">    5254 </span><span class="lineNoCov">          0 :   AliDebug(2,Form(&quot;ilayer= %d, idet=%d, x= %f, z=%f&quot;,ilayer,idet,locx,locz));</span>
<span class="lineNum">    5255 </span><span class="lineNoCov">          0 :   UInt_t key=fPlaneEff-&gt;GetKeyFromDetLocCoord(ilayer,idet,locx,locz);</span>
<span class="lineNum">    5256 </span><span class="lineNoCov">          0 :   if(key&gt;fPlaneEff-&gt;Nblock()) return;</span>
<span class="lineNum">    5257 </span>            :   Bool_t found=kFALSE;
<span class="lineNum">    5258 </span>            :   //if (ci&gt;=0) {
<span class="lineNum">    5259 </span>            :   Double_t chi2;
<span class="lineNum">    5260 </span><span class="lineNoCov">          0 :   while ((cl=layer.GetNextCluster(clidx))!=0) {</span>
<span class="lineNum">    5261 </span><span class="lineNoCov">          0 :     idetc = cl-&gt;GetDetectorIndex();</span>
<span class="lineNum">    5262 </span><span class="lineNoCov">          0 :     if(idet!=idetc) continue;</span>
<span class="lineNum">    5263 </span>            :     // here real control to see whether the cluster can be associated to the track.
<span class="lineNum">    5264 </span>            :     // cluster not associated to track
<span class="lineNum">    5265 </span><span class="lineNoCov">          0 :     if ( (tmp.GetZ()-cl-&gt;GetZ())*(tmp.GetZ()-cl-&gt;GetZ())*msz +</span>
<span class="lineNum">    5266 </span><span class="lineNoCov">          0 :          (tmp.GetY()-cl-&gt;GetY())*(tmp.GetY()-cl-&gt;GetY())*msy   &gt; 1. ) continue;</span>
<span class="lineNum">    5267 </span>            :     // calculate track-clusters chi2
<span class="lineNum">    5268 </span><span class="lineNoCov">          0 :     chi2 = GetPredictedChi2MI(&amp;tmp,cl,ilayer); // note that this method change track tmp</span>
<span class="lineNum">    5269 </span>            :                                                // in particular, the error associated to the cluster 
<span class="lineNum">    5270 </span>            :     //Double_t chi2 = tmp.GetPredictedChi(cl); // this method does not change track tmp
<span class="lineNum">    5271 </span>            :     // chi2 cut
<span class="lineNum">    5272 </span><span class="lineNoCov">          0 :     if (chi2 &gt; AliITSReconstructor::GetRecoParam()-&gt;GetMaxChi2s(ilayer)) continue;</span>
<span class="lineNum">    5273 </span>            :     found=kTRUE;
<span class="lineNum">    5274 </span><span class="lineNoCov">          0 :     if (chi2&lt;chi2trkcl) { chi2trkcl=chi2; ci=clidx; } // this just to trace which cluster is selected</span>
<span class="lineNum">    5275 </span>            :    // track-&gt;SetExtraCluster(ilayer,(ilayer&lt;&lt;28)+ci);
<span class="lineNum">    5276 </span>            :    // track-&gt;SetExtraModule(ilayer,idetExtra);
<span class="lineNum">    5277 </span>            :   }
<span class="lineNum">    5278 </span><span class="lineNoCov">          0 :   if(!fPlaneEff-&gt;UpDatePlaneEff(found,key))</span>
<span class="lineNum">    5279 </span><span class="lineNoCov">          0 :        AliWarning(Form(&quot;UseTrackForPlaneEff: cannot UpDate PlaneEff for key=%d&quot;,key));</span>
<span class="lineNum">    5280 </span>            : 
<span class="lineNum">    5281 </span>            : // this for FO efficiency studies (only for SPD) // 
<span class="lineNum">    5282 </span>            :    UInt_t keyFO=999999;
<span class="lineNum">    5283 </span>            :    Bool_t foundFO=kFALSE;
<span class="lineNum">    5284 </span><span class="lineNoCov">          0 :    if(ilayer&lt;2){ //ONLY SPD layers for FastOr studies</span>
<span class="lineNum">    5285 </span><span class="lineNoCov">          0 :     TBits mapFO = fkDetTypeRec-&gt;GetFastOrFiredMap();</span>
<span class="lineNum">    5286 </span><span class="lineNoCov">          0 :     Int_t phase = (fEsd-&gt;GetBunchCrossNumber())%4;</span>
<span class="lineNum">    5287 </span><span class="lineNoCov">          0 :     if(!fSPDChipIntPlaneEff[key]){</span>
<span class="lineNum">    5288 </span><span class="lineNoCov">          0 :       AliITSPlaneEffSPD spd; </span>
<span class="lineNum">    5289 </span><span class="lineNoCov">          0 :       keyFO = spd.SwitchChipKeyNumbering(key);</span>
<span class="lineNum">    5290 </span><span class="lineNoCov">          0 :       if(mapFO.TestBitNumber(keyFO))foundFO=kTRUE;</span>
<span class="lineNum">    5291 </span><span class="lineNoCov">          0 :        keyFO = key + (AliITSPlaneEffSPD::kNModule*AliITSPlaneEffSPD::kNChip)*(phase+1);</span>
<span class="lineNum">    5292 </span><span class="lineNoCov">          0 :        if(keyFO&lt;AliITSPlaneEffSPD::kNModule*AliITSPlaneEffSPD::kNChip) {</span>
<span class="lineNum">    5293 </span><span class="lineNoCov">          0 :          AliWarning(Form(&quot;UseTrackForPlaneEff: too small keyF0 (= %d), setting it to 999999&quot;,keyFO));</span>
<span class="lineNum">    5294 </span>            :          keyFO=999999;
<span class="lineNum">    5295 </span><span class="lineNoCov">          0 :        }</span>
<span class="lineNum">    5296 </span><span class="lineNoCov">          0 :        if(!fPlaneEff-&gt;UpDatePlaneEff(foundFO,keyFO))</span>
<span class="lineNum">    5297 </span><span class="lineNoCov">          0 :           AliWarning(Form(&quot;UseTrackForPlaneEff: cannot UpDate PlaneEff for FastOR for key=%d&quot;,keyFO));</span>
<span class="lineNum">    5298 </span><span class="lineNoCov">          0 :      }</span>
<span class="lineNum">    5299 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5300 </span>            :   
<span class="lineNum">    5301 </span>            : 
<span class="lineNum">    5302 </span>            : 
<span class="lineNum">    5303 </span><span class="lineNoCov">          0 :   if(fPlaneEff-&gt;GetCreateHistos()&amp;&amp;  AliITSReconstructor::GetRecoParam()-&gt;GetHistoPlaneEff()) {</span>
<span class="lineNum">    5304 </span><span class="lineNoCov">          0 :     Float_t tr[4]={99999.,99999.,9999.,9999.};    // initialize to high values </span>
<span class="lineNum">    5305 </span><span class="lineNoCov">          0 :     Float_t clu[4]={-99999.,-99999.,9999.,9999.}; // (in some cases GetCov fails) </span>
<span class="lineNum">    5306 </span><span class="lineNoCov">          0 :     Int_t cltype[2]={-999,-999};</span>
<span class="lineNum">    5307 </span>            :                                                           // and the module
<span class="lineNum">    5308 </span>            : 
<span class="lineNum">    5309 </span><span class="lineNoCov">          0 :     Float_t angleModTrack[3]={99999.,99999.,99999.}; // angles (phi, z and &quot;absolute angle&quot;) between the track and the mormal to the module (see below)</span>
<span class="lineNum">    5310 </span>            : 
<span class="lineNum">    5311 </span><span class="lineNoCov">          0 :     tr[0]=locx;</span>
<span class="lineNum">    5312 </span><span class="lineNoCov">          0 :     tr[1]=locz;</span>
<span class="lineNum">    5313 </span><span class="lineNoCov">          0 :     tr[2]=TMath::Sqrt(tmp.GetSigmaY2());  // those are precisions in the tracking reference system</span>
<span class="lineNum">    5314 </span><span class="lineNoCov">          0 :     tr[3]=TMath::Sqrt(tmp.GetSigmaZ2());  // Use it also for the module reference system, as it is</span>
<span class="lineNum">    5315 </span>            : 
<span class="lineNum">    5316 </span><span class="lineNoCov">          0 :     if (found){</span>
<span class="lineNum">    5317 </span><span class="lineNoCov">          0 :       clu[0]=layer.GetCluster(ci)-&gt;GetDetLocalX();</span>
<span class="lineNum">    5318 </span><span class="lineNoCov">          0 :       clu[1]=layer.GetCluster(ci)-&gt;GetDetLocalZ();</span>
<span class="lineNum">    5319 </span><span class="lineNoCov">          0 :       cltype[0]=layer.GetCluster(ci)-&gt;GetNy();</span>
<span class="lineNum">    5320 </span><span class="lineNoCov">          0 :       cltype[1]=layer.GetCluster(ci)-&gt;GetNz();</span>
<span class="lineNum">    5321 </span>            :      
<span class="lineNum">    5322 </span>            :      // Without the following 6 lines you would retrieve the nominal error of a cluster (e.g. for the SPD:
<span class="lineNum">    5323 </span>            :      //  X-&gt;50/sqrt(12)=14 micron   Z-&gt;450/sqrt(12)= 120 micron) 
<span class="lineNum">    5324 </span>            :      // Within AliTrackerMI/AliTrackMI the error on the cluster is associated to the AliITStrackMI (fSigmaY,Z)
<span class="lineNum">    5325 </span>            :      // It is computed properly by calling the method 
<span class="lineNum">    5326 </span>            :      // AliITStrackerMI::GetPredictedChi2MI(AliITStrackMI* track, const AliITSRecPoint *cluster,Int_t layer)
<span class="lineNum">    5327 </span>            :      // T
<span class="lineNum">    5328 </span>            :      //Double_t x=0.5*(tmp.GetX()+layer.GetCluster(ci)-&gt;GetX()); // Take into account the mis-alignment
<span class="lineNum">    5329 </span>            :       //if (tmp.PropagateTo(x,0.,0.)) {
<span class="lineNum">    5330 </span><span class="lineNoCov">          0 :         chi2=GetPredictedChi2MI(&amp;tmp,layer.GetCluster(ci),ilayer);</span>
<span class="lineNum">    5331 </span><span class="lineNoCov">          0 :         AliCluster c(*layer.GetCluster(ci));</span>
<span class="lineNum">    5332 </span><span class="lineNoCov">          0 :         c.SetSigmaY2(tmp.GetSigmaY(ilayer)*tmp.GetSigmaY(ilayer));</span>
<span class="lineNum">    5333 </span><span class="lineNoCov">          0 :         c.SetSigmaZ2(tmp.GetSigmaZ(ilayer)*tmp.GetSigmaZ(ilayer));</span>
<span class="lineNum">    5334 </span>            :         //if (layer.GetCluster(ci)-&gt;GetGlobalCov(cov))  // by using this, instead, you got nominal cluster errors
<span class="lineNum">    5335 </span><span class="lineNoCov">          0 :         clu[2]=TMath::Sqrt(c.GetSigmaY2());</span>
<span class="lineNum">    5336 </span><span class="lineNoCov">          0 :         clu[3]=TMath::Sqrt(c.GetSigmaZ2());</span>
<span class="lineNum">    5337 </span>            :       //}
<span class="lineNum">    5338 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    5339 </span>            :   // Compute the angles between the track and the module
<span class="lineNum">    5340 </span>            :       // compute the angle &quot;in phi direction&quot;, i.e. the angle in the transverse plane 
<span class="lineNum">    5341 </span>            :       // between the normal to the module and the projection (in the transverse plane) of the 
<span class="lineNum">    5342 </span>            :       // track trajectory
<span class="lineNum">    5343 </span>            :     // tgphi and tglambda of the track in tracking frame with alpha=det.GetPhi
<span class="lineNum">    5344 </span><span class="lineNoCov">          0 :     Float_t tgl = tmp.GetTgl();</span>
<span class="lineNum">    5345 </span><span class="lineNoCov">          0 :     Float_t phitr   = tmp.GetSnp();</span>
<span class="lineNum">    5346 </span><span class="lineNoCov">          0 :     phitr = TMath::ASin(phitr);</span>
<span class="lineNum">    5347 </span><span class="lineNoCov">          0 :     Int_t volId = AliGeomManager::LayerToVolUIDSafe(ilayer+1 ,idet );</span>
<span class="lineNum">    5348 </span>            : 
<span class="lineNum">    5349 </span><span class="lineNoCov">          0 :     Double_t tra[3]={0}; AliGeomManager::GetOrigTranslation(volId,tra);</span>
<span class="lineNum">    5350 </span><span class="lineNoCov">          0 :     Double_t rot[9]={0}; AliGeomManager::GetOrigRotation(volId,rot);</span>
<span class="lineNum">    5351 </span>            :    Double_t alpha =0.;
<span class="lineNum">    5352 </span><span class="lineNoCov">          0 :     alpha = tmp.GetAlpha();</span>
<span class="lineNum">    5353 </span><span class="lineNoCov">          0 :     Double_t phiglob = alpha+phitr;</span>
<span class="lineNum">    5354 </span>            :     Double_t p[3]={0};
<span class="lineNum">    5355 </span><span class="lineNoCov">          0 :     p[0] = TMath::Cos(phiglob);</span>
<span class="lineNum">    5356 </span><span class="lineNoCov">          0 :     p[1] = TMath::Sin(phiglob);</span>
<span class="lineNum">    5357 </span><span class="lineNoCov">          0 :     p[2] = tgl;</span>
<span class="lineNum">    5358 </span><span class="lineNoCov">          0 :     TVector3 pvec(p[0],p[1],p[2]);</span>
<span class="lineNum">    5359 </span><span class="lineNoCov">          0 :     TVector3 normvec(rot[1],rot[4],rot[7]);</span>
<span class="lineNum">    5360 </span><span class="lineNoCov">          0 :     Double_t angle = pvec.Angle(normvec);</span>
<span class="lineNum">    5361 </span>            : 
<span class="lineNum">    5362 </span><span class="lineNoCov">          0 :     if(angle&gt;0.5*TMath::Pi()) angle = (TMath::Pi()-angle);</span>
<span class="lineNum">    5363 </span><span class="lineNoCov">          0 :     angle *= 180./TMath::Pi();</span>
<span class="lineNum">    5364 </span>            : 
<span class="lineNum">    5365 </span>            :     //Trasverse Plane
<span class="lineNum">    5366 </span><span class="lineNoCov">          0 :     TVector3 pt(p[0],p[1],0);</span>
<span class="lineNum">    5367 </span><span class="lineNoCov">          0 :     TVector3 normt(rot[1],rot[4],0);</span>
<span class="lineNum">    5368 </span><span class="lineNoCov">          0 :     Double_t anglet = pt.Angle(normt);</span>
<span class="lineNum">    5369 </span>            : 
<span class="lineNum">    5370 </span><span class="lineNoCov">          0 :     Double_t phiPt = TMath::ATan2(p[1],p[0]);</span>
<span class="lineNum">    5371 </span><span class="lineNoCov">          0 :     if(phiPt&lt;0)phiPt+=2.*TMath::Pi();</span>
<span class="lineNum">    5372 </span><span class="lineNoCov">          0 :     Double_t phiNorm = TMath::ATan2(rot[4],rot[1]);</span>
<span class="lineNum">    5373 </span><span class="lineNoCov">          0 :     if(phiNorm&lt;0) phiNorm+=2.*TMath::Pi();</span>
<span class="lineNum">    5374 </span><span class="lineNoCov">          0 :     if(anglet&gt;0.5*TMath::Pi()) anglet = (TMath::Pi()-anglet);</span>
<span class="lineNum">    5375 </span><span class="lineNoCov">          0 :     if(phiNorm&gt;phiPt) anglet*=-1.;// pt--&gt;normt  clockwise: anglet&gt;0</span>
<span class="lineNum">    5376 </span><span class="lineNoCov">          0 :     if((phiNorm-phiPt)&gt;TMath::Pi()) anglet*=-1.;</span>
<span class="lineNum">    5377 </span><span class="lineNoCov">          0 :     anglet *= 180./TMath::Pi();</span>
<span class="lineNum">    5378 </span>            : 
<span class="lineNum">    5379 </span><span class="lineNoCov">          0 :      angleModTrack[2]=(Float_t) angle;</span>
<span class="lineNum">    5380 </span><span class="lineNoCov">          0 :      angleModTrack[0]=(Float_t) anglet;</span>
<span class="lineNum">    5381 </span>            :      // now the &quot;angle in z&quot; (much easier, i.e. the angle between the z axis and the track momentum + 90)
<span class="lineNum">    5382 </span><span class="lineNoCov">          0 :     angleModTrack[1]=TMath::ACos(tgl/TMath::Sqrt(tgl*tgl+1.));</span>
<span class="lineNum">    5383 </span><span class="lineNoCov">          0 :     angleModTrack[1]-=TMath::Pi()/2.; // range of angle is -pi/2 , pi/2</span>
<span class="lineNum">    5384 </span><span class="lineNoCov">          0 :     angleModTrack[1]*=180./TMath::Pi(); // in degree</span>
<span class="lineNum">    5385 </span>            : 
<span class="lineNum">    5386 </span><span class="lineNoCov">          0 :     fPlaneEff-&gt;FillHistos(key,found,tr,clu,cltype,angleModTrack);</span>
<span class="lineNum">    5387 </span>            : 
<span class="lineNum">    5388 </span>            :     // For FO efficiency studies of SPD 
<span class="lineNum">    5389 </span><span class="lineNoCov">          0 :     if(ilayer&lt;2 &amp;&amp; !fSPDChipIntPlaneEff[key]) fPlaneEff-&gt;FillHistos(keyFO,foundFO,tr,clu,cltype,angleModTrack);</span>
<span class="lineNum">    5390 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5391 </span><span class="lineNoCov">          0 :   if(ilayer&lt;2) fSPDChipIntPlaneEff[key]=kTRUE;</span>
<span class="lineNum">    5392 </span>            : return;
<a name="5393"><span class="lineNum">    5393 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    5394 </span>            : 
<span class="lineNum">    5395 </span>            : Int_t AliITStrackerMI::FindClusterOfTrack(int label, int lr, int* store) const //RS
<span class="lineNum">    5396 </span>            : {
<span class="lineNum">    5397 </span>            :   // find the MC cluster for the label
<span class="lineNum">    5398 </span><span class="lineNoCov">          0 :   return fgLayers[lr].FindClusterForLabel(label,store);</span>
<span class="lineNum">    5399 </span>            : }
<span class="lineNum">    5400 </span>            : 
<span class="lineNum">    5401 </span>            : /*
<span class="lineNum">    5402 </span>            : Int_t AliITStrackerMI::GetPattern(const AliITStrackMI* track, char* patt)
<span class="lineNum">    5403 </span>            : {
<span class="lineNum">    5404 </span>            :   // creates pattarn of hits marking fake/corrects by f/c. Used for debugging (RS) 
<span class="lineNum">    5405 </span>            :   strncpy(patt,&quot;......&quot;,6); 
<span class="lineNum">    5406 </span>            :   int tpcLabel = 0;
<span class="lineNum">    5407 </span>            :   if (track-&gt;GetESDtrack()) tpcLabel = track-&gt;GetESDtrack()-&gt;GetTPCLabel();
<span class="lineNum">    5408 </span>            :   //
<span class="lineNum">    5409 </span>            :   int nwrong = 0;
<span class="lineNum">    5410 </span>            :   for (Int_t i=0;i&lt;track-&gt;GetNumberOfClusters();i++){
<span class="lineNum">    5411 </span>            :     Int_t cindex = track-&gt;GetClusterIndex(i);
<span class="lineNum">    5412 </span>            :     Int_t l=(cindex &amp; 0xf0000000) &gt;&gt; 28;
<span class="lineNum">    5413 </span>            :     AliITSRecPoint *cl = (AliITSRecPoint*)GetCluster(cindex);
<span class="lineNum">    5414 </span>            :     Int_t isWrong=1;
<span class="lineNum">    5415 </span>            :     for (Int_t ind=0;ind&lt;3;ind++) if (cl-&gt;GetLabel(ind)==TMath::Abs(tpcLabel)) isWrong=0;
<span class="lineNum">    5416 </span>            :     patt[l] = isWrong ? 'f':'c';
<span class="lineNum">    5417 </span>            :     nwrong+=isWrong;
<span class="lineNum">    5418 </span>            :   }
<span class="lineNum">    5419 </span>            :   return nwrong;
<span class="lineNum">    5420 </span>            : }
<a name="5421"><span class="lineNum">    5421 </span>            : */</a>
<span class="lineNum">    5422 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    5423 </span>            : Int_t AliITStrackerMI::AliITSlayer::FindClusterForLabel(Int_t label, Int_t *store) const
<span class="lineNum">    5424 </span>            : { //RS
<span class="lineNum">    5425 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    5426 </span>            : 
<span class="lineNum">    5427 </span>            :   int nfound = 0;
<span class="lineNum">    5428 </span><span class="lineNoCov">          0 :   for (int ic=0;ic&lt;fN;ic++) {</span>
<span class="lineNum">    5429 </span><span class="lineNoCov">          0 :     const AliITSRecPoint *cl = GetCluster(ic);</span>
<span class="lineNum">    5430 </span><span class="lineNoCov">          0 :     for (int i=0;i&lt;3;i++) if (cl-&gt;GetLabel(i)==label) {</span>
<span class="lineNum">    5431 </span><span class="lineNoCov">          0 :         if (nfound&lt;50) {</span>
<span class="lineNum">    5432 </span><span class="lineNoCov">          0 :           if (store) store[nfound] = ic;</span>
<span class="lineNum">    5433 </span><span class="lineNoCov">          0 :           nfound++;</span>
<span class="lineNum">    5434 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5435 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    5436 </span>            :       }
<span class="lineNum">    5437 </span>            :   }
<span class="lineNum">    5438 </span><span class="lineNoCov">          0 :   return nfound;</span>
<span class="lineNum">    5439 </span>            : }
<span class="lineNum">    5440 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
