<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - ANALYSIS/ANALYSISaliceBase/AliAnalysisAlien.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">ANALYSIS/ANALYSISaliceBase</a> - AliAnalysisAlien.cxx<span style="font-size: 80%;"> (source / <a href="AliAnalysisAlien.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">3800</td>
            <td class="headerCovTableEntryLo">0.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">76</td>
            <td class="headerCovTableEntryLo">1.3 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-2007, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : // Author: Mihaela Gheata, 01/09/2008
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : //==============================================================================
<span class="lineNum">      19 </span>            : //   AliAnalysisAlien - AliEn utility class. Provides interface for creating
<span class="lineNum">      20 </span>            : // a personalized JDL, finding and creating a dataset.
<span class="lineNum">      21 </span>            : //==============================================================================
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span>            : #include &quot;AliAnalysisAlien.h&quot;
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : #include &quot;Riostream.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;TEnv.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;TKey.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;TBits.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;TError.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;TROOT.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;TSystem.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;TInterpreter.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;TFile.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;TFileCollection.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;TChain.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;TObjString.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;TObjArray.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;TMacro.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;TGrid.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;TGridResult.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;TGridCollection.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;TGridJDL.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;TGridJobStatusList.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;TGridJobStatus.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;TFileMerger.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;AliAnalysisManager.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;AliAnalysisTaskCfg.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;AliVEventHandler.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;AliAnalysisDataContainer.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;AliMultiInputEventHandler.h&quot;
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : using std::ofstream;
<span class="lineNum">      53 </span>            : using std::ifstream;
<a name="54"><span class="lineNum">      54 </span>            : using std::ios;</a>
<span class="lineNum">      55 </span>            : using std::endl;
<span class="lineNum">      56 </span><span class="lineCov">        170 : ClassImp(AliAnalysisAlien)</span>
<span class="lineNum">      57 </span>            : #if 0
<span class="lineNum">      58 </span>            : ;
<span class="lineNum">      59 </span>            : #endif  
<a name="60"><span class="lineNum">      60 </span>            : </a>
<span class="lineNum">      61 </span>            : namespace {
<span class="lineNum">      62 </span>            :   Bool_t copyLocal2Alien(const char* where, const char* loc, const char* rem)
<span class="lineNum">      63 </span>            :   {
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :     TString sl(Form(&quot;file:%s&quot;, loc));</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :     TString sr(Form(&quot;alien://%s&quot;, rem));</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :     Bool_t ret = TFile::Cp(sl, sr);</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :     if (!ret) { </span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :       Warning(where, &quot;Failed to copy %s to %s&quot;, sl.Data(), sr.Data());</span>
<span class="lineNum">      69 </span>            :     }
<span class="lineNum">      70 </span>            :     return ret;
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">      72 </span>            : }
<a name="73"><span class="lineNum">      73 </span>            :     </a>
<span class="lineNum">      74 </span>            : //______________________________________________________________________________
<span class="lineNum">      75 </span>            : AliAnalysisAlien::AliAnalysisAlien()
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :                  :AliAnalysisGrid(),</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :                   fGridJDL(NULL),</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :                   fMergingJDL(NULL),</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :                   fPrice(0),</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :                   fTTL(0),</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :                   fSplitMaxInputFileNumber(0),</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :                   fMaxInitFailed(0),</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :                   fMasterResubmitThreshold(0),</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :                   fNtestFiles(0),</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :                   fNrunsPerMaster(0),</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :                   fMaxMergeFiles(0),</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :                   fMaxMergeStages(0),</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :                   fNsubmitted(0),</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :                   fProductionMode(0),</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :                   fOutputToRunNo(0),</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :                   fMergeViaJDL(0),</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :                   fFastReadOption(0),</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :                   fOverwriteMode(1),</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :                   fNreplicas(2),</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :                   fNproofWorkers(0),</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :                   fNproofWorkersPerSlave(0),</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :                   fProofReset(0),</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :                   fNMCevents(0),</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :                   fNMCjobs(0),</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :                   fRunNumbers(),</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :                   fExecutable(),</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :                   fExecutableCommand(),</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :                   fArguments(),</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :                   fExecutableArgs(),</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :                   fAnalysisMacro(),</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :                   fAnalysisSource(),</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :                   fValidationScript(),</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :                   fAdditionalRootLibs(),</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :                   fAdditionalLibs(),</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :                   fGeneratorLibs(),</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :                   fSplitMode(),</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :                   fAPIVersion(),</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :                   fROOTVersion(),</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :                   fAliROOTVersion(),</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :                   fAliPhysicsVersion(),</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :                   fExternalPackages(),</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :                   fUser(),</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :                   fGridWorkingDir(),</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :                   fGridDataDir(),</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :                   fDataPattern(),</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :                   fGridOutputDir(),</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :                   fOutputArchive(),</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :                   fOutputFiles(),</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :                   fInputFormat(),</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :                   fDatasetName(),</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :                   fJDLName(),</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :                   fTerminateFiles(),</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :                             fMergeExcludes(),</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :                   fRegisterExcludes(),</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :                   fIncludePath(),</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :                   fCloseSE(),</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :                   fFriendChainName(),</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :                   fJobTag(),</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :                   fOutputSingle(),</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :                   fRunPrefix(),</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :                   fProofCluster(),</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :                   fProofDataSet(),</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :                   fFileForTestMode(),</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :                   fAliRootMode(),</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :                   fProofProcessOpt(),</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :                   fMergeDirName(),</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :                   fInputFiles(0),</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :                   fPackages(0),</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :                   fModules(0),</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :                   fProofParam(),</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :                   fDropToShell(true),</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :                   fMCLoop(false),</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :                   fGridJobIDs(&quot;&quot;),</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :                   fGridStages(&quot;&quot;),</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :                   fFriendLibs(&quot;&quot;),</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :                   fTreeName()</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     153 </span>            : // Dummy ctor.
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :    SetDefaults();</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 : }</span>
<a name="156"><span class="lineNum">     156 </span>            : </a>
<span class="lineNum">     157 </span>            : //______________________________________________________________________________
<span class="lineNum">     158 </span>            : AliAnalysisAlien::AliAnalysisAlien(const char *name)
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :                  :AliAnalysisGrid(name),</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :                   fGridJDL(NULL),</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :                   fMergingJDL(NULL),</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :                   fPrice(0),</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :                   fTTL(0),</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :                   fSplitMaxInputFileNumber(0),</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :                   fMaxInitFailed(0),</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :                   fMasterResubmitThreshold(0),</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :                   fNtestFiles(0),</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :                   fNrunsPerMaster(0),</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :                   fMaxMergeFiles(0),</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :                   fMaxMergeStages(0),</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :                   fNsubmitted(0),</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :                   fProductionMode(0),</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :                   fOutputToRunNo(0),</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :                   fMergeViaJDL(0),</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :                   fFastReadOption(0),</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :                   fOverwriteMode(1),</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :                   fNreplicas(2),</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :                   fNproofWorkers(0),</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :                   fNproofWorkersPerSlave(0),</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :                   fProofReset(0),</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :                   fNMCevents(0),</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :                   fNMCjobs(0),</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :                   fRunNumbers(),</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :                   fExecutable(),</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :                   fExecutableCommand(),</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :                   fArguments(),</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :                   fExecutableArgs(),</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :                   fAnalysisMacro(),</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :                   fAnalysisSource(),</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :                   fValidationScript(),</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :                   fAdditionalRootLibs(),</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :                   fAdditionalLibs(),</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :                   fGeneratorLibs(),</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :                   fSplitMode(),</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :                   fAPIVersion(),</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :                   fROOTVersion(),</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :                   fAliROOTVersion(),</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :                   fAliPhysicsVersion(),</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :                   fExternalPackages(),</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :                   fUser(),</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :                   fGridWorkingDir(),</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :                   fGridDataDir(),</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :                   fDataPattern(),</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :                   fGridOutputDir(),</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :                   fOutputArchive(),</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :                   fOutputFiles(),</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :                   fInputFormat(),</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :                   fDatasetName(),</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                   fJDLName(),</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :                   fTerminateFiles(),</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :                   fMergeExcludes(),</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                   fRegisterExcludes(),</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                   fIncludePath(),</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :                   fCloseSE(),</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :                   fFriendChainName(),</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :                   fJobTag(),</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :                   fOutputSingle(),</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :                   fRunPrefix(),</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :                   fProofCluster(),</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                   fProofDataSet(),</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :                   fFileForTestMode(),</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :                   fAliRootMode(),</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :                   fProofProcessOpt(),</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :                   fMergeDirName(),</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                   fInputFiles(0),</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                   fPackages(0),</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :                   fModules(0),</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :                   fProofParam(),</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :                   fDropToShell(true),</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :                   fMCLoop(false),</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :                   fGridJobIDs(&quot;&quot;),</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :                   fGridStages(&quot;&quot;),</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :                   fFriendLibs(&quot;&quot;),</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :                   fTreeName()</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     236 </span>            : // Default ctor.
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :    SetDefaults();</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 : }</span>
<a name="239"><span class="lineNum">     239 </span>            : </a>
<span class="lineNum">     240 </span>            : //______________________________________________________________________________
<span class="lineNum">     241 </span>            : AliAnalysisAlien::AliAnalysisAlien(const AliAnalysisAlien&amp; other)
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :                  :AliAnalysisGrid(other),</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :                   fGridJDL(NULL),</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :                   fMergingJDL(NULL),</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :                   fPrice(other.fPrice),</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :                   fTTL(other.fTTL),</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :                   fSplitMaxInputFileNumber(other.fSplitMaxInputFileNumber),</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :                   fMaxInitFailed(other.fMaxInitFailed),</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :                   fMasterResubmitThreshold(other.fMasterResubmitThreshold),</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :                   fNtestFiles(other.fNtestFiles),</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :                   fNrunsPerMaster(other.fNrunsPerMaster),</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :                   fMaxMergeFiles(other.fMaxMergeFiles),</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :                   fMaxMergeStages(other.fMaxMergeStages),</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :                   fNsubmitted(other.fNsubmitted),</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :                   fProductionMode(other.fProductionMode),</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :                   fOutputToRunNo(other.fOutputToRunNo),</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :                   fMergeViaJDL(other.fMergeViaJDL),</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :                   fFastReadOption(other.fFastReadOption),</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :                   fOverwriteMode(other.fOverwriteMode),</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :                   fNreplicas(other.fNreplicas),</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :                   fNproofWorkers(other.fNproofWorkers),</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :                   fNproofWorkersPerSlave(other.fNproofWorkersPerSlave),</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :                   fProofReset(other.fProofReset),</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :                   fNMCevents(other.fNMCevents),</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :                   fNMCjobs(other.fNMCjobs),</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :                   fRunNumbers(other.fRunNumbers),</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :                   fExecutable(other.fExecutable),</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :                   fExecutableCommand(other.fExecutableCommand),</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :                   fArguments(other.fArguments),</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :                   fExecutableArgs(other.fExecutableArgs),</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :                   fAnalysisMacro(other.fAnalysisMacro),</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :                   fAnalysisSource(other.fAnalysisSource),</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :                   fValidationScript(other.fValidationScript),</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :                   fAdditionalRootLibs(other.fAdditionalRootLibs),</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :                   fAdditionalLibs(other.fAdditionalLibs),</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :                   fGeneratorLibs(other.fGeneratorLibs),</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :                   fSplitMode(other.fSplitMode),</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :                   fAPIVersion(other.fAPIVersion),</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :                   fROOTVersion(other.fROOTVersion),</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :                   fAliROOTVersion(other.fAliROOTVersion),</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :                   fAliPhysicsVersion(other.fAliPhysicsVersion),</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :                   fExternalPackages(other.fExternalPackages),</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :                   fUser(other.fUser),</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :                   fGridWorkingDir(other.fGridWorkingDir),</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :                   fGridDataDir(other.fGridDataDir),</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :                   fDataPattern(other.fDataPattern),</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :                   fGridOutputDir(other.fGridOutputDir),</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :                   fOutputArchive(other.fOutputArchive),</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :                   fOutputFiles(other.fOutputFiles),</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :                   fInputFormat(other.fInputFormat),</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :                   fDatasetName(other.fDatasetName),</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :                   fJDLName(other.fJDLName),</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :                   fTerminateFiles(other.fTerminateFiles),</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :                   fMergeExcludes(other.fMergeExcludes),</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :                   fRegisterExcludes(other.fRegisterExcludes),</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :                   fIncludePath(other.fIncludePath),</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :                   fCloseSE(other.fCloseSE),</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :                   fFriendChainName(other.fFriendChainName),</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :                   fJobTag(other.fJobTag),</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :                   fOutputSingle(other.fOutputSingle),</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :                   fRunPrefix(other.fRunPrefix),</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :                   fProofCluster(other.fProofCluster),</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :                   fProofDataSet(other.fProofDataSet),</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :                   fFileForTestMode(other.fFileForTestMode),</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :                   fAliRootMode(other.fAliRootMode),</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :                   fProofProcessOpt(other.fProofProcessOpt),</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :                   fMergeDirName(other.fMergeDirName),</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :                   fInputFiles(0),</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :                   fPackages(0),</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :                   fModules(0),</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :                   fProofParam(),</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :                   fDropToShell(other.fDropToShell),</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :                   fMCLoop(other.fMCLoop),</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :                   fGridJobIDs(other.fGridJobIDs),</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :                   fGridStages(other.fGridStages),</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :                   fFriendLibs(other.fFriendLibs),</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :                   fTreeName(other.fTreeName)</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     319 </span>            : // Copy ctor.
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :    fGridJDL = (TGridJDL*)gROOT-&gt;ProcessLine(&quot;new TAlienJDL()&quot;);</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :    fMergingJDL = (TGridJDL*)gROOT-&gt;ProcessLine(&quot;new TAlienJDL()&quot;);</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :    fRunRange[0] = other.fRunRange[0];</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :    fRunRange[1] = other.fRunRange[1];</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :    if (other.fInputFiles) {</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :       fInputFiles = new TObjArray();</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :       TIter next(other.fInputFiles);</span>
<span class="lineNum">     327 </span>            :       TObject *obj;
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :       while ((obj=next())) fInputFiles-&gt;Add(new TObjString(obj-&gt;GetName()));</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       fInputFiles-&gt;SetOwner();</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :    if (other.fPackages) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :       fPackages = new TObjArray();</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :       TIter next(other.fPackages);</span>
<span class="lineNum">     334 </span>            :       TObject *obj;
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       while ((obj=next())) fPackages-&gt;Add(new TObjString(obj-&gt;GetName()));</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :       fPackages-&gt;SetOwner();</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :    if (other.fModules) {</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :       fModules = new TObjArray();</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :       fModules-&gt;SetOwner();</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       TIter next(other.fModules);</span>
<span class="lineNum">     342 </span>            :       AliAnalysisTaskCfg *mod, *crt;
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :       while ((crt=(AliAnalysisTaskCfg*)next())) {</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :          mod = new AliAnalysisTaskCfg(*crt);</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :          fModules-&gt;Add(mod);</span>
<span class="lineNum">     346 </span>            :       }
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 : }</span>
<a name="349"><span class="lineNum">     349 </span>            : </a>
<span class="lineNum">     350 </span>            : //______________________________________________________________________________
<span class="lineNum">     351 </span>            : AliAnalysisAlien::~AliAnalysisAlien()
<span class="lineNum">     352 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     353 </span>            : // Destructor.
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :    delete fGridJDL;</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :    delete fMergingJDL;</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :    delete fInputFiles;</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :    delete fPackages;</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :    delete fModules;</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :    fProofParam.DeleteAll();</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 : }   </span>
<a name="361"><span class="lineNum">     361 </span>            : </a>
<span class="lineNum">     362 </span>            : //______________________________________________________________________________
<span class="lineNum">     363 </span>            : AliAnalysisAlien &amp;AliAnalysisAlien::operator=(const AliAnalysisAlien&amp; other)
<span class="lineNum">     364 </span>            : {
<span class="lineNum">     365 </span>            : // Assignment.
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :    if (this != &amp;other) {</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :       AliAnalysisGrid::operator=(other);</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :       fGridJDL = (TGridJDL*)gROOT-&gt;ProcessLine(&quot;new TAlienJDL()&quot;);</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :       fMergingJDL = (TGridJDL*)gROOT-&gt;ProcessLine(&quot;new TAlienJDL()&quot;);</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :       fPrice                   = other.fPrice;</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :       fTTL                     = other.fTTL;</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :       fSplitMaxInputFileNumber = other.fSplitMaxInputFileNumber;</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :       fMaxInitFailed           = other.fMaxInitFailed;</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :       fMasterResubmitThreshold = other.fMasterResubmitThreshold;</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :       fNtestFiles              = other.fNtestFiles;</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :       fNrunsPerMaster          = other.fNrunsPerMaster;</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :       fMaxMergeFiles           = other.fMaxMergeFiles;</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :       fMaxMergeStages          = other.fMaxMergeStages;</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :       fNsubmitted              = other.fNsubmitted;</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :       fProductionMode          = other.fProductionMode;</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :       fOutputToRunNo           = other.fOutputToRunNo;</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :       fMergeViaJDL             = other.fMergeViaJDL;</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :       fFastReadOption          = other.fFastReadOption;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :       fOverwriteMode           = other.fOverwriteMode;</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :       fNreplicas               = other.fNreplicas;</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :       fNproofWorkers           = other.fNproofWorkers;</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :       fNproofWorkersPerSlave   = other.fNproofWorkersPerSlave;</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :       fProofReset              = other.fProofReset;</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :       fNMCevents               = other.fNMCevents;</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :       fNMCjobs                 = other.fNMCjobs;</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :       fRunNumbers              = other.fRunNumbers;</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :       fExecutable              = other.fExecutable;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :       fExecutableCommand       = other.fExecutableCommand;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :       fArguments               = other.fArguments;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :       fExecutableArgs          = other.fExecutableArgs;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :       fAnalysisMacro           = other.fAnalysisMacro;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :       fAnalysisSource          = other.fAnalysisSource;</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :       fValidationScript        = other.fValidationScript;</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :       fAdditionalRootLibs      = other.fAdditionalRootLibs;</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :       fAdditionalLibs          = other.fAdditionalLibs;</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :       fGeneratorLibs           = other.fGeneratorLibs;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :       fSplitMode               = other.fSplitMode;</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :       fAPIVersion              = other.fAPIVersion;</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :       fROOTVersion             = other.fROOTVersion;</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :       fAliROOTVersion          = other.fAliROOTVersion;</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :       fAliPhysicsVersion       = other.fAliPhysicsVersion;</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :       fExternalPackages        = other.fExternalPackages;</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :       fUser                    = other.fUser;</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :       fGridWorkingDir          = other.fGridWorkingDir;</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :       fGridDataDir             = other.fGridDataDir;</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :       fDataPattern             = other.fDataPattern;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :       fGridOutputDir           = other.fGridOutputDir;</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :       fOutputArchive           = other.fOutputArchive;</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :       fOutputFiles             = other.fOutputFiles;</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :       fInputFormat             = other.fInputFormat;</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :       fDatasetName             = other.fDatasetName;</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :       fJDLName                 = other.fJDLName;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :       fTerminateFiles          = other.fTerminateFiles;</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :       fMergeExcludes           = other.fMergeExcludes;</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :       fRegisterExcludes        = other.fRegisterExcludes;</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :       fIncludePath             = other.fIncludePath;</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :       fCloseSE                 = other.fCloseSE;</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :       fFriendChainName         = other.fFriendChainName;</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :       fJobTag                  = other.fJobTag;</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :       fOutputSingle            = other.fOutputSingle;</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :       fRunPrefix               = other.fRunPrefix;</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :       fProofCluster            = other.fProofCluster;</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :       fProofDataSet            = other.fProofDataSet;</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :       fFileForTestMode         = other.fFileForTestMode;</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :       fAliRootMode             = other.fAliRootMode;</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :       fProofProcessOpt         = other.fProofProcessOpt;</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :       fMergeDirName            = other.fMergeDirName;</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :       fDropToShell             = other.fDropToShell;</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :       fMCLoop                  = other.fMCLoop;</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :       fGridJobIDs              = other.fGridJobIDs;</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :       fGridStages              = other.fGridStages;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :       fFriendLibs              = other.fFriendLibs;</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :       fTreeName                = other.fTreeName;</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :       if (other.fInputFiles) {</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :          fInputFiles = new TObjArray();</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :          TIter next(other.fInputFiles);</span>
<span class="lineNum">     442 </span>            :          TObject *obj;
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :          while ((obj=next())) fInputFiles-&gt;Add(new TObjString(obj-&gt;GetName()));</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :          fInputFiles-&gt;SetOwner();</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :       if (other.fPackages) {</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :          fPackages = new TObjArray();</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :          TIter next(other.fPackages);</span>
<span class="lineNum">     449 </span>            :          TObject *obj;
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :          while ((obj=next())) fPackages-&gt;Add(new TObjString(obj-&gt;GetName()));</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :          fPackages-&gt;SetOwner();</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :       if (other.fModules) {</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :          fModules = new TObjArray();</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :          fModules-&gt;SetOwner();</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :          TIter next(other.fModules);</span>
<span class="lineNum">     457 </span>            :          AliAnalysisTaskCfg *mod, *crt;
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :          while ((crt=(AliAnalysisTaskCfg*)next())) {</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :             mod = new AliAnalysisTaskCfg(*crt);</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :             fModules-&gt;Add(mod);</span>
<span class="lineNum">     461 </span>            :          }
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">     463 </span>            :    }
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :    return *this;</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 : }</span>
<a name="466"><span class="lineNum">     466 </span>            : </a>
<span class="lineNum">     467 </span>            : //______________________________________________________________________________
<span class="lineNum">     468 </span>            : void AliAnalysisAlien::AddAdditionalLibrary(const char *name)
<span class="lineNum">     469 </span>            : {
<span class="lineNum">     470 </span>            : // Add a single additional library to be loaded. Extension must be present.
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :    TString lib(name);</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :    if (!lib.Contains(&quot;.&quot;)) {</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :       Error(&quot;AddAdditionalLibrary&quot;, &quot;Extension not defined for %s&quot;, name);</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     475 </span>            :    }
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :    if (fAdditionalLibs.Contains(name)) {</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :       Warning(&quot;AddAdditionalLibrary&quot;, &quot;Library %s already added.&quot;, name);</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     479 </span>            :    }
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :    if (!fAdditionalLibs.IsNull()) fAdditionalLibs += &quot; &quot;;</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :    fAdditionalLibs += lib;</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 : }   </span>
<a name="483"><span class="lineNum">     483 </span>            : </a>
<span class="lineNum">     484 </span>            : //______________________________________________________________________________
<span class="lineNum">     485 </span>            : void AliAnalysisAlien::AddModule(AliAnalysisTaskCfg *module)
<span class="lineNum">     486 </span>            : {
<span class="lineNum">     487 </span>            : // Adding a module. Checks if already existing. Becomes owned by this.
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :    if (!module) return;</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :    if (GetModule(module-&gt;GetName())) {</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :       Error(&quot;AddModule&quot;, &quot;A module having the same name %s already added&quot;, module-&gt;GetName());</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     492 </span>            :    }
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :    if (!fModules) {</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :       fModules = new TObjArray();</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :       fModules-&gt;SetOwner();</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :    fModules-&gt;Add(module);</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 : }</span>
<a name="499"><span class="lineNum">     499 </span>            : </a>
<span class="lineNum">     500 </span>            : //______________________________________________________________________________
<span class="lineNum">     501 </span>            : void AliAnalysisAlien::AddModules(TObjArray *list)
<span class="lineNum">     502 </span>            : {
<span class="lineNum">     503 </span>            : // Adding a list of modules. Checks if already existing. Becomes owned by this.
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :    TIter next(list);</span>
<span class="lineNum">     505 </span>            :    AliAnalysisTaskCfg *module;
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :    while ((module = (AliAnalysisTaskCfg*)next())) AddModule(module);</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 : }   </span>
<a name="508"><span class="lineNum">     508 </span>            : </a>
<span class="lineNum">     509 </span>            : //______________________________________________________________________________
<span class="lineNum">     510 </span>            : Bool_t AliAnalysisAlien::CheckDependencies()
<span class="lineNum">     511 </span>            : {
<span class="lineNum">     512 </span>            : // Check if all dependencies are satisfied. Reorder modules if needed.
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :    Int_t nmodules = GetNmodules();</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :    if (!nmodules) {</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :       Warning(&quot;CheckDependencies&quot;, &quot;No modules added yet to check their dependencies&quot;);</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :       return kTRUE;</span>
<span class="lineNum">     517 </span>            :    }   
<span class="lineNum">     518 </span>            :    AliAnalysisTaskCfg *mod = 0;
<span class="lineNum">     519 </span>            :    AliAnalysisTaskCfg *dep = 0;
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :    TString depname;</span>
<span class="lineNum">     521 </span>            :    Int_t i, j, k;
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :    for (i=0; i&lt;nmodules; i++) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :       mod = (AliAnalysisTaskCfg*) fModules-&gt;At(i);</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :       Int_t ndeps = mod-&gt;GetNdeps();</span>
<span class="lineNum">     525 </span>            :       Int_t istart = i;
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :       for (j=0; j&lt;ndeps; j++) {</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :          depname = mod-&gt;GetDependency(j);</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :          dep = GetModule(depname);</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :          if (!dep) {</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :             Error(&quot;CheckDependencies&quot;,&quot;Dependency %s not added for module %s&quot;,</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :                    depname.Data(), mod-&gt;GetName());</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">     533 </span>            :          }
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :          if (dep-&gt;NeedsDependency(mod-&gt;GetName())) {</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :             Error(&quot;CheckDependencies&quot;,&quot;Modules %s and %s circularly depend on each other&quot;,</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :                    mod-&gt;GetName(), dep-&gt;GetName());</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">     538 </span>            :          }                  
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :          Int_t idep = fModules-&gt;IndexOf(dep);</span>
<span class="lineNum">     540 </span>            :          // The dependency task must come first
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :          if (idep&gt;i) {</span>
<span class="lineNum">     542 </span>            :             // Remove at idep and move all objects below up one slot
<span class="lineNum">     543 </span>            :             // down to index i included.
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :             fModules-&gt;RemoveAt(idep);</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :             for (k=idep-1; k&gt;=i; k--) fModules-&gt;AddAt(fModules-&gt;RemoveAt(k),k+1);</span>
<span class="lineNum">     546 </span>            :             istart = i;
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :             fModules-&gt;AddAt(dep, i++);</span>
<span class="lineNum">     548 </span>            :          }
<span class="lineNum">     549 </span>            :       }
<span class="lineNum">     550 </span>            :       //Redo from istart if dependencies were inserted
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :       if (i&gt;istart) i=istart-1;</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 : }      </span>
<a name="555"><span class="lineNum">     555 </span>            : </a>
<span class="lineNum">     556 </span>            : //______________________________________________________________________________
<span class="lineNum">     557 </span>            : AliAnalysisManager *AliAnalysisAlien::CreateAnalysisManager(const char *name, const char *filename)
<span class="lineNum">     558 </span>            : {
<span class="lineNum">     559 </span>            : // Create the analysis manager and optionally execute the macro in filename.
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :    if (mgr) {</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :       mgr-&gt;SetMCLoop(fMCLoop);</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :       return mgr;</span>
<span class="lineNum">     564 </span>            :    }   
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :    mgr = new AliAnalysisManager(name);</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :    mgr-&gt;SetGridHandler((AliAnalysisGrid*)this);</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :    mgr-&gt;SetMCLoop(fMCLoop);</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :    if (strlen(filename)) {</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :       TString line = gSystem-&gt;ExpandPathName(filename);</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :       line.Prepend(&quot;.x &quot;);</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :       gROOT-&gt;ProcessLine(line.Data());</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :    return mgr;</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 : }      </span>
<a name="575"><span class="lineNum">     575 </span>            :       </a>
<span class="lineNum">     576 </span>            : //______________________________________________________________________________
<span class="lineNum">     577 </span>            : Int_t AliAnalysisAlien::GetNmodules() const
<span class="lineNum">     578 </span>            : {
<span class="lineNum">     579 </span>            : // Get number of modules.
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :    if (!fModules) return 0;</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :    return fModules-&gt;GetEntries();</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 : }</span>
<a name="583"><span class="lineNum">     583 </span>            : </a>
<span class="lineNum">     584 </span>            : //______________________________________________________________________________
<span class="lineNum">     585 </span>            : AliAnalysisTaskCfg *AliAnalysisAlien::GetModule(const char *name)
<span class="lineNum">     586 </span>            : {
<span class="lineNum">     587 </span>            : // Get a module by name.
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :    if (!fModules) return 0;</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :    return (AliAnalysisTaskCfg*)fModules-&gt;FindObject(name);</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 : }</span>
<a name="591"><span class="lineNum">     591 </span>            :    </a>
<span class="lineNum">     592 </span>            : //______________________________________________________________________________
<span class="lineNum">     593 </span>            : Bool_t AliAnalysisAlien::LoadModule(AliAnalysisTaskCfg *mod)
<span class="lineNum">     594 </span>            : {
<span class="lineNum">     595 </span>            : // Load a given module.
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :    if (mod-&gt;IsLoaded()) return kTRUE;</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :    if (!mgr) {</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :       Error(&quot;LoadModule&quot;, &quot;No analysis manager created yet. Use CreateAnalysisManager first.&quot;);</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     601 </span>            :    }   
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :    Int_t ndeps = mod-&gt;GetNdeps();</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :    TString depname;</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :    for (Int_t j=0; j&lt;ndeps; j++) {</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :       depname = mod-&gt;GetDependency(j);</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :       AliAnalysisTaskCfg *dep = GetModule(depname);</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :       if (!dep) {</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :          Error(&quot;LoadModule&quot;,&quot;Dependency %s not existing for module %s&quot;,</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :                 depname.Data(), mod-&gt;GetName());</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">     611 </span>            :       }
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :       if (!LoadModule(dep)) {</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :          Error(&quot;LoadModule&quot;,&quot;Dependency %s for module %s could not be loaded&quot;,</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :                 depname.Data(), mod-&gt;GetName());</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">     616 </span>            :       }
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     618 </span>            :    // Load libraries for the module
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :    if (!mod-&gt;CheckLoadLibraries()) {</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :       Error(&quot;LoadModule&quot;, &quot;Cannot load all libraries for module %s&quot;, mod-&gt;GetName());</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     622 </span>            :    }
<span class="lineNum">     623 </span>            :    // Check if a custom file name was requested
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :    if (strlen(mod-&gt;GetOutputFileName())) mgr-&gt;SetCommonFileName(mod-&gt;GetOutputFileName());</span>
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span>            :    // Check if a custom terminate file name was requested
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :    if (strlen(mod-&gt;GetTerminateFileName())) {</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :       if (!fTerminateFiles.IsNull()) fTerminateFiles += &quot;,&quot;;</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :       fTerminateFiles += mod-&gt;GetTerminateFileName();</span>
<span class="lineNum">     630 </span>            :    }   
<span class="lineNum">     631 </span>            : 
<span class="lineNum">     632 </span>            :    // Execute the macro
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :    if (mod-&gt;ExecuteMacro()&lt;0) {</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :       Error(&quot;LoadModule&quot;, &quot;Executing the macro %s with arguments: %s for module %s returned a negative value&quot;,</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :              mod-&gt;GetMacroName(), mod-&gt;GetMacroArgs(), mod-&gt;GetName());</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     637 </span>            :    }
<span class="lineNum">     638 </span>            :    // Configure dependencies
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :    if (mod-&gt;GetConfigMacro() &amp;&amp; mod-&gt;ExecuteConfigMacro()&lt;0) {</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :       Error(&quot;LoadModule&quot;, &quot;There was an error executing the deps config macro %s for module %s&quot;,</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :             mod-&gt;GetConfigMacro()-&gt;GetTitle(), mod-&gt;GetName());</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     643 </span>            :    }
<span class="lineNum">     644 </span>            :    // Adjust extra libraries
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :    Int_t nlibs = mod-&gt;GetNlibs();</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :    TString lib;</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :    for (Int_t i=0; i&lt;nlibs; i++) {</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :       lib = mod-&gt;GetLibrary(i);</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :       lib = Form(&quot;lib%s.so&quot;, lib.Data());</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :       if (fAdditionalLibs.Contains(lib)) continue;</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :       if (!fAdditionalLibs.IsNull()) fAdditionalLibs += &quot; &quot;;</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :       fAdditionalLibs += lib;</span>
<span class="lineNum">     653 </span>            :    }
<span class="lineNum">     654 </span>            :    return kTRUE;
<span class="lineNum">     655 </span><span class="lineNoCov">          0 : }</span>
<a name="656"><span class="lineNum">     656 </span>            : </a>
<span class="lineNum">     657 </span>            : //______________________________________________________________________________
<span class="lineNum">     658 </span>            : Bool_t AliAnalysisAlien::GenerateTrain(const char *name)
<span class="lineNum">     659 </span>            : {
<span class="lineNum">     660 </span>            : // Generate the full train.
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :    fAdditionalLibs = &quot;&quot;;</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :    if (!LoadModules()) return kFALSE;</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :    if (!mgr-&gt;InitAnalysis()) return kFALSE;</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :    mgr-&gt;RunLocalInit();</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :    mgr-&gt;PrintStatus();</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :    Int_t productionMode = fProductionMode;</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :    SetProductionMode();</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :    TString macro = fAnalysisMacro;</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :    TString executable = fExecutable;</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :    TString validation = fValidationScript;</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :    TString execCommand = fExecutableCommand;</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :    SetAnalysisMacro(Form(&quot;%s.C&quot;, name));</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :    SetExecutable(Form(&quot;%s.sh&quot;, name));</span>
<span class="lineNum">     675 </span>            : //   SetExecutableCommand(&quot;aliroot -b -q &quot;);
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :    SetValidationScript(Form(&quot;%s_validation.sh&quot;, name));</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :    StartAnalysis();</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :    SetProductionMode(productionMode);</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :    fAnalysisMacro = macro;</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :    fExecutable = executable;</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :    fExecutableCommand = execCommand;</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :    fValidationScript = validation;</span>
<span class="lineNum">     683 </span>            :    return kTRUE;   
<span class="lineNum">     684 </span><span class="lineNoCov">          0 : }   </span>
<a name="685"><span class="lineNum">     685 </span>            : </a>
<span class="lineNum">     686 </span>            : //______________________________________________________________________________
<span class="lineNum">     687 </span>            : Bool_t AliAnalysisAlien::GenerateTest(const char *name, const char *modname)
<span class="lineNum">     688 </span>            : {
<span class="lineNum">     689 </span>            : // Generate test macros for a single module or for the full train.
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :    fAdditionalLibs = &quot;&quot;;</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :    if (strlen(modname)) {</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :       if (!CheckDependencies()) return kFALSE;</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :       AliAnalysisTaskCfg *mod = GetModule(modname);</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :       if (!mod) {</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :          Error(&quot;GenerateTest&quot;, &quot;cannot generate test for inexistent module %s&quot;, modname);</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">     697 </span>            :       }
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :       if (!LoadModule(mod)) return kFALSE;</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :       if (!LoadFriendLibs()) return kFALSE;</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :    } else if (!LoadModules()) return kFALSE;</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :    if (!mgr-&gt;InitAnalysis()) return kFALSE;</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :    mgr-&gt;RunLocalInit();</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :    mgr-&gt;PrintStatus();</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :    SetLocalTest(kTRUE);</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :    Int_t productionMode = fProductionMode;</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :    SetProductionMode();</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :    TString macro = fAnalysisMacro;</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :    TString executable = fExecutable;</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :    TString validation = fValidationScript;</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :    TString execCommand = fExecutableCommand;</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :    SetAnalysisMacro(Form(&quot;%s.C&quot;, name));</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :    SetExecutable(Form(&quot;%s.sh&quot;, name));</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :       fOutputFiles = GetListOfFiles(&quot;outaod&quot;);</span>
<span class="lineNum">     715 </span>            :       // Add extra files registered to the analysis manager
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :       TString extra = GetListOfFiles(&quot;ext&quot;);</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :       if (!extra.IsNull()) {</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :          extra.ReplaceAll(&quot;.root&quot;, &quot;*.root&quot;);</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :          if (!fOutputFiles.IsNull()) fOutputFiles += &quot;,&quot;;</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :          fOutputFiles += extra;</span>
<span class="lineNum">     721 </span>            :       }
<span class="lineNum">     722 </span>            : //   SetExecutableCommand(&quot;aliroot -b -q &quot;);
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :    SetValidationScript(Form(&quot;%s_validation.sh&quot;, name));</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :    WriteAnalysisFile();   </span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :    WriteAnalysisMacro();</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :    WriteExecutable();</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :    WriteValidationScript();   </span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :    WriteMergingMacro();</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :    WriteMergeExecutable();</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :    WriteValidationScript(kTRUE);</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :    SetLocalTest(kFALSE);</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :    SetProductionMode(productionMode);</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :    fAnalysisMacro = macro;</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :    fExecutable = executable;</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :    fExecutableCommand = execCommand;</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :    fValidationScript = validation;</span>
<span class="lineNum">     737 </span>            :    return kTRUE;   
<span class="lineNum">     738 </span><span class="lineNoCov">          0 : }</span>
<a name="739"><span class="lineNum">     739 </span>            : </a>
<span class="lineNum">     740 </span>            : //______________________________________________________________________________
<span class="lineNum">     741 </span>            : Bool_t AliAnalysisAlien::LoadModules()
<span class="lineNum">     742 </span>            : {
<span class="lineNum">     743 </span>            : // Load all modules by executing the AddTask macros. Checks first the dependencies.
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :    fAdditionalLibs = &quot;&quot;;</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :    Int_t nmodules = GetNmodules();</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :    if (!nmodules) {</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :       Warning(&quot;LoadModules&quot;, &quot;No module to be loaded&quot;);</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :       return kTRUE;</span>
<span class="lineNum">     749 </span>            :    }   
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :    if (!mgr) {</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :       Error(&quot;LoadModules&quot;, &quot;No analysis manager created yet. Use CreateAnalysisManager first.&quot;);</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     754 </span>            :    }   
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :    if (!CheckDependencies()) return kFALSE;</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :    nmodules = GetNmodules();</span>
<span class="lineNum">     757 </span>            :    AliAnalysisTaskCfg *mod;
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :    for (Int_t imod=0; imod&lt;nmodules; imod++) {</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :       mod = (AliAnalysisTaskCfg*)fModules-&gt;At(imod);</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :       if (!LoadModule(mod)) return kFALSE;</span>
<span class="lineNum">     761 </span>            :    }
<span class="lineNum">     762 </span>            :    // Load additional friend libraries
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :    return LoadFriendLibs();</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 : }      </span>
<a name="765"><span class="lineNum">     765 </span>            : </a>
<span class="lineNum">     766 </span>            : //______________________________________________________________________________
<span class="lineNum">     767 </span>            : Bool_t AliAnalysisAlien::LoadFriendLibs() const
<span class="lineNum">     768 </span>            : {
<span class="lineNum">     769 </span>            : // Load libraries required for reading friends.
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :    if (fFriendLibs.Length()) {</span>
<span class="lineNum">     771 </span>            :       TObjArray *list = 0;
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :       TString lib;</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :       if (fFriendLibs.Contains(&quot;,&quot;)) list  = fFriendLibs.Tokenize(&quot;,&quot;);</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :       else                           list  = fFriendLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :       for (Int_t ilib=0; ilib&lt;list-&gt;GetEntriesFast(); ilib++) {</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :          lib = list-&gt;At(ilib)-&gt;GetName();</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :          lib.ReplaceAll(&quot;.so&quot;,&quot;&quot;);</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :          lib.ReplaceAll(&quot;.dylib&quot;,&quot;&quot;);</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :          lib.ReplaceAll(&quot; &quot;,&quot;&quot;);</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :          if (lib.BeginsWith(&quot;lib&quot;)) lib.Remove(0, 3);</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :          lib.Prepend(&quot;lib&quot;);</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :          Int_t loaded = strlen(gSystem-&gt;GetLibraries(lib,&quot;&quot;,kFALSE));</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :          if (!loaded) loaded = gSystem-&gt;Load(lib);</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :          if (loaded &lt; 0) {</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :             Error(&quot;LoadFriendLibs&quot;, &quot;Cannot load library for friends %s&quot;, lib.Data());</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">     787 </span>            :          }
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :       delete list;</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 : }   </span>
<a name="793"><span class="lineNum">     793 </span>            : </a>
<span class="lineNum">     794 </span>            : //______________________________________________________________________________
<span class="lineNum">     795 </span>            : void AliAnalysisAlien::SetRunPrefix(const char *prefix)
<span class="lineNum">     796 </span>            : {
<span class="lineNum">     797 </span>            : // Set the run number format. Can be a prefix or a format like &quot;%09d&quot;
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :    fRunPrefix = prefix;</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :    if (!fRunPrefix.Contains(&quot;%&quot;)) fRunPrefix += &quot;%d&quot;;</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 : }   </span>
<a name="801"><span class="lineNum">     801 </span>            : </a>
<span class="lineNum">     802 </span>            : //______________________________________________________________________________
<span class="lineNum">     803 </span>            : void AliAnalysisAlien::AddIncludePath(const char *path)
<span class="lineNum">     804 </span>            : {
<span class="lineNum">     805 </span>            : // Add include path in the remote analysis macro.
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :    TString p(path);</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :    if (p.Contains(&quot;-I&quot;)) fIncludePath += Form(&quot;%s &quot;, path);</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :    else                  fIncludePath += Form(&quot;-I%s &quot;, path);</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 : }</span>
<a name="810"><span class="lineNum">     810 </span>            : </a>
<span class="lineNum">     811 </span>            : //______________________________________________________________________________
<span class="lineNum">     812 </span>            : void AliAnalysisAlien::AddRunNumber(Int_t run)
<span class="lineNum">     813 </span>            : {
<span class="lineNum">     814 </span>            : // Add a run number to the list of runs to be processed.
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :    if (fRunNumbers.Length()) fRunNumbers += &quot; &quot;;</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :    fRunNumbers += Form(fRunPrefix.Data(), run);</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 : }   </span>
<a name="818"><span class="lineNum">     818 </span>            : </a>
<span class="lineNum">     819 </span>            : //______________________________________________________________________________
<span class="lineNum">     820 </span>            : void AliAnalysisAlien::AddRunList(const char* runList)
<span class="lineNum">     821 </span>            : {
<span class="lineNum">     822 </span>            : // Add several runs into the list of runs; they are expected to be separated by a blank character.  
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :   TString    sList = runList;</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :   TObjArray *list  = sList.Tokenize(&quot; &quot;);</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :   Int_t n = list-&gt;GetEntries();</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :   for (Int_t i = 0; i &lt; n; i++) {</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :     TObjString *os = (TObjString*)list-&gt;At(i);</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :     AddRunNumber(os-&gt;GetString().Atoi());</span>
<span class="lineNum">     829 </span>            :   }
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :   delete list;</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 : }</span>
<a name="832"><span class="lineNum">     832 </span>            : </a>
<span class="lineNum">     833 </span>            : //______________________________________________________________________________
<span class="lineNum">     834 </span>            : void AliAnalysisAlien::AddRunNumber(const char* run)
<span class="lineNum">     835 </span>            : {
<span class="lineNum">     836 </span>            : // Add a run number to the list of runs to be processed.
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :    TString runs = run;</span>
<span class="lineNum">     838 </span>            :    TObjString *os;
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :    TObjArray *arr = runs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :    TIter next(arr);</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :    TString prefix; </span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :    prefix.Append(fRunPrefix, fRunPrefix.Index(&quot;%d&quot;));</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :    while ((os=(TObjString*)next())){</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :        if (fRunNumbers.Length()) fRunNumbers += &quot; &quot;;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :        fRunNumbers += Form(&quot;%s%s&quot;, prefix.Data(), os-&gt;GetString().Data());</span>
<span class="lineNum">     846 </span>            :    }
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :    delete arr;</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 : }   </span>
<a name="849"><span class="lineNum">     849 </span>            : </a>
<span class="lineNum">     850 </span>            : //______________________________________________________________________________
<span class="lineNum">     851 </span>            : void AliAnalysisAlien::AddDataFile(const char *lfn)
<span class="lineNum">     852 </span>            : {
<span class="lineNum">     853 </span>            : // Adds a data file to the input to be analysed. The file should be a valid LFN
<span class="lineNum">     854 </span>            : // or point to an existing file in the alien workdir.
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :    if (!fInputFiles) fInputFiles = new TObjArray();</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :    fInputFiles-&gt;Add(new TObjString(lfn));</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 : }</span>
<a name="858"><span class="lineNum">     858 </span>            : </a>
<span class="lineNum">     859 </span>            : //______________________________________________________________________________
<span class="lineNum">     860 </span>            : void AliAnalysisAlien::AddExternalPackage(const char *package)
<span class="lineNum">     861 </span>            : {
<span class="lineNum">     862 </span>            : // Adds external packages w.r.t to the default ones (root,aliroot and gapi)
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :    if (fExternalPackages) fExternalPackages += &quot; &quot;;</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :    fExternalPackages += package;</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 : }   </span>
<a name="866"><span class="lineNum">     866 </span>            :       </a>
<span class="lineNum">     867 </span>            : //______________________________________________________________________________
<span class="lineNum">     868 </span>            : Bool_t AliAnalysisAlien::Connect()
<span class="lineNum">     869 </span>            : {
<span class="lineNum">     870 </span>            : // Try to connect to AliEn. User needs a valid token and /tmp/gclient_env_$UID sourced.
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :    if (gGrid &amp;&amp; gGrid-&gt;IsConnected()) return kTRUE;</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :    if (fProductionMode) return kTRUE;</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :    if (!gGrid) {</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :       Info(&quot;Connect&quot;, &quot;Trying to connect to AliEn ...&quot;);</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :       TGrid::Connect(&quot;alien://&quot;);</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :    if (!gGrid || !gGrid-&gt;IsConnected()) {</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :       Error(&quot;Connect&quot;, &quot;Did not managed to connect to AliEn. Make sure you have a valid token.&quot;);</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     880 </span>            :    }  
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :    fUser = gGrid-&gt;GetUser();</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :    Info(&quot;Connect&quot;, &quot;\n#####   Connected to AliEn as user %s. Setting analysis user to &lt;%s&gt;&quot;, fUser.Data(), fUser.Data());</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 : }</span>
<a name="885"><span class="lineNum">     885 </span>            : </a>
<span class="lineNum">     886 </span>            : //______________________________________________________________________________
<span class="lineNum">     887 </span>            : void AliAnalysisAlien::CdWork()
<span class="lineNum">     888 </span>            : {
<span class="lineNum">     889 </span>            : // Check validity of alien workspace. Create directory if possible.
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :    if (!Connect()) {</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :       Error(&quot;CdWork&quot;, &quot;Alien connection required&quot;);</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     893 </span>            :    } 
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :    TString homedir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :    TString workdir = homedir + fGridWorkingDir;</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :    if (DirectoryExists(workdir)) {</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :       gGrid-&gt;Cd(workdir);</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     899 </span>            :    }   
<span class="lineNum">     900 </span>            :    // Work directory not existing - create it
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :    gGrid-&gt;Cd(homedir);</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :    if (gGrid-&gt;Mkdir(workdir, &quot;-p&quot;)) {</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :       gGrid-&gt;Cd(fGridWorkingDir);</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :       Info(&quot;CdWork&quot;, &quot;\n#####   Created alien working directory %s&quot;, fGridWorkingDir.Data());</span>
<span class="lineNum">     905 </span>            :    } else {
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :       Warning(&quot;CdWork&quot;, &quot;Working directory %s cannot be created.\n Using %s instead.&quot;,</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :               workdir.Data(), homedir.Data());</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :       fGridWorkingDir = &quot;&quot;;</span>
<span class="lineNum">     909 </span>            :    }          
<span class="lineNum">     910 </span><span class="lineNoCov">          0 : }</span>
<a name="911"><span class="lineNum">     911 </span>            : </a>
<span class="lineNum">     912 </span>            : //______________________________________________________________________________
<span class="lineNum">     913 </span>            : Bool_t AliAnalysisAlien::CheckFileCopy(const char *alienpath)
<span class="lineNum">     914 </span>            : {
<span class="lineNum">     915 </span>            : // Check if file copying is possible.
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :    if (fProductionMode) return kTRUE;</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :    TString salienpath(alienpath);</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :    if (salienpath.Contains(&quot; &quot;)) {</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :       Error(&quot;CheckFileCopy&quot;, &quot;path: &lt;%s&gt; contains blancs - FIX IT !&quot;,alienpath);</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     921 </span>            :    }   
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :    if (!Connect()) {</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :       Error(&quot;CheckFileCopy&quot;, &quot;Not connected to AliEn. File copying cannot be tested.&quot;);</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     925 </span>            :    }
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :    Info(&quot;CheckFileCopy&quot;, &quot;Checking possibility to copy files to your AliEn home directory... \</span>
<span class="lineNum">     927 </span>            :         \n +++ NOTE: You can disable this via: plugin-&gt;SetCheckCopy(kFALSE);&quot;);
<span class="lineNum">     928 </span>            :    // Check if alien_CLOSE_SE is defined
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :    TString closeSE = gSystem-&gt;Getenv(&quot;alien_CLOSE_SE&quot;);</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :    if (!closeSE.IsNull()) {</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :       Info(&quot;CheckFileCopy&quot;, &quot;Your current close storage is pointing to: \</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :            \n      alien_CLOSE_SE = \&quot;%s\&quot;&quot;, closeSE.Data());</span>
<span class="lineNum">     933 </span>            :    } else {
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :       Warning(&quot;CheckFileCopy&quot;, &quot;Your current close storage is empty ! Depending on your location, file copying may fail.&quot;);</span>
<span class="lineNum">     935 </span>            :    }        
<span class="lineNum">     936 </span>            :    // Check if grid directory exists.
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :    if (!DirectoryExists(alienpath)) {</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :       Error(&quot;CheckFileCopy&quot;, &quot;Alien path %s does not seem to exist&quot;, alienpath);</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     940 </span>            :    }
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :    TString stest = &quot;plugin_test_copy&quot;;</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :    TFile f(stest, &quot;RECREATE&quot;);</span>
<span class="lineNum">     943 </span>            :    // User may not have write permissions to current directory 
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :    if (f.IsZombie()) {</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :       Error(&quot;CheckFileCopy&quot;, &quot;Cannot create local test file. Do you have write access to current directory: &lt;%s&gt; ?&quot;,</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :             gSystem-&gt;WorkingDirectory());</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     948 </span>            :    }
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :    f.Close();</span>
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :    if (FileExists(Form(&quot;alien://%s/%s&quot;,alienpath, stest.Data()))) gGrid-&gt;Rm(Form(&quot;alien://%s/%s&quot;,alienpath, stest.Data()));</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :    if (!TFile::Cp(stest.Data(), Form(&quot;alien://%s/%s&quot;,alienpath, stest.Data()))) {</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :       Error(&quot;CheckFileCopy&quot;, &quot;Cannot copy files to Alien destination: &lt;%s&gt; This may be temporary, or: \</span>
<span class="lineNum">     953 </span>            :            \n# 1. Make sure you have write permissions there. If this is the case: \
<span class="lineNum">     954 </span>            :            \n# 2. Check the storage availability at: http://alimonitor.cern.ch/stats?page=SE/table \
<span class="lineNum">     955 </span>            :            \n#    Do:           export alien_CLOSE_SE=\&quot;working_disk_SE\&quot; \
<span class="lineNum">     956 </span>            :            \n#    To make this permanent put in in your .bashrc (in .alienshrc is not enough) \
<span class="lineNum">     957 </span>            :            \n#    Redo token:   rm /tmp/x509up_u$UID then: alien-token-init &lt;username&gt;&quot;, alienpath);
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :       gSystem-&gt;Unlink(stest.Data());</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     960 </span>            :    }   
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :    gSystem-&gt;Unlink(stest.Data());</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :    gGrid-&gt;Rm(Form(&quot;%s/%s&quot;,alienpath,stest.Data()));</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :    Info(&quot;CheckFileCopy&quot;, &quot;### ...SUCCESS ###&quot;);</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 : }   </span>
<a name="966"><span class="lineNum">     966 </span>            : </a>
<span class="lineNum">     967 </span>            : //______________________________________________________________________________
<span class="lineNum">     968 </span>            : Bool_t AliAnalysisAlien::CheckInputData()
<span class="lineNum">     969 </span>            : {
<span class="lineNum">     970 </span>            : // Check validity of input data. If necessary, create xml files.
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :    if (fProductionMode) return kTRUE;</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :    if (!fInputFiles &amp;&amp; !fRunNumbers.Length() &amp;&amp; !fRunRange[0]) {</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :       if (!fGridDataDir.Length()) {</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :          Error(&quot;CkeckInputData&quot;, &quot;AliEn path to base data directory must be set.\n = Use: SetGridDataDir()&quot;);</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">     976 </span>            :       }
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :       if (fMergeViaJDL) {</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :          Error(&quot;CheckInputData&quot;, &quot;Merging via jdl works only with run numbers, run range or provided xml&quot;);</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">     980 </span>            :       }   
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :       Info(&quot;CheckInputData&quot;, &quot;Analysis will make a single xml for base data directory %s&quot;,fGridDataDir.Data());</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :       if (fDataPattern.Contains(&quot;tag&quot;) &amp;&amp; TestBit(AliAnalysisGrid::kTest))</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :          TObject::SetBit(AliAnalysisGrid::kUseTags, kTRUE); // ADDED (fix problem in determining the tag usage in test mode) </span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :       return kTRUE;</span>
<span class="lineNum">     985 </span>            :    }
<span class="lineNum">     986 </span>            :    // Process declared files
<span class="lineNum">     987 </span>            :    Bool_t isCollection = kFALSE;
<span class="lineNum">     988 </span>            :    Bool_t isXml = kFALSE;
<span class="lineNum">     989 </span>            :    Bool_t useTags = kFALSE;
<span class="lineNum">     990 </span>            :    Bool_t checked = kFALSE;
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :    if (!TestBit(AliAnalysisGrid::kTest)) CdWork();</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :    TString file;</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :    TString workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :    workdir += fGridWorkingDir;</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :    if (fInputFiles) {</span>
<span class="lineNum">     996 </span>            :       TObjString *objstr;
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :       TIter next(fInputFiles);</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :       while ((objstr=(TObjString*)next())) {</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :          file = workdir;</span>
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :          file += &quot;/&quot;;</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :          file += objstr-&gt;GetString();</span>
<span class="lineNum">    1002 </span>            :          // Store full lfn path
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :          if (FileExists(file)) objstr-&gt;SetString(file);</span>
<span class="lineNum">    1004 </span>            :          else {
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :             file = objstr-&gt;GetName();</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :             if (!FileExists(objstr-&gt;GetName())) {</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :                Error(&quot;CheckInputData&quot;, &quot;Data file %s not found or not in your working dir: %s&quot;,</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :                      objstr-&gt;GetName(), workdir.Data());</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :                return kFALSE;</span>
<span class="lineNum">    1010 </span>            :             }         
<span class="lineNum">    1011 </span>            :          }
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :          Bool_t iscoll, isxml, usetags;</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :          CheckDataType(file, iscoll, isxml, usetags);</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :          if (!checked) {</span>
<span class="lineNum">    1015 </span>            :             checked = kTRUE;
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :             isCollection = iscoll;</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :             isXml = isxml;</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :             useTags = usetags;</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :             TObject::SetBit(AliAnalysisGrid::kUseTags, useTags);</span>
<span class="lineNum">    1020 </span>            :          } else {
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :             if ((iscoll != isCollection) || (isxml != isXml) || (usetags != useTags)) {</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :                Error(&quot;CheckInputData&quot;, &quot;Some conflict was found in the types of inputs&quot;);</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :                return kFALSE;</span>
<span class="lineNum">    1024 </span>            :             } 
<span class="lineNum">    1025 </span>            :          }
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    1028 </span>            :    // Process requested run numbers
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :    if (!fRunNumbers.Length() &amp;&amp; !fRunRange[0]) return kTRUE;</span>
<span class="lineNum">    1030 </span>            :    // Check validity of alien data directory
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :    if (!fGridDataDir.Length()) {</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :       Error(&quot;CkeckInputData&quot;, &quot;AliEn path to base data directory must be set.\n = Use: SetGridDataDir()&quot;);</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    1034 </span>            :    }
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :    if (!DirectoryExists(fGridDataDir)) {</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :       Error(&quot;CheckInputData&quot;, &quot;Data directory %s not existing.&quot;, fGridDataDir.Data());</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    1038 </span>            :    }
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :    if (isCollection) {</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :       Error(&quot;CheckInputData&quot;, &quot;You are using raw AliEn collections as input. Cannot process run numbers.&quot;);</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :       return kFALSE;   </span>
<span class="lineNum">    1042 </span>            :    }
<span class="lineNum">    1043 </span>            :    
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :    if (checked &amp;&amp; !isXml) {</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :       Error(&quot;CheckInputData&quot;, &quot;Cannot mix processing of full runs with non-xml files&quot;);</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :       return kFALSE;   </span>
<span class="lineNum">    1047 </span>            :    }
<span class="lineNum">    1048 </span>            :    // Check validity of run number(s)
<span class="lineNum">    1049 </span>            :    TObjArray *arr;
<span class="lineNum">    1050 </span>            :    TObjString *os;
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :    TString format;</span>
<span class="lineNum">    1052 </span>            :    Int_t nruns = 0;
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :    TString schunk, schunk2;</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :    TString path;</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :    if (!checked) {</span>
<span class="lineNum">    1056 </span>            :       checked = kTRUE;
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :       useTags = fDataPattern.Contains(&quot;tag&quot;);</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :       TObject::SetBit(AliAnalysisGrid::kUseTags, useTags);</span>
<span class="lineNum">    1059 </span>            :    }   
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :    if (useTags != fDataPattern.Contains(&quot;tag&quot;)) {</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :       Error(&quot;CheckInputData&quot;, &quot;Cannot mix input files using/not using tags&quot;);</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    1063 </span>            :    }
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :    if (fRunNumbers.Length()) {</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :       Info(&quot;CheckDataType&quot;, &quot;Using supplied run numbers (run ranges are ignored)&quot;);</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :       arr = fRunNumbers.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :       TIter next(arr);</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :       while ((os=(TObjString*)next())) {</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :          path = Form(&quot;%s/%s &quot;, fGridDataDir.Data(), os-&gt;GetString().Data());</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :          if (!DirectoryExists(path)) {</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :             Warning(&quot;CheckInputData&quot;, &quot;Run number %s not found in path: &lt;%s&gt;&quot;, os-&gt;GetString().Data(), path.Data());</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    1073 </span>            :          }
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :          path = Form(&quot;%s/%s.xml&quot;, workdir.Data(),os-&gt;GetString().Data());</span>
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :          TString msg = &quot;\n#####   file: &quot;;</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :          msg += path;</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :          msg += &quot; type: xml_collection;&quot;;</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :          if (useTags) msg += &quot; using_tags: Yes&quot;;</span>
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :          else          msg += &quot; using_tags: No&quot;;</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :          Info(&quot;CheckDataType&quot;, &quot;%s&quot;, msg.Data());</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :          if (fNrunsPerMaster&lt;2) {</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :             AddDataFile(Form(&quot;%s.xml&quot;, os-&gt;GetString().Data()));</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :          } else {</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :             nruns++;</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :             if (((nruns-1)%fNrunsPerMaster) == 0) {</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :                schunk = os-&gt;GetString();</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :             }   </span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :             if ((nruns%fNrunsPerMaster)!=0 &amp;&amp; os!=arr-&gt;Last()) continue;</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :             schunk += Form(&quot;_%s.xml&quot;, os-&gt;GetString().Data());</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :             AddDataFile(schunk);</span>
<span class="lineNum">    1091 </span>            :          }   
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :       delete arr;   </span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :    } else {</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :       Info(&quot;CheckDataType&quot;, &quot;Using run range [%d, %d]&quot;, fRunRange[0], fRunRange[1]);</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :       for (Int_t irun=fRunRange[0]; irun&lt;=fRunRange[1]; irun++) {</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :          format = Form(&quot;%%s/%s &quot;, fRunPrefix.Data());</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :          path = Form(format.Data(), fGridDataDir.Data(), irun);</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :          if (!DirectoryExists(path)) {</span>
<span class="lineNum">    1100 </span>            :             continue;
<span class="lineNum">    1101 </span>            :          }
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :          format = Form(&quot;%%s/%s.xml&quot;, fRunPrefix.Data());</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :          path = Form(format.Data(), workdir.Data(),irun);</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :          TString msg = &quot;\n#####   file: &quot;;</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :          msg += path;</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :          msg += &quot; type: xml_collection;&quot;;</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :          if (useTags) msg += &quot; using_tags: Yes&quot;;</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :          else          msg += &quot; using_tags: No&quot;;</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :          Info(&quot;CheckDataType&quot;, &quot;%s&quot;, msg.Data());</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :          if (fNrunsPerMaster&lt;2) {</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :             format = Form(&quot;%s.xml&quot;, fRunPrefix.Data());</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :             AddDataFile(Form(format.Data(),irun));</span>
<span class="lineNum">    1113 </span>            :          } else {
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :             nruns++;</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :             if (((nruns-1)%fNrunsPerMaster) == 0) {</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :                schunk = Form(fRunPrefix.Data(),irun);</span>
<span class="lineNum">    1117 </span>            :             }
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :             format = Form(&quot;_%s.xml&quot;, fRunPrefix.Data());</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :             schunk2 = Form(format.Data(), irun);</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :             if ((nruns%fNrunsPerMaster)!=0 &amp;&amp; irun != fRunRange[1]) continue;</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :             schunk += schunk2;</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :             AddDataFile(schunk);</span>
<span class="lineNum">    1123 </span>            :          }   
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :       if (!fInputFiles) {</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :          schunk += schunk2;</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :          AddDataFile(schunk);</span>
<span class="lineNum">    1128 </span>            :       }   
<span class="lineNum">    1129 </span>            :    }
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :    return kTRUE;      </span>
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 : }   </span>
<a name="1132"><span class="lineNum">    1132 </span>            : </a>
<span class="lineNum">    1133 </span>            : //______________________________________________________________________________
<span class="lineNum">    1134 </span>            : Int_t AliAnalysisAlien::CopyLocalDataset(const char *griddir, const char *pattern, Int_t nfiles, const char *output, const char *archivefile, const char *outputdir)
<span class="lineNum">    1135 </span>            : {
<span class="lineNum">    1136 </span>            : // Copy data from the given grid directory according a pattern and make a local
<span class="lineNum">    1137 </span>            : // dataset.
<span class="lineNum">    1138 </span>            : // archivefile (optional) results in that the archive containing the file &lt;pattern&gt; is copied. archivefile can contain a list of files (semicolon-separated) which are all copied
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :    if (!Connect()) {</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :       Error(&quot;CopyLocalDataset&quot;, &quot;Cannot copy local dataset with no grid connection&quot;);</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">    1142 </span>            :    }
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :    if (!DirectoryExists(griddir)) {</span>
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :       Error(&quot;CopyLocalDataset&quot;, &quot;Data directory %s not existing.&quot;, griddir);</span>
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">    1146 </span>            :    }
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :    TString command = Form(&quot;find -z -l %d %s %s&quot;, nfiles, griddir, pattern);</span>
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :    printf(&quot;Running command: %s\n&quot;, command.Data());</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :    TGridResult *res = gGrid-&gt;Command(command);</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :    Int_t nfound = res-&gt;GetEntries();</span>
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :    if (!nfound) {</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :       Error(&quot;CopyLocalDataset&quot;, &quot;No file found in &lt;%s&gt; having pattern &lt;%s&gt;&quot;, griddir, pattern);</span>
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">    1154 </span>            :    }
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :    printf(&quot;... found %d files. Copying locally ...\n&quot;, nfound);</span>
<span class="lineNum">    1156 </span>            :    
<span class="lineNum">    1157 </span>            :    // archives
<span class="lineNum">    1158 </span>            :    TObjArray* additionalArchives = 0;
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :    if (strlen(archivefile) &gt; 0 &amp;&amp; TString(archivefile).Contains(&quot;;&quot;)) {</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :       additionalArchives = TString(archivefile).Tokenize(&quot;;&quot;);</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :       archivefile = additionalArchives-&gt;At(0)-&gt;GetName();</span>
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :       additionalArchives-&gt;RemoveAt(0);</span>
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :       additionalArchives-&gt;Compress();</span>
<span class="lineNum">    1164 </span>            :    }
<span class="lineNum">    1165 </span>            :    
<span class="lineNum">    1166 </span>            :    // Copy files locally
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :    ofstream out;</span>
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :    out.open(output, ios::out);</span>
<span class="lineNum">    1169 </span>            :    TMap *map;
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :    TString turl, dirname, filename, temp;</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :    TString cdir = gSystem-&gt;WorkingDirectory();</span>
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 :    gSystem-&gt;MakeDirectory(outputdir);</span>
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :    gSystem-&gt;ChangeDirectory(outputdir);</span>
<span class="lineNum">    1174 </span>            :    Int_t ncopied = 0;
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :    for (Int_t i=0; i&lt;nfound; i++) {</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :       map = (TMap*)res-&gt;At(i);</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :       turl = map-&gt;GetValue(&quot;turl&quot;)-&gt;GetName();</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :       filename = gSystem-&gt;BaseName(turl.Data());</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :       dirname = gSystem-&gt;DirName(turl.Data());</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :       dirname = gSystem-&gt;BaseName(dirname.Data());</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :       gSystem-&gt;MakeDirectory(dirname);</span>
<span class="lineNum">    1182 </span>            :       
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :       TString source(turl);</span>
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :       TString targetFileName(filename);</span>
<span class="lineNum">    1185 </span>            :       
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :       if (strlen(archivefile) &gt; 0) {</span>
<span class="lineNum">    1187 </span>            : // TODO here the archive in which the file resides should be determined
<span class="lineNum">    1188 </span>            : // however whereis returns only a guid, and guid2lfn does not work
<span class="lineNum">    1189 </span>            : // Therefore we use the one provided as argument for now
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :          source = Form(&quot;%s/%s&quot;, gSystem-&gt;DirName(source.Data()), archivefile);</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :          targetFileName = archivefile;</span>
<span class="lineNum">    1192 </span>            :       }
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :       if (TFile::Cp(source, Form(&quot;file:./%s/%s&quot;, dirname.Data(), targetFileName.Data()))) {</span>
<span class="lineNum">    1194 </span>            :          Bool_t success = kTRUE;
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :          if (additionalArchives) {</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :             for (Int_t j=0; j&lt;additionalArchives-&gt;GetEntriesFast(); j++) {</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :                TString target;</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                target.Form(&quot;./%s/%s&quot;, dirname.Data(), additionalArchives-&gt;At(j)-&gt;GetName());</span>
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :                gSystem-&gt;MakeDirectory(gSystem-&gt;DirName(target));</span>
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :                success &amp;= TFile::Cp(Form(&quot;%s/%s&quot;, gSystem-&gt;DirName(source.Data()), additionalArchives-&gt;At(j)-&gt;GetName()), Form(&quot;file:%s&quot;, target.Data()));</span>
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    1203 </span>            : 
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :          if (success) {</span>
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :             if (strlen(archivefile) &gt; 0) targetFileName = Form(&quot;%s#%s&quot;, targetFileName.Data(), gSystem-&gt;BaseName(turl.Data()));</span>
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :             out &lt;&lt; cdir &lt;&lt; Form(&quot;/%s/%s/%s&quot;, outputdir, dirname.Data(), targetFileName.Data()) &lt;&lt; endl;</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :             ncopied++;</span>
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :    gSystem-&gt;ChangeDirectory(cdir);</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :    delete res;</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :    delete additionalArchives;</span>
<span class="lineNum">    1214 </span>            :    return ncopied;
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 : }   </span>
<a name="1216"><span class="lineNum">    1216 </span>            : </a>
<span class="lineNum">    1217 </span>            : //______________________________________________________________________________
<span class="lineNum">    1218 </span>            : Bool_t AliAnalysisAlien::CreateDataset(const char *pattern)
<span class="lineNum">    1219 </span>            : {
<span class="lineNum">    1220 </span>            : // Create dataset for the grid data directory + run number.
<span class="lineNum">    1221 </span>            :    const Int_t gMaxEntries = 15000;
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :    if (fProductionMode || TestBit(AliAnalysisGrid::kOffline)) return kTRUE;</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :    if (!Connect()) {</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :       Error(&quot;CreateDataset&quot;, &quot;Cannot create dataset with no grid connection&quot;);</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    1226 </span>            :    }   
<span class="lineNum">    1227 </span>            : 
<span class="lineNum">    1228 </span>            :    // Cd workspace
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :    if (!TestBit(AliAnalysisGrid::kTest)) CdWork();</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :    TString workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :    workdir += fGridWorkingDir;</span>
<span class="lineNum">    1232 </span>            : 
<span class="lineNum">    1233 </span>            :    // Compose the 'find' command arguments
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :    TString format;</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :    TString command;</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :    TString delimiter = pattern;</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :    delimiter.Strip();</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :    if (delimiter.Contains(&quot; &quot;)) delimiter = &quot;&quot;;</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :    else delimiter = &quot; &quot;;</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :    TString options = &quot;-x collection &quot;;</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :    if (TestBit(AliAnalysisGrid::kTest)) options += Form(&quot;-l %d &quot;, fNtestFiles);</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :    else options += Form(&quot;-l %d &quot;, gMaxEntries);  // Protection for the find command</span>
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :    TString conditions = &quot;&quot;;</span>
<span class="lineNum">    1244 </span>            :    Int_t nstart = 0;
<span class="lineNum">    1245 </span>            :    Int_t ncount = 0;
<span class="lineNum">    1246 </span>            :    Int_t stage = 0;
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :    TString file;</span>
<span class="lineNum">    1248 </span><span class="lineNoCov">          0 :    TString path;</span>
<span class="lineNum">    1249 </span>            :    Int_t nruns = 0;
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :    TString schunk, schunk2;</span>
<span class="lineNum">    1251 </span>            :    TGridCollection *cbase=0, *cadd=0;
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :    if (!fRunNumbers.Length() &amp;&amp; !fRunRange[0]) {</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :       if (fInputFiles &amp;&amp; fInputFiles-&gt;GetEntries()) return kTRUE;</span>
<span class="lineNum">    1254 </span>            :       // Make a single data collection from data directory.
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :       path = fGridDataDir;</span>
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :       if (!DirectoryExists(path)) {</span>
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :          Error(&quot;CreateDataset&quot;, &quot;Path to data directory %s not valid&quot;,fGridDataDir.Data());</span>
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    1259 </span>            :       } 
<span class="lineNum">    1260 </span>            : //      CdWork();
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :       if (TestBit(AliAnalysisGrid::kTest)) file = &quot;wn.xml&quot;;</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :       else file = Form(&quot;%s.xml&quot;, gSystem-&gt;BaseName(path));</span>
<span class="lineNum">    1263 </span>            :       // cholm - Identical loop - should be put in common function for code simplification
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :       while (1) {</span>
<span class="lineNum">    1265 </span>            :          ncount = 0;
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :          stage++;</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :          if (gSystem-&gt;AccessPathName(file) || TestBit(AliAnalysisGrid::kTest) || fOverwriteMode) {</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :             command = &quot;alien_find &quot;;</span>
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :             command += Form(&quot;%s -o %d &quot;,options.Data(), nstart);</span>
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :             command += path;</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :             command += delimiter;</span>
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 :             command += pattern;</span>
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :             command += conditions;</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :             printf(&quot;command: %s\n&quot;, command.Data());</span>
<span class="lineNum">    1275 </span>            :             //TGridResult *res = gGrid-&gt;Command(command);
<span class="lineNum">    1276 </span>            :             //if (res) delete res;
<span class="lineNum">    1277 </span>            :             // Write standard output to file
<span class="lineNum">    1278 </span>            :             // Write standard error to null device
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :             gSystem-&gt;Exec(Form(&quot;%s &gt; __tmp%d__%s 2&gt;/dev/null&quot;, command.Data(), stage, file.Data()));</span>
<span class="lineNum">    1280 </span>            :             //gROOT-&gt;ProcessLine(Form(&quot;gGrid-&gt;Stdout(); &gt; __tmp%d__%s&quot;, stage, file.Data()));
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :             Bool_t hasGrep = (gSystem-&gt;Exec(&quot;grep --version 2&gt;/dev/null &gt; /dev/null&quot;)==0)?kTRUE:kFALSE;</span>
<span class="lineNum">    1282 </span>            :             Bool_t nullFile = kFALSE;
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :             if (!hasGrep) {</span>
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :                 Warning(&quot;CreateDataset&quot;, &quot;'grep' command not available on this system - cannot validate the result of the grid 'find' command&quot;);</span>
<span class="lineNum">    1285 </span>            :             } else {
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :                nullFile = (gSystem-&gt;Exec(Form(&quot;grep -c /event __tmp%d__%s 2&gt;/dev/null &gt; __tmp__&quot;,stage,file.Data()))==0)?kFALSE:kTRUE;</span>
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :                if (nullFile) {</span>
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :                   Error(&quot;CreateDataset&quot;,&quot;Dataset %s produced by the previous find command is empty !&quot;, file.Data());</span>
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :                   gSystem-&gt;Exec(&quot;rm -f __tmp*&quot;);</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :                   return kFALSE;</span>
<span class="lineNum">    1291 </span>            :                }
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :                TString line;</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :                ifstream in;</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :                in.open(&quot;__tmp__&quot;);</span>
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :                in &gt;&gt; line;</span>
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :                in.close();</span>
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :                gSystem-&gt;Exec(&quot;rm -f __tmp__&quot;);</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :                ncount = line.Atoi();</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :             }         </span>
<span class="lineNum">    1300 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :          if (ncount == gMaxEntries) {</span>
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :             Info(&quot;CreateDataset&quot;, &quot;Dataset %s has more than 15K entries. Trying to merge...&quot;, file.Data());</span>
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :             cadd = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;__tmp%d__%s\&quot;, 1000000);&quot;,stage,file.Data()));</span>
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :             if (!cbase) cbase = cadd;</span>
<span class="lineNum">    1305 </span>            :             else {
<span class="lineNum">    1306 </span>            :               // cholm - Avoid using very slow TAlienCollection 
<span class="lineNum">    1307 </span>            :               // cbase-&gt;Add(cadd);
<span class="lineNum">    1308 </span>            :               // cholm - Use AddFast (via interpreter)
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :               gROOT-&gt;ProcessLine(Form(&quot;((TAlienCollection*)%p)-&gt;AddFast((TGridCollection*)%p)&quot;,cbase,cadd));</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :                delete cadd;</span>
<span class="lineNum">    1311 </span>            :             }   
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :             nstart += ncount;</span>
<span class="lineNum">    1313 </span>            :          } else {
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :             if (cbase) {</span>
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :                cadd = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;__tmp%d__%s\&quot;, 1000000);&quot;,stage,file.Data()));</span>
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :                printf(&quot;... please wait - TAlienCollection::Add() scales badly...\n&quot;);</span>
<span class="lineNum">    1317 </span>            :               // cholm - Avoid using very slow TAlienCollection 
<span class="lineNum">    1318 </span>            :               // cbase-&gt;Add(cadd);
<span class="lineNum">    1319 </span>            :               // cholm - Use AddFast (via interpreter)
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :               gROOT-&gt;ProcessLine(Form(&quot;((TAlienCollection*)%p)-&gt;AddFast((TGridCollection*)%p)&quot;,cbase,cadd));</span>
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :                delete cadd;</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :                cbase-&gt;ExportXML(Form(&quot;file://%s&quot;, file.Data()),kFALSE,kFALSE, file, &quot;Merged entries for a run&quot;);</span>
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :                delete cbase; cbase = 0;               </span>
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :             } else {</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :                TFile::Cp(Form(&quot;__tmp%d__%s&quot;,stage, file.Data()), file.Data());</span>
<span class="lineNum">    1326 </span>            :             }
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :             gSystem-&gt;Exec(&quot;rm -f __tmp*&quot;);   </span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :             Info(&quot;CreateDataset&quot;, &quot;Created dataset %s with %d files&quot;, file.Data(), nstart+ncount);</span>
<span class="lineNum">    1329 </span>            :             break;
<span class="lineNum">    1330 </span>            :          }
<span class="lineNum">    1331 </span>            :       }
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :       Bool_t fileExists = FileExists(file);</span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :       if (!TestBit(AliAnalysisGrid::kTest) &amp;&amp; (!fileExists || fOverwriteMode)) {</span>
<span class="lineNum">    1334 </span>            :          // Copy xml file to alien space
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :          if (fileExists) gGrid-&gt;Rm(file);</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :          TFile::Cp(Form(&quot;file:%s&quot;,file.Data()), Form(&quot;alien://%s/%s&quot;,workdir.Data(), file.Data()));</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :          if (!FileExists(file)) {</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :             Error(&quot;CreateDataset&quot;, &quot;Command %s did NOT succeed&quot;, command.Data());</span>
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">    1340 </span>            :          }
<span class="lineNum">    1341 </span>            :          // Update list of files to be processed.
<span class="lineNum">    1342 </span>            :       }
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :       AddDataFile(Form(&quot;%s/%s&quot;, workdir.Data(), file.Data()));</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :       return kTRUE;</span>
<span class="lineNum">    1345 </span>            :    }   
<span class="lineNum">    1346 </span>            :    // Several runs
<span class="lineNum">    1347 </span>            :    Bool_t nullResult = kTRUE;
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :    if (fRunNumbers.Length()) {</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :       TObjArray *arr = fRunNumbers.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    1350 </span>            :       TObjString *os;
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :       TIter next(arr);</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :       while ((os=(TObjString*)next())) {</span>
<span class="lineNum">    1353 </span>            :          nstart = 0;
<span class="lineNum">    1354 </span>            :          stage = 0;
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :          path = Form(&quot;%s/%s&quot;, fGridDataDir.Data(), os-&gt;GetString().Data());</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :          if (!DirectoryExists(path)) continue;</span>
<span class="lineNum">    1357 </span>            : //         CdWork();
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :          if (TestBit(AliAnalysisGrid::kTest)) file = &quot;wn.xml&quot;;</span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :          else file = Form(&quot;%s.xml&quot;, os-&gt;GetString().Data());</span>
<span class="lineNum">    1360 </span>            :          // cholm - Identical loop - should be put in common function for code simplification
<span class="lineNum">    1361 </span>            :          // If local collection file does not exist, create it via 'find' command.
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :          while (1) {</span>
<span class="lineNum">    1363 </span>            :             ncount = 0;
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :             stage++;</span>
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :             if (gSystem-&gt;AccessPathName(file) || TestBit(AliAnalysisGrid::kTest) || fOverwriteMode) {</span>
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :                command = &quot;alien_find &quot;;</span>
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :                command +=  Form(&quot;%s -o %d &quot;,options.Data(), nstart);</span>
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :                command += path;</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :                command += delimiter;</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :                command += pattern;</span>
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :                command += conditions;</span>
<span class="lineNum">    1372 </span>            :                //TGridResult *res = gGrid-&gt;Command(command);
<span class="lineNum">    1373 </span>            :                //if (res) delete res;
<span class="lineNum">    1374 </span>            :                // Write standard output to file
<span class="lineNum">    1375 </span>            :                //gROOT-&gt;ProcessLine(Form(&quot;gGrid-&gt;Stdout(); &gt; __tmp%d__%s&quot;, stage,file.Data()));
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :                gSystem-&gt;Exec(Form(&quot;%s &gt; __tmp%d__%s 2&gt;/dev/null&quot;, command.Data(), stage, file.Data()));</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :                Bool_t hasGrep = (gSystem-&gt;Exec(&quot;grep --version 2&gt;/dev/null &gt; /dev/null&quot;)==0)?kTRUE:kFALSE;</span>
<span class="lineNum">    1378 </span>            :                Bool_t nullFile = kFALSE;
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :                if (!hasGrep) {</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :                   Warning(&quot;CreateDataset&quot;, &quot;'grep' command not available on this system - cannot validate the result of the grid 'find' command&quot;);</span>
<span class="lineNum">    1381 </span>            :                } else {
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :                   nullFile = (gSystem-&gt;Exec(Form(&quot;grep -c /event __tmp%d__%s 2&gt;/dev/null &gt; __tmp__&quot;,stage,file.Data()))==0)?kFALSE:kTRUE;</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :                   if (nullFile) {</span>
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 :                      Warning(&quot;CreateDataset&quot;,&quot;Dataset %s produced by: &lt;%s&gt; is empty !&quot;, file.Data(), command.Data());</span>
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :                      gSystem-&gt;Exec(&quot;rm -f __tmp*&quot;);</span>
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :                      fRunNumbers.ReplaceAll(os-&gt;GetString().Data(), &quot;&quot;);</span>
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :                      break;</span>
<span class="lineNum">    1388 </span>            :                   }   
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :                   TString line;</span>
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :                   ifstream in;</span>
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :                   in.open(&quot;__tmp__&quot;);</span>
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :                   in &gt;&gt; line;</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :                   in.close();</span>
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :                   gSystem-&gt;Exec(&quot;rm -f __tmp__&quot;);   </span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :                   ncount = line.Atoi();</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :                }</span>
<span class="lineNum">    1397 </span>            :                nullResult = kFALSE;         
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :             if (ncount == gMaxEntries) {</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :                Info(&quot;CreateDataset&quot;, &quot;Dataset %s has more than 15K entries. Trying to merge...&quot;, file.Data());</span>
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :                if (fNrunsPerMaster &gt; 1) {</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :                   Error(&quot;CreateDataset&quot;, &quot;File %s has more than %d entries. Please set the number of runs per master to 1 !&quot;, </span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :                           file.Data(),gMaxEntries);</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :                   return kFALSE;</span>
<span class="lineNum">    1405 </span>            :                }           
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :                cadd = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;__tmp%d__%s\&quot;, 1000000);&quot;,stage,file.Data()));</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :                if (!cbase) cbase = cadd;</span>
<span class="lineNum">    1408 </span>            :                else {
<span class="lineNum">    1409 </span>            :                   // cholm - Avoid using very slow TAlienCollection 
<span class="lineNum">    1410 </span>            :                   // cbase-&gt;Add(cadd);
<span class="lineNum">    1411 </span>            :                   // cholm - Use AddFast (via interpreter)
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :                   gROOT-&gt;ProcessLine(Form(&quot;((TAlienCollection*)%p)-&gt;AddFast((TGridCollection*)%p)&quot;,cbase,cadd));</span>
<span class="lineNum">    1413 </span>            : 
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :                   delete cadd;</span>
<span class="lineNum">    1415 </span>            :                }   
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :                nstart += ncount;</span>
<span class="lineNum">    1417 </span>            :             } else {
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :                if (cbase &amp;&amp; fNrunsPerMaster&lt;2) {</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :                   cadd = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;__tmp%d__%s\&quot;, 1000000);&quot;,stage,file.Data()));</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :                   printf(&quot;... please wait - TAlienCollection::Add() scales badly...\n&quot;);</span>
<span class="lineNum">    1421 </span>            :                   // cholm - Avoid using very slow TAlienCollection 
<span class="lineNum">    1422 </span>            :                   // cbase-&gt;Add(cadd);
<span class="lineNum">    1423 </span>            :                   // cholm - Use AddFast (via interpreter)
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :                   gROOT-&gt;ProcessLine(Form(&quot;((TAlienCollection*)%p)-&gt;AddFast((TGridCollection*)%p)&quot;,cbase,cadd));</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :                   delete cadd;</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :                   cbase-&gt;ExportXML(Form(&quot;file://%s&quot;, file.Data()),kFALSE,kFALSE, file, &quot;Merged entries for a run&quot;);</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :                   delete cbase; cbase = 0;               </span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :                } else {</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :                   TFile::Cp(Form(&quot;__tmp%d__%s&quot;,stage, file.Data()), file.Data());</span>
<span class="lineNum">    1430 </span>            :                }
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :                gSystem-&gt;Exec(&quot;rm -f __tmp*&quot;);   </span>
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :                Info(&quot;CreateDataset&quot;, &quot;Created dataset %s with %d files&quot;, file.Data(), nstart+ncount);</span>
<span class="lineNum">    1433 </span>            :                break;
<span class="lineNum">    1434 </span>            :             }
<span class="lineNum">    1435 </span>            :          }   
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :          if (TestBit(AliAnalysisGrid::kTest)) break;</span>
<span class="lineNum">    1437 </span>            :          // Check if there is one run per master job.
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :          if (fNrunsPerMaster&lt;2) {</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :             if (FileExists(file)) {</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :                if (fOverwriteMode) gGrid-&gt;Rm(file);</span>
<span class="lineNum">    1441 </span>            :                else {
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :                   Info(&quot;CreateDataset&quot;, &quot;\n#####   Dataset %s exist. Skipping creation...&quot;, file.Data());</span>
<span class="lineNum">    1443 </span>            :                   continue;
<span class="lineNum">    1444 </span>            :                }   
<span class="lineNum">    1445 </span>            :             }        
<span class="lineNum">    1446 </span>            :             // Copy xml file to alien space
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :             TFile::Cp(Form(&quot;file:%s&quot;,file.Data()), Form(&quot;alien://%s/%s&quot;,workdir.Data(), file.Data()));</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :             if (!FileExists(file)) {</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :                Error(&quot;CreateDataset&quot;, &quot;Command %s did NOT succeed&quot;, command.Data());</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :                delete arr;</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                return kFALSE;</span>
<span class="lineNum">    1452 </span>            :             }
<span class="lineNum">    1453 </span>            :          } else {
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :             nruns++;</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :             if (((nruns-1)%fNrunsPerMaster) == 0) {</span>
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :                schunk = os-&gt;GetString();</span>
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :                cbase = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;%s\&quot;, 1000000);&quot;,file.Data()));</span>
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :             } else {</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :                cadd = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;%s\&quot;, 1000000);&quot;,file.Data()));</span>
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :                printf(&quot;   Merging collection &lt;%s&gt; into masterjob input...\n&quot;, file.Data());</span>
<span class="lineNum">    1461 </span>            :                // cholm - Avoid using very slow TAlienCollection 
<span class="lineNum">    1462 </span>            :                // cbase-&gt;Add(cadd);
<span class="lineNum">    1463 </span>            :                // cholm - Use AddFast (via interpreter)
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :                gROOT-&gt;ProcessLine(Form(&quot;((TAlienCollection*)%p)-&gt;AddFast((TGridCollection*)%p)&quot;,cbase,cadd));</span>
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :                delete cadd;</span>
<span class="lineNum">    1466 </span>            :             }
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :             if ((nruns%fNrunsPerMaster)!=0 &amp;&amp; os!=arr-&gt;Last()) {</span>
<span class="lineNum">    1468 </span>            :                continue;
<span class="lineNum">    1469 </span>            :             }   
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :             schunk += Form(&quot;_%s.xml&quot;, os-&gt;GetString().Data());</span>
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :             if (FileExists(schunk)) {               </span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :                if (fOverwriteMode) gGrid-&gt;Rm(file);</span>
<span class="lineNum">    1473 </span>            :                else {
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :                   Info(&quot;CreateDataset&quot;, &quot;\n#####   Dataset %s exist. Skipping creation...&quot;, schunk.Data());</span>
<span class="lineNum">    1475 </span>            :                   continue;
<span class="lineNum">    1476 </span>            :                }   
<span class="lineNum">    1477 </span>            :             }        
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :             printf(&quot;Exporting merged collection &lt;%s&gt; and copying to AliEn\n&quot;, schunk.Data());</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :             cbase-&gt;ExportXML(Form(&quot;file://%s&quot;, schunk.Data()),kFALSE,kFALSE, schunk, &quot;Merged runs&quot;);</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :             TFile::Cp(Form(&quot;file:%s&quot;,schunk.Data()), Form(&quot;alien://%s/%s&quot;,workdir.Data(), schunk.Data()));</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :             if (!FileExists(schunk)) {</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :                Error(&quot;CreateDataset&quot;, &quot;Copy command did NOT succeed for %s&quot;, schunk.Data());</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :                delete arr;</span>
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :                return kFALSE;</span>
<span class="lineNum">    1485 </span>            :             }
<span class="lineNum">    1486 </span>            :          }
<span class="lineNum">    1487 </span>            :       }   
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :       delete arr;</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :       if (nullResult) {</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :          Error(&quot;CreateDataset&quot;, &quot;No valid dataset corresponding to the query!&quot;);</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    1492 </span>            :       }
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :    } else {</span>
<span class="lineNum">    1494 </span>            :       // Process a full run range.
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :       for (Int_t irun=fRunRange[0]; irun&lt;=fRunRange[1]; irun++) {</span>
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :          format = Form(&quot;%%s/%s&quot;, fRunPrefix.Data());</span>
<span class="lineNum">    1497 </span>            :          nstart = 0;
<span class="lineNum">    1498 </span>            :          stage = 0;
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :          path = Form(format.Data(), fGridDataDir.Data(), irun);</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :          if (!DirectoryExists(path)) continue;</span>
<span class="lineNum">    1501 </span>            : //         CdWork();
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :          format = Form(&quot;%s.xml&quot;, fRunPrefix.Data());</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :          if (TestBit(AliAnalysisGrid::kTest)) file = &quot;wn.xml&quot;;</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :          else file = Form(format.Data(), irun);</span>
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :          if (FileExists(file) &amp;&amp; fNrunsPerMaster&lt;2 &amp;&amp; !TestBit(AliAnalysisGrid::kTest)) {         </span>
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :             if (fOverwriteMode) gGrid-&gt;Rm(file);</span>
<span class="lineNum">    1507 </span>            :             else {
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :                Info(&quot;CreateDataset&quot;, &quot;\n#####   Dataset %s exist. Skipping creation...&quot;, file.Data());</span>
<span class="lineNum">    1509 </span>            :                continue;
<span class="lineNum">    1510 </span>            :             }   
<span class="lineNum">    1511 </span>            :          }
<span class="lineNum">    1512 </span>            :          // cholm - Identical loop - should be put in common function for code simplification
<span class="lineNum">    1513 </span>            :          // If local collection file does not exist, create it via 'find' command.
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :          while (1) {</span>
<span class="lineNum">    1515 </span>            :             ncount = 0;
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :             stage++;</span>
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :             if (gSystem-&gt;AccessPathName(file) || TestBit(AliAnalysisGrid::kTest) || fOverwriteMode) {</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :                command = &quot;alien_find &quot;;</span>
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :                command +=  Form(&quot;%s -o %d &quot;,options.Data(), nstart);</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :                command += path;</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :                command += delimiter;</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :                command += pattern;</span>
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :                command += conditions;</span>
<span class="lineNum">    1524 </span>            :                //TGridResult *res = gGrid-&gt;Command(command);
<span class="lineNum">    1525 </span>            :                //if (res) delete res;
<span class="lineNum">    1526 </span>            :                // Write standard output to file
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :                gSystem-&gt;Exec(Form(&quot;%s &gt; __tmp%d__%s 2&gt;/dev/null&quot;, command.Data(), stage, file.Data()));</span>
<span class="lineNum">    1528 </span>            :                //gROOT-&gt;ProcessLine(Form(&quot;gGrid-&gt;Stdout(); &gt; __tmp%d__%s&quot;, stage,file.Data()));
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :                Bool_t hasGrep = (gSystem-&gt;Exec(&quot;grep --version 2&gt;/dev/null &gt; /dev/null&quot;)==0)?kTRUE:kFALSE;</span>
<span class="lineNum">    1530 </span>            :                Bool_t nullFile = kFALSE;
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :                if (!hasGrep) {</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :                   Warning(&quot;CreateDataset&quot;, &quot;'grep' command not available on this system - cannot validate the result of the grid 'find' command&quot;);</span>
<span class="lineNum">    1533 </span>            :                } else {
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :                   nullFile = (gSystem-&gt;Exec(Form(&quot;grep -c /event __tmp%d__%s 2&gt;/dev/null &gt; __tmp__&quot;,stage,file.Data()))==0)?kFALSE:kTRUE;</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :                   if (nullFile) {</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :                      Warning(&quot;CreateDataset&quot;,&quot;Dataset %s produced by: &lt;%s&gt; is empty !&quot;, file.Data(), command.Data());</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :                      gSystem-&gt;Exec(&quot;rm -f __tmp*&quot;);</span>
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :                      break;</span>
<span class="lineNum">    1539 </span>            :                   }   
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :                   TString line;</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :                   ifstream in;</span>
<span class="lineNum">    1542 </span><span class="lineNoCov">          0 :                   in.open(&quot;__tmp__&quot;);</span>
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :                   in &gt;&gt; line;</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :                   in.close();</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :                   gSystem-&gt;Exec(&quot;rm -f __tmp__&quot;);   </span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :                   ncount = line.Atoi();</span>
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 :                }</span>
<span class="lineNum">    1548 </span>            :                nullResult = kFALSE;         
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :             }   </span>
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 :             if (ncount == gMaxEntries) {</span>
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :                Info(&quot;CreateDataset&quot;, &quot;Dataset %s has more than 15K entries. Trying to merge...&quot;, file.Data());</span>
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :                if (fNrunsPerMaster &gt; 1) {</span>
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :                   Error(&quot;CreateDataset&quot;, &quot;File %s has more than %d entries. Please set the number of runs per master to 1 !&quot;, </span>
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :                           file.Data(),gMaxEntries);</span>
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :                   return kFALSE;</span>
<span class="lineNum">    1556 </span>            :                }           
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :                cadd = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;__tmp%d__%s\&quot;, 1000000);&quot;,stage,file.Data()));</span>
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :                if (!cbase) cbase = cadd;</span>
<span class="lineNum">    1559 </span>            :                else {
<span class="lineNum">    1560 </span>            :                  // cholm - Avoid using very slow TAlienCollection 
<span class="lineNum">    1561 </span>            :                  // cbase-&gt;Add(cadd);
<span class="lineNum">    1562 </span>            :                  // cholm - Use AddFast (via interpreter)
<span class="lineNum">    1563 </span><span class="lineNoCov">          0 :                  gROOT-&gt;ProcessLine(Form(&quot;((TAlienCollection*)%p)-&gt;AddFast((TGridCollection*)%p)&quot;,cbase,cadd));</span>
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :                   delete cadd;</span>
<span class="lineNum">    1565 </span>            :                }   
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :                nstart += ncount;</span>
<span class="lineNum">    1567 </span>            :             } else {
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :                if (cbase &amp;&amp; fNrunsPerMaster&lt;2) {</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :                   cadd = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;__tmp%d__%s\&quot;, 1000000);&quot;,stage,file.Data()));</span>
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :                   printf(&quot;... please wait - TAlienCollection::Add() scales badly...\n&quot;);</span>
<span class="lineNum">    1571 </span>            :                  // cholm - Avoid using very slow TAlienCollection 
<span class="lineNum">    1572 </span>            :                  // cbase-&gt;Add(cadd);
<span class="lineNum">    1573 </span>            :                  // cholm - Use AddFast (via interpreter)
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :                  gROOT-&gt;ProcessLine(Form(&quot;((TAlienCollection*)%p)-&gt;AddFast((TGridCollection*)%p)&quot;,cbase,cadd));</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :                   delete cadd;</span>
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :                   cbase-&gt;ExportXML(Form(&quot;file://%s&quot;, file.Data()),kFALSE,kFALSE, file, &quot;Merged entries for a run&quot;);</span>
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :                   delete cbase; cbase = 0;               </span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :                } else {</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :                   TFile::Cp(Form(&quot;__tmp%d__%s&quot;,stage, file.Data()), file.Data());</span>
<span class="lineNum">    1580 </span>            :                }
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :                Info(&quot;CreateDataset&quot;, &quot;Created dataset %s with %d files&quot;, file.Data(), nstart+ncount);</span>
<span class="lineNum">    1582 </span>            :                break;
<span class="lineNum">    1583 </span>            :             }
<span class="lineNum">    1584 </span>            :          }   
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :          if (TestBit(AliAnalysisGrid::kTest)) break;</span>
<span class="lineNum">    1586 </span>            :          // Check if there is one run per master job.
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :          if (fNrunsPerMaster&lt;2) {</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :             if (FileExists(file)) {</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :                if (fOverwriteMode) gGrid-&gt;Rm(file);</span>
<span class="lineNum">    1590 </span>            :                else {
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :                   Info(&quot;CreateDataset&quot;, &quot;\n#####   Dataset %s exist. Skipping creation...&quot;, file.Data());</span>
<span class="lineNum">    1592 </span>            :                   continue;
<span class="lineNum">    1593 </span>            :                }   
<span class="lineNum">    1594 </span>            :             }        
<span class="lineNum">    1595 </span>            :             // Copy xml file to alien space
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :             TFile::Cp(Form(&quot;file:%s&quot;,file.Data()), Form(&quot;alien://%s/%s&quot;,workdir.Data(), file.Data()));</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :             if (!FileExists(file)) {</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :                Error(&quot;CreateDataset&quot;, &quot;Command %s did NOT succeed&quot;, command.Data());</span>
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :                return kFALSE;</span>
<span class="lineNum">    1600 </span>            :             }
<span class="lineNum">    1601 </span>            :          } else {
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :             nruns++;</span>
<span class="lineNum">    1603 </span>            :             // Check if the collection for the chunk exist locally.
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :             Int_t nchunk = (nruns-1)/fNrunsPerMaster;</span>
<span class="lineNum">    1605 </span><span class="lineNoCov">          0 :             if (FileExists(fInputFiles-&gt;At(nchunk)-&gt;GetName())) {</span>
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :                if (fOverwriteMode) gGrid-&gt;Rm(fInputFiles-&gt;At(nchunk)-&gt;GetName());</span>
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :                else continue;</span>
<span class="lineNum">    1608 </span>            :             }   
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :             printf(&quot;   Merging collection &lt;%s&gt; into %d runs chunk...\n&quot;,file.Data(),fNrunsPerMaster);</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :             if (((nruns-1)%fNrunsPerMaster) == 0) {</span>
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 :                schunk = Form(fRunPrefix.Data(), irun);</span>
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :                cbase = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;%s\&quot;, 1000000);&quot;,file.Data()));</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :             } else {</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :                cadd = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;new TAlienCollection(\&quot;%s\&quot;, 1000000);&quot;,file.Data()));</span>
<span class="lineNum">    1615 </span>            :                // cholm - Avoid using very slow TAlienCollection 
<span class="lineNum">    1616 </span>            :                // cbase-&gt;Add(cadd);
<span class="lineNum">    1617 </span>            :                // cholm - Use AddFast (via interpreter)
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :                gROOT-&gt;ProcessLine(Form(&quot;((TAlienCollection*)%p)-&gt;AddFast((TGridCollection*)%p)&quot;,cbase,cadd));</span>
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :                delete cadd;</span>
<span class="lineNum">    1620 </span>            :             }
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :             format = Form(&quot;%%s_%s.xml&quot;, fRunPrefix.Data());</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :             schunk2 = Form(format.Data(), schunk.Data(), irun);</span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :             if ((nruns%fNrunsPerMaster)!=0 &amp;&amp; irun!=fRunRange[1] &amp;&amp; schunk2 != fInputFiles-&gt;Last()-&gt;GetName()) {</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :                continue;</span>
<span class="lineNum">    1625 </span>            :             }   
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :             schunk = schunk2;</span>
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :             if (FileExists(schunk)) {</span>
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :                if (fOverwriteMode) gGrid-&gt;Rm(schunk);</span>
<span class="lineNum">    1629 </span>            :                else {
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :                   Info(&quot;CreateDataset&quot;, &quot;\n#####   Dataset %s exist. Skipping creation...&quot;, schunk.Data());</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 :                   continue;</span>
<span class="lineNum">    1632 </span>            :                }   
<span class="lineNum">    1633 </span>            :             }        
<span class="lineNum">    1634 </span><span class="lineNoCov">          0 :             printf(&quot;Exporting merged collection &lt;%s&gt; and copying to AliEn.\n&quot;, schunk.Data());</span>
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :             cbase-&gt;ExportXML(Form(&quot;file://%s&quot;, schunk.Data()),kFALSE,kFALSE, schunk, &quot;Merged runs&quot;);</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :             if (FileExists(schunk)) {</span>
<span class="lineNum">    1637 </span><span class="lineNoCov">          0 :                if (fOverwriteMode) gGrid-&gt;Rm(schunk);</span>
<span class="lineNum">    1638 </span>            :                else {
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :                   Info(&quot;CreateDataset&quot;, &quot;\n#####   Dataset %s exist. Skipping copy...&quot;, schunk.Data());</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :                   continue;</span>
<span class="lineNum">    1641 </span>            :                }   
<span class="lineNum">    1642 </span>            :             }   
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :             TFile::Cp(Form(&quot;file:%s&quot;,schunk.Data()), Form(&quot;alien://%s/%s&quot;,workdir.Data(), schunk.Data()));</span>
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :             if (!FileExists(schunk)) {</span>
<span class="lineNum">    1645 </span><span class="lineNoCov">          0 :                Error(&quot;CreateDataset&quot;, &quot;Copy command did NOT succeed for %s&quot;, schunk.Data());</span>
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :                return kFALSE;</span>
<span class="lineNum">    1647 </span>            :             }
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :          }   </span>
<span class="lineNum">    1649 </span>            :       }
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :       if (nullResult) {</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :          Error(&quot;CreateDataset&quot;, &quot;No valid dataset corresponding to the query!&quot;);</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    1653 </span>            :       }      
<span class="lineNum">    1654 </span>            :    }      
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 : }</span>
<a name="1657"><span class="lineNum">    1657 </span>            : </a>
<span class="lineNum">    1658 </span>            : //______________________________________________________________________________
<span class="lineNum">    1659 </span>            : Bool_t AliAnalysisAlien::CreateJDL()
<span class="lineNum">    1660 </span>            : {
<span class="lineNum">    1661 </span>            : // Generate a JDL file according to current settings. The name of the file is 
<span class="lineNum">    1662 </span>            : // specified by fJDLName.
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">    1664 </span>            :    Bool_t error = kFALSE;
<span class="lineNum">    1665 </span>            :    TObjArray *arr = 0;
<span class="lineNum">    1666 </span>            :    Bool_t copy = kTRUE;
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :    if (fProductionMode || TestBit(AliAnalysisGrid::kOffline) || TestBit(AliAnalysisGrid::kTest)) copy = kFALSE;</span>
<span class="lineNum">    1668 </span>            :    Bool_t generate = kTRUE;
<span class="lineNum">    1669 </span><span class="lineNoCov">          0 :    if (TestBit(AliAnalysisGrid::kTest) || TestBit(AliAnalysisGrid::kSubmit)) generate = kFALSE;</span>
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :    if (!Connect()) {</span>
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :       Error(&quot;CreateJDL&quot;, &quot;Alien connection required&quot;);</span>
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    1673 </span>            :    }   
<span class="lineNum">    1674 </span>            :    // Check validity of alien workspace
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :    TString workdir;</span>
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :    if (!fProductionMode &amp;&amp; !fGridWorkingDir.BeginsWith(&quot;/alice&quot;)) workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :    if (!fProductionMode &amp;&amp;  !TestBit(AliAnalysisGrid::kTest)) CdWork();</span>
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 :    workdir += fGridWorkingDir;</span>
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :    if (generate) {</span>
<span class="lineNum">    1680 </span>            :       TObjString *os;
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 :       if (!fInputFiles &amp;&amp; !fMCLoop) {</span>
<span class="lineNum">    1682 </span><span class="lineNoCov">          0 :          Error(&quot;CreateJDL()&quot;, &quot;Define some input files for your analysis.&quot;);</span>
<span class="lineNum">    1683 </span>            :          error = kTRUE;
<span class="lineNum">    1684 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1685 </span>            :       // Compose list of input files   
<span class="lineNum">    1686 </span>            :       // Check if output files were defined
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 :       if (!fOutputFiles.Length()) {</span>
<span class="lineNum">    1688 </span><span class="lineNoCov">          0 :          Error(&quot;CreateJDL&quot;, &quot;You must define at least one output file&quot;);</span>
<span class="lineNum">    1689 </span>            :          error = kTRUE;
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    1691 </span>            :       // Check if an output directory was defined and valid
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :       if (!fGridOutputDir.Length()) {</span>
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :          Error(&quot;CreateJDL&quot;, &quot;You must define AliEn output directory&quot;);</span>
<span class="lineNum">    1694 </span>            :          error = kTRUE;
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :       } else {</span>
<span class="lineNum">    1696 </span><span class="lineNoCov">          0 :          if (!fProductionMode) {</span>
<span class="lineNum">    1697 </span><span class="lineNoCov">          0 :             if (!fGridOutputDir.Contains(&quot;/&quot;)) fGridOutputDir = Form(&quot;%s/%s&quot;, workdir.Data(), fGridOutputDir.Data());</span>
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :             if (!DirectoryExists(fGridOutputDir)) {</span>
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :                if (gGrid-&gt;Mkdir(fGridOutputDir,&quot;-p&quot;)) {</span>
<span class="lineNum">    1700 </span><span class="lineNoCov">          0 :                   Info(&quot;CreateJDL&quot;, &quot;\n#####   Created alien output directory %s&quot;, fGridOutputDir.Data());</span>
<span class="lineNum">    1701 </span>            :                } else {
<span class="lineNum">    1702 </span><span class="lineNoCov">          0 :                   Error(&quot;CreateJDL&quot;, &quot;Could not create alien output directory %s&quot;, fGridOutputDir.Data());</span>
<span class="lineNum">    1703 </span>            :                   // error = kTRUE;
<span class="lineNum">    1704 </span>            :                }
<span class="lineNum">    1705 </span>            :             } else {
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :                Warning(&quot;CreateJDL&quot;, &quot;#### Output directory %s exists! If this contains old data, jobs will fail with ERROR_SV !!! ###&quot;, fGridOutputDir.Data());</span>
<span class="lineNum">    1707 </span>            :             }   
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :             gGrid-&gt;Cd(workdir);</span>
<span class="lineNum">    1709 </span>            :          }   
<span class="lineNum">    1710 </span>            :       }   
<span class="lineNum">    1711 </span>            :       // Exit if any error up to now
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :       if (error) return kFALSE;   </span>
<span class="lineNum">    1713 </span>            :       // Set JDL fields
<span class="lineNum">    1714 </span><span class="lineNoCov">          0 :       if (!fUser.IsNull()) {</span>
<span class="lineNum">    1715 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetValue(&quot;User&quot;, Form(&quot;\&quot;%s\&quot;&quot;, fUser.Data()));</span>
<span class="lineNum">    1716 </span><span class="lineNoCov">          0 :          fMergingJDL-&gt;SetValue(&quot;User&quot;, Form(&quot;\&quot;%s\&quot;&quot;, fUser.Data()));</span>
<span class="lineNum">    1717 </span>            :       }
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :       TString executable = fExecutable;</span>
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 :       if (!executable.BeginsWith(&quot;/&quot;)) </span>
<span class="lineNum">    1720 </span><span class="lineNoCov">          0 :          executable.Prepend(Form(&quot;%s/&quot;, workdir.Data()));</span>
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :       fGridJDL-&gt;SetExecutable(executable, &quot;This is the startup script&quot;);</span>
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 :       TString mergeExec = executable;</span>
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :       mergeExec.ReplaceAll(&quot;.sh&quot;, &quot;_merge.sh&quot;);</span>
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;SetExecutable(mergeExec, &quot;This is the startup script&quot;);</span>
<span class="lineNum">    1725 </span><span class="lineNoCov">          0 :       mergeExec.ReplaceAll(&quot;.sh&quot;, &quot;.C&quot;);</span>
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;AddToInputSandbox(Form(&quot;LF:%s&quot;, mergeExec.Data()), &quot;List of input files to be uploaded to workers&quot;);</span>
<span class="lineNum">    1727 </span><span class="lineNoCov">          0 :       if (!fArguments.IsNull())</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetArguments(fArguments, &quot;Arguments for the executable command&quot;);</span>
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 :       if (IsOneStageMerging()) fMergingJDL-&gt;SetArguments(fGridOutputDir);</span>
<span class="lineNum">    1730 </span>            :       else {
<span class="lineNum">    1731 </span><span class="lineNoCov">          0 :          if (fProductionMode)  fMergingJDL-&gt;SetArguments(&quot;wn.xml $4&quot;);    // xml, stage</span>
<span class="lineNum">    1732 </span><span class="lineNoCov">          0 :          else                  fMergingJDL-&gt;SetArguments(&quot;wn.xml $2&quot;);    // xml, stage</span>
<span class="lineNum">    1733 </span>            :      }               
<span class="lineNum">    1734 </span>            : 
<span class="lineNum">    1735 </span><span class="lineNoCov">          0 :       fGridJDL-&gt;SetValue(&quot;TTL&quot;, Form(&quot;\&quot;%d\&quot;&quot;,fTTL));</span>
<span class="lineNum">    1736 </span><span class="lineNoCov">          0 :       fGridJDL-&gt;SetDescription(&quot;TTL&quot;, Form(&quot;Time after which the job is killed (%d min.)&quot;, fTTL/60));</span>
<span class="lineNum">    1737 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;SetValue(&quot;TTL&quot;, Form(&quot;\&quot;%d\&quot;&quot;,fTTL));</span>
<span class="lineNum">    1738 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;SetDescription(&quot;TTL&quot;, Form(&quot;Time after which the job is killed (%d min.)&quot;, fTTL/60));</span>
<span class="lineNum">    1739 </span>            :         
<span class="lineNum">    1740 </span><span class="lineNoCov">          0 :       if (fMaxInitFailed &gt; 0) {</span>
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetValue(&quot;MaxInitFailed&quot;, Form(&quot;\&quot;%d\&quot;&quot;,fMaxInitFailed));</span>
<span class="lineNum">    1742 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetDescription(&quot;MaxInitFailed&quot;, &quot;Maximum number of first failing jobs to abort the master job&quot;);</span>
<span class="lineNum">    1743 </span>            :       }   
<span class="lineNum">    1744 </span><span class="lineNoCov">          0 :       if (fSplitMaxInputFileNumber &gt; 0 &amp;&amp; !fMCLoop) {</span>
<span class="lineNum">    1745 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetValue(&quot;SplitMaxInputFileNumber&quot;, Form(&quot;\&quot;%d\&quot;&quot;, fSplitMaxInputFileNumber));</span>
<span class="lineNum">    1746 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetDescription(&quot;SplitMaxInputFileNumber&quot;, &quot;Maximum number of input files to be processed per subjob&quot;);</span>
<span class="lineNum">    1747 </span>            :       }
<span class="lineNum">    1748 </span><span class="lineNoCov">          0 :       if (!IsOneStageMerging()) {</span>
<span class="lineNum">    1749 </span><span class="lineNoCov">          0 :          fMergingJDL-&gt;SetValue(&quot;SplitMaxInputFileNumber&quot;, Form(&quot;\&quot;%d\&quot;&quot;,fMaxMergeFiles));</span>
<span class="lineNum">    1750 </span><span class="lineNoCov">          0 :          fMergingJDL-&gt;SetDescription(&quot;SplitMaxInputFileNumber&quot;, &quot;Maximum number of input files to be merged in one go&quot;);</span>
<span class="lineNum">    1751 </span>            :       }   
<span class="lineNum">    1752 </span><span class="lineNoCov">          0 :       if (fSplitMode.Length()) {</span>
<span class="lineNum">    1753 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetValue(&quot;Split&quot;, Form(&quot;\&quot;%s\&quot;&quot;, fSplitMode.Data()));</span>
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetDescription(&quot;Split&quot;, &quot;We split per SE or file&quot;);</span>
<span class="lineNum">    1755 </span>            :       }
<span class="lineNum">    1756 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;SetValue(&quot;Split&quot;, &quot;\&quot;se\&quot;&quot;); </span>
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;SetDescription(&quot;Split&quot;, &quot;We split per SE for merging in stages&quot;);</span>
<span class="lineNum">    1758 </span><span class="lineNoCov">          0 :       if (!fAliROOTVersion.IsNull()) {</span>
<span class="lineNum">    1759 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;AddToPackages(&quot;AliRoot&quot;, fAliROOTVersion,&quot;VO_ALICE&quot;, &quot;List of requested packages&quot;);</span>
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :          fMergingJDL-&gt;AddToPackages(&quot;AliRoot&quot;, fAliROOTVersion, &quot;VO_ALICE&quot;, &quot;List of requested packages&quot;);</span>
<span class="lineNum">    1761 </span>            :       }   
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :       if (!fAliPhysicsVersion.IsNull()) {</span>
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;AddToPackages(&quot;AliPhysics&quot;, fAliPhysicsVersion,&quot;VO_ALICE&quot;, &quot;List of requested packages&quot;);</span>
<span class="lineNum">    1764 </span><span class="lineNoCov">          0 :          fMergingJDL-&gt;AddToPackages(&quot;AliPhysics&quot;, fAliPhysicsVersion, &quot;VO_ALICE&quot;, &quot;List of requested packages&quot;);</span>
<span class="lineNum">    1765 </span>            :       }   
<span class="lineNum">    1766 </span><span class="lineNoCov">          0 :       if (!fROOTVersion.IsNull()) {</span>
<span class="lineNum">    1767 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;AddToPackages(&quot;ROOT&quot;, fROOTVersion);</span>
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :          fMergingJDL-&gt;AddToPackages(&quot;ROOT&quot;, fROOTVersion);</span>
<span class="lineNum">    1769 </span>            :       }   
<span class="lineNum">    1770 </span><span class="lineNoCov">          0 :       if (!fAPIVersion.IsNull()) {</span>
<span class="lineNum">    1771 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;AddToPackages(&quot;APISCONFIG&quot;, fAPIVersion);</span>
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :          fMergingJDL-&gt;AddToPackages(&quot;APISCONFIG&quot;, fAPIVersion);</span>
<span class="lineNum">    1773 </span>            :       }   
<span class="lineNum">    1774 </span><span class="lineNoCov">          0 :       if (!fExternalPackages.IsNull()) {</span>
<span class="lineNum">    1775 </span><span class="lineNoCov">          0 :          arr = fExternalPackages.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :          TIter next(arr);</span>
<span class="lineNum">    1777 </span><span class="lineNoCov">          0 :          while ((os=(TObjString*)next())) {</span>
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :             TString pkgname = os-&gt;GetString();</span>
<span class="lineNum">    1779 </span><span class="lineNoCov">          0 :             Int_t index = pkgname.Index(&quot;::&quot;);</span>
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :             TString pkgversion = pkgname(index+2, pkgname.Length());</span>
<span class="lineNum">    1781 </span><span class="lineNoCov">          0 :             pkgname.Remove(index);</span>
<span class="lineNum">    1782 </span><span class="lineNoCov">          0 :             fGridJDL-&gt;AddToPackages(pkgname, pkgversion);</span>
<span class="lineNum">    1783 </span><span class="lineNoCov">          0 :             fMergingJDL-&gt;AddToPackages(pkgname, pkgversion);</span>
<span class="lineNum">    1784 </span><span class="lineNoCov">          0 :          }   </span>
<span class="lineNum">    1785 </span><span class="lineNoCov">          0 :          delete arr;   </span>
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    1787 </span><span class="lineNoCov">          0 :       if (!fMCLoop) {</span>
<span class="lineNum">    1788 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetInputDataListFormat(fInputFormat, &quot;Format of input data&quot;);</span>
<span class="lineNum">    1789 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetInputDataList(&quot;wn.xml&quot;, &quot;Collection name to be processed on each worker node&quot;);</span>
<span class="lineNum">    1790 </span>            :       }   
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;SetInputDataListFormat(fInputFormat, &quot;Format of input data&quot;);</span>
<span class="lineNum">    1792 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;SetInputDataList(&quot;wn.xml&quot;, &quot;Collection name to be processed on each worker node&quot;);</span>
<span class="lineNum">    1793 </span><span class="lineNoCov">          0 :       fGridJDL-&gt;AddToInputSandbox(Form(&quot;LF:%s/%s&quot;, workdir.Data(), fAnalysisMacro.Data()), &quot;List of input files to be uploaded to workers&quot;);</span>
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :       TString analysisFile = fExecutable;</span>
<span class="lineNum">    1795 </span><span class="lineNoCov">          0 :       analysisFile.ReplaceAll(&quot;.sh&quot;, &quot;.root&quot;);</span>
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :       fGridJDL-&gt;AddToInputSandbox(Form(&quot;LF:%s/%s&quot;, workdir.Data(),analysisFile.Data()));</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;AddToInputSandbox(Form(&quot;LF:%s/%s&quot;, workdir.Data(),analysisFile.Data()));</span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :       if (fAdditionalLibs.Length()) {</span>
<span class="lineNum">    1799 </span><span class="lineNoCov">          0 :          arr = fAdditionalLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    1800 </span><span class="lineNoCov">          0 :          TIter next(arr);</span>
<span class="lineNum">    1801 </span><span class="lineNoCov">          0 :          while ((os=(TObjString*)next())) {</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :             if (os-&gt;GetString().Contains(&quot;.so&quot;) ||</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 :                 os-&gt;GetString().Contains(&quot;.dylib&quot;)) continue;</span>
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :             fGridJDL-&gt;AddToInputSandbox(Form(&quot;LF:%s/%s&quot;, workdir.Data(), os-&gt;GetString().Data()));</span>
<span class="lineNum">    1805 </span><span class="lineNoCov">          0 :             fMergingJDL-&gt;AddToInputSandbox(Form(&quot;LF:%s/%s&quot;, workdir.Data(), os-&gt;GetString().Data()));</span>
<span class="lineNum">    1806 </span>            :          }   
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 :          delete arr;   </span>
<span class="lineNum">    1808 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1809 </span><span class="lineNoCov">          0 :       if (fPackages) {</span>
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :          TIter next(fPackages);</span>
<span class="lineNum">    1811 </span>            :          TObject *obj;
<span class="lineNum">    1812 </span><span class="lineNoCov">          0 :          while ((obj=next())) {</span>
<span class="lineNum">    1813 </span><span class="lineNoCov">          0 :             fGridJDL-&gt;AddToInputSandbox(Form(&quot;LF:%s/%s&quot;, workdir.Data(), obj-&gt;GetName()));</span>
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :             fMergingJDL-&gt;AddToInputSandbox(Form(&quot;LF:%s/%s&quot;, workdir.Data(), obj-&gt;GetName()));</span>
<span class="lineNum">    1815 </span>            :          }
<span class="lineNum">    1816 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1817 </span>            :       const char *comment = &quot;List of output files and archives&quot;;
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :       if (fOutputArchive.Length()) {</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :          TString outputArchive = fOutputArchive;</span>
<span class="lineNum">    1820 </span><span class="lineNoCov">          0 :          if (!fRegisterExcludes.IsNull()) {</span>
<span class="lineNum">    1821 </span><span class="lineNoCov">          0 :             arr = fRegisterExcludes.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    1822 </span><span class="lineNoCov">          0 :             TIter next1(arr);</span>
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :             while ((os=(TObjString*)next1())) {</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :                outputArchive.ReplaceAll(Form(&quot;%s,&quot;,os-&gt;GetString().Data()),&quot;&quot;);</span>
<span class="lineNum">    1825 </span><span class="lineNoCov">          0 :                outputArchive.ReplaceAll(os-&gt;GetString(),&quot;&quot;);</span>
<span class="lineNum">    1826 </span>            :             } 
<span class="lineNum">    1827 </span><span class="lineNoCov">          0 :             delete arr;</span>
<span class="lineNum">    1828 </span><span class="lineNoCov">          0 :          }     </span>
<span class="lineNum">    1829 </span><span class="lineNoCov">          0 :          arr = outputArchive.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :          TIter next(arr);</span>
<span class="lineNum">    1831 </span>            :          Bool_t first = kTRUE;
<span class="lineNum">    1832 </span><span class="lineNoCov">          0 :          while ((os=(TObjString*)next())) {</span>
<span class="lineNum">    1833 </span><span class="lineNoCov">          0 :             if (!os-&gt;GetString().Contains(&quot;@&quot;) &amp;&amp; fCloseSE.Length())</span>
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :                fGridJDL-&gt;AddToSet(&quot;Output&quot;, Form(&quot;%s@%s&quot;,os-&gt;GetString().Data(), fCloseSE.Data()));</span>
<span class="lineNum">    1835 </span>            :             else
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :                fGridJDL-&gt;AddToSet(&quot;Output&quot;, os-&gt;GetString());</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :             if (first) fGridJDL-&gt;AddToSetDescription(&quot;Output&quot;, comment);</span>
<span class="lineNum">    1838 </span>            :             first = kFALSE;   
<span class="lineNum">    1839 </span>            :          }      
<span class="lineNum">    1840 </span><span class="lineNoCov">          0 :          delete arr;</span>
<span class="lineNum">    1841 </span>            :          // Output archive for the merging jdl
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :          if (TestBit(AliAnalysisGrid::kDefaultOutputs)) {</span>
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 :             outputArchive = &quot;log_archive.zip:std*@disk=1 &quot;;</span>
<span class="lineNum">    1844 </span>            :             // Add normal output files, extra files + terminate files
<span class="lineNum">    1845 </span><span class="lineNoCov">          0 :             TString files;</span>
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :             if (IsMergeAOD()) files = GetListOfFiles(&quot;outaodextter&quot;);</span>
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 :             else files = GetListOfFiles(&quot;outextter&quot;);</span>
<span class="lineNum">    1848 </span>            :             // Do not register files in fRegisterExcludes
<span class="lineNum">    1849 </span><span class="lineNoCov">          0 :             if (!fRegisterExcludes.IsNull()) {</span>
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :                arr = fRegisterExcludes.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :                TIter next1(arr);</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :                while ((os=(TObjString*)next1())) {</span>
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :                   files.ReplaceAll(Form(&quot;%s,&quot;,os-&gt;GetString().Data()),&quot;&quot;);</span>
<span class="lineNum">    1854 </span><span class="lineNoCov">          0 :                   files.ReplaceAll(os-&gt;GetString(),&quot;&quot;);</span>
<span class="lineNum">    1855 </span>            :                }   
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :                delete arr;</span>
<span class="lineNum">    1857 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1858 </span><span class="lineNoCov">          0 :             files.ReplaceAll(&quot;.root&quot;, &quot;*.root&quot;);</span>
<span class="lineNum">    1859 </span>            :             
<span class="lineNum">    1860 </span><span class="lineNoCov">          0 :             if (mgr-&gt;IsCollectThroughput())</span>
<span class="lineNum">    1861 </span><span class="lineNoCov">          0 :                outputArchive += Form(&quot;root_archive.zip:%s,*.stat@disk=%d %s@disk=%d&quot;,files.Data(),fNreplicas, mgr-&gt;GetFileInfoLog(),fNreplicas);</span>
<span class="lineNum">    1862 </span>            :             else
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :                outputArchive += Form(&quot;root_archive.zip:%s,*.stat@disk=%d&quot;,files.Data(),fNreplicas);</span>
<span class="lineNum">    1864 </span><span class="lineNoCov">          0 :          } else {</span>
<span class="lineNum">    1865 </span><span class="lineNoCov">          0 :             TString files = fOutputArchive;</span>
<span class="lineNum">    1866 </span><span class="lineNoCov">          0 :             files.ReplaceAll(&quot;.root&quot;, &quot;*.root&quot;); // nreplicas etc should be already atttached by use</span>
<span class="lineNum">    1867 </span><span class="lineNoCov">          0 :             outputArchive = files;</span>
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :          }   </span>
<span class="lineNum">    1869 </span><span class="lineNoCov">          0 :          arr = outputArchive.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    1870 </span><span class="lineNoCov">          0 :          TIter next2(arr);</span>
<span class="lineNum">    1871 </span>            :          first = kTRUE;
<span class="lineNum">    1872 </span><span class="lineNoCov">          0 :          while ((os=(TObjString*)next2())) {</span>
<span class="lineNum">    1873 </span><span class="lineNoCov">          0 :             TString currentfile = os-&gt;GetString();</span>
<span class="lineNum">    1874 </span><span class="lineNoCov">          0 :             if (!currentfile.Contains(&quot;@&quot;) &amp;&amp; fCloseSE.Length())</span>
<span class="lineNum">    1875 </span><span class="lineNoCov">          0 :                fMergingJDL-&gt;AddToSet(&quot;Output&quot;, Form(&quot;%s@%s&quot;,currentfile.Data(), fCloseSE.Data()));</span>
<span class="lineNum">    1876 </span>            :             else
<span class="lineNum">    1877 </span><span class="lineNoCov">          0 :                fMergingJDL-&gt;AddToSet(&quot;Output&quot;, currentfile);</span>
<span class="lineNum">    1878 </span><span class="lineNoCov">          0 :             if (first) fMergingJDL-&gt;AddToSetDescription(&quot;Output&quot;, comment);</span>
<span class="lineNum">    1879 </span>            :             first = kFALSE;   
<span class="lineNum">    1880 </span><span class="lineNoCov">          0 :          }      </span>
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 :          delete arr;         </span>
<span class="lineNum">    1882 </span><span class="lineNoCov">          0 :       }      </span>
<span class="lineNum">    1883 </span><span class="lineNoCov">          0 :       arr = fOutputFiles.Tokenize(&quot;,&quot;);</span>
<span class="lineNum">    1884 </span><span class="lineNoCov">          0 :       TIter next(arr);</span>
<span class="lineNum">    1885 </span>            :       Bool_t first = kTRUE;
<span class="lineNum">    1886 </span><span class="lineNoCov">          0 :       while ((os=(TObjString*)next())) {</span>
<span class="lineNum">    1887 </span>            :          // Ignore ouputs in jdl that are also in outputarchive
<span class="lineNum">    1888 </span><span class="lineNoCov">          0 :          TString sout = os-&gt;GetString();</span>
<span class="lineNum">    1889 </span><span class="lineNoCov">          0 :          sout.ReplaceAll(&quot;*&quot;, &quot;&quot;);</span>
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :          sout.ReplaceAll(&quot;.root&quot;, &quot;&quot;);</span>
<span class="lineNum">    1891 </span><span class="lineNoCov">          0 :          if (sout.Index(&quot;@&quot;)&gt;0) sout.Remove(sout.Index(&quot;@&quot;));</span>
<span class="lineNum">    1892 </span><span class="lineNoCov">          0 :          if (fOutputArchive.Contains(sout)) continue;</span>
<span class="lineNum">    1893 </span>            :          // Ignore fRegisterExcludes
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :          if (fRegisterExcludes.Contains(sout)) continue;</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :          if (!first) comment = NULL;</span>
<span class="lineNum">    1896 </span><span class="lineNoCov">          0 :          if (!os-&gt;GetString().Contains(&quot;@&quot;) &amp;&amp; fCloseSE.Length())</span>
<span class="lineNum">    1897 </span><span class="lineNoCov">          0 :             fGridJDL-&gt;AddToSet(&quot;Output&quot;, Form(&quot;%s@%s&quot;,os-&gt;GetString().Data(), fCloseSE.Data())); </span>
<span class="lineNum">    1898 </span>            :          else
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :             fGridJDL-&gt;AddToSet(&quot;Output&quot;, os-&gt;GetString());</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :          if (first) fGridJDL-&gt;AddToSetDescription(&quot;Output&quot;, comment); </span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :          if (fMergeExcludes.Contains(sout)) continue;   </span>
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :          if (!os-&gt;GetString().Contains(&quot;@&quot;) &amp;&amp; fCloseSE.Length())</span>
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :             fMergingJDL-&gt;AddToSet(&quot;Output&quot;, Form(&quot;%s@%s&quot;,os-&gt;GetString().Data(), fCloseSE.Data())); </span>
<span class="lineNum">    1904 </span>            :          else
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :             fMergingJDL-&gt;AddToSet(&quot;Output&quot;, os-&gt;GetString());</span>
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :          if (first) fMergingJDL-&gt;AddToSetDescription(&quot;Output&quot;, comment);</span>
<span class="lineNum">    1907 </span>            :          first = kFALSE;
<span class="lineNum">    1908 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    1909 </span><span class="lineNoCov">          0 :       delete arr;</span>
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :       fGridJDL-&gt;SetPrice((UInt_t)fPrice, &quot;AliEn price for this job&quot;);</span>
<span class="lineNum">    1911 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;SetPrice((UInt_t)fPrice, &quot;AliEn price for this job&quot;);</span>
<span class="lineNum">    1912 </span><span class="lineNoCov">          0 :       TString validationScript = fValidationScript;</span>
<span class="lineNum">    1913 </span><span class="lineNoCov">          0 :       fGridJDL-&gt;SetValidationCommand(Form(&quot;%s/%s&quot;, workdir.Data(),validationScript.Data()), &quot;Validation script to be run for each subjob&quot;);</span>
<span class="lineNum">    1914 </span><span class="lineNoCov">          0 :       validationScript.ReplaceAll(&quot;.sh&quot;, &quot;_merge.sh&quot;);</span>
<span class="lineNum">    1915 </span><span class="lineNoCov">          0 :       fMergingJDL-&gt;SetValidationCommand(Form(&quot;%s/%s&quot;, workdir.Data(),validationScript.Data()), &quot;Validation script to be run for each subjob&quot;);</span>
<span class="lineNum">    1916 </span><span class="lineNoCov">          0 :       if (fMasterResubmitThreshold) {</span>
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetValue(&quot;MasterResubmitThreshold&quot;, Form(&quot;\&quot;%d%%\&quot;&quot;, fMasterResubmitThreshold));</span>
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetDescription(&quot;MasterResubmitThreshold&quot;, &quot;Resubmit failed jobs until DONE rate reaches this percentage&quot;);</span>
<span class="lineNum">    1919 </span>            :       }   
<span class="lineNum">    1920 </span>            :       // Write a jdl with 2 input parameters: collection name and output dir name.
<span class="lineNum">    1921 </span><span class="lineNoCov">          0 :       WriteJDL(copy);</span>
<span class="lineNum">    1922 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    1923 </span>            :    // Copy jdl to grid workspace   
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :    if (copy) {</span>
<span class="lineNum">    1925 </span>            :       // Check if an output directory was defined and valid
<span class="lineNum">    1926 </span><span class="lineNoCov">          0 :       if (!fGridOutputDir.Length()) {</span>
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :          Error(&quot;CreateJDL&quot;, &quot;You must define AliEn output directory&quot;);</span>
<span class="lineNum">    1928 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    1929 </span>            :       } else {
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :          if (!fGridOutputDir.Contains(&quot;/&quot;)) fGridOutputDir = Form(&quot;%s/%s&quot;, workdir.Data(), fGridOutputDir.Data());</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :          if (!fProductionMode &amp;&amp; !DirectoryExists(fGridOutputDir)) {</span>
<span class="lineNum">    1932 </span><span class="lineNoCov">          0 :             if (gGrid-&gt;Mkdir(fGridOutputDir,&quot;-p&quot;)) {</span>
<span class="lineNum">    1933 </span><span class="lineNoCov">          0 :                Info(&quot;CreateJDL&quot;, &quot;\n#####   Created alien output directory %s&quot;, fGridOutputDir.Data());</span>
<span class="lineNum">    1934 </span>            :             } else {
<span class="lineNum">    1935 </span><span class="lineNoCov">          0 :                Error(&quot;CreateJDL&quot;, &quot;Could not create alien output directory %s&quot;, fGridOutputDir.Data());</span>
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 :                return kFALSE;</span>
<span class="lineNum">    1937 </span>            :             }
<span class="lineNum">    1938 </span>            :          }
<span class="lineNum">    1939 </span><span class="lineNoCov">          0 :          gGrid-&gt;Cd(workdir);</span>
<span class="lineNum">    1940 </span>            :       }   
<span class="lineNum">    1941 </span><span class="lineNoCov">          0 :       if (TestBit(AliAnalysisGrid::kSubmit)) {</span>
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :          TString mergeJDLName = fExecutable;</span>
<span class="lineNum">    1943 </span><span class="lineNoCov">          0 :          mergeJDLName.ReplaceAll(&quot;.sh&quot;, &quot;_merge.jdl&quot;);</span>
<span class="lineNum">    1944 </span><span class="lineNoCov">          0 :          TString locjdl = Form(&quot;%s/%s&quot;, fGridOutputDir.Data(),fJDLName.Data());</span>
<span class="lineNum">    1945 </span><span class="lineNoCov">          0 :          TString locjdl1 = Form(&quot;%s/%s&quot;, fGridOutputDir.Data(),mergeJDLName.Data());</span>
<span class="lineNum">    1946 </span><span class="lineNoCov">          0 :          if (fProductionMode) {</span>
<span class="lineNum">    1947 </span><span class="lineNoCov">          0 :             locjdl = Form(&quot;%s/%s&quot;, workdir.Data(),fJDLName.Data());</span>
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :             locjdl1 = Form(&quot;%s/%s&quot;, workdir.Data(),mergeJDLName.Data());</span>
<span class="lineNum">    1949 </span>            :          }   
<span class="lineNum">    1950 </span><span class="lineNoCov">          0 :          if (FileExists(locjdl)) gGrid-&gt;Rm(locjdl);</span>
<span class="lineNum">    1951 </span><span class="lineNoCov">          0 :          if (FileExists(locjdl1)) gGrid-&gt;Rm(locjdl1);</span>
<span class="lineNum">    1952 </span><span class="lineNoCov">          0 :          Info(&quot;CreateJDL&quot;, &quot;\n#####   Copying JDL file &lt;%s&gt; to your AliEn output directory&quot;, fJDLName.Data());</span>
<span class="lineNum">    1953 </span><span class="lineNoCov">          0 :          if (!copyLocal2Alien(&quot;CreateJDL&quot;, fJDLName, locjdl)) </span>
<span class="lineNum">    1954 </span><span class="lineNoCov">          0 :             Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    1955 </span>            : //         TFile::Cp(Form(&quot;file:%s&quot;,fJDLName.Data()), Form(&quot;alien://%s&quot;, locjdl.Data()));
<span class="lineNum">    1956 </span><span class="lineNoCov">          0 :          if (fMergeViaJDL) {</span>
<span class="lineNum">    1957 </span><span class="lineNoCov">          0 :             Info(&quot;CreateJDL&quot;, &quot;\n#####   Copying merging JDL file &lt;%s&gt; to your AliEn output directory&quot;, mergeJDLName.Data());</span>
<span class="lineNum">    1958 </span>            : //            TFile::Cp(Form(&quot;file:%s&quot;,mergeJDLName.Data()), Form(&quot;alien://%s&quot;, locjdl1.Data()));
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :             if (!copyLocal2Alien(&quot;CreateJDL&quot;, mergeJDLName.Data(), locjdl1)) </span>
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :                Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    1961 </span>            :          }   
<span class="lineNum">    1962 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1963 </span><span class="lineNoCov">          0 :       if (fAdditionalLibs.Length()) {</span>
<span class="lineNum">    1964 </span><span class="lineNoCov">          0 :          arr = fAdditionalLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    1965 </span>            :          TObjString *os;
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :          TIter next(arr);</span>
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 :          while ((os=(TObjString*)next())) {</span>
<span class="lineNum">    1968 </span><span class="lineNoCov">          0 :             if (os-&gt;GetString().Contains(&quot;.so&quot;) ||</span>
<span class="lineNum">    1969 </span><span class="lineNoCov">          0 :                 os-&gt;GetString().Contains(&quot;.dylib&quot;)) continue;</span>
<span class="lineNum">    1970 </span><span class="lineNoCov">          0 :             Info(&quot;CreateJDL&quot;, &quot;\n#####   Copying dependency: &lt;%s&gt; to your alien workspace&quot;, os-&gt;GetString().Data());</span>
<span class="lineNum">    1971 </span><span class="lineNoCov">          0 :             if (FileExists(os-&gt;GetString())) gGrid-&gt;Rm(os-&gt;GetString());</span>
<span class="lineNum">    1972 </span>            : //            TFile::Cp(Form(&quot;file:%s&quot;,os-&gt;GetString().Data()), Form(&quot;alien://%s/%s&quot;, workdir.Data(), os-&gt;GetString().Data()));
<span class="lineNum">    1973 </span><span class="lineNoCov">          0 :             if (!copyLocal2Alien(&quot;CreateJDL&quot;, os-&gt;GetString().Data(), </span>
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 :                 Form(&quot;%s/%s&quot;, workdir.Data(), os-&gt;GetString().Data())))</span>
<span class="lineNum">    1975 </span><span class="lineNoCov">          0 :               Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    1976 </span>            :          }   
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :          delete arr;   </span>
<span class="lineNum">    1978 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 :       if (fPackages) {</span>
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :          TIter next(fPackages);</span>
<span class="lineNum">    1981 </span>            :          TObject *obj;
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :          while ((obj=next())) {</span>
<span class="lineNum">    1983 </span><span class="lineNoCov">          0 :             if (FileExists(obj-&gt;GetName())) gGrid-&gt;Rm(obj-&gt;GetName());</span>
<span class="lineNum">    1984 </span><span class="lineNoCov">          0 :             Info(&quot;CreateJDL&quot;, &quot;\n#####   Copying dependency: &lt;%s&gt; to your alien workspace&quot;, obj-&gt;GetName());</span>
<span class="lineNum">    1985 </span>            : //            TFile::Cp(Form(&quot;file:%s&quot;,obj-&gt;GetName()), Form(&quot;alien://%s/%s&quot;, workdir.Data(), obj-&gt;GetName()));
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :             if (!copyLocal2Alien(&quot;CreateJDL&quot;,obj-&gt;GetName(), </span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :                 Form(&quot;%s/%s&quot;, workdir.Data(), obj-&gt;GetName()))) </span>
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :               Fatal(&quot;&quot;,&quot;Terminating&quot;); </span>
<span class="lineNum">    1989 </span>            :          }   
<span class="lineNum">    1990 </span><span class="lineNoCov">          0 :       }      </span>
<span class="lineNum">    1991 </span>            :    } 
<span class="lineNum">    1992 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    1993 </span><span class="lineNoCov">          0 : }</span>
<a name="1994"><span class="lineNum">    1994 </span>            : </a>
<span class="lineNum">    1995 </span>            : //______________________________________________________________________________
<span class="lineNum">    1996 </span>            : Bool_t AliAnalysisAlien::WriteJDL(Bool_t copy)
<span class="lineNum">    1997 </span>            : {
<span class="lineNum">    1998 </span>            : // Writes one or more JDL's corresponding to findex. If findex is negative,
<span class="lineNum">    1999 </span>            : // all run numbers are considered in one go (jdl). For non-negative indices
<span class="lineNum">    2000 </span>            : // they correspond to the indices in the array fInputFiles.
<span class="lineNum">    2001 </span><span class="lineNoCov">          0 :    if (!fInputFiles &amp;&amp; !fMCLoop) return kFALSE;</span>
<span class="lineNum">    2002 </span>            :    TObject *os;
<span class="lineNum">    2003 </span><span class="lineNoCov">          0 :    TString workdir;</span>
<span class="lineNum">    2004 </span><span class="lineNoCov">          0 :    if (!fProductionMode &amp;&amp; !fGridWorkingDir.BeginsWith(&quot;/alice&quot;)) workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    2005 </span><span class="lineNoCov">          0 :    workdir += fGridWorkingDir;</span>
<span class="lineNum">    2006 </span><span class="lineNoCov">          0 :    TString stageName = &quot;$2&quot;;</span>
<span class="lineNum">    2007 </span><span class="lineNoCov">          0 :    if (fProductionMode) stageName = &quot;$4&quot;;</span>
<span class="lineNum">    2008 </span><span class="lineNoCov">          0 :    if (!fMergeDirName.IsNull()) {</span>
<span class="lineNum">    2009 </span><span class="lineNoCov">          0 :      fMergingJDL-&gt;AddToInputDataCollection(Form(&quot;LF:$1/%s/Stage_%s.xml,nodownload&quot;,fMergeDirName.Data(),stageName.Data()), &quot;Collection of files to be merged for current stage&quot;);</span>
<span class="lineNum">    2010 </span><span class="lineNoCov">          0 :      fMergingJDL-&gt;SetOutputDirectory(Form(&quot;$1/%s/Stage_%s/#alien_counter_03i#&quot;,fMergeDirName.Data(),stageName.Data()), &quot;Output directory&quot;);</span>
<span class="lineNum">    2011 </span>            :    } else {
<span class="lineNum">    2012 </span><span class="lineNoCov">          0 :      fMergingJDL-&gt;AddToInputDataCollection(Form(&quot;LF:$1/Stage_%s.xml,nodownload&quot;,stageName.Data()), &quot;Collection of files to be merged for current stage&quot;);</span>
<span class="lineNum">    2013 </span><span class="lineNoCov">          0 :      fMergingJDL-&gt;SetOutputDirectory(Form(&quot;$1/Stage_%s/#alien_counter_03i#&quot;,stageName.Data()), &quot;Output directory&quot;);</span>
<span class="lineNum">    2014 </span>            :    }
<span class="lineNum">    2015 </span><span class="lineNoCov">          0 :    if (fProductionMode) {</span>
<span class="lineNum">    2016 </span><span class="lineNoCov">          0 :       TIter next(fInputFiles);</span>
<span class="lineNum">    2017 </span><span class="lineNoCov">          0 :       while ((os=next())) {</span>
<span class="lineNum">    2018 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;AddToInputDataCollection(Form(&quot;LF:%s,nodownload&quot;, os-&gt;GetName()), &quot;Input xml collections&quot;);</span>
<span class="lineNum">    2019 </span>            :       }
<span class="lineNum">    2020 </span><span class="lineNoCov">          0 :       if (!fOutputToRunNo)</span>
<span class="lineNum">    2021 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetOutputDirectory(Form(&quot;%s/#alien_counter_04i#&quot;, fGridOutputDir.Data()));</span>
<span class="lineNum">    2022 </span>            :       else  
<span class="lineNum">    2023 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;SetOutputDirectory(fGridOutputDir);</span>
<span class="lineNum">    2024 </span><span class="lineNoCov">          0 :    } else {            </span>
<span class="lineNum">    2025 </span><span class="lineNoCov">          0 :       if (!fRunNumbers.Length() &amp;&amp; !fRunRange[0]) {</span>
<span class="lineNum">    2026 </span>            :          // One jdl with no parameters in case input data is specified by name.
<span class="lineNum">    2027 </span><span class="lineNoCov">          0 :          TIter next(fInputFiles);</span>
<span class="lineNum">    2028 </span><span class="lineNoCov">          0 :          while ((os=next()))</span>
<span class="lineNum">    2029 </span><span class="lineNoCov">          0 :             fGridJDL-&gt;AddToInputDataCollection(Form(&quot;LF:%s,nodownload&quot;, os-&gt;GetName()), &quot;Input xml collections&quot;);</span>
<span class="lineNum">    2030 </span><span class="lineNoCov">          0 :          if (!fOutputSingle.IsNull())</span>
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :             fGridJDL-&gt;SetOutputDirectory(Form(&quot;#alienfulldir#/../%s&quot;,fOutputSingle.Data()), &quot;Output directory&quot;);</span>
<span class="lineNum">    2032 </span>            :          else {
<span class="lineNum">    2033 </span><span class="lineNoCov">          0 :             fGridJDL-&gt;SetOutputDirectory(Form(&quot;%s/#alien_counter_03i#&quot;, fGridOutputDir.Data()), &quot;Output directory&quot;);</span>
<span class="lineNum">    2034 </span>            : //            fMergingJDL-&gt;SetOutputDirectory(fGridOutputDir);         
<span class="lineNum">    2035 </span>            :          }   
<span class="lineNum">    2036 </span><span class="lineNoCov">          0 :       } else {</span>
<span class="lineNum">    2037 </span>            :          // One jdl to be submitted with 2 input parameters: data collection name and output dir prefix
<span class="lineNum">    2038 </span><span class="lineNoCov">          0 :          fGridJDL-&gt;AddToInputDataCollection(Form(&quot;LF:%s/$1,nodownload&quot;, workdir.Data()), &quot;Input xml collections&quot;);</span>
<span class="lineNum">    2039 </span><span class="lineNoCov">          0 :          if (!fOutputSingle.IsNull()) {</span>
<span class="lineNum">    2040 </span><span class="lineNoCov">          0 :             if (!fOutputToRunNo) fGridJDL-&gt;SetOutputDirectory(Form(&quot;#alienfulldir#/%s&quot;,fOutputSingle.Data()), &quot;Output directory&quot;);</span>
<span class="lineNum">    2041 </span><span class="lineNoCov">          0 :             else fGridJDL-&gt;SetOutputDirectory(Form(&quot;%s/$2&quot;,fGridOutputDir.Data()), &quot;Output directory&quot;);</span>
<span class="lineNum">    2042 </span>            :          } else {   
<span class="lineNum">    2043 </span><span class="lineNoCov">          0 :             fGridJDL-&gt;SetOutputDirectory(Form(&quot;%s/$2/#alien_counter_03i#&quot;, fGridOutputDir.Data()), &quot;Output directory&quot;);</span>
<span class="lineNum">    2044 </span>            :          }   
<span class="lineNum">    2045 </span>            :       }
<span class="lineNum">    2046 </span>            :    }
<span class="lineNum">    2047 </span>            :       
<span class="lineNum">    2048 </span>            :    // Generate the JDL as a string
<span class="lineNum">    2049 </span><span class="lineNoCov">          0 :    TString sjdl = fGridJDL-&gt;Generate();</span>
<span class="lineNum">    2050 </span><span class="lineNoCov">          0 :    TString sjdl1 = fMergingJDL-&gt;Generate();</span>
<span class="lineNum">    2051 </span>            :    // Final merge jdl
<span class="lineNum">    2052 </span><span class="lineNoCov">          0 :    if (!fMergeDirName.IsNull()) {</span>
<span class="lineNum">    2053 </span><span class="lineNoCov">          0 :      fMergingJDL-&gt;SetOutputDirectory(Form(&quot;$1/%s&quot;,fMergeDirName.Data()), &quot;Output directory&quot;);</span>
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :      fMergingJDL-&gt;AddToInputSandbox(Form(&quot;LF:$1/%s/Stage_%s.xml&quot;,fMergeDirName.Data(),stageName.Data()));</span>
<span class="lineNum">    2055 </span>            :    } else {  
<span class="lineNum">    2056 </span><span class="lineNoCov">          0 :      fMergingJDL-&gt;SetOutputDirectory(&quot;$1&quot;, &quot;Output directory&quot;);</span>
<span class="lineNum">    2057 </span><span class="lineNoCov">          0 :      fMergingJDL-&gt;AddToInputSandbox(Form(&quot;LF:$1/Stage_%s.xml&quot;,stageName.Data()));</span>
<span class="lineNum">    2058 </span>            :    }  
<span class="lineNum">    2059 </span><span class="lineNoCov">          0 :    TString sjdl2 = fMergingJDL-&gt;Generate();</span>
<span class="lineNum">    2060 </span>            :    Int_t index, index1;
<span class="lineNum">    2061 </span><span class="lineNoCov">          0 :    sjdl.ReplaceAll(&quot;\&quot;,\&quot;&quot;, &quot;\&quot;,\n   \&quot;&quot;);</span>
<span class="lineNum">    2062 </span><span class="lineNoCov">          0 :    sjdl.ReplaceAll(&quot;(member&quot;, &quot;\n   (member&quot;);</span>
<span class="lineNum">    2063 </span><span class="lineNoCov">          0 :    sjdl.ReplaceAll(&quot;\&quot;,\&quot;VO_&quot;, &quot;\&quot;,\n   \&quot;VO_&quot;);</span>
<span class="lineNum">    2064 </span><span class="lineNoCov">          0 :    sjdl.ReplaceAll(&quot;{&quot;, &quot;{\n   &quot;);</span>
<span class="lineNum">    2065 </span><span class="lineNoCov">          0 :    sjdl.ReplaceAll(&quot;};&quot;, &quot;\n};&quot;);</span>
<span class="lineNum">    2066 </span><span class="lineNoCov">          0 :    sjdl.ReplaceAll(&quot;{\n   \n&quot;, &quot;{\n&quot;);</span>
<span class="lineNum">    2067 </span><span class="lineNoCov">          0 :    sjdl.ReplaceAll(&quot;\n\n&quot;, &quot;\n&quot;);</span>
<span class="lineNum">    2068 </span><span class="lineNoCov">          0 :    sjdl.ReplaceAll(&quot;OutputDirectory&quot;, &quot;OutputDir&quot;);</span>
<span class="lineNum">    2069 </span><span class="lineNoCov">          0 :    sjdl1.ReplaceAll(&quot;\&quot;,\&quot;&quot;, &quot;\&quot;,\n   \&quot;&quot;);</span>
<span class="lineNum">    2070 </span><span class="lineNoCov">          0 :    sjdl1.ReplaceAll(&quot;(member&quot;, &quot;\n   (member&quot;);</span>
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :    sjdl1.ReplaceAll(&quot;\&quot;,\&quot;VO_&quot;, &quot;\&quot;,\n   \&quot;VO_&quot;);</span>
<span class="lineNum">    2072 </span><span class="lineNoCov">          0 :    sjdl1.ReplaceAll(&quot;{&quot;, &quot;{\n   &quot;);</span>
<span class="lineNum">    2073 </span><span class="lineNoCov">          0 :    sjdl1.ReplaceAll(&quot;};&quot;, &quot;\n};&quot;);</span>
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 :    sjdl1.ReplaceAll(&quot;{\n   \n&quot;, &quot;{\n&quot;);</span>
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 :    sjdl1.ReplaceAll(&quot;\n\n&quot;, &quot;\n&quot;);</span>
<span class="lineNum">    2076 </span><span class="lineNoCov">          0 :    sjdl1.ReplaceAll(&quot;OutputDirectory&quot;, &quot;OutputDir&quot;);</span>
<span class="lineNum">    2077 </span><span class="lineNoCov">          0 :    sjdl2.ReplaceAll(&quot;\&quot;,\&quot;&quot;, &quot;\&quot;,\n   \&quot;&quot;);</span>
<span class="lineNum">    2078 </span><span class="lineNoCov">          0 :    sjdl2.ReplaceAll(&quot;(member&quot;, &quot;\n   (member&quot;);</span>
<span class="lineNum">    2079 </span><span class="lineNoCov">          0 :    sjdl2.ReplaceAll(&quot;\&quot;,\&quot;VO_&quot;, &quot;\&quot;,\n   \&quot;VO_&quot;);</span>
<span class="lineNum">    2080 </span><span class="lineNoCov">          0 :    sjdl2.ReplaceAll(&quot;{&quot;, &quot;{\n   &quot;);</span>
<span class="lineNum">    2081 </span><span class="lineNoCov">          0 :    sjdl2.ReplaceAll(&quot;};&quot;, &quot;\n};&quot;);</span>
<span class="lineNum">    2082 </span><span class="lineNoCov">          0 :    sjdl2.ReplaceAll(&quot;{\n   \n&quot;, &quot;{\n&quot;);</span>
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :    sjdl2.ReplaceAll(&quot;\n\n&quot;, &quot;\n&quot;);</span>
<span class="lineNum">    2084 </span><span class="lineNoCov">          0 :    sjdl2.ReplaceAll(&quot;OutputDirectory&quot;, &quot;OutputDir&quot;);</span>
<span class="lineNum">    2085 </span><span class="lineNoCov">          0 :    sjdl += &quot;JDLVariables = \n{\n   \&quot;Packages\&quot;,\n   \&quot;OutputDir\&quot;\n};\n&quot;;</span>
<span class="lineNum">    2086 </span><span class="lineNoCov">          0 :    sjdl.Prepend(Form(&quot;Jobtag = {\n   \&quot;comment:%s\&quot;\n};\n&quot;, fJobTag.Data()));</span>
<span class="lineNum">    2087 </span><span class="lineNoCov">          0 :    index = sjdl.Index(&quot;JDLVariables&quot;);</span>
<span class="lineNum">    2088 </span><span class="lineNoCov">          0 :    if (index &gt;= 0) sjdl.Insert(index, &quot;\n# JDL variables\n&quot;);</span>
<span class="lineNum">    2089 </span><span class="lineNoCov">          0 :    sjdl += &quot;Workdirectorysize = {\&quot;5000MB\&quot;};&quot;;</span>
<span class="lineNum">    2090 </span><span class="lineNoCov">          0 :    sjdl1 += &quot;Workdirectorysize = {\&quot;5000MB\&quot;};&quot;;</span>
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :    sjdl1 += &quot;JDLVariables = \n{\n   \&quot;Packages\&quot;,\n   \&quot;OutputDir\&quot;\n};\n&quot;;</span>
<span class="lineNum">    2092 </span><span class="lineNoCov">          0 :    index = fJobTag.Index(&quot;:&quot;);</span>
<span class="lineNum">    2093 </span><span class="lineNoCov">          0 :    if (index &lt; 0) index = fJobTag.Length();</span>
<span class="lineNum">    2094 </span><span class="lineNoCov">          0 :    TString jobTag = fJobTag;</span>
<span class="lineNum">    2095 </span><span class="lineNoCov">          0 :    if (fProductionMode) jobTag.Insert(index,&quot;_Stage$4&quot;);</span>
<span class="lineNum">    2096 </span><span class="lineNoCov">          0 :    sjdl1.Prepend(Form(&quot;Jobtag = {\n   \&quot;comment:%s_Merging\&quot;\n};\n&quot;, jobTag.Data()));</span>
<span class="lineNum">    2097 </span><span class="lineNoCov">          0 :    if (fProductionMode) {   </span>
<span class="lineNum">    2098 </span><span class="lineNoCov">          0 :      sjdl1.Prepend(&quot;# Generated merging jdl (production mode) \</span>
<span class="lineNum">    2099 </span>            :                     \n# $1 = full alien path to output directory to be merged \
<span class="lineNum">    2100 </span>            :                     \n# $2 = train number \
<span class="lineNum">    2101 </span>            :                     \n# $3 = production (like LHC10b) \
<span class="lineNum">    2102 </span>            :                     \n# $4 = merging stage \
<span class="lineNum">    2103 </span>            :                     \n# Stage_&lt;n&gt;.xml made via: find &lt;OutputDir&gt; *Stage&lt;n-1&gt;/*root_archive.zip\n&quot;);
<span class="lineNum">    2104 </span><span class="lineNoCov">          0 :      sjdl2.Prepend(Form(&quot;Jobtag = {\n   \&quot;comment:%s_FinalMerging\&quot;\n};\n&quot;, jobTag.Data()));</span>
<span class="lineNum">    2105 </span><span class="lineNoCov">          0 :      sjdl2.Prepend(&quot;# Generated merging jdl \</span>
<span class="lineNum">    2106 </span>            :                     \n# $1 = full alien path to output directory to be merged \
<span class="lineNum">    2107 </span>            :                     \n# $2 = train number \
<span class="lineNum">    2108 </span>            :                     \n# $3 = production (like LHC10b) \
<span class="lineNum">    2109 </span>            :                     \n# $4 = merging stage \
<span class="lineNum">    2110 </span>            :                     \n# Stage_&lt;n&gt;.xml made via: find &lt;OutputDir&gt; *Stage&lt;n-1&gt;/*root_archive.zip\n&quot;);
<span class="lineNum">    2111 </span>            :    } else {
<span class="lineNum">    2112 </span><span class="lineNoCov">          0 :      sjdl1.Prepend(&quot;# Generated merging jdl \</span>
<span class="lineNum">    2113 </span>            :                     \n# $1 = full alien path to output directory to be merged \
<span class="lineNum">    2114 </span>            :                     \n# $2 = merging stage \
<span class="lineNum">    2115 </span>            :                     \n# xml made via: find &lt;OutputDir&gt; *Stage&lt;n-1&gt;/*root_archive.zip\n&quot;);
<span class="lineNum">    2116 </span><span class="lineNoCov">          0 :      sjdl2.Prepend(Form(&quot;Jobtag = {\n   \&quot;comment:%s_FinalMerging\&quot;\n};\n&quot;, jobTag.Data()));</span>
<span class="lineNum">    2117 </span><span class="lineNoCov">          0 :      sjdl2.Prepend(&quot;# Generated merging jdl \</span>
<span class="lineNum">    2118 </span>            :                     \n# $1 = full alien path to output directory to be merged \
<span class="lineNum">    2119 </span>            :                     \n# $2 = merging stage \
<span class="lineNum">    2120 </span>            :                     \n# xml made via: find &lt;OutputDir&gt; *Stage&lt;n-1&gt;/*root_archive.zip\n&quot;);
<span class="lineNum">    2121 </span>            :    }
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :    index = sjdl1.Index(&quot;JDLVariables&quot;);</span>
<span class="lineNum">    2123 </span><span class="lineNoCov">          0 :    if (index &gt;= 0) sjdl1.Insert(index, &quot;\n# JDL variables\n&quot;);</span>
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :    index = sjdl2.Index(&quot;JDLVariables&quot;);</span>
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :    if (index &gt;= 0) sjdl2.Insert(index, &quot;\n# JDL variables\n&quot;);</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :    sjdl1 += &quot;Workdirectorysize = {\&quot;5000MB\&quot;};&quot;;</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :    sjdl2 += &quot;Workdirectorysize = {\&quot;5000MB\&quot;};&quot;;</span>
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :    index = sjdl2.Index(&quot;Split =&quot;);</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :    if (index&gt;=0) {</span>
<span class="lineNum">    2130 </span><span class="lineNoCov">          0 :       index1 = sjdl2.Index(&quot;\n&quot;, index);</span>
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 :       sjdl2.Remove(index, index1-index+1);</span>
<span class="lineNum">    2132 </span>            :    }
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :    index = sjdl2.Index(&quot;SplitMaxInputFileNumber&quot;);</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :    if (index&gt;=0) {</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :       index1 = sjdl2.Index(&quot;\n&quot;, index);</span>
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :       sjdl2.Remove(index, index1-index+1);</span>
<span class="lineNum">    2137 </span>            :    }
<span class="lineNum">    2138 </span><span class="lineNoCov">          0 :    index = sjdl2.Index(&quot;InputDataCollection&quot;);</span>
<span class="lineNum">    2139 </span><span class="lineNoCov">          0 :    if (index&gt;=0) {</span>
<span class="lineNum">    2140 </span><span class="lineNoCov">          0 :       index1 = sjdl2.Index(&quot;;&quot;, index);</span>
<span class="lineNum">    2141 </span><span class="lineNoCov">          0 :       sjdl2.Remove(index, index1-index+1);</span>
<span class="lineNum">    2142 </span>            :    }
<span class="lineNum">    2143 </span><span class="lineNoCov">          0 :    index = sjdl2.Index(&quot;InputDataListFormat&quot;);</span>
<span class="lineNum">    2144 </span><span class="lineNoCov">          0 :    if (index&gt;=0) {</span>
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :       index1 = sjdl2.Index(&quot;\n&quot;, index);</span>
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 :       sjdl2.Remove(index, index1-index+1);</span>
<span class="lineNum">    2147 </span>            :    }
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :    index = sjdl2.Index(&quot;InputDataList&quot;);</span>
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :    if (index&gt;=0) {</span>
<span class="lineNum">    2150 </span><span class="lineNoCov">          0 :       index1 = sjdl2.Index(&quot;\n&quot;, index);</span>
<span class="lineNum">    2151 </span><span class="lineNoCov">          0 :       sjdl2.Remove(index, index1-index+1);</span>
<span class="lineNum">    2152 </span>            :    }
<span class="lineNum">    2153 </span><span class="lineNoCov">          0 :    sjdl2.ReplaceAll(&quot;wn.xml&quot;, Form(&quot;Stage_%s.xml&quot;,stageName.Data()));</span>
<span class="lineNum">    2154 </span>            :    // Write jdl to file
<span class="lineNum">    2155 </span><span class="lineNoCov">          0 :    ofstream out;</span>
<span class="lineNum">    2156 </span><span class="lineNoCov">          0 :    out.open(fJDLName.Data(), ios::out);</span>
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :    if (out.bad()) {</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :       Error(&quot;WriteJDL&quot;, &quot;Bad file name: %s&quot;, fJDLName.Data());</span>
<span class="lineNum">    2159 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2160 </span>            :    }
<span class="lineNum">    2161 </span><span class="lineNoCov">          0 :    out &lt;&lt; sjdl &lt;&lt; endl;</span>
<span class="lineNum">    2162 </span><span class="lineNoCov">          0 :    out.close();</span>
<span class="lineNum">    2163 </span><span class="lineNoCov">          0 :    TString mergeJDLName = fExecutable;</span>
<span class="lineNum">    2164 </span><span class="lineNoCov">          0 :    mergeJDLName.ReplaceAll(&quot;.sh&quot;, &quot;_merge.jdl&quot;);</span>
<span class="lineNum">    2165 </span><span class="lineNoCov">          0 :    if (fMergeViaJDL) {</span>
<span class="lineNum">    2166 </span><span class="lineNoCov">          0 :       ofstream out1;</span>
<span class="lineNum">    2167 </span><span class="lineNoCov">          0 :       out1.open(mergeJDLName.Data(), ios::out);</span>
<span class="lineNum">    2168 </span><span class="lineNoCov">          0 :       if (out1.bad()) {</span>
<span class="lineNum">    2169 </span><span class="lineNoCov">          0 :          Error(&quot;WriteJDL&quot;, &quot;Bad file name: %s&quot;, mergeJDLName.Data());</span>
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    2171 </span>            :       }
<span class="lineNum">    2172 </span><span class="lineNoCov">          0 :       out1 &lt;&lt; sjdl1 &lt;&lt; endl;</span>
<span class="lineNum">    2173 </span><span class="lineNoCov">          0 :       out1.close();</span>
<span class="lineNum">    2174 </span><span class="lineNoCov">          0 :       ofstream out2;</span>
<span class="lineNum">    2175 </span><span class="lineNoCov">          0 :       TString finalJDL = mergeJDLName;</span>
<span class="lineNum">    2176 </span><span class="lineNoCov">          0 :       finalJDL.ReplaceAll(&quot;.jdl&quot;, &quot;_final.jdl&quot;);</span>
<span class="lineNum">    2177 </span><span class="lineNoCov">          0 :       out2.open(finalJDL.Data(), ios::out);</span>
<span class="lineNum">    2178 </span><span class="lineNoCov">          0 :       if (out2.bad()) {</span>
<span class="lineNum">    2179 </span><span class="lineNoCov">          0 :          Error(&quot;WriteJDL&quot;, &quot;Bad file name: %s&quot;, finalJDL.Data());</span>
<span class="lineNum">    2180 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    2181 </span>            :       }
<span class="lineNum">    2182 </span><span class="lineNoCov">          0 :       out2 &lt;&lt; sjdl2 &lt;&lt; endl;</span>
<span class="lineNum">    2183 </span><span class="lineNoCov">          0 :       out2.close();</span>
<span class="lineNum">    2184 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    2185 </span>            : 
<span class="lineNum">    2186 </span>            :    // Copy jdl to grid workspace   
<span class="lineNum">    2187 </span><span class="lineNoCov">          0 :    if (!copy) {</span>
<span class="lineNum">    2188 </span><span class="lineNoCov">          0 :       Info(&quot;WriteJDL&quot;, &quot;\n#####   You may want to review jdl:%s and analysis macro:%s before running in &lt;submit&gt; mode&quot;, fJDLName.Data(), fAnalysisMacro.Data());</span>
<span class="lineNum">    2189 </span>            :    } else {
<span class="lineNum">    2190 </span><span class="lineNoCov">          0 :       TString locjdl = Form(&quot;%s/%s&quot;, fGridOutputDir.Data(),fJDLName.Data());</span>
<span class="lineNum">    2191 </span><span class="lineNoCov">          0 :       TString locjdl1 = Form(&quot;%s/%s&quot;, fGridOutputDir.Data(),mergeJDLName.Data());</span>
<span class="lineNum">    2192 </span><span class="lineNoCov">          0 :       TString finalJDL = mergeJDLName;</span>
<span class="lineNum">    2193 </span><span class="lineNoCov">          0 :       finalJDL.ReplaceAll(&quot;.jdl&quot;, &quot;_final.jdl&quot;);</span>
<span class="lineNum">    2194 </span><span class="lineNoCov">          0 :       TString locjdl2 = Form(&quot;%s/%s&quot;, fGridOutputDir.Data(),finalJDL.Data());</span>
<span class="lineNum">    2195 </span><span class="lineNoCov">          0 :       if (fProductionMode) {</span>
<span class="lineNum">    2196 </span><span class="lineNoCov">          0 :          locjdl = Form(&quot;%s/%s&quot;, workdir.Data(),fJDLName.Data());</span>
<span class="lineNum">    2197 </span><span class="lineNoCov">          0 :          locjdl1 = Form(&quot;%s/%s&quot;, workdir.Data(),mergeJDLName.Data());</span>
<span class="lineNum">    2198 </span><span class="lineNoCov">          0 :          locjdl2 = Form(&quot;%s/%s&quot;, workdir.Data(),finalJDL.Data());</span>
<span class="lineNum">    2199 </span>            :       }   
<span class="lineNum">    2200 </span><span class="lineNoCov">          0 :       if (FileExists(locjdl)) gGrid-&gt;Rm(locjdl);</span>
<span class="lineNum">    2201 </span><span class="lineNoCov">          0 :       if (FileExists(locjdl1)) gGrid-&gt;Rm(locjdl1);</span>
<span class="lineNum">    2202 </span><span class="lineNoCov">          0 :       if (FileExists(locjdl2)) gGrid-&gt;Rm(locjdl2);</span>
<span class="lineNum">    2203 </span><span class="lineNoCov">          0 :       Info(&quot;WriteJDL&quot;, &quot;\n#####   Copying JDL file &lt;%s&gt; to your AliEn output directory&quot;, fJDLName.Data());</span>
<span class="lineNum">    2204 </span>            : //      TFile::Cp(Form(&quot;file:%s&quot;,fJDLName.Data()), Form(&quot;alien://%s&quot;, locjdl.Data()));
<span class="lineNum">    2205 </span><span class="lineNoCov">          0 :       if (!copyLocal2Alien(&quot;WriteJDL&quot;,fJDLName.Data(),locjdl.Data())) </span>
<span class="lineNum">    2206 </span><span class="lineNoCov">          0 :          Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    2207 </span><span class="lineNoCov">          0 :       if (fMergeViaJDL) {</span>
<span class="lineNum">    2208 </span><span class="lineNoCov">          0 :          Info(&quot;WriteJDL&quot;, &quot;\n#####   Copying merging JDL files &lt;%s&gt; to your AliEn output directory&quot;, mergeJDLName.Data());</span>
<span class="lineNum">    2209 </span>            : //         TFile::Cp(Form(&quot;file:%s&quot;,mergeJDLName.Data()), Form(&quot;alien://%s&quot;, locjdl1.Data()));
<span class="lineNum">    2210 </span>            : //         TFile::Cp(Form(&quot;file:%s&quot;,finalJDL.Data()), Form(&quot;alien://%s&quot;, locjdl2.Data()));
<span class="lineNum">    2211 </span><span class="lineNoCov">          0 :          if (!copyLocal2Alien(&quot;WriteJDL&quot;,mergeJDLName.Data(),locjdl1.Data()))</span>
<span class="lineNum">    2212 </span><span class="lineNoCov">          0 :             Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    2213 </span><span class="lineNoCov">          0 :          if (!copyLocal2Alien(&quot;WriteJDL&quot;,finalJDL.Data(),locjdl2.Data()))</span>
<span class="lineNum">    2214 </span><span class="lineNoCov">          0 :            Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    2215 </span>            :       }   
<span class="lineNum">    2216 </span><span class="lineNoCov">          0 :    } </span>
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    2218 </span><span class="lineNoCov">          0 : }</span>
<a name="2219"><span class="lineNum">    2219 </span>            : </a>
<span class="lineNum">    2220 </span>            : //______________________________________________________________________________
<span class="lineNum">    2221 </span>            : Bool_t AliAnalysisAlien::FileExists(const char *lfn)
<span class="lineNum">    2222 </span>            : {
<span class="lineNum">    2223 </span>            : // Returns true if file exists.
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 :    if (!gGrid) return kFALSE;</span>
<span class="lineNum">    2225 </span><span class="lineNoCov">          0 :    TString slfn = lfn;</span>
<span class="lineNum">    2226 </span><span class="lineNoCov">          0 :    slfn.ReplaceAll(&quot;alien://&quot;,&quot;&quot;);</span>
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :    TGridResult *res = gGrid-&gt;Ls(slfn);</span>
<span class="lineNum">    2228 </span><span class="lineNoCov">          0 :    if (!res) return kFALSE;</span>
<span class="lineNum">    2229 </span><span class="lineNoCov">          0 :    TMap *map = dynamic_cast&lt;TMap*&gt;(res-&gt;At(0));</span>
<span class="lineNum">    2230 </span><span class="lineNoCov">          0 :    if (!map) {</span>
<span class="lineNum">    2231 </span><span class="lineNoCov">          0 :       delete res;</span>
<span class="lineNum">    2232 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2233 </span>            :    }   
<span class="lineNum">    2234 </span><span class="lineNoCov">          0 :    TObjString *objs = dynamic_cast&lt;TObjString*&gt;(map-&gt;GetValue(&quot;name&quot;));</span>
<span class="lineNum">    2235 </span><span class="lineNoCov">          0 :    if (!objs || !objs-&gt;GetString().Length()) {</span>
<span class="lineNum">    2236 </span><span class="lineNoCov">          0 :       delete res;</span>
<span class="lineNum">    2237 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2238 </span>            :    }
<span class="lineNum">    2239 </span><span class="lineNoCov">          0 :    delete res;   </span>
<span class="lineNum">    2240 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    2241 </span><span class="lineNoCov">          0 : }</span>
<a name="2242"><span class="lineNum">    2242 </span>            : </a>
<span class="lineNum">    2243 </span>            : //______________________________________________________________________________
<span class="lineNum">    2244 </span>            : Bool_t AliAnalysisAlien::DirectoryExists(const char *dirname)
<span class="lineNum">    2245 </span>            : {
<span class="lineNum">    2246 </span>            : // Returns true if directory exists. Can be also a path.
<span class="lineNum">    2247 </span>            : // Since there is not API in TAlien, we use the Cd trick:
<span class="lineNum">    2248 </span><span class="lineNoCov">          0 :    if (!gGrid) return kFALSE;</span>
<span class="lineNum">    2249 </span>            :    // Backup current path
<span class="lineNum">    2250 </span><span class="lineNoCov">          0 :    TString cpath = gGrid-&gt;Pwd();</span>
<span class="lineNum">    2251 </span><span class="lineNoCov">          0 :    TString command = &quot;cd &quot;;</span>
<span class="lineNum">    2252 </span><span class="lineNoCov">          0 :    TString sdir(dirname);</span>
<span class="lineNum">    2253 </span><span class="lineNoCov">          0 :    sdir.ReplaceAll(&quot;alien://&quot;, &quot;&quot;);</span>
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 :    command += sdir;</span>
<span class="lineNum">    2255 </span><span class="lineNoCov">          0 :    TGridResult *res = gGrid-&gt;Command(command);</span>
<span class="lineNum">    2256 </span><span class="lineNoCov">          0 :    if (!res) {</span>
<span class="lineNum">    2257 </span><span class="lineNoCov">          0 :       gGrid-&gt;Cd(cpath);</span>
<span class="lineNum">    2258 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2259 </span>            :    }   
<span class="lineNum">    2260 </span><span class="lineNoCov">          0 :    TMap *map = (TMap*)res-&gt;At(0);</span>
<span class="lineNum">    2261 </span><span class="lineNoCov">          0 :    if (!map) {</span>
<span class="lineNum">    2262 </span><span class="lineNoCov">          0 :       gGrid-&gt;Cd(cpath);</span>
<span class="lineNum">    2263 </span><span class="lineNoCov">          0 :       delete res;</span>
<span class="lineNum">    2264 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2265 </span>            :    }
<span class="lineNum">    2266 </span><span class="lineNoCov">          0 :    TString sval = map-&gt;GetValue(&quot;__result__&quot;)-&gt;GetName();</span>
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :    Bool_t retval = (Bool_t)sval.Atoi();</span>
<span class="lineNum">    2268 </span><span class="lineNoCov">          0 :    gGrid-&gt;Cd(cpath);</span>
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :    delete res;</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :    return retval;</span>
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 : }   </span>
<a name="2272"><span class="lineNum">    2272 </span>            : </a>
<span class="lineNum">    2273 </span>            : //______________________________________________________________________________
<span class="lineNum">    2274 </span>            : void AliAnalysisAlien::CheckDataType(const char *lfn, Bool_t &amp;isCollection, Bool_t &amp;isXml, Bool_t &amp;useTags)
<span class="lineNum">    2275 </span>            : {
<span class="lineNum">    2276 </span>            : // Check input data type.
<span class="lineNum">    2277 </span><span class="lineNoCov">          0 :    isCollection = kFALSE;</span>
<span class="lineNum">    2278 </span><span class="lineNoCov">          0 :    isXml = kFALSE;</span>
<span class="lineNum">    2279 </span><span class="lineNoCov">          0 :    useTags = kFALSE;</span>
<span class="lineNum">    2280 </span><span class="lineNoCov">          0 :    if (!gGrid) {</span>
<span class="lineNum">    2281 </span><span class="lineNoCov">          0 :       Error(&quot;CheckDataType&quot;, &quot;No connection to grid&quot;);</span>
<span class="lineNum">    2282 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    2283 </span>            :    }
<span class="lineNum">    2284 </span><span class="lineNoCov">          0 :    isCollection = IsCollection(lfn);</span>
<span class="lineNum">    2285 </span><span class="lineNoCov">          0 :    TString msg = &quot;\n#####   file: &quot;;</span>
<span class="lineNum">    2286 </span><span class="lineNoCov">          0 :    msg += lfn;</span>
<span class="lineNum">    2287 </span><span class="lineNoCov">          0 :    if (isCollection) {</span>
<span class="lineNum">    2288 </span><span class="lineNoCov">          0 :       msg += &quot; type: raw_collection;&quot;;</span>
<span class="lineNum">    2289 </span>            :    // special treatment for collections
<span class="lineNum">    2290 </span><span class="lineNoCov">          0 :       isXml = kFALSE;</span>
<span class="lineNum">    2291 </span>            :       // check for tag files in the collection
<span class="lineNum">    2292 </span><span class="lineNoCov">          0 :       TGridResult *res = gGrid-&gt;Command(Form(&quot;listFilesFromCollection -z -v %s&quot;,lfn), kFALSE);</span>
<span class="lineNum">    2293 </span><span class="lineNoCov">          0 :       if (!res) {</span>
<span class="lineNum">    2294 </span><span class="lineNoCov">          0 :          msg += &quot; using_tags: No (unknown)&quot;;</span>
<span class="lineNum">    2295 </span><span class="lineNoCov">          0 :          Info(&quot;CheckDataType&quot;, &quot;%s&quot;, msg.Data());</span>
<span class="lineNum">    2296 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    2297 </span>            :       }   
<span class="lineNum">    2298 </span><span class="lineNoCov">          0 :       const char* typeStr = res-&gt;GetKey(0, &quot;origLFN&quot;);</span>
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :       if (!typeStr || !strlen(typeStr)) {</span>
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :          msg += &quot; using_tags: No (unknown)&quot;;</span>
<span class="lineNum">    2301 </span><span class="lineNoCov">          0 :          Info(&quot;CheckDataType&quot;, &quot;%s&quot;, msg.Data());</span>
<span class="lineNum">    2302 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    2303 </span>            :       }   
<span class="lineNum">    2304 </span><span class="lineNoCov">          0 :       TString file = typeStr;</span>
<span class="lineNum">    2305 </span><span class="lineNoCov">          0 :       useTags = file.Contains(&quot;.tag&quot;);</span>
<span class="lineNum">    2306 </span><span class="lineNoCov">          0 :       if (useTags) msg += &quot; using_tags: Yes&quot;;</span>
<span class="lineNum">    2307 </span><span class="lineNoCov">          0 :       else          msg += &quot; using_tags: No&quot;;</span>
<span class="lineNum">    2308 </span><span class="lineNoCov">          0 :       Info(&quot;CheckDataType&quot;, &quot;%s&quot;, msg.Data());</span>
<span class="lineNum">    2309 </span>            :       return;
<span class="lineNum">    2310 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2311 </span><span class="lineNoCov">          0 :    TString slfn(lfn);</span>
<span class="lineNum">    2312 </span><span class="lineNoCov">          0 :    slfn.ToLower();</span>
<span class="lineNum">    2313 </span><span class="lineNoCov">          0 :    isXml = slfn.Contains(&quot;.xml&quot;);</span>
<span class="lineNum">    2314 </span><span class="lineNoCov">          0 :    if (isXml) {</span>
<span class="lineNum">    2315 </span>            :    // Open xml collection and check if there are tag files inside
<span class="lineNum">    2316 </span><span class="lineNoCov">          0 :       msg += &quot; type: xml_collection;&quot;;</span>
<span class="lineNum">    2317 </span><span class="lineNoCov">          0 :       TGridCollection *coll = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;TAlienCollection::Open(\&quot;alien://%s\&quot;,1);&quot;,lfn));</span>
<span class="lineNum">    2318 </span><span class="lineNoCov">          0 :       if (!coll) {</span>
<span class="lineNum">    2319 </span><span class="lineNoCov">          0 :          msg += &quot; using_tags: No (unknown)&quot;;</span>
<span class="lineNum">    2320 </span><span class="lineNoCov">          0 :          Info(&quot;CheckDataType&quot;, &quot;%s&quot;, msg.Data());</span>
<span class="lineNum">    2321 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    2322 </span>            :       }   
<span class="lineNum">    2323 </span><span class="lineNoCov">          0 :       TMap *map = coll-&gt;Next();</span>
<span class="lineNum">    2324 </span><span class="lineNoCov">          0 :       if (!map) {</span>
<span class="lineNum">    2325 </span><span class="lineNoCov">          0 :          msg += &quot; using_tags: No (unknown)&quot;;</span>
<span class="lineNum">    2326 </span><span class="lineNoCov">          0 :          Info(&quot;CheckDataType&quot;, &quot;%s&quot;, msg.Data());</span>
<span class="lineNum">    2327 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    2328 </span>            :       }   
<span class="lineNum">    2329 </span><span class="lineNoCov">          0 :       map = (TMap*)map-&gt;GetValue(&quot;&quot;);</span>
<span class="lineNum">    2330 </span><span class="lineNoCov">          0 :       TString file;</span>
<span class="lineNum">    2331 </span><span class="lineNoCov">          0 :       if (map &amp;&amp; map-&gt;GetValue(&quot;name&quot;)) file = map-&gt;GetValue(&quot;name&quot;)-&gt;GetName();</span>
<span class="lineNum">    2332 </span><span class="lineNoCov">          0 :       useTags = file.Contains(&quot;.tag&quot;);</span>
<span class="lineNum">    2333 </span><span class="lineNoCov">          0 :       delete coll;</span>
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :       if (useTags) msg += &quot; using_tags: Yes&quot;;</span>
<span class="lineNum">    2335 </span><span class="lineNoCov">          0 :       else          msg += &quot; using_tags: No&quot;;</span>
<span class="lineNum">    2336 </span><span class="lineNoCov">          0 :       Info(&quot;CheckDataType&quot;, &quot;%s&quot;, msg.Data());</span>
<span class="lineNum">    2337 </span>            :       return;
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2339 </span><span class="lineNoCov">          0 :    useTags = slfn.Contains(&quot;.tag&quot;);</span>
<span class="lineNum">    2340 </span><span class="lineNoCov">          0 :    if (slfn.Contains(&quot;.root&quot;)) msg += &quot; type: root file;&quot;;</span>
<span class="lineNum">    2341 </span><span class="lineNoCov">          0 :    else                        msg += &quot; type: unknown file;&quot;;</span>
<span class="lineNum">    2342 </span><span class="lineNoCov">          0 :    if (useTags) msg += &quot; using_tags: Yes&quot;;</span>
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :    else          msg += &quot; using_tags: No&quot;;</span>
<span class="lineNum">    2344 </span><span class="lineNoCov">          0 :    Info(&quot;CheckDataType&quot;, &quot;%s&quot;, msg.Data());</span>
<span class="lineNum">    2345 </span><span class="lineNoCov">          0 : }</span>
<a name="2346"><span class="lineNum">    2346 </span>            : </a>
<span class="lineNum">    2347 </span>            : //______________________________________________________________________________
<span class="lineNum">    2348 </span>            : void AliAnalysisAlien::EnablePackage(const char *package)
<span class="lineNum">    2349 </span>            : {
<span class="lineNum">    2350 </span>            : // Enables a par file supposed to exist in the current directory.
<span class="lineNum">    2351 </span><span class="lineNoCov">          0 :    TString pkg(package);</span>
<span class="lineNum">    2352 </span><span class="lineNoCov">          0 :    pkg.ReplaceAll(&quot;.par&quot;, &quot;&quot;);</span>
<span class="lineNum">    2353 </span><span class="lineNoCov">          0 :    pkg += &quot;.par&quot;;</span>
<span class="lineNum">    2354 </span><span class="lineNoCov">          0 :    if (gSystem-&gt;AccessPathName(pkg)) {</span>
<span class="lineNum">    2355 </span><span class="lineNoCov">          0 :       Fatal(&quot;EnablePackage&quot;, &quot;Package %s not found&quot;, pkg.Data());</span>
<span class="lineNum">    2356 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    2357 </span>            :    }
<span class="lineNum">    2358 </span><span class="lineNoCov">          0 :    if (!TObject::TestBit(AliAnalysisGrid::kUsePars))</span>
<span class="lineNum">    2359 </span><span class="lineNoCov">          0 :       Info(&quot;EnablePackage&quot;, &quot;AliEn plugin will use .par packages&quot;);</span>
<span class="lineNum">    2360 </span><span class="lineNoCov">          0 :    TObject::SetBit(AliAnalysisGrid::kUsePars, kTRUE);</span>
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :    if (!fPackages) {</span>
<span class="lineNum">    2362 </span><span class="lineNoCov">          0 :       fPackages = new TObjArray();</span>
<span class="lineNum">    2363 </span><span class="lineNoCov">          0 :       fPackages-&gt;SetOwner();</span>
<span class="lineNum">    2364 </span>            :    }
<span class="lineNum">    2365 </span><span class="lineNoCov">          0 :    fPackages-&gt;Add(new TObjString(pkg));</span>
<span class="lineNum">    2366 </span><span class="lineNoCov">          0 : }      </span>
<a name="2367"><span class="lineNum">    2367 </span>            : </a>
<span class="lineNum">    2368 </span>            : //______________________________________________________________________________
<span class="lineNum">    2369 </span>            : TChain *AliAnalysisAlien::GetChainForTestMode(const char *treeName) const
<span class="lineNum">    2370 </span>            : {
<span class="lineNum">    2371 </span>            : // Make a tree from files having the location specified in fFileForTestMode. 
<span class="lineNum">    2372 </span>            : // Inspired from JF's CreateESDChain.
<span class="lineNum">    2373 </span><span class="lineNoCov">          0 :    if (fFileForTestMode.IsNull()) {</span>
<span class="lineNum">    2374 </span><span class="lineNoCov">          0 :       Error(&quot;GetChainForTestMode&quot;, &quot;For proof test mode please use SetFileForTestMode() pointing to a file that contains data file locations.&quot;);</span>
<span class="lineNum">    2375 </span><span class="lineNoCov">          0 :       return NULL;</span>
<span class="lineNum">    2376 </span>            :    }
<span class="lineNum">    2377 </span><span class="lineNoCov">          0 :    if (gSystem-&gt;AccessPathName(fFileForTestMode)) {</span>
<span class="lineNum">    2378 </span><span class="lineNoCov">          0 :       Error(&quot;GetChainForTestMode&quot;, &quot;File not found: %s&quot;, fFileForTestMode.Data());</span>
<span class="lineNum">    2379 </span><span class="lineNoCov">          0 :       return NULL;</span>
<span class="lineNum">    2380 </span>            :    }   
<span class="lineNum">    2381 </span>            :    // Open the file
<span class="lineNum">    2382 </span><span class="lineNoCov">          0 :    ifstream in;</span>
<span class="lineNum">    2383 </span><span class="lineNoCov">          0 :    in.open(fFileForTestMode);</span>
<span class="lineNum">    2384 </span>            :    Int_t count = 0;
<span class="lineNum">    2385 </span>            :     // Read the input list of files and add them to the chain
<span class="lineNum">    2386 </span><span class="lineNoCov">          0 :    TString line;</span>
<span class="lineNum">    2387 </span><span class="lineNoCov">          0 :    TString streeName(treeName);</span>
<span class="lineNum">    2388 </span><span class="lineNoCov">          0 :    if (IsUseMCchain()) streeName = &quot;TE&quot;;</span>
<span class="lineNum">    2389 </span><span class="lineNoCov">          0 :    TChain *chain = new TChain(streeName);</span>
<span class="lineNum">    2390 </span><span class="lineNoCov">          0 :    TList *friends = new TList();</span>
<span class="lineNum">    2391 </span>            :    TChain *cfriend = 0;
<span class="lineNum">    2392 </span><span class="lineNoCov">          0 :    if (!fFriendChainName.IsNull()) {</span>
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :       TObjArray *list = fFriendChainName.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    2394 </span><span class="lineNoCov">          0 :       TIter next(list);</span>
<span class="lineNum">    2395 </span>            :       TObjString *str;
<span class="lineNum">    2396 </span><span class="lineNoCov">          0 :       while((str=(TObjString*)next())) {</span>
<span class="lineNum">    2397 </span><span class="lineNoCov">          0 :          cfriend = new TChain(streeName, str-&gt;GetName());</span>
<span class="lineNum">    2398 </span><span class="lineNoCov">          0 :          friends-&gt;Add(cfriend);</span>
<span class="lineNum">    2399 </span><span class="lineNoCov">          0 :          chain-&gt;AddFriend(cfriend);</span>
<span class="lineNum">    2400 </span>            :       }
<span class="lineNum">    2401 </span><span class="lineNoCov">          0 :       delete list;</span>
<span class="lineNum">    2402 </span><span class="lineNoCov">          0 :    } </span>
<span class="lineNum">    2403 </span><span class="lineNoCov">          0 :    TString bpath;</span>
<span class="lineNum">    2404 </span><span class="lineNoCov">          0 :    TIter nextfriend(friends);</span>
<span class="lineNum">    2405 </span><span class="lineNoCov">          0 :    while (in.good())</span>
<span class="lineNum">    2406 </span>            :    {
<span class="lineNum">    2407 </span><span class="lineNoCov">          0 :       in &gt;&gt; line;</span>
<span class="lineNum">    2408 </span><span class="lineNoCov">          0 :       if (line.IsNull() || line.BeginsWith(&quot;#&quot;)) continue;</span>
<span class="lineNum">    2409 </span><span class="lineNoCov">          0 :       if (count++ == fNtestFiles) break;</span>
<span class="lineNum">    2410 </span><span class="lineNoCov">          0 :       TString esdFile(line);</span>
<span class="lineNum">    2411 </span><span class="lineNoCov">          0 :       TFile *file = TFile::Open(esdFile);</span>
<span class="lineNum">    2412 </span><span class="lineNoCov">          0 :       if (file &amp;&amp; !file-&gt;IsZombie()) {</span>
<span class="lineNum">    2413 </span><span class="lineNoCov">          0 :          chain-&gt;Add(esdFile);</span>
<span class="lineNum">    2414 </span><span class="lineNoCov">          0 :          file-&gt;Close();</span>
<span class="lineNum">    2415 </span><span class="lineNoCov">          0 :          if (!fFriendChainName.IsNull()) {</span>
<span class="lineNum">    2416 </span><span class="lineNoCov">          0 :             if (esdFile.Index(&quot;#&quot;) &gt; -1)</span>
<span class="lineNum">    2417 </span><span class="lineNoCov">          0 :                esdFile.Remove(esdFile.Index(&quot;#&quot;));</span>
<span class="lineNum">    2418 </span><span class="lineNoCov">          0 :             bpath = gSystem-&gt;DirName(esdFile);</span>
<span class="lineNum">    2419 </span><span class="lineNoCov">          0 :             bpath += &quot;/&quot;;</span>
<span class="lineNum">    2420 </span><span class="lineNoCov">          0 :             TString fileFriend;</span>
<span class="lineNum">    2421 </span><span class="lineNoCov">          0 :             nextfriend.Reset();</span>
<span class="lineNum">    2422 </span><span class="lineNoCov">          0 :             while ((cfriend=(TChain*)nextfriend())) {</span>
<span class="lineNum">    2423 </span><span class="lineNoCov">          0 :                fileFriend = bpath;</span>
<span class="lineNum">    2424 </span><span class="lineNoCov">          0 :                fileFriend += cfriend-&gt;GetTitle();</span>
<span class="lineNum">    2425 </span><span class="lineNoCov">          0 :                file = TFile::Open(fileFriend);</span>
<span class="lineNum">    2426 </span><span class="lineNoCov">          0 :                if (file &amp;&amp; !file-&gt;IsZombie()) {</span>
<span class="lineNum">    2427 </span><span class="lineNoCov">          0 :                   file-&gt;Close();</span>
<span class="lineNum">    2428 </span><span class="lineNoCov">          0 :                   cfriend-&gt;Add(fileFriend);</span>
<span class="lineNum">    2429 </span>            :                } else {
<span class="lineNum">    2430 </span><span class="lineNoCov">          0 :                   Fatal(&quot;GetChainForTestMode&quot;, &quot;Cannot open friend file: %s&quot;, fileFriend.Data());</span>
<span class="lineNum">    2431 </span><span class="lineNoCov">          0 :                   return 0;</span>
<span class="lineNum">    2432 </span>            :                } 
<span class="lineNum">    2433 </span>            :             }     
<span class="lineNum">    2434 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    2435 </span>            :       } else {
<span class="lineNum">    2436 </span><span class="lineNoCov">          0 :          Error(&quot;GetChainforTestMode&quot;, &quot;Skipping un-openable file: %s&quot;, esdFile.Data());</span>
<span class="lineNum">    2437 </span>            :       }   
<span class="lineNum">    2438 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2439 </span><span class="lineNoCov">          0 :    in.close();</span>
<span class="lineNum">    2440 </span><span class="lineNoCov">          0 :    if (!chain-&gt;GetListOfFiles()-&gt;GetEntries()) {</span>
<span class="lineNum">    2441 </span><span class="lineNoCov">          0 :        Error(&quot;GetChainForTestMode&quot;, &quot;No file from %s could be opened&quot;, fFileForTestMode.Data());</span>
<span class="lineNum">    2442 </span><span class="lineNoCov">          0 :        delete chain;</span>
<span class="lineNum">    2443 </span><span class="lineNoCov">          0 :        friends-&gt;Delete();</span>
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 :        delete friends;</span>
<span class="lineNum">    2445 </span><span class="lineNoCov">          0 :        return NULL;</span>
<span class="lineNum">    2446 </span>            :    }
<span class="lineNum">    2447 </span><span class="lineNoCov">          0 :    return chain;</span>
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 : }    </span>
<a name="2449"><span class="lineNum">    2449 </span>            : </a>
<span class="lineNum">    2450 </span>            : //______________________________________________________________________________
<span class="lineNum">    2451 </span>            : const char *AliAnalysisAlien::GetJobStatus(Int_t jobidstart, Int_t lastid, Int_t &amp;nrunning, Int_t &amp;nwaiting, Int_t &amp;nerror, Int_t &amp;ndone)
<span class="lineNum">    2452 </span>            : {
<span class="lineNum">    2453 </span>            : // Get job status for all jobs with jobid&gt;jobidstart.
<span class="lineNum">    2454 </span>            :    static char mstatus[20];
<span class="lineNum">    2455 </span><span class="lineNoCov">          0 :    mstatus[0] = '\0';</span>
<span class="lineNum">    2456 </span><span class="lineNoCov">          0 :    nrunning = 0;</span>
<span class="lineNum">    2457 </span><span class="lineNoCov">          0 :    nwaiting = 0;</span>
<span class="lineNum">    2458 </span><span class="lineNoCov">          0 :    nerror   = 0;</span>
<span class="lineNum">    2459 </span><span class="lineNoCov">          0 :    ndone    = 0;</span>
<span class="lineNum">    2460 </span><span class="lineNoCov">          0 :    TGridJobStatusList *list = gGrid-&gt;Ps(&quot;&quot;);</span>
<span class="lineNum">    2461 </span><span class="lineNoCov">          0 :    if (!list) return mstatus;</span>
<span class="lineNum">    2462 </span><span class="lineNoCov">          0 :    Int_t nentries = list-&gt;GetSize();</span>
<span class="lineNum">    2463 </span>            :    TGridJobStatus *status;
<span class="lineNum">    2464 </span>            :    Int_t pid;
<span class="lineNum">    2465 </span><span class="lineNoCov">          0 :    for (Int_t ijob=0; ijob&lt;nentries; ijob++) {</span>
<span class="lineNum">    2466 </span><span class="lineNoCov">          0 :       status = (TGridJobStatus *)list-&gt;At(ijob);</span>
<span class="lineNum">    2467 </span><span class="lineNoCov">          0 :       pid = gROOT-&gt;ProcessLine(Form(&quot;atoi(((TAlienJobStatus*)%p)-&gt;GetKey(\&quot;queueId\&quot;));&quot;, status));</span>
<span class="lineNum">    2468 </span><span class="lineNoCov">          0 :       if (pid&lt;jobidstart) continue;</span>
<span class="lineNum">    2469 </span><span class="lineNoCov">          0 :       if (pid == lastid) {</span>
<span class="lineNum">    2470 </span><span class="lineNoCov">          0 :          gROOT-&gt;ProcessLine(Form(&quot;sprintf((char*)%p,((TAlienJobStatus*)%p)-&gt;GetKey(\&quot;status\&quot;));&quot;,mstatus, status));</span>
<span class="lineNum">    2471 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    2472 </span><span class="lineNoCov">          0 :       switch (status-&gt;GetStatus()) {</span>
<span class="lineNum">    2473 </span>            :          case TGridJobStatus::kWAITING:
<span class="lineNum">    2474 </span><span class="lineNoCov">          0 :             nwaiting++; break;</span>
<span class="lineNum">    2475 </span>            :          case TGridJobStatus::kRUNNING:
<span class="lineNum">    2476 </span><span class="lineNoCov">          0 :             nrunning++; break;</span>
<span class="lineNum">    2477 </span>            :          case TGridJobStatus::kABORTED:
<span class="lineNum">    2478 </span>            :          case TGridJobStatus::kFAIL:
<span class="lineNum">    2479 </span>            :          case TGridJobStatus::kUNKNOWN:
<span class="lineNum">    2480 </span><span class="lineNoCov">          0 :             nerror++; break;</span>
<span class="lineNum">    2481 </span>            :          case TGridJobStatus::kDONE:
<span class="lineNum">    2482 </span><span class="lineNoCov">          0 :             ndone++;</span>
<span class="lineNum">    2483 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    2484 </span>            :    }
<span class="lineNum">    2485 </span><span class="lineNoCov">          0 :    list-&gt;Delete();</span>
<span class="lineNum">    2486 </span><span class="lineNoCov">          0 :    delete list;</span>
<span class="lineNum">    2487 </span>            :    return mstatus;
<span class="lineNum">    2488 </span><span class="lineNoCov">          0 : }</span>
<a name="2489"><span class="lineNum">    2489 </span>            : </a>
<span class="lineNum">    2490 </span>            : //______________________________________________________________________________
<span class="lineNum">    2491 </span>            : Bool_t AliAnalysisAlien::IsCollection(const char *lfn) const
<span class="lineNum">    2492 </span>            : {
<span class="lineNum">    2493 </span>            : // Returns true if file is a collection. Functionality duplicated from
<span class="lineNum">    2494 </span>            : // TAlien::Type() because we don't want to directly depend on TAlien.
<span class="lineNum">    2495 </span><span class="lineNoCov">          0 :    if (!gGrid) {</span>
<span class="lineNum">    2496 </span><span class="lineNoCov">          0 :       Error(&quot;IsCollection&quot;, &quot;No connection to grid&quot;);</span>
<span class="lineNum">    2497 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2498 </span>            :    }
<span class="lineNum">    2499 </span><span class="lineNoCov">          0 :    TGridResult *res = gGrid-&gt;Command(Form(&quot;type -z %s&quot;,lfn),kFALSE);</span>
<span class="lineNum">    2500 </span><span class="lineNoCov">          0 :    if (!res) return kFALSE;</span>
<span class="lineNum">    2501 </span><span class="lineNoCov">          0 :    const char* typeStr = res-&gt;GetKey(0, &quot;type&quot;);</span>
<span class="lineNum">    2502 </span><span class="lineNoCov">          0 :    if (!typeStr || !strlen(typeStr)) return kFALSE;</span>
<span class="lineNum">    2503 </span><span class="lineNoCov">          0 :    if (!strcmp(typeStr, &quot;collection&quot;)) return kTRUE;</span>
<span class="lineNum">    2504 </span><span class="lineNoCov">          0 :    delete res;</span>
<span class="lineNum">    2505 </span><span class="lineNoCov">          0 :    return kFALSE;</span>
<span class="lineNum">    2506 </span><span class="lineNoCov">          0 : }   </span>
<a name="2507"><span class="lineNum">    2507 </span>            : </a>
<span class="lineNum">    2508 </span>            : //______________________________________________________________________________
<span class="lineNum">    2509 </span>            : Bool_t AliAnalysisAlien::IsSingleOutput() const
<span class="lineNum">    2510 </span>            : {
<span class="lineNum">    2511 </span>            : // Check if single-ouput option is on.
<span class="lineNum">    2512 </span><span class="lineNoCov">          0 :    return (!fOutputSingle.IsNull());</span>
<span class="lineNum">    2513 </span>            : }
<a name="2514"><span class="lineNum">    2514 </span>            : </a>
<span class="lineNum">    2515 </span>            : //______________________________________________________________________________
<span class="lineNum">    2516 </span>            : Long64_t AliAnalysisAlien::RunMacroAndExtractLibs(const char* macro, const char *args, TString &amp;libs)
<span class="lineNum">    2517 </span>            : {
<span class="lineNum">    2518 </span>            : // Tries to run the specified macro and return the libraries that it loads.
<span class="lineNum">    2519 </span><span class="lineNoCov">          0 :    TString expname;</span>
<span class="lineNum">    2520 </span><span class="lineNoCov">          0 :    if (strlen(macro)) expname = gSystem-&gt;ExpandPathName(macro);</span>
<span class="lineNum">    2521 </span><span class="lineNoCov">          0 :    if (expname.IsNull() || gSystem-&gt;AccessPathName(expname)) {</span>
<span class="lineNum">    2522 </span><span class="lineNoCov">          0 :       ::Error(&quot;RunMacroAndExtractLibs&quot;,&quot;Cannot find macro %s in current directory&quot;, macro);</span>
<span class="lineNum">    2523 </span><span class="lineNoCov">          0 :       return -1;</span>
<span class="lineNum">    2524 </span>            :    }   
<span class="lineNum">    2525 </span><span class="lineNoCov">          0 :    TString oldlibs = gSystem-&gt;GetLibraries();</span>
<span class="lineNum">    2526 </span><span class="lineNoCov">          0 :    TMacro m(expname);</span>
<span class="lineNum">    2527 </span><span class="lineNoCov">          0 :    Int_t error = 0;</span>
<span class="lineNum">    2528 </span><span class="lineNoCov">          0 :    Long64_t retval = m.Exec(args, &amp;error);</span>
<span class="lineNum">    2529 </span><span class="lineNoCov">          0 :    if (error != TInterpreter::kNoError)</span>
<span class="lineNum">    2530 </span>            :    {
<span class="lineNum">    2531 </span><span class="lineNoCov">          0 :       ::Error(&quot;RunMacroAndExtractLibs&quot;, &quot;Macro interpretation %s failed&quot;, macro);</span>
<span class="lineNum">    2532 </span><span class="lineNoCov">          0 :       return -1;</span>
<span class="lineNum">    2533 </span>            :    }
<span class="lineNum">    2534 </span><span class="lineNoCov">          0 :    libs = gSystem-&gt;GetLibraries();</span>
<span class="lineNum">    2535 </span><span class="lineNoCov">          0 :    libs.ReplaceAll(oldlibs, &quot;&quot;);</span>
<span class="lineNum">    2536 </span><span class="lineNoCov">          0 :    libs.Strip(TString::kLeading);</span>
<span class="lineNum">    2537 </span><span class="lineNoCov">          0 :    TObjArray *libTokens = libs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    2538 </span><span class="lineNoCov">          0 :    libs = &quot;&quot;;</span>
<span class="lineNum">    2539 </span><span class="lineNoCov">          0 :    for (Int_t i=0; i&lt;libTokens-&gt;GetEntries(); i++) {</span>
<span class="lineNum">    2540 </span><span class="lineNoCov">          0 :      if (!libs.IsNull()) libs += &quot; &quot;;</span>
<span class="lineNum">    2541 </span><span class="lineNoCov">          0 :      libs += gSystem-&gt;BaseName(libTokens-&gt;At(i)-&gt;GetName());</span>
<span class="lineNum">    2542 </span>            :    }
<span class="lineNum">    2543 </span><span class="lineNoCov">          0 :    delete libTokens;</span>
<span class="lineNum">    2544 </span>            :    return retval;
<span class="lineNum">    2545 </span><span class="lineNoCov">          0 : }   </span>
<a name="2546"><span class="lineNum">    2546 </span>            :       </a>
<span class="lineNum">    2547 </span>            : //______________________________________________________________________________
<span class="lineNum">    2548 </span>            : void AliAnalysisAlien::Print(Option_t *) const
<span class="lineNum">    2549 </span>            : {
<span class="lineNum">    2550 </span>            : // Print current plugin settings.
<span class="lineNum">    2551 </span><span class="lineNoCov">          0 :    printf(&quot;### AliEn analysis plugin current settings ###\n&quot;);</span>
<span class="lineNum">    2552 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">    2553 </span><span class="lineNoCov">          0 :    if (mgr &amp;&amp; mgr-&gt;IsProofMode()) {</span>
<span class="lineNum">    2554 </span><span class="lineNoCov">          0 :       TString proofType = &quot;=   PLUGIN IN PROOF MODE ON CLUSTER:_________________&quot;;</span>
<span class="lineNum">    2555 </span><span class="lineNoCov">          0 :       if (TestBit(AliAnalysisGrid::kTest))</span>
<span class="lineNum">    2556 </span><span class="lineNoCov">          0 :          proofType = &quot;=   PLUGIN IN PROOF LITE MODE ON CLUSTER:____________&quot;;</span>
<span class="lineNum">    2557 </span><span class="lineNoCov">          0 :       printf(&quot;%s %s\n&quot;, proofType.Data(), fProofCluster.Data());</span>
<span class="lineNum">    2558 </span><span class="lineNoCov">          0 :       if (!fProofDataSet.IsNull())</span>
<span class="lineNum">    2559 </span><span class="lineNoCov">          0 :       printf(&quot;=   Requested data set:___________________________ %s\n&quot;, fProofDataSet.Data());</span>
<span class="lineNum">    2560 </span><span class="lineNoCov">          0 :       if (fProofReset==1)</span>
<span class="lineNum">    2561 </span><span class="lineNoCov">          0 :       printf(&quot;=   Soft reset signal will be send to master______ CHANGE BEHAVIOR AFTER COMPLETION\n&quot;);      </span>
<span class="lineNum">    2562 </span><span class="lineNoCov">          0 :       if (fProofReset&gt;1)   </span>
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 :       printf(&quot;=   Hard reset signal will be send to master______ CHANGE BEHAVIOR AFTER COMPLETION\n&quot;);      </span>
<span class="lineNum">    2564 </span><span class="lineNoCov">          0 :       if (!fROOTVersion.IsNull())</span>
<span class="lineNum">    2565 </span><span class="lineNoCov">          0 :       printf(&quot;=   ROOT version requested________________________ %s\n&quot;, fROOTVersion.Data());</span>
<span class="lineNum">    2566 </span>            :       else
<span class="lineNum">    2567 </span><span class="lineNoCov">          0 :       printf(&quot;=   ROOT version requested________________________ default\n&quot;);</span>
<span class="lineNum">    2568 </span><span class="lineNoCov">          0 :       printf(&quot;=   AliRoot version requested_____________________ %s\n&quot;, fAliROOTVersion.Data());</span>
<span class="lineNum">    2569 </span><span class="lineNoCov">          0 :       printf(&quot;=   AliPhysics version requested__________________ %s\n&quot;, fAliPhysicsVersion.Data());</span>
<span class="lineNum">    2570 </span><span class="lineNoCov">          0 :       if (!fAliRootMode.IsNull())</span>
<span class="lineNum">    2571 </span><span class="lineNoCov">          0 :       printf(&quot;=   Requested AliRoot mode________________________ %s\n&quot;, fAliRootMode.Data());  </span>
<span class="lineNum">    2572 </span><span class="lineNoCov">          0 :       if (fNproofWorkers)</span>
<span class="lineNum">    2573 </span><span class="lineNoCov">          0 :       printf(&quot;=   Number of PROOF workers limited to____________ %d\n&quot;, fNproofWorkers);</span>
<span class="lineNum">    2574 </span><span class="lineNoCov">          0 :       if  (fNproofWorkersPerSlave)</span>
<span class="lineNum">    2575 </span><span class="lineNoCov">          0 :       printf(&quot;=   Maximum number of workers per slave___________ %d\n&quot;, fNproofWorkersPerSlave);</span>
<span class="lineNum">    2576 </span><span class="lineNoCov">          0 :       if (TestSpecialBit(kClearPackages))</span>
<span class="lineNum">    2577 </span><span class="lineNoCov">          0 :       printf(&quot;=   ClearPackages requested...\n&quot;);</span>
<span class="lineNum">    2578 </span><span class="lineNoCov">          0 :       if (fIncludePath.Data())</span>
<span class="lineNum">    2579 </span><span class="lineNoCov">          0 :       printf(&quot;=   Include path for runtime task compilation: ___ %s\n&quot;, fIncludePath.Data());</span>
<span class="lineNum">    2580 </span><span class="lineNoCov">          0 :       printf(&quot;=   Additional libs to be loaded or souces to be compiled runtime: &lt;%s&gt;\n&quot;,fAdditionalLibs.Data());</span>
<span class="lineNum">    2581 </span><span class="lineNoCov">          0 :       if (fPackages &amp;&amp; fPackages-&gt;GetEntries()) {</span>
<span class="lineNum">    2582 </span><span class="lineNoCov">          0 :          TIter next(fPackages);</span>
<span class="lineNum">    2583 </span>            :          TObject *obj;
<span class="lineNum">    2584 </span><span class="lineNoCov">          0 :          TString list;</span>
<span class="lineNum">    2585 </span><span class="lineNoCov">          0 :          while ((obj=next())) list += obj-&gt;GetName();</span>
<span class="lineNum">    2586 </span><span class="lineNoCov">          0 :          printf(&quot;=   Par files to be used: ________________________ %s\n&quot;, list.Data());</span>
<span class="lineNum">    2587 </span><span class="lineNoCov">          0 :       } </span>
<span class="lineNum">    2588 </span><span class="lineNoCov">          0 :       if (TestSpecialBit(kProofConnectGrid))</span>
<span class="lineNum">    2589 </span><span class="lineNoCov">          0 :       printf(&quot;=   Requested PROOF connection to grid\n&quot;);</span>
<span class="lineNum">    2590 </span>            :       return;
<span class="lineNum">    2591 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2592 </span><span class="lineNoCov">          0 :    printf(&quot;=   OverwriteMode:________________________________ %d\n&quot;, fOverwriteMode);</span>
<span class="lineNum">    2593 </span><span class="lineNoCov">          0 :    if (fOverwriteMode) {</span>
<span class="lineNum">    2594 </span><span class="lineNoCov">          0 :       printf(&quot;***** NOTE: Overwrite mode will overwrite the input generated datasets and partial results from previous analysis. \</span>
<span class="lineNum">    2595 </span>            :             \n*****       To disable, use: plugin-&gt;SetOverwriteMode(kFALSE);\n&quot;);
<span class="lineNum">    2596 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2597 </span><span class="lineNoCov">          0 :    printf(&quot;=   Copy files to grid: __________________________ %s\n&quot;, (IsUseCopy())?&quot;YES&quot;:&quot;NO&quot;);</span>
<span class="lineNum">    2598 </span><span class="lineNoCov">          0 :    printf(&quot;=   Check if files can be copied to grid: ________ %s\n&quot;, (IsCheckCopy())?&quot;YES&quot;:&quot;NO:Print&quot;);</span>
<span class="lineNum">    2599 </span><span class="lineNoCov">          0 :    printf(&quot;=   Production mode:______________________________ %d\n&quot;, fProductionMode);</span>
<span class="lineNum">    2600 </span><span class="lineNoCov">          0 :    printf(&quot;=   Version of API requested: ____________________ %s\n&quot;, fAPIVersion.Data());</span>
<span class="lineNum">    2601 </span><span class="lineNoCov">          0 :    printf(&quot;=   Version of ROOT requested: ___________________ %s\n&quot;, fROOTVersion.Data());</span>
<span class="lineNum">    2602 </span><span class="lineNoCov">          0 :    printf(&quot;=   Version of AliRoot requested: ________________ %s\n&quot;, fAliROOTVersion.Data());</span>
<span class="lineNum">    2603 </span><span class="lineNoCov">          0 :    printf(&quot;=   Version of AliPhysics requested: _____________ %s\n&quot;, fAliPhysicsVersion.Data());</span>
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 :    if (fUser.Length()) </span>
<span class="lineNum">    2605 </span><span class="lineNoCov">          0 :    printf(&quot;=   User running the plugin: _____________________ %s\n&quot;, fUser.Data());</span>
<span class="lineNum">    2606 </span><span class="lineNoCov">          0 :    printf(&quot;=   Grid workdir relative to user $HOME: _________ %s\n&quot;, fGridWorkingDir.Data());</span>
<span class="lineNum">    2607 </span><span class="lineNoCov">          0 :    printf(&quot;=   Grid output directory relative to workdir: ___ %s\n&quot;, fGridOutputDir.Data());</span>
<span class="lineNum">    2608 </span><span class="lineNoCov">          0 :    TString basedatadir = fGridDataDir;</span>
<span class="lineNum">    2609 </span><span class="lineNoCov">          0 :    TString pattern = fDataPattern;</span>
<span class="lineNum">    2610 </span><span class="lineNoCov">          0 :    pattern.Strip();</span>
<span class="lineNum">    2611 </span><span class="lineNoCov">          0 :    Int_t ind = pattern.Index(&quot; &quot;);</span>
<span class="lineNum">    2612 </span><span class="lineNoCov">          0 :    if (ind&gt;=0) {</span>
<span class="lineNum">    2613 </span><span class="lineNoCov">          0 :       basedatadir += &quot;/%run%/&quot;;</span>
<span class="lineNum">    2614 </span><span class="lineNoCov">          0 :       basedatadir += pattern(0, ind);</span>
<span class="lineNum">    2615 </span><span class="lineNoCov">          0 :       pattern = pattern(ind+1, pattern.Length());</span>
<span class="lineNum">    2616 </span>            :    }   
<span class="lineNum">    2617 </span><span class="lineNoCov">          0 :    printf(&quot;=   Data base directory path requested: __________ %s\n&quot;, basedatadir.Data());</span>
<span class="lineNum">    2618 </span><span class="lineNoCov">          0 :    printf(&quot;=   Data search pattern: _________________________ %s\n&quot;, pattern.Data());</span>
<span class="lineNum">    2619 </span><span class="lineNoCov">          0 :    printf(&quot;=   Input data format: ___________________________ %s\n&quot;, fInputFormat.Data());</span>
<span class="lineNum">    2620 </span><span class="lineNoCov">          0 :    if (fRunNumbers.Length()) </span>
<span class="lineNum">    2621 </span><span class="lineNoCov">          0 :    printf(&quot;=   Run numbers to be processed: _________________ %s\n&quot;, fRunNumbers.Data());</span>
<span class="lineNum">    2622 </span><span class="lineNoCov">          0 :    if (fRunRange[0])</span>
<span class="lineNum">    2623 </span><span class="lineNoCov">          0 :    printf(&quot;=   Run range to be processed: ___________________ %d-%d\n&quot;, fRunRange[0], fRunRange[1]);</span>
<span class="lineNum">    2624 </span><span class="lineNoCov">          0 :    if (!fRunRange[0] &amp;&amp; !fRunNumbers.Length()) {</span>
<span class="lineNum">    2625 </span><span class="lineNoCov">          0 :       TIter next(fInputFiles);</span>
<span class="lineNum">    2626 </span>            :       TObject *obj;
<span class="lineNum">    2627 </span><span class="lineNoCov">          0 :       TString list;</span>
<span class="lineNum">    2628 </span><span class="lineNoCov">          0 :       while ((obj=next())) list += obj-&gt;GetName();</span>
<span class="lineNum">    2629 </span><span class="lineNoCov">          0 :       printf(&quot;=   Input files to be processed: _________________ %s\n&quot;, list.Data());</span>
<span class="lineNum">    2630 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2631 </span><span class="lineNoCov">          0 :    if (TestBit(AliAnalysisGrid::kTest))</span>
<span class="lineNum">    2632 </span><span class="lineNoCov">          0 :    printf(&quot;=   Number of input files used in test mode: _____ %d\n&quot;, fNtestFiles);</span>
<span class="lineNum">    2633 </span><span class="lineNoCov">          0 :    printf(&quot;=   List of output files to be registered: _______ %s\n&quot;, fOutputFiles.Data());</span>
<span class="lineNum">    2634 </span><span class="lineNoCov">          0 :    printf(&quot;=   List of outputs going to be archived: ________ %s\n&quot;, fOutputArchive.Data());</span>
<span class="lineNum">    2635 </span><span class="lineNoCov">          0 :    printf(&quot;=   List of outputs that should not be merged: ___ %s\n&quot;, fMergeExcludes.Data());</span>
<span class="lineNum">    2636 </span><span class="lineNoCov">          0 :    printf(&quot;=   List of outputs that should not be registered: %s\n&quot;, fRegisterExcludes.Data());</span>
<span class="lineNum">    2637 </span><span class="lineNoCov">          0 :    printf(&quot;=   List of outputs produced during Terminate: ___ %s\n&quot;, fTerminateFiles.Data());</span>
<span class="lineNum">    2638 </span><span class="lineNoCov">          0 :    printf(&quot;=====================================================================\n&quot;);</span>
<span class="lineNum">    2639 </span><span class="lineNoCov">          0 :    printf(&quot;=   Job price: ___________________________________ %d\n&quot;, fPrice);</span>
<span class="lineNum">    2640 </span><span class="lineNoCov">          0 :    printf(&quot;=   Time to live (TTL): __________________________ %d\n&quot;, fTTL);</span>
<span class="lineNum">    2641 </span><span class="lineNoCov">          0 :    printf(&quot;=   Max files per subjob: ________________________ %d\n&quot;, fSplitMaxInputFileNumber);</span>
<span class="lineNum">    2642 </span><span class="lineNoCov">          0 :    if (fMaxInitFailed&gt;0) </span>
<span class="lineNum">    2643 </span><span class="lineNoCov">          0 :    printf(&quot;=   Max number of subjob fails to kill: __________ %d\n&quot;, fMaxInitFailed);</span>
<span class="lineNum">    2644 </span><span class="lineNoCov">          0 :    if (fMasterResubmitThreshold&gt;0) </span>
<span class="lineNum">    2645 </span><span class="lineNoCov">          0 :    printf(&quot;=   Resubmit master job if failed subjobs &gt;_______ %d\n&quot;, fMasterResubmitThreshold);</span>
<span class="lineNum">    2646 </span><span class="lineNoCov">          0 :    printf(&quot;=   Number of replicas for the output files_______ %d\n&quot;, fNreplicas);</span>
<span class="lineNum">    2647 </span><span class="lineNoCov">          0 :    if (fNrunsPerMaster&gt;0)</span>
<span class="lineNum">    2648 </span><span class="lineNoCov">          0 :    printf(&quot;=   Number of runs per master job: _______________ %d\n&quot;, fNrunsPerMaster);</span>
<span class="lineNum">    2649 </span><span class="lineNoCov">          0 :    printf(&quot;=   Number of files in one chunk to be merged: ___ %d\n&quot;, fMaxMergeFiles);</span>
<span class="lineNum">    2650 </span><span class="lineNoCov">          0 :    printf(&quot;=   Name of the generated execution script: ______ %s\n&quot;, fExecutable.Data());</span>
<span class="lineNum">    2651 </span><span class="lineNoCov">          0 :    printf(&quot;=   Executable command: __________________________ %s\n&quot;, fExecutableCommand.Data());</span>
<span class="lineNum">    2652 </span><span class="lineNoCov">          0 :    if (fArguments.Length()) </span>
<span class="lineNum">    2653 </span><span class="lineNoCov">          0 :    printf(&quot;=   Arguments for the execution script: __________ %s\n&quot;,fArguments.Data());</span>
<span class="lineNum">    2654 </span><span class="lineNoCov">          0 :    if (fExecutableArgs.Length()) </span>
<span class="lineNum">    2655 </span><span class="lineNoCov">          0 :    printf(&quot;=   Arguments after macro name in executable______ %s\n&quot;,fExecutableArgs.Data());</span>
<span class="lineNum">    2656 </span><span class="lineNoCov">          0 :    printf(&quot;=   Name of the generated analysis macro: ________ %s\n&quot;,fAnalysisMacro.Data());</span>
<span class="lineNum">    2657 </span><span class="lineNoCov">          0 :    printf(&quot;=   User analysis files to be deployed: __________ %s\n&quot;,fAnalysisSource.Data());</span>
<span class="lineNum">    2658 </span><span class="lineNoCov">          0 :    printf(&quot;=   Additional libs to be loaded or souces to be compiled runtime: &lt;%s&gt;\n&quot;,fAdditionalLibs.Data());</span>
<span class="lineNum">    2659 </span><span class="lineNoCov">          0 :    printf(&quot;=   Master jobs split mode: ______________________ %s\n&quot;,fSplitMode.Data());</span>
<span class="lineNum">    2660 </span><span class="lineNoCov">          0 :    if (fDatasetName)</span>
<span class="lineNum">    2661 </span><span class="lineNoCov">          0 :    printf(&quot;=   Custom name for the dataset to be created: ___ %s\n&quot;, fDatasetName.Data());</span>
<span class="lineNum">    2662 </span><span class="lineNoCov">          0 :    printf(&quot;=   Name of the generated JDL: ___________________ %s\n&quot;, fJDLName.Data());</span>
<span class="lineNum">    2663 </span><span class="lineNoCov">          0 :    if (fIncludePath.Data())</span>
<span class="lineNum">    2664 </span><span class="lineNoCov">          0 :    printf(&quot;=   Include path for runtime task compilation: ___ %s\n&quot;, fIncludePath.Data());</span>
<span class="lineNum">    2665 </span><span class="lineNoCov">          0 :    if (fCloseSE.Length())</span>
<span class="lineNum">    2666 </span><span class="lineNoCov">          0 :    printf(&quot;=   Force job outputs to storage element: ________ %s\n&quot;, fCloseSE.Data());</span>
<span class="lineNum">    2667 </span><span class="lineNoCov">          0 :    if (fFriendChainName.Length())</span>
<span class="lineNum">    2668 </span><span class="lineNoCov">          0 :    printf(&quot;=   Open friend chain file on worker: ____________ %s\n&quot;, fFriendChainName.Data());</span>
<span class="lineNum">    2669 </span><span class="lineNoCov">          0 :    if (fPackages &amp;&amp; fPackages-&gt;GetEntries()) {</span>
<span class="lineNum">    2670 </span><span class="lineNoCov">          0 :       TIter next(fPackages);</span>
<span class="lineNum">    2671 </span>            :       TObject *obj;
<span class="lineNum">    2672 </span><span class="lineNoCov">          0 :       TString list;</span>
<span class="lineNum">    2673 </span><span class="lineNoCov">          0 :       while ((obj=next())) list += obj-&gt;GetName();</span>
<span class="lineNum">    2674 </span><span class="lineNoCov">          0 :       printf(&quot;=   Par files to be used: ________________________ %s\n&quot;, list.Data());</span>
<span class="lineNum">    2675 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    2676 </span><span class="lineNoCov">          0 : }</span>
<a name="2677"><span class="lineNum">    2677 </span>            : </a>
<span class="lineNum">    2678 </span>            : //______________________________________________________________________________
<span class="lineNum">    2679 </span>            : void AliAnalysisAlien::SetDefaults()
<span class="lineNum">    2680 </span>            : {
<span class="lineNum">    2681 </span>            : // Set default values for everything. What cannot be filled will be left empty.
<span class="lineNum">    2682 </span><span class="lineNoCov">          0 :    if (fGridJDL) delete fGridJDL;</span>
<span class="lineNum">    2683 </span><span class="lineNoCov">          0 :    fGridJDL = (TGridJDL*)gROOT-&gt;ProcessLine(&quot;new TAlienJDL()&quot;);</span>
<span class="lineNum">    2684 </span><span class="lineNoCov">          0 :    fMergingJDL = (TGridJDL*)gROOT-&gt;ProcessLine(&quot;new TAlienJDL()&quot;);</span>
<span class="lineNum">    2685 </span><span class="lineNoCov">          0 :    fPrice                      = 1;</span>
<span class="lineNum">    2686 </span><span class="lineNoCov">          0 :    fTTL                        = 30000;</span>
<span class="lineNum">    2687 </span><span class="lineNoCov">          0 :    fSplitMaxInputFileNumber    = 100;</span>
<span class="lineNum">    2688 </span><span class="lineNoCov">          0 :    fMaxInitFailed              = 0;</span>
<span class="lineNum">    2689 </span><span class="lineNoCov">          0 :    fMasterResubmitThreshold    = 0;</span>
<span class="lineNum">    2690 </span><span class="lineNoCov">          0 :    fNtestFiles                 = 10;</span>
<span class="lineNum">    2691 </span><span class="lineNoCov">          0 :    fNreplicas                  = 2;</span>
<span class="lineNum">    2692 </span><span class="lineNoCov">          0 :    fRunRange[0]                = 0;</span>
<span class="lineNum">    2693 </span><span class="lineNoCov">          0 :    fRunRange[1]                = 0;</span>
<span class="lineNum">    2694 </span><span class="lineNoCov">          0 :    fRunPrefix                  = &quot;%d&quot;;</span>
<span class="lineNum">    2695 </span><span class="lineNoCov">          0 :    fNrunsPerMaster             = 1;</span>
<span class="lineNum">    2696 </span><span class="lineNoCov">          0 :    fMaxMergeFiles              = 100;</span>
<span class="lineNum">    2697 </span><span class="lineNoCov">          0 :    fRunNumbers                 = &quot;&quot;;</span>
<span class="lineNum">    2698 </span><span class="lineNoCov">          0 :    fExecutable                 = &quot;analysis.sh&quot;;</span>
<span class="lineNum">    2699 </span><span class="lineNoCov">          0 :    fExecutableCommand          = &quot;root -b -q -x&quot;;</span>
<span class="lineNum">    2700 </span><span class="lineNoCov">          0 :    fArguments                  = &quot;&quot;;</span>
<span class="lineNum">    2701 </span><span class="lineNoCov">          0 :    fExecutableArgs             = &quot;&quot;;</span>
<span class="lineNum">    2702 </span><span class="lineNoCov">          0 :    fAnalysisMacro              = &quot;myAnalysis.C&quot;;</span>
<span class="lineNum">    2703 </span><span class="lineNoCov">          0 :    fAnalysisSource             = &quot;&quot;;</span>
<span class="lineNum">    2704 </span><span class="lineNoCov">          0 :    fAdditionalLibs             = &quot;&quot;;</span>
<span class="lineNum">    2705 </span><span class="lineNoCov">          0 :    fSplitMode                  = &quot;se&quot;;</span>
<span class="lineNum">    2706 </span><span class="lineNoCov">          0 :    fAPIVersion                 = &quot;&quot;;</span>
<span class="lineNum">    2707 </span><span class="lineNoCov">          0 :    fROOTVersion                = &quot;&quot;;</span>
<span class="lineNum">    2708 </span><span class="lineNoCov">          0 :    fAliROOTVersion             = &quot;&quot;;</span>
<span class="lineNum">    2709 </span><span class="lineNoCov">          0 :    fAliPhysicsVersion          = &quot;&quot;;</span>
<span class="lineNum">    2710 </span><span class="lineNoCov">          0 :    fUser                       = &quot;&quot;;  // Your alien user name</span>
<span class="lineNum">    2711 </span><span class="lineNoCov">          0 :    fGridWorkingDir             = &quot;&quot;;</span>
<span class="lineNum">    2712 </span><span class="lineNoCov">          0 :    fGridDataDir                = &quot;&quot;;  // Can be like: /alice/sim/PDC_08a/LHC08c9/</span>
<span class="lineNum">    2713 </span><span class="lineNoCov">          0 :    fDataPattern                = &quot;*AliESDs.root&quot;;  // Can be like: *AliESDs.root, */pass1/*AliESDs.root, ...</span>
<span class="lineNum">    2714 </span><span class="lineNoCov">          0 :    fFriendChainName            = &quot;&quot;;</span>
<span class="lineNum">    2715 </span><span class="lineNoCov">          0 :    fGridOutputDir              = &quot;output&quot;;</span>
<span class="lineNum">    2716 </span><span class="lineNoCov">          0 :    fOutputArchive              = &quot;log_archive.zip:std*@disk=1 root_archive.zip:*.root@disk=2&quot;;</span>
<span class="lineNum">    2717 </span><span class="lineNoCov">          0 :    fOutputFiles                = &quot;&quot;;  // Like &quot;AliAODs.root histos.root&quot;</span>
<span class="lineNum">    2718 </span><span class="lineNoCov">          0 :    fInputFormat                = &quot;xml-single&quot;;</span>
<span class="lineNum">    2719 </span><span class="lineNoCov">          0 :    fJDLName                    = &quot;analysis.jdl&quot;;</span>
<span class="lineNum">    2720 </span><span class="lineNoCov">          0 :    fJobTag                     = &quot;Automatically generated analysis JDL&quot;;</span>
<span class="lineNum">    2721 </span><span class="lineNoCov">          0 :    fMergeExcludes              = &quot;&quot;;</span>
<span class="lineNum">    2722 </span><span class="lineNoCov">          0 :    fMergeViaJDL                = 0;</span>
<span class="lineNum">    2723 </span><span class="lineNoCov">          0 :    SetUseCopy(kTRUE);</span>
<span class="lineNum">    2724 </span><span class="lineNoCov">          0 :    SetCheckCopy(kTRUE);</span>
<span class="lineNum">    2725 </span><span class="lineNoCov">          0 :    SetDefaultOutputs(kTRUE);</span>
<span class="lineNum">    2726 </span><span class="lineNoCov">          0 :    fOverwriteMode              = 1;</span>
<span class="lineNum">    2727 </span><span class="lineNoCov">          0 : }   </span>
<a name="2728"><span class="lineNum">    2728 </span>            : </a>
<span class="lineNum">    2729 </span>            : //______________________________________________________________________________
<span class="lineNum">    2730 </span>            : void AliAnalysisAlien::SetFriendChainName(const char *name, const char *libnames)
<span class="lineNum">    2731 </span>            : {
<span class="lineNum">    2732 </span>            :    // Set file name for the chain of friends and optionally additional libs to be loaded.
<span class="lineNum">    2733 </span>            :    // Libs should be separated by blancs.
<span class="lineNum">    2734 </span><span class="lineNoCov">          0 :    fFriendChainName = name;</span>
<span class="lineNum">    2735 </span><span class="lineNoCov">          0 :    fFriendChainName.ReplaceAll(&quot;,&quot;, &quot; &quot;);</span>
<span class="lineNum">    2736 </span><span class="lineNoCov">          0 :    fFriendChainName.Strip();</span>
<span class="lineNum">    2737 </span><span class="lineNoCov">          0 :    fFriendChainName.ReplaceAll(&quot;  &quot;, &quot; &quot;);</span>
<span class="lineNum">    2738 </span>            :    
<span class="lineNum">    2739 </span><span class="lineNoCov">          0 :    fFriendLibs = libnames;</span>
<span class="lineNum">    2740 </span><span class="lineNoCov">          0 :    if (fFriendLibs.Length()) {</span>
<span class="lineNum">    2741 </span><span class="lineNoCov">          0 :      if(!fFriendLibs.Contains(&quot;.so&quot;) &amp;&amp; </span>
<span class="lineNum">    2742 </span><span class="lineNoCov">          0 :         !fFriendLibs.Contains(&quot;.dylib&quot;))</span>
<span class="lineNum">    2743 </span><span class="lineNoCov">          0 :        Fatal(&quot;SetFriendChainName()&quot;, &quot;You should provide explicit library names (with extension)&quot;);</span>
<span class="lineNum">    2744 </span><span class="lineNoCov">          0 :      fFriendLibs.ReplaceAll(&quot;,&quot;, &quot; &quot;);</span>
<span class="lineNum">    2745 </span><span class="lineNoCov">          0 :      fFriendLibs.Strip();</span>
<span class="lineNum">    2746 </span><span class="lineNoCov">          0 :      fFriendLibs.ReplaceAll(&quot;  &quot;, &quot; &quot;);</span>
<span class="lineNum">    2747 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2748 </span><span class="lineNoCov">          0 : }</span>
<a name="2749"><span class="lineNum">    2749 </span>            : </a>
<span class="lineNum">    2750 </span>            : //______________________________________________________________________________
<span class="lineNum">    2751 </span>            : void AliAnalysisAlien::SetRootVersionForProof(const char *version)
<span class="lineNum">    2752 </span>            : {
<span class="lineNum">    2753 </span>            : // Obsolete method. Use SetROOTVersion instead
<span class="lineNum">    2754 </span><span class="lineNoCov">          0 :    Warning(&quot;SetRootVersionForProof&quot;, &quot;Obsolete. Use SetROOTVersion instead&quot;);</span>
<span class="lineNum">    2755 </span><span class="lineNoCov">          0 :    if (fROOTVersion.IsNull()) SetROOTVersion(version);</span>
<span class="lineNum">    2756 </span><span class="lineNoCov">          0 :    else Error(&quot;SetRootVersionForProof&quot;, &quot;ROOT version already set to %s&quot;, fROOTVersion.Data());</span>
<span class="lineNum">    2757 </span><span class="lineNoCov">          0 : }</span>
<a name="2758"><span class="lineNum">    2758 </span>            :    </a>
<span class="lineNum">    2759 </span>            : //______________________________________________________________________________
<span class="lineNum">    2760 </span>            : Bool_t AliAnalysisAlien::CheckMergedFiles(const char *filename, const char *aliendir, Int_t nperchunk, const char *jdl)
<span class="lineNum">    2761 </span>            : {
<span class="lineNum">    2762 </span>            : // Checks current merge stage, makes xml for the next stage, counts number of files, submits next stage.
<span class="lineNum">    2763 </span>            :    // First check if the result is already in the output directory.
<span class="lineNum">    2764 </span><span class="lineNoCov">          0 :    if (FileExists(Form(&quot;%s/%s&quot;,aliendir,filename))) {</span>
<span class="lineNum">    2765 </span><span class="lineNoCov">          0 :       printf(&quot;Final merged results found. Not merging again.\n&quot;);</span>
<span class="lineNum">    2766 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2767 </span>            :    }
<span class="lineNum">    2768 </span>            :    // Now check the last stage done.
<span class="lineNum">    2769 </span>            :    Int_t stage = 0;
<span class="lineNum">    2770 </span><span class="lineNoCov">          0 :    while (1) {</span>
<span class="lineNum">    2771 </span><span class="lineNoCov">          0 :       if (!FileExists(Form(&quot;%s/Stage_%d.xml&quot;,aliendir, stage+1))) break;</span>
<span class="lineNum">    2772 </span>            :       stage++;
<span class="lineNum">    2773 </span>            :    }
<span class="lineNum">    2774 </span>            :    // Next stage of merging
<span class="lineNum">    2775 </span>            :    stage++;
<span class="lineNum">    2776 </span><span class="lineNoCov">          0 :    TString pattern = &quot;*root_archive.zip&quot;;</span>
<span class="lineNum">    2777 </span><span class="lineNoCov">          0 :    if (stage&gt;1) pattern = Form(&quot;Stage_%d/*root_archive.zip&quot;, stage-1);</span>
<span class="lineNum">    2778 </span><span class="lineNoCov">          0 :    TGridResult *res = gGrid-&gt;Command(Form(&quot;find -x Stage_%d %s %s&quot;, stage, aliendir, pattern.Data()));</span>
<span class="lineNum">    2779 </span><span class="lineNoCov">          0 :    if (res) delete res;</span>
<span class="lineNum">    2780 </span>            :    // Write standard output to file
<span class="lineNum">    2781 </span><span class="lineNoCov">          0 :    gROOT-&gt;ProcessLine(Form(&quot;gGrid-&gt;Stdout(); &gt; %s&quot;, Form(&quot;Stage_%d.xml&quot;,stage)));</span>
<span class="lineNum">    2782 </span>            :    // Count the number of files inside
<span class="lineNum">    2783 </span><span class="lineNoCov">          0 :    ifstream ifile;</span>
<span class="lineNum">    2784 </span><span class="lineNoCov">          0 :    ifile.open(Form(&quot;Stage_%d.xml&quot;,stage));</span>
<span class="lineNum">    2785 </span><span class="lineNoCov">          0 :    if (!ifile.good()) {</span>
<span class="lineNum">    2786 </span><span class="lineNoCov">          0 :       ::Error(&quot;CheckMergedFiles&quot;, &quot;Could not redirect result of the find command to file %s&quot;, Form(&quot;Stage_%d.xml&quot;,stage));</span>
<span class="lineNum">    2787 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2788 </span>            :    }   
<span class="lineNum">    2789 </span><span class="lineNoCov">          0 :    TString line;</span>
<span class="lineNum">    2790 </span>            :    Int_t nfiles = 0;
<span class="lineNum">    2791 </span><span class="lineNoCov">          0 :    while (!ifile.eof()) {</span>
<span class="lineNum">    2792 </span><span class="lineNoCov">          0 :       ifile &gt;&gt; line;</span>
<span class="lineNum">    2793 </span><span class="lineNoCov">          0 :       if (line.Contains(&quot;/event&quot;)) nfiles++;</span>
<span class="lineNum">    2794 </span>            :    }
<span class="lineNum">    2795 </span><span class="lineNoCov">          0 :    ifile.close();</span>
<span class="lineNum">    2796 </span><span class="lineNoCov">          0 :    if (!nfiles) {</span>
<span class="lineNum">    2797 </span><span class="lineNoCov">          0 :       ::Error(&quot;CheckMergedFiles&quot;, &quot;Cannot start Stage_%d merging since Stage_%d did not produced yet output&quot;, stage, stage-1);</span>
<span class="lineNum">    2798 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2799 </span>            :    } else {
<span class="lineNum">    2800 </span><span class="lineNoCov">          0 :       printf(&quot;=== Stage_%d produced %d files\n&quot;, stage-1, nfiles);</span>
<span class="lineNum">    2801 </span>            :    }   
<span class="lineNum">    2802 </span>            :    // Copy the file in the output directory
<span class="lineNum">    2803 </span><span class="lineNoCov">          0 :    printf(&quot;===&gt; Copying collection %s in the output directory %s\n&quot;, Form(&quot;Stage_%d.xml&quot;,stage), aliendir);</span>
<span class="lineNum">    2804 </span>            : //   TFile::Cp(Form(&quot;Stage_%d.xml&quot;,stage), Form(&quot;alien://%s/Stage_%d.xml&quot;,aliendir,stage));
<span class="lineNum">    2805 </span><span class="lineNoCov">          0 :    if (!copyLocal2Alien(&quot;CheckMergedFiles&quot;, Form(&quot;Stage_%d.xml&quot;,stage), </span>
<span class="lineNum">    2806 </span><span class="lineNoCov">          0 :         Form(&quot;%s/Stage_%d.xml&quot;,aliendir,stage))) Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    2807 </span>            :    // Check if this is the last stage to be done.
<span class="lineNum">    2808 </span><span class="lineNoCov">          0 :    Bool_t laststage = (nfiles&lt;nperchunk);</span>
<span class="lineNum">    2809 </span><span class="lineNoCov">          0 :    if (fMaxMergeStages &amp;&amp; stage&gt;=fMaxMergeStages) laststage = kTRUE;</span>
<span class="lineNum">    2810 </span>            :    Int_t jobId = 0;
<span class="lineNum">    2811 </span><span class="lineNoCov">          0 :    if (laststage) {</span>
<span class="lineNum">    2812 </span><span class="lineNoCov">          0 :       printf(&quot;### Submiting final merging stage %d\n&quot;, stage);</span>
<span class="lineNum">    2813 </span><span class="lineNoCov">          0 :       TString finalJDL = jdl;</span>
<span class="lineNum">    2814 </span><span class="lineNoCov">          0 :       finalJDL.ReplaceAll(&quot;.jdl&quot;, &quot;_final.jdl&quot;);</span>
<span class="lineNum">    2815 </span><span class="lineNoCov">          0 :       TString query = Form(&quot;submit %s %s %d&quot;, finalJDL.Data(), aliendir, stage);</span>
<span class="lineNum">    2816 </span><span class="lineNoCov">          0 :       jobId = SubmitSingleJob(query);</span>
<span class="lineNum">    2817 </span><span class="lineNoCov">          0 :    } else {</span>
<span class="lineNum">    2818 </span><span class="lineNoCov">          0 :       printf(&quot;### Submiting merging stage %d\n&quot;, stage);</span>
<span class="lineNum">    2819 </span><span class="lineNoCov">          0 :       TString query = Form(&quot;submit %s %s %d&quot;, jdl, aliendir, stage);</span>
<span class="lineNum">    2820 </span><span class="lineNoCov">          0 :       jobId = SubmitSingleJob(query);</span>
<span class="lineNum">    2821 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2822 </span><span class="lineNoCov">          0 :    if (!jobId) return kFALSE;           </span>
<span class="lineNum">    2823 </span>            : 
<span class="lineNum">    2824 </span><span class="lineNoCov">          0 :    if (!fGridJobIDs.IsNull()) fGridJobIDs.Append(&quot; &quot;);</span>
<span class="lineNum">    2825 </span><span class="lineNoCov">          0 :    fGridJobIDs.Append(Form(&quot;%d&quot;, jobId));</span>
<span class="lineNum">    2826 </span><span class="lineNoCov">          0 :    if (!fGridStages.IsNull()) fGridStages.Append(&quot; &quot;);</span>
<span class="lineNum">    2827 </span><span class="lineNoCov">          0 :    fGridStages.Append(Form(&quot;%s_merge_stage%d&quot;, </span>
<span class="lineNum">    2828 </span><span class="lineNoCov">          0 :                            laststage ? &quot;final&quot; : &quot;partial&quot;, stage));</span>
<span class="lineNum">    2829 </span>            : 
<span class="lineNum">    2830 </span><span class="lineNoCov">          0 :    return kTRUE;   </span>
<span class="lineNum">    2831 </span><span class="lineNoCov">          0 : }        </span>
<a name="2832"><span class="lineNum">    2832 </span>            : </a>
<span class="lineNum">    2833 </span>            : //______________________________________________________________________________
<span class="lineNum">    2834 </span>            : AliAnalysisManager *AliAnalysisAlien::LoadAnalysisManager(const char *fname)
<span class="lineNum">    2835 </span>            : {
<span class="lineNum">    2836 </span>            : // Loat the analysis manager from a file.
<span class="lineNum">    2837 </span><span class="lineNoCov">          0 :    TFile *file = TFile::Open(fname);</span>
<span class="lineNum">    2838 </span><span class="lineNoCov">          0 :    if (!file) {</span>
<span class="lineNum">    2839 </span><span class="lineNoCov">          0 :       ::Error(&quot;LoadAnalysisManager&quot;, &quot;Cannot open file %s&quot;, fname);</span>
<span class="lineNum">    2840 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">    2841 </span>            :    }   
<span class="lineNum">    2842 </span><span class="lineNoCov">          0 :    TIter nextkey(file-&gt;GetListOfKeys());</span>
<span class="lineNum">    2843 </span>            :    AliAnalysisManager *mgr = 0;
<span class="lineNum">    2844 </span>            :    TKey *key;
<span class="lineNum">    2845 </span><span class="lineNoCov">          0 :    while ((key=(TKey*)nextkey())) {</span>
<span class="lineNum">    2846 </span><span class="lineNoCov">          0 :       if (!strcmp(key-&gt;GetClassName(), &quot;AliAnalysisManager&quot;))</span>
<span class="lineNum">    2847 </span><span class="lineNoCov">          0 :          mgr = (AliAnalysisManager*)file-&gt;Get(key-&gt;GetName());</span>
<span class="lineNum">    2848 </span>            :    }
<span class="lineNum">    2849 </span><span class="lineNoCov">          0 :    if (!mgr) </span>
<span class="lineNum">    2850 </span><span class="lineNoCov">          0 :       ::Error(&quot;LoadAnalysisManager&quot;, &quot;No analysis manager found in file %s&quot;, fname);</span>
<span class="lineNum">    2851 </span>            :    return mgr;
<span class="lineNum">    2852 </span><span class="lineNoCov">          0 : }      </span>
<a name="2853"><span class="lineNum">    2853 </span>            : </a>
<span class="lineNum">    2854 </span>            : //______________________________________________________________________________
<span class="lineNum">    2855 </span>            : Int_t AliAnalysisAlien::SubmitSingleJob(const char *query)
<span class="lineNum">    2856 </span>            : {
<span class="lineNum">    2857 </span>            : // Submits a single job corresponding to the query and returns job id. If 0 submission failed.
<span class="lineNum">    2858 </span><span class="lineNoCov">          0 :    if (!gGrid) return 0;</span>
<span class="lineNum">    2859 </span><span class="lineNoCov">          0 :    printf(&quot;=&gt; %s ------&gt; &quot;,query);</span>
<span class="lineNum">    2860 </span><span class="lineNoCov">          0 :    TGridResult *res = gGrid-&gt;Command(query);</span>
<span class="lineNum">    2861 </span><span class="lineNoCov">          0 :    if (!res) return 0;</span>
<span class="lineNum">    2862 </span><span class="lineNoCov">          0 :    TString jobId = res-&gt;GetKey(0,&quot;jobId&quot;);</span>
<span class="lineNum">    2863 </span><span class="lineNoCov">          0 :    delete res;</span>
<span class="lineNum">    2864 </span><span class="lineNoCov">          0 :    if (jobId.IsNull()) {</span>
<span class="lineNum">    2865 </span><span class="lineNoCov">          0 :       printf(&quot;submission failed. Reason:\n&quot;);</span>
<span class="lineNum">    2866 </span><span class="lineNoCov">          0 :       gGrid-&gt;Stdout();</span>
<span class="lineNum">    2867 </span><span class="lineNoCov">          0 :       gGrid-&gt;Stderr();</span>
<span class="lineNum">    2868 </span><span class="lineNoCov">          0 :       ::Error(&quot;SubmitSingleJob&quot;, &quot;Your query %s could not be submitted&quot;, query);</span>
<span class="lineNum">    2869 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">    2870 </span>            :    }
<span class="lineNum">    2871 </span><span class="lineNoCov">          0 :    Int_t ijobId = jobId.Atoi();</span>
<span class="lineNum">    2872 </span><span class="lineNoCov">          0 :    printf(&quot; Job id: '%s' (%d)\n&quot;, jobId.Data(), ijobId);</span>
<span class="lineNum">    2873 </span>            :    return ijobId; 
<span class="lineNum">    2874 </span><span class="lineNoCov">          0 : }  </span>
<a name="2875"><span class="lineNum">    2875 </span>            : </a>
<span class="lineNum">    2876 </span>            : //______________________________________________________________________________
<span class="lineNum">    2877 </span>            : Bool_t AliAnalysisAlien::MergeInfo(const char *output, const char *collection)
<span class="lineNum">    2878 </span>            : {
<span class="lineNum">    2879 </span>            : // Merges a collection of output files using concatenation.
<span class="lineNum">    2880 </span><span class="lineNoCov">          0 :    TString scoll(collection);</span>
<span class="lineNum">    2881 </span><span class="lineNoCov">          0 :    if (!scoll.Contains(&quot;.xml&quot;)) return kFALSE;</span>
<span class="lineNum">    2882 </span><span class="lineNoCov">          0 :    TGridCollection *coll = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;TAlienCollection::Open(\&quot;%s\&quot;);&quot;, collection));</span>
<span class="lineNum">    2883 </span><span class="lineNoCov">          0 :    if (!coll) {</span>
<span class="lineNum">    2884 </span><span class="lineNoCov">          0 :       ::Error(&quot;MergeInfo&quot;, &quot;Input XML %s collection empty.&quot;, collection);</span>
<span class="lineNum">    2885 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    2886 </span>            :    }
<span class="lineNum">    2887 </span>            :    // Iterate grid collection
<span class="lineNum">    2888 </span><span class="lineNoCov">          0 :    TString outtmp;</span>
<span class="lineNum">    2889 </span>            :    Bool_t merged = kFALSE;
<span class="lineNum">    2890 </span>            :    Int_t ifile = 0;
<span class="lineNum">    2891 </span><span class="lineNoCov">          0 :    while (coll-&gt;Next()) {</span>
<span class="lineNum">    2892 </span><span class="lineNoCov">          0 :       TString fname = gSystem-&gt;DirName(coll-&gt;GetTURL());</span>
<span class="lineNum">    2893 </span><span class="lineNoCov">          0 :       fname += &quot;/&quot;;</span>
<span class="lineNum">    2894 </span><span class="lineNoCov">          0 :       fname += output;</span>
<span class="lineNum">    2895 </span><span class="lineNoCov">          0 :       outtmp = Form(&quot;%d_%s&quot;, ifile, output);</span>
<span class="lineNum">    2896 </span><span class="lineNoCov">          0 :       if (!TFile::Cp(fname, outtmp)) {</span>
<span class="lineNum">    2897 </span><span class="lineNoCov">          0 :          ::Error(&quot;MergeInfo&quot;, &quot;Could not copy %s&quot;, fname.Data());</span>
<span class="lineNum">    2898 </span><span class="lineNoCov">          0 :          continue;</span>
<span class="lineNum">    2899 </span>            :       }
<span class="lineNum">    2900 </span><span class="lineNoCov">          0 :       ifile++;</span>
<span class="lineNum">    2901 </span><span class="lineNoCov">          0 :       if (ifile&lt;2) {</span>
<span class="lineNum">    2902 </span><span class="lineNoCov">          0 :          gSystem-&gt;Exec(Form(&quot;cp %s lastmerged&quot;, outtmp.Data()));</span>
<span class="lineNum">    2903 </span><span class="lineNoCov">          0 :          continue;</span>
<span class="lineNum">    2904 </span>            :       }
<span class="lineNum">    2905 </span><span class="lineNoCov">          0 :       gSystem-&gt;Exec(Form(&quot;cat lastmerged %s &gt; tempmerged&quot;, outtmp.Data()));</span>
<span class="lineNum">    2906 </span><span class="lineNoCov">          0 :       gSystem-&gt;Exec(&quot;cp tempmerged lastmerged&quot;);</span>
<span class="lineNum">    2907 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2908 </span><span class="lineNoCov">          0 :    if (ifile) {</span>
<span class="lineNum">    2909 </span><span class="lineNoCov">          0 :       gSystem-&gt;Exec(Form(&quot;cp lastmerged %s&quot;, output));</span>
<span class="lineNum">    2910 </span><span class="lineNoCov">          0 :       gSystem-&gt;Exec(Form(&quot;rm tempmerged lastmerged *_%s&quot;, output));</span>
<span class="lineNum">    2911 </span>            :       merged = kTRUE;
<span class="lineNum">    2912 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    2913 </span><span class="lineNoCov">          0 :    return merged;</span>
<span class="lineNum">    2914 </span><span class="lineNoCov">          0 : }   </span>
<a name="2915"><span class="lineNum">    2915 </span>            : </a>
<span class="lineNum">    2916 </span>            : //______________________________________________________________________________
<span class="lineNum">    2917 </span>            : Bool_t AliAnalysisAlien::MergeOutput(const char *output, const char *basedir, Int_t nmaxmerge, Int_t stage)
<span class="lineNum">    2918 </span>            : {
<span class="lineNum">    2919 </span>            : // Merge given output files from basedir. Basedir can be an alien output directory
<span class="lineNum">    2920 </span>            : // but also an xml file with root_archive.zip locations. The file merger will merge nmaxmerge
<span class="lineNum">    2921 </span>            : // files in a group (ignored for xml input). Merging can be done in stages:
<span class="lineNum">    2922 </span>            : // stage=0 : will merge all existing files in a single stage, supporting resume if run locally
<span class="lineNum">    2923 </span>            : // stage=1 : works with an xml of all root_archive.zip in the output directory
<span class="lineNum">    2924 </span>            : // stage&gt;1 : works with an xml of all root_archive.zip in the Stage_&lt;n-1&gt; directory
<span class="lineNum">    2925 </span><span class="lineNoCov">          0 :    TString outputFile = output;</span>
<span class="lineNum">    2926 </span><span class="lineNoCov">          0 :    TString command;</span>
<span class="lineNum">    2927 </span><span class="lineNoCov">          0 :    TString outputChunk;</span>
<span class="lineNum">    2928 </span><span class="lineNoCov">          0 :    TString previousChunk = &quot;&quot;;</span>
<span class="lineNum">    2929 </span><span class="lineNoCov">          0 :    TObjArray *listoffiles = new TObjArray();</span>
<span class="lineNum">    2930 </span>            : //   listoffiles-&gt;SetOwner();
<span class="lineNum">    2931 </span>            :    Int_t countChunk = 0;
<span class="lineNum">    2932 </span>            :    Int_t countZero = nmaxmerge;
<span class="lineNum">    2933 </span>            :    Bool_t merged = kTRUE;
<span class="lineNum">    2934 </span>            :    Bool_t isGrid = kTRUE;
<span class="lineNum">    2935 </span><span class="lineNoCov">          0 :    Int_t index = outputFile.Index(&quot;@&quot;);</span>
<span class="lineNum">    2936 </span><span class="lineNoCov">          0 :    if (index &gt; 0) outputFile.Remove(index);</span>
<span class="lineNum">    2937 </span><span class="lineNoCov">          0 :    TString inputFile = outputFile;</span>
<span class="lineNum">    2938 </span><span class="lineNoCov">          0 :    TString sbasedir = basedir;</span>
<span class="lineNum">    2939 </span><span class="lineNoCov">          0 :    if (sbasedir.Contains(&quot;.xml&quot;)) {</span>
<span class="lineNum">    2940 </span>            :       // Merge files pointed by the xml - ignore nmaxmerge and set ichunk to 0
<span class="lineNum">    2941 </span>            :       nmaxmerge = 9999999;
<span class="lineNum">    2942 </span><span class="lineNoCov">          0 :       TGridCollection *coll = (TGridCollection*)gROOT-&gt;ProcessLine(Form(&quot;TAlienCollection::Open(\&quot;%s\&quot;);&quot;, basedir));</span>
<span class="lineNum">    2943 </span><span class="lineNoCov">          0 :       if (!coll) {</span>
<span class="lineNum">    2944 </span><span class="lineNoCov">          0 :          ::Error(&quot;MergeOutput&quot;, &quot;Input XML collection empty.&quot;);</span>
<span class="lineNum">    2945 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    2946 </span>            :       }
<span class="lineNum">    2947 </span>            :       // Iterate grid collection
<span class="lineNum">    2948 </span><span class="lineNoCov">          0 :       while (coll-&gt;Next()) {</span>
<span class="lineNum">    2949 </span><span class="lineNoCov">          0 :          TString fname = gSystem-&gt;DirName(coll-&gt;GetTURL());</span>
<span class="lineNum">    2950 </span><span class="lineNoCov">          0 :          fname += &quot;/&quot;;</span>
<span class="lineNum">    2951 </span><span class="lineNoCov">          0 :          fname += inputFile;      </span>
<span class="lineNum">    2952 </span><span class="lineNoCov">          0 :          listoffiles-&gt;Add(new TNamed(fname.Data(),&quot;&quot;));</span>
<span class="lineNum">    2953 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    2954 </span><span class="lineNoCov">          0 :    } else if (sbasedir.Contains(&quot;.txt&quot;)) {</span>
<span class="lineNum">    2955 </span>            :       // The file having the .txt extension is expected to contain a list of
<span class="lineNum">    2956 </span>            :       // folders where the output files will be looked. For alien folders,
<span class="lineNum">    2957 </span>            :       // the full folder LFN is expected (starting with alien://)
<span class="lineNum">    2958 </span>            :       // Assume lfn's on each line
<span class="lineNum">    2959 </span><span class="lineNoCov">          0 :       TString line;</span>
<span class="lineNum">    2960 </span><span class="lineNoCov">          0 :       ifstream in;</span>
<span class="lineNum">    2961 </span><span class="lineNoCov">          0 :       in.open(sbasedir);</span>
<span class="lineNum">    2962 </span><span class="lineNoCov">          0 :       if (in.fail()) {</span>
<span class="lineNum">    2963 </span><span class="lineNoCov">          0 :          ::Error(&quot;MergeOutput&quot;, &quot;File %s cannot be opened. Merging stopped.&quot; ,sbasedir.Data());</span>
<span class="lineNum">    2964 </span><span class="lineNoCov">          0 :          return kTRUE;</span>
<span class="lineNum">    2965 </span>            :       }           
<span class="lineNum">    2966 </span>            :       Int_t nfiles = 0;
<span class="lineNum">    2967 </span><span class="lineNoCov">          0 :       while (in.good()) {</span>
<span class="lineNum">    2968 </span><span class="lineNoCov">          0 :          in &gt;&gt; line;</span>
<span class="lineNum">    2969 </span><span class="lineNoCov">          0 :          if (line.IsNull() || line.BeginsWith(&quot;#&quot;)) continue;</span>
<span class="lineNum">    2970 </span><span class="lineNoCov">          0 :          line.Strip();</span>
<span class="lineNum">    2971 </span><span class="lineNoCov">          0 :          if (!line.Contains(&quot;alien:&quot;)) isGrid = kFALSE;</span>
<span class="lineNum">    2972 </span><span class="lineNoCov">          0 :          line += &quot;/&quot;;</span>
<span class="lineNum">    2973 </span><span class="lineNoCov">          0 :          line += outputFile;</span>
<span class="lineNum">    2974 </span><span class="lineNoCov">          0 :          nfiles++;</span>
<span class="lineNum">    2975 </span><span class="lineNoCov">          0 :          listoffiles-&gt;Add(new TNamed(line.Data(),&quot;&quot;));</span>
<span class="lineNum">    2976 </span>            :       }
<span class="lineNum">    2977 </span><span class="lineNoCov">          0 :       in.close();</span>
<span class="lineNum">    2978 </span><span class="lineNoCov">          0 :       if (!nfiles) {</span>
<span class="lineNum">    2979 </span><span class="lineNoCov">          0 :          ::Error(&quot;MergeOutput&quot;,&quot;Input file %s contains no files to be merged\n&quot;, sbasedir.Data());</span>
<span class="lineNum">    2980 </span><span class="lineNoCov">          0 :          delete listoffiles;</span>
<span class="lineNum">    2981 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    2982 </span>            :       }
<span class="lineNum">    2983 </span><span class="lineNoCov">          0 :    } else {   </span>
<span class="lineNum">    2984 </span><span class="lineNoCov">          0 :       command = Form(&quot;find %s/ *%s&quot;, basedir, inputFile.Data());</span>
<span class="lineNum">    2985 </span><span class="lineNoCov">          0 :       printf(&quot;command: %s\n&quot;, command.Data());</span>
<span class="lineNum">    2986 </span><span class="lineNoCov">          0 :       TGridResult *res = gGrid-&gt;Command(command);</span>
<span class="lineNum">    2987 </span><span class="lineNoCov">          0 :       if (!res) {</span>
<span class="lineNum">    2988 </span><span class="lineNoCov">          0 :          ::Error(&quot;MergeOutput&quot;,&quot;No result for the find command\n&quot;);</span>
<span class="lineNum">    2989 </span><span class="lineNoCov">          0 :          delete listoffiles;</span>
<span class="lineNum">    2990 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    2991 </span>            :       }     
<span class="lineNum">    2992 </span><span class="lineNoCov">          0 :       TIter nextmap(res);</span>
<span class="lineNum">    2993 </span>            :       TMap *map = 0;
<span class="lineNum">    2994 </span><span class="lineNoCov">          0 :       while ((map=(TMap*)nextmap())) {</span>
<span class="lineNum">    2995 </span><span class="lineNoCov">          0 :          TObjString *objs = dynamic_cast&lt;TObjString*&gt;(map-&gt;GetValue(&quot;turl&quot;));</span>
<span class="lineNum">    2996 </span><span class="lineNoCov">          0 :          if (!objs || !objs-&gt;GetString().Length()) {</span>
<span class="lineNum">    2997 </span>            :             // Nothing found - skip this output
<span class="lineNum">    2998 </span><span class="lineNoCov">          0 :             delete res;</span>
<span class="lineNum">    2999 </span><span class="lineNoCov">          0 :             delete listoffiles;</span>
<span class="lineNum">    3000 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">    3001 </span>            :          }
<span class="lineNum">    3002 </span><span class="lineNoCov">          0 :          listoffiles-&gt;Add(new TNamed(objs-&gt;GetName(),&quot;&quot;));</span>
<span class="lineNum">    3003 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3004 </span><span class="lineNoCov">          0 :       delete res;</span>
<span class="lineNum">    3005 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3006 </span><span class="lineNoCov">          0 :    if (!listoffiles-&gt;GetEntries()) {</span>
<span class="lineNum">    3007 </span><span class="lineNoCov">          0 :       ::Error(&quot;MergeOutput&quot;,&quot;No result for the find command\n&quot;);</span>
<span class="lineNum">    3008 </span><span class="lineNoCov">          0 :       delete listoffiles;</span>
<span class="lineNum">    3009 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3010 </span>            :    }     
<span class="lineNum">    3011 </span>            : 
<span class="lineNum">    3012 </span>            :    TFileMerger *fm = 0;
<span class="lineNum">    3013 </span><span class="lineNoCov">          0 :    TIter next0(listoffiles);</span>
<span class="lineNum">    3014 </span><span class="lineNoCov">          0 :    TObjArray *listoffilestmp = new TObjArray();</span>
<span class="lineNum">    3015 </span><span class="lineNoCov">          0 :    listoffilestmp-&gt;SetOwner();</span>
<span class="lineNum">    3016 </span>            :    TObject *nextfile;
<span class="lineNum">    3017 </span><span class="lineNoCov">          0 :    TString snextfile;</span>
<span class="lineNum">    3018 </span>            :    // Keep only the files at upper level
<span class="lineNum">    3019 </span>            :    Int_t countChar = 0;
<span class="lineNum">    3020 </span><span class="lineNoCov">          0 :    while ((nextfile=next0())) {</span>
<span class="lineNum">    3021 </span><span class="lineNoCov">          0 :       snextfile = nextfile-&gt;GetName();</span>
<span class="lineNum">    3022 </span><span class="lineNoCov">          0 :       Int_t crtCount = snextfile.CountChar('/');</span>
<span class="lineNum">    3023 </span><span class="lineNoCov">          0 :       if (nextfile == listoffiles-&gt;First()) countChar = crtCount;</span>
<span class="lineNum">    3024 </span><span class="lineNoCov">          0 :       if (crtCount &lt; countChar) countChar = crtCount;</span>
<span class="lineNum">    3025 </span>            :    }
<span class="lineNum">    3026 </span><span class="lineNoCov">          0 :    next0.Reset();</span>
<span class="lineNum">    3027 </span><span class="lineNoCov">          0 :    while ((nextfile=next0())) {</span>
<span class="lineNum">    3028 </span><span class="lineNoCov">          0 :       snextfile = nextfile-&gt;GetName();</span>
<span class="lineNum">    3029 </span><span class="lineNoCov">          0 :       Int_t crtCount = snextfile.CountChar('/');</span>
<span class="lineNum">    3030 </span><span class="lineNoCov">          0 :       if (crtCount &gt; countChar) {</span>
<span class="lineNum">    3031 </span><span class="lineNoCov">          0 :          delete nextfile;</span>
<span class="lineNum">    3032 </span><span class="lineNoCov">          0 :          continue;</span>
<span class="lineNum">    3033 </span>            :       }   
<span class="lineNum">    3034 </span><span class="lineNoCov">          0 :       listoffilestmp-&gt;Add(nextfile);</span>
<span class="lineNum">    3035 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3036 </span><span class="lineNoCov">          0 :    delete listoffiles;</span>
<span class="lineNum">    3037 </span>            :    listoffiles = listoffilestmp;  // Now contains 'good' files
<span class="lineNum">    3038 </span><span class="lineNoCov">          0 :    listoffiles-&gt;Print();</span>
<span class="lineNum">    3039 </span><span class="lineNoCov">          0 :    TIter next(listoffiles);   </span>
<span class="lineNum">    3040 </span>            :    // Check if there is a merge operation to resume. Works only for stage 0 or 1.
<span class="lineNum">    3041 </span><span class="lineNoCov">          0 :    outputChunk = outputFile;</span>
<span class="lineNum">    3042 </span><span class="lineNoCov">          0 :    outputChunk.ReplaceAll(&quot;.root&quot;, &quot;_*.root&quot;);</span>
<span class="lineNum">    3043 </span>            :    // Check for existent temporary merge files
<span class="lineNum">    3044 </span>            :    // Check overwrite mode and remove previous partial results if needed
<span class="lineNum">    3045 </span>            :    // Preserve old merging functionality for stage 0.
<span class="lineNum">    3046 </span><span class="lineNoCov">          0 :    if (stage==0) {</span>
<span class="lineNum">    3047 </span><span class="lineNoCov">          0 :       if (!gSystem-&gt;Exec(Form(&quot;ls %s 2&gt;/dev/null&quot;, outputChunk.Data()))) {</span>
<span class="lineNum">    3048 </span>            :          while (1) {
<span class="lineNum">    3049 </span>            :             // Skip as many input files as in a chunk
<span class="lineNum">    3050 </span><span class="lineNoCov">          0 :             for (Int_t counter=0; counter&lt;nmaxmerge; counter++) {</span>
<span class="lineNum">    3051 </span><span class="lineNoCov">          0 :                nextfile = next();</span>
<span class="lineNum">    3052 </span><span class="lineNoCov">          0 :                if (!nextfile) {</span>
<span class="lineNum">    3053 </span><span class="lineNoCov">          0 :                   ::Error(&quot;MergeOutput&quot;, &quot;Mismatch found. Please remove partial merged files from local dir.&quot;);</span>
<span class="lineNum">    3054 </span><span class="lineNoCov">          0 :                   delete listoffiles;</span>
<span class="lineNum">    3055 </span><span class="lineNoCov">          0 :                   return kFALSE;</span>
<span class="lineNum">    3056 </span>            :                }   
<span class="lineNum">    3057 </span><span class="lineNoCov">          0 :                snextfile = nextfile-&gt;GetName();</span>
<span class="lineNum">    3058 </span>            :             }
<span class="lineNum">    3059 </span><span class="lineNoCov">          0 :             outputChunk = outputFile;</span>
<span class="lineNum">    3060 </span><span class="lineNoCov">          0 :             outputChunk.ReplaceAll(&quot;.root&quot;, Form(&quot;_%04d.root&quot;, countChunk));</span>
<span class="lineNum">    3061 </span><span class="lineNoCov">          0 :             countChunk++;</span>
<span class="lineNum">    3062 </span><span class="lineNoCov">          0 :             if (gSystem-&gt;AccessPathName(outputChunk)) continue;</span>
<span class="lineNum">    3063 </span>            :             // Merged file with chunks up to &lt;countChunk&gt; found
<span class="lineNum">    3064 </span><span class="lineNoCov">          0 :             ::Info(&quot;MergeOutput&quot;, &quot;Resume merging of &lt;%s&gt; from &lt;%s&gt;\n&quot;, outputFile.Data(), outputChunk.Data());</span>
<span class="lineNum">    3065 </span><span class="lineNoCov">          0 :             previousChunk = outputChunk;</span>
<span class="lineNum">    3066 </span>            :             break;
<span class="lineNum">    3067 </span>            :          }
<span class="lineNum">    3068 </span>            :       }   
<span class="lineNum">    3069 </span>            :       countZero = nmaxmerge;
<span class="lineNum">    3070 </span>            :    
<span class="lineNum">    3071 </span><span class="lineNoCov">          0 :       while ((nextfile=next())) {</span>
<span class="lineNum">    3072 </span><span class="lineNoCov">          0 :          snextfile = nextfile-&gt;GetName();</span>
<span class="lineNum">    3073 </span>            :          // Loop 'find' results and get next LFN
<span class="lineNum">    3074 </span><span class="lineNoCov">          0 :          if (countZero == nmaxmerge) {</span>
<span class="lineNum">    3075 </span>            :             // First file in chunk - create file merger and add previous chunk if any.
<span class="lineNum">    3076 </span><span class="lineNoCov">          0 :             fm = new TFileMerger(isGrid);</span>
<span class="lineNum">    3077 </span><span class="lineNoCov">          0 :             fm-&gt;SetFastMethod(kTRUE);</span>
<span class="lineNum">    3078 </span><span class="lineNoCov">          0 :             if (previousChunk.Length()) fm-&gt;AddFile(previousChunk.Data());</span>
<span class="lineNum">    3079 </span><span class="lineNoCov">          0 :             outputChunk = outputFile;</span>
<span class="lineNum">    3080 </span><span class="lineNoCov">          0 :             outputChunk.ReplaceAll(&quot;.root&quot;, Form(&quot;_%04d.root&quot;, countChunk));</span>
<span class="lineNum">    3081 </span>            :          }
<span class="lineNum">    3082 </span>            :          // If last file found, put merged results in the output file
<span class="lineNum">    3083 </span><span class="lineNoCov">          0 :          if (nextfile == listoffiles-&gt;Last()) outputChunk = outputFile;</span>
<span class="lineNum">    3084 </span>            :          // Add file to be merged and decrement chunk counter.
<span class="lineNum">    3085 </span><span class="lineNoCov">          0 :          fm-&gt;AddFile(snextfile);</span>
<span class="lineNum">    3086 </span><span class="lineNoCov">          0 :          countZero--;</span>
<span class="lineNum">    3087 </span><span class="lineNoCov">          0 :          if (countZero==0 || nextfile == listoffiles-&gt;Last()) {            </span>
<span class="lineNum">    3088 </span><span class="lineNoCov">          0 :             if (!fm-&gt;GetMergeList() || !fm-&gt;GetMergeList()-&gt;GetSize()) {</span>
<span class="lineNum">    3089 </span>            :             // Nothing found - skip this output
<span class="lineNum">    3090 </span><span class="lineNoCov">          0 :                ::Warning(&quot;MergeOutput&quot;, &quot;No &lt;%s&gt; files found.&quot;, inputFile.Data());</span>
<span class="lineNum">    3091 </span>            :                merged = kFALSE;
<span class="lineNum">    3092 </span><span class="lineNoCov">          0 :                break;</span>
<span class="lineNum">    3093 </span>            :             }
<span class="lineNum">    3094 </span><span class="lineNoCov">          0 :             fm-&gt;OutputFile(outputChunk);</span>
<span class="lineNum">    3095 </span>            :             // Merge the outputs, then go to next chunk      
<span class="lineNum">    3096 </span><span class="lineNoCov">          0 :             if (!fm-&gt;Merge()) {</span>
<span class="lineNum">    3097 </span><span class="lineNoCov">          0 :                ::Error(&quot;MergeOutput&quot;, &quot;Could not merge all &lt;%s&gt; files&quot;, outputFile.Data());</span>
<span class="lineNum">    3098 </span>            :                merged = kFALSE;
<span class="lineNum">    3099 </span><span class="lineNoCov">          0 :                break;</span>
<span class="lineNum">    3100 </span>            :             } else {
<span class="lineNum">    3101 </span><span class="lineNoCov">          0 :                ::Info(&quot;MergeOutputs&quot;, &quot;\n#####   Merged %d output files to &lt;%s&gt;&quot;, fm-&gt;GetMergeList()-&gt;GetSize(), outputChunk.Data());</span>
<span class="lineNum">    3102 </span><span class="lineNoCov">          0 :                gSystem-&gt;Unlink(previousChunk);</span>
<span class="lineNum">    3103 </span>            :             }
<span class="lineNum">    3104 </span><span class="lineNoCov">          0 :             if (nextfile == listoffiles-&gt;Last()) break;</span>
<span class="lineNum">    3105 </span><span class="lineNoCov">          0 :             countChunk++;</span>
<span class="lineNum">    3106 </span>            :             countZero = nmaxmerge;
<span class="lineNum">    3107 </span><span class="lineNoCov">          0 :             previousChunk = outputChunk;</span>
<span class="lineNum">    3108 </span>            :          }
<span class="lineNum">    3109 </span>            :       }
<span class="lineNum">    3110 </span><span class="lineNoCov">          0 :       delete listoffiles;</span>
<span class="lineNum">    3111 </span><span class="lineNoCov">          0 :       delete fm;</span>
<span class="lineNum">    3112 </span><span class="lineNoCov">          0 :       return merged;</span>
<span class="lineNum">    3113 </span>            :    }
<span class="lineNum">    3114 </span>            :    // Merging stage different than 0.
<span class="lineNum">    3115 </span>            :    // Move to the begining of the requested chunk.
<span class="lineNum">    3116 </span><span class="lineNoCov">          0 :    fm = new TFileMerger(isGrid);</span>
<span class="lineNum">    3117 </span><span class="lineNoCov">          0 :    fm-&gt;SetFastMethod(kTRUE);</span>
<span class="lineNum">    3118 </span><span class="lineNoCov">          0 :    while ((nextfile=next())) fm-&gt;AddFile(nextfile-&gt;GetName());</span>
<span class="lineNum">    3119 </span><span class="lineNoCov">          0 :    delete listoffiles;</span>
<span class="lineNum">    3120 </span><span class="lineNoCov">          0 :    if (!fm-&gt;GetMergeList() || !fm-&gt;GetMergeList()-&gt;GetSize()) {</span>
<span class="lineNum">    3121 </span>            :       // Nothing found - skip this output
<span class="lineNum">    3122 </span><span class="lineNoCov">          0 :       ::Warning(&quot;MergeOutput&quot;, &quot;No &lt;%s&gt; files found.&quot;, inputFile.Data());</span>
<span class="lineNum">    3123 </span><span class="lineNoCov">          0 :       delete fm;</span>
<span class="lineNum">    3124 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3125 </span>            :    }
<span class="lineNum">    3126 </span><span class="lineNoCov">          0 :    fm-&gt;OutputFile(outputFile);</span>
<span class="lineNum">    3127 </span>            :    // Merge the outputs
<span class="lineNum">    3128 </span><span class="lineNoCov">          0 :    if (!fm-&gt;Merge()) {</span>
<span class="lineNum">    3129 </span><span class="lineNoCov">          0 :       ::Error(&quot;MergeOutput&quot;, &quot;Could not merge all &lt;%s&gt; files&quot;, outputFile.Data());</span>
<span class="lineNum">    3130 </span><span class="lineNoCov">          0 :       delete fm;</span>
<span class="lineNum">    3131 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3132 </span>            :    } else {
<span class="lineNum">    3133 </span><span class="lineNoCov">          0 :       ::Info(&quot;MergeOutput&quot;, &quot;\n#####   Merged %d output files to &lt;%s&gt;&quot;, fm-&gt;GetMergeList()-&gt;GetSize(), outputFile.Data());</span>
<span class="lineNum">    3134 </span>            :    }
<span class="lineNum">    3135 </span><span class="lineNoCov">          0 :    delete fm;</span>
<span class="lineNum">    3136 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    3137 </span><span class="lineNoCov">          0 : } </span>
<a name="3138"><span class="lineNum">    3138 </span>            : </a>
<span class="lineNum">    3139 </span>            : //______________________________________________________________________________
<span class="lineNum">    3140 </span>            : Bool_t AliAnalysisAlien::MergeOutputs()
<span class="lineNum">    3141 </span>            : {
<span class="lineNum">    3142 </span>            : // Merge analysis outputs existing in the AliEn space.
<span class="lineNum">    3143 </span><span class="lineNoCov">          0 :    if (TestBit(AliAnalysisGrid::kTest)) return kTRUE;</span>
<span class="lineNum">    3144 </span><span class="lineNoCov">          0 :    if (TestBit(AliAnalysisGrid::kOffline)) return kFALSE;</span>
<span class="lineNum">    3145 </span><span class="lineNoCov">          0 :    if (!Connect()) {</span>
<span class="lineNum">    3146 </span><span class="lineNoCov">          0 :       Error(&quot;MergeOutputs&quot;, &quot;Cannot merge outputs without grid connection. Terminate will NOT be executed&quot;);</span>
<span class="lineNum">    3147 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3148 </span>            :    }
<span class="lineNum">    3149 </span><span class="lineNoCov">          0 :    if (fMergeViaJDL) {</span>
<span class="lineNum">    3150 </span><span class="lineNoCov">          0 :       if (!TestBit(AliAnalysisGrid::kMerge)) {</span>
<span class="lineNum">    3151 </span><span class="lineNoCov">          0 :          Info(&quot;MergeOutputs&quot;, &quot;### Re-run with &lt;MergeViaJDL&gt; option in terminate mode of the plugin to submit merging jobs ###&quot;);</span>
<span class="lineNum">    3152 </span><span class="lineNoCov">          0 :          return kFALSE; </span>
<span class="lineNum">    3153 </span>            :       }     
<span class="lineNum">    3154 </span><span class="lineNoCov">          0 :       if (fProductionMode) {</span>
<span class="lineNum">    3155 </span><span class="lineNoCov">          0 :          Info(&quot;MergeOutputs&quot;, &quot;### Merging will be submitted by LPM manager... ###&quot;);</span>
<span class="lineNum">    3156 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    3157 </span>            :       }
<span class="lineNum">    3158 </span><span class="lineNoCov">          0 :       Info(&quot;MergeOutputs&quot;, &quot;Submitting merging JDL&quot;);</span>
<span class="lineNum">    3159 </span><span class="lineNoCov">          0 :       if (!SubmitMerging()) return kFALSE;</span>
<span class="lineNum">    3160 </span><span class="lineNoCov">          0 :       Info(&quot;MergeOutputs&quot;, &quot;### Re-run with &lt;MergeViaJDL&gt; off to collect results after merging jobs are done ###&quot;);</span>
<span class="lineNum">    3161 </span><span class="lineNoCov">          0 :       Info(&quot;MergeOutputs&quot;, &quot;### The Terminate() method is executed by the merging jobs&quot;);</span>
<span class="lineNum">    3162 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3163 </span>            :    }   
<span class="lineNum">    3164 </span>            :    // Get the output path
<span class="lineNum">    3165 </span><span class="lineNoCov">          0 :    if (!fGridOutputDir.Contains(&quot;/&quot;)) fGridOutputDir = Form(&quot;%s/%s/%s&quot;, gGrid-&gt;GetHomeDirectory(), fGridWorkingDir.Data(), fGridOutputDir.Data());</span>
<span class="lineNum">    3166 </span><span class="lineNoCov">          0 :    if (!DirectoryExists(fGridOutputDir)) {</span>
<span class="lineNum">    3167 </span><span class="lineNoCov">          0 :       Error(&quot;MergeOutputs&quot;, &quot;Grid output directory %s not found. Terminate() will NOT be executed&quot;, fGridOutputDir.Data());</span>
<span class="lineNum">    3168 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3169 </span>            :    }
<span class="lineNum">    3170 </span><span class="lineNoCov">          0 :    if (!fOutputFiles.Length()) {</span>
<span class="lineNum">    3171 </span><span class="lineNoCov">          0 :       Error(&quot;MergeOutputs&quot;, &quot;No output file names defined. Are you running the right AliAnalysisAlien configuration ?&quot;);</span>
<span class="lineNum">    3172 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3173 </span>            :    }
<span class="lineNum">    3174 </span>            :    // Check if fast read option was requested
<span class="lineNum">    3175 </span><span class="lineNoCov">          0 :    Info(&quot;MergeOutputs&quot;, &quot;Started local merging of output files from: alien://%s \</span>
<span class="lineNum">    3176 </span><span class="lineNoCov">          0 :         \n======= overwrite mode = %d&quot;, fGridOutputDir.Data(), (Int_t)fOverwriteMode);</span>
<span class="lineNum">    3177 </span><span class="lineNoCov">          0 :    if (fFastReadOption) {</span>
<span class="lineNum">    3178 </span><span class="lineNoCov">          0 :       Warning(&quot;MergeOutputs&quot;, &quot;You requested FastRead option. Using xrootd flags to reduce timeouts. This may skip some files that could be accessed ! \</span>
<span class="lineNum">    3179 </span>            :              \n+++ NOTE: To disable this option, use: plugin-&gt;SetFastReadOption(kFALSE)&quot;);
<span class="lineNum">    3180 </span><span class="lineNoCov">          0 :       gEnv-&gt;SetValue(&quot;XNet.ConnectTimeout&quot;,50);</span>
<span class="lineNum">    3181 </span><span class="lineNoCov">          0 :       gEnv-&gt;SetValue(&quot;XNet.RequestTimeout&quot;,50);</span>
<span class="lineNum">    3182 </span><span class="lineNoCov">          0 :       gEnv-&gt;SetValue(&quot;XNet.MaxRedirectCount&quot;,2);</span>
<span class="lineNum">    3183 </span><span class="lineNoCov">          0 :       gEnv-&gt;SetValue(&quot;XNet.ReconnectTimeout&quot;,50);</span>
<span class="lineNum">    3184 </span><span class="lineNoCov">          0 :       gEnv-&gt;SetValue(&quot;XNet.FirstConnectMaxCnt&quot;,1);</span>
<span class="lineNum">    3185 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    3186 </span>            :    // Make sure we change the temporary directory
<span class="lineNum">    3187 </span><span class="lineNoCov">          0 :    gSystem-&gt;Setenv(&quot;TMPDIR&quot;, gSystem-&gt;pwd());</span>
<span class="lineNum">    3188 </span>            :    // Set temporary compilation directory to current one
<span class="lineNum">    3189 </span><span class="lineNoCov">          0 :    gSystem-&gt;SetBuildDir(gSystem-&gt;pwd(), kTRUE);   </span>
<span class="lineNum">    3190 </span><span class="lineNoCov">          0 :    TObjArray *list = fOutputFiles.Tokenize(&quot;,&quot;);</span>
<span class="lineNum">    3191 </span><span class="lineNoCov">          0 :    TIter next(list);</span>
<span class="lineNum">    3192 </span>            :    TObjString *str;
<span class="lineNum">    3193 </span><span class="lineNoCov">          0 :    TString outputFile;</span>
<span class="lineNum">    3194 </span>            :    Bool_t merged = kTRUE;
<span class="lineNum">    3195 </span><span class="lineNoCov">          0 :    while((str=(TObjString*)next())) {</span>
<span class="lineNum">    3196 </span><span class="lineNoCov">          0 :       outputFile = str-&gt;GetString();</span>
<span class="lineNum">    3197 </span><span class="lineNoCov">          0 :       Int_t index = outputFile.Index(&quot;@&quot;);</span>
<span class="lineNum">    3198 </span><span class="lineNoCov">          0 :       if (index &gt; 0) outputFile.Remove(index);</span>
<span class="lineNum">    3199 </span><span class="lineNoCov">          0 :       TString outputChunk = outputFile;</span>
<span class="lineNum">    3200 </span><span class="lineNoCov">          0 :       outputChunk.ReplaceAll(&quot;.root&quot;, &quot;_*.root&quot;);</span>
<span class="lineNum">    3201 </span>            :       // Skip already merged outputs
<span class="lineNum">    3202 </span><span class="lineNoCov">          0 :       if (!gSystem-&gt;AccessPathName(outputFile)) {</span>
<span class="lineNum">    3203 </span><span class="lineNoCov">          0 :          if (fOverwriteMode) {</span>
<span class="lineNum">    3204 </span><span class="lineNoCov">          0 :             Info(&quot;MergeOutputs&quot;, &quot;Overwrite mode. Existing file %s was deleted.&quot;, outputFile.Data());</span>
<span class="lineNum">    3205 </span><span class="lineNoCov">          0 :             gSystem-&gt;Unlink(outputFile);</span>
<span class="lineNum">    3206 </span><span class="lineNoCov">          0 :             if (!gSystem-&gt;Exec(Form(&quot;ls %s 2&gt;/dev/null&quot;, outputChunk.Data()))) {</span>
<span class="lineNum">    3207 </span><span class="lineNoCov">          0 :                Info(&quot;MergeOutput&quot;, &quot;Overwrite mode: partial merged files %s will removed&quot;,</span>
<span class="lineNum">    3208 </span><span class="lineNoCov">          0 :                      outputChunk.Data());</span>
<span class="lineNum">    3209 </span><span class="lineNoCov">          0 :                gSystem-&gt;Exec(Form(&quot;rm -f %s&quot;, outputChunk.Data()));</span>
<span class="lineNum">    3210 </span>            :             }
<span class="lineNum">    3211 </span>            :          } else {   
<span class="lineNum">    3212 </span><span class="lineNoCov">          0 :             Info(&quot;MergeOutputs&quot;, &quot;Output file &lt;%s&gt; found. Not merging again.&quot;, outputFile.Data());</span>
<span class="lineNum">    3213 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    3214 </span>            :          }   
<span class="lineNum">    3215 </span>            :       } else {
<span class="lineNum">    3216 </span><span class="lineNoCov">          0 :          if (!gSystem-&gt;Exec(Form(&quot;ls %s 2&gt;/dev/null&quot;, outputChunk.Data()))) {</span>
<span class="lineNum">    3217 </span><span class="lineNoCov">          0 :             Info(&quot;MergeOutput&quot;, &quot;Overwrite mode: partial merged files %s will removed&quot;,</span>
<span class="lineNum">    3218 </span><span class="lineNoCov">          0 :                   outputChunk.Data());</span>
<span class="lineNum">    3219 </span><span class="lineNoCov">          0 :             gSystem-&gt;Exec(Form(&quot;rm -f %s&quot;, outputChunk.Data()));</span>
<span class="lineNum">    3220 </span>            :          }   
<span class="lineNum">    3221 </span>            :       }
<span class="lineNum">    3222 </span><span class="lineNoCov">          0 :       if (fMergeExcludes.Contains(outputFile.Data()) || </span>
<span class="lineNum">    3223 </span><span class="lineNoCov">          0 :           fRegisterExcludes.Contains(outputFile.Data())) continue;</span>
<span class="lineNum">    3224 </span>            :       // Perform a 'find' command in the output directory, looking for registered outputs    
<span class="lineNum">    3225 </span><span class="lineNoCov">          0 :       merged = MergeOutput(outputFile, fGridOutputDir, fMaxMergeFiles);</span>
<span class="lineNum">    3226 </span><span class="lineNoCov">          0 :       if (!merged) {</span>
<span class="lineNum">    3227 </span><span class="lineNoCov">          0 :          Error(&quot;MergeOutputs&quot;, &quot;Terminate() will  NOT be executed&quot;);</span>
<span class="lineNum">    3228 </span><span class="lineNoCov">          0 :          delete list;</span>
<span class="lineNum">    3229 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    3230 </span>            :       }
<span class="lineNum">    3231 </span><span class="lineNoCov">          0 :       TFile *fileOpened = (TFile*)gROOT-&gt;GetListOfFiles()-&gt;FindObject(outputFile);</span>
<span class="lineNum">    3232 </span><span class="lineNoCov">          0 :       if (fileOpened) fileOpened-&gt;Close();</span>
<span class="lineNum">    3233 </span><span class="lineNoCov">          0 :    } </span>
<span class="lineNum">    3234 </span><span class="lineNoCov">          0 :    delete list;</span>
<span class="lineNum">    3235 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    3236 </span><span class="lineNoCov">          0 : }   </span>
<a name="3237"><span class="lineNum">    3237 </span>            : </a>
<span class="lineNum">    3238 </span>            : //______________________________________________________________________________
<span class="lineNum">    3239 </span>            : void AliAnalysisAlien::SetDefaultOutputs(Bool_t flag)
<span class="lineNum">    3240 </span>            : {
<span class="lineNum">    3241 </span>            : // Use the output files connected to output containers from the analysis manager
<span class="lineNum">    3242 </span>            : // rather than the files defined by SetOutputFiles
<span class="lineNum">    3243 </span><span class="lineNoCov">          0 :    if (flag &amp;&amp; !TObject::TestBit(AliAnalysisGrid::kDefaultOutputs))</span>
<span class="lineNum">    3244 </span><span class="lineNoCov">          0 :       Info(&quot;SetDefaultOutputs&quot;, &quot;Plugin will use the output files taken from analysis manager&quot;);</span>
<span class="lineNum">    3245 </span><span class="lineNoCov">          0 :    TObject::SetBit(AliAnalysisGrid::kDefaultOutputs, flag);</span>
<span class="lineNum">    3246 </span><span class="lineNoCov">          0 : }</span>
<a name="3247"><span class="lineNum">    3247 </span>            :       </a>
<span class="lineNum">    3248 </span>            : //______________________________________________________________________________
<span class="lineNum">    3249 </span>            : void AliAnalysisAlien::SetOutputFiles(const char *list)
<span class="lineNum">    3250 </span>            : {
<span class="lineNum">    3251 </span>            : // Manually set the output files list.
<span class="lineNum">    3252 </span>            : // Removes duplicates. Not allowed if default outputs are not disabled.
<span class="lineNum">    3253 </span><span class="lineNoCov">          0 :    if (TObject::TestBit(AliAnalysisGrid::kDefaultOutputs)) {</span>
<span class="lineNum">    3254 </span><span class="lineNoCov">          0 :       Fatal(&quot;SetOutputFiles&quot;, &quot;You have to explicitly call SetDefaultOutputs(kFALSE) to manually set output files.&quot;);</span>
<span class="lineNum">    3255 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    3256 </span>            :    }
<span class="lineNum">    3257 </span><span class="lineNoCov">          0 :    Info(&quot;SetOutputFiles&quot;, &quot;Output file list is set manually - you are on your own.&quot;);</span>
<span class="lineNum">    3258 </span><span class="lineNoCov">          0 :    fOutputFiles = &quot;&quot;;</span>
<span class="lineNum">    3259 </span><span class="lineNoCov">          0 :    TString slist = list;</span>
<span class="lineNum">    3260 </span><span class="lineNoCov">          0 :    if (slist.Contains(&quot;@&quot;)) Warning(&quot;SetOutputFiles&quot;,&quot;The plugin does not allow explicit SE's. Please use: SetNumberOfReplicas() instead.&quot;);</span>
<span class="lineNum">    3261 </span><span class="lineNoCov">          0 :    TObjArray *arr = slist.Tokenize(&quot; &quot;); </span>
<span class="lineNum">    3262 </span>            :    TObjString *os;
<span class="lineNum">    3263 </span><span class="lineNoCov">          0 :    TIter next(arr);</span>
<span class="lineNum">    3264 </span><span class="lineNoCov">          0 :    TString sout;</span>
<span class="lineNum">    3265 </span><span class="lineNoCov">          0 :    while ((os=(TObjString*)next())) {</span>
<span class="lineNum">    3266 </span><span class="lineNoCov">          0 :       sout = os-&gt;GetString();</span>
<span class="lineNum">    3267 </span><span class="lineNoCov">          0 :       if (sout.Index(&quot;@&quot;)&gt;0) sout.Remove(sout.Index(&quot;@&quot;));</span>
<span class="lineNum">    3268 </span><span class="lineNoCov">          0 :       if (fOutputFiles.Contains(sout)) continue;</span>
<span class="lineNum">    3269 </span><span class="lineNoCov">          0 :       if (!fOutputFiles.IsNull()) fOutputFiles += &quot;,&quot;;</span>
<span class="lineNum">    3270 </span><span class="lineNoCov">          0 :       fOutputFiles += sout;</span>
<span class="lineNum">    3271 </span>            :    }
<span class="lineNum">    3272 </span><span class="lineNoCov">          0 :    delete arr;   </span>
<span class="lineNum">    3273 </span><span class="lineNoCov">          0 : }</span>
<a name="3274"><span class="lineNum">    3274 </span>            : </a>
<span class="lineNum">    3275 </span>            : //______________________________________________________________________________
<span class="lineNum">    3276 </span>            : void AliAnalysisAlien::SetOutputArchive(const char *list)
<span class="lineNum">    3277 </span>            : {
<span class="lineNum">    3278 </span>            : // Manually set the output archive list. Free text - you are on your own...
<span class="lineNum">    3279 </span>            : // Not allowed if default outputs are not disabled.
<span class="lineNum">    3280 </span><span class="lineNoCov">          0 :    if (TObject::TestBit(AliAnalysisGrid::kDefaultOutputs)) {</span>
<span class="lineNum">    3281 </span><span class="lineNoCov">          0 :       Fatal(&quot;SetOutputArchive&quot;, &quot;You have to explicitly call SetDefaultOutputs(kFALSE) to manually set the output archives.&quot;);</span>
<span class="lineNum">    3282 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    3283 </span>            :    }
<span class="lineNum">    3284 </span><span class="lineNoCov">          0 :    Info(&quot;SetOutputArchive&quot;, &quot;Output archive is set manually - you are on your own.&quot;);</span>
<span class="lineNum">    3285 </span><span class="lineNoCov">          0 :    fOutputArchive = list;</span>
<span class="lineNum">    3286 </span><span class="lineNoCov">          0 : }</span>
<a name="3287"><span class="lineNum">    3287 </span>            : </a>
<span class="lineNum">    3288 </span>            : //______________________________________________________________________________
<span class="lineNum">    3289 </span>            : void AliAnalysisAlien::SetProofParameter(const char *pname, const char *value)
<span class="lineNum">    3290 </span>            : {
<span class="lineNum">    3291 </span>            : // Set some PROOF special parameter.
<span class="lineNum">    3292 </span><span class="lineNoCov">          0 :    TPair *pair = dynamic_cast&lt;TPair*&gt;(fProofParam.FindObject(pname));</span>
<span class="lineNum">    3293 </span><span class="lineNoCov">          0 :    if (pair) {</span>
<span class="lineNum">    3294 </span><span class="lineNoCov">          0 :       TObject *old = pair-&gt;Key();</span>
<span class="lineNum">    3295 </span><span class="lineNoCov">          0 :       TObject *val = pair-&gt;Value();</span>
<span class="lineNum">    3296 </span><span class="lineNoCov">          0 :       fProofParam.Remove(old);</span>
<span class="lineNum">    3297 </span><span class="lineNoCov">          0 :       delete old;</span>
<span class="lineNum">    3298 </span><span class="lineNoCov">          0 :       delete val;</span>
<span class="lineNum">    3299 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3300 </span><span class="lineNoCov">          0 :    fProofParam.Add(new TObjString(pname), new TObjString(value));</span>
<span class="lineNum">    3301 </span><span class="lineNoCov">          0 : }</span>
<a name="3302"><span class="lineNum">    3302 </span>            : </a>
<span class="lineNum">    3303 </span>            : //______________________________________________________________________________
<span class="lineNum">    3304 </span>            : const char *AliAnalysisAlien::GetProofParameter(const char *pname) const
<span class="lineNum">    3305 </span>            : {
<span class="lineNum">    3306 </span>            : // Returns a special PROOF parameter.
<span class="lineNum">    3307 </span><span class="lineNoCov">          0 :    TPair *pair = dynamic_cast&lt;TPair*&gt;(fProofParam.FindObject(pname));</span>
<span class="lineNum">    3308 </span><span class="lineNoCov">          0 :    if (!pair) return 0;</span>
<span class="lineNum">    3309 </span><span class="lineNoCov">          0 :    return pair-&gt;Value()-&gt;GetName();</span>
<span class="lineNum">    3310 </span><span class="lineNoCov">          0 : }      </span>
<a name="3311"><span class="lineNum">    3311 </span>            : </a>
<span class="lineNum">    3312 </span>            : //______________________________________________________________________________
<span class="lineNum">    3313 </span>            : Bool_t AliAnalysisAlien::StartAnalysis(Long64_t nentries, Long64_t firstEntry)
<span class="lineNum">    3314 </span>            : {
<span class="lineNum">    3315 </span>            : // Start remote grid analysis.
<span class="lineNum">    3316 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">    3317 </span><span class="lineNoCov">          0 :    Bool_t testMode = TestBit(AliAnalysisGrid::kTest);</span>
<span class="lineNum">    3318 </span><span class="lineNoCov">          0 :    if (!mgr || !mgr-&gt;IsInitialized()) {</span>
<span class="lineNum">    3319 </span><span class="lineNoCov">          0 :       Error(&quot;StartAnalysis&quot;, &quot;You need an initialized analysis manager for this&quot;);</span>
<span class="lineNum">    3320 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3321 </span>            :    }
<span class="lineNum">    3322 </span>            :    // Are we in PROOF mode ?
<span class="lineNum">    3323 </span><span class="lineNoCov">          0 :    if (mgr-&gt;IsProofMode()) {</span>
<span class="lineNum">    3324 </span><span class="lineNoCov">          0 :       if (testMode) Info(&quot;StartAnalysis&quot;, &quot;##### Starting PROOF analysis with Proof Lite via the plugin #####&quot;);</span>
<span class="lineNum">    3325 </span><span class="lineNoCov">          0 :       else Info(&quot;StartAnalysis&quot;, &quot;##### Starting PROOF analysis on cluster &lt;%s&gt; via the plugin #####&quot;, fProofCluster.Data());</span>
<span class="lineNum">    3326 </span><span class="lineNoCov">          0 :       if (fProofCluster.IsNull()) {</span>
<span class="lineNum">    3327 </span><span class="lineNoCov">          0 :          Error(&quot;StartAnalysis&quot;, &quot;You need to specify the proof cluster name via SetProofCluster&quot;);</span>
<span class="lineNum">    3328 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    3329 </span>            :       }   
<span class="lineNum">    3330 </span><span class="lineNoCov">          0 :       if (fProofDataSet.IsNull() &amp;&amp; !testMode) {</span>
<span class="lineNum">    3331 </span><span class="lineNoCov">          0 :          Error(&quot;StartAnalysis&quot;, &quot;You need to specify a dataset using SetProofDataSet()&quot;);</span>
<span class="lineNum">    3332 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    3333 </span>            :       }   
<span class="lineNum">    3334 </span>            :       // Set the needed environment
<span class="lineNum">    3335 </span><span class="lineNoCov">          0 :       gEnv-&gt;SetValue(&quot;XSec.GSI.DelegProxy&quot;,&quot;2&quot;);</span>
<span class="lineNum">    3336 </span>            :       // Do we need to reset PROOF ? The success of the Reset operation cannot be checked
<span class="lineNum">    3337 </span><span class="lineNoCov">          0 :       if (fProofReset &amp;&amp; !testMode) {</span>
<span class="lineNum">    3338 </span><span class="lineNoCov">          0 :          if (fProofReset==1) {</span>
<span class="lineNum">    3339 </span><span class="lineNoCov">          0 :             Info(&quot;StartAnalysis&quot;, &quot;Sending soft reset signal to proof cluster %s&quot;, fProofCluster.Data());</span>
<span class="lineNum">    3340 </span><span class="lineNoCov">          0 :             gROOT-&gt;ProcessLine(Form(&quot;TProof::Reset(\&quot;%s\&quot;, kFALSE);&quot;, fProofCluster.Data()));</span>
<span class="lineNum">    3341 </span><span class="lineNoCov">          0 :          } else {         </span>
<span class="lineNum">    3342 </span><span class="lineNoCov">          0 :             Info(&quot;StartAnalysis&quot;, &quot;Sending hard reset signal to proof cluster %s&quot;, fProofCluster.Data());</span>
<span class="lineNum">    3343 </span><span class="lineNoCov">          0 :             gROOT-&gt;ProcessLine(Form(&quot;TProof::Reset(\&quot;%s\&quot;, kTRUE);&quot;, fProofCluster.Data()));</span>
<span class="lineNum">    3344 </span>            :          }
<span class="lineNum">    3345 </span><span class="lineNoCov">          0 :          Info(&quot;StartAnalysis&quot;, &quot;Stopping the analysis. Please use SetProofReset(0) to resume.&quot;);</span>
<span class="lineNum">    3346 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    3347 </span>            :       }
<span class="lineNum">    3348 </span>            :       
<span class="lineNum">    3349 </span><span class="lineNoCov">          0 :       if (!testMode) {</span>
<span class="lineNum">    3350 </span>            :         // Check if there is an old active session
<span class="lineNum">    3351 </span><span class="lineNoCov">          0 :         Long_t nsessions = gROOT-&gt;ProcessLine(Form(&quot;TProof::Mgr(\&quot;%s\&quot;)-&gt;QuerySessions(\&quot;\&quot;)-&gt;GetEntries();&quot;, fProofCluster.Data()));</span>
<span class="lineNum">    3352 </span><span class="lineNoCov">          0 :         if (nsessions) {</span>
<span class="lineNum">    3353 </span><span class="lineNoCov">          0 :           Error(&quot;StartAnalysis&quot;,&quot;You have to reset your old session first\n&quot;);</span>
<span class="lineNum">    3354 </span><span class="lineNoCov">          0 :           return kFALSE;</span>
<span class="lineNum">    3355 </span>            :         }
<span class="lineNum">    3356 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3357 </span>            :       // Do we need to change the ROOT version ? The success of this cannot be checked.
<span class="lineNum">    3358 </span><span class="lineNoCov">          0 :       if (!fROOTVersion.IsNull() &amp;&amp; !testMode) {</span>
<span class="lineNum">    3359 </span><span class="lineNoCov">          0 :          gROOT-&gt;ProcessLine(Form(&quot;TProof::Mgr(\&quot;%s\&quot;)-&gt;SetROOTVersion(\&quot;VO_ALICE@ROOT::%s\&quot;);&quot;, </span>
<span class="lineNum">    3360 </span><span class="lineNoCov">          0 :                             fProofCluster.Data(), fROOTVersion.Data()));</span>
<span class="lineNum">    3361 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3362 </span>            :       // Connect to PROOF and check the status
<span class="lineNum">    3363 </span>            :       Long_t proof = 0;
<span class="lineNum">    3364 </span><span class="lineNoCov">          0 :       TString sworkers;</span>
<span class="lineNum">    3365 </span><span class="lineNoCov">          0 :       if (fNproofWorkersPerSlave) sworkers = Form(&quot;workers=%dx&quot;, fNproofWorkersPerSlave);</span>
<span class="lineNum">    3366 </span><span class="lineNoCov">          0 :       else if (fNproofWorkers) sworkers = Form(&quot;workers=%d&quot;, fNproofWorkers);</span>
<span class="lineNum">    3367 </span><span class="lineNoCov">          0 :       if (!testMode) {</span>
<span class="lineNum">    3368 </span><span class="lineNoCov">          0 :          if (!sworkers.IsNull()) </span>
<span class="lineNum">    3369 </span><span class="lineNoCov">          0 :             proof = gROOT-&gt;ProcessLine(Form(&quot;TProof::Open(\&quot;%s\&quot;, \&quot;%s\&quot;);&quot;, fProofCluster.Data(), sworkers.Data()));</span>
<span class="lineNum">    3370 </span>            :          else   
<span class="lineNum">    3371 </span><span class="lineNoCov">          0 :             proof = gROOT-&gt;ProcessLine(Form(&quot;TProof::Open(\&quot;%s\&quot;);&quot;, fProofCluster.Data()));</span>
<span class="lineNum">    3372 </span>            :       } else {
<span class="lineNum">    3373 </span><span class="lineNoCov">          0 :          proof = gROOT-&gt;ProcessLine(&quot;TProof::Open(\&quot;\&quot;);&quot;);</span>
<span class="lineNum">    3374 </span><span class="lineNoCov">          0 :          if (!proof) {</span>
<span class="lineNum">    3375 </span><span class="lineNoCov">          0 :             Error(&quot;StartAnalysis&quot;, &quot;Could not start PROOF in test mode&quot;);</span>
<span class="lineNum">    3376 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">    3377 </span>            :          }   
<span class="lineNum">    3378 </span>            :       }
<span class="lineNum">    3379 </span><span class="lineNoCov">          0 :       if (!proof) {</span>
<span class="lineNum">    3380 </span><span class="lineNoCov">          0 :          Error(&quot;StartAnalysis&quot;, &quot;Could not connect to PROOF cluster &lt;%s&gt;&quot;, fProofCluster.Data());</span>
<span class="lineNum">    3381 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    3382 </span>            :       }   
<span class="lineNum">    3383 </span><span class="lineNoCov">          0 :       if (fNproofWorkersPerSlave*fNproofWorkers &gt; 0)</span>
<span class="lineNum">    3384 </span><span class="lineNoCov">          0 :          gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;SetParallel(%d);&quot;, fNproofWorkers));</span>
<span class="lineNum">    3385 </span>            :       // Set proof special parameters if any
<span class="lineNum">    3386 </span><span class="lineNoCov">          0 :       TIter nextpp(&amp;fProofParam);</span>
<span class="lineNum">    3387 </span>            :       TObject *proofparam;
<span class="lineNum">    3388 </span><span class="lineNoCov">          0 :       while ((proofparam=nextpp())) {</span>
<span class="lineNum">    3389 </span><span class="lineNoCov">          0 :          TString svalue = GetProofParameter(proofparam-&gt;GetName());</span>
<span class="lineNum">    3390 </span><span class="lineNoCov">          0 :          gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;SetParameter(\&quot;%s\&quot;,%s);&quot;, proofparam-&gt;GetName(), svalue.Data()));</span>
<span class="lineNum">    3391 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    3392 </span>            :       // Is dataset existing ?
<span class="lineNum">    3393 </span><span class="lineNoCov">          0 :       if (!testMode) {</span>
<span class="lineNum">    3394 </span><span class="lineNoCov">          0 :          TString dataset = fProofDataSet;</span>
<span class="lineNum">    3395 </span><span class="lineNoCov">          0 :          Int_t index = dataset.Index(&quot;#&quot;);</span>
<span class="lineNum">    3396 </span><span class="lineNoCov">          0 :          if (index&gt;=0) dataset.Remove(index);</span>
<span class="lineNum">    3397 </span>            : //         if (!gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;ExistsDataSet(\&quot;%s\&quot;);&quot;,fProofDataSet.Data()))) {
<span class="lineNum">    3398 </span>            : //            Error(&quot;StartAnalysis&quot;, &quot;Dataset %s not existing&quot;, fProofDataSet.Data());
<span class="lineNum">    3399 </span>            : //            return kFALSE;
<span class="lineNum">    3400 </span>            : //         }
<span class="lineNum">    3401 </span>            : //         Info(&quot;StartAnalysis&quot;, &quot;Dataset %s found&quot;, dataset.Data());
<span class="lineNum">    3402 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3403 </span>            :       // Is ClearPackages() needed ?
<span class="lineNum">    3404 </span><span class="lineNoCov">          0 :       if (TestSpecialBit(kClearPackages)) {</span>
<span class="lineNum">    3405 </span><span class="lineNoCov">          0 :          Info(&quot;StartAnalysis&quot;, &quot;ClearPackages signal sent to PROOF. Use SetClearPackages(kFALSE) to reset this.&quot;);</span>
<span class="lineNum">    3406 </span><span class="lineNoCov">          0 :          gROOT-&gt;ProcessLine(&quot;gProof-&gt;ClearPackages();&quot;);</span>
<span class="lineNum">    3407 </span>            :       }
<span class="lineNum">    3408 </span>            :       // Is a given aliroot mode requested ?
<span class="lineNum">    3409 </span><span class="lineNoCov">          0 :       TList optionsList;</span>
<span class="lineNum">    3410 </span><span class="lineNoCov">          0 :       TString parLibs;</span>
<span class="lineNum">    3411 </span><span class="lineNoCov">          0 :       if (!fAliRootMode.IsNull()) {</span>
<span class="lineNum">    3412 </span><span class="lineNoCov">          0 :          TString alirootMode = fAliRootMode;</span>
<span class="lineNum">    3413 </span><span class="lineNoCov">          0 :          if (alirootMode == &quot;default&quot;) alirootMode = &quot;&quot;;</span>
<span class="lineNum">    3414 </span><span class="lineNoCov">          0 :          Info(&quot;StartAnalysis&quot;, &quot;You are requesting AliRoot mode: %s&quot;, fAliRootMode.Data());</span>
<span class="lineNum">    3415 </span><span class="lineNoCov">          0 :          optionsList.SetOwner();</span>
<span class="lineNum">    3416 </span><span class="lineNoCov">          0 :          optionsList.Add(new TNamed(&quot;ALIROOT_MODE&quot;, alirootMode.Data()));</span>
<span class="lineNum">    3417 </span>            :          // Check the additional libs to be loaded
<span class="lineNum">    3418 </span><span class="lineNoCov">          0 :          TString extraLibs;</span>
<span class="lineNum">    3419 </span>            :          Bool_t parMode = kFALSE;
<span class="lineNum">    3420 </span><span class="lineNoCov">          0 :          if (!alirootMode.IsNull()) extraLibs = &quot;ANALYSIS:ANALYSISalice:OADB&quot;;</span>
<span class="lineNum">    3421 </span>            :          // Parse the extra libs for .so or .dylib
<span class="lineNum">    3422 </span><span class="lineNoCov">          0 :          if (fAdditionalLibs.Length()) {</span>
<span class="lineNum">    3423 </span><span class="lineNoCov">          0 :             TString additionalLibs = fAdditionalLibs;</span>
<span class="lineNum">    3424 </span><span class="lineNoCov">          0 :             additionalLibs.Strip();</span>
<span class="lineNum">    3425 </span><span class="lineNoCov">          0 :             if (additionalLibs.Length() &amp;&amp; fFriendLibs.Length())</span>
<span class="lineNum">    3426 </span><span class="lineNoCov">          0 :                additionalLibs += &quot; &quot;;</span>
<span class="lineNum">    3427 </span><span class="lineNoCov">          0 :             additionalLibs += fFriendLibs;</span>
<span class="lineNum">    3428 </span><span class="lineNoCov">          0 :             TObjArray *list = additionalLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    3429 </span><span class="lineNoCov">          0 :             TIter next(list);</span>
<span class="lineNum">    3430 </span>            :             TObjString *str;
<span class="lineNum">    3431 </span><span class="lineNoCov">          0 :             while((str=(TObjString*)next())) {</span>
<span class="lineNum">    3432 </span><span class="lineNoCov">          0 :                if (str-&gt;GetString().Contains(&quot;.so&quot;) ||</span>
<span class="lineNum">    3433 </span><span class="lineNoCov">          0 :                    str-&gt;GetString().Contains(&quot;.dylib&quot;) ) {</span>
<span class="lineNum">    3434 </span><span class="lineNoCov">          0 :                   if (parMode) {</span>
<span class="lineNum">    3435 </span><span class="lineNoCov">          0 :                      Warning(&quot;StartAnalysis&quot;, &quot;Plugin does not support loading libs after par files in PROOF mode. Library %s and following will not load on workers&quot;, str-&gt;GetName());</span>
<span class="lineNum">    3436 </span>            :                      break;
<span class="lineNum">    3437 </span>            :                   }   
<span class="lineNum">    3438 </span><span class="lineNoCov">          0 :                   TString stmp = str-&gt;GetName();</span>
<span class="lineNum">    3439 </span><span class="lineNoCov">          0 :                   if (stmp.BeginsWith(&quot;lib&quot;)) stmp.Remove(0,3);</span>
<span class="lineNum">    3440 </span><span class="lineNoCov">          0 :                   stmp.ReplaceAll(&quot;.so&quot;,&quot;&quot;);</span>
<span class="lineNum">    3441 </span><span class="lineNoCov">          0 :                   stmp.ReplaceAll(&quot;.dylib&quot;,&quot;&quot;);</span>
<span class="lineNum">    3442 </span><span class="lineNoCov">          0 :                   if (!extraLibs.IsNull()) extraLibs += &quot;:&quot;;</span>
<span class="lineNum">    3443 </span><span class="lineNoCov">          0 :                   extraLibs += stmp;</span>
<span class="lineNum">    3444 </span>            :                   continue;
<span class="lineNum">    3445 </span><span class="lineNoCov">          0 :                }</span>
<span class="lineNum">    3446 </span><span class="lineNoCov">          0 :                if (str-&gt;GetString().Contains(&quot;.par&quot;)) {</span>
<span class="lineNum">    3447 </span>            :                   // The first par file found in the list will not allow any further .so
<span class="lineNum">    3448 </span>            :                   parMode = kTRUE;
<span class="lineNum">    3449 </span><span class="lineNoCov">          0 :                   if (!parLibs.IsNull()) parLibs += &quot;:&quot;;</span>
<span class="lineNum">    3450 </span><span class="lineNoCov">          0 :                   parLibs += str-&gt;GetName();</span>
<span class="lineNum">    3451 </span>            :                   continue;
<span class="lineNum">    3452 </span>            :                }   
<span class="lineNum">    3453 </span>            :             }
<span class="lineNum">    3454 </span><span class="lineNoCov">          0 :             if (list) delete list;            </span>
<span class="lineNum">    3455 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    3456 </span><span class="lineNoCov">          0 :          if (!extraLibs.IsNull()) {</span>
<span class="lineNum">    3457 </span><span class="lineNoCov">          0 :            Info(&quot;StartAnalysis&quot;, &quot;Adding extra libs: %s&quot;,extraLibs.Data());</span>
<span class="lineNum">    3458 </span><span class="lineNoCov">          0 :            optionsList.Add(new TNamed(&quot;ALIROOT_EXTRA_LIBS&quot;,extraLibs.Data()));</span>
<span class="lineNum">    3459 </span>            :          }
<span class="lineNum">    3460 </span>            :          // Check extra includes
<span class="lineNum">    3461 </span><span class="lineNoCov">          0 :          if (!fIncludePath.IsNull()) {</span>
<span class="lineNum">    3462 </span><span class="lineNoCov">          0 :             TString includePath = fIncludePath;</span>
<span class="lineNum">    3463 </span><span class="lineNoCov">          0 :             includePath.ReplaceAll(&quot; &quot;,&quot;:&quot;);</span>
<span class="lineNum">    3464 </span><span class="lineNoCov">          0 :             includePath.ReplaceAll(&quot;$ALICE_ROOT/&quot;,&quot;&quot;);</span>
<span class="lineNum">    3465 </span><span class="lineNoCov">          0 :             includePath.ReplaceAll(&quot;${ALICE_ROOT}/&quot;,&quot;&quot;);</span>
<span class="lineNum">    3466 </span><span class="lineNoCov">          0 :             includePath.ReplaceAll(&quot;-I&quot;,&quot;&quot;);</span>
<span class="lineNum">    3467 </span><span class="lineNoCov">          0 :             includePath.Remove(TString::kTrailing, ':');</span>
<span class="lineNum">    3468 </span><span class="lineNoCov">          0 :             Info(&quot;StartAnalysis&quot;, &quot;Adding extra includes: %s&quot;,includePath.Data()); </span>
<span class="lineNum">    3469 </span><span class="lineNoCov">          0 :             optionsList.Add(new TNamed(&quot;ALIROOT_EXTRA_INCLUDES&quot;,includePath.Data()));</span>
<span class="lineNum">    3470 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    3471 </span>            :          // Check if connection to grid is requested
<span class="lineNum">    3472 </span><span class="lineNoCov">          0 :          if (TestSpecialBit(kProofConnectGrid)) </span>
<span class="lineNum">    3473 </span><span class="lineNoCov">          0 :             optionsList.Add(new TNamed(&quot;ALIROOT_ENABLE_ALIEN&quot;, &quot;1&quot;));</span>
<span class="lineNum">    3474 </span>            :          // Enable AliRoot par
<span class="lineNum">    3475 </span><span class="lineNoCov">          0 :          if (testMode) {</span>
<span class="lineNum">    3476 </span>            :          // Enable proof lite package
<span class="lineNum">    3477 </span><span class="lineNoCov">          0 :             TString alirootLite = gSystem-&gt;ExpandPathName(&quot;$ALICE_ROOT/ANALYSIS/macros/AliRootProofLite.par&quot;);</span>
<span class="lineNum">    3478 </span><span class="lineNoCov">          0 :             for (Int_t i=0; i&lt;optionsList.GetSize(); i++) {</span>
<span class="lineNum">    3479 </span><span class="lineNoCov">          0 :                TNamed *obj = (TNamed*)optionsList.At(i);</span>
<span class="lineNum">    3480 </span><span class="lineNoCov">          0 :                printf(&quot;%s  %s\n&quot;, obj-&gt;GetName(), obj-&gt;GetTitle());</span>
<span class="lineNum">    3481 </span>            :             }   
<span class="lineNum">    3482 </span><span class="lineNoCov">          0 :             if (!gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;UploadPackage(\&quot;%s\&quot;);&quot;,alirootLite.Data()))</span>
<span class="lineNum">    3483 </span><span class="lineNoCov">          0 :               &amp;&amp; !gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;EnablePackage(\&quot;%s\&quot;, (TList*)%p);&quot;,alirootLite.Data(),&amp;optionsList))) {</span>
<span class="lineNum">    3484 </span><span class="lineNoCov">          0 :                   Info(&quot;StartAnalysis&quot;, &quot;AliRootProofLite enabled&quot;);</span>
<span class="lineNum">    3485 </span>            :             } else {                      
<span class="lineNum">    3486 </span><span class="lineNoCov">          0 :                Error(&quot;StartAnalysis&quot;, &quot;There was an error trying to enable package AliRootProofLite.par&quot;);</span>
<span class="lineNum">    3487 </span><span class="lineNoCov">          0 :                return kFALSE;</span>
<span class="lineNum">    3488 </span>            :             }   
<span class="lineNum">    3489 </span><span class="lineNoCov">          0 :          } else {</span>
<span class="lineNum">    3490 </span><span class="lineNoCov">          0 :            if ( ! fAliROOTVersion.IsNull() ) {</span>
<span class="lineNum">    3491 </span><span class="lineNoCov">          0 :              if (gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;EnablePackage(\&quot;VO_ALICE@AliRoot::%s\&quot;, (TList*)%p, kTRUE);&quot;, </span>
<span class="lineNum">    3492 </span><span class="lineNoCov">          0 :                                          fAliROOTVersion.Data(), &amp;optionsList))) {</span>
<span class="lineNum">    3493 </span><span class="lineNoCov">          0 :                 Error(&quot;StartAnalysis&quot;, &quot;There was an error trying to enable package VO_ALICE@AliRoot::%s&quot;, fAliROOTVersion.Data());</span>
<span class="lineNum">    3494 </span><span class="lineNoCov">          0 :                 return kFALSE;</span>
<span class="lineNum">    3495 </span>            :              }
<span class="lineNum">    3496 </span>            :            }
<span class="lineNum">    3497 </span><span class="lineNoCov">          0 :            if ( ! fAliPhysicsVersion.IsNull() ) {</span>
<span class="lineNum">    3498 </span><span class="lineNoCov">          0 :              if (gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;EnablePackage(\&quot;VO_ALICE@AliPhysics::%s\&quot;, (TList*)%p, kTRUE);&quot;, </span>
<span class="lineNum">    3499 </span><span class="lineNoCov">          0 :                                          fAliPhysicsVersion.Data(), &amp;optionsList))) {</span>
<span class="lineNum">    3500 </span><span class="lineNoCov">          0 :                 Error(&quot;StartAnalysis&quot;, &quot;There was an error trying to enable package VO_ALICE@AliPhysics::%s&quot;, fAliPhysicsVersion.Data());</span>
<span class="lineNum">    3501 </span><span class="lineNoCov">          0 :                 return kFALSE;</span>
<span class="lineNum">    3502 </span>            :              }
<span class="lineNum">    3503 </span>            :            }
<span class="lineNum">    3504 </span>            :          }
<span class="lineNum">    3505 </span>            :          // Enable first par files from fAdditionalLibs
<span class="lineNum">    3506 </span><span class="lineNoCov">          0 :          if (!parLibs.IsNull()) {</span>
<span class="lineNum">    3507 </span><span class="lineNoCov">          0 :             TObjArray *list = parLibs.Tokenize(&quot;:&quot;);</span>
<span class="lineNum">    3508 </span><span class="lineNoCov">          0 :             TIter next(list);</span>
<span class="lineNum">    3509 </span>            :             TObjString *package;
<span class="lineNum">    3510 </span><span class="lineNoCov">          0 :             while((package=(TObjString*)next())) {</span>
<span class="lineNum">    3511 </span><span class="lineNoCov">          0 :                TString spkg = package-&gt;GetName();</span>
<span class="lineNum">    3512 </span><span class="lineNoCov">          0 :                spkg.ReplaceAll(&quot;.par&quot;, &quot;&quot;);</span>
<span class="lineNum">    3513 </span><span class="lineNoCov">          0 :                gSystem-&gt;Exec(TString::Format(&quot;rm -rf %s&quot;, spkg.Data()));</span>
<span class="lineNum">    3514 </span><span class="lineNoCov">          0 :                if (!gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;UploadPackage(\&quot;%s\&quot;);&quot;, package-&gt;GetName()))) {</span>
<span class="lineNum">    3515 </span><span class="lineNoCov">          0 :                   TString enablePackage = (testMode)?Form(&quot;gProof-&gt;EnablePackage(\&quot;%s\&quot;,kFALSE);&quot;, package-&gt;GetName()):Form(&quot;gProof-&gt;EnablePackage(\&quot;%s\&quot;,kTRUE);&quot;, package-&gt;GetName());</span>
<span class="lineNum">    3516 </span><span class="lineNoCov">          0 :                   if (gROOT-&gt;ProcessLine(enablePackage)) {</span>
<span class="lineNum">    3517 </span><span class="lineNoCov">          0 :                      Error(&quot;StartAnalysis&quot;, &quot;There was an error trying to enable package %s&quot;, package-&gt;GetName());</span>
<span class="lineNum">    3518 </span><span class="lineNoCov">          0 :                      return kFALSE;</span>
<span class="lineNum">    3519 </span>            :                   }
<span class="lineNum">    3520 </span><span class="lineNoCov">          0 :                } else {</span>
<span class="lineNum">    3521 </span><span class="lineNoCov">          0 :                   Error(&quot;StartAnalysis&quot;, &quot;There was an error trying to upload package %s&quot;, package-&gt;GetName());</span>
<span class="lineNum">    3522 </span><span class="lineNoCov">          0 :                   return kFALSE;</span>
<span class="lineNum">    3523 </span>            :                }
<span class="lineNum">    3524 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    3525 </span><span class="lineNoCov">          0 :             if (list) delete list; </span>
<span class="lineNum">    3526 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    3527 </span><span class="lineNoCov">          0 :       } else {</span>
<span class="lineNum">    3528 </span><span class="lineNoCov">          0 :          if ((fAdditionalLibs.Contains(&quot;.so&quot;) || fAdditionalLibs.Contains(&quot;.dylib&quot;)) &amp;&amp; </span>
<span class="lineNum">    3529 </span>            :              !testMode) {
<span class="lineNum">    3530 </span><span class="lineNoCov">          0 :             Error(&quot;StartAnalysis&quot;, &quot;You request additional libs to be loaded but did not enabled any AliRoot mode. Please refer to: \</span>
<span class="lineNum">    3531 </span>            :                    \n http://aaf.cern.ch/node/83 and use a parameter for SetAliRootMode()&quot;);
<span class="lineNum">    3532 </span><span class="lineNoCov">          0 :             return kFALSE;       </span>
<span class="lineNum">    3533 </span>            :          }
<span class="lineNum">    3534 </span>            :       }
<span class="lineNum">    3535 </span>            :       // Enable par files if requested
<span class="lineNum">    3536 </span><span class="lineNoCov">          0 :       if (fPackages &amp;&amp; fPackages-&gt;GetEntries()) {</span>
<span class="lineNum">    3537 </span><span class="lineNoCov">          0 :          TIter next(fPackages);</span>
<span class="lineNum">    3538 </span>            :          TObject *package;
<span class="lineNum">    3539 </span><span class="lineNoCov">          0 :          while ((package=next())) {</span>
<span class="lineNum">    3540 </span>            :             // Skip packages already enabled
<span class="lineNum">    3541 </span><span class="lineNoCov">          0 :             if (parLibs.Contains(package-&gt;GetName())) continue;</span>
<span class="lineNum">    3542 </span><span class="lineNoCov">          0 :             TString spkg = package-&gt;GetName();</span>
<span class="lineNum">    3543 </span><span class="lineNoCov">          0 :             spkg.ReplaceAll(&quot;.par&quot;, &quot;&quot;);</span>
<span class="lineNum">    3544 </span><span class="lineNoCov">          0 :             gSystem-&gt;Exec(TString::Format(&quot;rm -rf %s&quot;, spkg.Data()));</span>
<span class="lineNum">    3545 </span><span class="lineNoCov">          0 :             if (!gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;UploadPackage(\&quot;%s\&quot;);&quot;, package-&gt;GetName()))) {</span>
<span class="lineNum">    3546 </span><span class="lineNoCov">          0 :                if (gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;EnablePackage(\&quot;%s\&quot;,kTRUE);&quot;, package-&gt;GetName()))) {</span>
<span class="lineNum">    3547 </span><span class="lineNoCov">          0 :                   Error(&quot;StartAnalysis&quot;, &quot;There was an error trying to enable package %s&quot;, package-&gt;GetName());</span>
<span class="lineNum">    3548 </span><span class="lineNoCov">          0 :                   return kFALSE;</span>
<span class="lineNum">    3549 </span>            :                }
<span class="lineNum">    3550 </span>            :             } else {
<span class="lineNum">    3551 </span><span class="lineNoCov">          0 :                Error(&quot;StartAnalysis&quot;, &quot;There was an error trying to upload package %s&quot;, package-&gt;GetName());</span>
<span class="lineNum">    3552 </span><span class="lineNoCov">          0 :                return kFALSE;</span>
<span class="lineNum">    3553 </span>            :             }
<span class="lineNum">    3554 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    3555 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3556 </span>            :       // Do we need to load analysis source files ?
<span class="lineNum">    3557 </span>            :       // NOTE: don't load on client since this is anyway done by the user to attach his task.
<span class="lineNum">    3558 </span><span class="lineNoCov">          0 :       if (fAnalysisSource.Length()) {</span>
<span class="lineNum">    3559 </span><span class="lineNoCov">          0 :          TObjArray *list = fAnalysisSource.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    3560 </span><span class="lineNoCov">          0 :          TIter next(list);</span>
<span class="lineNum">    3561 </span>            :          TObjString *str;
<span class="lineNum">    3562 </span><span class="lineNoCov">          0 :          while((str=(TObjString*)next())) {</span>
<span class="lineNum">    3563 </span><span class="lineNoCov">          0 :             gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;Load(\&quot;%s+g\&quot;, kTRUE);&quot;, str-&gt;GetName()));</span>
<span class="lineNum">    3564 </span>            :          }
<span class="lineNum">    3565 </span><span class="lineNoCov">          0 :          if (list) delete list;</span>
<span class="lineNum">    3566 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3567 </span><span class="lineNoCov">          0 :       if (testMode) {</span>
<span class="lineNum">    3568 </span>            :       // Register dataset to proof lite.
<span class="lineNum">    3569 </span><span class="lineNoCov">          0 :          if (fFileForTestMode.IsNull()) {</span>
<span class="lineNum">    3570 </span><span class="lineNoCov">          0 :             Error(&quot;GetChainForTestMode&quot;, &quot;For proof test mode please use SetFileForTestMode() pointing to a file that contains data file locations.&quot;);</span>
<span class="lineNum">    3571 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">    3572 </span>            :          }
<span class="lineNum">    3573 </span><span class="lineNoCov">          0 :          if (gSystem-&gt;AccessPathName(fFileForTestMode)) {</span>
<span class="lineNum">    3574 </span><span class="lineNoCov">          0 :             Error(&quot;GetChainForTestMode&quot;, &quot;File not found: %s&quot;, fFileForTestMode.Data());</span>
<span class="lineNum">    3575 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">    3576 </span>            :          }   
<span class="lineNum">    3577 </span><span class="lineNoCov">          0 :          TFileCollection *coll = new TFileCollection();</span>
<span class="lineNum">    3578 </span><span class="lineNoCov">          0 :          coll-&gt;AddFromFile(fFileForTestMode);</span>
<span class="lineNum">    3579 </span><span class="lineNoCov">          0 :          gROOT-&gt;ProcessLine(Form(&quot;gProof-&gt;RegisterDataSet(\&quot;test_collection\&quot;, (TFileCollection*)%p, \&quot;OV\&quot;);&quot;, coll));</span>
<span class="lineNum">    3580 </span><span class="lineNoCov">          0 :          gROOT-&gt;ProcessLine(&quot;gProof-&gt;ShowDataSets()&quot;);</span>
<span class="lineNum">    3581 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3582 </span><span class="lineNoCov">          0 :       return kTRUE;</span>
<span class="lineNum">    3583 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3584 </span>            :    
<span class="lineNum">    3585 </span>            :    // Check if output files have to be taken from the analysis manager
<span class="lineNum">    3586 </span><span class="lineNoCov">          0 :    if (TestBit(AliAnalysisGrid::kDefaultOutputs)) {</span>
<span class="lineNum">    3587 </span>            :       // Add output files and AOD files
<span class="lineNum">    3588 </span><span class="lineNoCov">          0 :       fOutputFiles = GetListOfFiles(&quot;outaod&quot;);</span>
<span class="lineNum">    3589 </span>            :       // Add extra files registered to the analysis manager
<span class="lineNum">    3590 </span><span class="lineNoCov">          0 :       TString extra = GetListOfFiles(&quot;ext&quot;);</span>
<span class="lineNum">    3591 </span><span class="lineNoCov">          0 :       if (!extra.IsNull()) {</span>
<span class="lineNum">    3592 </span><span class="lineNoCov">          0 :          extra.ReplaceAll(&quot;.root&quot;, &quot;*.root&quot;);</span>
<span class="lineNum">    3593 </span><span class="lineNoCov">          0 :          if (!fOutputFiles.IsNull()) fOutputFiles += &quot;,&quot;;</span>
<span class="lineNum">    3594 </span><span class="lineNoCov">          0 :          fOutputFiles += extra;</span>
<span class="lineNum">    3595 </span>            :       }
<span class="lineNum">    3596 </span>            :       // Compose the output archive.
<span class="lineNum">    3597 </span><span class="lineNoCov">          0 :       fOutputArchive = &quot;log_archive.zip:std*@disk=1 &quot;;</span>
<span class="lineNum">    3598 </span><span class="lineNoCov">          0 :       if (mgr-&gt;IsCollectThroughput())</span>
<span class="lineNum">    3599 </span><span class="lineNoCov">          0 :          fOutputArchive += Form(&quot;root_archive.zip:%s,*.stat@disk=%d %s@disk=%d&quot;,fOutputFiles.Data(),fNreplicas, mgr-&gt;GetFileInfoLog(),fNreplicas);</span>
<span class="lineNum">    3600 </span>            :       else
<span class="lineNum">    3601 </span><span class="lineNoCov">          0 :          fOutputArchive += Form(&quot;root_archive.zip:%s,*.stat@disk=%d&quot;,fOutputFiles.Data(),fNreplicas);</span>
<span class="lineNum">    3602 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3603 </span>            : //   if (!fCloseSE.Length()) fCloseSE = gSystem-&gt;Getenv(&quot;alien_CLOSE_SE&quot;);
<span class="lineNum">    3604 </span><span class="lineNoCov">          0 :    if (TestBit(AliAnalysisGrid::kOffline)) {</span>
<span class="lineNum">    3605 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;,&quot;\n##### OFFLINE MODE ##### Files to be used in GRID are produced but not copied \</span>
<span class="lineNum">    3606 </span>            :       \n                         there nor any job run. You can revise the JDL and analysis \
<span class="lineNum">    3607 </span>            :       \n                         macro then run the same in \&quot;submit\&quot; mode.&quot;);
<span class="lineNum">    3608 </span><span class="lineNoCov">          0 :    } else if (TestBit(AliAnalysisGrid::kTest)) {</span>
<span class="lineNum">    3609 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;,&quot;\n##### LOCAL MODE #####   Your analysis will be run locally on a subset of the requested \</span>
<span class="lineNum">    3610 </span>            :       \n                         dataset.&quot;);
<span class="lineNum">    3611 </span><span class="lineNoCov">          0 :    } else if (TestBit(AliAnalysisGrid::kSubmit)) {</span>
<span class="lineNum">    3612 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;,&quot;\n##### SUBMIT MODE #####  Files required by your analysis are copied to your grid working \</span>
<span class="lineNum">    3613 </span>            :       \n                         space and job submitted.&quot;);
<span class="lineNum">    3614 </span><span class="lineNoCov">          0 :    } else if (TestBit(AliAnalysisGrid::kMerge)) {</span>
<span class="lineNum">    3615 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;,&quot;\n##### MERGE MODE #####   The registered outputs of the analysis will be merged&quot;);</span>
<span class="lineNum">    3616 </span><span class="lineNoCov">          0 :       if (fMergeViaJDL) CheckInputData();</span>
<span class="lineNum">    3617 </span><span class="lineNoCov">          0 :       return kTRUE;</span>
<span class="lineNum">    3618 </span>            :    } else {
<span class="lineNum">    3619 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;,&quot;\n##### FULL ANALYSIS MODE ##### Producing needed files and submitting your analysis job...&quot;);   </span>
<span class="lineNum">    3620 </span>            :    }   
<span class="lineNum">    3621 </span>            :       
<span class="lineNum">    3622 </span><span class="lineNoCov">          0 :    Print();   </span>
<span class="lineNum">    3623 </span><span class="lineNoCov">          0 :    if (!Connect()) {</span>
<span class="lineNum">    3624 </span><span class="lineNoCov">          0 :       Error(&quot;StartAnalysis&quot;, &quot;Cannot start grid analysis without grid connection&quot;);</span>
<span class="lineNum">    3625 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3626 </span>            :    }
<span class="lineNum">    3627 </span><span class="lineNoCov">          0 :    if (IsCheckCopy() &amp;&amp; gGrid) CheckFileCopy(gGrid-&gt;GetHomeDirectory());</span>
<span class="lineNum">    3628 </span><span class="lineNoCov">          0 :    if (!CheckInputData()) {</span>
<span class="lineNum">    3629 </span><span class="lineNoCov">          0 :       Error(&quot;StartAnalysis&quot;, &quot;There was an error in preprocessing your requested input data&quot;);</span>
<span class="lineNum">    3630 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3631 </span>            :    }   
<span class="lineNum">    3632 </span><span class="lineNoCov">          0 :    if (!CreateDataset(fDataPattern)) {</span>
<span class="lineNum">    3633 </span><span class="lineNoCov">          0 :       TString serror;</span>
<span class="lineNum">    3634 </span><span class="lineNoCov">          0 :       if (!fRunNumbers.Length() &amp;&amp; !fRunRange[0]) serror = Form(&quot;path to data directory: &lt;%s&gt;&quot;, fGridDataDir.Data());</span>
<span class="lineNum">    3635 </span><span class="lineNoCov">          0 :       if (fRunNumbers.Length()) serror = &quot;run numbers&quot;;</span>
<span class="lineNum">    3636 </span><span class="lineNoCov">          0 :       if (fRunRange[0]) serror = Form(&quot;run range [%d, %d]&quot;, fRunRange[0], fRunRange[1]);</span>
<span class="lineNum">    3637 </span><span class="lineNoCov">          0 :       serror += Form(&quot;\n   or data pattern &lt;%s&gt;&quot;, fDataPattern.Data());</span>
<span class="lineNum">    3638 </span><span class="lineNoCov">          0 :       Error(&quot;StartAnalysis&quot;, &quot;No data to process. Please fix %s in your plugin configuration.&quot;, serror.Data());</span>
<span class="lineNum">    3639 </span>            :       return kFALSE;
<span class="lineNum">    3640 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    3641 </span><span class="lineNoCov">          0 :    WriteAnalysisFile();</span>
<span class="lineNum">    3642 </span><span class="lineNoCov">          0 :    WriteAnalysisMacro(nentries, firstEntry);</span>
<span class="lineNum">    3643 </span><span class="lineNoCov">          0 :    WriteExecutable();</span>
<span class="lineNum">    3644 </span><span class="lineNoCov">          0 :    WriteValidationScript();</span>
<span class="lineNum">    3645 </span><span class="lineNoCov">          0 :    if (fMergeViaJDL) {</span>
<span class="lineNum">    3646 </span><span class="lineNoCov">          0 :       WriteMergingMacro();</span>
<span class="lineNum">    3647 </span><span class="lineNoCov">          0 :       WriteMergeExecutable();</span>
<span class="lineNum">    3648 </span><span class="lineNoCov">          0 :       WriteValidationScript(kTRUE);</span>
<span class="lineNum">    3649 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    3650 </span><span class="lineNoCov">          0 :    if (!CreateJDL()) return kFALSE;</span>
<span class="lineNum">    3651 </span><span class="lineNoCov">          0 :    if (TestBit(AliAnalysisGrid::kOffline)) return kFALSE;</span>
<span class="lineNum">    3652 </span><span class="lineNoCov">          0 :    if (testMode) {</span>
<span class="lineNum">    3653 </span>            :       // Locally testing the analysis
<span class="lineNum">    3654 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;, &quot;\n_______________________________________________________________________ \</span>
<span class="lineNum">    3655 </span>            :       \n   Running analysis script in a daughter shell as on a worker node \
<span class="lineNum">    3656 </span>            :       \n_______________________________________________________________________&quot;);
<span class="lineNum">    3657 </span><span class="lineNoCov">          0 :       TObjArray *list = fOutputFiles.Tokenize(&quot;,&quot;);</span>
<span class="lineNum">    3658 </span><span class="lineNoCov">          0 :       TIter next(list);</span>
<span class="lineNum">    3659 </span>            :       TObjString *str;
<span class="lineNum">    3660 </span><span class="lineNoCov">          0 :       TString outputFile;</span>
<span class="lineNum">    3661 </span><span class="lineNoCov">          0 :       while((str=(TObjString*)next())) {</span>
<span class="lineNum">    3662 </span><span class="lineNoCov">          0 :          outputFile = str-&gt;GetString();</span>
<span class="lineNum">    3663 </span><span class="lineNoCov">          0 :          Int_t index = outputFile.Index(&quot;@&quot;);</span>
<span class="lineNum">    3664 </span><span class="lineNoCov">          0 :          if (index &gt; 0) outputFile.Remove(index);         </span>
<span class="lineNum">    3665 </span><span class="lineNoCov">          0 :          if (!gSystem-&gt;AccessPathName(outputFile)) gSystem-&gt;Exec(Form(&quot;rm %s&quot;, outputFile.Data()));</span>
<span class="lineNum">    3666 </span>            :       }
<span class="lineNum">    3667 </span><span class="lineNoCov">          0 :       delete list;</span>
<span class="lineNum">    3668 </span><span class="lineNoCov">          0 :       gSystem-&gt;Exec(Form(&quot;bash %s 2&gt;stderr&quot;, fExecutable.Data()));</span>
<span class="lineNum">    3669 </span><span class="lineNoCov">          0 :       gSystem-&gt;Exec(Form(&quot;bash %s&quot;,fValidationScript.Data()));</span>
<span class="lineNum">    3670 </span>            : //      gSystem-&gt;Exec(&quot;cat stdout&quot;);
<span class="lineNum">    3671 </span>            :       return kFALSE;
<span class="lineNum">    3672 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3673 </span>            :    // Check if submitting is managed by LPM manager
<span class="lineNum">    3674 </span><span class="lineNoCov">          0 :    if (fProductionMode) {</span>
<span class="lineNum">    3675 </span>            :       //TString prodfile = fJDLName;
<span class="lineNum">    3676 </span>            :       //prodfile.ReplaceAll(&quot;.jdl&quot;, &quot;.prod&quot;);
<span class="lineNum">    3677 </span>            :       //WriteProductionFile(prodfile);
<span class="lineNum">    3678 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;, &quot;Job submitting is managed by LPM. Rerun in terminate mode after jobs finished.&quot;);</span>
<span class="lineNum">    3679 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3680 </span>            :    }   
<span class="lineNum">    3681 </span>            :    // Submit AliEn job(s)
<span class="lineNum">    3682 </span><span class="lineNoCov">          0 :    gGrid-&gt;Cd(fGridOutputDir);</span>
<span class="lineNum">    3683 </span>            :    TGridResult *res;
<span class="lineNum">    3684 </span><span class="lineNoCov">          0 :    TString jobID = &quot;&quot;;</span>
<span class="lineNum">    3685 </span><span class="lineNoCov">          0 :    fGridJobIDs = &quot;&quot;;</span>
<span class="lineNum">    3686 </span><span class="lineNoCov">          0 :    fGridStages = &quot;&quot;;</span>
<span class="lineNum">    3687 </span><span class="lineNoCov">          0 :    if (!fRunNumbers.Length() &amp;&amp; !fRunRange[0]) {</span>
<span class="lineNum">    3688 </span>            :       // Submit a given xml or a set of runs
<span class="lineNum">    3689 </span><span class="lineNoCov">          0 :       res = gGrid-&gt;Command(Form(&quot;submit %s&quot;, fJDLName.Data()));</span>
<span class="lineNum">    3690 </span><span class="lineNoCov">          0 :       printf(&quot;*************************** %s\n&quot;,Form(&quot;submit %s&quot;, fJDLName.Data()));</span>
<span class="lineNum">    3691 </span><span class="lineNoCov">          0 :       if (res) {</span>
<span class="lineNum">    3692 </span><span class="lineNoCov">          0 :          const char *cjobId = res-&gt;GetKey(0,&quot;jobId&quot;);</span>
<span class="lineNum">    3693 </span><span class="lineNoCov">          0 :          if (!cjobId) {</span>
<span class="lineNum">    3694 </span><span class="lineNoCov">          0 :             gGrid-&gt;Stdout();</span>
<span class="lineNum">    3695 </span><span class="lineNoCov">          0 :             gGrid-&gt;Stderr();</span>
<span class="lineNum">    3696 </span><span class="lineNoCov">          0 :             Error(&quot;StartAnalysis&quot;, &quot;Your JDL %s could not be submitted&quot;, fJDLName.Data());</span>
<span class="lineNum">    3697 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">    3698 </span>            :          } else {
<span class="lineNum">    3699 </span><span class="lineNoCov">          0 :             Info(&quot;StartAnalysis&quot;, &quot;\n_______________________________________________________________________ \</span>
<span class="lineNum">    3700 </span>            :             \n#####   Your JDL %s was successfully submitted. \nTHE JOB ID IS: %s \
<span class="lineNum">    3701 </span>            :             \n_______________________________________________________________________&quot;,
<span class="lineNum">    3702 </span><span class="lineNoCov">          0 :                    fJDLName.Data(), cjobId);</span>
<span class="lineNum">    3703 </span><span class="lineNoCov">          0 :             jobID = cjobId;      </span>
<span class="lineNum">    3704 </span><span class="lineNoCov">          0 :             if (jobID.Atoi()) { </span>
<span class="lineNum">    3705 </span><span class="lineNoCov">          0 :               if (!fGridJobIDs.IsNull()) fGridJobIDs.Append(&quot; &quot;);</span>
<span class="lineNum">    3706 </span><span class="lineNoCov">          0 :               fGridJobIDs.Append(jobID);</span>
<span class="lineNum">    3707 </span><span class="lineNoCov">          0 :               if (!fGridStages.IsNull()) fGridStages.Append(&quot; &quot;);</span>
<span class="lineNum">    3708 </span><span class="lineNoCov">          0 :               fGridStages.Append(&quot;full&quot;);</span>
<span class="lineNum">    3709 </span>            :             }
<span class="lineNum">    3710 </span>            :          }          
<span class="lineNum">    3711 </span><span class="lineNoCov">          0 :          delete res;</span>
<span class="lineNum">    3712 </span><span class="lineNoCov">          0 :       } else {</span>
<span class="lineNum">    3713 </span><span class="lineNoCov">          0 :          Error(&quot;StartAnalysis&quot;, &quot;No grid result after submission !!! Bailing out...&quot;);</span>
<span class="lineNum">    3714 </span><span class="lineNoCov">          0 :          return kFALSE;      </span>
<span class="lineNum">    3715 </span>            :       }   
<span class="lineNum">    3716 </span>            :    } else {
<span class="lineNum">    3717 </span>            :       // Submit for a range of enumeration of runs.
<span class="lineNum">    3718 </span><span class="lineNoCov">          0 :       if (!Submit()) return kFALSE;</span>
<span class="lineNum">    3719 </span><span class="lineNoCov">          0 :       jobID = fGridJobIDs;</span>
<span class="lineNum">    3720 </span>            :    }   
<span class="lineNum">    3721 </span>            :          
<span class="lineNum">    3722 </span><span class="lineNoCov">          0 :    if (fDropToShell) {</span>
<span class="lineNum">    3723 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;, &quot;\n#### STARTING AN ALIEN SHELL FOR YOU. EXIT WHEN YOUR JOB %s HAS FINISHED. #### \</span>
<span class="lineNum">    3724 </span>            :       \n You may exit at any time and terminate the job later using the option &lt;terminate&gt; \
<span class="lineNum">    3725 </span><span class="lineNoCov">          0 :       \n ##################################################################################&quot;, jobID.Data());</span>
<span class="lineNum">    3726 </span><span class="lineNoCov">          0 :       gSystem-&gt;Exec(&quot;aliensh&quot;);</span>
<span class="lineNum">    3727 </span>            :    } else {
<span class="lineNum">    3728 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;, &quot;\n#### SUBMITTED JOB %s TO ALIEN QUEUE #### \</span>
<span class="lineNum">    3729 </span>            :       \n Remember to terminate the job later using the option &lt;terminate&gt; \
<span class="lineNum">    3730 </span><span class="lineNoCov">          0 :       \n ##################################################################################&quot;, jobID.Data());</span>
<span class="lineNum">    3731 </span>            :    }   
<span class="lineNum">    3732 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    3733 </span><span class="lineNoCov">          0 : }</span>
<a name="3734"><span class="lineNum">    3734 </span>            : </a>
<span class="lineNum">    3735 </span>            : //______________________________________________________________________________
<span class="lineNum">    3736 </span>            : const char *AliAnalysisAlien::GetListOfFiles(const char *type)
<span class="lineNum">    3737 </span>            : {
<span class="lineNum">    3738 </span>            : // Get a comma-separated list of output files of the requested type.
<span class="lineNum">    3739 </span>            : // Type can be (case unsensitive):
<span class="lineNum">    3740 </span>            : //    aod - list of aod files (std, extensions and filters)
<span class="lineNum">    3741 </span>            : //    out - list of output files connected to containers (but not aod's or extras)
<span class="lineNum">    3742 </span>            : //    ext - list of extra files registered to the manager
<span class="lineNum">    3743 </span>            : //    ter - list of files produced in terminate
<span class="lineNum">    3744 </span><span class="lineNoCov">          0 :    static TString files;</span>
<span class="lineNum">    3745 </span><span class="lineNoCov">          0 :    files = &quot;&quot;;</span>
<span class="lineNum">    3746 </span><span class="lineNoCov">          0 :    TString stype = type;</span>
<span class="lineNum">    3747 </span><span class="lineNoCov">          0 :    stype.ToLower();</span>
<span class="lineNum">    3748 </span><span class="lineNoCov">          0 :    TString aodfiles, extra;</span>
<span class="lineNum">    3749 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">    3750 </span><span class="lineNoCov">          0 :    if (!mgr) {</span>
<span class="lineNum">    3751 </span><span class="lineNoCov">          0 :       ::Error(&quot;GetListOfFiles&quot;, &quot;Cannot call this without analysis manager&quot;);</span>
<span class="lineNum">    3752 </span><span class="lineNoCov">          0 :       return files.Data();</span>
<span class="lineNum">    3753 </span>            :    }
<span class="lineNum">    3754 </span><span class="lineNoCov">          0 :    if (mgr-&gt;GetOutputEventHandler()) {</span>
<span class="lineNum">    3755 </span><span class="lineNoCov">          0 :       aodfiles = &quot;&quot;;</span>
<span class="lineNum">    3756 </span><span class="lineNoCov">          0 :       if (mgr-&gt;GetOutputEventHandler()-&gt;GetFillAOD())</span>
<span class="lineNum">    3757 </span><span class="lineNoCov">          0 :          aodfiles = mgr-&gt;GetOutputEventHandler()-&gt;GetOutputFileName();</span>
<span class="lineNum">    3758 </span><span class="lineNoCov">          0 :       TString extraaod = mgr-&gt;GetOutputEventHandler()-&gt;GetExtraOutputs(kTRUE);</span>
<span class="lineNum">    3759 </span><span class="lineNoCov">          0 :       if (!extraaod.IsNull() &amp;&amp; mgr-&gt;GetOutputEventHandler()-&gt;GetFillExtension()) {</span>
<span class="lineNum">    3760 </span><span class="lineNoCov">          0 :          if (!aodfiles.IsNull()) aodfiles += &quot;,&quot;;</span>
<span class="lineNum">    3761 </span><span class="lineNoCov">          0 :          aodfiles += extraaod;</span>
<span class="lineNum">    3762 </span>            :       }
<span class="lineNum">    3763 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3764 </span><span class="lineNoCov">          0 :    if (stype.Contains(&quot;aod&quot;)) {</span>
<span class="lineNum">    3765 </span><span class="lineNoCov">          0 :       files = aodfiles;</span>
<span class="lineNum">    3766 </span><span class="lineNoCov">          0 :       if (stype == &quot;aod&quot;) return files.Data();</span>
<span class="lineNum">    3767 </span>            :    }  
<span class="lineNum">    3768 </span>            :    // Add output files that are not in the list of AOD files 
<span class="lineNum">    3769 </span><span class="lineNoCov">          0 :    TString outputfiles = &quot;&quot;;</span>
<span class="lineNum">    3770 </span><span class="lineNoCov">          0 :    TIter next(mgr-&gt;GetOutputs());</span>
<span class="lineNum">    3771 </span>            :    AliAnalysisDataContainer *output;
<span class="lineNum">    3772 </span>            :    const char *filename = 0;
<span class="lineNum">    3773 </span><span class="lineNoCov">          0 :    while ((output=(AliAnalysisDataContainer*)next())) {</span>
<span class="lineNum">    3774 </span><span class="lineNoCov">          0 :       filename = output-&gt;GetFileName();</span>
<span class="lineNum">    3775 </span><span class="lineNoCov">          0 :       if (!(strcmp(filename, &quot;default&quot;))) continue;</span>
<span class="lineNum">    3776 </span><span class="lineNoCov">          0 :       if (outputfiles.Contains(filename)) continue;</span>
<span class="lineNum">    3777 </span><span class="lineNoCov">          0 :       if (aodfiles.Contains(filename))    continue;</span>
<span class="lineNum">    3778 </span><span class="lineNoCov">          0 :       if (!outputfiles.IsNull() &amp;&amp; strlen(filename)) outputfiles += &quot;,&quot;;</span>
<span class="lineNum">    3779 </span><span class="lineNoCov">          0 :       outputfiles += filename;</span>
<span class="lineNum">    3780 </span>            :    }
<span class="lineNum">    3781 </span><span class="lineNoCov">          0 :    if (stype.Contains(&quot;out&quot;)) {</span>
<span class="lineNum">    3782 </span><span class="lineNoCov">          0 :       if (!files.IsNull() &amp;&amp; !outputfiles.IsNull()) files += &quot;,&quot;;</span>
<span class="lineNum">    3783 </span><span class="lineNoCov">          0 :       files += outputfiles;</span>
<span class="lineNum">    3784 </span><span class="lineNoCov">          0 :       if (stype == &quot;out&quot;) return files.Data();</span>
<span class="lineNum">    3785 </span>            :    }   
<span class="lineNum">    3786 </span>            :    // Add extra files registered to the analysis manager
<span class="lineNum">    3787 </span><span class="lineNoCov">          0 :    TString sextra;</span>
<span class="lineNum">    3788 </span><span class="lineNoCov">          0 :    extra = mgr-&gt;GetExtraFiles();</span>
<span class="lineNum">    3789 </span><span class="lineNoCov">          0 :    if (!extra.IsNull()) {</span>
<span class="lineNum">    3790 </span><span class="lineNoCov">          0 :       extra.Strip();</span>
<span class="lineNum">    3791 </span><span class="lineNoCov">          0 :       extra.ReplaceAll(&quot; &quot;, &quot;,&quot;);</span>
<span class="lineNum">    3792 </span><span class="lineNoCov">          0 :       TObjArray *fextra = extra.Tokenize(&quot;,&quot;);</span>
<span class="lineNum">    3793 </span><span class="lineNoCov">          0 :       TIter nextx(fextra);</span>
<span class="lineNum">    3794 </span>            :       TObject *obj;
<span class="lineNum">    3795 </span><span class="lineNoCov">          0 :       while ((obj=nextx())) {</span>
<span class="lineNum">    3796 </span><span class="lineNoCov">          0 :          if (aodfiles.Contains(obj-&gt;GetName())) continue;</span>
<span class="lineNum">    3797 </span><span class="lineNoCov">          0 :          if (outputfiles.Contains(obj-&gt;GetName())) continue;</span>
<span class="lineNum">    3798 </span><span class="lineNoCov">          0 :          if (sextra.Contains(obj-&gt;GetName())) continue;</span>
<span class="lineNum">    3799 </span><span class="lineNoCov">          0 :          if (!sextra.IsNull()) sextra += &quot;,&quot;;</span>
<span class="lineNum">    3800 </span><span class="lineNoCov">          0 :          sextra += obj-&gt;GetName();</span>
<span class="lineNum">    3801 </span>            :       }
<span class="lineNum">    3802 </span><span class="lineNoCov">          0 :       delete fextra;</span>
<span class="lineNum">    3803 </span><span class="lineNoCov">          0 :       if (stype.Contains(&quot;ext&quot;)) {</span>
<span class="lineNum">    3804 </span><span class="lineNoCov">          0 :          if (!files.IsNull() &amp;&amp; !sextra.IsNull()) files += &quot;,&quot;;</span>
<span class="lineNum">    3805 </span><span class="lineNoCov">          0 :          files += sextra;</span>
<span class="lineNum">    3806 </span>            :       }
<span class="lineNum">    3807 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    3808 </span><span class="lineNoCov">          0 :    if (stype == &quot;ext&quot;) return files.Data();</span>
<span class="lineNum">    3809 </span><span class="lineNoCov">          0 :    TString termfiles;</span>
<span class="lineNum">    3810 </span><span class="lineNoCov">          0 :    if (!fTerminateFiles.IsNull()) {</span>
<span class="lineNum">    3811 </span><span class="lineNoCov">          0 :       fTerminateFiles.Strip();</span>
<span class="lineNum">    3812 </span><span class="lineNoCov">          0 :       fTerminateFiles.ReplaceAll(&quot; &quot;,&quot;,&quot;);</span>
<span class="lineNum">    3813 </span><span class="lineNoCov">          0 :       TObjArray *fextra = fTerminateFiles.Tokenize(&quot;,&quot;);</span>
<span class="lineNum">    3814 </span><span class="lineNoCov">          0 :       TIter nextx(fextra);</span>
<span class="lineNum">    3815 </span>            :       TObject *obj;
<span class="lineNum">    3816 </span><span class="lineNoCov">          0 :       while ((obj=nextx())) {</span>
<span class="lineNum">    3817 </span><span class="lineNoCov">          0 :          if (aodfiles.Contains(obj-&gt;GetName())) continue;</span>
<span class="lineNum">    3818 </span><span class="lineNoCov">          0 :          if (outputfiles.Contains(obj-&gt;GetName())) continue;</span>
<span class="lineNum">    3819 </span><span class="lineNoCov">          0 :          if (termfiles.Contains(obj-&gt;GetName())) continue;</span>
<span class="lineNum">    3820 </span><span class="lineNoCov">          0 :          if (sextra.Contains(obj-&gt;GetName())) continue;</span>
<span class="lineNum">    3821 </span><span class="lineNoCov">          0 :          if (!termfiles.IsNull()) termfiles += &quot;,&quot;;</span>
<span class="lineNum">    3822 </span><span class="lineNoCov">          0 :          termfiles += obj-&gt;GetName();</span>
<span class="lineNum">    3823 </span>            :       }
<span class="lineNum">    3824 </span><span class="lineNoCov">          0 :       delete fextra;</span>
<span class="lineNum">    3825 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    3826 </span><span class="lineNoCov">          0 :    if (stype.Contains(&quot;ter&quot;)) {</span>
<span class="lineNum">    3827 </span><span class="lineNoCov">          0 :       if (!files.IsNull() &amp;&amp; !termfiles.IsNull()) {</span>
<span class="lineNum">    3828 </span><span class="lineNoCov">          0 :          files += &quot;,&quot;;</span>
<span class="lineNum">    3829 </span><span class="lineNoCov">          0 :          files += termfiles;</span>
<span class="lineNum">    3830 </span>            :       }   
<span class="lineNum">    3831 </span>            :    }   
<span class="lineNum">    3832 </span><span class="lineNoCov">          0 :    return files.Data();</span>
<span class="lineNum">    3833 </span><span class="lineNoCov">          0 : }   </span>
<a name="3834"><span class="lineNum">    3834 </span>            : </a>
<span class="lineNum">    3835 </span>            : //______________________________________________________________________________
<span class="lineNum">    3836 </span>            : Bool_t AliAnalysisAlien::Submit()
<span class="lineNum">    3837 </span>            : {
<span class="lineNum">    3838 </span>            : // Submit all master jobs.
<span class="lineNum">    3839 </span><span class="lineNoCov">          0 :    Int_t nmasterjobs = fInputFiles-&gt;GetEntries();</span>
<span class="lineNum">    3840 </span><span class="lineNoCov">          0 :    Long_t tshoot = gSystem-&gt;Now();</span>
<span class="lineNum">    3841 </span><span class="lineNoCov">          0 :    if (!fNsubmitted &amp;&amp; !SubmitNext()) return kFALSE;</span>
<span class="lineNum">    3842 </span><span class="lineNoCov">          0 :    while (fNsubmitted &lt; nmasterjobs) {</span>
<span class="lineNum">    3843 </span><span class="lineNoCov">          0 :       Long_t now = gSystem-&gt;Now();</span>
<span class="lineNum">    3844 </span><span class="lineNoCov">          0 :       if ((now-tshoot)&gt;30000) {</span>
<span class="lineNum">    3845 </span>            :          tshoot = now;
<span class="lineNum">    3846 </span><span class="lineNoCov">          0 :          if (!SubmitNext()) return kFALSE;</span>
<span class="lineNum">    3847 </span>            :       }   
<span class="lineNum">    3848 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3849 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    3850 </span><span class="lineNoCov">          0 : }</span>
<a name="3851"><span class="lineNum">    3851 </span>            : </a>
<span class="lineNum">    3852 </span>            : //______________________________________________________________________________
<span class="lineNum">    3853 </span>            : Bool_t AliAnalysisAlien::SubmitMerging()
<span class="lineNum">    3854 </span>            : {
<span class="lineNum">    3855 </span>            : // Submit all merging jobs.
<span class="lineNum">    3856 </span><span class="lineNoCov">          0 :    if (!fGridOutputDir.Contains(&quot;/&quot;)) fGridOutputDir = Form(&quot;%s/%s/%s&quot;, gGrid-&gt;GetHomeDirectory(), fGridWorkingDir.Data(), fGridOutputDir.Data());</span>
<span class="lineNum">    3857 </span><span class="lineNoCov">          0 :    gGrid-&gt;Cd(fGridOutputDir);</span>
<span class="lineNum">    3858 </span><span class="lineNoCov">          0 :    TString mergeJDLName = fExecutable;</span>
<span class="lineNum">    3859 </span><span class="lineNoCov">          0 :    mergeJDLName.ReplaceAll(&quot;.sh&quot;, &quot;_merge.jdl&quot;);</span>
<span class="lineNum">    3860 </span><span class="lineNoCov">          0 :    if (!fInputFiles) {</span>
<span class="lineNum">    3861 </span><span class="lineNoCov">          0 :       Error(&quot;SubmitMerging&quot;, &quot;You have to use explicit run numbers or run range to merge via JDL!&quot;);</span>
<span class="lineNum">    3862 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    3863 </span>            :    }   
<span class="lineNum">    3864 </span><span class="lineNoCov">          0 :    Int_t ntosubmit = fInputFiles-&gt;GetEntries();</span>
<span class="lineNum">    3865 </span><span class="lineNoCov">          0 :    for (Int_t i=0; i&lt;ntosubmit; i++) {</span>
<span class="lineNum">    3866 </span><span class="lineNoCov">          0 :       TString runOutDir = gSystem-&gt;BaseName(fInputFiles-&gt;At(i)-&gt;GetName());</span>
<span class="lineNum">    3867 </span><span class="lineNoCov">          0 :       runOutDir.ReplaceAll(&quot;.xml&quot;, &quot;&quot;);</span>
<span class="lineNum">    3868 </span><span class="lineNoCov">          0 :       if (fOutputToRunNo) {</span>
<span class="lineNum">    3869 </span>            :          // The output directory is the run number
<span class="lineNum">    3870 </span><span class="lineNoCov">          0 :          printf(&quot;### Submitting merging job for run &lt;%s&gt;\n&quot;, runOutDir.Data());</span>
<span class="lineNum">    3871 </span><span class="lineNoCov">          0 :          runOutDir = Form(&quot;%s/%s&quot;, fGridOutputDir.Data(), runOutDir.Data());</span>
<span class="lineNum">    3872 </span>            :       } else {
<span class="lineNum">    3873 </span><span class="lineNoCov">          0 :          if (!fRunNumbers.Length() &amp;&amp; !fRunRange[0]) {</span>
<span class="lineNum">    3874 </span>            :             // The output directory is the grid outdir
<span class="lineNum">    3875 </span><span class="lineNoCov">          0 :             printf(&quot;### Submitting merging job for the full output directory %s.\n&quot;, fGridOutputDir.Data());</span>
<span class="lineNum">    3876 </span><span class="lineNoCov">          0 :             runOutDir = fGridOutputDir;</span>
<span class="lineNum">    3877 </span>            :          } else {
<span class="lineNum">    3878 </span>            :             // The output directory is the master number in 3 digits format
<span class="lineNum">    3879 </span><span class="lineNoCov">          0 :             printf(&quot;### Submitting merging job for master &lt;%03d&gt;\n&quot;, i);</span>
<span class="lineNum">    3880 </span><span class="lineNoCov">          0 :             runOutDir = Form(&quot;%s/%03d&quot;,fGridOutputDir.Data(), i);</span>
<span class="lineNum">    3881 </span>            :          }   
<span class="lineNum">    3882 </span>            :       }
<span class="lineNum">    3883 </span>            :       // Check now the number of merging stages.
<span class="lineNum">    3884 </span><span class="lineNoCov">          0 :       TObjArray *list = fOutputFiles.Tokenize(&quot;,&quot;);</span>
<span class="lineNum">    3885 </span><span class="lineNoCov">          0 :       TIter next(list);</span>
<span class="lineNum">    3886 </span>            :       TObjString *str;
<span class="lineNum">    3887 </span><span class="lineNoCov">          0 :       TString outputFile;</span>
<span class="lineNum">    3888 </span><span class="lineNoCov">          0 :       while((str=(TObjString*)next())) {</span>
<span class="lineNum">    3889 </span><span class="lineNoCov">          0 :          outputFile = str-&gt;GetString();</span>
<span class="lineNum">    3890 </span><span class="lineNoCov">          0 :          Int_t index = outputFile.Index(&quot;@&quot;);</span>
<span class="lineNum">    3891 </span><span class="lineNoCov">          0 :          if (index &gt; 0) outputFile.Remove(index);</span>
<span class="lineNum">    3892 </span><span class="lineNoCov">          0 :          if (!fMergeExcludes.Contains(outputFile) &amp;&amp; </span>
<span class="lineNum">    3893 </span><span class="lineNoCov">          0 :              !fRegisterExcludes.Contains(outputFile)) break;</span>
<span class="lineNum">    3894 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3895 </span><span class="lineNoCov">          0 :       delete list;</span>
<span class="lineNum">    3896 </span><span class="lineNoCov">          0 :       Bool_t done = CheckMergedFiles(outputFile, runOutDir, fMaxMergeFiles, mergeJDLName);</span>
<span class="lineNum">    3897 </span><span class="lineNoCov">          0 :       if (!done &amp;&amp; (i==ntosubmit-1)) return kFALSE;</span>
<span class="lineNum">    3898 </span><span class="lineNoCov">          0 :       if (!fRunNumbers.Length() &amp;&amp; !fRunRange[0]) break;</span>
<span class="lineNum">    3899 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3900 </span><span class="lineNoCov">          0 :    if (!ntosubmit) return kTRUE;</span>
<span class="lineNum">    3901 </span><span class="lineNoCov">          0 :    if (fDropToShell) {</span>
<span class="lineNum">    3902 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;, &quot;\n #### STARTING AN ALIEN SHELL FOR YOU. You can exit any time or inspect your jobs in a different shell.##########\</span>
<span class="lineNum">    3903 </span>            :                              \n Make sure your jobs are in a final state (you can resubmit failed ones via 'masterjob &lt;id&gt; resubmit ERROR_ALL')\
<span class="lineNum">    3904 </span>            :                              \n Rerun in 'terminate' mode to submit all merging stages, each AFTER the previous one completed. The final merged \
<span class="lineNum">    3905 </span>            :                              \n output will be written to your alien output directory, while separate stages in &lt;Stage_n&gt;. \
<span class="lineNum">    3906 </span>            :                              \n ################################################################################################################&quot;);
<span class="lineNum">    3907 </span><span class="lineNoCov">          0 :       gSystem-&gt;Exec(&quot;aliensh&quot;);</span>
<span class="lineNum">    3908 </span>            :    } else {
<span class="lineNum">    3909 </span><span class="lineNoCov">          0 :       Info(&quot;StartAnalysis&quot;, &quot;\n #### STARTED MERGING JOBS FOR YOU #### \</span>
<span class="lineNum">    3910 </span>            :                              \n Make sure your jobs are in a final state (you can resubmit failed ones via 'masterjob &lt;id&gt; resubmit ERROR_ALL') \
<span class="lineNum">    3911 </span>            :                              \n Rerun in 'terminate' mode to submit all merging stages, each AFTER the previous one completed. The final merged \
<span class="lineNum">    3912 </span>            :                              \n output will be written to your alien output directory, while separate stages in &lt;Stage_n&gt;. \
<span class="lineNum">    3913 </span>            :                              \n ################################################################################################################&quot;);   
<span class="lineNum">    3914 </span>            :    }   
<span class="lineNum">    3915 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    3916 </span><span class="lineNoCov">          0 : }</span>
<a name="3917"><span class="lineNum">    3917 </span>            : </a>
<span class="lineNum">    3918 </span>            : //______________________________________________________________________________
<span class="lineNum">    3919 </span>            : Bool_t AliAnalysisAlien::SubmitNext()
<span class="lineNum">    3920 </span>            : {
<span class="lineNum">    3921 </span>            : // Submit next bunch of master jobs if the queue is free. The first master job is
<span class="lineNum">    3922 </span>            : // submitted right away, while the next will not be unless the previous was split.
<span class="lineNum">    3923 </span>            : // The plugin will not submit new master jobs if there are more that 500 jobs in
<span class="lineNum">    3924 </span>            : // waiting phase.
<span class="lineNum">    3925 </span>            :    static Bool_t iscalled = kFALSE;
<span class="lineNum">    3926 </span>            :    static Int_t firstmaster = 0;
<span class="lineNum">    3927 </span>            :    static Int_t lastmaster = 0;
<span class="lineNum">    3928 </span>            :    static Int_t npermaster  = 0;
<span class="lineNum">    3929 </span><span class="lineNoCov">          0 :    if (iscalled) return kTRUE;</span>
<span class="lineNum">    3930 </span><span class="lineNoCov">          0 :    iscalled = kTRUE;</span>
<span class="lineNum">    3931 </span><span class="lineNoCov">          0 :    Int_t nrunning=0, nwaiting=0, nerror=0, ndone=0;</span>
<span class="lineNum">    3932 </span>            :    Int_t ntosubmit = 0;
<span class="lineNum">    3933 </span>            :    TGridResult *res;
<span class="lineNum">    3934 </span><span class="lineNoCov">          0 :    TString jobID = &quot;&quot;;</span>
<span class="lineNum">    3935 </span><span class="lineNoCov">          0 :    Int_t nmasterjobs = fInputFiles-&gt;GetEntries();</span>
<span class="lineNum">    3936 </span><span class="lineNoCov">          0 :    if (!fNsubmitted) {</span>
<span class="lineNum">    3937 </span>            :       ntosubmit = 1;
<span class="lineNum">    3938 </span><span class="lineNoCov">          0 :       if (!IsUseSubmitPolicy()) {</span>
<span class="lineNum">    3939 </span><span class="lineNoCov">          0 :          if (nmasterjobs&gt;5)</span>
<span class="lineNum">    3940 </span><span class="lineNoCov">          0 :             Info(&quot;SubmitNext&quot;,&quot;### Warning submit policy not used ! Submitting too many jobs at a time may be prohibitted. \</span>
<span class="lineNum">    3941 </span>            :                 \n### You can use SetUseSubmitPolicy() to enable if you have problems.&quot;);
<span class="lineNum">    3942 </span>            :          ntosubmit = nmasterjobs;
<span class="lineNum">    3943 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    3944 </span>            :    } else {
<span class="lineNum">    3945 </span><span class="lineNoCov">          0 :       TString status = GetJobStatus(firstmaster, lastmaster, nrunning, nwaiting, nerror, ndone);</span>
<span class="lineNum">    3946 </span><span class="lineNoCov">          0 :       printf(&quot;=== master %d: %s\n&quot;, lastmaster, status.Data());</span>
<span class="lineNum">    3947 </span>            :       // If last master not split, just return
<span class="lineNum">    3948 </span><span class="lineNoCov">          0 :       if (status != &quot;SPLIT&quot;) {iscalled = kFALSE; return kTRUE;}</span>
<span class="lineNum">    3949 </span>            :       // No more than 100 waiting jobs
<span class="lineNum">    3950 </span><span class="lineNoCov">          0 :       if (nwaiting&gt;500) {iscalled = kFALSE; return kTRUE;}</span>
<span class="lineNum">    3951 </span><span class="lineNoCov">          0 :       npermaster = (nrunning+nwaiting+nerror+ndone)/fNsubmitted;      </span>
<span class="lineNum">    3952 </span><span class="lineNoCov">          0 :       if (npermaster) ntosubmit = (500-nwaiting)/npermaster;</span>
<span class="lineNum">    3953 </span><span class="lineNoCov">          0 :       if (!ntosubmit) ntosubmit = 1;</span>
<span class="lineNum">    3954 </span><span class="lineNoCov">          0 :       printf(&quot;=== WAITING(%d) RUNNING(%d) DONE(%d) OTHER(%d) NperMaster=%d =&gt; to submit %d jobs\n&quot;, </span>
<span class="lineNum">    3955 </span><span class="lineNoCov">          0 :              nwaiting, nrunning, ndone, nerror, npermaster, ntosubmit);</span>
<span class="lineNum">    3956 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3957 </span><span class="lineNoCov">          0 :    for (Int_t i=0; i&lt;ntosubmit; i++) {</span>
<span class="lineNum">    3958 </span>            :       // Submit for a range of enumeration of runs.
<span class="lineNum">    3959 </span><span class="lineNoCov">          0 :       if (fNsubmitted&gt;=nmasterjobs) {iscalled = kFALSE; return kTRUE;}</span>
<span class="lineNum">    3960 </span><span class="lineNoCov">          0 :       TString query;</span>
<span class="lineNum">    3961 </span><span class="lineNoCov">          0 :       TString runOutDir = gSystem-&gt;BaseName(fInputFiles-&gt;At(fNsubmitted)-&gt;GetName());</span>
<span class="lineNum">    3962 </span><span class="lineNoCov">          0 :       runOutDir.ReplaceAll(&quot;.xml&quot;, &quot;&quot;);</span>
<span class="lineNum">    3963 </span><span class="lineNoCov">          0 :       if (fOutputToRunNo)</span>
<span class="lineNum">    3964 </span><span class="lineNoCov">          0 :          query = Form(&quot;submit %s %s %s&quot;, fJDLName.Data(), fInputFiles-&gt;At(fNsubmitted)-&gt;GetName(), runOutDir.Data());</span>
<span class="lineNum">    3965 </span>            :       else
<span class="lineNum">    3966 </span><span class="lineNoCov">          0 :          query = Form(&quot;submit %s %s %03d&quot;, fJDLName.Data(), fInputFiles-&gt;At(fNsubmitted)-&gt;GetName(), fNsubmitted);</span>
<span class="lineNum">    3967 </span><span class="lineNoCov">          0 :       printf(&quot;********* %s\n&quot;,query.Data());</span>
<span class="lineNum">    3968 </span><span class="lineNoCov">          0 :       res = gGrid-&gt;Command(query);</span>
<span class="lineNum">    3969 </span><span class="lineNoCov">          0 :       if (res) {</span>
<span class="lineNum">    3970 </span><span class="lineNoCov">          0 :          TString cjobId1 = res-&gt;GetKey(0,&quot;jobId&quot;);</span>
<span class="lineNum">    3971 </span><span class="lineNoCov">          0 :          if (!cjobId1.Length()) {</span>
<span class="lineNum">    3972 </span><span class="lineNoCov">          0 :             iscalled = kFALSE;</span>
<span class="lineNum">    3973 </span><span class="lineNoCov">          0 :             gGrid-&gt;Stdout();</span>
<span class="lineNum">    3974 </span><span class="lineNoCov">          0 :             gGrid-&gt;Stderr();</span>
<span class="lineNum">    3975 </span><span class="lineNoCov">          0 :             Error(&quot;StartAnalysis&quot;, &quot;Your JDL %s could not be submitted. The message was:&quot;, fJDLName.Data());</span>
<span class="lineNum">    3976 </span><span class="lineNoCov">          0 :             return kFALSE;</span>
<span class="lineNum">    3977 </span>            :          } else {
<span class="lineNum">    3978 </span><span class="lineNoCov">          0 :             Info(&quot;StartAnalysis&quot;, &quot;\n_______________________________________________________________________ \</span>
<span class="lineNum">    3979 </span>            :             \n#####   Your JDL %s submitted (%d to go). \nTHE JOB ID IS: %s \
<span class="lineNum">    3980 </span>            :             \n_______________________________________________________________________&quot;,
<span class="lineNum">    3981 </span><span class="lineNoCov">          0 :                 fJDLName.Data(), nmasterjobs-fNsubmitted-1, cjobId1.Data());</span>
<span class="lineNum">    3982 </span><span class="lineNoCov">          0 :             if (!fGridJobIDs.IsNull()) fGridJobIDs.Append(&quot; &quot;);</span>
<span class="lineNum">    3983 </span><span class="lineNoCov">          0 :             fGridJobIDs.Append(cjobId1);</span>
<span class="lineNum">    3984 </span><span class="lineNoCov">          0 :             if (!fGridStages.IsNull()) fGridStages.Append(&quot; &quot;);</span>
<span class="lineNum">    3985 </span><span class="lineNoCov">          0 :             fGridStages.Append(&quot;full&quot;);</span>
<span class="lineNum">    3986 </span><span class="lineNoCov">          0 :             jobID += cjobId1;</span>
<span class="lineNum">    3987 </span><span class="lineNoCov">          0 :             jobID += &quot; &quot;;</span>
<span class="lineNum">    3988 </span><span class="lineNoCov">          0 :             lastmaster = cjobId1.Atoi();</span>
<span class="lineNum">    3989 </span><span class="lineNoCov">          0 :             if (!firstmaster) firstmaster = lastmaster;</span>
<span class="lineNum">    3990 </span><span class="lineNoCov">          0 :             fNsubmitted++;</span>
<span class="lineNum">    3991 </span>            :          }          
<span class="lineNum">    3992 </span><span class="lineNoCov">          0 :          delete res;</span>
<span class="lineNum">    3993 </span><span class="lineNoCov">          0 :       } else {</span>
<span class="lineNum">    3994 </span><span class="lineNoCov">          0 :          Error(&quot;StartAnalysis&quot;, &quot;No grid result after submission !!! Bailing out...&quot;);</span>
<span class="lineNum">    3995 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    3996 </span>            :       }   
<span class="lineNum">    3997 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    3998 </span><span class="lineNoCov">          0 :    iscalled = kFALSE;</span>
<span class="lineNum">    3999 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    4000 </span><span class="lineNoCov">          0 : }</span>
<a name="4001"><span class="lineNum">    4001 </span>            : </a>
<span class="lineNum">    4002 </span>            : //______________________________________________________________________________
<span class="lineNum">    4003 </span>            : void AliAnalysisAlien::WriteAnalysisFile()
<span class="lineNum">    4004 </span>            : {
<span class="lineNum">    4005 </span>            : // Write current analysis manager into the file &lt;analysisFile&gt;
<span class="lineNum">    4006 </span><span class="lineNoCov">          0 :    TString analysisFile = fExecutable;</span>
<span class="lineNum">    4007 </span><span class="lineNoCov">          0 :    analysisFile.ReplaceAll(&quot;.sh&quot;, &quot;.root&quot;);</span>
<span class="lineNum">    4008 </span><span class="lineNoCov">          0 :    if (!TestBit(AliAnalysisGrid::kSubmit)) {  </span>
<span class="lineNum">    4009 </span><span class="lineNoCov">          0 :       AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">    4010 </span><span class="lineNoCov">          0 :       if (!mgr || !mgr-&gt;IsInitialized()) {</span>
<span class="lineNum">    4011 </span><span class="lineNoCov">          0 :          Error(&quot;WriteAnalysisFile&quot;, &quot;You need an initialized analysis manager for this&quot;);</span>
<span class="lineNum">    4012 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    4013 </span>            :       }
<span class="lineNum">    4014 </span>            :       // Check analysis type
<span class="lineNum">    4015 </span>            :       TObject *handler;
<span class="lineNum">    4016 </span><span class="lineNoCov">          0 :       if (mgr-&gt;GetMCtruthEventHandler()) TObject::SetBit(AliAnalysisGrid::kUseMC);</span>
<span class="lineNum">    4017 </span><span class="lineNoCov">          0 :       handler = (TObject*)mgr-&gt;GetInputEventHandler();</span>
<span class="lineNum">    4018 </span><span class="lineNoCov">          0 :       if (handler) {</span>
<span class="lineNum">    4019 </span><span class="lineNoCov">          0 :          if (handler-&gt;InheritsFrom(&quot;AliMultiInputEventHandler&quot;)) {</span>
<span class="lineNum">    4020 </span><span class="lineNoCov">          0 :             AliMultiInputEventHandler *multiIH = (AliMultiInputEventHandler*)handler;</span>
<span class="lineNum">    4021 </span><span class="lineNoCov">          0 :             if (multiIH-&gt;GetFirstInputEventHandler()-&gt;InheritsFrom(&quot;AliESDInputHandler&quot;)) TObject::SetBit(AliAnalysisGrid::kUseESD);</span>
<span class="lineNum">    4022 </span><span class="lineNoCov">          0 :             if (multiIH-&gt;GetFirstInputEventHandler()-&gt;InheritsFrom(&quot;AliAODInputHandler&quot;)) TObject::SetBit(AliAnalysisGrid::kUseAOD);</span>
<span class="lineNum">    4023 </span><span class="lineNoCov">          0 :          } else {</span>
<span class="lineNum">    4024 </span><span class="lineNoCov">          0 :             if (handler-&gt;InheritsFrom(&quot;AliESDInputHandler&quot;)) TObject::SetBit(AliAnalysisGrid::kUseESD);</span>
<span class="lineNum">    4025 </span><span class="lineNoCov">          0 :             if (handler-&gt;InheritsFrom(&quot;AliAODInputHandler&quot;)) TObject::SetBit(AliAnalysisGrid::kUseAOD);</span>
<span class="lineNum">    4026 </span>            :          }
<span class="lineNum">    4027 </span>            :       }
<span class="lineNum">    4028 </span><span class="lineNoCov">          0 :       TDirectory *cdir = gDirectory;</span>
<span class="lineNum">    4029 </span><span class="lineNoCov">          0 :       TFile *file = TFile::Open(analysisFile, &quot;RECREATE&quot;);</span>
<span class="lineNum">    4030 </span><span class="lineNoCov">          0 :       if (file) {</span>
<span class="lineNum">    4031 </span>            :          // Skip task Terminate calls for the grid job (but not in test mode, where we want to check also the terminate mode
<span class="lineNum">    4032 </span><span class="lineNoCov">          0 :          if (!TestBit(AliAnalysisGrid::kTest)) mgr-&gt;SetSkipTerminate(kTRUE);</span>
<span class="lineNum">    4033 </span>            :          // Unless merging makes no sense
<span class="lineNum">    4034 </span><span class="lineNoCov">          0 :          if (IsSingleOutput()) mgr-&gt;SetSkipTerminate(kFALSE);</span>
<span class="lineNum">    4035 </span><span class="lineNoCov">          0 :          mgr-&gt;Write();</span>
<span class="lineNum">    4036 </span><span class="lineNoCov">          0 :          delete file;</span>
<span class="lineNum">    4037 </span>            :          // Enable termination for local jobs
<span class="lineNum">    4038 </span><span class="lineNoCov">          0 :          mgr-&gt;SetSkipTerminate(kFALSE);</span>
<span class="lineNum">    4039 </span>            :       }
<span class="lineNum">    4040 </span><span class="lineNoCov">          0 :       if (cdir) cdir-&gt;cd();</span>
<span class="lineNum">    4041 </span><span class="lineNoCov">          0 :       Info(&quot;WriteAnalysisFile&quot;, &quot;\n#####   Analysis manager: %s wrote to file &lt;%s&gt;\n&quot;, mgr-&gt;GetName(),analysisFile.Data());</span>
<span class="lineNum">    4042 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    4043 </span>            :    Bool_t copy = kTRUE;
<span class="lineNum">    4044 </span><span class="lineNoCov">          0 :    if (fProductionMode || TestBit(AliAnalysisGrid::kOffline) || TestBit(AliAnalysisGrid::kTest)) copy = kFALSE;</span>
<span class="lineNum">    4045 </span><span class="lineNoCov">          0 :    if (copy) {</span>
<span class="lineNum">    4046 </span><span class="lineNoCov">          0 :       CdWork();</span>
<span class="lineNum">    4047 </span><span class="lineNoCov">          0 :       TString workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    4048 </span><span class="lineNoCov">          0 :       workdir += fGridWorkingDir;</span>
<span class="lineNum">    4049 </span><span class="lineNoCov">          0 :       Info(&quot;WriteAnalysisFile&quot;, &quot;\n#####   Copying file &lt;%s&gt; containing your initialized analysis manager to your alien workspace&quot;, analysisFile.Data());</span>
<span class="lineNum">    4050 </span><span class="lineNoCov">          0 :       if (FileExists(analysisFile)) gGrid-&gt;Rm(analysisFile);</span>
<span class="lineNum">    4051 </span><span class="lineNoCov">          0 :       if (!copyLocal2Alien(&quot;WriteAnalysisFile&quot;,analysisFile.Data(), </span>
<span class="lineNum">    4052 </span><span class="lineNoCov">          0 :           Form(&quot;%s/%s&quot;, workdir.Data(),analysisFile.Data()))) Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    4053 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    4054 </span><span class="lineNoCov">          0 : }</span>
<a name="4055"><span class="lineNum">    4055 </span>            : </a>
<span class="lineNum">    4056 </span>            : //______________________________________________________________________________
<span class="lineNum">    4057 </span>            : void AliAnalysisAlien::WriteAnalysisMacro(Long64_t nentries, Long64_t firstentry)
<span class="lineNum">    4058 </span>            : {
<span class="lineNum">    4059 </span>            : // Write the analysis macro that will steer the analysis in grid mode.
<span class="lineNum">    4060 </span><span class="lineNoCov">          0 :    if (!TestBit(AliAnalysisGrid::kSubmit)) {  </span>
<span class="lineNum">    4061 </span><span class="lineNoCov">          0 :       ofstream out;</span>
<span class="lineNum">    4062 </span><span class="lineNoCov">          0 :       out.open(fAnalysisMacro.Data(), ios::out);</span>
<span class="lineNum">    4063 </span><span class="lineNoCov">          0 :       if (!out.good()) {</span>
<span class="lineNum">    4064 </span><span class="lineNoCov">          0 :          Error(&quot;WriteAnalysisMacro&quot;, &quot;could not open file %s for writing&quot;, fAnalysisMacro.Data());</span>
<span class="lineNum">    4065 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    4066 </span>            :       }
<span class="lineNum">    4067 </span>            :       Bool_t hasSTEERBase = kFALSE;
<span class="lineNum">    4068 </span>            :       Bool_t hasESD = kFALSE;
<span class="lineNum">    4069 </span>            :       Bool_t hasAOD = kFALSE;
<span class="lineNum">    4070 </span>            :       Bool_t hasANALYSIS = kFALSE;
<span class="lineNum">    4071 </span>            :       Bool_t hasOADB = kFALSE;
<span class="lineNum">    4072 </span>            :       Bool_t hasANALYSISalice = kFALSE;
<span class="lineNum">    4073 </span>            :       Bool_t hasCORRFW = kFALSE;
<span class="lineNum">    4074 </span><span class="lineNoCov">          0 :       TString func = fAnalysisMacro;</span>
<span class="lineNum">    4075 </span><span class="lineNoCov">          0 :       TString type = &quot;ESD&quot;;</span>
<span class="lineNum">    4076 </span><span class="lineNoCov">          0 :       TString comment = &quot;// Analysis using &quot;;</span>
<span class="lineNum">    4077 </span><span class="lineNoCov">          0 :       if (fMCLoop) {</span>
<span class="lineNum">    4078 </span><span class="lineNoCov">          0 :          type = &quot;MCGEN&quot;;</span>
<span class="lineNum">    4079 </span><span class="lineNoCov">          0 :          comment += &quot;MCGEN&quot;;</span>
<span class="lineNum">    4080 </span>            :       } else {
<span class="lineNum">    4081 </span><span class="lineNoCov">          0 :          if (IsUseMCchain()) {</span>
<span class="lineNum">    4082 </span><span class="lineNoCov">          0 :             type = &quot;MC&quot;;</span>
<span class="lineNum">    4083 </span><span class="lineNoCov">          0 :             comment += &quot;MC&quot;;</span>
<span class="lineNum">    4084 </span>            :          } else {   
<span class="lineNum">    4085 </span><span class="lineNoCov">          0 :             if (TObject::TestBit(AliAnalysisGrid::kUseESD)) comment += &quot;ESD&quot;;</span>
<span class="lineNum">    4086 </span><span class="lineNoCov">          0 :             if (TObject::TestBit(AliAnalysisGrid::kUseAOD)) {</span>
<span class="lineNum">    4087 </span><span class="lineNoCov">          0 :                type = &quot;AOD&quot;;</span>
<span class="lineNum">    4088 </span><span class="lineNoCov">          0 :                comment += &quot;AOD&quot;;</span>
<span class="lineNum">    4089 </span>            :             }   
<span class="lineNum">    4090 </span>            :          }
<span class="lineNum">    4091 </span>            :       }   
<span class="lineNum">    4092 </span><span class="lineNoCov">          0 :       if (type!=&quot;AOD&quot; &amp;&amp; fFriendChainName!=&quot;&quot;) {</span>
<span class="lineNum">    4093 </span><span class="lineNoCov">          0 :          Error(&quot;WriteAnalysisMacro&quot;, &quot;Friend chain can be attached only to AOD&quot;);</span>
<span class="lineNum">    4094 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    4095 </span>            :       }
<span class="lineNum">    4096 </span><span class="lineNoCov">          0 :       if (TObject::TestBit(AliAnalysisGrid::kUseMC)) comment += &quot;/MC&quot;;</span>
<span class="lineNum">    4097 </span><span class="lineNoCov">          0 :       else comment += &quot; data&quot;;</span>
<span class="lineNum">    4098 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;TChain* CreateChain(const char *xmlfile, const char *type=\&quot;ESD\&quot;);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4099 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;const char *anatype = \&quot;&quot; &lt;&lt; type.Data() &lt;&lt; &quot;\&quot;;&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4100 </span><span class="lineNoCov">          0 :       func.ReplaceAll(&quot;.C&quot;, &quot;&quot;);</span>
<span class="lineNum">    4101 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;void &quot; &lt;&lt; func.Data() &lt;&lt; &quot;()&quot; &lt;&lt; endl; </span>
<span class="lineNum">    4102 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;{&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4103 </span><span class="lineNoCov">          0 :       out &lt;&lt; comment.Data() &lt;&lt; endl;</span>
<span class="lineNum">    4104 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Automatically generated analysis steering macro executed in grid subjobs&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4105 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TStopwatch timer;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4106 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   timer.Start();&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4107 </span>            :       // Change temp directory to current one
<span class="lineNum">    4108 </span><span class="lineNoCov">          0 :       if (!IsLocalTest()) {  </span>
<span class="lineNum">    4109 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// connect to AliEn and make the chain&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4110 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   if (!TGrid::Connect(\&quot;alien://\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4111 </span>            :       }   
<span class="lineNum">    4112 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Set temporary merging directory to current one&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4113 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   gSystem-&gt;Setenv(\&quot;TMPDIR\&quot;, gSystem-&gt;pwd());&quot; &lt;&lt; endl &lt;&lt; endl;   </span>
<span class="lineNum">    4114 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Set temporary compilation directory to current one&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4115 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   gSystem-&gt;SetBuildDir(gSystem-&gt;pwd(), kTRUE);&quot; &lt;&lt; endl &lt;&lt; endl;   </span>
<span class="lineNum">    4116 </span>            :       // Reset existing include path
<span class="lineNum">    4117 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Reset existing include path and add current directory first in the search&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4118 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   gSystem-&gt;SetIncludePath(\&quot;-I.\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4119 </span><span class="lineNoCov">          0 :       if (!fExecutableCommand.Contains(&quot;aliroot&quot;)) {</span>
<span class="lineNum">    4120 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// load base root libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4121 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libTree\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4122 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libGeom\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4123 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libVMC\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4124 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libPhysics\&quot;);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4125 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libMinuit\&quot;);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4126 </span>            :       }   
<span class="lineNum">    4127 </span><span class="lineNoCov">          0 :       if (fAdditionalRootLibs.Length()) {</span>
<span class="lineNum">    4128 </span>            :          // in principle libtree /lib geom libvmc etc. can go into this list, too
<span class="lineNum">    4129 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// Add aditional libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4130 </span><span class="lineNoCov">          0 :          TObjArray *list = fAdditionalRootLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    4131 </span><span class="lineNoCov">          0 :          TIter next(list);</span>
<span class="lineNum">    4132 </span>            :          TObjString *str;
<span class="lineNum">    4133 </span><span class="lineNoCov">          0 :          TString buf;</span>
<span class="lineNum">    4134 </span><span class="lineNoCov">          0 :          while((str=(TObjString*)next())) {</span>
<span class="lineNum">    4135 </span><span class="lineNoCov">          0 :             buf = str-&gt;GetString();</span>
<span class="lineNum">    4136 </span><span class="lineNoCov">          0 :             if (buf.Contains(&quot;.so&quot;) || buf.Contains(&quot;.dylib&quot;)) {</span>
<span class="lineNum">    4137 </span><span class="lineNoCov">          0 :                buf.ReplaceAll(&quot;.so&quot;, &quot;&quot;);</span>
<span class="lineNum">    4138 </span><span class="lineNoCov">          0 :                buf.ReplaceAll(&quot;.dylib&quot;, &quot;&quot;);</span>
<span class="lineNum">    4139 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;&quot; &lt;&lt; buf.Data() &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4140 </span>            :             }
<span class="lineNum">    4141 </span>            :          }
<span class="lineNum">    4142 </span><span class="lineNoCov">          0 :          if (list) delete list;</span>
<span class="lineNum">    4143 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4144 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Load analysis framework libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4145 </span><span class="lineNoCov">          0 :       TString setupPar = &quot;AliAnalysisAlien::SetupPar&quot;;</span>
<span class="lineNum">    4146 </span><span class="lineNoCov">          0 :       if (!fPackages) {</span>
<span class="lineNum">    4147 </span><span class="lineNoCov">          0 :          if (!fExecutableCommand.Contains(&quot;aliroot&quot;)) {         </span>
<span class="lineNum">    4148 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libSTEERBase\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4149 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libESD\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4150 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libAOD\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4151 </span>            :          }   
<span class="lineNum">    4152 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libANALYSIS\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4153 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libANALYSISalice\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4154 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libOADB\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4155 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libCORRFW\&quot;);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4156 </span>            :       } else {
<span class="lineNum">    4157 </span><span class="lineNoCov">          0 :          TIter next(fPackages);</span>
<span class="lineNum">    4158 </span>            :          TObject *obj;
<span class="lineNum">    4159 </span><span class="lineNoCov">          0 :          TString pkgname;</span>
<span class="lineNum">    4160 </span><span class="lineNoCov">          0 :          while ((obj=next())) {</span>
<span class="lineNum">    4161 </span><span class="lineNoCov">          0 :             pkgname = obj-&gt;GetName();</span>
<span class="lineNum">    4162 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;STEERBase&quot; ||</span>
<span class="lineNum">    4163 </span><span class="lineNoCov">          0 :                 pkgname == &quot;STEERBase.par&quot;) hasSTEERBase = kTRUE;</span>
<span class="lineNum">    4164 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;ESD&quot; ||</span>
<span class="lineNum">    4165 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ESD.par&quot;)       hasESD = kTRUE;</span>
<span class="lineNum">    4166 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;AOD&quot; ||</span>
<span class="lineNum">    4167 </span><span class="lineNoCov">          0 :                 pkgname == &quot;AOD.par&quot;)       hasAOD = kTRUE;</span>
<span class="lineNum">    4168 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;ANALYSIS&quot; ||</span>
<span class="lineNum">    4169 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSIS.par&quot;)  hasANALYSIS = kTRUE;</span>
<span class="lineNum">    4170 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;OADB&quot; ||</span>
<span class="lineNum">    4171 </span><span class="lineNoCov">          0 :                 pkgname == &quot;OADB.par&quot;)      hasOADB = kTRUE;</span>
<span class="lineNum">    4172 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;ANALYSISalice&quot; ||</span>
<span class="lineNum">    4173 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSISalice.par&quot;) hasANALYSISalice = kTRUE;</span>
<span class="lineNum">    4174 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;CORRFW&quot; ||</span>
<span class="lineNum">    4175 </span><span class="lineNoCov">          0 :                 pkgname == &quot;CORRFW.par&quot;)    hasCORRFW = kTRUE;</span>
<span class="lineNum">    4176 </span>            :          }
<span class="lineNum">    4177 </span><span class="lineNoCov">          0 :          if (hasANALYSISalice) setupPar = &quot;SetupPar&quot;;   </span>
<span class="lineNum">    4178 </span><span class="lineNoCov">          0 :          if (!hasSTEERBase) out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libSTEERBase\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4179 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;STEERBase\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4180 </span><span class="lineNoCov">          0 :          if (!hasESD)       out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libESD\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4181 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;ESD\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4182 </span><span class="lineNoCov">          0 :          if (!hasAOD)       out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libAOD\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4183 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;AOD\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4184 </span><span class="lineNoCov">          0 :          if (!hasANALYSIS)  out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libANALYSIS\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4185 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;ANALYSIS\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4186 </span><span class="lineNoCov">          0 :          if (!hasANALYSISalice)   out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libANALYSISalice\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4187 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;ANALYSISalice\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4188 </span><span class="lineNoCov">          0 :          if (!hasOADB)  out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libOADB\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4189 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;OADB\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4190 </span><span class="lineNoCov">          0 :          if (!hasCORRFW)    out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libCORRFW\&quot;);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4191 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;CORRFW\&quot;)) return;&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4192 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// Compile other par packages&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4193 </span><span class="lineNoCov">          0 :          next.Reset();</span>
<span class="lineNum">    4194 </span><span class="lineNoCov">          0 :          while ((obj=next())) {</span>
<span class="lineNum">    4195 </span><span class="lineNoCov">          0 :             pkgname = obj-&gt;GetName();</span>
<span class="lineNum">    4196 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;STEERBase&quot; ||</span>
<span class="lineNum">    4197 </span><span class="lineNoCov">          0 :                 pkgname == &quot;STEERBase.par&quot; ||</span>
<span class="lineNum">    4198 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ESD&quot; ||</span>
<span class="lineNum">    4199 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ESD.par&quot; ||</span>
<span class="lineNum">    4200 </span><span class="lineNoCov">          0 :                 pkgname == &quot;AOD&quot; ||</span>
<span class="lineNum">    4201 </span><span class="lineNoCov">          0 :                 pkgname == &quot;AOD.par&quot; ||</span>
<span class="lineNum">    4202 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSIS&quot; ||</span>
<span class="lineNum">    4203 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSIS.par&quot; ||</span>
<span class="lineNum">    4204 </span><span class="lineNoCov">          0 :                 pkgname == &quot;OADB&quot; ||</span>
<span class="lineNum">    4205 </span><span class="lineNoCov">          0 :                 pkgname == &quot;OADB.par&quot; ||</span>
<span class="lineNum">    4206 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSISalice&quot; ||</span>
<span class="lineNum">    4207 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSISalice.par&quot; ||</span>
<span class="lineNum">    4208 </span><span class="lineNoCov">          0 :                 pkgname == &quot;CORRFW&quot; ||</span>
<span class="lineNum">    4209 </span><span class="lineNoCov">          0 :                 pkgname == &quot;CORRFW.par&quot;) continue;</span>
<span class="lineNum">    4210 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;&quot; &lt;&lt; obj-&gt;GetName() &lt;&lt; &quot;\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4211 </span>            :          }   
<span class="lineNum">    4212 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    4213 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// include path&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4214 </span>            :       // Get the include path from the interpreter and remove entries pointing to AliRoot
<span class="lineNum">    4215 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TString intPath = gInterpreter-&gt;GetIncludePath();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4216 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TObjArray *listpaths = intPath.Tokenize(\&quot; \&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4217 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TIter nextpath(listpaths);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4218 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TObjString *pname;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4219 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   while ((pname=(TObjString*)nextpath())) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4220 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      TString current = pname-&gt;GetName();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4221 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      if (current.Contains(\&quot;AliRoot\&quot;) || current.Contains(\&quot;ALICE_ROOT\&quot;)) continue;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4222 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      gSystem-&gt;AddIncludePath(current);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4223 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4224 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   if (listpaths) delete listpaths;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4225 </span><span class="lineNoCov">          0 :       if (fIncludePath.Length()) out &lt;&lt; &quot;   gSystem-&gt;AddIncludePath(\&quot;&quot; &lt;&lt; fIncludePath.Data() &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4226 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   gROOT-&gt;ProcessLine(\&quot;.include $ALICE_ROOT/include\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4227 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   printf(\&quot;Include path: %s\\n\&quot;, gSystem-&gt;GetIncludePath());&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4228 </span><span class="lineNoCov">          0 :       if (fMCLoop &amp;&amp; !fGeneratorLibs.IsNull()) {</span>
<span class="lineNum">    4229 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// MC generator libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4230 </span><span class="lineNoCov">          0 :          TObjArray *list = fGeneratorLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    4231 </span><span class="lineNoCov">          0 :          TIter next(list);</span>
<span class="lineNum">    4232 </span>            :          TObjString *str;
<span class="lineNum">    4233 </span><span class="lineNoCov">          0 :          while((str=(TObjString*)next())) {</span>
<span class="lineNum">    4234 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;&quot; &lt;&lt; str-&gt;GetName() &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4235 </span>            :          }
<span class="lineNum">    4236 </span><span class="lineNoCov">          0 :          delete list;</span>
<span class="lineNum">    4237 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4238 </span><span class="lineNoCov">          0 :       if (fAdditionalLibs.Length()) {</span>
<span class="lineNum">    4239 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// Add aditional AliRoot libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4240 </span><span class="lineNoCov">          0 :          TString additionalLibs = fAdditionalLibs;</span>
<span class="lineNum">    4241 </span><span class="lineNoCov">          0 :          additionalLibs.Strip();</span>
<span class="lineNum">    4242 </span><span class="lineNoCov">          0 :          if (additionalLibs.Length() &amp;&amp; fFriendLibs.Length())</span>
<span class="lineNum">    4243 </span><span class="lineNoCov">          0 :             additionalLibs += &quot; &quot;;</span>
<span class="lineNum">    4244 </span><span class="lineNoCov">          0 :          additionalLibs += fFriendLibs;</span>
<span class="lineNum">    4245 </span><span class="lineNoCov">          0 :          TObjArray *list = additionalLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    4246 </span><span class="lineNoCov">          0 :          TIter next(list);</span>
<span class="lineNum">    4247 </span>            :          TObjString *str;
<span class="lineNum">    4248 </span><span class="lineNoCov">          0 :          TString buf;</span>
<span class="lineNum">    4249 </span><span class="lineNoCov">          0 :          while((str=(TObjString*)next())) {</span>
<span class="lineNum">    4250 </span><span class="lineNoCov">          0 :             buf = str-&gt;GetString();</span>
<span class="lineNum">    4251 </span><span class="lineNoCov">          0 :             if (buf.Contains(&quot;.so&quot;) || buf.Contains(&quot;.dylib&quot;)) {</span>
<span class="lineNum">    4252 </span><span class="lineNoCov">          0 :                buf.ReplaceAll(&quot;.so&quot;, &quot;&quot;);</span>
<span class="lineNum">    4253 </span><span class="lineNoCov">          0 :                buf.ReplaceAll(&quot;.dylib&quot;, &quot;&quot;);</span>
<span class="lineNum">    4254 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;&quot; &lt;&lt; buf.Data() &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4255 </span>            :             }
<span class="lineNum">    4256 </span><span class="lineNoCov">          0 :             if (buf.Contains(&quot;.par&quot;))</span>
<span class="lineNum">    4257 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;&quot; &lt;&lt; buf.Data() &lt;&lt; &quot;\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4258 </span>            :          }
<span class="lineNum">    4259 </span><span class="lineNoCov">          0 :          delete list;</span>
<span class="lineNum">    4260 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4261 </span><span class="lineNoCov">          0 :       out &lt;&lt; endl;</span>
<span class="lineNum">    4262 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// analysis source to be compiled at runtime (if any)&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4263 </span><span class="lineNoCov">          0 :       if (fAnalysisSource.Length()) {</span>
<span class="lineNum">    4264 </span><span class="lineNoCov">          0 :          TObjArray *list = fAnalysisSource.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    4265 </span><span class="lineNoCov">          0 :          TIter next(list);</span>
<span class="lineNum">    4266 </span>            :          TObjString *str;
<span class="lineNum">    4267 </span><span class="lineNoCov">          0 :          while((str=(TObjString*)next())) {</span>
<span class="lineNum">    4268 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gROOT-&gt;ProcessLine(\&quot;.L &quot; &lt;&lt; str-&gt;GetString().Data() &lt;&lt; &quot;+g\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4269 </span>            :          }   
<span class="lineNum">    4270 </span><span class="lineNoCov">          0 :          if (list) delete list;</span>
<span class="lineNum">    4271 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4272 </span><span class="lineNoCov">          0 :       out &lt;&lt; endl;</span>
<span class="lineNum">    4273 </span>            : //      out &lt;&lt; &quot;   printf(\&quot;Currently load libraries:\\n\&quot;);&quot; &lt;&lt; endl;
<span class="lineNum">    4274 </span>            : //      out &lt;&lt; &quot;   printf(\&quot;%s\\n\&quot;, gSystem-&gt;GetLibraries());&quot; &lt;&lt; endl;
<span class="lineNum">    4275 </span><span class="lineNoCov">          0 :       if (fFastReadOption) {</span>
<span class="lineNum">    4276 </span><span class="lineNoCov">          0 :          Warning(&quot;WriteAnalysisMacro&quot;, &quot;!!! You requested FastRead option. Using xrootd flags to reduce timeouts in the grid jobs. This may skip some files that could be accessed !!! \</span>
<span class="lineNum">    4277 </span>            :                 \n+++ NOTE: To disable this option, use: plugin-&gt;SetFastReadOption(kFALSE)&quot;);
<span class="lineNum">    4278 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// fast xrootd reading enabled&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4279 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;!!! You requested FastRead option. Using xrootd flags to reduce timeouts. Note that this may skip some files that could be accessed !!!\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4280 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.ConnectTimeout\&quot;,50);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4281 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.RequestTimeout\&quot;,50);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4282 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.MaxRedirectCount\&quot;,2);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4283 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.ReconnectTimeout\&quot;,50);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4284 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.FirstConnectMaxCnt\&quot;,1);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4285 </span>            :       } 
<span class="lineNum">    4286 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// read the analysis manager from file&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4287 </span><span class="lineNoCov">          0 :       TString analysisFile = fExecutable;</span>
<span class="lineNum">    4288 </span><span class="lineNoCov">          0 :       analysisFile.ReplaceAll(&quot;.sh&quot;, &quot;.root&quot;);</span>
<span class="lineNum">    4289 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   AliAnalysisManager *mgr = AliAnalysisAlien::LoadAnalysisManager(\&quot;&quot; </span>
<span class="lineNum">    4290 </span><span class="lineNoCov">          0 :           &lt;&lt; analysisFile &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4291 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   if (!mgr) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4292 </span><span class="lineNoCov">          0 :       if (IsLocalTest()) {</span>
<span class="lineNum">    4293 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   AliAnalysisAlien *plugin = new AliAnalysisAlien();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4294 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   plugin-&gt;SetRunMode(\&quot;test\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4295 </span><span class="lineNoCov">          0 :          if (fFileForTestMode.IsNull())</span>
<span class="lineNum">    4296 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   plugin-&gt;SetFileForTestMode(\&quot;data.txt\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4297 </span>            :          else   
<span class="lineNum">    4298 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   plugin-&gt;SetFileForTestMode(\&quot;&quot; &lt;&lt; fFileForTestMode &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4299 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   plugin-&gt;SetNtestFiles(&quot; &lt;&lt; fNtestFiles &lt;&lt; &quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4300 </span><span class="lineNoCov">          0 :          if (!fFriendChainName.IsNull()) </span>
<span class="lineNum">    4301 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   plugin-&gt;SetFriendChainName(\&quot;&quot; &lt;&lt; fFriendChainName &lt;&lt; &quot;\&quot;,\&quot;&quot; &lt;&lt; fFriendLibs &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4302 </span><span class="lineNoCov">          0 :          if (IsUseMCchain())</span>
<span class="lineNum">    4303 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   plugin-&gt;SetUseMCchain();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4304 </span><span class="lineNoCov">          0 :          if (fMCLoop)</span>
<span class="lineNum">    4305 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   plugin-&gt;SetMCLoop(kTRUE);&quot; &lt;&lt; endl;  </span>
<span class="lineNum">    4306 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   mgr-&gt;SetGridHandler(plugin);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4307 </span><span class="lineNoCov">          0 :          if (AliAnalysisManager::GetAnalysisManager()) {</span>
<span class="lineNum">    4308 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;SetDebugLevel(&quot; &lt;&lt; AliAnalysisManager::GetAnalysisManager()-&gt;GetDebugLevel() &lt;&lt; &quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4309 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;SetNSysInfo(&quot; &lt;&lt; AliAnalysisManager::GetAnalysisManager()-&gt;GetNsysInfo() &lt;&lt; &quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4310 </span>            :          } else {
<span class="lineNum">    4311 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;SetDebugLevel(10);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4312 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;SetNSysInfo(100);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4313 </span>            :          }
<span class="lineNum">    4314 </span>            :       }
<span class="lineNum">    4315 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   mgr-&gt;PrintStatus();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4316 </span><span class="lineNoCov">          0 :       if (AliAnalysisManager::GetAnalysisManager()) {</span>
<span class="lineNum">    4317 </span><span class="lineNoCov">          0 :          if (AliAnalysisManager::GetAnalysisManager()-&gt;GetDebugLevel()&gt;3) {</span>
<span class="lineNum">    4318 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.Debug\&quot;, \&quot;1\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4319 </span>            :          } else {
<span class="lineNum">    4320 </span><span class="lineNoCov">          0 :             if (TestBit(AliAnalysisGrid::kTest))            </span>
<span class="lineNum">    4321 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   AliLog::SetGlobalLogLevel(AliLog::kWarning);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4322 </span>            :             else
<span class="lineNum">    4323 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   AliLog::SetGlobalLogLevel(AliLog::kError);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4324 </span>            :          }
<span class="lineNum">    4325 </span>            :       }   
<span class="lineNum">    4326 </span><span class="lineNoCov">          0 :       if (!IsLocalTest()) {</span>
<span class="lineNum">    4327 </span><span class="lineNoCov">          0 :          if (fMCLoop) {</span>
<span class="lineNum">    4328 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;SetCacheSize(0);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4329 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;EventLoop(&quot; &lt;&lt; fNMCevents &lt;&lt; &quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4330 </span>            :          } else {   
<span class="lineNum">    4331 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   TChain *chain = CreateChain(\&quot;wn.xml\&quot;, anatype);&quot; &lt;&lt; endl &lt;&lt; endl;   </span>
<span class="lineNum">    4332 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;StartAnalysis(\&quot;localfile\&quot;, chain, &quot; </span>
<span class="lineNum">    4333 </span><span class="lineNoCov">          0 :                 &lt;&lt; nentries &lt;&lt; &quot;, &quot; &lt;&lt; firstentry &lt;&lt; &quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4334 </span>            :          }   
<span class="lineNum">    4335 </span>            :       } else {
<span class="lineNum">    4336 </span><span class="lineNoCov">          0 :          if (fMCLoop) {</span>
<span class="lineNum">    4337 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;SetCacheSize(0);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4338 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;EventLoop(&quot; &lt;&lt; fNMCevents &lt;&lt; &quot;);&quot; &lt;&lt; endl;         </span>
<span class="lineNum">    4339 </span>            :          } else {
<span class="lineNum">    4340 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   mgr-&gt;StartAnalysis(\&quot;localfile\&quot;, &quot; </span>
<span class="lineNum">    4341 </span><span class="lineNoCov">          0 :                 &lt;&lt; nentries &lt;&lt; &quot;, &quot; &lt;&lt; firstentry &lt;&lt; &quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4342 </span>            :          }   
<span class="lineNum">    4343 </span>            :       }   
<span class="lineNum">    4344 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   timer.Stop();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4345 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   timer.Print();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4346 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;}&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4347 </span><span class="lineNoCov">          0 :       if (!IsLocalTest() &amp;&amp; !fMCLoop) {</span>
<span class="lineNum">    4348 </span><span class="lineNoCov">          0 :          out &lt;&lt;&quot;//________________________________________________________________________________&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4349 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;TChain* CreateChain(const char *xmlfile, const char *type)&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4350 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;{&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4351 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// Create a chain using url's from xml file&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4352 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TString filename;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4353 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   Int_t run = 0;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4354 </span><span class="lineNoCov">          0 :          if (IsUseMCchain()) {</span>
<span class="lineNum">    4355 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   TString treename = \&quot;TE\&quot;;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4356 </span>            :          } else {   
<span class="lineNum">    4357 </span><span class="lineNoCov">          0 :             if (!fTreeName.IsNull()) {</span>
<span class="lineNum">    4358 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   TString treename = \&quot;&quot; &lt;&lt; fTreeName &lt;&lt; &quot;\&quot;;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4359 </span>            :             } else {   
<span class="lineNum">    4360 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   TString treename = type;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4361 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   treename.ToLower();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4362 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   treename += \&quot;Tree\&quot;;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4363 </span>            :             }   
<span class="lineNum">    4364 </span>            :          }   
<span class="lineNum">    4365 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;***************************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4366 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;    Getting chain of trees %s\\n\&quot;, treename.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4367 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;***************************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4368 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TAlienCollection *coll = dynamic_cast&lt;TAlienCollection *&gt;(TAlienCollection::Open(xmlfile));&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4369 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   if (!coll) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4370 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      ::Error(\&quot;CreateChain\&quot;, \&quot;Cannot create an AliEn collection from %s\&quot;, xmlfile);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4371 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      return NULL;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4372 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4373 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4374 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TChain *chain = new TChain(treename);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4375 </span><span class="lineNoCov">          0 :          if(!fFriendChainName.IsNull()) {</span>
<span class="lineNum">    4376 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   TList *friends = new TList();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4377 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   TIter nextfriend(friends);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4378 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   TChain *cfriend = 0;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4379 </span><span class="lineNoCov">          0 :             TObjArray *list = fFriendChainName.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    4380 </span><span class="lineNoCov">          0 :             TIter next(list);</span>
<span class="lineNum">    4381 </span>            :             TObjString *str;
<span class="lineNum">    4382 </span><span class="lineNoCov">          0 :             while((str=(TObjString*)next())) {</span>
<span class="lineNum">    4383 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   cfriend = new TChain(treename, \&quot;&quot; &lt;&lt; str-&gt;GetName() &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4384 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   friends-&gt;Add(cfriend);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4385 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   chain-&gt;AddFriend(cfriend);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4386 </span>            :             }
<span class="lineNum">    4387 </span><span class="lineNoCov">          0 :             delete list;   </span>
<span class="lineNum">    4388 </span>            : //            out &lt;&lt; &quot;   TChain *chainFriend = new TChain(treename);&quot; &lt;&lt; endl;
<span class="lineNum">    4389 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    4390 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   coll-&gt;Reset();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4391 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   while (coll-&gt;Next()) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4392 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      filename = coll-&gt;GetTURL(&quot;&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4393 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      if (mgr) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4394 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;         Int_t nrun = AliAnalysisManager::GetRunFromAlienPath(filename);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4395 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;         if (nrun &amp;&amp; nrun != run) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4396 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;            printf(\&quot;### Run number detected from chain: %d\\n\&quot;, nrun);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4397 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;            mgr-&gt;SetRunFromPath(nrun);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4398 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;            run = nrun;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4399 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;         }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4400 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4401 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      chain-&gt;Add(filename);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4402 </span><span class="lineNoCov">          0 :          if(!fFriendChainName.IsNull()) {</span>
<span class="lineNum">    4403 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;      TString bpath=coll-&gt;GetTURL(\&quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4404 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;      if (bpath.Index(\&quot;#\&quot;) &gt; -1) bpath.Remove(bpath.Index(\&quot;#\&quot;));&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4405 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;      bpath = gSystem-&gt;DirName(bpath);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4406 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;      bpath += \&quot;/\&quot;;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4407 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;      TString fileFriend;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4408 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;      nextfriend.Reset();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4409 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;      while ((cfriend=(TChain*)nextfriend())) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4410 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;         fileFriend = bpath;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4411 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;         fileFriend += cfriend-&gt;GetTitle();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4412 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;         TFile *file = TFile::Open(fileFriend);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4413 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;         if (file) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4414 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;            file-&gt;Close();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4415 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;            cfriend-&gt;Add(fileFriend.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4416 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;         } else {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4417 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;            ::Fatal(\&quot;CreateChain\&quot;, \&quot;Cannot open friend file: %s\&quot;, fileFriend.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4418 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;            return 0;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4419 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;         }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4420 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;      }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4421 </span>            :          }
<span class="lineNum">    4422 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4423 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   if (!chain-&gt;GetNtrees()) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4424 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      ::Error(\&quot;CreateChain\&quot;, \&quot;No tree found from collection %s\&quot;, xmlfile);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4425 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      return NULL;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4426 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4427 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   return chain;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4428 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;}&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4429 </span>            :       }   
<span class="lineNum">    4430 </span><span class="lineNoCov">          0 :       if (hasANALYSISalice) {</span>
<span class="lineNum">    4431 </span><span class="lineNoCov">          0 :          out &lt;&lt;&quot;//________________________________________________________________________________&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4432 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;Bool_t SetupPar(const char *package) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4433 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// Compile the package and set it up.&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4434 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TString pkgdir = package;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4435 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   pkgdir.ReplaceAll(\&quot;.par\&quot;,\&quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4436 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Exec(TString::Format(\&quot;tar xvzf %s.par\&quot;, pkgdir.Data()));&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4437 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TString cdir = gSystem-&gt;WorkingDirectory();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4438 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;ChangeDirectory(pkgdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4439 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   // Check for BUILD.sh and execute&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4440 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   if (!gSystem-&gt;AccessPathName(\&quot;PROOF-INF/BUILD.sh\&quot;)) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4441 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*******************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4442 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*** Building PAR archive    ***\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4443 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*******************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4444 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      if (gSystem-&gt;Exec(\&quot;PROOF-INF/BUILD.sh\&quot;)) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4445 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;         ::Error(\&quot;SetupPar\&quot;, \&quot;Cannot build par archive %s\&quot;, pkgdir.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4446 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;         gSystem-&gt;ChangeDirectory(cdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4447 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;         return kFALSE;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4448 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4449 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   } else {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4450 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      ::Error(\&quot;SetupPar\&quot;,\&quot;Cannot access PROOF-INF/BUILD.sh for package %s\&quot;, pkgdir.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4451 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      gSystem-&gt;ChangeDirectory(cdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4452 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      return kFALSE;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4453 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4454 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   // Check for SETUP.C and execute&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4455 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   if (!gSystem-&gt;AccessPathName(\&quot;PROOF-INF/SETUP.C\&quot;)) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4456 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*******************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4457 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;***    Setup PAR archive    ***\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4458 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*******************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4459 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      gROOT-&gt;Macro(\&quot;PROOF-INF/SETUP.C\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4460 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   } else {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4461 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      ::Error(\&quot;SetupPar\&quot;,\&quot;Cannot access PROOF-INF/SETUP.C for package %s\&quot;, pkgdir.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4462 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      gSystem-&gt;ChangeDirectory(cdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4463 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      return kFALSE;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4464 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4465 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   // Restore original workdir&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4466 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;ChangeDirectory(cdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4467 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   return kTRUE;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4468 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;}&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4469 </span>            :       }
<span class="lineNum">    4470 </span><span class="lineNoCov">          0 :       Info(&quot;WriteAnalysisMacro&quot;, &quot;\n#####   Analysis macro to run on worker nodes &lt;%s&gt; written&quot;,fAnalysisMacro.Data());</span>
<span class="lineNum">    4471 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    4472 </span>            :    Bool_t copy = kTRUE;
<span class="lineNum">    4473 </span><span class="lineNoCov">          0 :    if (fProductionMode || TestBit(AliAnalysisGrid::kOffline) || TestBit(AliAnalysisGrid::kTest)) copy = kFALSE;</span>
<span class="lineNum">    4474 </span><span class="lineNoCov">          0 :    if (copy) {</span>
<span class="lineNum">    4475 </span><span class="lineNoCov">          0 :       CdWork();</span>
<span class="lineNum">    4476 </span><span class="lineNoCov">          0 :       TString workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    4477 </span><span class="lineNoCov">          0 :       workdir += fGridWorkingDir;</span>
<span class="lineNum">    4478 </span><span class="lineNoCov">          0 :       if (FileExists(fAnalysisMacro)) gGrid-&gt;Rm(fAnalysisMacro);</span>
<span class="lineNum">    4479 </span><span class="lineNoCov">          0 :       Info(&quot;WriteAnalysisMacro&quot;, &quot;\n#####   Copying analysis macro: &lt;%s&gt; to your alien workspace&quot;, fAnalysisMacro.Data());</span>
<span class="lineNum">    4480 </span>            : //      TFile::Cp(Form(&quot;file:%s&quot;,fAnalysisMacro.Data()), Form(&quot;alien://%s/%s&quot;, workdir.Data(), fAnalysisMacro.Data()));
<span class="lineNum">    4481 </span><span class="lineNoCov">          0 :       if (!copyLocal2Alien(&quot;WriteAnalysisMacro&quot;,fAnalysisMacro.Data(), </span>
<span class="lineNum">    4482 </span><span class="lineNoCov">          0 :            Form(&quot;alien://%s/%s&quot;, workdir.Data(), </span>
<span class="lineNum">    4483 </span><span class="lineNoCov">          0 :            fAnalysisMacro.Data()))) Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    4484 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    4485 </span><span class="lineNoCov">          0 : }</span>
<a name="4486"><span class="lineNum">    4486 </span>            : </a>
<span class="lineNum">    4487 </span>            : //______________________________________________________________________________
<span class="lineNum">    4488 </span>            : void AliAnalysisAlien::WriteMergingMacro()
<span class="lineNum">    4489 </span>            : {
<span class="lineNum">    4490 </span>            : // Write a macro to merge the outputs per master job.
<span class="lineNum">    4491 </span><span class="lineNoCov">          0 :    if (!fMergeViaJDL) return;</span>
<span class="lineNum">    4492 </span><span class="lineNoCov">          0 :    if (!fOutputFiles.Length()) {</span>
<span class="lineNum">    4493 </span><span class="lineNoCov">          0 :       Error(&quot;WriteMergingMacro&quot;, &quot;No output file names defined. Are you running the right AliAnalysisAlien configuration ?&quot;);</span>
<span class="lineNum">    4494 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    4495 </span>            :    }   
<span class="lineNum">    4496 </span><span class="lineNoCov">          0 :    AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();</span>
<span class="lineNum">    4497 </span><span class="lineNoCov">          0 :    TString mergingMacro = fExecutable;</span>
<span class="lineNum">    4498 </span><span class="lineNoCov">          0 :    mergingMacro.ReplaceAll(&quot;.sh&quot;,&quot;_merge.C&quot;);</span>
<span class="lineNum">    4499 </span><span class="lineNoCov">          0 :    if (gGrid &amp;&amp; !fGridOutputDir.Contains(&quot;/&quot;)) fGridOutputDir = Form(&quot;%s/%s/%s&quot;, gGrid-&gt;GetHomeDirectory(), fGridWorkingDir.Data(), fGridOutputDir.Data());</span>
<span class="lineNum">    4500 </span><span class="lineNoCov">          0 :    if (!TestBit(AliAnalysisGrid::kSubmit)) {  </span>
<span class="lineNum">    4501 </span><span class="lineNoCov">          0 :       ofstream out;</span>
<span class="lineNum">    4502 </span><span class="lineNoCov">          0 :       out.open(mergingMacro.Data(), ios::out);</span>
<span class="lineNum">    4503 </span><span class="lineNoCov">          0 :       if (!out.good()) {</span>
<span class="lineNum">    4504 </span><span class="lineNoCov">          0 :          Error(&quot;WriteMergingMacro&quot;, &quot;could not open file %s for writing&quot;, fAnalysisMacro.Data());</span>
<span class="lineNum">    4505 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    4506 </span>            :       }
<span class="lineNum">    4507 </span>            :       Bool_t hasSTEERBase = kFALSE;
<span class="lineNum">    4508 </span>            :       Bool_t hasESD = kFALSE;
<span class="lineNum">    4509 </span>            :       Bool_t hasAOD = kFALSE;
<span class="lineNum">    4510 </span>            :       Bool_t hasANALYSIS = kFALSE;
<span class="lineNum">    4511 </span>            :       Bool_t hasOADB = kFALSE;
<span class="lineNum">    4512 </span>            :       Bool_t hasANALYSISalice = kFALSE;
<span class="lineNum">    4513 </span>            :       Bool_t hasCORRFW = kFALSE;
<span class="lineNum">    4514 </span><span class="lineNoCov">          0 :       TString func = mergingMacro;</span>
<span class="lineNum">    4515 </span><span class="lineNoCov">          0 :       TString comment;</span>
<span class="lineNum">    4516 </span><span class="lineNoCov">          0 :       func.ReplaceAll(&quot;.C&quot;, &quot;&quot;);</span>
<span class="lineNum">    4517 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;void &quot; &lt;&lt; func.Data() &lt;&lt; &quot;(const char *dir, Int_t stage=0)&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4518 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;{&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4519 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Automatically generated merging macro executed in grid subjobs&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4520 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TStopwatch timer;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4521 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   timer.Start();&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4522 </span>            :       // Reset existing include path
<span class="lineNum">    4523 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Reset existing include path and add current directory first in the search&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4524 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   gSystem-&gt;SetIncludePath(\&quot;-I.\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4525 </span><span class="lineNoCov">          0 :       if (!fExecutableCommand.Contains(&quot;aliroot&quot;)) {</span>
<span class="lineNum">    4526 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// load base root libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4527 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libTree\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4528 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libGeom\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4529 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libVMC\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4530 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libPhysics\&quot;);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4531 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libMinuit\&quot;);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4532 </span>            :       }   
<span class="lineNum">    4533 </span><span class="lineNoCov">          0 :       if (fAdditionalRootLibs.Length()) {</span>
<span class="lineNum">    4534 </span>            :          // in principle libtree /lib geom libvmc etc. can go into this list, too
<span class="lineNum">    4535 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// Add aditional libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4536 </span><span class="lineNoCov">          0 :          TObjArray *list = fAdditionalRootLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    4537 </span><span class="lineNoCov">          0 :          TIter next(list);</span>
<span class="lineNum">    4538 </span>            :          TObjString *str;
<span class="lineNum">    4539 </span><span class="lineNoCov">          0 :          TString buf;</span>
<span class="lineNum">    4540 </span><span class="lineNoCov">          0 :          while((str=(TObjString*)next())) {</span>
<span class="lineNum">    4541 </span><span class="lineNoCov">          0 :             buf = str-&gt;GetString();</span>
<span class="lineNum">    4542 </span><span class="lineNoCov">          0 :             if (buf.Contains(&quot;.so&quot;) || buf.Contains(&quot;.dylib&quot;)) {</span>
<span class="lineNum">    4543 </span><span class="lineNoCov">          0 :                buf.ReplaceAll(&quot;.so&quot;, &quot;&quot;);</span>
<span class="lineNum">    4544 </span><span class="lineNoCov">          0 :                buf.ReplaceAll(&quot;.dylib&quot;, &quot;&quot;);</span>
<span class="lineNum">    4545 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;&quot; &lt;&lt; buf.Data() &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4546 </span>            :             }
<span class="lineNum">    4547 </span>            :          }
<span class="lineNum">    4548 </span><span class="lineNoCov">          0 :          if (list) delete list;</span>
<span class="lineNum">    4549 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4550 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Load analysis framework libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4551 </span><span class="lineNoCov">          0 :       if (!fPackages) {</span>
<span class="lineNum">    4552 </span><span class="lineNoCov">          0 :          if (!fExecutableCommand.Contains(&quot;aliroot&quot;)) {</span>
<span class="lineNum">    4553 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libSTEERBase\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4554 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libESD\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4555 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libAOD\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4556 </span>            :          }
<span class="lineNum">    4557 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libANALYSIS\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4558 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libANALYSISalice\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4559 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libOADB\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4560 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libCORRFW\&quot;);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4561 </span>            :       } else {
<span class="lineNum">    4562 </span><span class="lineNoCov">          0 :          TIter next(fPackages);</span>
<span class="lineNum">    4563 </span>            :          TObject *obj;
<span class="lineNum">    4564 </span><span class="lineNoCov">          0 :          TString pkgname;</span>
<span class="lineNum">    4565 </span><span class="lineNoCov">          0 :          TString setupPar = &quot;AliAnalysisAlien::SetupPar&quot;;</span>
<span class="lineNum">    4566 </span><span class="lineNoCov">          0 :          while ((obj=next())) {</span>
<span class="lineNum">    4567 </span><span class="lineNoCov">          0 :             pkgname = obj-&gt;GetName();</span>
<span class="lineNum">    4568 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;STEERBase&quot; ||</span>
<span class="lineNum">    4569 </span><span class="lineNoCov">          0 :                 pkgname == &quot;STEERBase.par&quot;) hasSTEERBase = kTRUE;</span>
<span class="lineNum">    4570 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;ESD&quot; ||</span>
<span class="lineNum">    4571 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ESD.par&quot;)       hasESD = kTRUE;</span>
<span class="lineNum">    4572 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;AOD&quot; ||</span>
<span class="lineNum">    4573 </span><span class="lineNoCov">          0 :                 pkgname == &quot;AOD.par&quot;)       hasAOD = kTRUE;</span>
<span class="lineNum">    4574 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;ANALYSIS&quot; ||</span>
<span class="lineNum">    4575 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSIS.par&quot;)  hasANALYSIS = kTRUE;</span>
<span class="lineNum">    4576 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;OADB&quot; ||</span>
<span class="lineNum">    4577 </span><span class="lineNoCov">          0 :                 pkgname == &quot;OADB.par&quot;)      hasOADB = kTRUE;</span>
<span class="lineNum">    4578 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;ANALYSISalice&quot; ||</span>
<span class="lineNum">    4579 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSISalice.par&quot;) hasANALYSISalice = kTRUE;</span>
<span class="lineNum">    4580 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;CORRFW&quot; ||</span>
<span class="lineNum">    4581 </span><span class="lineNoCov">          0 :                 pkgname == &quot;CORRFW.par&quot;)    hasCORRFW = kTRUE;</span>
<span class="lineNum">    4582 </span>            :          }   
<span class="lineNum">    4583 </span><span class="lineNoCov">          0 :          if (hasANALYSISalice) setupPar = &quot;SetupPar&quot;;   </span>
<span class="lineNum">    4584 </span><span class="lineNoCov">          0 :          if (!hasSTEERBase) out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libSTEERBase\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4585 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;STEERBase\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4586 </span><span class="lineNoCov">          0 :          if (!hasESD)       out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libESD\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4587 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;ESD\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4588 </span><span class="lineNoCov">          0 :          if (!hasAOD)       out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libAOD\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4589 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;AOD\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4590 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libOADB\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4591 </span><span class="lineNoCov">          0 :          if (!hasANALYSIS)  out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libANALYSIS\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4592 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;ANALYSIS\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4593 </span><span class="lineNoCov">          0 :          if (!hasANALYSISalice)   out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libANALYSISalice\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4594 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;ANALYSISalice\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4595 </span><span class="lineNoCov">          0 :          if (!hasOADB)  out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libOADB\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4596 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;OADB\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4597 </span><span class="lineNoCov">          0 :          if (!hasCORRFW)    out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;libCORRFW\&quot;);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4598 </span><span class="lineNoCov">          0 :          else out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;CORRFW\&quot;)) return;&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4599 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// Compile other par packages&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4600 </span><span class="lineNoCov">          0 :          next.Reset();</span>
<span class="lineNum">    4601 </span><span class="lineNoCov">          0 :          while ((obj=next())) {</span>
<span class="lineNum">    4602 </span><span class="lineNoCov">          0 :             pkgname = obj-&gt;GetName();</span>
<span class="lineNum">    4603 </span><span class="lineNoCov">          0 :             if (pkgname == &quot;STEERBase&quot; ||</span>
<span class="lineNum">    4604 </span><span class="lineNoCov">          0 :                 pkgname == &quot;STEERBase.par&quot; ||</span>
<span class="lineNum">    4605 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ESD&quot; ||</span>
<span class="lineNum">    4606 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ESD.par&quot; ||</span>
<span class="lineNum">    4607 </span><span class="lineNoCov">          0 :                 pkgname == &quot;AOD&quot; ||</span>
<span class="lineNum">    4608 </span><span class="lineNoCov">          0 :                 pkgname == &quot;AOD.par&quot; ||</span>
<span class="lineNum">    4609 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSIS&quot; ||</span>
<span class="lineNum">    4610 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSIS.par&quot; ||</span>
<span class="lineNum">    4611 </span><span class="lineNoCov">          0 :                 pkgname == &quot;OADB&quot; ||</span>
<span class="lineNum">    4612 </span><span class="lineNoCov">          0 :                 pkgname == &quot;OADB.par&quot; ||</span>
<span class="lineNum">    4613 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSISalice&quot; ||</span>
<span class="lineNum">    4614 </span><span class="lineNoCov">          0 :                 pkgname == &quot;ANALYSISalice.par&quot; ||</span>
<span class="lineNum">    4615 </span><span class="lineNoCov">          0 :                 pkgname == &quot;CORRFW&quot; ||</span>
<span class="lineNum">    4616 </span><span class="lineNoCov">          0 :                 pkgname == &quot;CORRFW.par&quot;) continue;</span>
<span class="lineNum">    4617 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   if (!&quot; &lt;&lt; setupPar &lt;&lt; &quot;(\&quot;&quot; &lt;&lt; obj-&gt;GetName() &lt;&lt; &quot;\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4618 </span>            :          }   
<span class="lineNum">    4619 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    4620 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// include path&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4621 </span>            :       // Get the include path from the interpreter and remove entries pointing to AliRoot
<span class="lineNum">    4622 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TString intPath = gInterpreter-&gt;GetIncludePath();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4623 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TObjArray *listpaths = intPath.Tokenize(\&quot; \&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4624 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TIter nextpath(listpaths);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4625 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TObjString *pname;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4626 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   while ((pname=(TObjString*)nextpath())) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4627 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      TString current = pname-&gt;GetName();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4628 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      if (current.Contains(\&quot;AliRoot\&quot;) || current.Contains(\&quot;ALICE_ROOT\&quot;)) continue;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4629 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      gSystem-&gt;AddIncludePath(current);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4630 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4631 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   if (listpaths) delete listpaths;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4632 </span><span class="lineNoCov">          0 :       if (fIncludePath.Length()) out &lt;&lt; &quot;   gSystem-&gt;AddIncludePath(\&quot;&quot; &lt;&lt; fIncludePath.Data() &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4633 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   gROOT-&gt;ProcessLine(\&quot;.include $ALICE_ROOT/include\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4634 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   printf(\&quot;Include path: %s\\n\&quot;, gSystem-&gt;GetIncludePath());&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4635 </span><span class="lineNoCov">          0 :       if (fMCLoop &amp;&amp; !fGeneratorLibs.IsNull()) {</span>
<span class="lineNum">    4636 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// MC generator libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4637 </span><span class="lineNoCov">          0 :          TObjArray *list = fGeneratorLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    4638 </span><span class="lineNoCov">          0 :          TIter next(list);</span>
<span class="lineNum">    4639 </span>            :          TObjString *str;
<span class="lineNum">    4640 </span><span class="lineNoCov">          0 :          while((str=(TObjString*)next())) {</span>
<span class="lineNum">    4641 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;&quot; &lt;&lt; str-&gt;GetName() &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4642 </span>            :          }
<span class="lineNum">    4643 </span><span class="lineNoCov">          0 :          delete list;</span>
<span class="lineNum">    4644 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4645 </span><span class="lineNoCov">          0 :       if (fAdditionalLibs.Length()) {</span>
<span class="lineNum">    4646 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// Add aditional AliRoot libraries&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4647 </span><span class="lineNoCov">          0 :          TString additionalLibs = fAdditionalLibs;</span>
<span class="lineNum">    4648 </span><span class="lineNoCov">          0 :          additionalLibs.Strip();</span>
<span class="lineNum">    4649 </span><span class="lineNoCov">          0 :          if (additionalLibs.Length() &amp;&amp; fFriendLibs.Length())</span>
<span class="lineNum">    4650 </span><span class="lineNoCov">          0 :             additionalLibs += &quot; &quot;;</span>
<span class="lineNum">    4651 </span><span class="lineNoCov">          0 :          additionalLibs += fFriendLibs;</span>
<span class="lineNum">    4652 </span><span class="lineNoCov">          0 :          TObjArray *list = additionalLibs.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    4653 </span><span class="lineNoCov">          0 :          TIter next(list);</span>
<span class="lineNum">    4654 </span>            :          TObjString *str;
<span class="lineNum">    4655 </span><span class="lineNoCov">          0 :          TString buf;</span>
<span class="lineNum">    4656 </span><span class="lineNoCov">          0 :          while((str=(TObjString*)next())) {</span>
<span class="lineNum">    4657 </span><span class="lineNoCov">          0 :             buf = str-&gt;GetString();</span>
<span class="lineNum">    4658 </span><span class="lineNoCov">          0 :             if (buf.Contains(&quot;.so&quot;) || buf.Contains(&quot;.dylib&quot;)) {</span>
<span class="lineNum">    4659 </span><span class="lineNoCov">          0 :                buf.ReplaceAll(&quot;.so&quot;, &quot;&quot;);</span>
<span class="lineNum">    4660 </span><span class="lineNoCov">          0 :                buf.ReplaceAll(&quot;.dylib&quot;, &quot;&quot;);</span>
<span class="lineNum">    4661 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   gSystem-&gt;Load(\&quot;&quot; &lt;&lt; buf.Data() &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4662 </span>            :             }
<span class="lineNum">    4663 </span>            :          }
<span class="lineNum">    4664 </span><span class="lineNoCov">          0 :          if (list) delete list;</span>
<span class="lineNum">    4665 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4666 </span><span class="lineNoCov">          0 :       out &lt;&lt; endl;</span>
<span class="lineNum">    4667 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Analysis source to be compiled at runtime (if any)&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4668 </span><span class="lineNoCov">          0 :       if (fAnalysisSource.Length()) {</span>
<span class="lineNum">    4669 </span><span class="lineNoCov">          0 :          TObjArray *list = fAnalysisSource.Tokenize(&quot; &quot;);</span>
<span class="lineNum">    4670 </span><span class="lineNoCov">          0 :          TIter next(list);</span>
<span class="lineNum">    4671 </span>            :          TObjString *str;
<span class="lineNum">    4672 </span><span class="lineNoCov">          0 :          while((str=(TObjString*)next())) {</span>
<span class="lineNum">    4673 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gROOT-&gt;ProcessLine(\&quot;.L &quot; &lt;&lt; str-&gt;GetString().Data() &lt;&lt; &quot;+g\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4674 </span>            :          }   
<span class="lineNum">    4675 </span><span class="lineNoCov">          0 :          if (list) delete list;</span>
<span class="lineNum">    4676 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4677 </span><span class="lineNoCov">          0 :       out &lt;&lt; endl;      </span>
<span class="lineNum">    4678 </span>            : 
<span class="lineNum">    4679 </span><span class="lineNoCov">          0 :       if (fFastReadOption) {</span>
<span class="lineNum">    4680 </span><span class="lineNoCov">          0 :          Warning(&quot;WriteMergingMacro&quot;, &quot;!!! You requested FastRead option. Using xrootd flags to reduce timeouts in the grid merging jobs. Note that this may skip some files that could be accessed !!!&quot;);</span>
<span class="lineNum">    4681 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// fast xrootd reading enabled&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4682 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;!!! You requested FastRead option. Using xrootd flags to reduce timeouts. Note that this may skip some files that could be accessed !!!\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4683 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.ConnectTimeout\&quot;,50);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4684 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.RequestTimeout\&quot;,50);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4685 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.MaxRedirectCount\&quot;,2);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4686 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.ReconnectTimeout\&quot;,50);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4687 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.FirstConnectMaxCnt\&quot;,1);&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4688 </span>            :       }
<span class="lineNum">    4689 </span>            :       // Change temp directory to current one
<span class="lineNum">    4690 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Connect to AliEn&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4691 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   if (!TGrid::Connect(\&quot;alien://\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4692 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Set temporary merging directory to current one&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4693 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   gSystem-&gt;Setenv(\&quot;TMPDIR\&quot;, gSystem-&gt;pwd());&quot; &lt;&lt; endl &lt;&lt; endl;   </span>
<span class="lineNum">    4694 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;// Set temporary compilation directory to current one&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4695 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   gSystem-&gt;SetBuildDir(gSystem-&gt;pwd(), kTRUE);&quot; &lt;&lt; endl &lt;&lt; endl;   </span>
<span class="lineNum">    4696 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TString outputDir = dir;&quot; &lt;&lt; endl;  </span>
<span class="lineNum">    4697 </span><span class="lineNoCov">          0 :       if (IsMergeAOD())</span>
<span class="lineNum">    4698 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TString outputFiles = \&quot;&quot; &lt;&lt; GetListOfFiles(&quot;outaod&quot;) &lt;&lt; &quot;\&quot;;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4699 </span>            :       else   
<span class="lineNum">    4700 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TString outputFiles = \&quot;&quot; &lt;&lt; GetListOfFiles(&quot;out&quot;) &lt;&lt; &quot;\&quot;;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4701 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TString mergeExcludes = \&quot;&quot; &lt;&lt; fMergeExcludes &lt;&lt; &quot; &quot; &lt;&lt; fRegisterExcludes &lt;&lt; &quot;\&quot;;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4702 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TObjArray *list = outputFiles.Tokenize(\&quot;,\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4703 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TIter *iter = new TIter(list);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4704 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TObjString *str;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4705 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TString outputFile;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4706 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   Bool_t merged = kTRUE;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4707 </span><span class="lineNoCov">          0 :       TString analysisFile = fExecutable;</span>
<span class="lineNum">    4708 </span><span class="lineNoCov">          0 :       analysisFile.ReplaceAll(&quot;.sh&quot;, &quot;.root&quot;);</span>
<span class="lineNum">    4709 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   AliAnalysisManager *mgr = AliAnalysisAlien::LoadAnalysisManager(\&quot;&quot;</span>
<span class="lineNum">    4710 </span><span class="lineNoCov">          0 :           &lt;&lt; analysisFile &lt;&lt; &quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4711 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   if (!mgr) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4712 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      printf(\&quot;ERROR: Analysis manager could not be extracted from file \&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4713 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4714 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4715 </span><span class="lineNoCov">          0 :       if (IsLocalTest()) {</span>
<span class="lineNum">    4716 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;===================================\\n\&quot;);&quot; &lt;&lt; endl;      </span>
<span class="lineNum">    4717 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;Testing merging...\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4718 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;===================================\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4719 </span>            :       }        
<span class="lineNum">    4720 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   while((str=(TObjString*)iter-&gt;Next())) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4721 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      outputFile = str-&gt;GetString();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4722 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      if (outputFile.Contains(\&quot;*\&quot;)) continue;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4723 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      Int_t index = outputFile.Index(\&quot;@\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4724 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      if (index &gt; 0) outputFile.Remove(index);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4725 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      // Skip already merged outputs&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4726 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      if (!gSystem-&gt;AccessPathName(outputFile)) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4727 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;         printf(\&quot;Output file &lt;%s&gt; found. Not merging again.\\n\&quot;,outputFile.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4728 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;         continue;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4729 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4730 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      if (mergeExcludes.Contains(outputFile.Data())) continue;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4731 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      merged = AliAnalysisAlien::MergeOutput(outputFile, outputDir, &quot; &lt;&lt; fMaxMergeFiles &lt;&lt; &quot;, stage);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4732 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      if (!merged) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4733 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;         printf(\&quot;ERROR: Cannot merge %s\\n\&quot;, outputFile.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4734 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;         return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4735 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;      }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4736 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4737 </span><span class="lineNoCov">          0 :       if (mgr &amp;&amp; mgr-&gt;IsCollectThroughput() &amp;&amp; !IsLocalTest()) {</span>
<span class="lineNum">    4738 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TString infolog = \&quot;&quot; &lt;&lt; mgr-&gt;GetFileInfoLog() &lt;&lt; &quot;\&quot;;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4739 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   AliAnalysisAlien::MergeInfo(infolog, outputDir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4740 </span>            :       }
<span class="lineNum">    4741 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   // all outputs merged, validate&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4742 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   ofstream out;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4743 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   out.open(\&quot;outputs_valid\&quot;, ios::out);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4744 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   out.close();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4745 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   // read the analysis manager from file&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4746 </span><span class="lineNoCov">          0 :       if (IsLocalTest()) {</span>
<span class="lineNum">    4747 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;===================================\\n\&quot;);&quot; &lt;&lt; endl;      </span>
<span class="lineNum">    4748 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;Testing Terminate()...\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4749 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   printf(\&quot;===================================\\n\&quot;);&quot; &lt;&lt; endl;      </span>
<span class="lineNum">    4750 </span>            :       } else {   
<span class="lineNum">    4751 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   if (!outputDir.Contains(\&quot;Stage\&quot;)) return;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4752 </span>            :       }   
<span class="lineNum">    4753 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   mgr-&gt;SetRunFromPath(mgr-&gt;GetRunFromAlienPath(dir));&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4754 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   mgr-&gt;SetSkipTerminate(kFALSE);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4755 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   mgr-&gt;PrintStatus();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4756 </span><span class="lineNoCov">          0 :       if (mgr) {</span>
<span class="lineNum">    4757 </span><span class="lineNoCov">          0 :          if (mgr-&gt;GetDebugLevel()&gt;3) {</span>
<span class="lineNum">    4758 </span><span class="lineNoCov">          0 :             out &lt;&lt; &quot;   gEnv-&gt;SetValue(\&quot;XNet.Debug\&quot;, \&quot;1\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4759 </span>            :          } else {
<span class="lineNum">    4760 </span><span class="lineNoCov">          0 :             if (TestBit(AliAnalysisGrid::kTest))            </span>
<span class="lineNum">    4761 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   AliLog::SetGlobalLogLevel(AliLog::kWarning);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4762 </span>            :             else
<span class="lineNum">    4763 </span><span class="lineNoCov">          0 :                out &lt;&lt; &quot;   AliLog::SetGlobalLogLevel(AliLog::kError);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4764 </span>            :          }
<span class="lineNum">    4765 </span>            :       }   
<span class="lineNum">    4766 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   TTree *tree = NULL;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4767 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   mgr-&gt;StartAnalysis(\&quot;gridterminate\&quot;, tree);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4768 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;}&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4769 </span><span class="lineNoCov">          0 :       if (hasANALYSISalice) {</span>
<span class="lineNum">    4770 </span><span class="lineNoCov">          0 :          out &lt;&lt;&quot;//________________________________________________________________________________&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4771 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;Bool_t SetupPar(const char *package) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4772 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;// Compile the package and set it up.&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4773 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TString pkgdir = package;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4774 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   pkgdir.ReplaceAll(\&quot;.par\&quot;,\&quot;\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4775 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;Exec(TString::Format(\&quot;tar xvzf %s.par\&quot;, pkgdir.Data()));&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4776 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   TString cdir = gSystem-&gt;WorkingDirectory();&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4777 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;ChangeDirectory(pkgdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4778 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   // Check for BUILD.sh and execute&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4779 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   if (!gSystem-&gt;AccessPathName(\&quot;PROOF-INF/BUILD.sh\&quot;)) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4780 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*******************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4781 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*** Building PAR archive    ***\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4782 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*******************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4783 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      if (gSystem-&gt;Exec(\&quot;PROOF-INF/BUILD.sh\&quot;)) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4784 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;         ::Error(\&quot;SetupPar\&quot;, \&quot;Cannot build par archive %s\&quot;, pkgdir.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4785 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;         gSystem-&gt;ChangeDirectory(cdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4786 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;         return kFALSE;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4787 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4788 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   } else {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4789 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      ::Error(\&quot;SetupPar\&quot;,\&quot;Cannot access PROOF-INF/BUILD.sh for package %s\&quot;, pkgdir.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4790 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      gSystem-&gt;ChangeDirectory(cdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4791 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      return kFALSE;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4792 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4793 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   // Check for SETUP.C and execute&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4794 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   if (!gSystem-&gt;AccessPathName(\&quot;PROOF-INF/SETUP.C\&quot;)) {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4795 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*******************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4796 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;***    Setup PAR archive    ***\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4797 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      printf(\&quot;*******************************\\n\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4798 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      gROOT-&gt;Macro(\&quot;PROOF-INF/SETUP.C\&quot;);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4799 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   } else {&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4800 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      ::Error(\&quot;SetupPar\&quot;,\&quot;Cannot access PROOF-INF/SETUP.C for package %s\&quot;, pkgdir.Data());&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4801 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      gSystem-&gt;ChangeDirectory(cdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4802 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;      return kFALSE;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4803 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4804 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   // Restore original workdir&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4805 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   gSystem-&gt;ChangeDirectory(cdir);&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4806 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   return kTRUE;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4807 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;}&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4808 </span>            :       }
<span class="lineNum">    4809 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    4810 </span>            :    Bool_t copy = kTRUE;
<span class="lineNum">    4811 </span><span class="lineNoCov">          0 :    if (fProductionMode || TestBit(AliAnalysisGrid::kOffline) || TestBit(AliAnalysisGrid::kTest)) copy = kFALSE;</span>
<span class="lineNum">    4812 </span><span class="lineNoCov">          0 :    if (copy) {</span>
<span class="lineNum">    4813 </span><span class="lineNoCov">          0 :       CdWork();</span>
<span class="lineNum">    4814 </span><span class="lineNoCov">          0 :       TString workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    4815 </span><span class="lineNoCov">          0 :       workdir += fGridWorkingDir;</span>
<span class="lineNum">    4816 </span><span class="lineNoCov">          0 :       if (FileExists(mergingMacro)) gGrid-&gt;Rm(mergingMacro);</span>
<span class="lineNum">    4817 </span><span class="lineNoCov">          0 :       Info(&quot;WriteMergingMacro&quot;, &quot;\n#####   Copying merging macro: &lt;%s&gt; to your alien workspace&quot;, mergingMacro.Data());</span>
<span class="lineNum">    4818 </span>            : //      TFile::Cp(Form(&quot;file:%s&quot;,mergingMacro.Data()), Form(&quot;alien://%s/%s&quot;, workdir.Data(), mergingMacro.Data()));
<span class="lineNum">    4819 </span><span class="lineNoCov">          0 :       if (!copyLocal2Alien(&quot;WriteMergeMacro&quot;,mergingMacro.Data(), </span>
<span class="lineNum">    4820 </span><span class="lineNoCov">          0 :            Form(&quot;%s/%s&quot;, workdir.Data(), mergingMacro.Data()))) Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    4821 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    4822 </span><span class="lineNoCov">          0 : }</span>
<a name="4823"><span class="lineNum">    4823 </span>            : </a>
<span class="lineNum">    4824 </span>            : //______________________________________________________________________________
<span class="lineNum">    4825 </span>            : Bool_t AliAnalysisAlien::SetupPar(const char *package)
<span class="lineNum">    4826 </span>            : {
<span class="lineNum">    4827 </span>            : // Compile the par file archive pointed by &lt;package&gt;. This must be present in the current directory.
<span class="lineNum">    4828 </span>            : // Note that for loading the compiled library. The current directory should have precedence in
<span class="lineNum">    4829 </span>            : // LD_LIBRARY_PATH
<span class="lineNum">    4830 </span><span class="lineNoCov">          0 :    TString pkgdir = package;</span>
<span class="lineNum">    4831 </span><span class="lineNoCov">          0 :    pkgdir.ReplaceAll(&quot;.par&quot;,&quot;&quot;);</span>
<span class="lineNum">    4832 </span><span class="lineNoCov">          0 :    gSystem-&gt;Exec(TString::Format(&quot;tar xzf %s.par&quot;, pkgdir.Data()));</span>
<span class="lineNum">    4833 </span><span class="lineNoCov">          0 :    TString cdir = gSystem-&gt;WorkingDirectory();</span>
<span class="lineNum">    4834 </span><span class="lineNoCov">          0 :    gSystem-&gt;ChangeDirectory(pkgdir);</span>
<span class="lineNum">    4835 </span>            :    // Check for BUILD.sh and execute
<span class="lineNum">    4836 </span><span class="lineNoCov">          0 :    if (!gSystem-&gt;AccessPathName(&quot;PROOF-INF/BUILD.sh&quot;)) {</span>
<span class="lineNum">    4837 </span><span class="lineNoCov">          0 :       printf(&quot;**************************************************\n&quot;);</span>
<span class="lineNum">    4838 </span><span class="lineNoCov">          0 :       printf(&quot;*** Building PAR archive %s\n&quot;, package);</span>
<span class="lineNum">    4839 </span><span class="lineNoCov">          0 :       printf(&quot;**************************************************\n&quot;);</span>
<span class="lineNum">    4840 </span><span class="lineNoCov">          0 :       if (gSystem-&gt;Exec(&quot;PROOF-INF/BUILD.sh&quot;)) {</span>
<span class="lineNum">    4841 </span><span class="lineNoCov">          0 :          ::Error(&quot;SetupPar&quot;, &quot;Cannot build par archive %s&quot;, pkgdir.Data());</span>
<span class="lineNum">    4842 </span><span class="lineNoCov">          0 :          gSystem-&gt;ChangeDirectory(cdir);</span>
<span class="lineNum">    4843 </span><span class="lineNoCov">          0 :          return kFALSE;</span>
<span class="lineNum">    4844 </span>            :       }
<span class="lineNum">    4845 </span>            :    } else {
<span class="lineNum">    4846 </span><span class="lineNoCov">          0 :       ::Error(&quot;SetupPar&quot;,&quot;Cannot access PROOF-INF/BUILD.sh for package %s&quot;, pkgdir.Data());</span>
<span class="lineNum">    4847 </span><span class="lineNoCov">          0 :       gSystem-&gt;ChangeDirectory(cdir);</span>
<span class="lineNum">    4848 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    4849 </span>            :    }
<span class="lineNum">    4850 </span>            :    // Check for SETUP.C and execute
<span class="lineNum">    4851 </span><span class="lineNoCov">          0 :    if (!gSystem-&gt;AccessPathName(&quot;PROOF-INF/SETUP.C&quot;)) {</span>
<span class="lineNum">    4852 </span><span class="lineNoCov">          0 :       printf(&quot;**************************************************\n&quot;);</span>
<span class="lineNum">    4853 </span><span class="lineNoCov">          0 :       printf(&quot;*** Setup PAR archive %s\n&quot;, package);</span>
<span class="lineNum">    4854 </span><span class="lineNoCov">          0 :       printf(&quot;**************************************************\n&quot;);</span>
<span class="lineNum">    4855 </span><span class="lineNoCov">          0 :       gROOT-&gt;Macro(&quot;PROOF-INF/SETUP.C&quot;);</span>
<span class="lineNum">    4856 </span><span class="lineNoCov">          0 :       printf(&quot;*** Loaded library: %s\n&quot;, gSystem-&gt;GetLibraries(pkgdir,&quot;&quot;,kFALSE));</span>
<span class="lineNum">    4857 </span>            :    } else {
<span class="lineNum">    4858 </span><span class="lineNoCov">          0 :       ::Error(&quot;SetupPar&quot;,&quot;Cannot access PROOF-INF/SETUP.C for package %s&quot;, pkgdir.Data());</span>
<span class="lineNum">    4859 </span><span class="lineNoCov">          0 :       gSystem-&gt;ChangeDirectory(cdir);</span>
<span class="lineNum">    4860 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">    4861 </span>            :    }   
<span class="lineNum">    4862 </span>            :    // Restore original workdir
<span class="lineNum">    4863 </span><span class="lineNoCov">          0 :    gSystem-&gt;ChangeDirectory(cdir);</span>
<span class="lineNum">    4864 </span><span class="lineNoCov">          0 :    return kTRUE;</span>
<span class="lineNum">    4865 </span><span class="lineNoCov">          0 : }</span>
<a name="4866"><span class="lineNum">    4866 </span>            : </a>
<span class="lineNum">    4867 </span>            : //______________________________________________________________________________
<span class="lineNum">    4868 </span>            : void AliAnalysisAlien::WriteExecutable()
<span class="lineNum">    4869 </span>            : {
<span class="lineNum">    4870 </span>            : // Generate the alien executable script.
<span class="lineNum">    4871 </span>            :    // Patch executable with -x to catch error code
<span class="lineNum">    4872 </span><span class="lineNoCov">          0 :    if (fExecutableCommand.Contains(&quot;root&quot;) &amp;&amp; </span>
<span class="lineNum">    4873 </span><span class="lineNoCov">          0 :        fExecutableCommand.Contains(&quot;-q&quot;) &amp;&amp; </span>
<span class="lineNum">    4874 </span><span class="lineNoCov">          0 :        !fExecutableCommand.Contains(&quot;-x&quot;)) fExecutableCommand += &quot; -x&quot;;</span>
<span class="lineNum">    4875 </span><span class="lineNoCov">          0 :    if (!TestBit(AliAnalysisGrid::kSubmit)) {  </span>
<span class="lineNum">    4876 </span><span class="lineNoCov">          0 :       ofstream out;</span>
<span class="lineNum">    4877 </span><span class="lineNoCov">          0 :       out.open(fExecutable.Data(), ios::out);</span>
<span class="lineNum">    4878 </span><span class="lineNoCov">          0 :       if (out.bad()) {</span>
<span class="lineNum">    4879 </span><span class="lineNoCov">          0 :          Error(&quot;WriteExecutable&quot;, &quot;Bad file name for executable: %s&quot;, fExecutable.Data());</span>
<span class="lineNum">    4880 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    4881 </span>            :       }
<span class="lineNum">    4882 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;#!/bin/bash&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4883 </span>            :       // Make sure we can properly compile par files
<span class="lineNum">    4884 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4885 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;=========================================\&quot;&quot; &lt;&lt; endl; </span>
<span class="lineNum">    4886 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## PATH : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4887 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo $PATH&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4888 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## LD_LIBRARY_PATH : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4889 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo $LD_LIBRARY_PATH&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4890 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## ROOTSYS : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4891 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo $ROOTSYS&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4892 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## which root : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4893 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;which root&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4894 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## ALICE_ROOT : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4895 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo $ALICE_ROOT&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4896 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## which aliroot : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4897 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;which aliroot&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4898 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## system limits : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4899 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;ulimit -a&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4900 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## memory : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4901 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;free 2&gt; /dev/null || { [[ `uname` == Darwin ]] &amp;&amp; top -l 1 -s 0 | head -8 | tail -3; }&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4902 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;=========================================\&quot;&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4903 </span><span class="lineNoCov">          0 :       out &lt;&lt; fExecutableCommand &lt;&lt; &quot; &quot;; </span>
<span class="lineNum">    4904 </span><span class="lineNoCov">          0 :       out &lt;&lt; fAnalysisMacro.Data() &lt;&lt; &quot; &quot; &lt;&lt; fExecutableArgs.Data() &lt;&lt; endl;</span>
<span class="lineNum">    4905 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;RET=$?&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4906 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if [ \&quot;$RET\&quot; != \&quot;0\&quot; ];then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4907 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;  echo \&quot;======== ERROR : &quot; &lt;&lt; fAnalysisMacro.Data() &lt;&lt; &quot; finished with NON zero code: $RET ========\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4908 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;  if [ \&quot;$RET\&quot; -gt 128 ] &amp;&amp; [ \&quot;$RET\&quot; -lt 160 ]; then&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4909 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    let sig=\&quot;$RET - 128\&quot;&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4910 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    sigs='HUP INT QUIT ILL TRAP ABRT BUS FPE&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4911 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    KILL USR1 SEGV USR2 PIPE ALRM TERM STKFLT&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4912 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    CHLD CONT STOP TSTP TTIN TTOU URG XCPU&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4913 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    XFSZ VTALRM PROF WINCH IO PWR SYS'&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4914 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    sig=SIG`echo $sigs | awk '{ print $'\&quot;$sig\&quot;' }'`&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4915 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    echo \&quot;======== it appears to have been killed with signal: $sig ========\&quot;&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4916 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;  fi&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4917 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;  exit $RET&quot;&lt;&lt; endl;</span>
<span class="lineNum">    4918 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl &lt;&lt; endl ;</span>
<span class="lineNum">    4919 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;======== &quot; &lt;&lt; fAnalysisMacro.Data() &lt;&lt; &quot; finished with exit code: $RET ========\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4920 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## memory after: ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4921 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;free -m&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4922 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    4923 </span>            :    Bool_t copy = kTRUE;
<span class="lineNum">    4924 </span><span class="lineNoCov">          0 :    if (fProductionMode || TestBit(AliAnalysisGrid::kOffline) || TestBit(AliAnalysisGrid::kTest)) copy = kFALSE;</span>
<span class="lineNum">    4925 </span><span class="lineNoCov">          0 :    if (copy) {</span>
<span class="lineNum">    4926 </span><span class="lineNoCov">          0 :       CdWork();</span>
<span class="lineNum">    4927 </span><span class="lineNoCov">          0 :       TString workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    4928 </span><span class="lineNoCov">          0 :       workdir += fGridWorkingDir;</span>
<span class="lineNum">    4929 </span><span class="lineNoCov">          0 :       TString executable = TString::Format(&quot;%s/%s&quot;, workdir.Data(), fExecutable.Data());</span>
<span class="lineNum">    4930 </span><span class="lineNoCov">          0 :       if (FileExists(executable)) gGrid-&gt;Rm(executable);</span>
<span class="lineNum">    4931 </span><span class="lineNoCov">          0 :       Info(&quot;WriteExecutable&quot;, &quot;\n#####   Copying executable file &lt;%s&gt; to your AliEn bin directory&quot;, fExecutable.Data());</span>
<span class="lineNum">    4932 </span><span class="lineNoCov">          0 :       if (!copyLocal2Alien(&quot;WriteExecutable&quot;,fExecutable.Data(), </span>
<span class="lineNum">    4933 </span><span class="lineNoCov">          0 :           executable.Data())) Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    4934 </span><span class="lineNoCov">          0 :    } </span>
<span class="lineNum">    4935 </span><span class="lineNoCov">          0 : }</span>
<a name="4936"><span class="lineNum">    4936 </span>            : </a>
<span class="lineNum">    4937 </span>            : //______________________________________________________________________________
<span class="lineNum">    4938 </span>            : void AliAnalysisAlien::WriteMergeExecutable()
<span class="lineNum">    4939 </span>            : {
<span class="lineNum">    4940 </span>            : // Generate the alien executable script for the merging job.
<span class="lineNum">    4941 </span><span class="lineNoCov">          0 :    if (!fMergeViaJDL) return;</span>
<span class="lineNum">    4942 </span><span class="lineNoCov">          0 :    TString mergeExec = fExecutable;</span>
<span class="lineNum">    4943 </span><span class="lineNoCov">          0 :    mergeExec.ReplaceAll(&quot;.sh&quot;, &quot;_merge.sh&quot;);</span>
<span class="lineNum">    4944 </span><span class="lineNoCov">          0 :    if (!TestBit(AliAnalysisGrid::kSubmit)) {</span>
<span class="lineNum">    4945 </span><span class="lineNoCov">          0 :       ofstream out;</span>
<span class="lineNum">    4946 </span><span class="lineNoCov">          0 :       out.open(mergeExec.Data(), ios::out);</span>
<span class="lineNum">    4947 </span><span class="lineNoCov">          0 :       if (out.bad()) {</span>
<span class="lineNum">    4948 </span><span class="lineNoCov">          0 :          Error(&quot;WriteMergingExecutable&quot;, &quot;Bad file name for executable: %s&quot;, mergeExec.Data());</span>
<span class="lineNum">    4949 </span><span class="lineNoCov">          0 :          return;</span>
<span class="lineNum">    4950 </span>            :       }
<span class="lineNum">    4951 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;#!/bin/bash&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4952 </span>            :       // Make sure we can properly compile par files
<span class="lineNum">    4953 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4954 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;=========================================\&quot;&quot; &lt;&lt; endl; </span>
<span class="lineNum">    4955 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## PATH : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4956 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo $PATH&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4957 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## LD_LIBRARY_PATH : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4958 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo $LD_LIBRARY_PATH&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4959 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## ROOTSYS : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4960 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo $ROOTSYS&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4961 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## which root : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4962 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;which root&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4963 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## ALICE_ROOT : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4964 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo $ALICE_ROOT&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4965 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## which aliroot : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4966 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;which aliroot&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4967 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## system limits : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4968 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;ulimit -a&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4969 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## memory : ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4970 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;free -m&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4971 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;=========================================\&quot;&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    4972 </span><span class="lineNoCov">          0 :       TString mergeMacro = fExecutable;</span>
<span class="lineNum">    4973 </span><span class="lineNoCov">          0 :       mergeMacro.ReplaceAll(&quot;.sh&quot;, &quot;_merge.C&quot;);</span>
<span class="lineNum">    4974 </span><span class="lineNoCov">          0 :       if (IsOneStageMerging())</span>
<span class="lineNum">    4975 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;export ARG=\&quot;&quot; &lt;&lt; mergeMacro &lt;&lt; &quot;(\\\&quot;$1\\\&quot;)\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4976 </span>            :       else
<span class="lineNum">    4977 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;export ARG=\&quot;&quot; &lt;&lt; mergeMacro &lt;&lt; &quot;(\\\&quot;$1\\\&quot;,$2)\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4978 </span><span class="lineNoCov">          0 :       out &lt;&lt; fExecutableCommand &lt;&lt; &quot; &quot; &lt;&lt; &quot;$ARG&quot; &lt;&lt; endl; </span>
<span class="lineNum">    4979 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;RET=$?&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4980 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if [ \&quot;$RET\&quot; != \&quot;0\&quot; ];then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4981 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;  echo \&quot;======== ERROR : &quot; &lt;&lt; fAnalysisMacro.Data() &lt;&lt; &quot; finished with NON zero code: $RET ========\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4982 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;  if [ \&quot;$RET\&quot; -gt 128 ] &amp;&amp; [ \&quot;$RET\&quot; -lt 160 ]; then&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4983 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    let sig=\&quot;$RET - 128\&quot;&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4984 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    sigs='HUP INT QUIT ILL TRAP ABRT BUS FPE&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4985 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    KILL USR1 SEGV USR2 PIPE ALRM TERM STKFLT&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4986 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    CHLD CONT STOP TSTP TTIN TTOU URG XCPU&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4987 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    XFSZ VTALRM PROF WINCH IO PWR SYS'&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4988 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    sig=SIG`echo $sigs | awk '{ print $'\&quot;$sig\&quot;' }'`&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4989 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    echo \&quot;======== it appears to have been killed with signal: $sig ========\&quot;&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4990 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;  fi&quot;&lt;&lt;endl;</span>
<span class="lineNum">    4991 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;  exit $RET&quot;&lt;&lt; endl;</span>
<span class="lineNum">    4992 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl &lt;&lt; endl ;</span>
<span class="lineNum">    4993 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;======== &quot; &lt;&lt; mergeMacro.Data() &lt;&lt; &quot; finished with exit code: $? ========\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4994 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;############## memory after: ##############\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4995 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;free -m&quot; &lt;&lt; endl;</span>
<span class="lineNum">    4996 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    4997 </span>            :    Bool_t copy = kTRUE;
<span class="lineNum">    4998 </span><span class="lineNoCov">          0 :    if (fProductionMode || TestBit(AliAnalysisGrid::kOffline) || TestBit(AliAnalysisGrid::kTest)) copy = kFALSE;</span>
<span class="lineNum">    4999 </span><span class="lineNoCov">          0 :    if (copy) {</span>
<span class="lineNum">    5000 </span><span class="lineNoCov">          0 :       CdWork();</span>
<span class="lineNum">    5001 </span><span class="lineNoCov">          0 :       TString workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    5002 </span><span class="lineNoCov">          0 :       workdir += fGridWorkingDir;</span>
<span class="lineNum">    5003 </span><span class="lineNoCov">          0 :       TString executable = TString::Format(&quot;%s/%s&quot;, workdir.Data(), mergeExec.Data());</span>
<span class="lineNum">    5004 </span><span class="lineNoCov">          0 :       if (FileExists(executable)) gGrid-&gt;Rm(executable);</span>
<span class="lineNum">    5005 </span><span class="lineNoCov">          0 :       Info(&quot;WriteMergeExecutable&quot;, &quot;\n#####   Copying executable file &lt;%s&gt; to your AliEn bin directory&quot;, mergeExec.Data());</span>
<span class="lineNum">    5006 </span><span class="lineNoCov">          0 :       if (!copyLocal2Alien(&quot;WriteMergeExecutable&quot;,mergeExec.Data(), </span>
<span class="lineNum">    5007 </span><span class="lineNoCov">          0 :           executable.Data())) Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    5008 </span><span class="lineNoCov">          0 :    } </span>
<span class="lineNum">    5009 </span><span class="lineNoCov">          0 : }</span>
<a name="5010"><span class="lineNum">    5010 </span>            : </a>
<span class="lineNum">    5011 </span>            : //______________________________________________________________________________
<span class="lineNum">    5012 </span>            : void AliAnalysisAlien::WriteProductionFile(const char *filename) const
<span class="lineNum">    5013 </span>            : {
<span class="lineNum">    5014 </span>            : // Write the production file to be submitted by LPM manager. The format is:
<span class="lineNum">    5015 </span>            : // First line: full_path_to_jdl estimated_no_subjobs_per_master
<span class="lineNum">    5016 </span>            : // Next lines: full_path_to_dataset XXX (XXX is a string)
<span class="lineNum">    5017 </span>            : // To submit, one has to: submit jdl XXX for all lines
<span class="lineNum">    5018 </span><span class="lineNoCov">          0 :    ofstream out;</span>
<span class="lineNum">    5019 </span><span class="lineNoCov">          0 :    out.open(filename, ios::out);</span>
<span class="lineNum">    5020 </span><span class="lineNoCov">          0 :    if (out.bad()) {</span>
<span class="lineNum">    5021 </span><span class="lineNoCov">          0 :       Error(&quot;WriteProductionFile&quot;, &quot;Bad file name: %s&quot;, filename);</span>
<span class="lineNum">    5022 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    5023 </span>            :    }
<span class="lineNum">    5024 </span><span class="lineNoCov">          0 :    TString workdir;</span>
<span class="lineNum">    5025 </span><span class="lineNoCov">          0 :    if (!fProductionMode &amp;&amp; !fGridWorkingDir.BeginsWith(&quot;/alice&quot;))</span>
<span class="lineNum">    5026 </span><span class="lineNoCov">          0 :       workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    5027 </span><span class="lineNoCov">          0 :    workdir += fGridWorkingDir;</span>
<span class="lineNum">    5028 </span><span class="lineNoCov">          0 :    Int_t njobspermaster = 1000*fNrunsPerMaster/fSplitMaxInputFileNumber;</span>
<span class="lineNum">    5029 </span><span class="lineNoCov">          0 :    TString locjdl = Form(&quot;%s/%s&quot;, workdir.Data(),fJDLName.Data());</span>
<span class="lineNum">    5030 </span><span class="lineNoCov">          0 :    out &lt;&lt; locjdl &lt;&lt; &quot; &quot; &lt;&lt; njobspermaster &lt;&lt; endl;</span>
<span class="lineNum">    5031 </span><span class="lineNoCov">          0 :    Int_t nmasterjobs = fInputFiles-&gt;GetEntries();</span>
<span class="lineNum">    5032 </span><span class="lineNoCov">          0 :    for (Int_t i=0; i&lt;nmasterjobs; i++) {</span>
<span class="lineNum">    5033 </span><span class="lineNoCov">          0 :       TString runOutDir = gSystem-&gt;BaseName(fInputFiles-&gt;At(i)-&gt;GetName());</span>
<span class="lineNum">    5034 </span><span class="lineNoCov">          0 :       runOutDir.ReplaceAll(&quot;.xml&quot;, &quot;&quot;);</span>
<span class="lineNum">    5035 </span><span class="lineNoCov">          0 :       if (fOutputToRunNo)</span>
<span class="lineNum">    5036 </span><span class="lineNoCov">          0 :          out &lt;&lt; Form(&quot;%s&quot;, fInputFiles-&gt;At(i)-&gt;GetName()) &lt;&lt; &quot; &quot; &lt;&lt; runOutDir &lt;&lt; endl;</span>
<span class="lineNum">    5037 </span>            :       else
<span class="lineNum">    5038 </span><span class="lineNoCov">          0 :          out &lt;&lt; Form(&quot;%s&quot;, fInputFiles-&gt;At(i)-&gt;GetName()) &lt;&lt; &quot; &quot; &lt;&lt; Form(&quot;%03d&quot;, i) &lt;&lt; endl;</span>
<span class="lineNum">    5039 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    5040 </span><span class="lineNoCov">          0 :    if (gGrid) {</span>
<span class="lineNum">    5041 </span><span class="lineNoCov">          0 :       Info(&quot;WriteProductionFile&quot;, &quot;\n#####   Copying production file &lt;%s&gt; to your work directory&quot;, filename);</span>
<span class="lineNum">    5042 </span><span class="lineNoCov">          0 :       if (FileExists(filename)) gGrid-&gt;Rm(filename);</span>
<span class="lineNum">    5043 </span>            : //      TFile::Cp(Form(&quot;file:%s&quot;,filename), Form(&quot;alien://%s/%s&quot;, workdir.Data(),filename));
<span class="lineNum">    5044 </span><span class="lineNoCov">          0 :       if (!copyLocal2Alien(&quot;WriteProductionFile&quot;, filename, </span>
<span class="lineNum">    5045 </span><span class="lineNoCov">          0 :           Form(&quot;%s/%s&quot;, workdir.Data(),filename))) Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    5046 </span>            :    }   
<span class="lineNum">    5047 </span><span class="lineNoCov">          0 : }</span>
<a name="5048"><span class="lineNum">    5048 </span>            : </a>
<span class="lineNum">    5049 </span>            : //______________________________________________________________________________
<span class="lineNum">    5050 </span>            : void AliAnalysisAlien::WriteValidationScript(Bool_t merge)
<span class="lineNum">    5051 </span>            : {
<span class="lineNum">    5052 </span>            : // Generate the alien validation script.
<span class="lineNum">    5053 </span>            :    // Generate the validation script
<span class="lineNum">    5054 </span>            :    TObjString *os;
<span class="lineNum">    5055 </span><span class="lineNoCov">          0 :    if (fValidationScript.IsNull()) {</span>
<span class="lineNum">    5056 </span><span class="lineNoCov">          0 :       fValidationScript = fExecutable;</span>
<span class="lineNum">    5057 </span><span class="lineNoCov">          0 :       fValidationScript.ReplaceAll(&quot;.sh&quot;, &quot;_validation.sh&quot;);</span>
<span class="lineNum">    5058 </span><span class="lineNoCov">          0 :    }   </span>
<span class="lineNum">    5059 </span><span class="lineNoCov">          0 :    TString validationScript = fValidationScript;</span>
<span class="lineNum">    5060 </span><span class="lineNoCov">          0 :    if (merge) validationScript.ReplaceAll(&quot;.sh&quot;, &quot;_merge.sh&quot;);</span>
<span class="lineNum">    5061 </span><span class="lineNoCov">          0 :    if (!Connect()) {</span>
<span class="lineNum">    5062 </span><span class="lineNoCov">          0 :       Error(&quot;WriteValidationScript&quot;, &quot;Alien connection required&quot;);</span>
<span class="lineNum">    5063 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    5064 </span>            :    }
<span class="lineNum">    5065 </span><span class="lineNoCov">          0 :    if (!fTerminateFiles.IsNull()) {</span>
<span class="lineNum">    5066 </span><span class="lineNoCov">          0 :       fTerminateFiles.Strip();</span>
<span class="lineNum">    5067 </span><span class="lineNoCov">          0 :       fTerminateFiles.ReplaceAll(&quot; &quot;,&quot;,&quot;);</span>
<span class="lineNum">    5068 </span>            :    }   
<span class="lineNum">    5069 </span><span class="lineNoCov">          0 :    TString outStream = &quot;&quot;;</span>
<span class="lineNum">    5070 </span><span class="lineNoCov">          0 :    if (!TestBit(AliAnalysisGrid::kTest)) outStream = &quot; &gt;&gt; stdout&quot;;</span>
<span class="lineNum">    5071 </span><span class="lineNoCov">          0 :    if (!TestBit(AliAnalysisGrid::kSubmit)) {  </span>
<span class="lineNum">    5072 </span><span class="lineNoCov">          0 :       ofstream out;</span>
<span class="lineNum">    5073 </span><span class="lineNoCov">          0 :       out.open(validationScript, ios::out);</span>
<span class="lineNum">    5074 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;#!/bin/bash&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5075 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;##################################################&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5076 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;validateout=`dirname $0`&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5077 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;validatetime=`date`&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5078 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;validated=\&quot;0\&quot;;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5079 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;error=0&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5080 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if [ -z $validateout ]&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5081 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5082 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;    validateout=\&quot;.\&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5083 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    5084 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;cd $validateout;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5085 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;validateworkdir=`pwd`;&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    5086 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;*******************************************************\&quot;&quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5087 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;* Automatically generated validation script           *\&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5088 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5089 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;* Time:    $validatetime \&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5090 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;* Dir:     $validateout\&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5091 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;* Workdir: $validateworkdir\&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5092 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;* ----------------------------------------------------*\&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5093 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;ls -la ./&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5094 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;* ----------------------------------------------------*\&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">    5095 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;##################################################&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5096 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5097 </span>            : 
<span class="lineNum">    5098 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if [ ! -f stderr ] ; then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5099 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   error=1&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5100 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;* ########## Job not validated - no stderr  ###\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5101 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;Error = $error\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5102 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5103 </span>            : 
<span class="lineNum">    5104 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;parArch=`grep -Ei \&quot;Cannot Build the PAR Archive\&quot; stderr`&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5105 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;segViol=`grep -Ei \&quot;Segmentation violation\&quot; stderr`&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5106 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;segFault=`grep -Ei \&quot;Segmentation fault\&quot; stderr`&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5107 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;glibcErr=`grep -Ei '\\*\\*\\* glibc detected \\*\\*\\*' stderr`&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5108 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5109 </span>            : 
<span class="lineNum">    5110 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if [ \&quot;$parArch\&quot; != \&quot;\&quot; ] ; then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5111 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   error=1&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5112 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;* ########## Job not validated - PAR archive not built  ###\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5113 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;$parArch\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5114 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;Error = $error\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5115 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5116 </span>            : 
<span class="lineNum">    5117 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if [ \&quot;$segViol\&quot; != \&quot;\&quot; ] ; then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5118 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   error=1&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5119 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;* ########## Job not validated - Segment. violation  ###\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5120 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;$segViol\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5121 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;Error = $error\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5122 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5123 </span>            : 
<span class="lineNum">    5124 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if [ \&quot;$segFault\&quot; != \&quot;\&quot; ] ; then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5125 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   error=1&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5126 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;* ########## Job not validated - Segment. fault  ###\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5127 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;$segFault\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5128 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;Error = $error\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5129 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5130 </span>            : 
<span class="lineNum">    5131 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if [ \&quot;$glibcErr\&quot; != \&quot;\&quot; ] ; then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5132 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   error=1&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5133 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;* ########## Job not validated - *** glibc detected ***  ###\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5134 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;$glibcErr\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5135 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;Error = $error\&quot; &quot; &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5136 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5137 </span>            : 
<span class="lineNum">    5138 </span>            :       // Part dedicated to the specific analyses running into the train
<span class="lineNum">    5139 </span>            : 
<span class="lineNum">    5140 </span><span class="lineNoCov">          0 :       TString outputFiles = fOutputFiles;</span>
<span class="lineNum">    5141 </span><span class="lineNoCov">          0 :       if (merge &amp;&amp; !fTerminateFiles.IsNull()) {</span>
<span class="lineNum">    5142 </span><span class="lineNoCov">          0 :          if (!outputFiles.IsNull()) outputFiles += &quot;,&quot;;</span>
<span class="lineNum">    5143 </span><span class="lineNoCov">          0 :          outputFiles += fTerminateFiles;</span>
<span class="lineNum">    5144 </span>            :       }
<span class="lineNum">    5145 </span><span class="lineNoCov">          0 :       TObjArray *arr = outputFiles.Tokenize(&quot;,&quot;);</span>
<span class="lineNum">    5146 </span><span class="lineNoCov">          0 :       TIter next1(arr);</span>
<span class="lineNum">    5147 </span><span class="lineNoCov">          0 :       TString outputFile;</span>
<span class="lineNum">    5148 </span><span class="lineNoCov">          0 :       while (!merge &amp;&amp; (os=(TObjString*)next1())) { </span>
<span class="lineNum">    5149 </span>            :          // No need to validate outputs produced by merging since the merging macro does this
<span class="lineNum">    5150 </span><span class="lineNoCov">          0 :          outputFile = os-&gt;GetString();</span>
<span class="lineNum">    5151 </span><span class="lineNoCov">          0 :          Int_t index = outputFile.Index(&quot;@&quot;);</span>
<span class="lineNum">    5152 </span><span class="lineNoCov">          0 :          if (index &gt; 0) outputFile.Remove(index);</span>
<span class="lineNum">    5153 </span><span class="lineNoCov">          0 :          if (fTerminateFiles.Contains(outputFile)) continue;</span>
<span class="lineNum">    5154 </span><span class="lineNoCov">          0 :          if (outputFile.Contains(&quot;*&quot;)) continue;</span>
<span class="lineNum">    5155 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;if ! [ -f &quot; &lt;&lt; outputFile.Data() &lt;&lt; &quot; ] ; then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5156 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   error=1&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5157 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   echo \&quot;Output file &quot; &lt;&lt; outputFile &lt;&lt; &quot; not found. Job FAILED !\&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5158 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   echo \&quot;Output file &quot; &lt;&lt; outputFile &lt;&lt; &quot; not found. Job FAILED !\&quot; &gt;&gt; stderr&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5159 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;fi&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5160 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">    5161 </span><span class="lineNoCov">          0 :       delete arr;</span>
<span class="lineNum">    5162 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if ! [ -f outputs_valid ] ; then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5163 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   error=1&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5164 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;Output files were not validated by the analysis manager\&quot; &gt;&gt; stdout&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5165 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;Output files were not validated by the analysis manager\&quot; &gt;&gt; stderr&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5166 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5167 </span>            :       
<span class="lineNum">    5168 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;if [ $error = 0 ] ; then&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5169 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;   echo \&quot;* ----------------   Job Validated  ------------------*\&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5170 </span><span class="lineNoCov">          0 :       if (!IsKeepLogs()) {</span>
<span class="lineNum">    5171 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   echo \&quot;* === Logs std* will be deleted === \&quot;&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5172 </span><span class="lineNoCov">          0 :          outStream = &quot;&quot;;</span>
<span class="lineNum">    5173 </span><span class="lineNoCov">          0 :          out &lt;&lt; &quot;   rm -f std*&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5174 </span>            :       }            
<span class="lineNum">    5175 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;fi&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5176 </span>            : 
<span class="lineNum">    5177 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;* ----------------------------------------------------*\&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5178 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;echo \&quot;*******************************************************\&quot;&quot;  &lt;&lt; outStream &lt;&lt; endl;</span>
<span class="lineNum">    5179 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;cd -&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5180 </span><span class="lineNoCov">          0 :       out &lt;&lt; &quot;exit $error&quot; &lt;&lt; endl;</span>
<span class="lineNum">    5181 </span><span class="lineNoCov">          0 :    }    </span>
<span class="lineNum">    5182 </span>            :    Bool_t copy = kTRUE;
<span class="lineNum">    5183 </span><span class="lineNoCov">          0 :    if (fProductionMode || TestBit(AliAnalysisGrid::kOffline) || TestBit(AliAnalysisGrid::kTest)) copy = kFALSE;</span>
<span class="lineNum">    5184 </span><span class="lineNoCov">          0 :    if (copy) {</span>
<span class="lineNum">    5185 </span><span class="lineNoCov">          0 :       CdWork();</span>
<span class="lineNum">    5186 </span><span class="lineNoCov">          0 :       TString workdir = gGrid-&gt;GetHomeDirectory();</span>
<span class="lineNum">    5187 </span><span class="lineNoCov">          0 :       workdir += fGridWorkingDir;</span>
<span class="lineNum">    5188 </span><span class="lineNoCov">          0 :       Info(&quot;WriteValidationScript&quot;, &quot;\n#####   Copying validation script &lt;%s&gt; to your AliEn working space&quot;, validationScript.Data());</span>
<span class="lineNum">    5189 </span><span class="lineNoCov">          0 :       if (FileExists(validationScript)) gGrid-&gt;Rm(validationScript);</span>
<span class="lineNum">    5190 </span>            : //      TFile::Cp(Form(&quot;file:%s&quot;,validationScript.Data()), Form(&quot;alien://%s/%s&quot;, workdir.Data(),validationScript.Data()));
<span class="lineNum">    5191 </span><span class="lineNoCov">          0 :       if (!copyLocal2Alien(&quot;WriteValidationScript&quot;, validationScript.Data(), </span>
<span class="lineNum">    5192 </span><span class="lineNoCov">          0 :           Form(&quot;%s/%s&quot;,workdir.Data(), validationScript.Data()))) Fatal(&quot;&quot;,&quot;Terminating&quot;);</span>
<span class="lineNum">    5193 </span><span class="lineNoCov">          0 :    } </span>
<span class="lineNum">    5194 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
