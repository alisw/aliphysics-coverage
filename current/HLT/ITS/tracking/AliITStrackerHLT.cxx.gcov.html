<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - HLT/ITS/tracking/AliITStrackerHLT.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">HLT/ITS/tracking</a> - AliITStrackerHLT.cxx<span style="font-size: 80%;"> (source / <a href="AliITStrackerHLT.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">541</td>
            <td class="headerCovTableEntryLo">0.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">38</td>
            <td class="headerCovTableEntryLo">2.6 %</td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 2007-2009, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : /* $Id: AliITStrackerHLT.cxx 32466 2009-05-20 07:51:56Z hristov $ */
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">      18 </span>            : //               Implementation of the ITS tracker class
<span class="lineNum">      19 </span>            : //    It reads AliITSRecPoint clusters and creates AliHLTITSTrack tracks
<span class="lineNum">      20 </span>            : //                   and fills with them the ESD
<span class="lineNum">      21 </span>            : //          Origin: Marian Ivanov, CERN, Marian.Ivanov@cern.ch 
<span class="lineNum">      22 </span>            : //          Current support and development: 
<span class="lineNum">      23 </span>            : //                     Andrea Dainese, andrea.dainese@lnl.infn.it
<span class="lineNum">      24 </span>            : //     dE/dx analysis by: Boris Batyunya, JINR, Boris.Batiounia@cern.ch
<span class="lineNum">      25 </span>            : //     Params moved to AliITSRecoParam by: Andrea Dainese, INFN
<span class="lineNum">      26 </span>            : //     Material budget from TGeo by: Ludovic Gaudichet &amp; Andrea Dainese, INFN
<span class="lineNum">      27 </span>            : //-------------------------------------------------------------------------
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : //#include &lt;TMatrixD.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;TTree.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;TDatabasePDG.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;TString.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;TRandom.h&gt;
<span class="lineNum">      34 </span>            : #include &lt;TTreeStream.h&gt;
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;AliITSCalibrationSPD.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;AliITSCalibrationSDD.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;AliITSCalibrationSSD.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;AliCDBEntry.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;AliCDBManager.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;AliAlignObj.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;AliTrackPointArray.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;AliESDVertex.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;AliESDEvent.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;AliESDtrack.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;AliV0.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;AliHelix.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;AliITSChannelStatus.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;AliITSRecPoint.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;AliITSgeomTGeo.h&quot;
<span class="lineNum">      53 </span>            : #include &quot;AliITSReconstructor.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;AliITSClusterParam.h&quot;
<span class="lineNum">      55 </span>            : #include &quot;AliITSsegmentation.h&quot;
<span class="lineNum">      56 </span>            : #include &quot;AliITSCalibration.h&quot;
<span class="lineNum">      57 </span>            : #include &quot;AliITSV0Finder.h&quot;
<span class="lineNum">      58 </span>            : #include &quot;AliITStrackerHLT.h&quot;
<span class="lineNum">      59 </span>            : #include &quot;TStopwatch.h&quot;
<span class="lineNum">      60 </span>            : //#include &quot;AliHLTTPCCATrackParam.h&quot;
<span class="lineNum">      61 </span>            : //#include &quot;AliHLTVertexer.h&quot;
<span class="lineNum">      62 </span>            : #include &lt;vector&gt;
<a name="63"><span class="lineNum">      63 </span>            : </a>
<span class="lineNum">      64 </span>            : using std::vector;
<a name="65"><span class="lineNum">      65 </span><span class="lineCov">          6 : ClassImp(AliITStrackerHLT)</span></a>
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            : Bool_t AliITStrackerHLT::CheckTrack( const AliExternalTrackParam *t )
<span class="lineNum">      68 </span>            : {
<span class="lineNum">      69 </span>            :   // Check that the track parameters are reasonable in order to avoid floating point exeptions in AliExternalTrackParam routines
<span class="lineNum">      70 </span>            :   
<span class="lineNum">      71 </span>            :   bool ok = 1;
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :   for( int i=0; i&lt;5; i++ ) ok = ok &amp;&amp; finite(t-&gt;GetParameter()[i]);</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :   for( int i=0; i&lt;15; i++ ) ok = ok &amp;&amp; finite(t-&gt;GetCovariance()[i]);</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :   ok = ok &amp;&amp; ( TMath::Abs(t-&gt;GetX()) &lt; 500. );</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :   ok = ok &amp;&amp; ( TMath::Abs(t-&gt;GetY()) &lt; 500. );</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :   ok = ok &amp;&amp; ( TMath::Abs(t-&gt;GetZ()) &lt; 500. );</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :   ok = ok &amp;&amp; ( TMath::Abs(t-&gt;GetSnp()) &lt; .99 );</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :   ok = ok &amp;&amp; ( TMath::Abs(t-&gt;GetSigned1Pt()) &lt; 1./0.01 );</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :   return ok;</span>
<a name="80"><span class="lineNum">      80 </span>            : }</a>
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span>            : Bool_t AliITStrackerHLT::TransportToX( AliExternalTrackParam *t, double x ) const
<span class="lineNum">      83 </span>            : {
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :   return CheckTrack(t) &amp;&amp; t-&gt;PropagateTo( x, t-&gt;GetBz() );</span>
<a name="85"><span class="lineNum">      85 </span>            : }</a>
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span>            : Bool_t AliITStrackerHLT::TransportToPhiX( AliExternalTrackParam *t, double phi, double x ) const
<span class="lineNum">      88 </span>            : {
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :   return CheckTrack(t) &amp;&amp; t-&gt;Propagate( phi, x, t-&gt;GetBz() );</span>
<span class="lineNum">      90 </span>            : }
<span class="lineNum">      91 </span>            : 
<a name="92"><span class="lineNum">      92 </span>            : </a>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span>            : AliITStrackerHLT::AliITStrackerHLT()
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :   :AliTracker(),</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :    fRecoParam(0),</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :    fLayers(new AliHLTITSLayer[AliITSgeomTGeo::kNLayers]),</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :    fUseTGeo(2),</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :    fxOverX0Pipe(-1.),</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :    fxTimesRhoPipe(-1.), </span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :    fTracks(0),</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :    fITSOutTracks(0),</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :    fNTracks(0),</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :    fNITSOutTracks(0),</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :    fLoadTime(0),</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :    fRecoTime(0),</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :    fNEvents(0),</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :    fClusters(0),</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :    fNClusters(0)</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     111 </span>            :   //Default constructor
<span class="lineNum">     112 </span>            :   Int_t i;
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;4;i++) fSPDdetzcentre[i]=0.;</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;2;i++) {fxOverX0Shield[i]=-1.;fxTimesRhoShield[i]=-1.;}</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;6;i++) {fxOverX0Layer[i]=-1.;fxTimesRhoLayer[i]=-1.;}</span>
<a name="116"><span class="lineNum">     116 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     117 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     118 </span>            : AliITStrackerHLT::AliITStrackerHLT(const Char_t *geom) 
<span class="lineNum">     119 </span><span class="lineNoCov">          0 : : AliTracker(),</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :   fRecoParam(0),</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :   fLayers(new AliHLTITSLayer[AliITSgeomTGeo::kNLayers]),  </span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :   fUseTGeo(2),</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :   fxOverX0Pipe(-1.),</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   fxTimesRhoPipe(-1.),</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :   fTracks(0),</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :   fITSOutTracks(0),</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :   fNTracks(0),</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :   fNITSOutTracks(0),</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :   fLoadTime(0),</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :    fRecoTime(0),</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   fNEvents(0),</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :   fClusters(0),</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :   fNClusters(0)</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     135 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     136 </span>            :   //This is the AliITStrackerHLT constructor
<span class="lineNum">     137 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :   if (geom) {</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :     AliWarning(&quot;\&quot;geom\&quot; is actually a dummy argument !&quot;);</span>
<span class="lineNum">     140 </span>            :   }
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :   if(AliGeomManager::GetGeometry()==NULL){</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :     AliGeomManager::LoadGeometry();</span>
<span class="lineNum">     144 </span>            :   }
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :   fRecoParam = AliITSReconstructor::GetRecoParam();</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :   if( !fRecoParam ){</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :     AliITSReconstructor *tmp = new AliITSReconstructor();</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     tmp-&gt;Init();</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :     fRecoParam = AliITSRecoParam::GetLowFluxParam();</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :     tmp-&gt;AliReconstructor::SetRecoParam(fRecoParam);</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   for (Int_t i=1; i&lt;AliITSgeomTGeo::GetNLayers()+1; i++) {</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :     Int_t nlad=AliITSgeomTGeo::GetNLadders(i);</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :     Int_t ndet=AliITSgeomTGeo::GetNDetectors(i);</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :     Double_t xyz[3], &amp;x=xyz[0], &amp;y=xyz[1], &amp;z=xyz[2];</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :     AliITSgeomTGeo::GetOrigTranslation(i,1,1,xyz); </span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :     Double_t poff=TMath::ATan2(y,x);</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :     Double_t zoff=z;</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :     Double_t r=TMath::Sqrt(x*x + y*y);</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :     AliITSgeomTGeo::GetOrigTranslation(i,1,2,xyz);</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :     r += TMath::Sqrt(x*x + y*y);</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     AliITSgeomTGeo::GetOrigTranslation(i,2,1,xyz);</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :     r += TMath::Sqrt(x*x + y*y);</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :     AliITSgeomTGeo::GetOrigTranslation(i,2,2,xyz);</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :     r += TMath::Sqrt(x*x + y*y);</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :     r*=0.25;</span>
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :     new (fLayers+i-1) AliHLTITSLayer(r,poff,zoff,nlad,ndet);</span>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :     for (Int_t j=1; j&lt;nlad+1; j++) {</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :       for (Int_t k=1; k&lt;ndet+1; k++) { //Fill this layer with detectors</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :         TGeoHMatrix m; AliITSgeomTGeo::GetOrigMatrix(i,j,k,m);</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :         const TGeoHMatrix *tm=AliITSgeomTGeo::GetTracking2LocalMatrix(i,j,k);</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :         m.Multiply(tm);</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :         Double_t txyz[3]={0.};</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :         xyz[0]=0.;xyz[1]=0.;xyz[2]=0.;</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :         m.LocalToMaster(txyz,xyz);</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :         r=TMath::Sqrt(xyz[0]*xyz[0] + xyz[1]*xyz[1]);</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :         Double_t phi=TMath::ATan2(xyz[1],xyz[0]);</span>
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :         if (phi&lt;0) phi+=TMath::TwoPi();</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :         else if (phi&gt;=TMath::TwoPi()) phi-=TMath::TwoPi();</span>
<span class="lineNum">     186 </span>            : 
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :         AliHLTITSDetector &amp;det=fLayers[i-1].GetDetector((j-1)*ndet + k-1); </span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :         new(&amp;det) AliHLTITSDetector(r,phi); </span>
<span class="lineNum">     189 </span>            :         // compute the real radius (with misalignment)
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :         TGeoHMatrix mmisal(*(AliITSgeomTGeo::GetMatrix(i,j,k)));</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :         mmisal.Multiply(tm);</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :         xyz[0]=0.;xyz[1]=0.;xyz[2]=0.;</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :         mmisal.LocalToMaster(txyz,xyz);</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :         Double_t rmisal=TMath::Sqrt(xyz[0]*xyz[0] + xyz[1]*xyz[1]);</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :         det.SetRmisal(rmisal);</span>
<span class="lineNum">     196 </span>            :         
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :       } // end loop on detectors</span>
<span class="lineNum">     198 </span>            :     } // end loop on ladders
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :   } // end loop on layers</span>
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span>            :   
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :   Double_t xyzVtx[]={ fRecoParam-&gt;GetXVdef(),</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :                       fRecoParam-&gt;GetYVdef(),</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :                       fRecoParam-&gt;GetZVdef()}; </span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :   Double_t ersVtx[]={ fRecoParam-&gt;GetSigmaXVdef(),</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :                       fRecoParam-&gt;GetSigmaYVdef(),</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :                       fRecoParam-&gt;GetSigmaZVdef()}; </span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :   SetVertex(xyzVtx,ersVtx);</span>
<span class="lineNum">     210 </span>            : 
<span class="lineNum">     211 </span>            :   // store positions of centre of SPD modules (in z)
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :   Double_t tr[3];</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :   AliITSgeomTGeo::GetTranslation(1,1,1,tr);</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :   fSPDdetzcentre[0] = tr[2];</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :   AliITSgeomTGeo::GetTranslation(1,1,2,tr);</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :   fSPDdetzcentre[1] = tr[2];</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :   AliITSgeomTGeo::GetTranslation(1,1,3,tr);</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :   fSPDdetzcentre[2] = tr[2];</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   AliITSgeomTGeo::GetTranslation(1,1,4,tr);</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   fSPDdetzcentre[3] = tr[2];</span>
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span>            :   //fUseTGeo = fRecoParam-&gt;GetUseTGeoInTracker();
<span class="lineNum">     223 </span>            :   //if(fRecoParam-&gt;GetExtendedEtaAcceptance() &amp;&amp; fUseTGeo!=1 &amp;&amp; fUseTGeo!=3) {
<span class="lineNum">     224 </span>            :   //AliWarning(&quot;fUseTGeo changed to 3 because fExtendedEtaAcceptance is kTRUE&quot;);
<span class="lineNum">     225 </span>            :   //fUseTGeo = 3;
<span class="lineNum">     226 </span>            :   //}
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   for(Int_t i=0;i&lt;2;i++) {fxOverX0Shield[i]=-1.;fxTimesRhoShield[i]=-1.;}</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :   for(Int_t i=0;i&lt;6;i++) {fxOverX0Layer[i]=-1.;fxTimesRhoLayer[i]=-1.;}</span>
<span class="lineNum">     230 </span>            :   
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :   Init();</span>
<a name="232"><span class="lineNum">     232 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     233 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     234 </span>            : AliITStrackerHLT::AliITStrackerHLT(const AliITStrackerHLT &amp;tracker)
<span class="lineNum">     235 </span><span class="lineNoCov">          0 : :AliTracker(tracker),</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :  fRecoParam( tracker.fRecoParam),</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :  fLayers(new AliHLTITSLayer[AliITSgeomTGeo::kNLayers]), </span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :  fUseTGeo(tracker.fUseTGeo),</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :  fxOverX0Pipe(tracker.fxOverX0Pipe),</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :  fxTimesRhoPipe(tracker.fxTimesRhoPipe), </span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :  fTracks(0),</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :  fITSOutTracks(0),</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :  fNTracks(0),</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :  fNITSOutTracks(0),</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :   fLoadTime(0),</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :    fRecoTime(0),</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :  fNEvents(0),</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :  fClusters(0),</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :  fNClusters(0)</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     251 </span>            :   //Copy constructor
<span class="lineNum">     252 </span>            :   Int_t i;
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;4;i++) {</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :     fSPDdetzcentre[i]=tracker.fSPDdetzcentre[i];</span>
<span class="lineNum">     255 </span>            :   }
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;6;i++) {</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :     fxOverX0Layer[i]=tracker.fxOverX0Layer[i];</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :     fxTimesRhoLayer[i]=tracker.fxTimesRhoLayer[i];</span>
<span class="lineNum">     259 </span>            :   }
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :   for(i=0;i&lt;2;i++) {</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     fxOverX0Shield[i]=tracker.fxOverX0Shield[i];</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :     fxTimesRhoShield[i]=tracker.fxTimesRhoShield[i];</span>
<span class="lineNum">     263 </span>            :   }
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :   Init();</span>
<a name="265"><span class="lineNum">     265 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     266 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     267 </span>            : AliITStrackerHLT &amp; AliITStrackerHLT::operator=(const AliITStrackerHLT &amp;tracker){
<span class="lineNum">     268 </span>            :   //Assignment operator
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :   this-&gt;~AliITStrackerHLT();</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :   new(this) AliITStrackerHLT(tracker);</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :   return *this;</span>
<a name="272"><span class="lineNum">     272 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     273 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     274 </span>            : AliITStrackerHLT::~AliITStrackerHLT()
<span class="lineNum">     275 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     276 </span>            :   //
<span class="lineNum">     277 </span>            :   //destructor
<span class="lineNum">     278 </span>            :   //
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   delete[] fLayers;</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :   delete[] fTracks;</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :   delete[] fITSOutTracks;</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :   delete[] fClusters;</span>
<a name="283"><span class="lineNum">     283 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span>            : void AliITStrackerHLT::Init()
<span class="lineNum">     286 </span>            : {
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :   BuildMaterialLUT(&quot;Layers&quot;);  </span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   BuildMaterialLUT(&quot;Pipe&quot;);  </span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   BuildMaterialLUT(&quot;Shields&quot;);  </span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 : }</span>
<a name="291"><span class="lineNum">     291 </span>            : </a>
<span class="lineNum">     292 </span>            : 
<span class="lineNum">     293 </span>            : void AliITStrackerHLT::StartLoadClusters( Int_t NOfClusters )
<span class="lineNum">     294 </span>            : {
<span class="lineNum">     295 </span>            :   // !
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :   delete[] fClusters;</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :   fClusters = new AliITSRecPoint[NOfClusters];</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :   fNClusters = 0;</span>
<a name="299"><span class="lineNum">     299 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span>            : void AliITStrackerHLT::LoadCluster( const AliITSRecPoint &amp;cluster) 
<span class="lineNum">     302 </span>            : {
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :   fClusters[fNClusters++] = cluster ;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span>            : 
<a name="307"><span class="lineNum">     307 </span>            : </a>
<span class="lineNum">     308 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     309 </span>            : Int_t AliITStrackerHLT::LoadClusters(TTree *cTree) {
<span class="lineNum">     310 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     311 </span>            :   //This function loads ITS clusters
<span class="lineNum">     312 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :   TBranch *branch=cTree-&gt;GetBranch(&quot;ITSRecPoints&quot;);</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :   if (!branch) { </span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     Error(&quot;LoadClusters&quot;,&quot; can't get the branch !\n&quot;);</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">     319 </span>            :   }
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :   static TClonesArray dummy(&quot;AliITSRecPoint&quot;,10000), *clusters=&amp;dummy;</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :   branch-&gt;SetAddress(&amp;clusters);</span>
<span class="lineNum">     323 </span>            : 
<span class="lineNum">     324 </span>            :   int nClustersTotal = 0;
<span class="lineNum">     325 </span>            :   {
<span class="lineNum">     326 </span>            :     Int_t j=0;
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     for (int i=0; i&lt;AliITSgeomTGeo::GetNLayers(); i++) {</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :       int ndet=fLayers[i].GetNdetectors();</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       Int_t jmax = j + fLayers[i].GetNladders()*ndet;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :       for (; j&lt;jmax; j++) {           </span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :         if (!cTree-&gt;GetEvent(j)) continue;</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :         nClustersTotal+=clusters-&gt;GetEntriesFast();      </span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :         clusters-&gt;Delete();</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     335 </span>            :     }
<span class="lineNum">     336 </span>            :   }
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :   StartLoadClusters(nClustersTotal);</span>
<span class="lineNum">     338 </span>            :   {
<span class="lineNum">     339 </span>            :     Int_t j=0;
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     for (int i=0; i&lt;AliITSgeomTGeo::GetNLayers(); i++) {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       int ndet=fLayers[i].GetNdetectors();</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :       Int_t jmax = j + fLayers[i].GetNladders()*ndet;</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :       for (; j&lt;jmax; j++) {           </span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :         if (!cTree-&gt;GetEvent(j)) continue;</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :         Int_t ncl=clusters-&gt;GetEntriesFast(); </span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :         while (ncl--) {</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :           LoadCluster( *( (AliITSRecPoint*)clusters-&gt;UncheckedAt(ncl)));</span>
<span class="lineNum">     348 </span>            :         }
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :         clusters-&gt;Delete();</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     351 </span>            :     }
<span class="lineNum">     352 </span>            :   }
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :   dummy.Clear();</span>
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span>            :   return 0;
<span class="lineNum">     357 </span><span class="lineNoCov">          0 : }</span>
<a name="358"><span class="lineNum">     358 </span>            : </a>
<span class="lineNum">     359 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     360 </span>            : void AliITStrackerHLT::UnloadClusters() {
<span class="lineNum">     361 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     362 </span>            :   //This function unloads ITS clusters
<span class="lineNum">     363 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;AliITSgeomTGeo::GetNLayers(); i++) fLayers[i].ResetClusters();</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :   delete[] fClusters;</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   fClusters = 0;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :   fNClusters=0;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span>            : 
<a name="371"><span class="lineNum">     371 </span>            : </a>
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span>            : void AliITStrackerHLT::Reconstruct( AliExternalTrackParam *tracksTPC, int *tracksTPCLab, int nTPCTracks )
<span class="lineNum">     374 </span>            : {
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     377 </span>            :   // This functions reconstructs ITS tracks
<span class="lineNum">     378 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :   fNEvents++;</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span>            :   // Init clusters
<span class="lineNum">     383 </span>            :  
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :   TStopwatch timerInit;</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   for( int i=0; i&lt;AliITSgeomTGeo::GetNLayers(); i++ ){ </span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     fLayers[i].ResetClusters();</span>
<span class="lineNum">     388 </span>            :   }
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :   for( int icl=0; icl&lt;fNClusters; icl++ ){   </span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     AliITSRecPoint &amp;cl = fClusters[icl];</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     if (!cl.Misalign()) AliWarning(&quot;Can't misalign this cluster !&quot;); </span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     fLayers[cl.GetLayer()].InsertCluster(&amp;cl); </span>
<span class="lineNum">     394 </span>            :   }
<span class="lineNum">     395 </span>            : 
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :   for( int i=0; i&lt;AliITSgeomTGeo::GetNLayers(); i++ ){ </span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     fLayers[i].ResetRoad(); //road defined by the cluster density</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     fLayers[i].SortClusters();</span>
<span class="lineNum">     399 </span>            :   }  
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :   timerInit.Stop();</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :   fLoadTime+=timerInit.RealTime();</span>
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :   TStopwatch timer;</span>
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :   Double_t pimass = TDatabasePDG::Instance()-&gt;GetParticle(211)-&gt;Mass();</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :   delete[] fTracks;</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :   delete[] fITSOutTracks;</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :   fTracks = new AliHLTITSTrack[nTPCTracks];</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :   fITSOutTracks = new AliHLTITSTrack[nTPCTracks];</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :   fNTracks = 0;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :   fNITSOutTracks = 0;</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :   for( int itr=0; itr&lt;nTPCTracks; itr++ ){    </span>
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     AliHLTITSTrack tMI( tracksTPC[itr] );</span>
<span class="lineNum">     416 </span>            :     AliHLTITSTrack *t = &amp;tMI;
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :     t-&gt;SetTPCtrackId( itr );</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :     t-&gt;SetMass(pimass); </span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :     t-&gt;SetExpQ(0);</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     t-&gt;SetLabel(tracksTPCLab[itr]);</span>
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span>            :     //if (!CorrectForTPCtoITSDeadZoneMaterial(t))  continue;
<span class="lineNum">     423 </span>            :       
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :     Int_t tpcLabel=t-&gt;GetLabel(); //save the TPC track label       </span>
<span class="lineNum">     425 </span>            :     
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :     FollowProlongationTree(t); </span>
<span class="lineNum">     427 </span>            :     int nclu=0;
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :     for(Int_t i=0; i&lt;6; i++) {</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :       if( t-&gt;GetClusterIndex(i)&gt;=0 ) nclu++; </span>
<span class="lineNum">     430 </span>            :     }
<span class="lineNum">     431 </span>            :     //cout&lt;&lt;&quot;N assigned ITS clusters = &quot;&lt;&lt;nclu&lt;&lt;std::endl;
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :     t-&gt;SetLabel(-1);</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :     if( nclu&gt;0 ){</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :       t-&gt;SetLabel(tpcLabel);</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :       t-&gt;SetFakeRatio(1.);</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :       CookLabel(t,.99); //For comparison only</span>
<span class="lineNum">     437 </span>            :       //cout&lt;&lt;&quot;SG: label = &quot;&lt;&lt;t-&gt;GetLabel()&lt;&lt;&quot; / &quot;&lt;&lt;tpcLabel&lt;&lt;endl;
<span class="lineNum">     438 </span>            :     }
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :     CorrectForPipeMaterial(t);</span>
<span class="lineNum">     441 </span>            :    
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :     TransportToX(t, 0 );</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :     fTracks[fNTracks++] = *t;  </span>
<span class="lineNum">     444 </span>            :     //cout&lt;&lt;&quot;SG: ITS: Bz = &quot;&lt;&lt;t-&gt;GetBz()&lt;&lt;endl;
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :     if(  nclu&gt;0 ){ // construct ITSOut track</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :       AliHLTITSTrack tOut(*t);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :       if( FitOutward( &amp;tOut ) ){</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :         fITSOutTracks[fNITSOutTracks++] = *t;  </span>
<span class="lineNum">     450 </span>            :       }
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   timer.Stop();</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :   fRecoTime+=timer.RealTime();</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     457 </span>            : 
<span class="lineNum">     458 </span>            : 
<a name="459"><span class="lineNum">     459 </span>            : </a>
<span class="lineNum">     460 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     461 </span>            : Int_t AliITStrackerHLT::Clusters2Tracks(AliESDEvent *event) {
<span class="lineNum">     462 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     463 </span>            :   // This functions reconstructs ITS tracks
<span class="lineNum">     464 </span>            :   // The clusters must be already loaded !
<span class="lineNum">     465 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     466 </span>            :   
<span class="lineNum">     467 </span>            :   
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :   std::vector&lt;AliExternalTrackParam&gt; tracksTPC;</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :   std::vector&lt;int&gt; tracksTPCLab;</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :   tracksTPC.reserve(event-&gt;GetNumberOfTracks());</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :   for( int itr=0; itr&lt;event-&gt;GetNumberOfTracks(); itr++ ){</span>
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     AliESDtrack *esdTrack = event-&gt;GetTrack(itr);</span>
<span class="lineNum">     475 </span>            :     //esdTrack-&gt;myITS = esdTrack-&gt;myTPC;
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     if ((esdTrack-&gt;GetStatus()&amp;AliESDtrack::kTPCin)==0) continue;</span>
<span class="lineNum">     477 </span>            :     //if (esdTrack-&gt;GetStatus()&amp;AliESDtrack::kTPCout) continue;
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     if (esdTrack-&gt;GetStatus()&amp;AliESDtrack::kITSin) continue;</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :     if (esdTrack-&gt;GetKinkIndex(0)&gt;0) continue;   //kink daughter</span>
<span class="lineNum">     480 </span>            :     
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :     AliHLTITSTrack t(*esdTrack);</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :     t.SetTPCtrackId( itr );</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :     tracksTPC.push_back( t );</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :     tracksTPCLab.push_back(esdTrack-&gt;GetLabel());</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     486 </span>            :   //for( int iter=0; iter&lt;100; iter++){
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :   Reconstruct( &amp;(tracksTPC[0]), &amp;(tracksTPCLab[0]), tracksTPC.size() );</span>
<span class="lineNum">     488 </span>            :   //}
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :   for( int itr=0; itr&lt;fNTracks; itr++ ){</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :     AliHLTITSTrack &amp;t = fTracks[itr];    </span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :     UpdateESDtrack(event-&gt;GetTrack(t.TPCtrackId()), &amp;t, AliESDtrack::kITSin);          </span>
<span class="lineNum">     493 </span>            :     //event-&gt;GetTrack(t.TPCtrackId())-&gt;myITS = t;
<span class="lineNum">     494 </span>            :   }
<span class="lineNum">     495 </span>            :  
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span>            :   //int hz = ( int ) ( (fRecoTime+fLoadTime) &gt; 1.e-4 ? fNEvents / (fRecoTime+fLoadTime) : 0 );
<span class="lineNum">     498 </span>            :   //int hz1 = ( int ) ( fRecoTime &gt; 1.e-4 ? fNEvents / fRecoTime : 0 );
<span class="lineNum">     499 </span>            :   //int hz2 = ( int ) ( fLoadTime &gt; 1.e-4 ? fNEvents / fLoadTime : 0 );
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span>            :   //std::cout&lt;&lt;&quot;\n\nSG: ITS tracker time = &quot;&lt;&lt;hz2&lt;&lt;&quot; Hz load / &quot;&lt;&lt;hz1&lt;&lt;&quot; Hz reco =&quot;
<span class="lineNum">     502 </span>            :   //&lt;&lt;hz&lt;&lt;
<span class="lineNum">     503 </span>            :   //&quot; Hz (&quot;
<span class="lineNum">     504 </span>            :   //&lt;&lt;fLoadTime/fNEvents*1000&lt;&lt;&quot;+&quot;&lt;&lt;fRecoTime/fNEvents*1000.
<span class="lineNum">     505 </span>            :   //&lt;&lt;&quot; = &quot;&lt;&lt;(fLoadTime + fRecoTime)/fNEvents*1000. 
<span class="lineNum">     506 </span>            :   //&lt;&lt;&quot; ms/ev), &quot;&lt;&lt;fNEvents&lt;&lt;&quot; events processed\n\n &quot;&lt;&lt;std::endl;
<span class="lineNum">     507 </span>            :   return 0;
<span class="lineNum">     508 </span><span class="lineNoCov">          0 : }</span>
<a name="509"><span class="lineNum">     509 </span>            : </a>
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span>            : AliCluster *AliITStrackerHLT::GetCluster(Int_t index) const 
<span class="lineNum">     512 </span>            : {
<span class="lineNum">     513 </span>            :   //       Return pointer to a given cluster
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :   Int_t l=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :   Int_t c=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :   return fLayers[l].GetCluster(c);</span>
<span class="lineNum">     517 </span>            : }
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span>            : 
<a name="521"><span class="lineNum">     521 </span>            : </a>
<span class="lineNum">     522 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     523 </span>            : void AliITStrackerHLT::FollowProlongationTree(AliHLTITSTrack * track ) 
<span class="lineNum">     524 </span>            : {
<span class="lineNum">     525 </span>            :   // FollowProlongationTree
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :   for (Int_t ilayer=5; ilayer&gt;=0; ilayer--) {</span>
<span class="lineNum">     527 </span>            :    
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     AliHLTITSLayer &amp;layer=fLayers[ilayer];</span>
<span class="lineNum">     529 </span>            :   
<span class="lineNum">     530 </span>            :     // material between SSD and SDD, SDD and SPD
<span class="lineNum">     531 </span>            :     //if (ilayer==3 &amp;&amp; !CorrectForShieldMaterial(track,1)) continue;
<span class="lineNum">     532 </span>            :     //if (ilayer==1 &amp;&amp; !CorrectForShieldMaterial(track,0)) continue;
<span class="lineNum">     533 </span>            :     
<span class="lineNum">     534 </span>            :     int idet;
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span>            :     {            
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :       Double_t xloc, phi,z;</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :       if( !track-&gt;GetLocalXPhiZat( layer.GetR(), xloc, phi, z ) ) return;</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :       idet = layer.FindDetectorIndex(phi,z);</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span>            :     // track outside layer acceptance in z
<span class="lineNum">     543 </span>            :    
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :     if( idet&lt;0 ) continue;</span>
<span class="lineNum">     545 </span>            :     
<span class="lineNum">     546 </span>            :     // propagate to the intersection with the detector plane     
<span class="lineNum">     547 </span>            :     {
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :       const AliHLTITSDetector &amp;det=layer.GetDetector( idet );</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :       if (!TransportToPhiX( track, det.GetPhi(), det.GetR() ) ) return;</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :       CorrectForLayerMaterial(track,ilayer);</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span>            :     // DEFINITION OF SEARCH ROAD AND CLUSTERS SELECTION
<span class="lineNum">     554 </span>            :     
<span class="lineNum">     555 </span>            :     // road in global (rphi,z) [i.e. in tracking ref. system]
<span class="lineNum">     556 </span>            :     
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :     Double_t zmin,zmax,ymin,ymax;</span>
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :     if (!ComputeRoad(track,ilayer,idet,zmin,zmax,ymin,ymax)) continue;</span>
<span class="lineNum">     560 </span>            :   
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :     layer.SelectClusters(zmin,zmax,ymin,ymax);     </span>
<span class="lineNum">     562 </span>            :     
<span class="lineNum">     563 </span>            :     // Define criteria for track-cluster association
<span class="lineNum">     564 </span>            :     
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :     Double_t msz = track-&gt;GetSigmaZ2() + </span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :       fRecoParam-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :       fRecoParam-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :       fRecoParam-&gt;GetSigmaZ2(ilayer);</span>
<span class="lineNum">     569 </span>            :     
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :     Double_t msy = track-&gt;GetSigmaY2() + </span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :       fRecoParam-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :       fRecoParam-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :       fRecoParam-&gt;GetSigmaY2(ilayer);</span>
<span class="lineNum">     574 </span>            :     
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :     msz *= fRecoParam-&gt;GetNSigma2RoadZNonC();</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :     msy *= fRecoParam-&gt;GetNSigma2RoadYNonC(); </span>
<span class="lineNum">     577 </span>            :     
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :     msz = 1./msz; // 1/RoadZ^2</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :     msy = 1./msy; // 1/RoadY^2    </span>
<span class="lineNum">     580 </span>            :     
<span class="lineNum">     581 </span>            :     const AliITSRecPoint *cl=0; 
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :     Int_t clidx=-1;     </span>
<span class="lineNum">     583 </span>            :     
<span class="lineNum">     584 </span>            :     // loop over clusters in the road     
<span class="lineNum">     585 </span>            :     
<span class="lineNum">     586 </span>            :     const AliITSRecPoint *bestCluster=0; 
<span class="lineNum">     587 </span>            :     double bestChi2 = 1.e10;
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :     AliHLTITSTrack bestTrack( *track );</span>
<span class="lineNum">     589 </span>            :     int bestIdx = -1;
<span class="lineNum">     590 </span>            :      
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :     while( (cl=layer.GetNextCluster(clidx)) ){</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :       Int_t idetc=cl-&gt;GetDetectorIndex();</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :       if ( idet !=idetc ) { // new cluster's detector</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :         const AliHLTITSDetector &amp;detc=layer.GetDetector(idetc);</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         if (!TransportToPhiX( track, detc.GetPhi(),detc.GetR()) ) continue;</span>
<span class="lineNum">     596 </span>            :         idet = idetc;
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :       }  </span>
<span class="lineNum">     598 </span>            :       //double y,z;
<span class="lineNum">     599 </span>            :       //if (! track-&gt;GetLocalYZat( layer.GetDetector(idetc).GetR() + cl-&gt;GetX(),y,z ) ) continue;
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :       double dz = track-&gt;GetZ() - cl-&gt;GetZ();</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :       double dy = track-&gt;GetY() - cl-&gt;GetY();</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :       double chi2 = dz*dz*msz + dy*dy*msy ;       </span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :       if ( chi2 &lt; bestChi2 ){</span>
<span class="lineNum">     604 </span>            :         bestChi2 = chi2;
<span class="lineNum">     605 </span>            :         bestCluster = cl;
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :         bestTrack = *track;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :         bestIdx = clidx;</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     609 </span>            :       }
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     611 </span>            :     
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     if( !bestCluster || bestChi2 &gt;2*10. ) continue;</span>
<span class="lineNum">     613 </span>            :     
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :     if (!TransportToX( &amp;bestTrack, layer.GetDetector(bestCluster-&gt;GetDetectorIndex()).GetR() + bestCluster-&gt;GetX() ) ) continue;</span>
<span class="lineNum">     615 </span>            :     
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :     Double_t par[2]={ bestCluster-&gt;GetY(), bestCluster-&gt;GetZ()};</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :     Double_t cov[3]={ bestCluster-&gt;GetSigmaY2(), 0., bestCluster-&gt;GetSigmaZ2()};</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     if( !bestTrack.AliExternalTrackParam::Update(par,cov) ) continue;</span>
<span class="lineNum">     619 </span>            :     
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :     *track = bestTrack;</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :     track-&gt;SetClusterIndex(track-&gt;GetNumberOfClusters(), (ilayer&lt;&lt;28)+bestIdx);</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :     track-&gt;SetNumberOfClusters(track-&gt;GetNumberOfClusters()+1);  </span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     625 </span>            : 
<a name="626"><span class="lineNum">     626 </span>            : </a>
<span class="lineNum">     627 </span>            : 
<span class="lineNum">     628 </span>            : Int_t AliITStrackerHLT::FitOutward(AliHLTITSTrack * track ) 
<span class="lineNum">     629 </span>            : {
<span class="lineNum">     630 </span>            :   // FitOutward
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :   track-&gt;ResetCovariance(100);</span>
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :   for (Int_t iTrCl=track-&gt;GetNumberOfClusters()-1; iTrCl&gt;=0; iTrCl--) {</span>
<span class="lineNum">     634 </span>            :     
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :     Int_t index = track-&gt;GetClusterIndex(iTrCl);</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :     Int_t ilayer=(index &amp; 0xf0000000) &gt;&gt; 28;</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :     Int_t ic=(index &amp; 0x0fffffff) &gt;&gt; 00;</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :     const AliHLTITSLayer &amp;layer=fLayers[ilayer];</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :     AliITSRecPoint *cl = layer.GetCluster(ic); </span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :     int idet = cl-&gt;GetDetectorIndex();</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :     const AliHLTITSDetector &amp;det=layer.GetDetector( idet );</span>
<span class="lineNum">     642 </span>            :  
<span class="lineNum">     643 </span>            :     // material between SSD and SDD, SDD and SPD
<span class="lineNum">     644 </span>            :     //if (ilayer==4 &amp;&amp; !CorrectForShieldMaterial(track,1)) continue;
<span class="lineNum">     645 </span>            :     //if (ilayer==2 &amp;&amp; !CorrectForShieldMaterial(track,0)) continue;
<span class="lineNum">     646 </span>            :     
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span>            :     // propagate to the intersection with the detector plane     
<span class="lineNum">     649 </span>            :     {
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :       if (!TransportToPhiX( track, det.GetPhi(), det.GetR()+ cl-&gt;GetX() ) ) return 0;</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :       CorrectForLayerMaterial(track,ilayer);</span>
<span class="lineNum">     652 </span>            :     }
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :     Double_t par[2]={ cl-&gt;GetY(), cl-&gt;GetZ()};</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :     Double_t cov[3]={ cl-&gt;GetSigmaY2(), 0., cl-&gt;GetSigmaZ2()};</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :     if( !track-&gt;AliExternalTrackParam::Update(par,cov) ) return 0;    </span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :   return 1;</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     660 </span>            : 
<a name="661"><span class="lineNum">     661 </span>            : </a>
<span class="lineNum">     662 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     663 </span>            : AliHLTITSLayer &amp; AliITStrackerHLT::GetLayer(Int_t layer) const
<span class="lineNum">     664 </span>            : {
<span class="lineNum">     665 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     666 </span>            :   //
<span class="lineNum">     667 </span>            :   //
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :   return fLayers[layer];</span>
<span class="lineNum">     669 </span>            : }
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span>            : 
<a name="672"><span class="lineNum">     672 </span>            : </a>
<span class="lineNum">     673 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     674 </span>            : void AliITStrackerHLT::CookLabel(AliHLTITSTrack *track,Float_t wrong) const 
<span class="lineNum">     675 </span>            : {
<span class="lineNum">     676 </span>            :   // get MC label for the track
<span class="lineNum">     677 </span>            : 
<span class="lineNum">     678 </span>            :   Int_t mcLabel = -1;
<span class="lineNum">     679 </span>            :   
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :   vector&lt;int&gt; labels;</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :   Int_t nClusters = track-&gt;GetNumberOfClusters();</span>
<span class="lineNum">     682 </span>            :   Int_t nClustersEff = 0;
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;nClusters; i++){</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :     Int_t cindex = track-&gt;GetClusterIndex(i);</span>
<span class="lineNum">     685 </span>            :     //Int_t l=(cindex &amp; 0xf0000000) &gt;&gt; 28;
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :     AliITSRecPoint *cl = (AliITSRecPoint*)GetCluster(cindex);    </span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :     if ( cl-&gt;GetLabel(0) &gt;= 0 ){ labels.push_back(cl-&gt;GetLabel(0)) ; nClustersEff++; }</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :     if ( cl-&gt;GetLabel(1) &gt;= 0 ) labels.push_back(cl-&gt;GetLabel(1)) ;</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :     if ( cl-&gt;GetLabel(2) &gt;= 0 ) labels.push_back(cl-&gt;GetLabel(2)) ;</span>
<span class="lineNum">     690 </span>            :   }
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :   std::sort( labels.begin(), labels.end() );</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :   labels.push_back( -1 ); // put -1 to the end    </span>
<span class="lineNum">     694 </span>            :   int labelMax = -1, labelCur = -1, nLabelsMax = 0, nLabelsCurr = 0;
<span class="lineNum">     695 </span>            : 
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :   for ( unsigned int iLab = 0; iLab &lt; labels.size(); iLab++ ) {</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :     if ( labels[iLab] != labelCur ) {         </span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :       if ( labelCur &gt;= 0 &amp;&amp; nLabelsMax&lt; nLabelsCurr ) {</span>
<span class="lineNum">     699 </span>            :         nLabelsMax = nLabelsCurr;
<span class="lineNum">     700 </span>            :         labelMax = labelCur;
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :       labelCur = labels[iLab];</span>
<span class="lineNum">     703 </span>            :       nLabelsCurr = 0;
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :     nLabelsCurr++;</span>
<span class="lineNum">     706 </span>            :   }
<span class="lineNum">     707 </span>            : 
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :   if( labelMax&gt;=0 &amp;&amp; nLabelsMax &lt; wrong * nClustersEff ) labelMax = -labelMax;</span>
<span class="lineNum">     709 </span>            :   
<span class="lineNum">     710 </span>            :   mcLabel = labelMax;
<span class="lineNum">     711 </span>            :                 
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :   track-&gt;SetLabel( mcLabel );</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span>            : 
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span>            : 
<a name="722"><span class="lineNum">     722 </span>            : </a>
<span class="lineNum">     723 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     724 </span>            : void AliITStrackerHLT::UpdateESDtrack(AliESDtrack *tESD, AliHLTITSTrack* track, ULong_t flags) const
<span class="lineNum">     725 </span>            : {
<span class="lineNum">     726 </span>            :   //
<span class="lineNum">     727 </span>            :   // Update ESD track
<span class="lineNum">     728 </span>            :   //
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :   tESD-&gt;UpdateTrackParams(track,flags);</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :   AliHLTITSTrack * oldtrack = (AliHLTITSTrack*)(tESD-&gt;GetITStrack());</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :   if (oldtrack) delete oldtrack; </span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :   tESD-&gt;SetITStrack(new AliHLTITSTrack(*track));</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     734 </span>            : 
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span>            : 
<a name="737"><span class="lineNum">     737 </span>            : </a>
<span class="lineNum">     738 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     739 </span>            : void AliITStrackerHLT::BuildMaterialLUT(TString material) {
<span class="lineNum">     740 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     741 </span>            :   // Fill a look-up table with mean material
<span class="lineNum">     742 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span>            :   Int_t n=1000;
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :   Double_t mparam[7];</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :   Double_t point1[3],point2[3];</span>
<span class="lineNum">     747 </span>            :   Double_t phi,cosphi,sinphi,z;
<span class="lineNum">     748 </span>            :   // 0-5 layers, 6 pipe, 7-8 shields 
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :   Double_t rmin[9]={ 3.5, 5.5,13.0,22.0,35.0,41.0, 2.0, 8.0,25.0};</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :   Double_t rmax[9]={ 5.5, 8.0,17.0,26.0,41.0,47.0, 3.0,10.5,30.0};</span>
<span class="lineNum">     751 </span>            : 
<span class="lineNum">     752 </span>            :   Int_t ifirst=0,ilast=0;  
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :   if(material.Contains(&quot;Pipe&quot;)) {</span>
<span class="lineNum">     754 </span>            :     ifirst=6; ilast=6;
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :   } else if(material.Contains(&quot;Shields&quot;)) {</span>
<span class="lineNum">     756 </span>            :     ifirst=7; ilast=8;
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :   } else if(material.Contains(&quot;Layers&quot;)) {</span>
<span class="lineNum">     758 </span>            :     ifirst=0; ilast=5;
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     Error(&quot;BuildMaterialLUT&quot;,&quot;Wrong layer name\n&quot;);</span>
<span class="lineNum">     761 </span>            :   }
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :   for(Int_t imat=ifirst; imat&lt;=ilast; imat++) {</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :     Double_t param[5]={0.,0.,0.,0.,0.};</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :     for (Int_t i=0; i&lt;n; i++) {</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :       phi = 2.*TMath::Pi()*gRandom-&gt;Rndm();</span>
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :       cosphi = TMath::Cos(phi); sinphi = TMath::Sin(phi); </span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :       z = 14.*(-1.+2.*gRandom-&gt;Rndm()); // SPD barrel</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :       point1[0] = rmin[imat]*cosphi;</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :       point1[1] = rmin[imat]*sinphi;</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :       point1[2] = z;</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :       point2[0] = rmax[imat]*cosphi;</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :       point2[1] = rmax[imat]*sinphi;</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :       point2[2] = z;</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :       AliTracker::MeanMaterialBudget(point1,point2,mparam);</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :       for(Int_t j=0;j&lt;5;j++) param[j]+=mparam[j];</span>
<span class="lineNum">     777 </span>            :     }
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :     for(Int_t j=0;j&lt;5;j++) param[j]/=(Float_t)n;</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :     if(imat&lt;=5) {</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :       fxOverX0Layer[imat] = param[1];</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :       fxTimesRhoLayer[imat] = param[0]*param[4];</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :     } else if(imat==6) {</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :       fxOverX0Pipe = param[1];</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :       fxTimesRhoPipe = param[0]*param[4];</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :     } else if(imat==7) {</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :       fxOverX0Shield[0] = param[1];</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :       fxTimesRhoShield[0] = param[0]*param[4];</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :     } else if(imat==8) {</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :       fxOverX0Shield[1] = param[1];</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :       fxTimesRhoShield[1] = param[0]*param[4];</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     793 </span>            :   /*
<span class="lineNum">     794 </span>            :   printf(&quot;%s\n&quot;,material.Data());
<span class="lineNum">     795 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Pipe,fxTimesRhoPipe);
<span class="lineNum">     796 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Shield[0],fxTimesRhoShield[0]);
<span class="lineNum">     797 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Shield[1],fxTimesRhoShield[1]);
<span class="lineNum">     798 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[0],fxTimesRhoLayer[0]);
<span class="lineNum">     799 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[1],fxTimesRhoLayer[1]);
<span class="lineNum">     800 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[2],fxTimesRhoLayer[2]);
<span class="lineNum">     801 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[3],fxTimesRhoLayer[3]);
<span class="lineNum">     802 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[4],fxTimesRhoLayer[4]);
<span class="lineNum">     803 </span>            :   printf(&quot;%f  %f\n&quot;,fxOverX0Layer[5],fxTimesRhoLayer[5]);
<span class="lineNum">     804 </span>            :   */
<span class="lineNum">     805 </span>            :   return;
<span class="lineNum">     806 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span>            : 
<span class="lineNum">     809 </span>            : 
<a name="810"><span class="lineNum">     810 </span>            : </a>
<span class="lineNum">     811 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     812 </span>            : Int_t AliITStrackerHLT::CorrectForTPCtoITSDeadZoneMaterial(AliHLTITSTrack *t) {
<span class="lineNum">     813 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     814 </span>            :   // Correction for the material between the TPC and the ITS
<span class="lineNum">     815 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :   if (t-&gt;GetX() &gt; AliITSRecoParam::Getriw()) {   // inward direction </span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getriw(),1)) return 0;// TPC inner wall</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getrcd(),1)) return 0;// TPC central drum</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getrs(),1))  return 0;// ITS screen</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :   } else if (t-&gt;GetX() &lt; AliITSRecoParam::Getrs()) {  // outward direction</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getrs(),1))        return 0;// ITS screen</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getrcd(),1))       return 0;// TPC central drum</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :       if (!t-&gt;PropagateToTGeo(AliITSRecoParam::Getriw()+0.001,1)) return 0;// TPC inner wall</span>
<span class="lineNum">     824 </span>            :   } else {
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :     printf(&quot;CorrectForTPCtoITSDeadZoneMaterial: Track is already in the dead zone !\n&quot;);</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     827 </span>            :   }
<span class="lineNum">     828 </span>            :   
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :   return 1;</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     831 </span>            : 
<a name="832"><span class="lineNum">     832 </span>            : </a>
<span class="lineNum">     833 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     834 </span>            : Int_t AliITStrackerHLT::CorrectForPipeMaterial(AliHLTITSTrack *t,
<span class="lineNum">     835 </span>            :                                                bool InwardDirection) {
<span class="lineNum">     836 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">     837 </span>            :   // Propagate beyond beam pipe and correct for material
<span class="lineNum">     838 </span>            :   // (material budget in different ways according to fUseTGeo value)
<span class="lineNum">     839 </span>            :   // Add time if going outward (PropagateTo or PropagateToTGeo)
<span class="lineNum">     840 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">     841 </span>            : 
<span class="lineNum">     842 </span>            :   // Define budget mode:
<span class="lineNum">     843 </span>            :   // 0: material from AliITSRecoParam (hard coded)
<span class="lineNum">     844 </span>            :   // 1: material from TGeo in one step (on the fly)
<span class="lineNum">     845 </span>            :   // 2: material from lut
<span class="lineNum">     846 </span>            :   // 3: material from TGeo in one step (same for all hypotheses)
<span class="lineNum">     847 </span>            :   Int_t mode;
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :   switch(fUseTGeo) {</span>
<span class="lineNum">     849 </span>            :   case 0:
<span class="lineNum">     850 </span>            :     mode=0; 
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">     852 </span>            :   case 1:
<span class="lineNum">     853 </span>            :     mode=1;
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">     855 </span>            :   case 2:
<span class="lineNum">     856 </span>            :     mode=2;
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     858 </span>            :   case 3:
<span class="lineNum">     859 </span>            :     mode=3; 
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     861 </span>            :   case 4:
<span class="lineNum">     862 </span>            :     mode=3;
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     864 </span>            :   default:
<span class="lineNum">     865 </span>            :     mode=0;
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     867 </span>            :   }
<span class="lineNum">     868 </span>            :   
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :   Float_t  dir = (InwardDirection ? 1. : -1.);</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :   Double_t rToGo= ( InwardDirection ? AliITSRecoParam::GetrInsidePipe() : AliITSRecoParam::GetrOutsidePipe());</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :   Double_t xToGo, phi,z;</span>
<span class="lineNum">     872 </span>            : 
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :   if (!t-&gt;GetLocalXPhiZat(rToGo,xToGo,phi,z)) return 0;</span>
<span class="lineNum">     874 </span>            : 
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :   Double_t xOverX0,x0,lengthTimesMeanDensity;</span>
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :   switch(mode) {</span>
<span class="lineNum">     878 </span>            :   case 0:
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :     xOverX0 = AliITSRecoParam::GetdPipe();</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :     x0 = AliITSRecoParam::GetX0Be();</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity = xOverX0*x0;</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">     884 </span>            :     break;
<span class="lineNum">     885 </span>            :   case 1:
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateToTGeo(xToGo,1)) return 0;</span>
<span class="lineNum">     887 </span>            :     break;
<span class="lineNum">     888 </span>            :   case 2:
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :     if(fxOverX0Pipe&lt;0) BuildMaterialLUT(&quot;Pipe&quot;);  </span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :     xOverX0 = fxOverX0Pipe;</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity = fxTimesRhoPipe;</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">     894 </span>            :     break;
<span class="lineNum">     895 </span>            :   case 3:
<span class="lineNum">     896 </span>            :     double xOverX0PipeTrks, xTimesRhoPipeTrks;
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateToTGeo(xToGo,1,xOverX0,lengthTimesMeanDensity)) return 0;</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :     Double_t angle=TMath::Sqrt((1.+t-&gt;GetTgl()*t-&gt;GetTgl())/</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :                                ((1.-t-&gt;GetSnp())*(1.+t-&gt;GetSnp())));</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :     xOverX0PipeTrks = TMath::Abs(xOverX0)/angle;</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :     xTimesRhoPipeTrks = TMath::Abs(lengthTimesMeanDensity)/angle;</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :     xOverX0 = xOverX0PipeTrks;</span>
<span class="lineNum">     903 </span>            :     lengthTimesMeanDensity = xTimesRhoPipeTrks;
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     907 </span>            :   }
<span class="lineNum">     908 </span>            :   
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :   return 1;</span>
<a name="910"><span class="lineNum">     910 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     911 </span>            : //------------------------------------------------------------------------
<span class="lineNum">     912 </span>            : Int_t AliITStrackerHLT::CorrectForShieldMaterial(AliHLTITSTrack *t,
<span class="lineNum">     913 </span>            :                                                  Int_t    shieldindex,
<span class="lineNum">     914 </span>            :                                                 bool InwardDirection) {
<span class="lineNum">     915 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">     916 </span>            :   // Propagate beyond SPD or SDD shield and correct for material
<span class="lineNum">     917 </span>            :   // (material budget in different ways according to fUseTGeo value)
<span class="lineNum">     918 </span>            :   // Add time if going outward (PropagateTo or PropagateToTGeo)
<span class="lineNum">     919 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">     920 </span>            : 
<span class="lineNum">     921 </span>            :   // Define budget mode:
<span class="lineNum">     922 </span>            :   // 0: material from AliITSRecoParam (hard coded)
<span class="lineNum">     923 </span>            :   // 1: material from TGeo in steps of X cm (on the fly)
<span class="lineNum">     924 </span>            :   //    X = AliITSRecoParam::GetStepSizeTGeo()
<span class="lineNum">     925 </span>            :   // 2: material from lut
<span class="lineNum">     926 </span>            :   // 3: material from TGeo in one step (same for all hypotheses)
<span class="lineNum">     927 </span>            :   Int_t mode;
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :   switch(fUseTGeo) {</span>
<span class="lineNum">     929 </span>            :   case 0:
<span class="lineNum">     930 </span>            :     mode=0; 
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">     932 </span>            :   case 1:
<span class="lineNum">     933 </span>            :     mode=1;
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :     break;    </span>
<span class="lineNum">     935 </span>            :   case 2:
<span class="lineNum">     936 </span>            :     mode=2;
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     938 </span>            :   case 3:
<span class="lineNum">     939 </span>            :     mode=3;
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     941 </span>            :   case 4:
<span class="lineNum">     942 </span>            :     mode=3;
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     944 </span>            :   default:
<span class="lineNum">     945 </span>            :     mode=0;
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     947 </span>            :   }
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span>            : 
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :   Float_t  dir = (InwardDirection ? 1. : -1.);</span>
<span class="lineNum">     951 </span>            :   Double_t rToGo;
<span class="lineNum">     952 </span>            : 
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :   if (shieldindex==1 ) { // SDDouter</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :     rToGo=(InwardDirection ? AliITSRecoParam::GetrInsideShield(1) : AliITSRecoParam::GetrOutsideShield(1));</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :   } else if (shieldindex==0 ) {        // SPDouter</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :     rToGo=(InwardDirection ? AliITSRecoParam::GetrInsideShield(0) : AliITSRecoParam::GetrOutsideShield(0)); </span>
<span class="lineNum">     957 </span>            :   } else {
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :     Error(&quot;CorrectForShieldMaterial&quot;,&quot; Wrong shield name\n&quot;);</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     960 </span>            :   }
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :   Double_t xToGo, phi,z;</span>
<span class="lineNum">     962 </span>            : 
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :   if (!t-&gt;GetLocalXPhiZat(rToGo,xToGo,phi,z)) return 0;</span>
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :   Double_t xOverX0,x0,lengthTimesMeanDensity;</span>
<span class="lineNum">     966 </span>            :   Int_t nsteps=1;
<span class="lineNum">     967 </span>            : 
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :   switch(mode) {</span>
<span class="lineNum">     969 </span>            :   case 0:
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :     xOverX0 = AliITSRecoParam::Getdshield(shieldindex);</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :     x0 = AliITSRecoParam::GetX0shield(shieldindex);</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity = xOverX0*x0;</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">     975 </span>            :     break;
<span class="lineNum">     976 </span>            :   case 1:
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :     nsteps= (Int_t)(TMath::Abs(t-&gt;GetX()-xToGo)/fRecoParam-&gt;GetStepSizeTGeo())+1;</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateToTGeo(xToGo,nsteps)) return 0; // cross the material and apply correction</span>
<span class="lineNum">     979 </span>            :     break;
<span class="lineNum">     980 </span>            :   case 2:
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :     if(fxOverX0Shield[shieldindex]&lt;0) BuildMaterialLUT(&quot;Shields&quot;);  </span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :     xOverX0 = fxOverX0Shield[shieldindex];</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity = fxTimesRhoShield[shieldindex];</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">     986 </span>            :     break;
<span class="lineNum">     987 </span>            :   case 3:    
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateToTGeo(xToGo,1,xOverX0,lengthTimesMeanDensity)) return 0;</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :     Double_t angle=TMath::Sqrt((1.+t-&gt;GetTgl()*t-&gt;GetTgl())/</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                                ((1.-t-&gt;GetSnp())*(1.+t-&gt;GetSnp())));</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :     double xOverX0ShieldTrks = TMath::Abs(xOverX0)/angle;</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :     double xTimesRhoShieldTrks = TMath::Abs(lengthTimesMeanDensity)/angle;</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :     xOverX0 = xOverX0ShieldTrks;</span>
<span class="lineNum">     994 </span>            :     lengthTimesMeanDensity = xTimesRhoShieldTrks;
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :     lengthTimesMeanDensity *= dir;</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :     if (!t-&gt;PropagateTo(xToGo,xOverX0,lengthTimesMeanDensity/xOverX0)) return 0;</span>
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     998 </span>            :   }
<span class="lineNum">     999 </span>            : 
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :   return 1;</span>
<a name="1001"><span class="lineNum">    1001 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1002 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1003 </span>            : Int_t AliITStrackerHLT::CorrectForLayerMaterial(AliHLTITSTrack *t,
<span class="lineNum">    1004 </span>            :                                                Int_t layerindex,
<span class="lineNum">    1005 </span>            :                                                bool InwardDirection ){
<span class="lineNum">    1006 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    1007 </span>            :   // Propagate beyond layer and correct for material
<span class="lineNum">    1008 </span>            :   // (material budget in different ways according to fUseTGeo value)
<span class="lineNum">    1009 </span>            :   // Add time if going outward (PropagateTo or PropagateToTGeo)
<span class="lineNum">    1010 </span>            :   //-------------------------------------------------------------------
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span>            :   /*
<span class="lineNum">    1013 </span>            :     Double_t r=fLayers[layerindex].GetR();
<span class="lineNum">    1014 </span>            :     Double_t deltar=(layerindex&lt;2 ? 0.10*r : 0.05*r);
<span class="lineNum">    1015 </span>            :     Double_t rToGo=TMath::Sqrt(t-&gt;GetX()*t-&gt;GetX()+t-&gt;GetY()*t-&gt;GetY());
<span class="lineNum">    1016 </span>            :     rToGo+= InwardDirection ?-deltar :deltar;
<span class="lineNum">    1017 </span>            :     Double_t xToGo;
<span class="lineNum">    1018 </span>            :     if (!t-&gt;GetLocalXat(rToGo,xToGo)) return 0;  
<span class="lineNum">    1019 </span>            :   */
<span class="lineNum">    1020 </span>            :   
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :   if(fxOverX0Layer[layerindex]&lt;0) BuildMaterialLUT(&quot;Layers&quot;);</span>
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :   Double_t lengthTimesMeanDensity = fxTimesRhoLayer[layerindex];</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :   if( !InwardDirection ) lengthTimesMeanDensity = -lengthTimesMeanDensity;</span>
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :   return t-&gt;CorrectForMeanMaterial(fxOverX0Layer[layerindex],lengthTimesMeanDensity,kTRUE);</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1028 </span>            : 
<a name="1029"><span class="lineNum">    1029 </span>            : </a>
<span class="lineNum">    1030 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1031 </span>            : Bool_t AliITStrackerHLT::LocalModuleCoord(Int_t ilayer,Int_t idet,
<span class="lineNum">    1032 </span>            :                                        const AliHLTITSTrack *track,
<span class="lineNum">    1033 </span>            :                                        Float_t &amp;xloc,Float_t &amp;zloc) const {
<span class="lineNum">    1034 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1035 </span>            :   // Gives position of track in local module ref. frame
<span class="lineNum">    1036 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :   xloc=0.; </span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :   zloc=0.;</span>
<span class="lineNum">    1040 </span>            : 
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :   if(idet&lt;0) return kFALSE;</span>
<span class="lineNum">    1042 </span>            : 
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :   Int_t ndet=AliITSgeomTGeo::GetNDetectors(ilayer+1); // layers from 1 to 6 </span>
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :   Int_t lad = Int_t(idet/ndet) + 1;</span>
<span class="lineNum">    1046 </span>            : 
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :   Int_t det = idet - (lad-1)*ndet + 1;</span>
<span class="lineNum">    1048 </span>            : 
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :   Double_t xyzGlob[3],xyzLoc[3];</span>
<span class="lineNum">    1050 </span>            : 
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :   AliHLTITSDetector &amp;detector = fLayers[ilayer].GetDetector(idet);</span>
<span class="lineNum">    1052 </span>            :   // take into account the misalignment: xyz at real detector plane
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :   if(!track-&gt;GetXYZAt(detector.GetRmisal(),GetBz(),xyzGlob)) return kFALSE;</span>
<span class="lineNum">    1054 </span>            : 
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :   if(!AliITSgeomTGeo::GlobalToLocal(ilayer+1,lad,det,xyzGlob,xyzLoc)) return kFALSE;</span>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :   xloc = (Float_t)xyzLoc[0];</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :   zloc = (Float_t)xyzLoc[2];</span>
<span class="lineNum">    1059 </span>            : 
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 : }</span>
<a name="1062"><span class="lineNum">    1062 </span>            : </a>
<span class="lineNum">    1063 </span>            : //------------------------------------------------------------------------
<span class="lineNum">    1064 </span>            : Bool_t AliITStrackerHLT::ComputeRoad(AliHLTITSTrack* track,Int_t ilayer,Int_t idet,Double_t &amp;zmin,Double_t &amp;zmax,Double_t &amp;ymin,Double_t &amp;ymax) const {
<span class="lineNum">    1065 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1066 </span>            :   // This function computes the rectangular road for this track
<span class="lineNum">    1067 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    1068 </span>            : 
<span class="lineNum">    1069 </span>            : 
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :   AliHLTITSDetector &amp;det = fLayers[ilayer].GetDetector(idet);</span>
<span class="lineNum">    1071 </span>            :   // take into account the misalignment: propagate track to misaligned detector plane
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :   double y,z,snp,cov[3];</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :   if( !track-&gt;GetYZAtPhiX( det.GetPhi(),det.GetRmisal(), y, z, snp, cov))return 0;</span>
<span class="lineNum">    1075 </span>            : 
<span class="lineNum">    1076 </span>            : 
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :   Double_t dz=fRecoParam-&gt;GetNSigmaRoadZ()*</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :                     TMath::Sqrt(cov[2] + </span>
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :                                 fRecoParam-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :                                 fRecoParam-&gt;GetNSigmaZLayerForRoadZ()*</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :                                 fRecoParam-&gt;GetSigmaZ2(ilayer));</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :   Double_t dy=fRecoParam-&gt;GetNSigmaRoadY()*</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :                     TMath::Sqrt(cov[0] + </span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :                                 fRecoParam-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :                                 fRecoParam-&gt;GetNSigmaYLayerForRoadY()*</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :                                 fRecoParam-&gt;GetSigmaY2(ilayer));</span>
<span class="lineNum">    1087 </span>            :       
<span class="lineNum">    1088 </span>            :   // track at boundary between detectors, enlarge road
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :   Double_t boundaryWidth=AliITSRecoParam::GetBoundaryWidth();</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :   if ( (y-dy &lt; det.GetYmin()+boundaryWidth) || </span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :        (y+dy &gt; det.GetYmax()-boundaryWidth) || </span>
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :        (z-dz &lt; det.GetZmin()+boundaryWidth) ||</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :        (z+dz &gt; det.GetZmax()-boundaryWidth) ) {</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :     Float_t tgl = TMath::Abs(track-&gt;GetTgl());</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :     if (tgl &gt; 1.) tgl=1.;</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :     Double_t deltaXNeighbDets=AliITSRecoParam::GetDeltaXNeighbDets();</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :     dz = TMath::Sqrt(dz*dz+deltaXNeighbDets*deltaXNeighbDets*tgl*tgl);</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :     if (snp &gt; fRecoParam-&gt;GetMaxSnp()) return kFALSE;</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :     dy = TMath::Sqrt(dy*dy+deltaXNeighbDets*deltaXNeighbDets*snp*snp);</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :   } // boundary</span>
<span class="lineNum">    1101 </span>            :   
<span class="lineNum">    1102 </span>            :   // add to the road a term (up to 2-3 mm) to deal with misalignments
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :   dy = TMath::Sqrt(dy*dy + fRecoParam-&gt;GetRoadMisal()*fRecoParam-&gt;GetRoadMisal());</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :   dz = TMath::Sqrt(dz*dz + fRecoParam-&gt;GetRoadMisal()*fRecoParam-&gt;GetRoadMisal());</span>
<span class="lineNum">    1105 </span>            : 
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :   Double_t r = fLayers[ilayer].GetR();</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :   zmin = z - dz; </span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :   zmax = z + dz;</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :   ymin = y + r*det.GetPhi() - dy;</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :   ymax = y + r*det.GetPhi() + dy;</span>
<span class="lineNum">    1111 </span>            : 
<span class="lineNum">    1112 </span>            :   return kTRUE;
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1114 </span>            : 
<a name="1115"><span class="lineNum">    1115 </span>            : </a>
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span>            : Int_t AliITStrackerHLT::PropagateBack(AliESDEvent * /*event*/) 
<span class="lineNum">    1118 </span>            : {
<span class="lineNum">    1119 </span>            :   // dummy
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="1121"><span class="lineNum">    1121 </span>            : }</a>
<span class="lineNum">    1122 </span>            : 
<span class="lineNum">    1123 </span>            : Int_t AliITStrackerHLT::RefitInward(AliESDEvent * /*event*/ ) 
<span class="lineNum">    1124 </span>            : {
<span class="lineNum">    1125 </span>            :   // dummy
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">    1127 </span>            : }
<a name="1128"><span class="lineNum">    1128 </span>            : </a>
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span>            : Bool_t AliITStrackerHLT::GetTrackPoint(Int_t /*index*/, AliTrackPoint&amp; /*p*/) const 
<span class="lineNum">    1131 </span>            : {
<span class="lineNum">    1132 </span>            :   // dummy
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="1134"><span class="lineNum">    1134 </span>            : }</a>
<span class="lineNum">    1135 </span>            : 
<span class="lineNum">    1136 </span>            : Bool_t AliITStrackerHLT::GetTrackPointTrackingError(Int_t /*index*/, 
<span class="lineNum">    1137 </span>            :                                                     AliTrackPoint&amp; /*p*/, const AliESDtrack */*t*/) 
<span class="lineNum">    1138 </span>            : {
<span class="lineNum">    1139 </span>            :   // dummy
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">    1141 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
