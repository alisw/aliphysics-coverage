<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - HLT/BASE/AliHLTDataBuffer.h</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">HLT/BASE</a> - AliHLTDataBuffer.h<span style="font-size: 80%;"> (source / <a href="AliHLTDataBuffer.h.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">59</td>
            <td class="headerCovTableEntryLo">1.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">45</td>
            <td class="headerCovTableEntryLo">2.2 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : //-*- Mode: C++ -*-</a>
<span class="lineNum">       2 </span>            : // $Id$
<span class="lineNum">       3 </span>            : 
<span class="lineNum">       4 </span>            : #ifndef ALIHLTDATABUFFER_H
<span class="lineNum">       5 </span>            : #define ALIHLTDATABUFFER_H
<span class="lineNum">       6 </span>            : //* This file is property of and copyright by the                          * 
<span class="lineNum">       7 </span>            : //* ALICE Experiment at CERN, All rights reserved.                         *
<span class="lineNum">       8 </span>            : //* See cxx source for full Copyright notice                               *
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            : //  @file   AliHLTDataBuffer.h
<span class="lineNum">      11 </span>            : //  @author Matthias Richter
<span class="lineNum">      12 </span>            : //  @date   
<span class="lineNum">      13 </span>            : //  @brief  Handling of Data Buffers for HLT components.
<span class="lineNum">      14 </span>            : //  @note   The class is used in Offline (AliRoot) context
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : #include &lt;vector&gt;
<span class="lineNum">      17 </span>            : #include &quot;TObject.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;AliHLTLogging.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;AliHLTDataTypes.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;AliHLTComponent.h&quot;
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : using std::vector;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : class AliHLTConsumerDescriptor;
<span class="lineNum">      25 </span>            : class AliHLTTask;
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : /** list of AliHLTConsumerDescriptor pointers */
<span class="lineNum">      28 </span>            : typedef vector&lt;AliHLTConsumerDescriptor*&gt; AliHLTConsumerDescriptorPList;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : typedef AliHLTUInt8_t* AliHLTUInt8Pointer_t;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : /**
<span class="lineNum">      33 </span>            :  * @class AliHLTDataBuffer
<span class="lineNum">      34 </span>            :  * @brief  Handling of data buffers for the HLT.
<span class="lineNum">      35 </span>            :  * 
<span class="lineNum">      36 </span>            :  * The class provides handling of data buffers for HLT tasks. Each task gets
<span class="lineNum">      37 </span>            :  * its own Data Buffer instance. The buffer is grouped into different data
<span class="lineNum">      38 </span>            :  * segments according to the output of the component.&lt;br&gt;
<span class="lineNum">      39 </span>            :  * The Data Buffer keeps control over the data requests of the 'child'
<span class="lineNum">      40 </span>            :  * components. Each component can subscribe to a certain segment of the data
<span class="lineNum">      41 </span>            :  * buffer. It's state is then changed from 'reserved' to 'active'. After the
<span class="lineNum">      42 </span>            :  * data processing, the component has to release the segment and it's state is
<span class="lineNum">      43 </span>            :  * set to 'processed'. If all components have requested and released their data,
<span class="lineNum">      44 </span>            :  * the Raw Buffer is released and pushed back in the list of available buffers.
<span class="lineNum">      45 </span>            :  *
<span class="lineNum">      46 </span>            :  * @note This class is only used for the @ref alihlt_system.
<span class="lineNum">      47 </span>            :  *
<span class="lineNum">      48 </span>            :  * @ingroup alihlt_system
<span class="lineNum">      49 </span>            :  */
<span class="lineNum">      50 </span>            : class AliHLTDataBuffer : public TObject, public AliHLTLogging 
<span class="lineNum">      51 </span>            : {
<span class="lineNum">      52 </span>            :  public:
<span class="lineNum">      53 </span>            :   //////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      54 </span>            :   // constructors and destructors
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            :   /* standard constructor
<span class="lineNum">      57 </span>            :    */
<span class="lineNum">      58 </span>            :   AliHLTDataBuffer();
<span class="lineNum">      59 </span>            :   /** destructor */
<span class="lineNum">      60 </span>            :   virtual ~AliHLTDataBuffer();
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            :   //////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      63 </span>            :   // initialization
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            :   /**
<span class="lineNum">      66 </span>            :    * Add component to the list of consumers
<span class="lineNum">      67 </span>            :    * @param pConsumer - a consumer of type AliHLTComponent
<span class="lineNum">      68 </span>            :    */
<span class="lineNum">      69 </span>            :   int SetConsumer(AliHLTComponent* pConsumer);
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            :   //////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      72 </span>            :   // component to component communication
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            :   /**
<span class="lineNum">      75 </span>            :    * Determine the number of matching data blocks for the component and a
<span class="lineNum">      76 </span>            :    * consumer component. &lt;br&gt;
<span class="lineNum">      77 </span>            :    * The first approach will support only one output data type for processing
<span class="lineNum">      78 </span>            :    * components.
<span class="lineNum">      79 </span>            :    * @param pConsumer       the component which subscribes to the buffer
<span class="lineNum">      80 </span>            :    * @param tgtList         (optional) the list to receive the data types
<span class="lineNum">      81 </span>            :    * @return: number of data blocks which match the input data types 
<span class="lineNum">      82 </span>            :    *          of the consumer, neg. error code if failed &lt;br&gt;
<span class="lineNum">      83 </span>            :    *          -EINVAL       invalid parameter &lt;br&gt;
<span class="lineNum">      84 </span>            :    */
<span class="lineNum">      85 </span>            :   int FindMatchingDataBlocks(const AliHLTComponent* pConsumer,
<span class="lineNum">      86 </span>            :                              AliHLTComponentDataTypeList* tgtList=NULL);
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            :   /**
<span class="lineNum">      89 </span>            :    * Subscribe to a segment of the data buffer.
<span class="lineNum">      90 </span>            :    * The function prepares the block descriptor for subsequent use with the
<span class="lineNum">      91 </span>            :    * AliHLTComponent::ProcessEvent method, the method can prepare several block
<span class="lineNum">      92 </span>            :    * descriptors up to the array size specified by iArraySize. The return value
<span class="lineNum">      93 </span>            :    * is independent from the array size the number of block descriptors which
<span class="lineNum">      94 </span>            :    * would have been prepared if there was enough space in the array&lt;br&gt;
<span class="lineNum">      95 </span>            :    * The method is used by the consumer component.
<span class="lineNum">      96 </span>            :    * @param pConsumer       the component which subscribes to the buffer
<span class="lineNum">      97 </span>            :    * @param blockDescList   block descriptor vector to be filled
<span class="lineNum">      98 </span>            :    * @return: number of matching data blocks, neg. error code if failed&lt;br&gt;
<span class="lineNum">      99 </span>            :    *          -EACCESS      the consumer state can't be changed (activated)
<span class="lineNum">     100 </span>            :    *          -EBADF        unresolved data segments &lt;br&gt;
<span class="lineNum">     101 </span>            :    *          -ENOENT       consumer component not found &lt;br&gt;
<span class="lineNum">     102 </span>            :    *          -ENODATA      data buffer does not have raw data &lt;br&gt;
<span class="lineNum">     103 </span>            :    *          -EINVAL       invalid parameter &lt;br&gt;
<span class="lineNum">     104 </span>            :    */
<span class="lineNum">     105 </span>            :   int Subscribe(const AliHLTComponent* pConsumer,
<span class="lineNum">     106 </span>            :                 AliHLTComponentBlockDataList&amp; blockDescList);
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span>            :   /**
<span class="lineNum">     109 </span>            :    * Release an instance of the data buffer.
<span class="lineNum">     110 </span>            :    * Resets the variables of the block descriptor.
<span class="lineNum">     111 </span>            :    * If all buffer segments are released, the Data Buffer is reseted
<span class="lineNum">     112 </span>            :    * and the Raw Buffer released.&lt;br&gt;
<span class="lineNum">     113 </span>            :    * The method is used by the consumer component.
<span class="lineNum">     114 </span>            :    * @param pBlockDesc      descriptor of the data segment
<span class="lineNum">     115 </span>            :    * @param pConsumer       the component which subscribes to the buffer
<span class="lineNum">     116 </span>            :    * @param pOwnerTask      task owning this buffer
<span class="lineNum">     117 </span>            :    * @return: &gt;0 if success, negative error code if failed &lt;br&gt;
<span class="lineNum">     118 </span>            :    *          -EACCESS      the consumer state can not be changed (de-activated)
<span class="lineNum">     119 </span>            :    *          -ENOENT       consumer has not subscribed to the buffer &lt;br&gt;
<span class="lineNum">     120 </span>            :    *          -EINVAL       invalid parameter &lt;br&gt;
<span class="lineNum">     121 </span>            :    */
<span class="lineNum">     122 </span>            :   int Release(AliHLTComponentBlockData* pBlockDesc, const AliHLTComponent* pConsumer,
<span class="lineNum">     123 </span>            :               const AliHLTTask* pOwnerTask);
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span>            :   /**
<span class="lineNum">     126 </span>            :    * Release a forwarded data block.
<span class="lineNum">     127 </span>            :    */
<span class="lineNum">     128 </span>            :   int ReleaseForwardedBlock(AliHLTComponentBlockData* pBlockDesc,
<span class="lineNum">     129 </span>            :                              const AliHLTTask* pOwnerTask);
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span>            :   /**
<span class="lineNum">     132 </span>            :    * Register an input data block for forwarding.
<span class="lineNum">     133 </span>            :    * Consumer of this data buffer subscribe to forwarded data blocks in te same way.
<span class="lineNum">     134 </span>            :    * Forwarded data blocks are released when the last consumer has released the
<span class="lineNum">     135 </span>            :    * blocks.
<span class="lineNum">     136 </span>            :    * @param pSrcTask        original source task of the data block
<span class="lineNum">     137 </span>            :    * @param pBlockDesc      descriptor of the data segment
<span class="lineNum">     138 </span>            :    */
<span class="lineNum">     139 </span>            :   int Forward(AliHLTTask* pSrcTask, AliHLTComponentBlockData* pBlockDesc);
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            :   /**
<span class="lineNum">     142 </span>            :    * Get a target buffer of minimum size iMinSize.
<span class="lineNum">     143 </span>            :    * The method is used by the component which owns the Data Buffer to 
<span class="lineNum">     144 </span>            :    * allocate a buffer for the data it is going to produce.
<span class="lineNum">     145 </span>            :    * @param iMinSize        minumum size of the requested buffer
<span class="lineNum">     146 </span>            :    * @return: pointer to target buffer if 
<span class="lineNum">     147 </span>            :    */
<span class="lineNum">     148 </span>            :   AliHLTUInt8_t* GetTargetBuffer(int iMinSize);
<span class="lineNum">     149 </span>            :   static unsigned int GetMaxBufferSize();
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            :   /**
<span class="lineNum">     152 </span>            :    * Set the segments for the data buffer.
<span class="lineNum">     153 </span>            :    * This is usually done after the component has written the data to the buffer, 
<span class="lineNum">     154 </span>            :    * which was requested by the @ref GetTargetBuffer method. The component might
<span class="lineNum">     155 </span>            :    * produce different types of data, for each type a segment has to be defined
<span class="lineNum">     156 </span>            :    * which describes the data inside the buffer.&lt;br&gt;
<span class="lineNum">     157 </span>            :    * The @ref AliHLTComponentBlockData segment descriptor comes directly from
<span class="lineNum">     158 </span>            :    * the @ref AliHLTComponent::ProcessEvent method.
<span class="lineNum">     159 </span>            :    * @param pTgt            the target buffer which the segments refer to
<span class="lineNum">     160 </span>            :    * @param arraySegments   the output block descriptors of the component
<span class="lineNum">     161 </span>            :    * @param iSize           size of the array
<span class="lineNum">     162 </span>            :    */
<span class="lineNum">     163 </span>            :   int SetSegments(AliHLTUInt8_t* pTgt, AliHLTComponentBlockData* arraySegments, int iSize);
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span>            :   /**
<span class="lineNum">     166 </span>            :    * Check if the data buffer is empty.
<span class="lineNum">     167 </span>            :    * @return 1 if empty, 0 if not
<span class="lineNum">     168 </span>            :    */
<span class="lineNum">     169 </span>            :   int IsEmpty();
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span>            :   /**
<span class="lineNum">     172 </span>            :    * Get the total and maximum size of the buffer.
<span class="lineNum">     173 </span>            :    * Lets see if this is needed later
<span class="lineNum">     174 </span>            :    */
<span class="lineNum">     175 </span>            :   //int GetTotalSize();
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span>            :   /**
<span class="lineNum">     178 </span>            :    * Get the number of segments including the forwarded data blocks.
<span class="lineNum">     179 </span>            :    * @return number of segments
<span class="lineNum">     180 </span>            :    */
<span class="lineNum">     181 </span>            :   int GetNofSegments() const;
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span>            :   /**
<span class="lineNum">     184 </span>            :    * Get the total number of consumers.
<span class="lineNum">     185 </span>            :    * This gives the number of consumers regardless of their state.
<span class="lineNum">     186 </span>            :    * @return number of consumers
<span class="lineNum">     187 </span>            :    */
<span class="lineNum">     188 </span>            :   int GetNofConsumers() const;
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span>            :   /**
<span class="lineNum">     191 </span>            :    * Get the number of consumers which still need to be processed during
<span class="lineNum">     192 </span>            :    * the current event.
<span class="lineNum">     193 </span>            :    * @return number of consumers
<span class="lineNum">     194 </span>            :    */
<span class="lineNum">     195 </span>            :   int GetNofPendingConsumers() const;
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span>            :   /**
<span class="lineNum">     198 </span>            :    * Get the number of consumers currently under processing.
<span class="lineNum">     199 </span>            :    * @return number of active consumers
<span class="lineNum">     200 </span>            :    */
<span class="lineNum">     201 </span>            :   int GetNofActiveConsumers() const;
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span>            :   /**
<span class="lineNum">     204 </span>            :    * Check if a consumer is already in the list
<span class="lineNum">     205 </span>            :    * @param pConsumer   pointer to consumer component
<span class="lineNum">     206 </span>            :    * @param bAllLists   search in all lists if 1
<span class="lineNum">     207 </span>            :    *                    search only in fConsumer list if 0
<span class="lineNum">     208 </span>            :    * @return 1 if found, 0 if not
<span class="lineNum">     209 </span>            :    */
<span class="lineNum">     210 </span>            :   int FindConsumer(const AliHLTComponent* pConsumer, int bAllLists=1);
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span>            :   /**
<span class="lineNum">     213 </span>            :    * Public method to reset the buffer.
<span class="lineNum">     214 </span>            :    * Eventually with some additional checks. In normal operation,
<span class="lineNum">     215 </span>            :    * an external reset should not be necessary.
<span class="lineNum">     216 </span>            :    */
<span class="lineNum">     217 </span>            :   int Reset();
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span>            :   /**
<span class="lineNum">     220 </span>            :    * Print info about the buffer
<span class="lineNum">     221 </span>            :    */
<span class="lineNum">     222 </span>            :   virtual void Print(const char* option) const;
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span>            :   /**
<span class="lineNum">     225 </span>            :    * Set local logging level
<a name="226"><span class="lineNum">     226 </span>            :    * logging filter for individual object</a>
<span class="lineNum">     227 </span>            :    */
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   void SetLocalLoggingLevel(AliHLTComponentLogSeverity level)</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :   {fgLogging.SetLocalLoggingLevel(level); AliHLTLogging::SetLocalLoggingLevel(level);}</span>
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span>            :   /**
<span class="lineNum">     232 </span>            :    * Print summary of the global buffer management.
<span class="lineNum">     233 </span>            :    */
<span class="lineNum">     234 </span>            :   static int PrintStatistics();
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span>            :   /**
<span class="lineNum">     237 </span>            :    * Set the global event count.
<span class="lineNum">     238 </span>            :    * The event count is deployed to find buffers which have not been used
<span class="lineNum">     239 </span>            :    * for a while. In such a case to policy to find an appropriate buffer is
<a name="240"><span class="lineNum">     240 </span>            :    * adjusted.</a>
<span class="lineNum">     241 </span>            :    */
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :   static int SetGlobalEventCount(AliHLTUInt32_t eventCount) {fgEventCount=eventCount; return 0;}</span>
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span>            :   /**
<span class="lineNum">     245 </span>            :    * @class AliHLTDataSegment
<span class="lineNum">     246 </span>            :    * @brief  Descriptor of a data segment within the buffer.
<span class="lineNum">     247 </span>            :    */
<span class="lineNum">     248 </span>            :   class AliHLTDataSegment {
<a name="249"><span class="lineNum">     249 </span>            :     friend class AliHLTDataBuffer; // TODO: implement some getters/setters</a>
<span class="lineNum">     250 </span>            :   public:
<span class="lineNum">     251 </span>            :     AliHLTDataSegment()
<span class="lineNum">     252 </span>            :       :
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :       fDataType(kAliHLTVoidDataType),</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :       fPtr(NULL),</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :       fSegmentOffset(0),</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :       fSegmentSize(0),</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :       fSpecification(0)</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span>            :     AliHLTDataSegment(AliHLTUInt8_t* ptr, AliHLTUInt32_t offset, AliHLTUInt32_t size) 
<span class="lineNum">     262 </span>            :       :
<span class="lineNum">     263 </span>            :       fDataType(kAliHLTVoidDataType),
<span class="lineNum">     264 </span>            :       fPtr(ptr),
<span class="lineNum">     265 </span>            :       fSegmentOffset(offset),
<span class="lineNum">     266 </span>            :       fSegmentSize(size),
<span class="lineNum">     267 </span>            :       fSpecification(0)
<span class="lineNum">     268 </span>            :     {
<a name="269"><span class="lineNum">     269 </span>            :     }</a>
<span class="lineNum">     270 </span>            : 
<span class="lineNum">     271 </span>            :     AliHLTDataSegment(void* ptr, AliHLTUInt32_t offset, AliHLTUInt32_t size) 
<span class="lineNum">     272 </span>            :       :
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :       fDataType(kAliHLTVoidDataType),</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :       fPtr(reinterpret_cast&lt;AliHLTUInt8_t*&gt;(ptr)),</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :       fSegmentOffset(offset),</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :       fSegmentSize(size),</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :       fSpecification(0)</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :     {</span>
<a name="279"><span class="lineNum">     279 </span><span class="lineNoCov">          0 :     }</span></a>
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span>            :     AliHLTDataSegment(void* ptr, AliHLTUInt32_t offset, AliHLTUInt32_t size, AliHLTComponentDataType dt, AliHLTUInt32_t spec)
<span class="lineNum">     282 </span>            :       :
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :       fDataType(dt),</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :       fPtr(reinterpret_cast&lt;AliHLTUInt8_t*&gt;(ptr)),</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :       fSegmentOffset(offset),</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :       fSegmentSize(size),</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :       fSpecification(spec)</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     {</span>
<a name="289"><span class="lineNum">     289 </span><span class="lineNoCov">          0 :     }</span></a>
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :     AliHLTDataSegment(const AliHLTDataSegment&amp; src)
<span class="lineNum">     292 </span>            :       :
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :       fDataType(src.fDataType),</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :       fPtr(src.fPtr),</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :       fSegmentOffset(src.fSegmentOffset),</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :       fSegmentSize(src.fSegmentSize),</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :       fSpecification(src.fSpecification)</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     299 </span>            :       // AliHLTDataSegment just stores external pointers and properties
<a name="300"><span class="lineNum">     300 </span><span class="lineNoCov">          0 :     }</span></a>
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span>            :     AliHLTDataSegment&amp; operator=(const AliHLTDataSegment&amp; src)
<span class="lineNum">     303 </span>            :     {
<span class="lineNum">     304 </span>            :       // AliHLTDataSegment just stores external pointers and properties
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :       if (this==&amp;src) return *this;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :       fDataType=src.fDataType;</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :       fPtr=src.fPtr;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :       fSegmentOffset=src.fSegmentOffset;</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :       fSegmentSize=src.fSegmentSize;</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :       fSpecification=src.fSpecification;</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :       return *this;</span>
<a name="312"><span class="lineNum">     312 </span><span class="lineNoCov">          0 :     }</span></a>
<span class="lineNum">     313 </span>            : 
<a name="314"><span class="lineNum">     314 </span><span class="lineNoCov">          0 :     virtual ~AliHLTDataSegment() {}</span></a>
<span class="lineNum">     315 </span>            : 
<a name="316"><span class="lineNum">     316 </span><span class="lineNoCov">          0 :     AliHLTUInt8_t* GetPtr() const {return (AliHLTUInt8_t*)*this;}</span></a>
<span class="lineNum">     317 </span>            : 
<a name="318"><span class="lineNum">     318 </span><span class="lineNoCov">          0 :     AliHLTUInt32_t GetSize() const {return fSegmentSize;}</span></a>
<span class="lineNum">     319 </span>            :     
<span class="lineNum">     320 </span>            :     int operator==(const AliHLTDataSegment&amp; seg) const
<span class="lineNum">     321 </span>            :     {
<a name="322"><span class="lineNum">     322 </span><span class="lineNoCov">          0 :       return (fPtr+fSegmentOffset==seg.fPtr+seg.fSegmentOffset) &amp;&amp; (fSegmentSize==seg.fSegmentSize);</span></a>
<span class="lineNum">     323 </span>            :     }
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :     operator AliHLTUInt8_t*() const {return fPtr+fSegmentOffset;}</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span>            :     virtual void Print(const char* option) const;
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span>            :   private:
<span class="lineNum">     329 </span>            :     /** the data type of this segment */
<span class="lineNum">     330 </span>            :     AliHLTComponentDataType fDataType;                             // see above
<span class="lineNum">     331 </span>            :     /** pointer to the buffer */
<span class="lineNum">     332 </span>            :     AliHLTUInt8Pointer_t fPtr;                                     //!transient
<span class="lineNum">     333 </span>            :     /** offset in byte within the data buffer */
<span class="lineNum">     334 </span>            :     AliHLTUInt32_t fSegmentOffset;                                 // see above
<span class="lineNum">     335 </span>            :     /** size of the actual content */
<span class="lineNum">     336 </span>            :     AliHLTUInt32_t fSegmentSize;                                   // see above
<span class="lineNum">     337 </span>            :     /** data specification */
<span class="lineNum">     338 </span>            :     AliHLTUInt32_t fSpecification;                                 // see above
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span>            :   };
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span>            :   /**
<span class="lineNum">     343 </span>            :    * @class AliHLTForwardedDataSegment
<span class="lineNum">     344 </span>            :    * @brief  Descriptor of a forwarded data segment.
<span class="lineNum">     345 </span>            :    * Contains in addition information about the parent of this forwarded
<span class="lineNum">     346 </span>            :    * block and the original data type and specification
<span class="lineNum">     347 </span>            :    */
<span class="lineNum">     348 </span>            :   class AliHLTForwardedDataSegment : public AliHLTDataSegment {
<span class="lineNum">     349 </span>            :     friend class AliHLTDataBuffer; // TODO: implement some getters/setters
<span class="lineNum">     350 </span>            :   public:
<span class="lineNum">     351 </span>            :     AliHLTForwardedDataSegment()
<span class="lineNum">     352 </span>            :       : AliHLTDataSegment()
<span class="lineNum">     353 </span>            :       , fParentSegment()
<span class="lineNum">     354 </span>            :       , fParentTask(NULL)
<span class="lineNum">     355 </span>            :     {
<span class="lineNum">     356 </span>            :     }
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            :     AliHLTForwardedDataSegment(AliHLTDataSegment&amp; mySegment, AliHLTDataSegment&amp; parentSegment, AliHLTTask* parentTask)
<span class="lineNum">     359 </span>            :       : AliHLTDataSegment(mySegment)
<span class="lineNum">     360 </span>            :       , fParentSegment(parentSegment)
<span class="lineNum">     361 </span>            :       , fParentTask(parentTask)
<span class="lineNum">     362 </span>            :     {
<span class="lineNum">     363 </span>            :     }
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span>            :     AliHLTForwardedDataSegment(const AliHLTForwardedDataSegment&amp; src)
<span class="lineNum">     366 </span>            :       : AliHLTDataSegment(src),
<span class="lineNum">     367 </span>            :       fParentSegment(src.fParentSegment),
<span class="lineNum">     368 </span>            :       fParentTask(src.fParentTask)
<span class="lineNum">     369 </span>            :     {
<span class="lineNum">     370 </span>            :       // AliHLTForwardedDataSegment just stores external pointers and properties
<span class="lineNum">     371 </span>            :     }
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span>            :     AliHLTForwardedDataSegment&amp; operator=(const AliHLTForwardedDataSegment&amp; src)
<span class="lineNum">     374 </span>            :     {
<span class="lineNum">     375 </span>            :       // AliHLTForwardedDataSegment just stores external pointers and properties
<span class="lineNum">     376 </span>            :       AliHLTDataSegment::operator=(src);
<span class="lineNum">     377 </span>            :       fParentSegment=src.fParentSegment;
<span class="lineNum">     378 </span>            :       fParentTask=src.fParentTask;
<span class="lineNum">     379 </span>            :       return *this;
<a name="380"><span class="lineNum">     380 </span>            :     }</a>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :     virtual ~AliHLTForwardedDataSegment() {}</span>
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span>            :     virtual void Print(const char* option) const;
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span>            :   private:
<span class="lineNum">     387 </span>            :     /// description of the original segment
<span class="lineNum">     388 </span>            :     AliHLTDataSegment fParentSegment;                              // see above
<span class="lineNum">     389 </span>            :     /// the parent task
<span class="lineNum">     390 </span>            :     AliHLTTask* fParentTask;                                       //!transient
<span class="lineNum">     391 </span>            :   };
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span>            :   typedef vector&lt;AliHLTDataBuffer::AliHLTDataSegment&gt; AliHLTDataSegmentList;
<span class="lineNum">     394 </span>            : 
<span class="lineNum">     395 </span>            :   class AliHLTRawBuffer;
<span class="lineNum">     396 </span>            :   typedef vector&lt;AliHLTRawBuffer*&gt;  AliHLTRawBufferPList;
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span>            :   /**
<span class="lineNum">     399 </span>            :    * @class AliHLTRawPage
<span class="lineNum">     400 </span>            :    * Memory allocation is organized in pages of a fixed size. Within a
<span class="lineNum">     401 </span>            :    * page, AliHLTRawBuffer chunks are created.
<span class="lineNum">     402 </span>            :    */
<span class="lineNum">     403 </span>            :   class AliHLTRawPage : public AliHLTLogging {
<a name="404"><span class="lineNum">     404 </span>            :   public:</a>
<span class="lineNum">     405 </span>            :     /** standard constructor */
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :   AliHLTRawPage() : fSize(0), fPtr(NULL), fFreeBuffers(), fUsedBuffers() {}</span>
<span class="lineNum">     407 </span>            :     /** constructor */
<span class="lineNum">     408 </span>            :     AliHLTRawPage(AliHLTUInt32_t pagesize);
<span class="lineNum">     409 </span>            :     /** destructor */
<span class="lineNum">     410 </span>            :     virtual ~AliHLTRawPage();
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span>            :     /** alloc a buffer of specified size from the global pages*/
<span class="lineNum">     413 </span>            :     static AliHLTRawBuffer* GlobalAlloc(AliHLTUInt32_t size, int verbosity=0);
<span class="lineNum">     414 </span>            :     /** find buffer in the global pages */
<span class="lineNum">     415 </span>            :     static AliHLTRawPage* FindPage(AliHLTRawBuffer* buffer);
<span class="lineNum">     416 </span>            :     /** cleanup the global pages */
<a name="417"><span class="lineNum">     417 </span>            :     static int GlobalClean();</a>
<a name="418"><span class="lineNum">     418 </span>            :     /** adjust global page size */</a>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :     static void SetGlobalPageSize(AliHLTUInt32_t size) {fgGlobalPageSize=size;}</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     static AliHLTUInt32_t GetGlobalPageSize() {return fgGlobalPageSize;}</span>
<span class="lineNum">     421 </span>            :     /** find next page after prev, or first page */
<span class="lineNum">     422 </span>            :     static AliHLTRawPage* NextPage(const AliHLTRawPage* prev=NULL);
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span>            :     /** alloc a buffer of specified size */
<span class="lineNum">     425 </span>            :     AliHLTRawBuffer* Alloc(AliHLTUInt32_t size);
<span class="lineNum">     426 </span>            :     /** free a buffer and merge consecutive free buffers */
<span class="lineNum">     427 </span>            :     int Free(AliHLTRawBuffer* pBuffer);
<span class="lineNum">     428 </span>            :     /** set the size of a raw buffer and release the remaining part */
<span class="lineNum">     429 </span>            :     int SetSize(const AliHLTRawBuffer* pBuffer, AliHLTUInt32_t size);
<span class="lineNum">     430 </span>            :     /// check if the buffer is in this page
<a name="431"><span class="lineNum">     431 </span>            :     bool HasBuffer(const AliHLTRawBuffer* pBuffer);</a>
<span class="lineNum">     432 </span>            : 
<a name="433"><span class="lineNum">     433 </span><span class="lineNoCov">          0 :     AliHLTUInt32_t Size() const {return fSize;}</span></a>
<a name="434"><span class="lineNum">     434 </span>            :     AliHLTUInt32_t Capacity() const;</a>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     bool IsUsed() const {return fUsedBuffers.size()&gt;0;}</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :     bool IsFragmented() const {return (fFreeBuffers.size()+fUsedBuffers.size())&gt;1;}</span>
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span>            :     /**
<span class="lineNum">     439 </span>            :      * Print page information
<span class="lineNum">     440 </span>            :      */
<span class="lineNum">     441 </span>            :     virtual void Print(const char* option);
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span>            :   private:
<span class="lineNum">     444 </span>            :     /** copy constructor prohibited */
<span class="lineNum">     445 </span>            :     AliHLTRawPage(const AliHLTRawPage&amp;);
<span class="lineNum">     446 </span>            :     /** assignment operator prohibited */
<span class="lineNum">     447 </span>            :     AliHLTRawPage&amp; operator=(const AliHLTRawPage&amp;);
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span>            :     /// list of global pages
<span class="lineNum">     450 </span>            :     static vector&lt;AliHLTDataBuffer::AliHLTRawPage*&gt; fgGlobalPages; //! transient
<span class="lineNum">     451 </span>            :     /// pages size of global pages
<span class="lineNum">     452 </span>            :     static AliHLTUInt32_t fgGlobalPageSize;                        //! transient
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span>            :     /** page size */
<span class="lineNum">     455 </span>            :     AliHLTUInt32_t fSize;                                          // see above
<span class="lineNum">     456 </span>            :     /** the memory segment */
<span class="lineNum">     457 </span>            :     AliHLTUInt8_t* fPtr;                                           //! transient
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span>            :     /** list of free buffers */
<span class="lineNum">     460 </span>            :     AliHLTRawBufferPList fFreeBuffers;                             //! transient
<span class="lineNum">     461 </span>            :     /** list of used buffers */
<span class="lineNum">     462 </span>            :     AliHLTRawBufferPList fUsedBuffers;                             //! transient
<span class="lineNum">     463 </span>            :   };
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span>            :   /**
<span class="lineNum">     466 </span>            :    * @class AliHLTRawBuffer
<span class="lineNum">     467 </span>            :    * @brief  Descriptor of the raw data buffer which can host several segments.
<span class="lineNum">     468 </span>            :    */
<span class="lineNum">     469 </span>            :   class AliHLTRawBuffer {
<a name="470"><span class="lineNum">     470 </span>            :   public:</a>
<span class="lineNum">     471 </span>            :     /** standard constructor */
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :   AliHLTRawBuffer() : fSize(0), fTotalSize(0), fExternalPtr(NULL), fPtr(NULL), fLastEventCount(0) {}</span>
<span class="lineNum">     473 </span>            :     /** constructor */
<span class="lineNum">     474 </span>            :     AliHLTRawBuffer(AliHLTUInt32_t size);
<span class="lineNum">     475 </span>            :     /** constructor */
<span class="lineNum">     476 </span>            :     AliHLTRawBuffer(AliHLTUInt32_t size, AliHLTUInt8_t* buffer);
<span class="lineNum">     477 </span>            :     /** destructor */
<span class="lineNum">     478 </span>            :     virtual ~AliHLTRawBuffer();
<span class="lineNum">     479 </span>            : 
<span class="lineNum">     480 </span>            :     /**
<span class="lineNum">     481 </span>            :      * Use a fraction of the buffer.
<span class="lineNum">     482 </span>            :      * @param size    size in bytes to be used
<span class="lineNum">     483 </span>            :      * @return pointer to buffer
<span class="lineNum">     484 </span>            :      */
<span class="lineNum">     485 </span>            :     AliHLTUInt8_t* UseBuffer(AliHLTUInt32_t size);
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span>            :     /**
<span class="lineNum">     488 </span>            :      * split a buffer at specified size
<span class="lineNum">     489 </span>            :      * only possible for buffers with external memory
<span class="lineNum">     490 </span>            :      */
<span class="lineNum">     491 </span>            :     AliHLTRawBuffer* Split(AliHLTUInt32_t size);
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span>            :     /**
<span class="lineNum">     494 </span>            :      * Check whether buffer fits for a request.
<span class="lineNum">     495 </span>            :      * A buffer fits if it is at least of the requested size and at most
<span class="lineNum">     496 </span>            :      * the requested size plus a margin. The margin increases with the
<span class="lineNum">     497 </span>            :      * number of events the buffer has not been used.
<span class="lineNum">     498 </span>            :      * @param size    size of the request in bytes
<span class="lineNum">     499 </span>            :      * @return 1 if buffer is big enough, 0 if not
<span class="lineNum">     500 </span>            :      */
<span class="lineNum">     501 </span>            :     int CheckSize(AliHLTUInt32_t size) const;
<span class="lineNum">     502 </span>            : 
<span class="lineNum">     503 </span>            :     /**
<a name="504"><span class="lineNum">     504 </span>            :      * Get used size of the buffer</a>
<span class="lineNum">     505 </span>            :      */
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :     AliHLTUInt32_t GetUsedSize() const {return fSize;}</span>
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span>            :     /**
<a name="509"><span class="lineNum">     509 </span>            :      * Get total size of the buffer</a>
<span class="lineNum">     510 </span>            :      */
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     AliHLTUInt32_t GetTotalSize() const {return fTotalSize;}</span>
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span>            :     /**
<a name="514"><span class="lineNum">     514 </span>            :      * Get pointer of data buffer</a>
<span class="lineNum">     515 </span>            :      */
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :     AliHLTUInt8_t* GetPointer() const {return fPtr;}</span>
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span>            :     /**
<span class="lineNum">     519 </span>            :      * Write check pattern
<span class="lineNum">     520 </span>            :      */
<span class="lineNum">     521 </span>            :     int WritePattern(const char* pattern, int size);
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :     /**
<span class="lineNum">     524 </span>            :      * Check pattern
<span class="lineNum">     525 </span>            :      */
<span class="lineNum">     526 </span>            :     int CheckPattern(const char* pattern, int size) const;
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span>            :     /**
<span class="lineNum">     529 </span>            :      * Reset buffer.
<span class="lineNum">     530 </span>            :      * Data buffer remains allocated, used size set to 0
<span class="lineNum">     531 </span>            :      */
<span class="lineNum">     532 </span>            :     int Reset();
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span>            :     /*
<span class="lineNum">     535 </span>            :      * Merge buffer with succeeding buffer.
<span class="lineNum">     536 </span>            :      * Only possible if the buffers are consecutive with out any gap.
<span class="lineNum">     537 </span>            :      */
<span class="lineNum">     538 </span>            :     int Merge(const AliHLTRawBuffer&amp; succ);
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span>            :     /**
<span class="lineNum">     541 </span>            :      * Print buffer information
<span class="lineNum">     542 </span>            :      */
<span class="lineNum">     543 </span>            :     virtual void Print(const char* option) const;
<a name="544"><span class="lineNum">     544 </span>            : </a>
<span class="lineNum">     545 </span>            :     int operator==(void* ptr) const;
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :     int operator==(AliHLTUInt8_t* ptr) const {return fPtr==ptr;}</span>
<span class="lineNum">     547 </span>            :     int operator&lt;(void* ptr) const;
<span class="lineNum">     548 </span>            :     int operator&lt;=(void* ptr) const;
<span class="lineNum">     549 </span>            :     int operator&gt;(void* ptr) const;
<span class="lineNum">     550 </span>            :     int operator-(void* ptr) const;
<span class="lineNum">     551 </span>            :     int operator&lt;(const AliHLTRawBuffer&amp; op) const;
<span class="lineNum">     552 </span>            :     int operator&lt;=(const AliHLTRawBuffer&amp; op) const;
<a name="553"><span class="lineNum">     553 </span>            :     int operator&gt;(const AliHLTRawBuffer&amp; op) const;</a>
<a name="554"><span class="lineNum">     554 </span>            : </a>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :     operator void*() const {return fPtr;}</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :     operator AliHLTUInt8_t*() const {return fPtr;}</span>
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span>            :   private:
<span class="lineNum">     559 </span>            :     /** copy constructor prohibited */
<span class="lineNum">     560 </span>            :     AliHLTRawBuffer(const AliHLTRawBuffer&amp;);
<span class="lineNum">     561 </span>            :     /** assignment operator prohibited */
<span class="lineNum">     562 </span>            :     AliHLTRawBuffer&amp; operator=(const AliHLTRawBuffer&amp;);
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span>            :     /** size of the currently occupied partition of the buffer */
<span class="lineNum">     565 </span>            :     AliHLTUInt32_t fSize;                                          // see above
<span class="lineNum">     566 </span>            :     /** total size of the buffer, including safety margin */
<span class="lineNum">     567 </span>            :     AliHLTUInt32_t fTotalSize;                                     // see above
<span class="lineNum">     568 </span>            :     /** optional external buffer */
<span class="lineNum">     569 </span>            :     AliHLTUInt8_t* fExternalPtr;                                   //! transient
<span class="lineNum">     570 </span>            :     /** the buffer, external or allocated */
<span class="lineNum">     571 </span>            :     AliHLTUInt8_t* fPtr;                                           //! transient
<span class="lineNum">     572 </span>            :     /** last event count where the buffer has been used */
<span class="lineNum">     573 </span>            :     AliHLTUInt32_t fLastEventCount;                                //! transient
<span class="lineNum">     574 </span>            :   };
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span>            :  private:
<span class="lineNum">     577 </span>            :   /** copy constructor prohibited */
<span class="lineNum">     578 </span>            :   AliHLTDataBuffer(const AliHLTDataBuffer&amp;);
<span class="lineNum">     579 </span>            :   /** assignment operator prohibited */
<span class="lineNum">     580 </span>            :   AliHLTDataBuffer&amp; operator=(const AliHLTDataBuffer&amp;);
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span>            :   /* lets see if this is needed
<span class="lineNum">     583 </span>            :      AliHLTDataSegment* FindDataSegment(AliHLTComponentDataType datatype);
<span class="lineNum">     584 </span>            :   */
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span>            :   /**
<span class="lineNum">     587 </span>            :    * Find those data segments which match the input types of a component.
<span class="lineNum">     588 </span>            :    * @param pConsumer       the component which subscribes to the buffer
<span class="lineNum">     589 </span>            :    * @param tgtList         the list to receive the data segment descriptors
<span class="lineNum">     590 </span>            :    * @return: number of data blocks which match the input data types 
<span class="lineNum">     591 </span>            :    *          of the consumer, neg. error code if failed &lt;br&gt;
<span class="lineNum">     592 </span>            :    *          -EINVAL       invalid parameter &lt;br&gt;
<span class="lineNum">     593 </span>            :    */
<span class="lineNum">     594 </span>            :   int FindMatchingDataSegments(const AliHLTComponent* pConsumer, 
<span class="lineNum">     595 </span>            :                                AliHLTDataSegmentList&amp; tgtList);
<span class="lineNum">     596 </span>            : 
<span class="lineNum">     597 </span>            :  protected:
<span class="lineNum">     598 </span>            :   // 2010-02-01 make function protected in order to be used from unit test
<span class="lineNum">     599 </span>            :   /**
<span class="lineNum">     600 </span>            :    * Reset the data buffer.
<span class="lineNum">     601 </span>            :    * Removes all consumers back to the @ref fConsumers list, deletes
<span class="lineNum">     602 </span>            :    * segments and releases the Raw Buffer.
<span class="lineNum">     603 </span>            :    */
<span class="lineNum">     604 </span>            :   int ResetDataBuffer();
<span class="lineNum">     605 </span>            :  private:
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span>            :   //////////////////////////////////////////////////////////////////////////////
<span class="lineNum">     608 </span>            : 
<span class="lineNum">     609 </span>            :   // the data description
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span>            :   // the data segments within this buffer
<span class="lineNum">     612 </span>            :   vector&lt;AliHLTDataSegment&gt; fSegments;                             // see above
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span>            :   // the list of all consumers which are going to subscribe to the buffer
<span class="lineNum">     615 </span>            :   AliHLTConsumerDescriptorPList fConsumers;                         // see above
<span class="lineNum">     616 </span>            :   // the list of all consumers which are currently subscribed to the buffer
<span class="lineNum">     617 </span>            :   AliHLTConsumerDescriptorPList fActiveConsumers;                   // see above
<span class="lineNum">     618 </span>            :   // the list of all consumers which are already released for the current event
<span class="lineNum">     619 </span>            :   AliHLTConsumerDescriptorPList fReleasedConsumers;                 // see above
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span>            :   // the buffer instance
<span class="lineNum">     622 </span>            :   AliHLTRawBuffer* fpBuffer;                                       //! transient
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span>            :   // flags indicating the state of the buffer
<span class="lineNum">     625 </span>            :   AliHLTUInt32_t fFlags;                                           // see above
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span>            :   /** list of tasks with forwarded data blocks */
<span class="lineNum">     628 </span>            :   vector&lt;AliHLTTask*&gt; fForwardedSegmentSources;                    //! transient
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span>            :   /** list of forwarded block descriptors */
<span class="lineNum">     631 </span>            :   vector&lt;AliHLTDataSegment&gt; fForwardedSegments;                    //! transient
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span>            :   //////////////////////////////////////////////////////////////////////////////
<span class="lineNum">     634 </span>            :   // global buffer handling, internal use only
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span>            :   /**
<span class="lineNum">     637 </span>            :    * Create a raw buffer of a certain size.
<span class="lineNum">     638 </span>            :    * The function tries to find a buffer of the given size (or a bit bigger by a 
<span class="lineNum">     639 </span>            :    * certain margin @ref fgMargin) from the list of free buffers.
<span class="lineNum">     640 </span>            :    * If no buffer is available, a new one is created and added to the buffer handling.
<span class="lineNum">     641 </span>            :    * @param size            min. size of the requested buffer
<span class="lineNum">     642 </span>            :    * @return pointer to raw buffer
<span class="lineNum">     643 </span>            :    */
<span class="lineNum">     644 </span>            :   static AliHLTRawBuffer* CreateRawBuffer(AliHLTUInt32_t size);
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span>            :   /**
<span class="lineNum">     647 </span>            :    * Set the data size of a raw buffer after it has been filled by
<span class="lineNum">     648 </span>            :    * the component.
<span class="lineNum">     649 </span>            :    */
<span class="lineNum">     650 </span>            :   int SetRawBufferDataSize(AliHLTRawBuffer* pBuffer, AliHLTUInt32_t size) const;
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span>            :   /**
<span class="lineNum">     653 </span>            :    * Mark a buffer as free.
<span class="lineNum">     654 </span>            :    * After the Data Buffer has finnished using the raw buffer, it is released
<span class="lineNum">     655 </span>            :    * and added to the list of available buffers.
<span class="lineNum">     656 </span>            :    * @param pBuffer         the raw buffer to release
<span class="lineNum">     657 </span>            :    * @return &gt;=0 if succeeded, neg. error code if failed
<span class="lineNum">     658 </span>            :    */
<span class="lineNum">     659 </span>            :   static int ReleaseRawBuffer(AliHLTRawBuffer* pBuffer);
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span>            :   /**
<span class="lineNum">     662 </span>            :    * Deletes all the raw buffers.
<span class="lineNum">     663 </span>            :    * When the last Data Buffer object is destructed, all raw data buffers are
<span class="lineNum">     664 </span>            :    * relesed.
<span class="lineNum">     665 </span>            :    */
<span class="lineNum">     666 </span>            :   static int DeleteRawBuffers();
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span>            :   /**
<span class="lineNum">     669 </span>            :    * Number of instances of AliHLTDataBuffer.
<span class="lineNum">     670 </span>            :    * The statice variable is incremented and decremented in the constructor/
<span class="lineNum">     671 </span>            :    * destructor. All internal data structures are cleaned up when the last
<span class="lineNum">     672 </span>            :    * instance is exiting.
<span class="lineNum">     673 </span>            :    */
<span class="lineNum">     674 </span>            :   static int fgNofInstances;                                       // see above
<span class="lineNum">     675 </span>            :   /** global list of free raw buffers */
<span class="lineNum">     676 </span>            :   static vector&lt;AliHLTRawBuffer*&gt; fgFreeBuffers;                   // see above
<span class="lineNum">     677 </span>            :   /** global list of currently active raw buffers */
<span class="lineNum">     678 </span>            :   static vector&lt;AliHLTRawBuffer*&gt; fgActiveBuffers;                 // see above
<span class="lineNum">     679 </span>            :   /** determines the raw buffer size margin at buffer requests */
<span class="lineNum">     680 </span>            :   static AliHLTUInt32_t fgMargin;                                  // see above
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span>            :   /** global instance to HLT logging class for static methods */
<span class="lineNum">     683 </span>            :   static AliHLTLogging fgLogging;                                  // see above
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span>            :   /** size of the safety pattern */
<span class="lineNum">     686 </span>            :   static const Int_t fgkSafetyPatternSize;                         // see above
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span>            :   /** the safety pattern */
<span class="lineNum">     689 </span>            :   static const char fgkSafetyPattern[];                            //!transient
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span>            :   static AliHLTUInt32_t fgEventCount;                              //!transient
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span>            :   //////////////////////////////////////////////////////////////////////////////
<span class="lineNum">     694 </span>            :   // internal helper functions
<span class="lineNum">     695 </span>            : 
<span class="lineNum">     696 </span>            :   /**
<span class="lineNum">     697 </span>            :    * Find the consumer descriptor for a certain component and data type in 
<span class="lineNum">     698 </span>            :    * a list of consumers.&lt;br&gt;
<span class="lineNum">     699 </span>            :    * &lt;b&gt;Note:&lt;/b&gt; There are three lists which contain the consumers in the
<span class="lineNum">     700 </span>            :    * different states.
<span class="lineNum">     701 </span>            :    * @param pConsumer       pointer to consumer component
<span class="lineNum">     702 </span>            :    * @param list            list where to search for the consumer
<span class="lineNum">     703 </span>            :    */
<span class="lineNum">     704 </span>            :   AliHLTConsumerDescriptor* FindConsumer(const AliHLTComponent* pConsumer,
<span class="lineNum">     705 </span>            :                                          AliHLTConsumerDescriptorPList &amp;list) const;
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span>            :   /**
<span class="lineNum">     708 </span>            :    * Change the state of a consumer.
<span class="lineNum">     709 </span>            :    * The state of a consumer is determined by the list it is strored in, the
<span class="lineNum">     710 </span>            :    * method moves a consumer from the source to the target list.
<span class="lineNum">     711 </span>            :    * @param pDesc           pointer to consumer descriptor
<span class="lineNum">     712 </span>            :    * @param srcList         list where the consumer is currently to be found
<span class="lineNum">     713 </span>            :    * @param tgtList         list where to move the consumer
<span class="lineNum">     714 </span>            :    */
<span class="lineNum">     715 </span>            :   int ChangeConsumerState(AliHLTConsumerDescriptor* pDesc,
<span class="lineNum">     716 </span>            :                           AliHLTConsumerDescriptorPList &amp;srcList,
<span class="lineNum">     717 </span>            :                           AliHLTConsumerDescriptorPList &amp;tgtList);
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span>            :   /**
<span class="lineNum">     720 </span>            :    * Cleanup a consumer list.
<span class="lineNum">     721 </span>            :    * Release all allocated data structures. &lt;b&gt;Note:&lt;/b&gt; Not the component itself!
<span class="lineNum">     722 </span>            :    */
<a name="723"><span class="lineNum">     723 </span>            :   int CleanupConsumerList();</a>
<span class="lineNum">     724 </span>            : 
<span class="lineNum">     725 </span><span class="lineCov">        126 :   ClassDef(AliHLTDataBuffer, 1)</span>
<span class="lineNum">     726 </span>            : };
<span class="lineNum">     727 </span>            : 
<span class="lineNum">     728 </span>            : #endif // ALIHLTDATABUFFER_H
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
