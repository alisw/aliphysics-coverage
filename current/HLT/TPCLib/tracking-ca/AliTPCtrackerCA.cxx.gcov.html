<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - HLT/TPCLib/tracking-ca/AliTPCtrackerCA.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">HLT/TPCLib/tracking-ca</a> - AliTPCtrackerCA.cxx<span style="font-size: 80%;"> (source / <a href="AliTPCtrackerCA.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">233</td>
            <td class="headerCovTableEntryLo">0.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">13</td>
            <td class="headerCovTableEntryLo">7.7 %</td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : // $Id$</a>
<span class="lineNum">       2 </span>            : // **************************************************************************
<span class="lineNum">       3 </span>            : // This file is property of and copyright by the ALICE HLT Project          *
<span class="lineNum">       4 </span>            : // ALICE Experiment at CERN, All rights reserved.                           *
<span class="lineNum">       5 </span>            : //                                                                          *
<span class="lineNum">       6 </span>            : // Primary Authors: Sergey Gorbunov &lt;sergey.gorbunov@kip.uni-heidelberg.de&gt; *
<span class="lineNum">       7 </span>            : //                  Ivan Kisel &lt;kisel@kip.uni-heidelberg.de&gt;                *
<span class="lineNum">       8 </span>            : //                  for The ALICE HLT Project.                              *
<span class="lineNum">       9 </span>            : //                                                                          *
<span class="lineNum">      10 </span>            : // Permission to use, copy, modify and distribute this software and its     *
<span class="lineNum">      11 </span>            : // documentation strictly for non-commercial purposes is hereby granted     *
<span class="lineNum">      12 </span>            : // without fee, provided that the above copyright notice appears in all     *
<span class="lineNum">      13 </span>            : // copies and that both the copyright notice and this permission notice     *
<span class="lineNum">      14 </span>            : // appear in the supporting documentation. The authors make no claims       *
<span class="lineNum">      15 </span>            : // about the suitability of this software for any purpose. It is            *
<span class="lineNum">      16 </span>            : // provided &quot;as is&quot; without express or implied warranty.                    *
<span class="lineNum">      17 </span>            : //                                                                          *
<span class="lineNum">      18 </span>            : //***************************************************************************
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #include &quot;AliTPCtrackerCA.h&quot;
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : #include &quot;TTree.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;Riostream.h&quot;
<span class="lineNum">      24 </span>            : //#include &quot;AliCluster.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;AliTPCClustersRow.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;AliTPCParam.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;AliTPCClusterParam.h&quot;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #include &quot;AliRun.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;AliRunLoader.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;AliStack.h&quot;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : #include &quot;AliHLTTPCCAPerformance.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;AliHLTTPCCAParam.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;AliHLTTPCCATracker.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;AliHLTTPCCAStandaloneFramework.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;AliHLTTPCGMMergedTrack.h&quot;
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : #include &quot;TMath.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;AliTPCLoader.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;AliTPC.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;AliTPCclusterMI.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;AliTPCTransform.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;AliTPCcalibDB.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;AliTPCtrack.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;AliTPCseed.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;AliESDtrack.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;AliESDEvent.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;AliTrackReference.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;TStopwatch.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;AliTPCReconstructor.h&quot;
<span class="lineNum">      52 </span>            : #include &lt;memory&gt;
<span class="lineNum">      53 </span>            : 
<a name="54"><span class="lineNum">      54 </span>            : //#include &lt;fstream.h&gt;</a>
<span class="lineNum">      55 </span>            : 
<a name="56"><span class="lineNum">      56 </span><span class="lineCov">          6 : ClassImp( AliTPCtrackerCA )</span></a>
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            : AliTPCtrackerCA::AliTPCtrackerCA()
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :     : AliTracker(), fkParam( 0 ), fClusters( 0 ), fClusterSliceRow( 0 ), fNClusters( 0 ), fDoHLTPerformance( 0 ), fDoHLTPerformanceClusters( 0 ), fStatCPUTime( 0 ), fStatRealTime( 0 ), fStatNEvents( 0 )</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      61 </span>            :   //* default constructor
<a name="62"><span class="lineNum">      62 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            : AliTPCtrackerCA::~AliTPCtrackerCA()
<span class="lineNum">      65 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      66 </span>            :   //* destructor
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :   delete[] fClusters;</span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :   delete[] fClusterSliceRow;</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      70 </span>            : 
<a name="71"><span class="lineNum">      71 </span>            : //#include &quot;AliHLTTPCCADisplay.h&quot;</a>
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            : AliTPCtrackerCA::AliTPCtrackerCA( const AliTPCParam *par ):
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :     AliTracker(), fkParam( par ), fClusters( 0 ), fClusterSliceRow( 0 ), fNClusters( 0 ), fDoHLTPerformance( 0 ), fDoHLTPerformanceClusters( 0 ), fStatCPUTime( 0 ), fStatRealTime( 0 ), fStatNEvents( 0 )</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      76 </span>            :   //* constructor
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :   fDoHLTPerformance = 0;</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :   fDoHLTPerformanceClusters = 0;</span>
<span class="lineNum">      80 </span>            : 
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :   AliHLTTPCCAStandaloneFramework &amp;hlt = AliHLTTPCCAStandaloneFramework::Instance();</span>
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            : 
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :   for ( int iSlice = 0; iSlice &lt; hlt.NSlices(); iSlice++ ) {</span>
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :     float bz = AliTracker::GetBz();</span>
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :     float inRmin = fkParam-&gt;GetInnerRadiusLow();</span>
<span class="lineNum">      89 </span>            :     //float inRmax = fkParam-&gt;GetInnerRadiusUp();
<span class="lineNum">      90 </span>            :     //float outRmin = fkParam-&gt;GetOuterRadiusLow();
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :     float outRmax = fkParam-&gt;GetOuterRadiusUp();</span>
<span class="lineNum">      92 </span>            :     float plusZmin = 0.0529937;
<span class="lineNum">      93 </span>            :     float plusZmax = 249.778;
<span class="lineNum">      94 </span>            :     float minusZmin = -249.645;
<span class="lineNum">      95 </span>            :     float minusZmax = -0.0799937;
<span class="lineNum">      96 </span>            :     float dalpha = 0.349066;
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :     float alpha = 0.174533 + dalpha * iSlice;</span>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :     bool zPlus = ( iSlice &lt; 18 );</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     float zMin =  zPlus ? plusZmin : minusZmin;</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     float zMax =  zPlus ? plusZmax : minusZmax;</span>
<span class="lineNum">     102 </span>            :     //TPCZmin = -249.645, ZMax = 249.778
<span class="lineNum">     103 </span>            :     //float rMin =  inRmin;
<span class="lineNum">     104 </span>            :     //float rMax =  outRmax;
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :     float padPitch = 0.4;
<span class="lineNum">     107 </span>            :     float sigmaZ = 0.228808;
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :     int nRows = fkParam-&gt;GetNRowLow() + fkParam-&gt;GetNRowUp();</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :     int dimRowX=fkParam-&gt;GetNRowLow()+fkParam-&gt;GetNRowUp();</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :     std::auto_ptr&lt;float&gt; rowX(new float[dimRowX]);</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     for ( int irow = 0; irow &lt; fkParam-&gt;GetNRowLow(); irow++ ) {</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :       (rowX.get())[irow] = fkParam-&gt;GetPadRowRadiiLow( irow );</span>
<span class="lineNum">     114 </span>            :     }
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     for ( int irow = 0; irow &lt; fkParam-&gt;GetNRowUp(); irow++ ) {</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :       (rowX.get())[fkParam-&gt;GetNRowLow()+irow] = fkParam-&gt;GetPadRowRadiiUp( irow );</span>
<span class="lineNum">     117 </span>            :     }
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     AliHLTTPCCAParam param;</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :     param.Initialize( iSlice, nRows, rowX.get(), alpha, dalpha,</span>
<span class="lineNum">     120 </span>            :                       inRmin, outRmax, zMin, zMax, padPitch, sigmaZ, bz );
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :     param.SetHitPickUpFactor( 1. );</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :     param.SetMaxTrackMatchDRow( 5 );</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :     param.SetTrackConnectionFactor( 3.5 );</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     param.SetMinNTrackClusters( 30 );</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     param.SetMinTrackPt(0.2);</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     AliTPCClusterParam * clparam = AliTPCcalibDB::Instance()-&gt;GetClusterParam();</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :     for ( int iRow = 0; iRow &lt; nRows; iRow++ ) {</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :       int    type = ( iRow &lt; 63 ) ? 0 : ( ( iRow &gt; 126 ) ? 1 : 2 );</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :       for ( int iyz = 0; iyz &lt; 2; iyz++ ) {</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :         for ( int k = 0; k &lt; 7; k++ ) {</span>
<span class="lineNum">     131 </span>            :           //std::cout&lt;&lt;param.fParamS0Par[iyz][type][k]&lt;&lt;&quot; &quot;&lt;&lt;clparam-&gt;fParamS0Par[iyz][type][k] - param.fParamS0Par[iyz][type][k]&lt;&lt;std::endl;
<span class="lineNum">     132 </span>            : #ifndef HAVE_NOT_ALITPCCLUSTERPARAM_r40128
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :           param.SetParamS0Par( iyz, type, k, clparam-&gt;ParamS0Par(iyz, type, k));</span>
<span class="lineNum">     134 </span>            : #else
<span class="lineNum">     135 </span>            :           param.SetParamS0Par( iyz, type, k, clparam-&gt;fParamS0Par[iyz][type][k] );
<span class="lineNum">     136 </span>            : #endif //HAVE_NOT_ALITPCCLUSTERPARAM_r40128
<span class="lineNum">     137 </span>            :         }
<span class="lineNum">     138 </span>            :       }
<span class="lineNum">     139 </span>            :     }
<span class="lineNum">     140 </span>            :     //hlt.SliceTracker( iSlice ).Initialize( param );
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :         hlt.InitializeSliceParam(iSlice, param);</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     144 </span>            : 
<a name="145"><span class="lineNum">     145 </span>            : </a>
<span class="lineNum">     146 </span>            : 
<span class="lineNum">     147 </span>            : int AliTPCtrackerCA::LoadClusters ( TTree * fromTree )
<span class="lineNum">     148 </span>            : {
<span class="lineNum">     149 </span>            :   // load clusters to the local arrays
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :   fNClusters = 0;</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   delete[] fClusters;</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :   delete[] fClusterSliceRow;</span>
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   AliHLTTPCCAStandaloneFramework &amp;hlt = AliHLTTPCCAStandaloneFramework::Instance();</span>
<span class="lineNum">     155 </span>            : 
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   if ( fDoHLTPerformance ) {</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :     AliHLTTPCCAPerformance::Instance().StartEvent();</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :     if ( fDoHLTPerformanceClusters ) AliHLTTPCCAPerformance::Instance().SetDoClusterPulls( 1 );</span>
<span class="lineNum">     159 </span>            :   }
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   if ( !fkParam ) return 1;</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span>            :   // load mc tracks
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :   while ( fDoHLTPerformance ) {</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     if ( !gAlice ) break;</span>
<span class="lineNum">     166 </span>            : #ifndef HAVE_NOT_ALIRUNLOADER30859
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :     AliRunLoader *rl = AliRunLoader::Instance();//gAlice-&gt;GetRunLoader();</span>
<span class="lineNum">     168 </span>            : #else
<span class="lineNum">     169 </span>            :     // the old way before rev 30859
<span class="lineNum">     170 </span>            :     AliRunLoader *rl = AliRunLoader::GetRunLoader();
<span class="lineNum">     171 </span>            : #endif
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :     if ( !rl ) break;</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :     rl-&gt;LoadKinematics();</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :     AliStack *stack = rl-&gt;Stack();</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     if ( !stack ) break;</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     int nMCtracks = stack-&gt;GetNtrack();</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     if( nMCtracks&lt;0 || nMCtracks&gt;10000000 ) nMCtracks = 0;</span>
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :     AliHLTTPCCAPerformance::Instance().SetNMCTracks( nMCtracks );</span>
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     for ( int itr = 0; itr &lt; nMCtracks; itr++ ) {</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :       TParticle *part = stack-&gt;Particle( itr );</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :       AliHLTTPCCAPerformance::Instance().ReadMCTrack( itr, part );</span>
<span class="lineNum">     184 </span>            :     }
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span>            :     { // check for MC tracks at the TPC entrance
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :       rl-&gt;LoadTrackRefs();</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :       TTree *mcTree = rl-&gt;TreeTR();</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :       if ( !mcTree ) break;</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :       TBranch *branch = mcTree-&gt;GetBranch( &quot;TrackReferences&quot; );</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :       if ( !branch ) break;</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :       TClonesArray tpcdummy( &quot;AliTrackReference&quot;, 1000 ), *tpcRefs = &amp;tpcdummy;</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :       branch-&gt;SetAddress( &amp;tpcRefs );</span>
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :       bool *isTPC = new bool [nMCtracks];</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :       for ( int i = 0; i &lt; nMCtracks; i++ ) isTPC[i] = 0;</span>
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :       int nr = ( int )mcTree-&gt;GetEntries();</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :       for ( int r = 0; r &lt; nr; r++ ) {</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :         mcTree-&gt;GetEvent( r );</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :         int nref = tpcRefs-&gt;GetEntriesFast();</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :         if ( !nref ) continue;</span>
<span class="lineNum">     204 </span>            :         AliTrackReference *tpcRef = 0x0;
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :         for ( int iref = 0; iref &lt; nref; ++iref ) {</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :           tpcRef = ( AliTrackReference* )tpcRefs-&gt;UncheckedAt( iref );</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :           if ( tpcRef-&gt;DetectorId() == AliTrackReference::kTPC ) break;</span>
<span class="lineNum">     208 </span>            :           tpcRef = 0x0;
<span class="lineNum">     209 </span>            :         }
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :         if ( !tpcRef ) continue;</span>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :         if ( isTPC[tpcRef-&gt;Label()] ) continue;</span>
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :         AliHLTTPCCAPerformance::Instance().ReadMCTPCTrack( tpcRef-&gt;Label(),</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :             tpcRef-&gt;X(), tpcRef-&gt;Y(), tpcRef-&gt;Z(),</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :             tpcRef-&gt;Px(), tpcRef-&gt;Py(), tpcRef-&gt;Pz() );</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :         isTPC[tpcRef-&gt;Label()] = 1;</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :         tpcRefs-&gt;Clear();</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :       delete[] isTPC;</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     222 </span>            : 
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :     while ( fDoHLTPerformanceClusters ) {</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :       AliTPCLoader *tpcl = ( AliTPCLoader* ) rl-&gt;GetDetectorLoader( &quot;TPC&quot; );</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :       if ( !tpcl ) break;</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :       if ( tpcl-&gt;TreeH() == 0x0 ) {</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :         if ( tpcl-&gt;LoadHits() ) break;</span>
<span class="lineNum">     228 </span>            :       }
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :       if ( tpcl-&gt;TreeH() == 0x0 ) break;</span>
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :       AliTPC *tpc = ( AliTPC* ) gAlice-&gt;GetDetector( &quot;TPC&quot; );</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :       int nEnt = ( int )tpcl-&gt;TreeH()-&gt;GetEntries();</span>
<span class="lineNum">     233 </span>            :       int nPoints = 0;
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :       for ( int iEnt = 0; iEnt &lt; nEnt; iEnt++ ) {</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :         tpc-&gt;ResetHits();</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :         tpcl-&gt;TreeH()-&gt;GetEvent( iEnt );</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :         AliTPChit *phit = ( AliTPChit* )tpc-&gt;FirstHit( -1 );</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :         for ( ; phit; phit = ( AliTPChit* )tpc-&gt;NextHit() ) nPoints++;</span>
<span class="lineNum">     239 </span>            :       }
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :       AliHLTTPCCAPerformance::Instance().SetNMCPoints( nPoints );</span>
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :       for ( int iEnt = 0; iEnt &lt; nEnt; iEnt++ ) {</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :         tpc-&gt;ResetHits();</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :         tpcl-&gt;TreeH()-&gt;GetEvent( iEnt );</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         AliTPChit *phit = ( AliTPChit* )tpc-&gt;FirstHit( -1 );</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :         for ( ; phit; phit = ( AliTPChit* )tpc-&gt;NextHit() ) {</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :           AliHLTTPCCAPerformance::Instance().ReadMCPoint( phit-&gt;GetTrack(), phit-&gt;X(), phit-&gt;Y(), phit-&gt;Z(), phit-&gt;Time(), phit-&gt;fSector % 36 );</span>
<span class="lineNum">     248 </span>            :         }
<span class="lineNum">     249 </span>            :       }
<span class="lineNum">     250 </span>            :       break;
<span class="lineNum">     251 </span>            :     }
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     253 </span>            :   }
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :   TBranch * br = fromTree-&gt;GetBranch( &quot;Segment&quot; );</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :   if ( !br ) return 1;</span>
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :   AliTPCClustersRow *clrow = new AliTPCClustersRow;</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :   clrow-&gt;SetClass( &quot;AliTPCclusterMI&quot; );</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :   clrow-&gt;SetArray( 0 );</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :   clrow-&gt;GetArray()-&gt;ExpandCreateFast( 10000 );</span>
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :   br-&gt;SetAddress( &amp;clrow );</span>
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span>            :   //
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :   int nEnt = int( fromTree-&gt;GetEntries() );</span>
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :   fNClusters = 0;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :   for ( int i = 0; i &lt; nEnt; i++ ) {</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     br-&gt;GetEntry( i );</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     int sec, row;</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     fkParam-&gt;AdjustSectorRow( clrow-&gt;GetID(), sec, row );</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     fNClusters += clrow-&gt;GetArray()-&gt;GetEntriesFast();</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   fClusters = new AliTPCclusterMI [fNClusters];</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   fClusterSliceRow = new unsigned int [fNClusters];</span>
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   hlt.StartDataReading( fNClusters );</span>
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :   if ( fDoHLTPerformance ) AliHLTTPCCAPerformance::Instance().SetNHits( fNClusters );</span>
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span>            :   int ind = 0;
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :   for ( int i = 0; i &lt; nEnt; i++ ) {</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     br-&gt;GetEntry( i );</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     int sec, row;</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :     fkParam-&gt;AdjustSectorRow( clrow-&gt;GetID(), sec, row );</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     int nClu = clrow-&gt;GetArray()-&gt;GetEntriesFast();</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :     float x = fkParam-&gt;GetPadRowRadii( sec, row );</span>
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :     if ( sec &gt;= 36 ) {</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :       sec = sec - 36;</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :       row = row + fkParam-&gt;GetNRowLow();</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :     unsigned int sliceRow = ( sec &lt;&lt; 8 ) + row;</span>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :     for ( int icl = 0; icl &lt; nClu; icl++ ) {</span>
<span class="lineNum">     299 </span>            :       int lab0 = -1;
<span class="lineNum">     300 </span>            :       int lab1 = -1;
<span class="lineNum">     301 </span>            :       int lab2 = -1;
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :       AliTPCclusterMI* cluster = ( AliTPCclusterMI* )( clrow-&gt;GetArray()-&gt;At( icl ) );</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :       if ( !cluster ) continue;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :       lab0 = cluster-&gt;GetLabel( 0 );</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :       lab1 = cluster-&gt;GetLabel( 1 );</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :       lab2 = cluster-&gt;GetLabel( 2 );</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :       AliTPCTransform *transform = AliTPCcalibDB::Instance()-&gt;GetTransform() ; </span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :       if ( !transform ) {</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :         AliFatal( &quot;Tranformations not in calibDB&quot; );</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     312 </span>            :       }
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :       transform-&gt;SetCurrentRecoParam((AliTPCRecoParam*)AliTPCReconstructor::GetRecoParam());</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :       double xx[3] = {static_cast&lt;double&gt;(cluster-&gt;GetRow()), cluster-&gt;GetPad(), cluster-&gt;GetTimeBin()};</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :       int id[1] = {cluster-&gt;GetDetector()};</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :       transform-&gt;Transform( xx, id, 0, 1 );</span>
<span class="lineNum">     318 </span>            : 
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :       cluster-&gt;SetX( xx[0] );</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :       cluster-&gt;SetY( xx[1] );</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :       cluster-&gt;SetZ( xx[2] );</span>
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :       TGeoHMatrix  *mat = fkParam-&gt;GetClusterMatrix( cluster-&gt;GetDetector() );</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :       double pos[3] = {cluster-&gt;GetX(), cluster-&gt;GetY(), cluster-&gt;GetZ()};</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :       double posC[3] = {cluster-&gt;GetX(), cluster-&gt;GetY(), cluster-&gt;GetZ()};</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :       if ( mat ) mat-&gt;LocalToMaster( pos, posC );</span>
<span class="lineNum">     327 </span>            :       else {
<span class="lineNum">     328 </span>            :         // chack Loading of Geo matrices from GeoManager - TEMPORARY FIX
<span class="lineNum">     329 </span>            :       }
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :       cluster-&gt;SetX( posC[0] );</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :       cluster-&gt;SetY( posC[1] );</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :       cluster-&gt;SetZ( posC[2] );</span>
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :       x = cluster-&gt;GetX();</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       float y = cluster-&gt;GetY();</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :       float z = cluster-&gt;GetZ();</span>
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :       int index = ind++;</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :       fClusters[index] = *cluster;</span>
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :       fClusterSliceRow[index] = sliceRow;</span>
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :       hlt.ReadCluster( index, sec, row, x, y, z, cluster-&gt;GetQ() );</span>
<span class="lineNum">     345 </span>            : 
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :       if ( fDoHLTPerformance ) AliHLTTPCCAPerformance::Instance().ReadHitLabel( index, lab0, lab1, lab2 );</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :   delete clrow;</span>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :   hlt.FinishDataReading();</span>
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span>            :   //AliHLTTPCCAPerformance::Instance().SmearClustersMC();
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            :   return 0;
<a name="356"><span class="lineNum">     356 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            : AliCluster * AliTPCtrackerCA::GetCluster( int index ) const
<span class="lineNum">     359 </span>            : {
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   return &amp;( fClusters[index] );</span>
<a name="361"><span class="lineNum">     361 </span>            : }</a>
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span>            : int AliTPCtrackerCA::Clusters2Tracks( AliESDEvent *event )
<span class="lineNum">     364 </span>            : {
<span class="lineNum">     365 </span>            :   // reconstruction
<span class="lineNum">     366 </span>            :   //cout&lt;&lt;&quot;Start of AliTPCtrackerCA&quot;&lt;&lt;endl;
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :   TStopwatch timer;</span>
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :   AliHLTTPCCAStandaloneFramework &amp;hlt = AliHLTTPCCAStandaloneFramework::Instance();</span>
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   hlt.ProcessEvent();</span>
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :   if ( event ) {  </span>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     for ( int itr = 0; itr &lt; hlt.Merger().NOutputTracks(); itr++ ) {</span>
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :       AliTPCseed tTPC;</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :       const AliHLTTPCGMMergedTrack &amp;tCA = hlt.Merger().OutputTracks()[itr];</span>
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :       AliHLTTPCGMTrackParam par = tCA.GetParam();      </span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :       par.GetExtParam( tTPC, tCA.GetAlpha() );</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :       tTPC.SetMass( 0.13957 );</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :       if ( TMath::Abs( tTPC.GetSigned1Pt() ) &gt; 1. / 0.02 ) continue;</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :       int nhits = tCA.NClusters();</span>
<span class="lineNum">     386 </span>            :       int firstHit = 0;
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :       if ( nhits &gt; 160 ) {</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :         firstHit = nhits - 160;</span>
<span class="lineNum">     389 </span>            :         nhits = 160;
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :       tTPC.SetNumberOfClusters( nhits );</span>
<span class="lineNum">     392 </span>            :       //float alpha = tCA.GetAlpha();
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :       AliHLTTPCGMTrackParam t0 = par;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :       for ( int ih = 0; ih &lt; nhits; ih++ ) {</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         int index = hlt.Merger().OutputClusterIds()[ tCA.FirstClusterRef() + firstHit + ih ];</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         tTPC.SetClusterIndex( ih, index );</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         AliTPCclusterMI *c = &amp;( fClusters[index] );</span>
<span class="lineNum">     398 </span>            :         //int iSlice = fClusterSliceRow[index] &gt;&gt; 8;
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         int row = fClusterSliceRow[index] &amp; 0xff;</span>
<span class="lineNum">     400 </span>            : 
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :         tTPC.SetClusterPointer( row, c );</span>
<span class="lineNum">     402 </span>            :         /*
<span class="lineNum">     403 </span>            :         AliTPCTrackerPoint &amp;point = *( tTPC.GetTrackPoint( row ) );
<span class="lineNum">     404 </span>            :         {
<span class="lineNum">     405 </span>            :           //AliHLTTPCCATracker &amp;slice = hlt.SliceTracker( iSlice );
<span class="lineNum">     406 </span>            :           if ( hlt.Param(iSlice).Alpha() != alpha ) {
<span class="lineNum">     407 </span>            :             if ( ! t0.Rotate(  hlt.Param(iSlice).Alpha() - alpha, .999 ) ) continue;
<span class="lineNum">     408 </span>            :             alpha = hlt.Param(iSlice).Alpha();
<span class="lineNum">     409 </span>            :           }
<span class="lineNum">     410 </span>            :           float x = hlt.Row(iSlice, row).X();
<span class="lineNum">     411 </span>            :           if ( !t0.TransportToX( x, hlt.Param(iSlice).GetBz( t0 ), .999 ) ) continue;
<span class="lineNum">     412 </span>            :           float sy2, sz2;
<span class="lineNum">     413 </span>            :           //slice.GetErrors2( row, t0, sy2, sz2 );
<span class="lineNum">     414 </span>            :                   hlt.Param(iSlice).GetClusterErrors2( row, t0.GetZ(), t0.SinPhi(), t0.GetCosPhi(), t0.DzDs(), sy2, sz2 );
<span class="lineNum">     415 </span>            :           point.SetSigmaY( c-&gt;GetSigmaY2() / sy2 );
<span class="lineNum">     416 </span>            :           point.SetSigmaZ( c-&gt;GetSigmaZ2() / sz2 );
<span class="lineNum">     417 </span>            :           point.SetAngleY( TMath::Abs( t0.GetSinPhi() / t0.GetCosPhi() ) );
<span class="lineNum">     418 </span>            :           point.SetAngleZ( TMath::Abs( t0.GetDzDs() ) );
<span class="lineNum">     419 </span>            :         }
<span class="lineNum">     420 </span>            :         */
<span class="lineNum">     421 </span>            :       }
<span class="lineNum">     422 </span>            :       //tTPC.CookdEdx( 0.02, 0.6 );
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :       CookLabel( &amp;tTPC, 0.1 );</span>
<span class="lineNum">     425 </span>            :       
<span class="lineNum">     426 </span>            :       if ( 1 ) { // correction like in off-line --- Adding systematic error
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :         const double *param = AliTPCReconstructor::GetRecoParam()-&gt;GetSystematicError();</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         double covar[15];</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :         for ( int i = 0; i &lt; 15; i++ ) covar[i] = 0;</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :         covar[0] = param[0] * param[0];</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :         covar[2] = param[1] * param[1];</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :         covar[5] = param[2] * param[2];</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :         covar[9] = param[3] * param[3];</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :         double facC =  AliTracker::GetBz() * kB2C;</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :         covar[14] = param[4] * param[4] * facC * facC;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :         tTPC.AddCovariance( covar );</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :       AliESDtrack tESD;</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :       tESD.UpdateTrackParams( &amp;( tTPC ), AliESDtrack::kTPCin );</span>
<span class="lineNum">     442 </span>            :       //tESD.SetStatus( AliESDtrack::kTPCrefit );
<span class="lineNum">     443 </span>            :       //tESD.SetTPCPoints(tTPC.GetPoints());
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :       int   ndedx = tTPC.GetNCDEDX( 0 );</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :       float sdedx = tTPC.GetSDEDX( 0 );</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :       float dedx  = tTPC.GetdEdx();</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :       tESD.SetTPCsignal( dedx, sdedx, ndedx );</span>
<span class="lineNum">     448 </span>            :       //tESD.myTPC = tTPC;
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :       event-&gt;AddTrack( &amp;tESD );</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :   timer.Stop();</span>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :   fStatCPUTime += timer.CpuTime();</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   fStatRealTime += timer.RealTime();</span>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span>            :   //cout &lt;&lt; &quot;\n\nCA tracker speed: cpu = &quot; &lt;&lt; fStatCPUTime / ( fStatNEvents + 1 )*1.e3 &lt;&lt; &quot; [ms/ev], real = &quot; &lt;&lt; fStatRealTime / ( fStatNEvents + 1 )*1.e3 &lt;&lt; &quot; [ms/ev], n calls = &quot; &lt;&lt; ( fStatNEvents + 1 ) &lt;&lt; endl &lt;&lt; endl;
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span>            :   //cout&lt;&lt;&quot;Do performance..&quot;&lt;&lt;endl;
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :   if ( fDoHLTPerformance ) AliHLTTPCCAPerformance::Instance().Performance();</span>
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span>            :   if ( 0 ) {// Write Event
<span class="lineNum">     468 </span>            :     if ( fStatNEvents == 0 ) {
<span class="lineNum">     469 </span>            :       fstream geo;
<span class="lineNum">     470 </span>            :       geo.open( &quot;CAEvents/settings.dat&quot;, ios::out );
<span class="lineNum">     471 </span>            :       if ( geo.is_open() ) {
<span class="lineNum">     472 </span>            :         hlt.WriteSettings( geo );
<span class="lineNum">     473 </span>            :       }
<span class="lineNum">     474 </span>            :       geo.close();
<span class="lineNum">     475 </span>            :     }
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span>            :     fstream hits;
<span class="lineNum">     478 </span>            :     char name[255];
<span class="lineNum">     479 </span>            :     sprintf( name, &quot;CAEvents/%i.event.dat&quot;, fStatNEvents );
<span class="lineNum">     480 </span>            :     hits.open( name, ios::out );
<span class="lineNum">     481 </span>            :     if ( hits.is_open() ) {
<span class="lineNum">     482 </span>            :       hlt.WriteEvent( hits );
<span class="lineNum">     483 </span>            :       fstream tracks;
<span class="lineNum">     484 </span>            :       sprintf( name, &quot;CAEvents/%i.tracks.dat&quot;, fStatNEvents );
<span class="lineNum">     485 </span>            :       tracks.open( name, ios::out );
<span class="lineNum">     486 </span>            :       hlt.WriteTracks( tracks );
<span class="lineNum">     487 </span>            :     }
<span class="lineNum">     488 </span>            :     hits.close();
<span class="lineNum">     489 </span>            :     if ( fDoHLTPerformance ) {
<span class="lineNum">     490 </span>            :       fstream mcevent, mcpoints;
<span class="lineNum">     491 </span>            :       char mcname[255];
<span class="lineNum">     492 </span>            :       sprintf( mcname, &quot;CAEvents/%i.mcevent.dat&quot;, fStatNEvents );
<span class="lineNum">     493 </span>            :       mcevent.open( mcname, ios::out );
<span class="lineNum">     494 </span>            :       if ( mcevent.is_open() ) {
<span class="lineNum">     495 </span>            :         AliHLTTPCCAPerformance::Instance().WriteMCEvent( mcevent );
<span class="lineNum">     496 </span>            :       }
<span class="lineNum">     497 </span>            :       if ( 1 &amp;&amp; fDoHLTPerformanceClusters ) {
<span class="lineNum">     498 </span>            :         sprintf( mcname, &quot;CAEvents/%i.mcpoints.dat&quot;, fStatNEvents );
<span class="lineNum">     499 </span>            :         mcpoints.open( mcname, ios::out );
<span class="lineNum">     500 </span>            :         if ( mcpoints.is_open() ) {
<span class="lineNum">     501 </span>            :           AliHLTTPCCAPerformance::Instance().WriteMCPoints( mcpoints );
<span class="lineNum">     502 </span>            :         }
<span class="lineNum">     503 </span>            :         mcpoints.close();
<span class="lineNum">     504 </span>            :       }
<span class="lineNum">     505 </span>            :       mcevent.close();
<span class="lineNum">     506 </span>            :     }
<span class="lineNum">     507 </span>            :   }
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :   fStatNEvents++;</span>
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span>            :   //cout&lt;&lt;&quot;End of AliTPCtrackerCA&quot;&lt;&lt;endl;
<span class="lineNum">     513 </span>            :   return 0;
<span class="lineNum">     514 </span><span class="lineNoCov">          0 : }</span>
<a name="515"><span class="lineNum">     515 </span>            : </a>
<span class="lineNum">     516 </span>            : 
<span class="lineNum">     517 </span>            : int AliTPCtrackerCA::RefitInward ( AliESDEvent * /*event*/ )
<span class="lineNum">     518 </span>            : {
<span class="lineNum">     519 </span>            :   //* forward propagation of ESD tracks
<span class="lineNum">     520 </span>            : #ifdef XXX
<span class="lineNum">     521 </span>            :   float xTPC = fkParam-&gt;GetInnerRadiusLow();
<span class="lineNum">     522 </span>            :   float dAlpha = fkParam-&gt;GetInnerAngle() / 180.*TMath::Pi();
<span class="lineNum">     523 </span>            :   float yMax = xTPC * TMath::Tan( dAlpha / 2. );
<span class="lineNum">     524 </span>            : 
<span class="lineNum">     525 </span>            :   AliHLTTPCCAStandaloneFramework &amp;hlt = AliHLTTPCCAStandaloneFramework::Instance();
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span>            :   int nentr = event-&gt;GetNumberOfTracks();
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span>            :   for ( int itr = 0; itr &lt; nentr; itr++ ) {
<span class="lineNum">     530 </span>            :     AliESDtrack *esd = event-&gt;GetTrack( itr );
<span class="lineNum">     531 </span>            :     ULong_t status = esd-&gt;GetStatus();
<span class="lineNum">     532 </span>            :     if ( !( status&amp;AliESDtrack::kTPCin ) ) continue;
<span class="lineNum">     533 </span>            :     AliHLTTPCCATrackParam t0;
<span class="lineNum">     534 </span>            :     AliHLTTPCCATrackConvertor::SetExtParam( t0, *esd );
<span class="lineNum">     535 </span>            :     AliHLTTPCCATrackParam t = t0;
<span class="lineNum">     536 </span>            :     float alpha = esd-&gt;GetAlpha();
<span class="lineNum">     537 </span>            :     //float dEdX=0;
<span class="lineNum">     538 </span>            :     AliHLTTPCCAMerger::AliHLTTPCCAClusterInfo infos[500];
<span class="lineNum">     539 </span>            :     int hits[500], hits1[500];
<span class="lineNum">     540 </span>            :     int nHits = esd-&gt;GetTPCclusters( hits );
<span class="lineNum">     541 </span>            :     for ( int i = 0; i &lt; nHits; i++ ) {
<span class="lineNum">     542 </span>            :       hits1[i] = i;
<span class="lineNum">     543 </span>            :       int index = hits[i];
<span class="lineNum">     544 </span>            :       infos[i].SetISlice( fClusterSliceRow[index] &gt;&gt; 8 );
<span class="lineNum">     545 </span>            :       int row = fClusterSliceRow[index] &amp; 0xff;
<span class="lineNum">     546 </span>            :       int type = ( row &lt; 63 ) ? 0 : ( ( row &gt; 126 ) ? 1 : 2 );
<span class="lineNum">     547 </span>            :       infos[i].SetRowType( type );
<span class="lineNum">     548 </span>            :       infos[i].SetId( index );
<span class="lineNum">     549 </span>            :       infos[i].SetX( fClusters[index].GetX() );
<span class="lineNum">     550 </span>            :       infos[i].SetY( fClusters[index].GetY() );
<span class="lineNum">     551 </span>            :       infos[i].SetZ( fClusters[index].GetZ() );
<span class="lineNum">     552 </span>            :     }
<span class="lineNum">     553 </span>            : 
<span class="lineNum">     554 </span>            :     bool ok = hlt.Merger().FitTrack( t, alpha, t0, alpha, hits1, nHits, 0, 1,infos );
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span>            :     if ( ok &amp;&amp;  nHits &gt; 15 ) {
<span class="lineNum">     557 </span>            :       if ( t.TransportToXWithMaterial( xTPC, hlt.Merger().SliceParam().GetBz( t ) ) ) {
<span class="lineNum">     558 </span>            :         if ( t.GetY() &gt; yMax ) {
<span class="lineNum">     559 </span>            :           if ( t.Rotate( dAlpha ) ) {
<span class="lineNum">     560 </span>            :             alpha += dAlpha;
<span class="lineNum">     561 </span>            :             t.TransportToXWithMaterial( xTPC, hlt.Merger().SliceParam().GetBz( t ) );
<span class="lineNum">     562 </span>            :           }
<span class="lineNum">     563 </span>            :         } else if ( t.GetY() &lt; -yMax ) {
<span class="lineNum">     564 </span>            :           if ( t.Rotate( -dAlpha ) ) {
<span class="lineNum">     565 </span>            :             alpha += -dAlpha;
<span class="lineNum">     566 </span>            :             t.TransportToXWithMaterial( xTPC, hlt.Merger().SliceParam().GetBz( t ) );
<span class="lineNum">     567 </span>            :           }
<span class="lineNum">     568 </span>            :         }
<span class="lineNum">     569 </span>            :       }
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span>            :       AliTPCtrack tt( *esd );
<span class="lineNum">     572 </span>            :       if ( AliHLTTPCCATrackConvertor::GetExtParam( t, tt, alpha ) ) {
<span class="lineNum">     573 </span>            :         if ( t.X() &gt; 50 ) esd-&gt;UpdateTrackParams( &amp;tt, AliESDtrack::kTPCrefit );
<span class="lineNum">     574 </span>            :       }
<span class="lineNum">     575 </span>            :     }
<span class="lineNum">     576 </span>            :   }
<span class="lineNum">     577 </span>            : #endif
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="579"><span class="lineNum">     579 </span>            : }</a>
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span>            : int AliTPCtrackerCA::PropagateBack( AliESDEvent * /*event*/ )
<span class="lineNum">     582 </span>            : {
<span class="lineNum">     583 </span>            :   //* backward propagation of ESD tracks
<span class="lineNum">     584 </span>            : #ifdef XXX
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span>            :   AliHLTTPCCAStandaloneFramework &amp;hlt = AliHLTTPCCAStandaloneFramework::Instance();
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span>            :   int nentr = event-&gt;GetNumberOfTracks();
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span>            :   for ( int itr = 0; itr &lt; nentr; itr++ ) {
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span>            :     AliESDtrack *esd = event-&gt;GetTrack( itr );
<span class="lineNum">     593 </span>            :     ULong_t status = esd-&gt;GetStatus();
<span class="lineNum">     594 </span>            :     if ( !( status&amp;AliESDtrack::kTPCin ) ) continue;
<span class="lineNum">     595 </span>            : 
<span class="lineNum">     596 </span>            :     AliHLTTPCCATrackParam t0;
<span class="lineNum">     597 </span>            :     AliHLTTPCCATrackConvertor::SetExtParam( t0, *esd  );
<span class="lineNum">     598 </span>            :     AliHLTTPCCATrackParam t = t0;
<span class="lineNum">     599 </span>            :     float alpha = esd-&gt;GetAlpha();
<span class="lineNum">     600 </span>            :     //float dEdX=0;
<span class="lineNum">     601 </span>            :     AliHLTTPCCAMerger::AliHLTTPCCAClusterInfo infos[500];
<span class="lineNum">     602 </span>            :     int hits[500], hits1[500];
<span class="lineNum">     603 </span>            :     int nHits = esd-&gt;GetTPCclusters( hits );
<span class="lineNum">     604 </span>            :     for ( int i = 0; i &lt; nHits; i++ ) {
<span class="lineNum">     605 </span>            :       hits1[i] = i;
<span class="lineNum">     606 </span>            :       int index = hits[i];
<span class="lineNum">     607 </span>            :       infos[i].SetISlice( fClusterSliceRow[index] &gt;&gt; 8 );
<span class="lineNum">     608 </span>            :       int row = fClusterSliceRow[index] &amp; 0xff;
<span class="lineNum">     609 </span>            :       int type = ( row &lt; 63 ) ? 0 : ( ( row &gt; 126 ) ? 1 : 2 );
<span class="lineNum">     610 </span>            :       infos[i].SetRowType( type );
<span class="lineNum">     611 </span>            :       infos[i].SetId( index );
<span class="lineNum">     612 </span>            :       infos[i].SetX( fClusters[index].GetX() );
<span class="lineNum">     613 </span>            :       infos[i].SetY( fClusters[index].GetY() );
<span class="lineNum">     614 </span>            :       infos[i].SetZ( fClusters[index].GetZ() );
<span class="lineNum">     615 </span>            :     }
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            :     bool ok = hlt.Merger().FitTrack( t, alpha, t0, alpha, hits1, nHits, 1, 1, infos );
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span>            :     if ( ok &amp;&amp;  nHits &gt; 15 ) {
<span class="lineNum">     620 </span>            :       AliTPCtrack tt( *esd );
<span class="lineNum">     621 </span>            :       if ( AliHLTTPCCATrackConvertor::GetExtParam( t, tt, alpha ) ) {
<span class="lineNum">     622 </span>            :         if ( t.X() &gt; 50 ) esd-&gt;UpdateTrackParams( &amp;tt, AliESDtrack::kTPCout );
<span class="lineNum">     623 </span>            :       }
<span class="lineNum">     624 </span>            :     }
<span class="lineNum">     625 </span>            :   }
<span class="lineNum">     626 </span>            : #endif
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     628 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
