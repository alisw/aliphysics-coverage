<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - STEER/ESD/AliKFParticleBase.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">STEER/ESD</a> - AliKFParticleBase.cxx<span style="font-size: 80%;"> (source / <a href="AliKFParticleBase.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">681</td>
            <td class="headerCovTableEntry">1716</td>
            <td class="headerCovTableEntryLo">39.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">20</td>
            <td class="headerCovTableEntry">49</td>
            <td class="headerCovTableEntryLo">40.8 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : //---------------------------------------------------------------------------------</a>
<span class="lineNum">       2 </span>            : // Implementation of the AliKFParticleBase class
<span class="lineNum">       3 </span>            : // .
<span class="lineNum">       4 </span>            : // @author  S.Gorbunov, I.Kisel, I.Kulakov, M.Zyzak
<span class="lineNum">       5 </span>            : // @version 1.0
<span class="lineNum">       6 </span>            : // @since   13.05.07
<span class="lineNum">       7 </span>            : // 
<span class="lineNum">       8 </span>            : // Class to reconstruct and store the decayed particle parameters.
<span class="lineNum">       9 </span>            : // The method is described in CBM-SOFT note 2007-003, 
<span class="lineNum">      10 </span>            : // ``Reconstruction of decayed particles based on the Kalman filter'', 
<span class="lineNum">      11 </span>            : // http://www.gsi.de/documents/DOC-2007-May-14-1.pdf
<span class="lineNum">      12 </span>            : //
<span class="lineNum">      13 </span>            : // This class describes general mathematics which is used by AliKFParticle class
<span class="lineNum">      14 </span>            : // 
<span class="lineNum">      15 </span>            : //  -= Copyright &amp;copy ALICE HLT Group =-
<span class="lineNum">      16 </span>            : //_________________________________________________________________________________
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : #include &quot;AliKFParticleBase.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;TMath.h&quot;
<a name="21"><span class="lineNum">      21 </span>            : </a>
<span class="lineNum">      22 </span>            : #include &lt;iostream&gt;
<span class="lineNum">      23 </span><span class="lineCov">        172 : ClassImp(AliKFParticleBase)</span>
<a name="24"><span class="lineNum">      24 </span>            : </a>
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span><span class="lineCov">        604 : AliKFParticleBase::AliKFParticleBase() :fQ(0), fNDF(-3), fChi2(0), fSFromDecay(0), fAtProductionVertex(0), fIsLinearized(0),</span>
<span class="lineNum">      27 </span><span class="lineCov">        302 :                                         fConstructMethod(2), SumDaughterMass(0), fMassHypo(-1)</span>
<span class="lineNum">      28 </span><span class="lineCov">        906 : { </span>
<span class="lineNum">      29 </span>            :   //* Constructor 
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span><span class="lineCov">        302 :   Initialize();</span>
<a name="32"><span class="lineNum">      32 </span><span class="lineCov">        302 : }</span></a>
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : void AliKFParticleBase::Initialize( const Double_t Param[], const Double_t Cov[], Int_t Charge, Double_t Mass )
<span class="lineNum">      35 </span>            : {
<span class="lineNum">      36 </span>            :   // Constructor from &quot;cartesian&quot; track, particle mass hypothesis should be provided
<span class="lineNum">      37 </span>            :   //
<span class="lineNum">      38 </span>            :   // Param[6] = { X, Y, Z, Px, Py, Pz } - position and momentum
<span class="lineNum">      39 </span>            :   // Cov [21] = lower-triangular part of the covariance matrix:
<span class="lineNum">      40 </span>            :   //
<span class="lineNum">      41 </span>            :   //                (  0  .  .  .  .  . )
<span class="lineNum">      42 </span>            :   //                (  1  2  .  .  .  . )
<span class="lineNum">      43 </span>            :   //  Cov. matrix = (  3  4  5  .  .  . ) - numbering of covariance elements in Cov[]
<span class="lineNum">      44 </span>            :   //                (  6  7  8  9  .  . )
<span class="lineNum">      45 </span>            :   //                ( 10 11 12 13 14  . )
<span class="lineNum">      46 </span>            :   //                ( 15 16 17 18 19 20 )
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span><span class="lineCov">       1680 :   for( Int_t i=0; i&lt;6 ; i++ ) fP[i] = Param[i];</span>
<span class="lineNum">      50 </span><span class="lineCov">       4928 :   for( Int_t i=0; i&lt;21; i++ ) fC[i] = Cov[i];</span>
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span><span class="lineCov">        112 :   Double_t energy = TMath::Sqrt( Mass*Mass + fP[3]*fP[3] + fP[4]*fP[4] + fP[5]*fP[5]);</span>
<span class="lineNum">      53 </span><span class="lineCov">        112 :   fP[6] = energy;</span>
<span class="lineNum">      54 </span><span class="lineCov">        112 :   fP[7] = 0;</span>
<span class="lineNum">      55 </span><span class="lineCov">        112 :   fQ = Charge;</span>
<span class="lineNum">      56 </span><span class="lineCov">        112 :   fNDF = 0;</span>
<span class="lineNum">      57 </span><span class="lineCov">        112 :   fChi2 = 0;</span>
<span class="lineNum">      58 </span><span class="lineCov">        112 :   fAtProductionVertex = 0;</span>
<span class="lineNum">      59 </span><span class="lineCov">        112 :   fIsLinearized = 0;</span>
<span class="lineNum">      60 </span><span class="lineCov">        112 :   fSFromDecay = 0;</span>
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span><span class="lineCov">        112 :   Double_t energyInv = 1./energy;</span>
<span class="lineNum">      63 </span>            :   Double_t 
<span class="lineNum">      64 </span><span class="lineCov">        112 :     h0 = fP[3]*energyInv,</span>
<span class="lineNum">      65 </span><span class="lineCov">        112 :     h1 = fP[4]*energyInv,</span>
<span class="lineNum">      66 </span><span class="lineCov">        112 :     h2 = fP[5]*energyInv;</span>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span><span class="lineCov">        112 :   fC[21] = h0*fC[ 6] + h1*fC[10] + h2*fC[15];</span>
<span class="lineNum">      69 </span><span class="lineCov">        112 :   fC[22] = h0*fC[ 7] + h1*fC[11] + h2*fC[16];</span>
<span class="lineNum">      70 </span><span class="lineCov">        112 :   fC[23] = h0*fC[ 8] + h1*fC[12] + h2*fC[17];</span>
<span class="lineNum">      71 </span><span class="lineCov">        112 :   fC[24] = h0*fC[ 9] + h1*fC[13] + h2*fC[18];</span>
<span class="lineNum">      72 </span><span class="lineCov">        112 :   fC[25] = h0*fC[13] + h1*fC[14] + h2*fC[19];</span>
<span class="lineNum">      73 </span><span class="lineCov">        112 :   fC[26] = h0*fC[18] + h1*fC[19] + h2*fC[20];</span>
<span class="lineNum">      74 </span><span class="lineCov">        224 :   fC[27] = ( h0*h0*fC[ 9] + h1*h1*fC[14] + h2*h2*fC[20] </span>
<span class="lineNum">      75 </span><span class="lineCov">        112 :              + 2*(h0*h1*fC[13] + h0*h2*fC[18] + h1*h2*fC[19] ) );</span>
<span class="lineNum">      76 </span><span class="lineCov">       2016 :   for( Int_t i=28; i&lt;36; i++ ) fC[i] = 0;</span>
<span class="lineNum">      77 </span><span class="lineCov">        112 :   fC[35] = 1.;</span>
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span><span class="lineCov">        112 :   SumDaughterMass = Mass;</span>
<span class="lineNum">      80 </span><span class="lineCov">        112 :   fMassHypo = Mass;</span>
<a name="81"><span class="lineNum">      81 </span><span class="lineCov">        112 : }</span></a>
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            : void AliKFParticleBase::Initialize()
<span class="lineNum">      84 </span>            : {
<span class="lineNum">      85 </span>            :   //* Initialise covariance matrix and set current parameters to 0.0 
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span><span class="lineCov">       6080 :   for( Int_t i=0; i&lt;8; i++) fP[i] = 0;</span>
<span class="lineNum">      88 </span><span class="lineCov">      23680 :   for(Int_t i=0;i&lt;36;++i) fC[i]=0.;</span>
<span class="lineNum">      89 </span><span class="lineCov">        320 :   fC[0] = fC[2] = fC[5] = 100.;</span>
<span class="lineNum">      90 </span><span class="lineCov">        320 :   fC[35] = 1.;</span>
<span class="lineNum">      91 </span><span class="lineCov">        320 :   fNDF  = -3;</span>
<span class="lineNum">      92 </span><span class="lineCov">        320 :   fChi2 =  0.;</span>
<span class="lineNum">      93 </span><span class="lineCov">        320 :   fQ = 0;</span>
<span class="lineNum">      94 </span><span class="lineCov">        320 :   fSFromDecay = 0;</span>
<span class="lineNum">      95 </span><span class="lineCov">        320 :   fAtProductionVertex = 0;</span>
<span class="lineNum">      96 </span><span class="lineCov">        320 :   fVtxGuess[0]=fVtxGuess[1]=fVtxGuess[2]=0.;</span>
<span class="lineNum">      97 </span><span class="lineCov">        320 :   fIsLinearized = 0;</span>
<span class="lineNum">      98 </span><span class="lineCov">        320 :   SumDaughterMass = 0;</span>
<span class="lineNum">      99 </span><span class="lineCov">        320 :   fMassHypo = -1;</span>
<a name="100"><span class="lineNum">     100 </span><span class="lineCov">        320 : }</span></a>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span>            : void AliKFParticleBase::SetVtxGuess( Double_t x, Double_t y, Double_t z )
<span class="lineNum">     103 </span>            : {
<span class="lineNum">     104 </span>            :   //* Set decay vertex parameters for linearisation 
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :   fVtxGuess[0] = x;</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :   fVtxGuess[1] = y;</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   fVtxGuess[2] = z;</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :   fIsLinearized = 1;</span>
<a name="110"><span class="lineNum">     110 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span>            : Int_t AliKFParticleBase::GetMomentum( Double_t &amp;p, Double_t &amp;error )  const 
<span class="lineNum">     113 </span>            : {
<span class="lineNum">     114 </span>            :   //* Calculate particle momentum
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :   Double_t x = fP[3];</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :   Double_t y = fP[4];</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :   Double_t z = fP[5];</span>
<span class="lineNum">     119 </span>            :   
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :   Double_t x2 = x*x;</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :   Double_t y2 = y*y;</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :   Double_t z2 = z*z;</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :   Double_t p2 = x2+y2+z2;</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   p = TMath::Sqrt(p2);</span>
<span class="lineNum">     125 </span>            :   
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :   error = (x2*fC[9]+y2*fC[14]+z2*fC[20] + 2*(x*y*fC[13]+x*z*fC[18]+y*z*fC[19]) );</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :   if( error&gt;1.e-16 &amp;&amp; p&gt;1.e-4 ){</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     error = TMath::Sqrt(error)/p;</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     130 </span>            :   }
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   error = 1.e8;</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :   return 1;</span>
<a name="133"><span class="lineNum">     133 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span>            : Int_t AliKFParticleBase::GetPt( Double_t &amp;pt, Double_t &amp;error )  const 
<span class="lineNum">     136 </span>            : {
<span class="lineNum">     137 </span>            :   //* Calculate particle transverse momentum
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :   Double_t px = fP[3];</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :   Double_t py = fP[4];</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   Double_t px2 = px*px;</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :   Double_t py2 = py*py;</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :   Double_t pt2 = px2+py2;</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :   pt = TMath::Sqrt(pt2);</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :   error = (px2*fC[9] + py2*fC[14] + 2*px*py*fC[13] );</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :   if( error&gt;0 &amp;&amp; pt&gt;1.e-4 ){</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     error = TMath::Sqrt(error)/pt;</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     149 </span>            :   }
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :   error = 1.e10;</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   return 1;</span>
<a name="152"><span class="lineNum">     152 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span>            : Int_t AliKFParticleBase::GetEta( Double_t &amp;eta, Double_t &amp;error )  const 
<span class="lineNum">     155 </span>            : {
<span class="lineNum">     156 </span>            :   //* Calculate particle pseudorapidity
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   Double_t px = fP[3];</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :   Double_t py = fP[4];</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :   Double_t pz = fP[5];</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   Double_t pt2 = px*px + py*py;</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   Double_t p2 = pt2 + pz*pz;</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :   Double_t p = TMath::Sqrt(p2);</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :   Double_t a = p + pz;</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   Double_t b = p - pz;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :   eta = 1.e10;</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :   if( b &gt; 1.e-8 ){</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :     Double_t c = a/b;</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :     if( c&gt;1.e-8 ) eta = 0.5*TMath::Log(c);</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :   Double_t h3 = -px*pz;</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :   Double_t h4 = -py*pz;  </span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :   Double_t pt4 = pt2*pt2;</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :   Double_t p2pt4 = p2*pt4;</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :   error = (h3*h3*fC[9] + h4*h4*fC[14] + pt4*fC[20] + 2*( h3*(h4*fC[13] + fC[18]*pt2) + pt2*h4*fC[19] ) );</span>
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :   if( error&gt;0 &amp;&amp; p2pt4&gt;1.e-10 ){</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :     error = TMath::Sqrt(error/p2pt4);</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     180 </span>            :   }
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   error = 1.e10;</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   return 1;</span>
<a name="184"><span class="lineNum">     184 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span>            : Int_t AliKFParticleBase::GetPhi( Double_t &amp;phi, Double_t &amp;error )  const 
<span class="lineNum">     187 </span>            : {
<span class="lineNum">     188 </span>            :   //* Calculate particle polar angle
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :   Double_t px = fP[3];</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :   Double_t py = fP[4];</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :   Double_t px2 = px*px;</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :   Double_t py2 = py*py;</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :   Double_t pt2 = px2 + py2;</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :   phi = TMath::ATan2(py,px);</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   error = (py2*fC[9] + px2*fC[14] - 2*px*py*fC[13] );</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   if( error&gt;0 &amp;&amp; pt2&gt;1.e-4 ){</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     error = TMath::Sqrt(error)/pt2;</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     200 </span>            :   }
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :   error = 1.e10;</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :   return 1;</span>
<a name="203"><span class="lineNum">     203 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span>            : Int_t AliKFParticleBase::GetR( Double_t &amp;r, Double_t &amp;error )  const 
<span class="lineNum">     206 </span>            : {
<span class="lineNum">     207 </span>            :   //* Calculate distance to the origin
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :   Double_t x = fP[0];</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :   Double_t y = fP[1];</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :   Double_t x2 = x*x;</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :   Double_t y2 = y*y;</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :   r = TMath::Sqrt(x2 + y2);</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :   error = (x2*fC[0] + y2*fC[2] - 2*x*y*fC[1] );</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :   if( error&gt;0 &amp;&amp; r&gt;1.e-4 ){</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :     error = TMath::Sqrt(error)/r;</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     218 </span>            :   }
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   error = 1.e10;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   return 1;</span>
<a name="221"><span class="lineNum">     221 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     222 </span>            : 
<span class="lineNum">     223 </span>            : Int_t AliKFParticleBase::GetMass( Double_t &amp;m, Double_t &amp;error ) const 
<span class="lineNum">     224 </span>            : {
<span class="lineNum">     225 </span>            :   //* Calculate particle mass
<span class="lineNum">     226 </span>            :   
<span class="lineNum">     227 </span>            :   // s = sigma^2 of m2/2
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span><span class="lineCov">         36 :   Double_t s = (  fP[3]*fP[3]*fC[9] + fP[4]*fP[4]*fC[14] + fP[5]*fP[5]*fC[20] </span>
<span class="lineNum">     230 </span><span class="lineCov">         18 :                   + fP[6]*fP[6]*fC[27] </span>
<span class="lineNum">     231 </span><span class="lineCov">         36 :                 +2*( + fP[3]*fP[4]*fC[13] + fP[5]*(fP[3]*fC[18] + fP[4]*fC[19]) </span>
<span class="lineNum">     232 </span><span class="lineCov">         18 :                      - fP[6]*( fP[3]*fC[24] + fP[4]*fC[25] + fP[5]*fC[26] )   )</span>
<span class="lineNum">     233 </span>            :                  ); 
<span class="lineNum">     234 </span>            : //   Double_t m2 = TMath::Abs(fP[6]*fP[6] - fP[3]*fP[3] - fP[4]*fP[4] - fP[5]*fP[5]);
<span class="lineNum">     235 </span>            : //   m  = TMath::Sqrt(m2);
<span class="lineNum">     236 </span>            : //   if( m&gt;1.e-10 ){
<span class="lineNum">     237 </span>            : //     if( s&gt;=0 ){
<span class="lineNum">     238 </span>            : //       error = TMath::Sqrt(s)/m;
<span class="lineNum">     239 </span>            : //       return 0;
<span class="lineNum">     240 </span>            : //     }
<span class="lineNum">     241 </span>            : //   }
<span class="lineNum">     242 </span>            : //   error = 1.e20;
<span class="lineNum">     243 </span>            : //   return 1;
<span class="lineNum">     244 </span><span class="lineCov">         18 :   Double_t m2 = (fP[6]*fP[6] - fP[3]*fP[3] - fP[4]*fP[4] - fP[5]*fP[5]);</span>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span><span class="lineCov">         18 :   if(m2&lt;0.)</span>
<span class="lineNum">     247 </span>            :   {
<span class="lineNum">     248 </span><span class="lineCov">          4 :     error = 1.e20;</span>
<span class="lineNum">     249 </span><span class="lineCov">          4 :     m = -TMath::Sqrt(-m2);</span>
<span class="lineNum">     250 </span><span class="lineCov">          4 :     return 1;</span>
<span class="lineNum">     251 </span>            :   }
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span><span class="lineCov">         14 :   m  = TMath::Sqrt(m2);</span>
<span class="lineNum">     254 </span><span class="lineCov">         14 :   if( m&gt;1.e-6 ){</span>
<span class="lineNum">     255 </span><span class="lineCov">         14 :     if( s &gt;= 0 ) {</span>
<span class="lineNum">     256 </span><span class="lineCov">         14 :       error = TMath::Sqrt(s)/m;</span>
<span class="lineNum">     257 </span><span class="lineCov">         14 :       return 0;</span>
<span class="lineNum">     258 </span>            :     }
<span class="lineNum">     259 </span>            :   }
<span class="lineNum">     260 </span>            :   else {
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     error = 1.e20;</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     263 </span>            :   }
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :   error = 1.e20;</span>
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :   return 1;</span>
<span class="lineNum">     267 </span><span class="lineCov">         18 : }</span>
<a name="268"><span class="lineNum">     268 </span>            : </a>
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span>            : Int_t AliKFParticleBase::GetDecayLength( Double_t &amp;l, Double_t &amp;error ) const 
<span class="lineNum">     271 </span>            : {
<span class="lineNum">     272 </span>            :   //* Calculate particle decay length [cm]
<span class="lineNum">     273 </span>            : 
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :   Double_t x = fP[3];</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   Double_t y = fP[4];</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   Double_t z = fP[5];</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   Double_t t = fP[7];</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   Double_t x2 = x*x;</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   Double_t y2 = y*y;</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :   Double_t z2 = z*z;</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :   Double_t p2 = x2+y2+z2;</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :   l = t*TMath::Sqrt(p2);</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :   if( p2&gt;1.e-4){</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     error = p2*fC[35] + t*t/p2*(x2*fC[9]+y2*fC[14]+z2*fC[20]</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :                                 + 2*(x*y*fC[13]+x*z*fC[18]+y*z*fC[19]) )</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :       + 2*t*(x*fC[31]+y*fC[32]+z*fC[33]);</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :     error = TMath::Sqrt(TMath::Abs(error));</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     289 </span>            :   }
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :   error = 1.e20;</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :   return 1;</span>
<a name="292"><span class="lineNum">     292 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span>            : Int_t AliKFParticleBase::GetDecayLengthXY( Double_t &amp;l, Double_t &amp;error ) const 
<span class="lineNum">     295 </span>            : {
<span class="lineNum">     296 </span>            :   //* Calculate particle decay length in XY projection [cm]
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :   Double_t x = fP[3];</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :   Double_t y = fP[4];</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :   Double_t t = fP[7];</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :   Double_t x2 = x*x;</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :   Double_t y2 = y*y;</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :   Double_t pt2 = x2+y2;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :   l = t*TMath::Sqrt(pt2);</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :   if( pt2&gt;1.e-4){</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     error = pt2*fC[35] + t*t/pt2*(x2*fC[9]+y2*fC[14] + 2*x*y*fC[13] )</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :       + 2*t*(x*fC[31]+y*fC[32]);</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :     error = TMath::Sqrt(TMath::Abs(error));</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     310 </span>            :   }
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :   error = 1.e20;</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :   return 1;</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 : }</span>
<a name="314"><span class="lineNum">     314 </span>            : </a>
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span>            : Int_t AliKFParticleBase::GetLifeTime( Double_t &amp;tauC, Double_t &amp;error ) const 
<span class="lineNum">     317 </span>            : {
<span class="lineNum">     318 </span>            :   //* Calculate particle decay time [s]
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :   Double_t m, dm;</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :   GetMass( m, dm );</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :   Double_t cTM = (-fP[3]*fC[31] - fP[4]*fC[32] - fP[5]*fC[33] + fP[6]*fC[34]);</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :   tauC = fP[7]*m;</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :   error = m*m*fC[35] + 2*fP[7]*cTM + fP[7]*fP[7]*dm*dm;</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :   if( error &gt; 0 ){</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     error = TMath::Sqrt( error );</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     328 </span>            :   }
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :   error = 1.e20;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :   return 1;</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 : }</span>
<a name="332"><span class="lineNum">     332 </span>            : </a>
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span>            : void AliKFParticleBase::operator +=( const AliKFParticleBase &amp;Daughter )
<span class="lineNum">     335 </span>            : {
<span class="lineNum">     336 </span>            :   //* Add daughter via operator+=
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span><span class="lineCov">        296 :   AddDaughter( Daughter );</span>
<a name="339"><span class="lineNum">     339 </span><span class="lineCov">        148 : }</span></a>
<span class="lineNum">     340 </span>            :   
<span class="lineNum">     341 </span>            : Double_t AliKFParticleBase::GetSCorrection( const Double_t Part[], const Double_t XYZ[] ) 
<span class="lineNum">     342 </span>            : {
<span class="lineNum">     343 </span>            :   //* Get big enough correction for S error to let the particle Part be fitted to XYZ point
<span class="lineNum">     344 </span>            :   
<span class="lineNum">     345 </span><span class="lineCov">        888 :   Double_t d[3] = { XYZ[0]-Part[0], XYZ[1]-Part[1], XYZ[2]-Part[2] };</span>
<span class="lineNum">     346 </span><span class="lineCov">        444 :   Double_t p2 = Part[3]*Part[3]+Part[4]*Part[4]+Part[5]*Part[5];</span>
<span class="lineNum">     347 </span><span class="lineCov">       1332 :   Double_t sigmaS = (p2&gt;1.e-4) ? ( 10.1+3.*TMath::Sqrt( d[0]*d[0]+d[1]*d[1]+d[2]*d[2]) )/TMath::Sqrt(p2) : 1.;</span>
<span class="lineNum">     348 </span><span class="lineCov">        444 :   return sigmaS;</span>
<a name="349"><span class="lineNum">     349 </span>            : }</a>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span>            : void AliKFParticleBase::GetMeasurement( const Double_t XYZ[], Double_t m[], Double_t V[] ) const
<span class="lineNum">     352 </span>            : {
<span class="lineNum">     353 </span>            :   //* Get additional covariances V used during measurement
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span><span class="lineCov">        888 :   Double_t b[3];</span>
<span class="lineNum">     356 </span><span class="lineCov">        444 :   GetFieldValue( XYZ, b );</span>
<span class="lineNum">     357 </span>            :   const Double_t kCLight =  0.000299792458;
<span class="lineNum">     358 </span><span class="lineCov">        444 :   b[0]*=kCLight; b[1]*=kCLight; b[2]*=kCLight;</span>
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span><span class="lineCov">        444 :   Transport( GetDStoPoint(XYZ), m, V );</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineCov">        444 :   Double_t sigmaS = GetSCorrection( m, XYZ );</span>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span>            :   Double_t h[6];
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span><span class="lineCov">        444 :   h[0] = m[3]*sigmaS;</span>
<span class="lineNum">     367 </span><span class="lineCov">        444 :   h[1] = m[4]*sigmaS;</span>
<span class="lineNum">     368 </span><span class="lineCov">        444 :   h[2] = m[5]*sigmaS;</span>
<span class="lineNum">     369 </span><span class="lineCov">        444 :   h[3] = ( h[1]*b[2]-h[2]*b[1] )*GetQ();</span>
<span class="lineNum">     370 </span><span class="lineCov">        444 :   h[4] = ( h[2]*b[0]-h[0]*b[2] )*GetQ();</span>
<span class="lineNum">     371 </span><span class="lineCov">        444 :   h[5] = ( h[0]*b[1]-h[1]*b[0] )*GetQ();</span>
<span class="lineNum">     372 </span>            :     
<span class="lineNum">     373 </span><span class="lineCov">        444 :   V[ 0]+= h[0]*h[0];</span>
<span class="lineNum">     374 </span><span class="lineCov">        444 :   V[ 1]+= h[1]*h[0];</span>
<span class="lineNum">     375 </span><span class="lineCov">        444 :   V[ 2]+= h[1]*h[1];</span>
<span class="lineNum">     376 </span><span class="lineCov">        444 :   V[ 3]+= h[2]*h[0];</span>
<span class="lineNum">     377 </span><span class="lineCov">        444 :   V[ 4]+= h[2]*h[1];</span>
<span class="lineNum">     378 </span><span class="lineCov">        444 :   V[ 5]+= h[2]*h[2];</span>
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineCov">        444 :   V[ 6]+= h[3]*h[0];</span>
<span class="lineNum">     381 </span><span class="lineCov">        444 :   V[ 7]+= h[3]*h[1];</span>
<span class="lineNum">     382 </span><span class="lineCov">        444 :   V[ 8]+= h[3]*h[2];</span>
<span class="lineNum">     383 </span><span class="lineCov">        444 :   V[ 9]+= h[3]*h[3];</span>
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span><span class="lineCov">        444 :   V[10]+= h[4]*h[0];</span>
<span class="lineNum">     386 </span><span class="lineCov">        444 :   V[11]+= h[4]*h[1];</span>
<span class="lineNum">     387 </span><span class="lineCov">        444 :   V[12]+= h[4]*h[2];</span>
<span class="lineNum">     388 </span><span class="lineCov">        444 :   V[13]+= h[4]*h[3];</span>
<span class="lineNum">     389 </span><span class="lineCov">        444 :   V[14]+= h[4]*h[4];</span>
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span><span class="lineCov">        444 :   V[15]+= h[5]*h[0];</span>
<span class="lineNum">     392 </span><span class="lineCov">        444 :   V[16]+= h[5]*h[1];</span>
<span class="lineNum">     393 </span><span class="lineCov">        444 :   V[17]+= h[5]*h[2];</span>
<span class="lineNum">     394 </span><span class="lineCov">        444 :   V[18]+= h[5]*h[3];</span>
<span class="lineNum">     395 </span><span class="lineCov">        444 :   V[19]+= h[5]*h[4];</span>
<span class="lineNum">     396 </span><span class="lineCov">        444 :   V[20]+= h[5]*h[5];</span>
<a name="397"><span class="lineNum">     397 </span><span class="lineCov">        444 : }</span></a>
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span>            : void AliKFParticleBase::AddDaughter( const AliKFParticleBase &amp;Daughter )
<span class="lineNum">     400 </span>            : {
<span class="lineNum">     401 </span><span class="lineCov">        296 :   if( fNDF&lt;-1 ){ // first daughter -&gt; just copy</span>
<span class="lineNum">     402 </span><span class="lineCov">         74 :     fNDF   = -1;</span>
<span class="lineNum">     403 </span><span class="lineCov">         74 :     fQ     =  Daughter.GetQ();</span>
<span class="lineNum">     404 </span><span class="lineCov">       1184 :     for( Int_t i=0; i&lt;7; i++) fP[i] = Daughter.fP[i];</span>
<span class="lineNum">     405 </span><span class="lineCov">       4292 :     for( Int_t i=0; i&lt;28; i++) fC[i] = Daughter.fC[i];</span>
<span class="lineNum">     406 </span><span class="lineCov">         74 :     fSFromDecay = 0;</span>
<span class="lineNum">     407 </span><span class="lineCov">         74 :     fMassHypo = Daughter.fMassHypo;</span>
<span class="lineNum">     408 </span><span class="lineCov">         74 :     SumDaughterMass = Daughter.SumDaughterMass;</span>
<span class="lineNum">     409 </span><span class="lineCov">         74 :     return;</span>
<span class="lineNum">     410 </span>            :   }
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span><span class="lineCov">         74 :   if(fConstructMethod == 0)</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     AddDaughterWithEnergyFit(Daughter);</span>
<span class="lineNum">     414 </span><span class="lineCov">         74 :   else if(fConstructMethod == 1)</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     AddDaughterWithEnergyCalc(Daughter);</span>
<span class="lineNum">     416 </span><span class="lineCov">         74 :   else if(fConstructMethod == 2)</span>
<span class="lineNum">     417 </span><span class="lineCov">         74 :     AddDaughterWithEnergyFitMC(Daughter);</span>
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span><span class="lineCov">         74 :   SumDaughterMass += Daughter.SumDaughterMass;</span>
<span class="lineNum">     420 </span><span class="lineCov">         74 :   fMassHypo = -1;</span>
<a name="421"><span class="lineNum">     421 </span><span class="lineCov">        222 : }</span></a>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span>            : void AliKFParticleBase::AddDaughterWithEnergyFit( const AliKFParticleBase &amp;Daughter )
<span class="lineNum">     424 </span>            : {
<span class="lineNum">     425 </span>            :   //* Energy considered as an independent veriable, fitted independently from momentum, without any constraints on mass
<span class="lineNum">     426 </span>            : 
<span class="lineNum">     427 </span>            :   //* Add daughter 
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :   TransportToDecayVertex();</span>
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :   Double_t b[3]; </span>
<span class="lineNum">     432 </span>            :   Int_t maxIter = 1;
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :   if( !fIsLinearized ){</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     if( fNDF==-1 ){</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :       Double_t ds, ds1;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :       GetDStoParticle(Daughter, ds, ds1);      </span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :       TransportToDS( ds );</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :       Double_t m[8];</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :       Double_t mCd[36];       </span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :       Daughter.Transport( ds1, m, mCd );    </span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :       fVtxGuess[0] = .5*( fP[0] + m[0] );</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :       fVtxGuess[1] = .5*( fP[1] + m[1] );</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :       fVtxGuess[2] = .5*( fP[2] + m[2] );</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :       fVtxGuess[0] = fP[0];</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :       fVtxGuess[1] = fP[1];</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :       fVtxGuess[2] = fP[2]; </span>
<span class="lineNum">     449 </span>            :     }
<span class="lineNum">     450 </span>            :     maxIter = 3;
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :   for( Int_t iter=0; iter&lt;maxIter; iter++ ){</span>
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span>            :     {
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :       GetFieldValue( fVtxGuess, b );</span>
<span class="lineNum">     457 </span>            :       const Double_t kCLight =  0.000299792458;
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :       b[0]*=kCLight; b[1]*=kCLight; b[2]*=kCLight;</span>
<span class="lineNum">     459 </span>            :     }
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :     Double_t *ffP = fP, *ffC = fC, tmpP[8], tmpC[36];</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :     if( fNDF==-1 ){            </span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :       GetMeasurement( fVtxGuess, tmpP, tmpC );</span>
<span class="lineNum">     464 </span>            :       ffP = tmpP;
<span class="lineNum">     465 </span>            :       ffC = tmpC;
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     Double_t m[8], mV[36];</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     if( Daughter.fC[35]&gt;0 ){</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :       Daughter.GetMeasurement( fVtxGuess, m, mV );</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :       for( Int_t i=0; i&lt;8; i++ ) m[i] = Daughter.fP[i];</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :       for( Int_t i=0; i&lt;36; i++ ) mV[i] = Daughter.fC[i];</span>
<span class="lineNum">     475 </span>            :     }
<span class="lineNum">     476 </span>            :     //*
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span>            :     Double_t mS[6];
<span class="lineNum">     479 </span>            :     {
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :       Double_t mSi[6] = { ffC[0]+mV[0], </span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :                           ffC[1]+mV[1], ffC[2]+mV[2], </span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :                           ffC[3]+mV[3], ffC[4]+mV[4], ffC[5]+mV[5] };</span>
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :       mS[0] = mSi[2]*mSi[5] - mSi[4]*mSi[4];</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :       mS[1] = mSi[3]*mSi[4] - mSi[1]*mSi[5];</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :       mS[2] = mSi[0]*mSi[5] - mSi[3]*mSi[3];</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :       mS[3] = mSi[1]*mSi[4] - mSi[2]*mSi[3];</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :       mS[4] = mSi[1]*mSi[3] - mSi[0]*mSi[4];</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :       mS[5] = mSi[0]*mSi[2] - mSi[1]*mSi[1];     </span>
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :       Double_t s = ( mSi[0]*mS[0] + mSi[1]*mS[1] + mSi[3]*mS[3] );      </span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :       s = ( TMath::Abs(s) &gt; 1.E-20 )  ?1./s :0;        </span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :       mS[0]*=s;</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :       mS[1]*=s;</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :       mS[2]*=s;</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :       mS[3]*=s;</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :       mS[4]*=s;</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :       mS[5]*=s;</span>
<span class="lineNum">     499 </span>            :     }
<span class="lineNum">     500 </span>            :     //* Residual (measured - estimated)
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :     Double_t zeta[3] = { m[0]-ffP[0], m[1]-ffP[1], m[2]-ffP[2] };    </span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span>            :     //* CHt = CH' - D'
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :     Double_t mCHt0[7], mCHt1[7], mCHt2[7];</span>
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :     mCHt0[0]=ffC[ 0] ;       mCHt1[0]=ffC[ 1] ;       mCHt2[0]=ffC[ 3] ;</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :     mCHt0[1]=ffC[ 1] ;       mCHt1[1]=ffC[ 2] ;       mCHt2[1]=ffC[ 4] ;</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :     mCHt0[2]=ffC[ 3] ;       mCHt1[2]=ffC[ 4] ;       mCHt2[2]=ffC[ 5] ;</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     mCHt0[3]=ffC[ 6]-mV[ 6]; mCHt1[3]=ffC[ 7]-mV[ 7]; mCHt2[3]=ffC[ 8]-mV[ 8];</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :     mCHt0[4]=ffC[10]-mV[10]; mCHt1[4]=ffC[11]-mV[11]; mCHt2[4]=ffC[12]-mV[12];</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :     mCHt0[5]=ffC[15]-mV[15]; mCHt1[5]=ffC[16]-mV[16]; mCHt2[5]=ffC[17]-mV[17];</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     mCHt0[6]=ffC[21]-mV[21]; mCHt1[6]=ffC[22]-mV[22]; mCHt2[6]=ffC[23]-mV[23];</span>
<span class="lineNum">     515 </span>            :   
<span class="lineNum">     516 </span>            :     //* Kalman gain K = mCH'*S
<span class="lineNum">     517 </span>            :     
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     Double_t k0[7], k1[7], k2[7];</span>
<span class="lineNum">     519 </span>            :     
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;7;++i){</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :       k0[i] = mCHt0[i]*mS[0] + mCHt1[i]*mS[1] + mCHt2[i]*mS[3];</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :       k1[i] = mCHt0[i]*mS[1] + mCHt1[i]*mS[2] + mCHt2[i]*mS[4];</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :       k2[i] = mCHt0[i]*mS[3] + mCHt1[i]*mS[4] + mCHt2[i]*mS[5];</span>
<span class="lineNum">     524 </span>            :     }
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span>            :    //* New estimation of the vertex position 
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     if( iter&lt;maxIter-1 ){</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :       for(Int_t i=0; i&lt;3; ++i) </span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :         fVtxGuess[i]= ffP[i] + k0[i]*zeta[0]+k1[i]*zeta[1]+k2[i]*zeta[2];</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     532 </span>            :     }
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span>            :     // last itearation -&gt; update the particle
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span>            :     //* Add the daughter momentum to the particle momentum
<span class="lineNum">     537 </span>            :     
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :     ffP[ 3] += m[ 3];</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :     ffP[ 4] += m[ 4];</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :     ffP[ 5] += m[ 5];</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :     ffP[ 6] += m[ 6];</span>
<span class="lineNum">     542 </span>            :   
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     ffC[ 9] += mV[ 9];</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :     ffC[13] += mV[13];</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :     ffC[14] += mV[14];</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :     ffC[18] += mV[18];</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :     ffC[19] += mV[19];</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :     ffC[20] += mV[20];</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :     ffC[24] += mV[24];</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :     ffC[25] += mV[25];</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :     ffC[26] += mV[26];</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     ffC[27] += mV[27];</span>
<span class="lineNum">     553 </span>            :     
<span class="lineNum">     554 </span>            :  
<span class="lineNum">     555 </span>            :    //* New estimation of the vertex position r += K*zeta
<span class="lineNum">     556 </span>            :     
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;7;++i) </span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :       fP[i] = ffP[i] + k0[i]*zeta[0] + k1[i]*zeta[1] + k2[i]*zeta[2];</span>
<span class="lineNum">     559 </span>            :     
<span class="lineNum">     560 </span>            :     //* New covariance matrix C -= K*(mCH')'
<span class="lineNum">     561 </span>            : 
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :     for(Int_t i=0, k=0;i&lt;7;++i){</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :       for(Int_t j=0;j&lt;=i;++j,++k){</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :         fC[k] = ffC[k] - (k0[i]*mCHt0[j] + k1[i]*mCHt1[j] + k2[i]*mCHt2[j] );</span>
<span class="lineNum">     565 </span>            :       }
<span class="lineNum">     566 </span>            :     }
<span class="lineNum">     567 </span>            :   
<span class="lineNum">     568 </span>            :     //* Calculate Chi^2 
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :     fNDF  += 2;</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :     fQ    +=  Daughter.GetQ();</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :     fSFromDecay = 0;    </span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :     fChi2 += (mS[0]*zeta[0] + mS[1]*zeta[1] + mS[3]*zeta[2])*zeta[0]</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :       +      (mS[1]*zeta[0] + mS[2]*zeta[1] + mS[4]*zeta[2])*zeta[1]</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :       +      (mS[3]*zeta[0] + mS[4]*zeta[1] + mS[5]*zeta[2])*zeta[2];     </span>
<span class="lineNum">     576 </span>            : 
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :   }</span>
<a name="578"><span class="lineNum">     578 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span>            : void AliKFParticleBase::AddDaughterWithEnergyCalc( const AliKFParticleBase &amp;Daughter )
<span class="lineNum">     581 </span>            : {
<span class="lineNum">     582 </span>            :   //* Energy considered as a dependent variable, calculated from the momentum and mass hypothesis
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span>            :   //* Add daughter 
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :   TransportToDecayVertex();</span>
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :   Double_t b[3]; </span>
<span class="lineNum">     589 </span>            :   Int_t maxIter = 1;
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :   if( !fIsLinearized ){</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :     if( fNDF==-1 ){</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :       Double_t ds, ds1;</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :       GetDStoParticle(Daughter, ds, ds1);      </span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :       TransportToDS( ds );</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :       Double_t m[8];</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :       Double_t mCd[36];       </span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :       Daughter.Transport( ds1, m, mCd );    </span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :       fVtxGuess[0] = .5*( fP[0] + m[0] );</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :       fVtxGuess[1] = .5*( fP[1] + m[1] );</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :       fVtxGuess[2] = .5*( fP[2] + m[2] );</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :       fVtxGuess[0] = fP[0];</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :       fVtxGuess[1] = fP[1];</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :       fVtxGuess[2] = fP[2]; </span>
<span class="lineNum">     606 </span>            :     }
<span class="lineNum">     607 </span>            :     maxIter = 3;
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :   for( Int_t iter=0; iter&lt;maxIter; iter++ ){</span>
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span>            :     {
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :       GetFieldValue( fVtxGuess, b );</span>
<span class="lineNum">     614 </span>            :       const Double_t kCLight =  0.000299792458;
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :       b[0]*=kCLight; b[1]*=kCLight; b[2]*=kCLight;</span>
<span class="lineNum">     616 </span>            :     }
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     Double_t *ffP = fP, *ffC = fC, tmpP[8], tmpC[36];</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     if( fNDF==-1 ){            </span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :       GetMeasurement( fVtxGuess, tmpP, tmpC );</span>
<span class="lineNum">     621 </span>            :       ffP = tmpP;
<span class="lineNum">     622 </span>            :       ffC = tmpC;
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :     Double_t m[8], mV[36];</span>
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :     if( Daughter.fC[35]&gt;0 ){</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :       Daughter.GetMeasurement( fVtxGuess, m, mV );</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :       for( Int_t i=0; i&lt;8; i++ ) m[i] = Daughter.fP[i];</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :       for( Int_t i=0; i&lt;36; i++ ) mV[i] = Daughter.fC[i];</span>
<span class="lineNum">     632 </span>            :     }
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :     double massMf2 = m[6]*m[6] - (m[3]*m[3] + m[4]*m[4] + m[5]*m[5]);</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :     double massRf2 = fP[6]*fP[6] - (fP[3]*fP[3] + fP[4]*fP[4] + fP[5]*fP[5]);</span>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span>            :     //*
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            :     Double_t mS[6];
<span class="lineNum">     640 </span>            :     {
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :       Double_t mSi[6] = { ffC[0]+mV[0], </span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :                           ffC[1]+mV[1], ffC[2]+mV[2], </span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :                           ffC[3]+mV[3], ffC[4]+mV[4], ffC[5]+mV[5] };</span>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :       mS[0] = mSi[2]*mSi[5] - mSi[4]*mSi[4];</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :       mS[1] = mSi[3]*mSi[4] - mSi[1]*mSi[5];</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :       mS[2] = mSi[0]*mSi[5] - mSi[3]*mSi[3];</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :       mS[3] = mSi[1]*mSi[4] - mSi[2]*mSi[3];</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :       mS[4] = mSi[1]*mSi[3] - mSi[0]*mSi[4];</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :       mS[5] = mSi[0]*mSi[2] - mSi[1]*mSi[1];     </span>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :       Double_t s = ( mSi[0]*mS[0] + mSi[1]*mS[1] + mSi[3]*mS[3] );      </span>
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :       s = ( s &gt; 1.E-20 )  ?1./s :0;    </span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :       mS[0]*=s;</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :       mS[1]*=s;</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :       mS[2]*=s;</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :       mS[3]*=s;</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :       mS[4]*=s;</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :       mS[5]*=s;</span>
<span class="lineNum">     661 </span>            :     }
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span>            :     //* Residual (measured - estimated)
<span class="lineNum">     664 </span>            : 
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :     Double_t zeta[3] = { m[0]-ffP[0], m[1]-ffP[1], m[2]-ffP[2] };    </span>
<span class="lineNum">     666 </span>            : 
<span class="lineNum">     667 </span>            :     //* CHt = CH' - D'
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :     Double_t mCHt0[6], mCHt1[6], mCHt2[6];</span>
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :     mCHt0[0]=ffC[ 0] ;       mCHt1[0]=ffC[ 1] ;       mCHt2[0]=ffC[ 3] ;</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :     mCHt0[1]=ffC[ 1] ;       mCHt1[1]=ffC[ 2] ;       mCHt2[1]=ffC[ 4] ;</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :     mCHt0[2]=ffC[ 3] ;       mCHt1[2]=ffC[ 4] ;       mCHt2[2]=ffC[ 5] ;</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :     mCHt0[3]=ffC[ 6]-mV[ 6]; mCHt1[3]=ffC[ 7]-mV[ 7]; mCHt2[3]=ffC[ 8]-mV[ 8];</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :     mCHt0[4]=ffC[10]-mV[10]; mCHt1[4]=ffC[11]-mV[11]; mCHt2[4]=ffC[12]-mV[12];</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :     mCHt0[5]=ffC[15]-mV[15]; mCHt1[5]=ffC[16]-mV[16]; mCHt2[5]=ffC[17]-mV[17];</span>
<span class="lineNum">     677 </span>            : 
<span class="lineNum">     678 </span>            :     //* Kalman gain K = mCH'*S
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :     Double_t k0[6], k1[6], k2[6];</span>
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;6;++i){</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :       k0[i] = mCHt0[i]*mS[0] + mCHt1[i]*mS[1] + mCHt2[i]*mS[3];</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :       k1[i] = mCHt0[i]*mS[1] + mCHt1[i]*mS[2] + mCHt2[i]*mS[4];</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :       k2[i] = mCHt0[i]*mS[3] + mCHt1[i]*mS[4] + mCHt2[i]*mS[5];</span>
<span class="lineNum">     686 </span>            :     }
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span>            :    //* New estimation of the vertex position 
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :     if( iter&lt;maxIter-1 ){</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :       for(Int_t i=0; i&lt;3; ++i) </span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :         fVtxGuess[i]= ffP[i] + k0[i]*zeta[0]+k1[i]*zeta[1]+k2[i]*zeta[2];</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     694 </span>            :     }
<span class="lineNum">     695 </span>            : 
<span class="lineNum">     696 </span>            :    //* find mf and mVf - optimum value of the measurement and its covariance matrix
<span class="lineNum">     697 </span>            :     //* mVHt = V*H'
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :     Double_t mVHt0[6], mVHt1[6], mVHt2[6];</span>
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :     mVHt0[0]= mV[ 0] ; mVHt1[0]= mV[ 1] ; mVHt2[0]= mV[ 3] ;</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :     mVHt0[1]= mV[ 1] ; mVHt1[1]= mV[ 2] ; mVHt2[1]= mV[ 4] ;</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :     mVHt0[2]= mV[ 3] ; mVHt1[2]= mV[ 4] ; mVHt2[2]= mV[ 5] ;</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :     mVHt0[3]= mV[ 6] ; mVHt1[3]= mV[ 7] ; mVHt2[3]= mV[ 8] ;</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :     mVHt0[4]= mV[10] ; mVHt1[4]= mV[11] ; mVHt2[4]= mV[12] ;</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :     mVHt0[5]= mV[15] ; mVHt1[5]= mV[16] ; mVHt2[5]= mV[17] ;</span>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span>            :     //* Kalman gain Km = mCH'*S
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :     Double_t km0[6], km1[6], km2[6];</span>
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;6;++i){</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :       km0[i] = mVHt0[i]*mS[0] + mVHt1[i]*mS[1] + mVHt2[i]*mS[3];</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :       km1[i] = mVHt0[i]*mS[1] + mVHt1[i]*mS[2] + mVHt2[i]*mS[4];</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :       km2[i] = mVHt0[i]*mS[3] + mVHt1[i]*mS[4] + mVHt2[i]*mS[5];</span>
<span class="lineNum">     715 </span>            :     }
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :     Double_t mf[7] = { m[0], m[1], m[2], m[3], m[4], m[5], m[6] };</span>
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;6;++i) </span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :       mf[i] = mf[i] - km0[i]*zeta[0] - km1[i]*zeta[1] - km2[i]*zeta[2];</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :     Double_t energyMf = TMath::Sqrt( massMf2 + (mf[3]*mf[3] + mf[4]*mf[4] + mf[5]*mf[5]) );</span>
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :     Double_t mVf[28];</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :     for(Int_t iC=0; iC&lt;28; iC++)</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :       mVf[iC] = mV[iC];</span>
<span class="lineNum">     727 </span>            : 
<span class="lineNum">     728 </span>            :     //* hmf = d(energyMf)/d(mf)
<span class="lineNum">     729 </span>            :     Double_t hmf[7];
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :     if( TMath::Abs(energyMf) &lt; 1.e-10) hmf[3] = 0; else hmf[3] = mf[3]/energyMf;</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :     if( TMath::Abs(energyMf) &lt; 1.e-10) hmf[4] = 0; else hmf[4] = mf[4]/energyMf;</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :     if( TMath::Abs(energyMf) &lt; 1.e-10) hmf[5] = 0; else hmf[5] = mf[5]/energyMf;</span>
<span class="lineNum">     733 </span>            : //    if( TMath::Abs(energyMf) &lt; 1.e-10) hmf[6] = 0; else hmf[6] = mf[6]/energyMf;
<span class="lineNum">     734 </span>            :     hmf[6] = 0;
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :     for(Int_t i=0, k=0;i&lt;6;++i){</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :       for(Int_t j=0;j&lt;=i;++j,++k){</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :         mVf[k] = mVf[k] - (km0[i]*mVHt0[j] + km1[i]*mVHt1[j] + km2[i]*mVHt2[j] );</span>
<span class="lineNum">     739 </span>            :       }
<span class="lineNum">     740 </span>            :     }
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :     Double_t mVf24 = mVf[24], mVf25 = mVf[25], mVf26 = mVf[26];</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :     mVf[21] = mVf[6 ]*hmf[3] + mVf[10]*hmf[4] + mVf[15]*hmf[5] + mVf[21]*hmf[6];</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :     mVf[22] = mVf[7 ]*hmf[3] + mVf[11]*hmf[4] + mVf[16]*hmf[5] + mVf[22]*hmf[6];</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :     mVf[23] = mVf[8 ]*hmf[3] + mVf[12]*hmf[4] + mVf[17]*hmf[5] + mVf[23]*hmf[6];</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :     mVf[24] = mVf[9 ]*hmf[3] + mVf[13]*hmf[4] + mVf[18]*hmf[5] + mVf[24]*hmf[6];</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :     mVf[25] = mVf[13]*hmf[3] + mVf[14]*hmf[4] + mVf[19]*hmf[5] + mVf[25]*hmf[6];</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :     mVf[26] = mVf[18]*hmf[3] + mVf[19]*hmf[4] + mVf[20]*hmf[5] + mVf[26]*hmf[6];</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :     mVf[27] = mVf[24]*hmf[3] + mVf[25]*hmf[4] + mVf[26]*hmf[5] + (mVf24*hmf[3] + mVf25*hmf[4] + mVf26*hmf[5] + mVf[27]*hmf[6])*hmf[6]; //here mVf[] are already modified</span>
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :     mf[6] = energyMf;</span>
<span class="lineNum">     751 </span>            : 
<span class="lineNum">     752 </span>            :     //* find rf and mCf - optimum value of the measurement and its covariance matrix
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span>            :     //* mCCHt = C*H'
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     Double_t mCCHt0[6], mCCHt1[6], mCCHt2[6];</span>
<span class="lineNum">     756 </span>            : 
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :     mCCHt0[0]=ffC[ 0]; mCCHt1[0]=ffC[ 1]; mCCHt2[0]=ffC[ 3];</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :     mCCHt0[1]=ffC[ 1]; mCCHt1[1]=ffC[ 2]; mCCHt2[1]=ffC[ 4];</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :     mCCHt0[2]=ffC[ 3]; mCCHt1[2]=ffC[ 4]; mCCHt2[2]=ffC[ 5];</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     mCCHt0[3]=ffC[ 6]; mCCHt1[3]=ffC[ 7]; mCCHt2[3]=ffC[ 8];</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :     mCCHt0[4]=ffC[10]; mCCHt1[4]=ffC[11]; mCCHt2[4]=ffC[12];</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :     mCCHt0[5]=ffC[15]; mCCHt1[5]=ffC[16]; mCCHt2[5]=ffC[17];</span>
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span>            :     //* Kalman gain Krf = mCH'*S
<span class="lineNum">     765 </span>            : 
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :     Double_t krf0[6], krf1[6], krf2[6];</span>
<span class="lineNum">     767 </span>            : 
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;6;++i){</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :       krf0[i] = mCCHt0[i]*mS[0] + mCCHt1[i]*mS[1] + mCCHt2[i]*mS[3];</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :       krf1[i] = mCCHt0[i]*mS[1] + mCCHt1[i]*mS[2] + mCCHt2[i]*mS[4];</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :       krf2[i] = mCCHt0[i]*mS[3] + mCCHt1[i]*mS[4] + mCCHt2[i]*mS[5];</span>
<span class="lineNum">     772 </span>            :     }
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :     Double_t rf[7] = { ffP[0], ffP[1], ffP[2], ffP[3], ffP[4], ffP[5], ffP[6] };</span>
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;6;++i) </span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :       rf[i] = rf[i] + krf0[i]*zeta[0] + krf1[i]*zeta[1] + krf2[i]*zeta[2];</span>
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :     Double_t energyRf = TMath::Sqrt( massRf2 + (rf[3]*rf[3] + rf[4]*rf[4] + rf[5]*rf[5]) );</span>
<span class="lineNum">     779 </span>            : 
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :     Double_t mCf[28];</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :     for(Int_t iC=0; iC&lt;28; iC++)</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :       mCf[iC] = ffC[iC];</span>
<span class="lineNum">     783 </span>            :     //* hrf = d(Erf)/d(rf)
<span class="lineNum">     784 </span>            :     Double_t hrf[7];
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :     if( TMath::Abs(energyRf) &lt; 1.e-10) hrf[3] = 0; else hrf[3] = rf[3]/energyRf;</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :     if( TMath::Abs(energyRf) &lt; 1.e-10) hrf[4] = 0; else hrf[4] = rf[4]/energyRf;</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :     if( TMath::Abs(energyRf) &lt; 1.e-10) hrf[5] = 0; else hrf[5] = rf[5]/energyRf;</span>
<span class="lineNum">     788 </span>            : //    if( TMath::Abs(energyRf) &lt; 1.e-10) hrf[6] = 0; else hrf[6] = rf[6]/energyRf;
<span class="lineNum">     789 </span>            :     hrf[6] = 0;
<span class="lineNum">     790 </span>            : 
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :     for(Int_t i=0, k=0;i&lt;6;++i){</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :       for(Int_t j=0;j&lt;=i;++j,++k){</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :         mCf[k] = mCf[k] - (krf0[i]*mCCHt0[j] + krf1[i]*mCCHt1[j] + krf2[i]*mCCHt2[j] );</span>
<span class="lineNum">     794 </span>            :       }
<span class="lineNum">     795 </span>            :     }
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :     Double_t mCf24 = mCf[24], mCf25 = mCf[25], mCf26 = mCf[26];</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :     mCf[21] = mCf[6 ]*hrf[3] + mCf[10]*hrf[4] + mCf[15]*hrf[5] + mCf[21]*hrf[6];</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :     mCf[22] = mCf[7 ]*hrf[3] + mCf[11]*hrf[4] + mCf[16]*hrf[5] + mCf[22]*hrf[6];</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :     mCf[23] = mCf[8 ]*hrf[3] + mCf[12]*hrf[4] + mCf[17]*hrf[5] + mCf[23]*hrf[6];</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :     mCf[24] = mCf[9 ]*hrf[3] + mCf[13]*hrf[4] + mCf[18]*hrf[5] + mCf[24]*hrf[6];</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :     mCf[25] = mCf[13]*hrf[3] + mCf[14]*hrf[4] + mCf[19]*hrf[5] + mCf[25]*hrf[6];</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :     mCf[26] = mCf[18]*hrf[3] + mCf[19]*hrf[4] + mCf[20]*hrf[5] + mCf[26]*hrf[6];</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :     mCf[27] = mCf[24]*hrf[3] + mCf[25]*hrf[4] + mCf[26]*hrf[5] + (mCf24*hrf[3] + mCf25*hrf[4] + mCf26*hrf[5] + mCf[27]*hrf[6])*hrf[6]; //here mCf[] are already modified</span>
<span class="lineNum">     804 </span>            : 
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :     for(Int_t iC=21; iC&lt;28; iC++)</span>
<span class="lineNum">     806 </span>            :     {
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :       ffC[iC] = mCf[iC];</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :       mV[iC]  = mVf[iC];</span>
<span class="lineNum">     809 </span>            :     }
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :     fP[6] = energyRf + energyMf;</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :     rf[6] = energyRf;</span>
<span class="lineNum">     813 </span>            : 
<span class="lineNum">     814 </span>            :     //Double_t Dvv[3][3]; do not need this
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :     Double_t mDvp[3][3];</span>
<span class="lineNum">     816 </span>            :     //    Double_t mDpv[3][3];
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :     Double_t mDpp[3][3];</span>
<span class="lineNum">     818 </span>            :     Double_t mDe[7];
<span class="lineNum">     819 </span>            : 
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :     for(int i=0; i&lt;3; i++)</span>
<span class="lineNum">     821 </span>            :     {
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :       for(int j=0; j&lt;3; j++)</span>
<span class="lineNum">     823 </span>            :       {
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :         mDvp[i][j] = km0[i+3]*mCCHt0[j] + km1[i+3]*mCCHt1[j] + km2[i+3]*mCCHt2[j];</span>
<span class="lineNum">     825 </span>            :         //        mDpv[i][j] = km0[i]*mCCHt0[j+3] + km1[i]*mCCHt1[j+3] + km2[i]*mCCHt2[j+3];
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :         mDpp[i][j] = km0[i+3]*mCCHt0[j+3] + km1[i+3]*mCCHt1[j+3] + km2[i+3]*mCCHt2[j+3];</span>
<span class="lineNum">     827 </span>            :       }
<span class="lineNum">     828 </span>            :     }
<span class="lineNum">     829 </span>            : 
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :     mDe[0] = hmf[3]*mDvp[0][0] + hmf[4]*mDvp[1][0] + hmf[5]*mDvp[2][0];</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :     mDe[1] = hmf[3]*mDvp[0][1] + hmf[4]*mDvp[1][1] + hmf[5]*mDvp[2][1];</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :     mDe[2] = hmf[3]*mDvp[0][2] + hmf[4]*mDvp[1][2] + hmf[5]*mDvp[2][2];</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :     mDe[3] = hmf[3]*mDpp[0][0] + hmf[4]*mDpp[1][0] + hmf[5]*mDpp[2][0];</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :     mDe[4] = hmf[3]*mDpp[0][1] + hmf[4]*mDpp[1][1] + hmf[5]*mDpp[2][1];</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :     mDe[5] = hmf[3]*mDpp[0][2] + hmf[4]*mDpp[1][2] + hmf[5]*mDpp[2][2];</span>
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :     mDe[6] = 2*(mDe[3]*hrf[3] + mDe[4]*hrf[4] + mDe[5]*hrf[5]);</span>
<span class="lineNum">     837 </span>            : 
<span class="lineNum">     838 </span>            :     // last itearation -&gt; update the particle
<span class="lineNum">     839 </span>            : 
<span class="lineNum">     840 </span>            :     //* Add the daughter momentum to the particle momentum
<span class="lineNum">     841 </span>            : 
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :     ffP[ 3] += m[ 3];</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :     ffP[ 4] += m[ 4];</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :     ffP[ 5] += m[ 5];</span>
<span class="lineNum">     845 </span>            : 
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :     ffC[ 9] += mV[ 9];</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :     ffC[13] += mV[13];</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :     ffC[14] += mV[14];</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :     ffC[18] += mV[18];</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :     ffC[19] += mV[19];</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :     ffC[20] += mV[20];</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :     ffC[24] += mV[24];</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :     ffC[25] += mV[25];</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :     ffC[26] += mV[26];</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :     ffC[27] += mV[27];</span>
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :     ffC[21] += mDe[0];</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :     ffC[22] += mDe[1];</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :     ffC[23] += mDe[2];</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :     ffC[24] += mDe[3];</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :     ffC[25] += mDe[4];</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :     ffC[26] += mDe[5];</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :     ffC[27] += mDe[6];</span>
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span>            :    //* New estimation of the vertex position r += K*zeta
<span class="lineNum">     866 </span>            : 
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;6;++i) </span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :       fP[i] = ffP[i] + k0[i]*zeta[0] + k1[i]*zeta[1] + k2[i]*zeta[2];</span>
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span>            :     //* New covariance matrix C -= K*(mCH')'
<span class="lineNum">     871 </span>            : 
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :     for(Int_t i=0, k=0;i&lt;6;++i){</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :       for(Int_t j=0;j&lt;=i;++j,++k){</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :         fC[k] = ffC[k] - (k0[i]*mCHt0[j] + k1[i]*mCHt1[j] + k2[i]*mCHt2[j] );</span>
<span class="lineNum">     875 </span>            :       }
<span class="lineNum">     876 </span>            :     }
<span class="lineNum">     877 </span>            : 
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :     for(int i=21; i&lt;28; i++) fC[i] = ffC[i];</span>
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span>            :     //* Calculate Chi^2 
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :     fNDF  += 2;</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :     fQ    +=  Daughter.GetQ();</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     fSFromDecay = 0;    </span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :     fChi2 += (mS[0]*zeta[0] + mS[1]*zeta[1] + mS[3]*zeta[2])*zeta[0]</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :       +      (mS[1]*zeta[0] + mS[2]*zeta[1] + mS[4]*zeta[2])*zeta[1]</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :       +      (mS[3]*zeta[0] + mS[4]*zeta[1] + mS[5]*zeta[2])*zeta[2];     </span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :   }</span>
<a name="889"><span class="lineNum">     889 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     890 </span>            : 
<span class="lineNum">     891 </span>            : void AliKFParticleBase::AddDaughterWithEnergyFitMC( const AliKFParticleBase &amp;Daughter )
<span class="lineNum">     892 </span>            : {
<span class="lineNum">     893 </span>            :   //* Energy considered as an independent variable, fitted independently from momentum, without any constraints on mass
<span class="lineNum">     894 </span>            : 
<span class="lineNum">     895 </span>            :   //* Add daughter 
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span><span class="lineCov">        148 :   TransportToDecayVertex();</span>
<span class="lineNum">     898 </span>            : 
<span class="lineNum">     899 </span><span class="lineCov">         74 :   Double_t b[3]; </span>
<span class="lineNum">     900 </span>            :   Int_t maxIter = 1;
<span class="lineNum">     901 </span>            : 
<span class="lineNum">     902 </span><span class="lineCov">         74 :   if( !fIsLinearized ){</span>
<span class="lineNum">     903 </span><span class="lineCov">         74 :     if( fNDF==-1 ){</span>
<span class="lineNum">     904 </span><span class="lineCov">         74 :       Double_t ds, ds1;</span>
<span class="lineNum">     905 </span><span class="lineCov">         74 :       GetDStoParticle(Daughter, ds, ds1);      </span>
<span class="lineNum">     906 </span><span class="lineCov">         74 :       TransportToDS( ds );</span>
<span class="lineNum">     907 </span><span class="lineCov">         74 :       Double_t m[8];</span>
<span class="lineNum">     908 </span><span class="lineCov">         74 :       Double_t mCd[36];       </span>
<span class="lineNum">     909 </span><span class="lineCov">         74 :       Daughter.Transport( ds1, m, mCd );    </span>
<span class="lineNum">     910 </span><span class="lineCov">         74 :       fVtxGuess[0] = .5*( fP[0] + m[0] );</span>
<span class="lineNum">     911 </span><span class="lineCov">         74 :       fVtxGuess[1] = .5*( fP[1] + m[1] );</span>
<span class="lineNum">     912 </span><span class="lineCov">         74 :       fVtxGuess[2] = .5*( fP[2] + m[2] );</span>
<span class="lineNum">     913 </span><span class="lineCov">         74 :     } else {</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :       fVtxGuess[0] = fP[0];</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :       fVtxGuess[1] = fP[1];</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :       fVtxGuess[2] = fP[2]; </span>
<span class="lineNum">     917 </span>            :     }
<span class="lineNum">     918 </span>            :     maxIter = 3;
<span class="lineNum">     919 </span><span class="lineCov">         74 :   }</span>
<span class="lineNum">     920 </span>            : 
<span class="lineNum">     921 </span><span class="lineCov">        592 :   for( Int_t iter=0; iter&lt;maxIter; iter++ ){</span>
<span class="lineNum">     922 </span>            : 
<span class="lineNum">     923 </span>            :     {
<span class="lineNum">     924 </span><span class="lineCov">        222 :       GetFieldValue( fVtxGuess, b );</span>
<span class="lineNum">     925 </span>            :       const Double_t kCLight =  0.000299792458;
<span class="lineNum">     926 </span><span class="lineCov">        222 :       b[0]*=kCLight; b[1]*=kCLight; b[2]*=kCLight;</span>
<span class="lineNum">     927 </span>            :     }
<span class="lineNum">     928 </span>            : 
<span class="lineNum">     929 </span><span class="lineCov">        222 :     Double_t *ffP = fP, *ffC = fC, tmpP[8], tmpC[36];</span>
<span class="lineNum">     930 </span><span class="lineCov">        222 :     if( fNDF==-1 ){            </span>
<span class="lineNum">     931 </span><span class="lineCov">        222 :       GetMeasurement( fVtxGuess, tmpP, tmpC );</span>
<span class="lineNum">     932 </span>            :       ffP = tmpP;
<span class="lineNum">     933 </span>            :       ffC = tmpC;
<span class="lineNum">     934 </span><span class="lineCov">        222 :     }</span>
<span class="lineNum">     935 </span><span class="lineCov">        222 :     Double_t m[8], mV[36];</span>
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span><span class="lineCov">        222 :     if( Daughter.fC[35]&gt;0 ){</span>
<span class="lineNum">     938 </span><span class="lineCov">        222 :       Daughter.GetMeasurement( fVtxGuess, m, mV );</span>
<span class="lineNum">     939 </span><span class="lineCov">        222 :     } else {</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :       for( Int_t i=0; i&lt;8; i++ ) m[i] = Daughter.fP[i];</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :       for( Int_t i=0; i&lt;36; i++ ) mV[i] = Daughter.fC[i];</span>
<span class="lineNum">     942 </span>            :     }
<span class="lineNum">     943 </span>            :     //*
<span class="lineNum">     944 </span>            : 
<span class="lineNum">     945 </span>            :     Double_t mS[6];
<span class="lineNum">     946 </span>            :     {
<span class="lineNum">     947 </span><span class="lineCov">        222 :       Double_t mSi[6] = { ffC[0]+mV[0], </span>
<span class="lineNum">     948 </span><span class="lineCov">        222 :                           ffC[1]+mV[1], ffC[2]+mV[2], </span>
<span class="lineNum">     949 </span><span class="lineCov">        222 :                           ffC[3]+mV[3], ffC[4]+mV[4], ffC[5]+mV[5] };</span>
<span class="lineNum">     950 </span>            :      
<span class="lineNum">     951 </span><span class="lineCov">        222 :       mS[0] = mSi[2]*mSi[5] - mSi[4]*mSi[4];</span>
<span class="lineNum">     952 </span><span class="lineCov">        222 :       mS[1] = mSi[3]*mSi[4] - mSi[1]*mSi[5];</span>
<span class="lineNum">     953 </span><span class="lineCov">        222 :       mS[2] = mSi[0]*mSi[5] - mSi[3]*mSi[3];</span>
<span class="lineNum">     954 </span><span class="lineCov">        222 :       mS[3] = mSi[1]*mSi[4] - mSi[2]*mSi[3];</span>
<span class="lineNum">     955 </span><span class="lineCov">        222 :       mS[4] = mSi[1]*mSi[3] - mSi[0]*mSi[4];</span>
<span class="lineNum">     956 </span><span class="lineCov">        222 :       mS[5] = mSi[0]*mSi[2] - mSi[1]*mSi[1];     </span>
<span class="lineNum">     957 </span>            :       
<span class="lineNum">     958 </span><span class="lineCov">        222 :       Double_t s = ( mSi[0]*mS[0] + mSi[1]*mS[1] + mSi[3]*mS[3] );      </span>
<span class="lineNum">     959 </span>            : 
<span class="lineNum">     960 </span><span class="lineCov">        666 :       s = ( s &gt; 1.E-20 )  ?1./s :0;    </span>
<span class="lineNum">     961 </span><span class="lineCov">        222 :       mS[0]*=s;</span>
<span class="lineNum">     962 </span><span class="lineCov">        222 :       mS[1]*=s;</span>
<span class="lineNum">     963 </span><span class="lineCov">        222 :       mS[2]*=s;</span>
<span class="lineNum">     964 </span><span class="lineCov">        222 :       mS[3]*=s;</span>
<span class="lineNum">     965 </span><span class="lineCov">        222 :       mS[4]*=s;</span>
<span class="lineNum">     966 </span><span class="lineCov">        222 :       mS[5]*=s;</span>
<span class="lineNum">     967 </span>            :     }
<span class="lineNum">     968 </span>            :     //* Residual (measured - estimated)
<span class="lineNum">     969 </span>            :     
<span class="lineNum">     970 </span><span class="lineCov">        222 :     Double_t zeta[3] = { m[0]-ffP[0], m[1]-ffP[1], m[2]-ffP[2] };    </span>
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span>            :     
<span class="lineNum">     973 </span>            :     //* CHt = CH'
<span class="lineNum">     974 </span>            :     
<span class="lineNum">     975 </span><span class="lineCov">        222 :     Double_t mCHt0[7], mCHt1[7], mCHt2[7];</span>
<span class="lineNum">     976 </span>            :     
<span class="lineNum">     977 </span><span class="lineCov">        222 :     mCHt0[0]=ffC[ 0] ; mCHt1[0]=ffC[ 1] ; mCHt2[0]=ffC[ 3] ;</span>
<span class="lineNum">     978 </span><span class="lineCov">        222 :     mCHt0[1]=ffC[ 1] ; mCHt1[1]=ffC[ 2] ; mCHt2[1]=ffC[ 4] ;</span>
<span class="lineNum">     979 </span><span class="lineCov">        222 :     mCHt0[2]=ffC[ 3] ; mCHt1[2]=ffC[ 4] ; mCHt2[2]=ffC[ 5] ;</span>
<span class="lineNum">     980 </span><span class="lineCov">        222 :     mCHt0[3]=ffC[ 6] ; mCHt1[3]=ffC[ 7] ; mCHt2[3]=ffC[ 8] ;</span>
<span class="lineNum">     981 </span><span class="lineCov">        222 :     mCHt0[4]=ffC[10] ; mCHt1[4]=ffC[11] ; mCHt2[4]=ffC[12] ;</span>
<span class="lineNum">     982 </span><span class="lineCov">        222 :     mCHt0[5]=ffC[15] ; mCHt1[5]=ffC[16] ; mCHt2[5]=ffC[17] ;</span>
<span class="lineNum">     983 </span><span class="lineCov">        222 :     mCHt0[6]=ffC[21] ; mCHt1[6]=ffC[22] ; mCHt2[6]=ffC[23] ;</span>
<span class="lineNum">     984 </span>            :   
<span class="lineNum">     985 </span>            :     //* Kalman gain K = mCH'*S
<span class="lineNum">     986 </span>            :     
<span class="lineNum">     987 </span><span class="lineCov">        222 :     Double_t k0[7], k1[7], k2[7];</span>
<span class="lineNum">     988 </span>            :     
<span class="lineNum">     989 </span><span class="lineCov">       3552 :     for(Int_t i=0;i&lt;7;++i){</span>
<span class="lineNum">     990 </span><span class="lineCov">       1554 :       k0[i] = mCHt0[i]*mS[0] + mCHt1[i]*mS[1] + mCHt2[i]*mS[3];</span>
<span class="lineNum">     991 </span><span class="lineCov">       1554 :       k1[i] = mCHt0[i]*mS[1] + mCHt1[i]*mS[2] + mCHt2[i]*mS[4];</span>
<span class="lineNum">     992 </span><span class="lineCov">       1554 :       k2[i] = mCHt0[i]*mS[3] + mCHt1[i]*mS[4] + mCHt2[i]*mS[5];</span>
<span class="lineNum">     993 </span>            :     }
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span>            :    //* New estimation of the vertex position 
<span class="lineNum">     996 </span>            : 
<span class="lineNum">     997 </span><span class="lineCov">        222 :     if( iter&lt;maxIter-1 ){</span>
<span class="lineNum">     998 </span><span class="lineCov">       1184 :       for(Int_t i=0; i&lt;3; ++i) </span>
<span class="lineNum">     999 </span><span class="lineCov">        444 :         fVtxGuess[i]= ffP[i] + k0[i]*zeta[0]+k1[i]*zeta[1]+k2[i]*zeta[2];</span>
<span class="lineNum">    1000 </span><span class="lineCov">        148 :       continue;</span>
<span class="lineNum">    1001 </span>            :     }
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span>            :     // last itearation -&gt; update the particle
<span class="lineNum">    1004 </span>            : 
<span class="lineNum">    1005 </span>            :     //* VHt = VH'
<span class="lineNum">    1006 </span>            :     
<span class="lineNum">    1007 </span><span class="lineCov">         74 :     Double_t mVHt0[7], mVHt1[7], mVHt2[7];</span>
<span class="lineNum">    1008 </span>            :     
<span class="lineNum">    1009 </span><span class="lineCov">         74 :     mVHt0[0]=mV[ 0] ; mVHt1[0]=mV[ 1] ; mVHt2[0]=mV[ 3] ;</span>
<span class="lineNum">    1010 </span><span class="lineCov">         74 :     mVHt0[1]=mV[ 1] ; mVHt1[1]=mV[ 2] ; mVHt2[1]=mV[ 4] ;</span>
<span class="lineNum">    1011 </span><span class="lineCov">         74 :     mVHt0[2]=mV[ 3] ; mVHt1[2]=mV[ 4] ; mVHt2[2]=mV[ 5] ;</span>
<span class="lineNum">    1012 </span><span class="lineCov">         74 :     mVHt0[3]=mV[ 6] ; mVHt1[3]=mV[ 7] ; mVHt2[3]=mV[ 8] ;</span>
<span class="lineNum">    1013 </span><span class="lineCov">         74 :     mVHt0[4]=mV[10] ; mVHt1[4]=mV[11] ; mVHt2[4]=mV[12] ;</span>
<span class="lineNum">    1014 </span><span class="lineCov">         74 :     mVHt0[5]=mV[15] ; mVHt1[5]=mV[16] ; mVHt2[5]=mV[17] ;</span>
<span class="lineNum">    1015 </span><span class="lineCov">         74 :     mVHt0[6]=mV[21] ; mVHt1[6]=mV[22] ; mVHt2[6]=mV[23] ;</span>
<span class="lineNum">    1016 </span>            :   
<span class="lineNum">    1017 </span>            :     //* Kalman gain Km = mCH'*S
<span class="lineNum">    1018 </span>            :     
<span class="lineNum">    1019 </span><span class="lineCov">         74 :     Double_t km0[7], km1[7], km2[7];</span>
<span class="lineNum">    1020 </span>            :     
<span class="lineNum">    1021 </span><span class="lineCov">       1184 :     for(Int_t i=0;i&lt;7;++i){</span>
<span class="lineNum">    1022 </span><span class="lineCov">        518 :       km0[i] = mVHt0[i]*mS[0] + mVHt1[i]*mS[1] + mVHt2[i]*mS[3];</span>
<span class="lineNum">    1023 </span><span class="lineCov">        518 :       km1[i] = mVHt0[i]*mS[1] + mVHt1[i]*mS[2] + mVHt2[i]*mS[4];</span>
<span class="lineNum">    1024 </span><span class="lineCov">        518 :       km2[i] = mVHt0[i]*mS[3] + mVHt1[i]*mS[4] + mVHt2[i]*mS[5];</span>
<span class="lineNum">    1025 </span>            :     }
<span class="lineNum">    1026 </span>            : 
<span class="lineNum">    1027 </span><span class="lineCov">       1184 :     for(Int_t i=0;i&lt;7;++i) </span>
<span class="lineNum">    1028 </span><span class="lineCov">        518 :       ffP[i] = ffP[i] + k0[i]*zeta[0] + k1[i]*zeta[1] + k2[i]*zeta[2];</span>
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span><span class="lineCov">       1184 :     for(Int_t i=0;i&lt;7;++i) </span>
<span class="lineNum">    1031 </span><span class="lineCov">        518 :       m[i] = m[i] - km0[i]*zeta[0] - km1[i]*zeta[1] - km2[i]*zeta[2];</span>
<span class="lineNum">    1032 </span>            : 
<span class="lineNum">    1033 </span><span class="lineCov">       1184 :     for(Int_t i=0, k=0;i&lt;7;++i){</span>
<span class="lineNum">    1034 </span><span class="lineCov">       5180 :       for(Int_t j=0;j&lt;=i;++j,++k){</span>
<span class="lineNum">    1035 </span><span class="lineCov">       2072 :         ffC[k] = ffC[k] - (k0[i]*mCHt0[j] + k1[i]*mCHt1[j] + k2[i]*mCHt2[j] );</span>
<span class="lineNum">    1036 </span>            :       }
<span class="lineNum">    1037 </span>            :     }
<span class="lineNum">    1038 </span>            : 
<span class="lineNum">    1039 </span><span class="lineCov">       1184 :     for(Int_t i=0, k=0;i&lt;7;++i){</span>
<span class="lineNum">    1040 </span><span class="lineCov">       5180 :       for(Int_t j=0;j&lt;=i;++j,++k){</span>
<span class="lineNum">    1041 </span><span class="lineCov">       2072 :         mV[k] = mV[k] - (km0[i]*mVHt0[j] + km1[i]*mVHt1[j] + km2[i]*mVHt2[j] );</span>
<span class="lineNum">    1042 </span>            :       }
<span class="lineNum">    1043 </span>            :     }
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span><span class="lineCov">         74 :     Double_t mDf[7][7];</span>
<span class="lineNum">    1046 </span>            : 
<span class="lineNum">    1047 </span><span class="lineCov">       1184 :     for(Int_t i=0;i&lt;7;++i){</span>
<span class="lineNum">    1048 </span><span class="lineCov">       8288 :       for(Int_t j=0;j&lt;7;++j){</span>
<span class="lineNum">    1049 </span><span class="lineCov">       3626 :         mDf[i][j] = (km0[i]*mCHt0[j] + km1[i]*mCHt1[j] + km2[i]*mCHt2[j] );</span>
<span class="lineNum">    1050 </span>            :       }
<span class="lineNum">    1051 </span>            :     }
<span class="lineNum">    1052 </span>            : 
<span class="lineNum">    1053 </span><span class="lineCov">         74 :     Double_t mJ1[7][7], mJ2[7][7];</span>
<span class="lineNum">    1054 </span><span class="lineCov">       1184 :     for(Int_t iPar1=0; iPar1&lt;7; iPar1++)</span>
<span class="lineNum">    1055 </span>            :     {
<span class="lineNum">    1056 </span><span class="lineCov">       8288 :       for(Int_t iPar2=0; iPar2&lt;7; iPar2++)</span>
<span class="lineNum">    1057 </span>            :       {
<span class="lineNum">    1058 </span><span class="lineCov">       3626 :         mJ1[iPar1][iPar2] = 0;</span>
<span class="lineNum">    1059 </span><span class="lineCov">       3626 :         mJ2[iPar1][iPar2] = 0;</span>
<span class="lineNum">    1060 </span>            :       }
<span class="lineNum">    1061 </span>            :     }
<span class="lineNum">    1062 </span>            : 
<span class="lineNum">    1063 </span><span class="lineCov">         74 :     Double_t mMassParticle  = ffP[6]*ffP[6] - (ffP[3]*ffP[3] + ffP[4]*ffP[4] + ffP[5]*ffP[5]);</span>
<span class="lineNum">    1064 </span><span class="lineCov">         74 :     Double_t mMassDaughter  = m[6]*m[6] - (m[3]*m[3] + m[4]*m[4] + m[5]*m[5]);</span>
<span class="lineNum">    1065 </span><span class="lineCov">        136 :     if(mMassParticle &gt; 0) mMassParticle = TMath::Sqrt(mMassParticle);</span>
<span class="lineNum">    1066 </span><span class="lineCov">        130 :     if(mMassDaughter &gt; 0) mMassDaughter = TMath::Sqrt(mMassDaughter);</span>
<span class="lineNum">    1067 </span>            : 
<span class="lineNum">    1068 </span><span class="lineCov">         74 :     if( fMassHypo &gt; -0.5)</span>
<span class="lineNum">    1069 </span><span class="lineCov">         74 :       SetMassConstraint(ffP,ffC,mJ1,fMassHypo);</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :     else if((mMassParticle &lt; SumDaughterMass) || (ffP[6]&lt;0) )</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :       SetMassConstraint(ffP,ffC,mJ1,SumDaughterMass);</span>
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span><span class="lineCov">         74 :     if(Daughter.fMassHypo &gt; -0.5)</span>
<span class="lineNum">    1074 </span><span class="lineCov">         74 :       SetMassConstraint(m,mV,mJ2,Daughter.fMassHypo);</span>
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :     else if((mMassDaughter &lt; Daughter.SumDaughterMass) || (m[6] &lt; 0) )</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :       SetMassConstraint(m,mV,mJ2,Daughter.SumDaughterMass);</span>
<span class="lineNum">    1077 </span>            : 
<span class="lineNum">    1078 </span><span class="lineCov">         74 :     Double_t mDJ[7][7];</span>
<span class="lineNum">    1079 </span>            : 
<span class="lineNum">    1080 </span><span class="lineCov">       1184 :     for(Int_t i=0; i&lt;7; i++) {</span>
<span class="lineNum">    1081 </span><span class="lineCov">       8288 :       for(Int_t j=0; j&lt;7; j++) {</span>
<span class="lineNum">    1082 </span><span class="lineCov">       3626 :         mDJ[i][j] = 0;</span>
<span class="lineNum">    1083 </span><span class="lineCov">      58016 :         for(Int_t k=0; k&lt;7; k++) {</span>
<span class="lineNum">    1084 </span><span class="lineCov">      25382 :           mDJ[i][j] += mDf[i][k]*mJ1[j][k];</span>
<span class="lineNum">    1085 </span>            :         }
<span class="lineNum">    1086 </span>            :       }
<span class="lineNum">    1087 </span>            :     }
<span class="lineNum">    1088 </span>            : 
<span class="lineNum">    1089 </span><span class="lineCov">       1184 :     for(Int_t i=0; i&lt;7; ++i){</span>
<span class="lineNum">    1090 </span><span class="lineCov">       8288 :       for(Int_t j=0; j&lt;7; ++j){</span>
<span class="lineNum">    1091 </span><span class="lineCov">       3626 :         mDf[i][j]=0;</span>
<span class="lineNum">    1092 </span><span class="lineCov">      58016 :         for(Int_t l=0; l&lt;7; l++){</span>
<span class="lineNum">    1093 </span><span class="lineCov">      25382 :           mDf[i][j] += mJ2[i][l]*mDJ[l][j];</span>
<span class="lineNum">    1094 </span>            :         }
<span class="lineNum">    1095 </span>            :       }
<span class="lineNum">    1096 </span>            :     }
<span class="lineNum">    1097 </span>            : 
<span class="lineNum">    1098 </span>            :     //* Add the daughter momentum to the particle momentum
<span class="lineNum">    1099 </span>            : 
<span class="lineNum">    1100 </span><span class="lineCov">         74 :     ffP[ 3] += m[ 3];</span>
<span class="lineNum">    1101 </span><span class="lineCov">         74 :     ffP[ 4] += m[ 4];</span>
<span class="lineNum">    1102 </span><span class="lineCov">         74 :     ffP[ 5] += m[ 5];</span>
<span class="lineNum">    1103 </span><span class="lineCov">         74 :     ffP[ 6] += m[ 6];</span>
<span class="lineNum">    1104 </span>            : 
<span class="lineNum">    1105 </span><span class="lineCov">         74 :     ffC[ 9] += mV[ 9];</span>
<span class="lineNum">    1106 </span><span class="lineCov">         74 :     ffC[13] += mV[13];</span>
<span class="lineNum">    1107 </span><span class="lineCov">         74 :     ffC[14] += mV[14];</span>
<span class="lineNum">    1108 </span><span class="lineCov">         74 :     ffC[18] += mV[18];</span>
<span class="lineNum">    1109 </span><span class="lineCov">         74 :     ffC[19] += mV[19];</span>
<span class="lineNum">    1110 </span><span class="lineCov">         74 :     ffC[20] += mV[20];</span>
<span class="lineNum">    1111 </span><span class="lineCov">         74 :     ffC[24] += mV[24];</span>
<span class="lineNum">    1112 </span><span class="lineCov">         74 :     ffC[25] += mV[25];</span>
<span class="lineNum">    1113 </span><span class="lineCov">         74 :     ffC[26] += mV[26];</span>
<span class="lineNum">    1114 </span><span class="lineCov">         74 :     ffC[27] += mV[27];</span>
<span class="lineNum">    1115 </span>            : 
<span class="lineNum">    1116 </span><span class="lineCov">         74 :     ffC[6 ] += mDf[3][0]; ffC[7 ] += mDf[3][1]; ffC[8 ] += mDf[3][2];</span>
<span class="lineNum">    1117 </span><span class="lineCov">         74 :     ffC[10] += mDf[4][0]; ffC[11] += mDf[4][1]; ffC[12] += mDf[4][2];</span>
<span class="lineNum">    1118 </span><span class="lineCov">         74 :     ffC[15] += mDf[5][0]; ffC[16] += mDf[5][1]; ffC[17] += mDf[5][2];</span>
<span class="lineNum">    1119 </span><span class="lineCov">         74 :     ffC[21] += mDf[6][0]; ffC[22] += mDf[6][1]; ffC[23] += mDf[6][2];</span>
<span class="lineNum">    1120 </span>            : 
<span class="lineNum">    1121 </span><span class="lineCov">         74 :     ffC[9 ] += mDf[3][3] + mDf[3][3];</span>
<span class="lineNum">    1122 </span><span class="lineCov">         74 :     ffC[13] += mDf[4][3] + mDf[3][4]; ffC[14] += mDf[4][4] + mDf[4][4];</span>
<span class="lineNum">    1123 </span><span class="lineCov">         74 :     ffC[18] += mDf[5][3] + mDf[3][5]; ffC[19] += mDf[5][4] + mDf[4][5]; ffC[20] += mDf[5][5] + mDf[5][5];</span>
<span class="lineNum">    1124 </span><span class="lineCov">         74 :     ffC[24] += mDf[6][3] + mDf[3][6]; ffC[25] += mDf[6][4] + mDf[4][6]; ffC[26] += mDf[6][5] + mDf[5][6]; ffC[27] += mDf[6][6] + mDf[6][6];</span>
<span class="lineNum">    1125 </span>            : 
<span class="lineNum">    1126 </span>            :    //* New estimation of the vertex position r += K*zeta
<span class="lineNum">    1127 </span>            : 
<span class="lineNum">    1128 </span><span class="lineCov">       1184 :     for(Int_t i=0;i&lt;7;++i) </span>
<span class="lineNum">    1129 </span><span class="lineCov">        518 :       fP[i] = ffP[i];</span>
<span class="lineNum">    1130 </span>            : 
<span class="lineNum">    1131 </span>            :     //* New covariance matrix C -= K*(mCH')'
<span class="lineNum">    1132 </span>            : 
<span class="lineNum">    1133 </span><span class="lineCov">       1184 :     for(Int_t i=0, k=0;i&lt;7;++i){</span>
<span class="lineNum">    1134 </span><span class="lineCov">       5180 :       for(Int_t j=0;j&lt;=i;++j,++k){</span>
<span class="lineNum">    1135 </span><span class="lineCov">       2072 :         fC[k] = ffC[k];</span>
<span class="lineNum">    1136 </span>            :       }
<span class="lineNum">    1137 </span>            :     }
<span class="lineNum">    1138 </span>            :     //* Calculate Chi^2 
<span class="lineNum">    1139 </span>            : 
<span class="lineNum">    1140 </span><span class="lineCov">         74 :     fNDF  += 2;</span>
<span class="lineNum">    1141 </span><span class="lineCov">         74 :     fQ    +=  Daughter.GetQ();</span>
<span class="lineNum">    1142 </span><span class="lineCov">         74 :     fSFromDecay = 0;    </span>
<span class="lineNum">    1143 </span><span class="lineCov">        148 :     fChi2 += (mS[0]*zeta[0] + mS[1]*zeta[1] + mS[3]*zeta[2])*zeta[0]</span>
<span class="lineNum">    1144 </span><span class="lineCov">         74 :       +      (mS[1]*zeta[0] + mS[2]*zeta[1] + mS[4]*zeta[2])*zeta[1]</span>
<span class="lineNum">    1145 </span><span class="lineCov">         74 :       +      (mS[3]*zeta[0] + mS[4]*zeta[1] + mS[5]*zeta[2])*zeta[2];</span>
<span class="lineNum">    1146 </span><span class="lineCov">        296 :   }</span>
<a name="1147"><span class="lineNum">    1147 </span><span class="lineCov">         74 : }</span></a>
<span class="lineNum">    1148 </span>            : 
<span class="lineNum">    1149 </span>            : void AliKFParticleBase::SetProductionVertex( const AliKFParticleBase &amp;Vtx )
<span class="lineNum">    1150 </span>            : {
<span class="lineNum">    1151 </span>            :   //* Set production vertex for the particle, when the particle was not used in the vertex fit
<span class="lineNum">    1152 </span>            : 
<span class="lineNum">    1153 </span><span class="lineCov">        148 :   const Double_t *m = Vtx.fP, *mV = Vtx.fC;</span>
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span><span class="lineCov">         74 :   Bool_t noS = ( fC[35]&lt;=0 ); // no decay length allowed</span>
<span class="lineNum">    1156 </span>            : 
<span class="lineNum">    1157 </span><span class="lineCov">         74 :   if( noS ){ </span>
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :     TransportToDecayVertex();</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :     fP[7] = 0;</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :     fC[28] = fC[29] = fC[30] = fC[31] = fC[32] = fC[33] = fC[34] = fC[35] = 0;</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    1162 </span><span class="lineCov">         74 :     TransportToDS( GetDStoPoint( m ) );    </span>
<span class="lineNum">    1163 </span><span class="lineCov">         74 :     fP[7] = -fSFromDecay;</span>
<span class="lineNum">    1164 </span><span class="lineCov">         74 :     fC[28] = fC[29] = fC[30] = fC[31] = fC[32] = fC[33] = fC[34] = 0;</span>
<span class="lineNum">    1165 </span><span class="lineCov">         74 :     fC[35] = 0.1;</span>
<span class="lineNum">    1166 </span>            :     
<span class="lineNum">    1167 </span><span class="lineCov">         74 :     Convert(1);</span>
<span class="lineNum">    1168 </span>            :   }
<span class="lineNum">    1169 </span>            : 
<span class="lineNum">    1170 </span><span class="lineCov">         74 :   Double_t mAi[6];</span>
<span class="lineNum">    1171 </span>            : 
<span class="lineNum">    1172 </span><span class="lineCov">         74 :   InvertSym3( fC, mAi );</span>
<span class="lineNum">    1173 </span>            : 
<span class="lineNum">    1174 </span>            :   Double_t mB[5][3];
<span class="lineNum">    1175 </span>            : 
<span class="lineNum">    1176 </span><span class="lineCov">         74 :   mB[0][0] = fC[ 6]*mAi[0] + fC[ 7]*mAi[1] + fC[ 8]*mAi[3];</span>
<span class="lineNum">    1177 </span><span class="lineCov">         74 :   mB[0][1] = fC[ 6]*mAi[1] + fC[ 7]*mAi[2] + fC[ 8]*mAi[4];</span>
<span class="lineNum">    1178 </span><span class="lineCov">         74 :   mB[0][2] = fC[ 6]*mAi[3] + fC[ 7]*mAi[4] + fC[ 8]*mAi[5];</span>
<span class="lineNum">    1179 </span>            : 
<span class="lineNum">    1180 </span><span class="lineCov">         74 :   mB[1][0] = fC[10]*mAi[0] + fC[11]*mAi[1] + fC[12]*mAi[3];</span>
<span class="lineNum">    1181 </span><span class="lineCov">         74 :   mB[1][1] = fC[10]*mAi[1] + fC[11]*mAi[2] + fC[12]*mAi[4];</span>
<span class="lineNum">    1182 </span><span class="lineCov">         74 :   mB[1][2] = fC[10]*mAi[3] + fC[11]*mAi[4] + fC[12]*mAi[5];</span>
<span class="lineNum">    1183 </span>            : 
<span class="lineNum">    1184 </span><span class="lineCov">         74 :   mB[2][0] = fC[15]*mAi[0] + fC[16]*mAi[1] + fC[17]*mAi[3];</span>
<span class="lineNum">    1185 </span><span class="lineCov">         74 :   mB[2][1] = fC[15]*mAi[1] + fC[16]*mAi[2] + fC[17]*mAi[4];</span>
<span class="lineNum">    1186 </span><span class="lineCov">         74 :   mB[2][2] = fC[15]*mAi[3] + fC[16]*mAi[4] + fC[17]*mAi[5];</span>
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span><span class="lineCov">         74 :   mB[3][0] = fC[21]*mAi[0] + fC[22]*mAi[1] + fC[23]*mAi[3];</span>
<span class="lineNum">    1189 </span><span class="lineCov">         74 :   mB[3][1] = fC[21]*mAi[1] + fC[22]*mAi[2] + fC[23]*mAi[4];</span>
<span class="lineNum">    1190 </span><span class="lineCov">         74 :   mB[3][2] = fC[21]*mAi[3] + fC[22]*mAi[4] + fC[23]*mAi[5];</span>
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span><span class="lineCov">         74 :   mB[4][0] = fC[28]*mAi[0] + fC[29]*mAi[1] + fC[30]*mAi[3];</span>
<span class="lineNum">    1193 </span><span class="lineCov">         74 :   mB[4][1] = fC[28]*mAi[1] + fC[29]*mAi[2] + fC[30]*mAi[4];</span>
<span class="lineNum">    1194 </span><span class="lineCov">         74 :   mB[4][2] = fC[28]*mAi[3] + fC[29]*mAi[4] + fC[30]*mAi[5];</span>
<span class="lineNum">    1195 </span>            : 
<span class="lineNum">    1196 </span><span class="lineCov">         74 :   Double_t z[3] = { m[0]-fP[0], m[1]-fP[1], m[2]-fP[2] };</span>
<span class="lineNum">    1197 </span>            : 
<span class="lineNum">    1198 </span>            :   {
<span class="lineNum">    1199 </span><span class="lineCov">        296 :     Double_t mAVi[6] = { fC[0]-mV[0], fC[1]-mV[1], fC[2]-mV[2], </span>
<span class="lineNum">    1200 </span><span class="lineCov">        222 :                         fC[3]-mV[3], fC[4]-mV[4], fC[5]-mV[5] };</span>
<span class="lineNum">    1201 </span>            :     
<span class="lineNum">    1202 </span><span class="lineCov">         74 :     if( !InvertSym3( mAVi, mAVi ) ){</span>
<span class="lineNum">    1203 </span>            : 
<span class="lineNum">    1204 </span><span class="lineCov">         74 :       Double_t dChi2 = ( +(mAVi[0]*z[0] + mAVi[1]*z[1] + mAVi[3]*z[2])*z[0]</span>
<span class="lineNum">    1205 </span><span class="lineCov">         74 :                          +(mAVi[1]*z[0] + mAVi[2]*z[1] + mAVi[4]*z[2])*z[1]</span>
<span class="lineNum">    1206 </span><span class="lineCov">         74 :                          +(mAVi[3]*z[0] + mAVi[4]*z[1] + mAVi[5]*z[2])*z[2] );</span>
<span class="lineNum">    1207 </span>            :       
<span class="lineNum">    1208 </span>            :       // Take Abs(dChi2) here. Negative value of 'det' or 'dChi2' shows that the particle 
<span class="lineNum">    1209 </span>            :       // was not used in the production vertex fit
<span class="lineNum">    1210 </span>            :       
<span class="lineNum">    1211 </span><span class="lineCov">         74 :       fChi2+= TMath::Abs( dChi2 );</span>
<span class="lineNum">    1212 </span><span class="lineCov">         74 :     }</span>
<span class="lineNum">    1213 </span><span class="lineCov">         74 :     fNDF  += 2;</span>
<span class="lineNum">    1214 </span><span class="lineCov">         74 :   }</span>
<span class="lineNum">    1215 </span>            :   
<span class="lineNum">    1216 </span><span class="lineCov">         74 :   fP[0] = m[0];</span>
<span class="lineNum">    1217 </span><span class="lineCov">         74 :   fP[1] = m[1];</span>
<span class="lineNum">    1218 </span><span class="lineCov">         74 :   fP[2] = m[2];</span>
<span class="lineNum">    1219 </span><span class="lineCov">         74 :   fP[3]+= mB[0][0]*z[0] + mB[0][1]*z[1] + mB[0][2]*z[2];</span>
<span class="lineNum">    1220 </span><span class="lineCov">         74 :   fP[4]+= mB[1][0]*z[0] + mB[1][1]*z[1] + mB[1][2]*z[2];</span>
<span class="lineNum">    1221 </span><span class="lineCov">         74 :   fP[5]+= mB[2][0]*z[0] + mB[2][1]*z[1] + mB[2][2]*z[2];</span>
<span class="lineNum">    1222 </span><span class="lineCov">         74 :   fP[6]+= mB[3][0]*z[0] + mB[3][1]*z[1] + mB[3][2]*z[2];</span>
<span class="lineNum">    1223 </span><span class="lineCov">         74 :   fP[7]+= mB[4][0]*z[0] + mB[4][1]*z[1] + mB[4][2]*z[2];</span>
<span class="lineNum">    1224 </span>            :   
<span class="lineNum">    1225 </span>            :   Double_t d0, d1, d2;
<span class="lineNum">    1226 </span>            : 
<span class="lineNum">    1227 </span><span class="lineCov">         74 :   fC[0] = mV[0];</span>
<span class="lineNum">    1228 </span><span class="lineCov">         74 :   fC[1] = mV[1];</span>
<span class="lineNum">    1229 </span><span class="lineCov">         74 :   fC[2] = mV[2];</span>
<span class="lineNum">    1230 </span><span class="lineCov">         74 :   fC[3] = mV[3];</span>
<span class="lineNum">    1231 </span><span class="lineCov">         74 :   fC[4] = mV[4];</span>
<span class="lineNum">    1232 </span><span class="lineCov">         74 :   fC[5] = mV[5];</span>
<span class="lineNum">    1233 </span>            : 
<span class="lineNum">    1234 </span><span class="lineCov">         74 :   d0= mB[0][0]*mV[0] + mB[0][1]*mV[1] + mB[0][2]*mV[3] - fC[ 6];</span>
<span class="lineNum">    1235 </span><span class="lineCov">         74 :   d1= mB[0][0]*mV[1] + mB[0][1]*mV[2] + mB[0][2]*mV[4] - fC[ 7];</span>
<span class="lineNum">    1236 </span><span class="lineCov">         74 :   d2= mB[0][0]*mV[3] + mB[0][1]*mV[4] + mB[0][2]*mV[5] - fC[ 8];</span>
<span class="lineNum">    1237 </span>            : 
<span class="lineNum">    1238 </span><span class="lineCov">         74 :   fC[ 6]+= d0;</span>
<span class="lineNum">    1239 </span><span class="lineCov">         74 :   fC[ 7]+= d1;</span>
<span class="lineNum">    1240 </span><span class="lineCov">         74 :   fC[ 8]+= d2;</span>
<span class="lineNum">    1241 </span><span class="lineCov">         74 :   fC[ 9]+= d0*mB[0][0] + d1*mB[0][1] + d2*mB[0][2];</span>
<span class="lineNum">    1242 </span>            : 
<span class="lineNum">    1243 </span><span class="lineCov">         74 :   d0= mB[1][0]*mV[0] + mB[1][1]*mV[1] + mB[1][2]*mV[3] - fC[10];</span>
<span class="lineNum">    1244 </span><span class="lineCov">         74 :   d1= mB[1][0]*mV[1] + mB[1][1]*mV[2] + mB[1][2]*mV[4] - fC[11];</span>
<span class="lineNum">    1245 </span><span class="lineCov">         74 :   d2= mB[1][0]*mV[3] + mB[1][1]*mV[4] + mB[1][2]*mV[5] - fC[12];</span>
<span class="lineNum">    1246 </span>            : 
<span class="lineNum">    1247 </span><span class="lineCov">         74 :   fC[10]+= d0;</span>
<span class="lineNum">    1248 </span><span class="lineCov">         74 :   fC[11]+= d1;</span>
<span class="lineNum">    1249 </span><span class="lineCov">         74 :   fC[12]+= d2;</span>
<span class="lineNum">    1250 </span><span class="lineCov">         74 :   fC[13]+= d0*mB[0][0] + d1*mB[0][1] + d2*mB[0][2];</span>
<span class="lineNum">    1251 </span><span class="lineCov">         74 :   fC[14]+= d0*mB[1][0] + d1*mB[1][1] + d2*mB[1][2];</span>
<span class="lineNum">    1252 </span>            : 
<span class="lineNum">    1253 </span><span class="lineCov">         74 :   d0= mB[2][0]*mV[0] + mB[2][1]*mV[1] + mB[2][2]*mV[3] - fC[15];</span>
<span class="lineNum">    1254 </span><span class="lineCov">         74 :   d1= mB[2][0]*mV[1] + mB[2][1]*mV[2] + mB[2][2]*mV[4] - fC[16];</span>
<span class="lineNum">    1255 </span><span class="lineCov">         74 :   d2= mB[2][0]*mV[3] + mB[2][1]*mV[4] + mB[2][2]*mV[5] - fC[17];</span>
<span class="lineNum">    1256 </span>            : 
<span class="lineNum">    1257 </span><span class="lineCov">         74 :   fC[15]+= d0;</span>
<span class="lineNum">    1258 </span><span class="lineCov">         74 :   fC[16]+= d1;</span>
<span class="lineNum">    1259 </span><span class="lineCov">         74 :   fC[17]+= d2;</span>
<span class="lineNum">    1260 </span><span class="lineCov">         74 :   fC[18]+= d0*mB[0][0] + d1*mB[0][1] + d2*mB[0][2];</span>
<span class="lineNum">    1261 </span><span class="lineCov">         74 :   fC[19]+= d0*mB[1][0] + d1*mB[1][1] + d2*mB[1][2];</span>
<span class="lineNum">    1262 </span><span class="lineCov">         74 :   fC[20]+= d0*mB[2][0] + d1*mB[2][1] + d2*mB[2][2];</span>
<span class="lineNum">    1263 </span>            : 
<span class="lineNum">    1264 </span><span class="lineCov">         74 :   d0= mB[3][0]*mV[0] + mB[3][1]*mV[1] + mB[3][2]*mV[3] - fC[21];</span>
<span class="lineNum">    1265 </span><span class="lineCov">         74 :   d1= mB[3][0]*mV[1] + mB[3][1]*mV[2] + mB[3][2]*mV[4] - fC[22];</span>
<span class="lineNum">    1266 </span><span class="lineCov">         74 :   d2= mB[3][0]*mV[3] + mB[3][1]*mV[4] + mB[3][2]*mV[5] - fC[23];</span>
<span class="lineNum">    1267 </span>            : 
<span class="lineNum">    1268 </span><span class="lineCov">         74 :   fC[21]+= d0;</span>
<span class="lineNum">    1269 </span><span class="lineCov">         74 :   fC[22]+= d1;</span>
<span class="lineNum">    1270 </span><span class="lineCov">         74 :   fC[23]+= d2;</span>
<span class="lineNum">    1271 </span><span class="lineCov">         74 :   fC[24]+= d0*mB[0][0] + d1*mB[0][1] + d2*mB[0][2];</span>
<span class="lineNum">    1272 </span><span class="lineCov">         74 :   fC[25]+= d0*mB[1][0] + d1*mB[1][1] + d2*mB[1][2];</span>
<span class="lineNum">    1273 </span><span class="lineCov">         74 :   fC[26]+= d0*mB[2][0] + d1*mB[2][1] + d2*mB[2][2];</span>
<span class="lineNum">    1274 </span><span class="lineCov">         74 :   fC[27]+= d0*mB[3][0] + d1*mB[3][1] + d2*mB[3][2];</span>
<span class="lineNum">    1275 </span>            : 
<span class="lineNum">    1276 </span><span class="lineCov">         74 :   d0= mB[4][0]*mV[0] + mB[4][1]*mV[1] + mB[4][2]*mV[3] - fC[28];</span>
<span class="lineNum">    1277 </span><span class="lineCov">         74 :   d1= mB[4][0]*mV[1] + mB[4][1]*mV[2] + mB[4][2]*mV[4] - fC[29];</span>
<span class="lineNum">    1278 </span><span class="lineCov">         74 :   d2= mB[4][0]*mV[3] + mB[4][1]*mV[4] + mB[4][2]*mV[5] - fC[30];</span>
<span class="lineNum">    1279 </span>            : 
<span class="lineNum">    1280 </span><span class="lineCov">         74 :   fC[28]+= d0;</span>
<span class="lineNum">    1281 </span><span class="lineCov">         74 :   fC[29]+= d1;</span>
<span class="lineNum">    1282 </span><span class="lineCov">         74 :   fC[30]+= d2;</span>
<span class="lineNum">    1283 </span><span class="lineCov">         74 :   fC[31]+= d0*mB[0][0] + d1*mB[0][1] + d2*mB[0][2];</span>
<span class="lineNum">    1284 </span><span class="lineCov">         74 :   fC[32]+= d0*mB[1][0] + d1*mB[1][1] + d2*mB[1][2];</span>
<span class="lineNum">    1285 </span><span class="lineCov">         74 :   fC[33]+= d0*mB[2][0] + d1*mB[2][1] + d2*mB[2][2];</span>
<span class="lineNum">    1286 </span><span class="lineCov">         74 :   fC[34]+= d0*mB[3][0] + d1*mB[3][1] + d2*mB[3][2];</span>
<span class="lineNum">    1287 </span><span class="lineCov">         74 :   fC[35]+= d0*mB[4][0] + d1*mB[4][1] + d2*mB[4][2];</span>
<span class="lineNum">    1288 </span>            :   
<span class="lineNum">    1289 </span><span class="lineCov">         74 :   if( noS ){ </span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :     fP[7] = 0;</span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :     fC[28] = fC[29] = fC[30] = fC[31] = fC[32] = fC[33] = fC[34] = fC[35] = 0;</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    1293 </span><span class="lineCov">         74 :     TransportToDS( fP[7] );</span>
<span class="lineNum">    1294 </span><span class="lineCov">         74 :     Convert(0);</span>
<span class="lineNum">    1295 </span>            :   }
<span class="lineNum">    1296 </span>            : 
<span class="lineNum">    1297 </span><span class="lineCov">         74 :   fSFromDecay = 0;</span>
<a name="1298"><span class="lineNum">    1298 </span><span class="lineCov">         74 : }</span></a>
<span class="lineNum">    1299 </span>            : 
<span class="lineNum">    1300 </span>            : void AliKFParticleBase::SetMassConstraint( Double_t *mP, Double_t *mC, Double_t mJ[7][7], Double_t mass )
<span class="lineNum">    1301 </span>            : {
<span class="lineNum">    1302 </span>            :   //* Set nonlinear mass constraint (Mass) on the state vector mP with a covariance matrix mC.
<span class="lineNum">    1303 </span>            :   
<span class="lineNum">    1304 </span><span class="lineCov">        296 :   const Double_t energy2 = mP[6]*mP[6], p2 = mP[3]*mP[3]+mP[4]*mP[4]+mP[5]*mP[5], mass2 = mass*mass;</span>
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span><span class="lineCov">        148 :   const Double_t a = energy2 - p2 + 2.*mass2;</span>
<span class="lineNum">    1307 </span><span class="lineCov">        148 :   const Double_t b = -2.*(energy2 + p2);</span>
<span class="lineNum">    1308 </span><span class="lineCov">        148 :   const Double_t c = energy2 - p2 - mass2;</span>
<span class="lineNum">    1309 </span>            : 
<span class="lineNum">    1310 </span>            :   Double_t lambda = 0;
<span class="lineNum">    1311 </span><span class="lineCov">        296 :   if(TMath::Abs(b) &gt; 1.e-10) lambda = -c / b;</span>
<span class="lineNum">    1312 </span>            : 
<span class="lineNum">    1313 </span><span class="lineCov">        148 :   Double_t d = 4.*energy2*p2 - mass2*(energy2-p2-2.*mass2);</span>
<span class="lineNum">    1314 </span><span class="lineCov">        444 :   if(d&gt;=0 &amp;&amp; TMath::Abs(a) &gt; 1.e-10) lambda = (energy2 + p2 - sqrt(d))/a;</span>
<span class="lineNum">    1315 </span>            : 
<span class="lineNum">    1316 </span><span class="lineCov">        148 :   if(mP[6] &lt; 0) //If energy &lt; 0 we need a lambda &lt; 0</span>
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :     lambda = -1000000.; //Empirical, a better solution should be found</span>
<span class="lineNum">    1318 </span>            : 
<span class="lineNum">    1319 </span>            :   Int_t iIter=0;
<span class="lineNum">    1320 </span><span class="lineCov">        306 :   for(iIter=0; iIter&lt;100; iIter++)</span>
<span class="lineNum">    1321 </span>            :   {
<span class="lineNum">    1322 </span><span class="lineCov">        153 :     Double_t lambda2 = lambda*lambda;</span>
<span class="lineNum">    1323 </span><span class="lineCov">        153 :     Double_t lambda4 = lambda2*lambda2;</span>
<span class="lineNum">    1324 </span>            : 
<span class="lineNum">    1325 </span>            :     Double_t lambda0 = lambda;
<span class="lineNum">    1326 </span>            : 
<span class="lineNum">    1327 </span><span class="lineCov">        153 :     Double_t f  = -mass2 * lambda4 + a*lambda2 + b*lambda + c;</span>
<span class="lineNum">    1328 </span><span class="lineCov">        153 :     Double_t df = -4.*mass2 * lambda2*lambda + 2.*a*lambda + b;</span>
<span class="lineNum">    1329 </span><span class="lineCov">        153 :     if(TMath::Abs(df) &lt; 1.e-10) break;</span>
<span class="lineNum">    1330 </span><span class="lineCov">        153 :     lambda -= f/df;</span>
<span class="lineNum">    1331 </span><span class="lineCov">        301 :     if(TMath::Abs(lambda0 - lambda) &lt; 1.e-8) break;</span>
<span class="lineNum">    1332 </span><span class="lineCov">          5 :   }</span>
<span class="lineNum">    1333 </span>            : 
<span class="lineNum">    1334 </span><span class="lineCov">        148 :   const Double_t lpi = 1./(1. + lambda);</span>
<span class="lineNum">    1335 </span><span class="lineCov">        148 :   const Double_t lmi = 1./(1. - lambda);</span>
<span class="lineNum">    1336 </span><span class="lineCov">        148 :   const Double_t lp2i = lpi*lpi;</span>
<span class="lineNum">    1337 </span><span class="lineCov">        148 :   const Double_t lm2i = lmi*lmi;</span>
<span class="lineNum">    1338 </span>            : 
<span class="lineNum">    1339 </span><span class="lineCov">        148 :   Double_t lambda2 = lambda*lambda;</span>
<span class="lineNum">    1340 </span>            : 
<span class="lineNum">    1341 </span><span class="lineCov">        148 :   Double_t dfl  = -4.*mass2 * lambda2*lambda + 2.*a*lambda + b;</span>
<span class="lineNum">    1342 </span><span class="lineCov">        148 :   Double_t dfx[7] = {0};//,0,0,0};</span>
<span class="lineNum">    1343 </span><span class="lineCov">        148 :   dfx[0] = -2.*(1. + lambda)*(1. + lambda)*mP[3];</span>
<span class="lineNum">    1344 </span><span class="lineCov">        148 :   dfx[1] = -2.*(1. + lambda)*(1. + lambda)*mP[4];</span>
<span class="lineNum">    1345 </span><span class="lineCov">        148 :   dfx[2] = -2.*(1. + lambda)*(1. + lambda)*mP[5];</span>
<span class="lineNum">    1346 </span><span class="lineCov">        148 :   dfx[3] = 2.*(1. - lambda)*(1. - lambda)*mP[6];</span>
<span class="lineNum">    1347 </span><span class="lineCov">        148 :   Double_t dlx[4] = {1,1,1,1};</span>
<span class="lineNum">    1348 </span><span class="lineCov">        148 :   if(TMath::Abs(dfl) &gt; 1.e-10 )</span>
<span class="lineNum">    1349 </span>            :   {
<span class="lineNum">    1350 </span><span class="lineCov">       1480 :     for(int i=0; i&lt;4; i++)</span>
<span class="lineNum">    1351 </span><span class="lineCov">        592 :       dlx[i] = -dfx[i] / dfl;</span>
<span class="lineNum">    1352 </span><span class="lineCov">        148 :   }</span>
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span><span class="lineCov">        148 :   Double_t dxx[4] = {mP[3]*lm2i, mP[4]*lm2i, mP[5]*lm2i, -mP[6]*lp2i};</span>
<span class="lineNum">    1355 </span>            : 
<span class="lineNum">    1356 </span><span class="lineCov">       2368 :   for(Int_t i=0; i&lt;7; i++)</span>
<span class="lineNum">    1357 </span><span class="lineCov">      16576 :     for(Int_t j=0; j&lt;7; j++)</span>
<span class="lineNum">    1358 </span><span class="lineCov">       7252 :       mJ[i][j]=0;</span>
<span class="lineNum">    1359 </span><span class="lineCov">        148 :   mJ[0][0] = 1.;</span>
<span class="lineNum">    1360 </span><span class="lineCov">        148 :   mJ[1][1] = 1.;</span>
<span class="lineNum">    1361 </span><span class="lineCov">        148 :   mJ[2][2] = 1.;</span>
<span class="lineNum">    1362 </span>            : 
<span class="lineNum">    1363 </span><span class="lineCov">       1480 :   for(Int_t i=3; i&lt;7; i++)</span>
<span class="lineNum">    1364 </span><span class="lineCov">       5920 :     for(Int_t j=3; j&lt;7; j++)</span>
<span class="lineNum">    1365 </span><span class="lineCov">       2368 :       mJ[i][j] = dlx[j-3]*dxx[i-3];</span>
<span class="lineNum">    1366 </span>            : 
<span class="lineNum">    1367 </span><span class="lineCov">       1184 :   for(Int_t i=3; i&lt;6; i++)</span>
<span class="lineNum">    1368 </span><span class="lineCov">        444 :     mJ[i][i] += lmi;</span>
<span class="lineNum">    1369 </span><span class="lineCov">        148 :   mJ[6][6] += lpi;</span>
<span class="lineNum">    1370 </span>            : 
<span class="lineNum">    1371 </span><span class="lineCov">        148 :   Double_t mCJ[7][7];</span>
<span class="lineNum">    1372 </span>            : 
<span class="lineNum">    1373 </span><span class="lineCov">       2368 :   for(Int_t i=0; i&lt;7; i++) {</span>
<span class="lineNum">    1374 </span><span class="lineCov">      16576 :     for(Int_t j=0; j&lt;7; j++) {</span>
<span class="lineNum">    1375 </span><span class="lineCov">       7252 :       mCJ[i][j] = 0;</span>
<span class="lineNum">    1376 </span><span class="lineCov">     116032 :       for(Int_t k=0; k&lt;7; k++) {</span>
<span class="lineNum">    1377 </span><span class="lineCov">      50764 :         mCJ[i][j] += mC[IJ(i,k)]*mJ[j][k];</span>
<span class="lineNum">    1378 </span>            :       }
<span class="lineNum">    1379 </span>            :     }
<span class="lineNum">    1380 </span>            :   }
<span class="lineNum">    1381 </span>            : 
<span class="lineNum">    1382 </span><span class="lineCov">       2368 :   for(Int_t i=0; i&lt;7; ++i){</span>
<span class="lineNum">    1383 </span><span class="lineCov">      10360 :     for(Int_t j=0; j&lt;=i; ++j){</span>
<span class="lineNum">    1384 </span><span class="lineCov">       4144 :       mC[IJ(i,j)]=0;</span>
<span class="lineNum">    1385 </span><span class="lineCov">      66304 :       for(Int_t l=0; l&lt;7; l++){</span>
<span class="lineNum">    1386 </span><span class="lineCov">      29008 :         mC[IJ(i,j)] += mJ[i][l]*mCJ[l][j];</span>
<span class="lineNum">    1387 </span>            :       }
<span class="lineNum">    1388 </span>            :     }
<span class="lineNum">    1389 </span>            :   }
<span class="lineNum">    1390 </span>            : 
<span class="lineNum">    1391 </span><span class="lineCov">        148 :   mP[3] *= lmi;</span>
<span class="lineNum">    1392 </span><span class="lineCov">        148 :   mP[4] *= lmi;</span>
<span class="lineNum">    1393 </span><span class="lineCov">        148 :   mP[5] *= lmi;</span>
<span class="lineNum">    1394 </span><span class="lineCov">        148 :   mP[6] *= lpi;</span>
<a name="1395"><span class="lineNum">    1395 </span><span class="lineCov">        148 : }</span></a>
<span class="lineNum">    1396 </span>            : 
<span class="lineNum">    1397 </span>            : void AliKFParticleBase::SetNonlinearMassConstraint( Double_t mass )
<span class="lineNum">    1398 </span>            : {
<span class="lineNum">    1399 </span>            :   //* Set nonlinear mass constraint (mass)
<span class="lineNum">    1400 </span>            : 
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :   Double_t mJ[7][7];</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :   SetMassConstraint( fP, fC, mJ, mass );</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :   fMassHypo = mass;</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :   SumDaughterMass = mass;</span>
<a name="1405"><span class="lineNum">    1405 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1406 </span>            : 
<span class="lineNum">    1407 </span>            : void AliKFParticleBase::SetMassConstraint( Double_t Mass, Double_t SigmaMass )
<span class="lineNum">    1408 </span>            : {  
<span class="lineNum">    1409 </span>            :   //* Set hard( SigmaMass=0 ) or soft (SigmaMass&gt;0) mass constraint 
<span class="lineNum">    1410 </span>            : 
<span class="lineNum">    1411 </span><span class="lineCov">         36 :   fMassHypo = Mass;</span>
<span class="lineNum">    1412 </span><span class="lineCov">         18 :   SumDaughterMass = Mass;</span>
<span class="lineNum">    1413 </span>            : 
<span class="lineNum">    1414 </span><span class="lineCov">         18 :   Double_t m2 = Mass*Mass;            // measurement, weighted by Mass </span>
<span class="lineNum">    1415 </span><span class="lineCov">         18 :   Double_t s2 = m2*SigmaMass*SigmaMass; // sigma^2</span>
<span class="lineNum">    1416 </span>            : 
<span class="lineNum">    1417 </span><span class="lineCov">         18 :   Double_t p2 = fP[3]*fP[3] + fP[4]*fP[4] + fP[5]*fP[5]; </span>
<span class="lineNum">    1418 </span><span class="lineCov">         18 :   Double_t e0 = TMath::Sqrt(m2+p2);</span>
<span class="lineNum">    1419 </span>            : 
<span class="lineNum">    1420 </span><span class="lineCov">         18 :   Double_t mH[8];</span>
<span class="lineNum">    1421 </span><span class="lineCov">         18 :   mH[0] = mH[1] = mH[2] = 0.;</span>
<span class="lineNum">    1422 </span><span class="lineCov">         18 :   mH[3] = -2*fP[3]; </span>
<span class="lineNum">    1423 </span><span class="lineCov">         18 :   mH[4] = -2*fP[4]; </span>
<span class="lineNum">    1424 </span><span class="lineCov">         18 :   mH[5] = -2*fP[5]; </span>
<span class="lineNum">    1425 </span><span class="lineCov">         18 :   mH[6] =  2*fP[6];//e0;</span>
<span class="lineNum">    1426 </span><span class="lineCov">         18 :   mH[7] = 0; </span>
<span class="lineNum">    1427 </span>            : 
<span class="lineNum">    1428 </span><span class="lineCov">         18 :   Double_t zeta = e0*e0 - e0*fP[6];</span>
<span class="lineNum">    1429 </span><span class="lineCov">         18 :   zeta = m2 - (fP[6]*fP[6]-p2);</span>
<span class="lineNum">    1430 </span>            :   
<span class="lineNum">    1431 </span><span class="lineCov">         18 :   Double_t mCHt[8], s2_est=0;</span>
<span class="lineNum">    1432 </span><span class="lineCov">        324 :   for( Int_t i=0; i&lt;8; ++i ){</span>
<span class="lineNum">    1433 </span><span class="lineCov">        144 :     mCHt[i] = 0.0;</span>
<span class="lineNum">    1434 </span><span class="lineCov">       2592 :     for (Int_t j=0;j&lt;8;++j) mCHt[i] += Cij(i,j)*mH[j];</span>
<span class="lineNum">    1435 </span><span class="lineCov">        144 :     s2_est += mH[i]*mCHt[i];</span>
<span class="lineNum">    1436 </span>            :   }
<span class="lineNum">    1437 </span>            :   
<span class="lineNum">    1438 </span><span class="lineCov">         18 :   if( s2_est&lt;1.e-20 ) return; // calculated mass error is already 0, </span>
<span class="lineNum">    1439 </span>            :                               // the particle can not be constrained on mass
<span class="lineNum">    1440 </span>            : 
<span class="lineNum">    1441 </span><span class="lineCov">         18 :   Double_t w2 = 1./( s2 + s2_est );</span>
<span class="lineNum">    1442 </span><span class="lineCov">         18 :   fChi2 += zeta*zeta*w2;</span>
<span class="lineNum">    1443 </span><span class="lineCov">         18 :   fNDF  += 1;</span>
<span class="lineNum">    1444 </span><span class="lineCov">        324 :   for( Int_t i=0, ii=0; i&lt;8; ++i ){</span>
<span class="lineNum">    1445 </span><span class="lineCov">        144 :     Double_t ki = mCHt[i]*w2;</span>
<span class="lineNum">    1446 </span><span class="lineCov">        144 :     fP[i]+= ki*zeta;</span>
<span class="lineNum">    1447 </span><span class="lineCov">       1584 :     for(Int_t j=0;j&lt;=i;++j) fC[ii++] -= ki*mCHt[j];    </span>
<span class="lineNum">    1448 </span>            :   }
<span class="lineNum">    1449 </span><span class="lineCov">         36 : }</span>
<a name="1450"><span class="lineNum">    1450 </span>            : </a>
<span class="lineNum">    1451 </span>            : 
<span class="lineNum">    1452 </span>            : void AliKFParticleBase::SetNoDecayLength()
<span class="lineNum">    1453 </span>            : {  
<span class="lineNum">    1454 </span>            :   //* Set no decay length for resonances
<span class="lineNum">    1455 </span>            : 
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :   TransportToDecayVertex();</span>
<span class="lineNum">    1457 </span>            : 
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :   Double_t h[8];</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :   h[0] = h[1] = h[2] = h[3] = h[4] = h[5] = h[6] = 0;</span>
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :   h[7] = 1; </span>
<span class="lineNum">    1461 </span>            : 
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :   Double_t zeta = 0 - fP[7];</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :   for(Int_t i=0;i&lt;8;++i) zeta -= h[i]*(fP[i]-fP[i]);</span>
<span class="lineNum">    1464 </span>            :   
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :   Double_t s = fC[35];   </span>
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 :   if( s&gt;1.e-20 ){</span>
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :     s = 1./s;</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :     fChi2 += zeta*zeta*s;</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :     fNDF  += 1;</span>
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :     for( Int_t i=0, ii=0; i&lt;7; ++i ){</span>
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :       Double_t ki = fC[28+i]*s;</span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :       fP[i]+= ki*zeta;</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :       for(Int_t j=0;j&lt;=i;++j) fC[ii++] -= ki*fC[28+j];    </span>
<span class="lineNum">    1474 </span>            :     }
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :   fP[7] = 0;</span>
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :   fC[28] = fC[29] = fC[30] = fC[31] = fC[32] = fC[33] = fC[34] = fC[35] = 0;</span>
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 : }</span>
<a name="1479"><span class="lineNum">    1479 </span>            : </a>
<span class="lineNum">    1480 </span>            : 
<span class="lineNum">    1481 </span>            : void AliKFParticleBase::Construct( const AliKFParticleBase* vDaughters[], Int_t NDaughters,
<span class="lineNum">    1482 </span>            :                                    const AliKFParticleBase *Parent,  Double_t Mass, Bool_t IsConstrained         )
<span class="lineNum">    1483 </span>            : { 
<span class="lineNum">    1484 </span>            :   //* Full reconstruction in one go
<span class="lineNum">    1485 </span>            : 
<span class="lineNum">    1486 </span>            :   Int_t maxIter = 1;
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :   bool wasLinearized = fIsLinearized;</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :   if( !fIsLinearized || IsConstrained ){</span>
<span class="lineNum">    1489 </span>            :     //fVtxGuess[0] = fVtxGuess[1] = fVtxGuess[2] = 0;  //!!!!
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :     fVtxGuess[0] = GetX();</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :     fVtxGuess[1] = GetY();</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :     fVtxGuess[2] = GetZ();</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :     fIsLinearized = 1;</span>
<span class="lineNum">    1494 </span>            :     maxIter = 3;
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1496 </span>            : 
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :   Double_t constraintC[6];</span>
<span class="lineNum">    1498 </span>            : 
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :   if( IsConstrained ){</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;6;++i) constraintC[i]=fC[i];</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;6;++i) constraintC[i]=0.;</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :     constraintC[0] = constraintC[2] = constraintC[5] = 100.;    </span>
<span class="lineNum">    1504 </span>            :   }
<span class="lineNum">    1505 </span>            : 
<span class="lineNum">    1506 </span>            : 
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :   for( Int_t iter=0; iter&lt;maxIter; iter++ ){</span>
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :     fAtProductionVertex = 0;</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :     fSFromDecay = 0;</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :     fP[0] = fVtxGuess[0];</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :     fP[1] = fVtxGuess[1];</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :     fP[2] = fVtxGuess[2];</span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :     fP[3] = 0;</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :     fP[4] = 0;</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :     fP[5] = 0;</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :     fP[6] = 0;</span>
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :     fP[7] = 0;</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :     SumDaughterMass = 0;</span>
<span class="lineNum">    1519 </span>            : 
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;6; ++i) fC[i]=constraintC[i];</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :     for(Int_t i=6;i&lt;36;++i) fC[i]=0.;</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :     fC[35] = 1.;</span>
<span class="lineNum">    1523 </span>            : 
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :     fNDF  = IsConstrained ?0 :-3;</span>
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :     fChi2 =  0.;</span>
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :     fQ = 0;</span>
<span class="lineNum">    1527 </span>            : 
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :     for( Int_t itr =0; itr&lt;NDaughters; itr++ ){</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :       AddDaughter( *vDaughters[itr] );    </span>
<span class="lineNum">    1530 </span>            :     }
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :     if( iter&lt;maxIter-1){</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :       for( Int_t i=0; i&lt;3; i++ ) fVtxGuess[i] = fP[i];  </span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1534 </span>            :   }
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :   fIsLinearized = wasLinearized;    </span>
<span class="lineNum">    1536 </span>            : 
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :   if( Mass&gt;=0 ) SetMassConstraint( Mass );</span>
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :   if( Parent ) SetProductionVertex( *Parent );</span>
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 : }</span>
<a name="1540"><span class="lineNum">    1540 </span>            : </a>
<span class="lineNum">    1541 </span>            : 
<span class="lineNum">    1542 </span>            : void AliKFParticleBase::Convert( bool ToProduction )
<span class="lineNum">    1543 </span>            : {
<span class="lineNum">    1544 </span>            :   //* Tricky function - convert the particle error along its trajectory to 
<span class="lineNum">    1545 </span>            :   //* the value which corresponds to its production/decay vertex
<span class="lineNum">    1546 </span>            :   //* It is done by combination of the error of decay length with the position errors
<span class="lineNum">    1547 </span>            : 
<span class="lineNum">    1548 </span><span class="lineCov">        148 :   Double_t fld[3]; </span>
<span class="lineNum">    1549 </span>            :   {
<span class="lineNum">    1550 </span><span class="lineCov">        148 :     GetFieldValue( fP, fld );</span>
<span class="lineNum">    1551 </span><span class="lineCov">        148 :     const Double_t kCLight =  fQ*0.000299792458;</span>
<span class="lineNum">    1552 </span><span class="lineCov">        148 :     fld[0]*=kCLight; fld[1]*=kCLight; fld[2]*=kCLight;</span>
<span class="lineNum">    1553 </span>            :   }
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span>            :   Double_t h[6];
<span class="lineNum">    1556 </span>            :   
<span class="lineNum">    1557 </span><span class="lineCov">        148 :   h[0] = fP[3];</span>
<span class="lineNum">    1558 </span><span class="lineCov">        148 :   h[1] = fP[4];</span>
<span class="lineNum">    1559 </span><span class="lineCov">        148 :   h[2] = fP[5];</span>
<span class="lineNum">    1560 </span><span class="lineCov">        222 :   if( ToProduction ){ h[0]=-h[0]; h[1]=-h[1]; h[2]=-h[2]; } </span>
<span class="lineNum">    1561 </span><span class="lineCov">        148 :   h[3] = h[1]*fld[2]-h[2]*fld[1];</span>
<span class="lineNum">    1562 </span><span class="lineCov">        148 :   h[4] = h[2]*fld[0]-h[0]*fld[2];</span>
<span class="lineNum">    1563 </span><span class="lineCov">        148 :   h[5] = h[0]*fld[1]-h[1]*fld[0];</span>
<span class="lineNum">    1564 </span>            :   
<span class="lineNum">    1565 </span>            :   Double_t c;
<span class="lineNum">    1566 </span>            : 
<span class="lineNum">    1567 </span><span class="lineCov">        148 :   c = fC[28]+h[0]*fC[35];</span>
<span class="lineNum">    1568 </span><span class="lineCov">        148 :   fC[ 0]+= h[0]*(c+fC[28]);</span>
<span class="lineNum">    1569 </span><span class="lineCov">        148 :   fC[28] = c;</span>
<span class="lineNum">    1570 </span>            : 
<span class="lineNum">    1571 </span><span class="lineCov">        148 :   fC[ 1]+= h[1]*fC[28] + h[0]*fC[29];</span>
<span class="lineNum">    1572 </span><span class="lineCov">        148 :   c = fC[29]+h[1]*fC[35];</span>
<span class="lineNum">    1573 </span><span class="lineCov">        148 :   fC[ 2]+= h[1]*(c+fC[29]);</span>
<span class="lineNum">    1574 </span><span class="lineCov">        148 :   fC[29] = c;</span>
<span class="lineNum">    1575 </span>            : 
<span class="lineNum">    1576 </span><span class="lineCov">        148 :   fC[ 3]+= h[2]*fC[28] + h[0]*fC[30];</span>
<span class="lineNum">    1577 </span><span class="lineCov">        148 :   fC[ 4]+= h[2]*fC[29] + h[1]*fC[30];</span>
<span class="lineNum">    1578 </span><span class="lineCov">        148 :   c = fC[30]+h[2]*fC[35];</span>
<span class="lineNum">    1579 </span><span class="lineCov">        148 :   fC[ 5]+= h[2]*(c+fC[30]);</span>
<span class="lineNum">    1580 </span><span class="lineCov">        148 :   fC[30] = c;</span>
<span class="lineNum">    1581 </span>            : 
<span class="lineNum">    1582 </span><span class="lineCov">        148 :   fC[ 6]+= h[3]*fC[28] + h[0]*fC[31];</span>
<span class="lineNum">    1583 </span><span class="lineCov">        148 :   fC[ 7]+= h[3]*fC[29] + h[1]*fC[31];</span>
<span class="lineNum">    1584 </span><span class="lineCov">        148 :   fC[ 8]+= h[3]*fC[30] + h[2]*fC[31];</span>
<span class="lineNum">    1585 </span><span class="lineCov">        148 :   c = fC[31]+h[3]*fC[35];</span>
<span class="lineNum">    1586 </span><span class="lineCov">        148 :   fC[ 9]+= h[3]*(c+fC[31]);</span>
<span class="lineNum">    1587 </span><span class="lineCov">        148 :   fC[31] = c;</span>
<span class="lineNum">    1588 </span>            :   
<span class="lineNum">    1589 </span><span class="lineCov">        148 :   fC[10]+= h[4]*fC[28] + h[0]*fC[32];</span>
<span class="lineNum">    1590 </span><span class="lineCov">        148 :   fC[11]+= h[4]*fC[29] + h[1]*fC[32];</span>
<span class="lineNum">    1591 </span><span class="lineCov">        148 :   fC[12]+= h[4]*fC[30] + h[2]*fC[32];</span>
<span class="lineNum">    1592 </span><span class="lineCov">        148 :   fC[13]+= h[4]*fC[31] + h[3]*fC[32];</span>
<span class="lineNum">    1593 </span><span class="lineCov">        148 :   c = fC[32]+h[4]*fC[35];</span>
<span class="lineNum">    1594 </span><span class="lineCov">        148 :   fC[14]+= h[4]*(c+fC[32]);</span>
<span class="lineNum">    1595 </span><span class="lineCov">        148 :   fC[32] = c;</span>
<span class="lineNum">    1596 </span>            :   
<span class="lineNum">    1597 </span><span class="lineCov">        148 :   fC[15]+= h[5]*fC[28] + h[0]*fC[33];</span>
<span class="lineNum">    1598 </span><span class="lineCov">        148 :   fC[16]+= h[5]*fC[29] + h[1]*fC[33];</span>
<span class="lineNum">    1599 </span><span class="lineCov">        148 :   fC[17]+= h[5]*fC[30] + h[2]*fC[33];</span>
<span class="lineNum">    1600 </span><span class="lineCov">        148 :   fC[18]+= h[5]*fC[31] + h[3]*fC[33];</span>
<span class="lineNum">    1601 </span><span class="lineCov">        148 :   fC[19]+= h[5]*fC[32] + h[4]*fC[33];</span>
<span class="lineNum">    1602 </span><span class="lineCov">        148 :   c = fC[33]+h[5]*fC[35];</span>
<span class="lineNum">    1603 </span><span class="lineCov">        148 :   fC[20]+= h[5]*(c+fC[33]);</span>
<span class="lineNum">    1604 </span><span class="lineCov">        148 :   fC[33] = c;</span>
<span class="lineNum">    1605 </span>            : 
<span class="lineNum">    1606 </span><span class="lineCov">        148 :   fC[21]+= h[0]*fC[34];</span>
<span class="lineNum">    1607 </span><span class="lineCov">        148 :   fC[22]+= h[1]*fC[34];</span>
<span class="lineNum">    1608 </span><span class="lineCov">        148 :   fC[23]+= h[2]*fC[34];</span>
<span class="lineNum">    1609 </span><span class="lineCov">        148 :   fC[24]+= h[3]*fC[34];</span>
<span class="lineNum">    1610 </span><span class="lineCov">        148 :   fC[25]+= h[4]*fC[34];</span>
<span class="lineNum">    1611 </span><span class="lineCov">        148 :   fC[26]+= h[5]*fC[34];</span>
<span class="lineNum">    1612 </span><span class="lineCov">        148 : }</span>
<a name="1613"><span class="lineNum">    1613 </span>            : </a>
<span class="lineNum">    1614 </span>            : 
<span class="lineNum">    1615 </span>            : void AliKFParticleBase::TransportToDecayVertex()
<span class="lineNum">    1616 </span>            : {
<span class="lineNum">    1617 </span>            :   //* Transport the particle to its decay vertex 
<span class="lineNum">    1618 </span>            : 
<span class="lineNum">    1619 </span><span class="lineCov">        148 :   if( fSFromDecay != 0 ) TransportToDS( -fSFromDecay );</span>
<span class="lineNum">    1620 </span><span class="lineCov">         74 :   if( fAtProductionVertex ) Convert(0);</span>
<span class="lineNum">    1621 </span><span class="lineCov">         74 :   fAtProductionVertex = 0;</span>
<a name="1622"><span class="lineNum">    1622 </span><span class="lineCov">         74 : }</span></a>
<span class="lineNum">    1623 </span>            : 
<span class="lineNum">    1624 </span>            : void AliKFParticleBase::TransportToProductionVertex()
<span class="lineNum">    1625 </span>            : {
<span class="lineNum">    1626 </span>            :   //* Transport the particle to its production vertex 
<span class="lineNum">    1627 </span>            :   
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :   if( fSFromDecay != -fP[7] ) TransportToDS( -fSFromDecay-fP[7] );</span>
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :   if( !fAtProductionVertex ) Convert( 1 );</span>
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :   fAtProductionVertex = 1;</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 : }</span>
<a name="1632"><span class="lineNum">    1632 </span>            : </a>
<span class="lineNum">    1633 </span>            : 
<span class="lineNum">    1634 </span>            : void AliKFParticleBase::TransportToDS( Double_t dS )
<span class="lineNum">    1635 </span>            : { 
<span class="lineNum">    1636 </span>            :   //* Transport the particle on dS parameter (SignedPath/Momentum) 
<span class="lineNum">    1637 </span>            :  
<span class="lineNum">    1638 </span><span class="lineCov">        444 :   Transport( dS, fP, fC );</span>
<span class="lineNum">    1639 </span><span class="lineCov">        222 :   fSFromDecay+= dS;</span>
<span class="lineNum">    1640 </span><span class="lineCov">        222 : }</span>
<a name="1641"><span class="lineNum">    1641 </span>            : </a>
<span class="lineNum">    1642 </span>            : 
<span class="lineNum">    1643 </span>            : Double_t AliKFParticleBase::GetDStoPointLine( const Double_t xyz[] ) const 
<span class="lineNum">    1644 </span>            : {
<span class="lineNum">    1645 </span>            :   //* Get dS to a certain space point without field
<span class="lineNum">    1646 </span>            : 
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :   Double_t p2 = fP[3]*fP[3] + fP[4]*fP[4] + fP[5]*fP[5];  </span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :   if( p2&lt;1.e-4 ) p2 = 1;</span>
<span class="lineNum">    1649 </span><span class="lineNoCov">          0 :   return ( fP[3]*(xyz[0]-fP[0]) + fP[4]*(xyz[1]-fP[1]) + fP[5]*(xyz[2]-fP[2]) )/p2;</span>
<span class="lineNum">    1650 </span>            : }
<a name="1651"><span class="lineNum">    1651 </span>            : </a>
<span class="lineNum">    1652 </span>            : 
<span class="lineNum">    1653 </span>            : Double_t AliKFParticleBase::GetDStoPointBz( Double_t B, const Double_t xyz[] ) 
<span class="lineNum">    1654 </span>            :   const
<span class="lineNum">    1655 </span>            : { 
<span class="lineNum">    1656 </span>            :   
<span class="lineNum">    1657 </span>            :   //* Get dS to a certain space point for Bz field
<span class="lineNum">    1658 </span>            :   const Double_t kCLight = 0.000299792458;
<span class="lineNum">    1659 </span><span class="lineCov">       1036 :   Double_t bq = B*fQ*kCLight;</span>
<span class="lineNum">    1660 </span><span class="lineCov">        518 :   Double_t pt2 = fP[3]*fP[3] + fP[4]*fP[4];</span>
<span class="lineNum">    1661 </span><span class="lineCov">        518 :   if( pt2&lt;1.e-4 ) return 0;</span>
<span class="lineNum">    1662 </span><span class="lineCov">        518 :   Double_t dx = xyz[0] - fP[0];</span>
<span class="lineNum">    1663 </span><span class="lineCov">        518 :   Double_t dy = xyz[1] - fP[1]; </span>
<span class="lineNum">    1664 </span><span class="lineCov">        518 :   Double_t a = dx*fP[3]+dy*fP[4];</span>
<span class="lineNum">    1665 </span>            :   Double_t dS;
<span class="lineNum">    1666 </span>            : 
<span class="lineNum">    1667 </span><span class="lineCov">        564 :   if( TMath::Abs(bq)&lt;1.e-8 ) dS = a/pt2;  </span>
<span class="lineNum">    1668 </span><span class="lineCov">        472 :   else dS =  TMath::ATan2( bq*a, pt2 + bq*(dy*fP[3] -dx*fP[4]) )/bq;</span>
<span class="lineNum">    1669 </span>            : 
<span class="lineNum">    1670 </span>            :   if(0){
<span class="lineNum">    1671 </span>            : 
<span class="lineNum">    1672 </span>            :     Double_t px = fP[3];
<span class="lineNum">    1673 </span>            :     Double_t py = fP[4];
<span class="lineNum">    1674 </span>            :     Double_t pz = fP[5];
<span class="lineNum">    1675 </span>            :     Double_t ss[2], g[2][5];
<span class="lineNum">    1676 </span>            :   
<span class="lineNum">    1677 </span>            :     ss[0] = dS;
<span class="lineNum">    1678 </span>            :     ss[1] = -dS;
<span class="lineNum">    1679 </span>            :     for( Int_t i=0; i&lt;2; i++){
<span class="lineNum">    1680 </span>            :       Double_t bs = bq*ss[i];
<span class="lineNum">    1681 </span>            :       Double_t c = TMath::Cos(bs), s = TMath::Sin(bs);
<span class="lineNum">    1682 </span>            :       Double_t cB,sB;
<span class="lineNum">    1683 </span>            :       if( TMath::Abs(bq)&gt;1.e-8){
<span class="lineNum">    1684 </span>            :         cB= (1-c)/bq;     
<span class="lineNum">    1685 </span>            :         sB= s/bq;  
<span class="lineNum">    1686 </span>            :       }else{
<span class="lineNum">    1687 </span>            :         const Double_t kOvSqr6 = 1./TMath::Sqrt(6.);
<span class="lineNum">    1688 </span>            :         sB = (1.-bs*kOvSqr6)*(1.+bs*kOvSqr6)*ss[i];
<span class="lineNum">    1689 </span>            :         cB = .5*sB*bs;
<span class="lineNum">    1690 </span>            :       }
<span class="lineNum">    1691 </span>            :       g[i][0] = fP[0] + sB*px + cB*py;
<span class="lineNum">    1692 </span>            :       g[i][1] = fP[1] - cB*px + sB*py;
<span class="lineNum">    1693 </span>            :       g[i][2] = fP[2] + ss[i]*pz;
<span class="lineNum">    1694 </span>            :       g[i][3] =       + c*px + s*py;
<span class="lineNum">    1695 </span>            :       g[i][4] =       - s*px + c*py;      
<span class="lineNum">    1696 </span>            :     }
<span class="lineNum">    1697 </span>            : 
<span class="lineNum">    1698 </span>            :     Int_t i=0;
<span class="lineNum">    1699 </span>            :   
<span class="lineNum">    1700 </span>            :     Double_t dMin = 1.e10;
<span class="lineNum">    1701 </span>            :     for( Int_t j=0; j&lt;2; j++){
<span class="lineNum">    1702 </span>            :       Double_t xx = g[j][0]-xyz[0];
<span class="lineNum">    1703 </span>            :       Double_t yy = g[j][1]-xyz[1];
<span class="lineNum">    1704 </span>            :       Double_t zz = g[j][2]-xyz[2];
<span class="lineNum">    1705 </span>            :       Double_t d = xx*xx + yy*yy + zz*zz;
<span class="lineNum">    1706 </span>            :       if( d&lt;dMin ){
<span class="lineNum">    1707 </span>            :         dMin = d;
<span class="lineNum">    1708 </span>            :         i = j;
<span class="lineNum">    1709 </span>            :       }
<span class="lineNum">    1710 </span>            :     }
<span class="lineNum">    1711 </span>            : 
<span class="lineNum">    1712 </span>            :     dS = ss[i];
<span class="lineNum">    1713 </span>            : 
<span class="lineNum">    1714 </span>            :     Double_t x= g[i][0], y= g[i][1], z= g[i][2], ppx= g[i][3], ppy= g[i][4];      
<span class="lineNum">    1715 </span>            :     Double_t ddx = x-xyz[0];
<span class="lineNum">    1716 </span>            :     Double_t ddy = y-xyz[1];
<span class="lineNum">    1717 </span>            :     Double_t ddz = z-xyz[2];
<span class="lineNum">    1718 </span>            :     Double_t c = ddx*ppx  + ddy*ppy  + ddz*pz ;
<span class="lineNum">    1719 </span>            :     Double_t pp2 = ppx*ppx + ppy*ppy + pz*pz;    
<span class="lineNum">    1720 </span>            :     if( TMath::Abs(pp2)&gt;1.e-8 ){
<span class="lineNum">    1721 </span>            :       dS+=c/pp2;
<span class="lineNum">    1722 </span>            :     }
<span class="lineNum">    1723 </span>            :   }
<span class="lineNum">    1724 </span>            :   return dS;
<span class="lineNum">    1725 </span><span class="lineCov">        518 : }</span>
<a name="1726"><span class="lineNum">    1726 </span>            : </a>
<span class="lineNum">    1727 </span>            : 
<span class="lineNum">    1728 </span>            : void AliKFParticleBase::GetDStoParticleBz( Double_t B, const AliKFParticleBase &amp;p, 
<span class="lineNum">    1729 </span>            :                                            Double_t &amp;DS, Double_t &amp;DS1 ) 
<span class="lineNum">    1730 </span>            :   const
<span class="lineNum">    1731 </span>            : { 
<span class="lineNum">    1732 </span>            :   //* Get dS to another particle for Bz field
<span class="lineNum">    1733 </span><span class="lineCov">        148 :   Double_t px = fP[3];</span>
<span class="lineNum">    1734 </span><span class="lineCov">         74 :   Double_t py = fP[4];</span>
<span class="lineNum">    1735 </span><span class="lineCov">         74 :   Double_t pz = fP[5];</span>
<span class="lineNum">    1736 </span>            : 
<span class="lineNum">    1737 </span><span class="lineCov">         74 :   Double_t px1 = p.fP[3];</span>
<span class="lineNum">    1738 </span><span class="lineCov">         74 :   Double_t py1 = p.fP[4];</span>
<span class="lineNum">    1739 </span><span class="lineCov">         74 :   Double_t pz1 = p.fP[5];</span>
<span class="lineNum">    1740 </span>            : 
<span class="lineNum">    1741 </span>            :   const Double_t kCLight = 0.000299792458;
<span class="lineNum">    1742 </span>            : 
<span class="lineNum">    1743 </span><span class="lineCov">         74 :   Double_t bq = B*fQ*kCLight;</span>
<span class="lineNum">    1744 </span><span class="lineCov">         74 :   Double_t bq1 = B*p.fQ*kCLight;</span>
<span class="lineNum">    1745 </span>            :   Double_t s=0, ds=0, s1=0, ds1=0;
<span class="lineNum">    1746 </span>            :   
<span class="lineNum">    1747 </span><span class="lineCov">         74 :   if( TMath::Abs(bq)&gt;1.e-8 || TMath::Abs(bq1)&gt;1.e-8 ){</span>
<span class="lineNum">    1748 </span>            : 
<span class="lineNum">    1749 </span><span class="lineCov">         74 :     Double_t dx = (p.fP[0] - fP[0]);</span>
<span class="lineNum">    1750 </span><span class="lineCov">         74 :     Double_t dy = (p.fP[1] - fP[1]);</span>
<span class="lineNum">    1751 </span><span class="lineCov">         74 :     Double_t d2 = (dx*dx+dy*dy);</span>
<span class="lineNum">    1752 </span>            :     
<span class="lineNum">    1753 </span><span class="lineCov">         74 :     Double_t p2  = (px *px  + py *py); </span>
<span class="lineNum">    1754 </span><span class="lineCov">         74 :     Double_t p21 = (px1*px1 + py1*py1);</span>
<span class="lineNum">    1755 </span>            : 
<span class="lineNum">    1756 </span><span class="lineCov">        148 :     if( TMath::Abs(p2) &lt; 1.e-8 || TMath::Abs(p21) &lt; 1.e-8 )</span>
<span class="lineNum">    1757 </span>            :     {
<span class="lineNum">    1758 </span><span class="lineNoCov">          0 :       DS=0.;</span>
<span class="lineNum">    1759 </span><span class="lineNoCov">          0 :       DS1=0.;</span>
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    1761 </span>            :     }
<span class="lineNum">    1762 </span>            : 
<span class="lineNum">    1763 </span><span class="lineCov">         74 :     Double_t a = (px*py1 - py*px1);</span>
<span class="lineNum">    1764 </span><span class="lineCov">         74 :     Double_t b = (px*px1 + py*py1);</span>
<span class="lineNum">    1765 </span>            :     
<span class="lineNum">    1766 </span><span class="lineCov">         74 :     Double_t ldx = bq*bq1*dx - bq1*py + bq*py1 ;</span>
<span class="lineNum">    1767 </span><span class="lineCov">         74 :     Double_t ldy = bq*bq1*dy + bq1*px - bq*px1 ;</span>
<span class="lineNum">    1768 </span><span class="lineCov">         74 :     Double_t l2 = ldx*ldx + ldy*ldy;</span>
<span class="lineNum">    1769 </span>            :     
<span class="lineNum">    1770 </span><span class="lineCov">         74 :     Double_t cS = bq1*p2 + bq*bq1*(dy* px - dx* py) -  bq*b;</span>
<span class="lineNum">    1771 </span><span class="lineCov">         74 :     Double_t cS1= bq*p21 - bq*bq1*(dy*px1 - dx*py1) - bq1*b;</span>
<span class="lineNum">    1772 </span>            : 
<span class="lineNum">    1773 </span><span class="lineCov">         74 :     Double_t ca  = bq*bq*bq1*d2  +2*( cS + bq*bq*(py1*dx-px1*dy)) ;</span>
<span class="lineNum">    1774 </span><span class="lineCov">         74 :     Double_t ca1 = bq*bq1*bq1*d2 +2*( cS1 - bq1*bq1*(py*dx-px*dy)) ;  </span>
<span class="lineNum">    1775 </span>            :   
<span class="lineNum">    1776 </span><span class="lineCov">         74 :     Double_t sa = 4*l2*p2 - ca*ca;</span>
<span class="lineNum">    1777 </span><span class="lineCov">         74 :     Double_t sa1 = 4*l2*p21 - ca1*ca1;</span>
<span class="lineNum">    1778 </span>            : 
<span class="lineNum">    1779 </span><span class="lineCov">         82 :     if(sa&lt;0) sa=0;</span>
<span class="lineNum">    1780 </span><span class="lineCov">         82 :     if(sa1&lt;0)sa1=0;</span>
<span class="lineNum">    1781 </span>            : 
<span class="lineNum">    1782 </span><span class="lineCov">         74 :     if( TMath::Abs(bq)&gt;1.e-8){</span>
<span class="lineNum">    1783 </span><span class="lineCov">         74 :       s  = TMath::ATan2(   bq*( bq1*(dx*px +dy*py) + a ) , cS )/bq;</span>
<span class="lineNum">    1784 </span><span class="lineCov">         74 :       ds = TMath::ATan2(TMath::Sqrt(sa),ca)/bq;</span>
<span class="lineNum">    1785 </span><span class="lineCov">         74 :     } else {</span>
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :       s = ( (dx*px + dy*py) + (py*px1-px*py1)/bq1)/p2;</span>
<span class="lineNum">    1787 </span><span class="lineNoCov">          0 :       ds = s*s - (d2-2*(px1*dy-py1*dx)/bq1)/p2; </span>
<span class="lineNum">    1788 </span><span class="lineNoCov">          0 :       if( ds&lt;0 ) ds = 0;</span>
<span class="lineNum">    1789 </span><span class="lineNoCov">          0 :       ds = TMath::Sqrt(ds);   </span>
<span class="lineNum">    1790 </span>            :     }
<span class="lineNum">    1791 </span>            :     
<span class="lineNum">    1792 </span><span class="lineCov">         74 :     if( TMath::Abs(bq1)&gt;1.e-8){</span>
<span class="lineNum">    1793 </span><span class="lineCov">         74 :       s1 = TMath::ATan2( -bq1*( bq*(dx*px1+dy*py1) + a), cS1 )/bq1;</span>
<span class="lineNum">    1794 </span><span class="lineCov">         74 :       ds1 = TMath::ATan2(TMath::Sqrt(sa1),ca1)/bq1;  </span>
<span class="lineNum">    1795 </span><span class="lineCov">         74 :     } else {</span>
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :       s1 = (-(dx*px1 + dy*py1) + (py*px1-px*py1)/bq)/p21;</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :       ds1 = s1*s1 - (d2+2*(px*dy-py*dx)/bq)/p21; </span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :       if( ds1&lt;0 ) ds1 = 0;</span>
<span class="lineNum">    1799 </span><span class="lineNoCov">          0 :       ds1 = TMath::Sqrt(ds1);</span>
<span class="lineNum">    1800 </span>            :     }
<span class="lineNum">    1801 </span><span class="lineCov">         74 :   }</span>
<span class="lineNum">    1802 </span>            : 
<span class="lineNum">    1803 </span><span class="lineCov">         74 :   Double_t ss[2], ss1[2], g[2][5],g1[2][5];</span>
<span class="lineNum">    1804 </span>            :   
<span class="lineNum">    1805 </span><span class="lineCov">         74 :   ss[0] = s + ds;</span>
<span class="lineNum">    1806 </span><span class="lineCov">         74 :   ss[1] = s - ds;</span>
<span class="lineNum">    1807 </span><span class="lineCov">         74 :   ss1[0] = s1 + ds1;</span>
<span class="lineNum">    1808 </span><span class="lineCov">         74 :   ss1[1] = s1 - ds1;</span>
<span class="lineNum">    1809 </span><span class="lineCov">        444 :   for( Int_t i=0; i&lt;2; i++){</span>
<span class="lineNum">    1810 </span><span class="lineCov">        148 :     Double_t bs = bq*ss[i];</span>
<span class="lineNum">    1811 </span><span class="lineCov">        148 :     Double_t c = TMath::Cos(bs), sss = TMath::Sin(bs);</span>
<span class="lineNum">    1812 </span>            :     Double_t cB,sB;
<span class="lineNum">    1813 </span><span class="lineCov">        148 :     if( TMath::Abs(bq)&gt;1.e-8){</span>
<span class="lineNum">    1814 </span><span class="lineCov">        148 :       cB= (1-c)/bq;     </span>
<span class="lineNum">    1815 </span><span class="lineCov">        148 :       sB= sss/bq;  </span>
<span class="lineNum">    1816 </span><span class="lineCov">        148 :     }else{</span>
<span class="lineNum">    1817 </span><span class="lineNoCov">          0 :       const Double_t kOvSqr6 = 1./TMath::Sqrt(6.);</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :       sB = (1.-bs*kOvSqr6)*(1.+bs*kOvSqr6)*ss[i];</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :       cB = .5*sB*bs;</span>
<span class="lineNum">    1820 </span>            :     }
<span class="lineNum">    1821 </span><span class="lineCov">        148 :     g[i][0] = fP[0] + sB*px + cB*py;</span>
<span class="lineNum">    1822 </span><span class="lineCov">        148 :     g[i][1] = fP[1] - cB*px + sB*py;</span>
<span class="lineNum">    1823 </span><span class="lineCov">        148 :     g[i][2] = fP[2] + ss[i]*pz;</span>
<span class="lineNum">    1824 </span><span class="lineCov">        148 :     g[i][3] =       + c*px + sss*py;</span>
<span class="lineNum">    1825 </span><span class="lineCov">        148 :     g[i][4] =       - sss*px + c*py;</span>
<span class="lineNum">    1826 </span>            : 
<span class="lineNum">    1827 </span><span class="lineCov">        148 :     bs = bq1*ss1[i];  </span>
<span class="lineNum">    1828 </span><span class="lineCov">        148 :     c =  TMath::Cos(bs); sss = TMath::Sin(bs);</span>
<span class="lineNum">    1829 </span><span class="lineCov">        148 :     if( TMath::Abs(bq1)&gt;1.e-8){</span>
<span class="lineNum">    1830 </span><span class="lineCov">        148 :       cB= (1-c)/bq1;   </span>
<span class="lineNum">    1831 </span><span class="lineCov">        148 :       sB= sss/bq1;  </span>
<span class="lineNum">    1832 </span><span class="lineCov">        148 :     }else{</span>
<span class="lineNum">    1833 </span><span class="lineNoCov">          0 :       const Double_t kOvSqr6 = 1./TMath::Sqrt(6.);</span>
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :       sB = (1.-bs*kOvSqr6)*(1.+bs*kOvSqr6)*ss1[i];</span>
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :       cB = .5*sB*bs;</span>
<span class="lineNum">    1836 </span>            :     }
<span class="lineNum">    1837 </span>            :       
<span class="lineNum">    1838 </span><span class="lineCov">        148 :     g1[i][0] = p.fP[0] + sB*px1 + cB*py1;</span>
<span class="lineNum">    1839 </span><span class="lineCov">        148 :     g1[i][1] = p.fP[1] - cB*px1 + sB*py1;</span>
<span class="lineNum">    1840 </span><span class="lineCov">        148 :     g1[i][2] = p.fP[2] + ss[i]*pz1;</span>
<span class="lineNum">    1841 </span><span class="lineCov">        148 :     g1[i][3] =         + c*px1 + sss*py1;</span>
<span class="lineNum">    1842 </span><span class="lineCov">        148 :     g1[i][4] =         - sss*px1 + c*py1;</span>
<span class="lineNum">    1843 </span>            :   }
<span class="lineNum">    1844 </span>            : 
<span class="lineNum">    1845 </span>            :   Int_t i=0, i1=0;
<span class="lineNum">    1846 </span>            :   
<span class="lineNum">    1847 </span>            :   Double_t dMin = 1.e10;
<span class="lineNum">    1848 </span><span class="lineCov">        444 :   for( Int_t j=0; j&lt;2; j++){</span>
<span class="lineNum">    1849 </span><span class="lineCov">        888 :     for( Int_t j1=0; j1&lt;2; j1++){</span>
<span class="lineNum">    1850 </span><span class="lineCov">        296 :       Double_t xx = g[j][0]-g1[j1][0];</span>
<span class="lineNum">    1851 </span><span class="lineCov">        296 :       Double_t yy = g[j][1]-g1[j1][1];</span>
<span class="lineNum">    1852 </span><span class="lineCov">        296 :       Double_t zz = g[j][2]-g1[j1][2];</span>
<span class="lineNum">    1853 </span><span class="lineCov">        296 :       Double_t d = xx*xx + yy*yy + zz*zz;</span>
<span class="lineNum">    1854 </span><span class="lineCov">        296 :       if( d&lt;dMin ){</span>
<span class="lineNum">    1855 </span>            :         dMin = d;
<span class="lineNum">    1856 </span>            :         i = j;
<span class="lineNum">    1857 </span>            :         i1 = j1;
<span class="lineNum">    1858 </span><span class="lineCov">         90 :       }</span>
<span class="lineNum">    1859 </span>            :     }
<span class="lineNum">    1860 </span>            :   }  
<span class="lineNum">    1861 </span>            : 
<span class="lineNum">    1862 </span><span class="lineCov">         74 :   DS = ss[i];</span>
<span class="lineNum">    1863 </span><span class="lineCov">         74 :   DS1 = ss1[i1];</span>
<span class="lineNum">    1864 </span>            :   if(0){
<span class="lineNum">    1865 </span>            :     Double_t x= g[i][0], y= g[i][1], z= g[i][2], ppx= g[i][3], ppy= g[i][4];  
<span class="lineNum">    1866 </span>            :     Double_t x1=g1[i1][0], y1= g1[i1][1], z1= g1[i1][2], ppx1= g1[i1][3], ppy1= g1[i1][4];  
<span class="lineNum">    1867 </span>            :     Double_t dx = x1-x;
<span class="lineNum">    1868 </span>            :     Double_t dy = y1-y;
<span class="lineNum">    1869 </span>            :     Double_t dz = z1-z;
<span class="lineNum">    1870 </span>            :     Double_t a = ppx*ppx1 + ppy*ppy1 + pz*pz1;
<span class="lineNum">    1871 </span>            :     Double_t b = dx*ppx1 + dy*ppy1 + dz*pz1;
<span class="lineNum">    1872 </span>            :     Double_t c = dx*ppx  + dy*ppy  + dz*pz ;
<span class="lineNum">    1873 </span>            :     Double_t pp2 = ppx*ppx + ppy*ppy + pz*pz;
<span class="lineNum">    1874 </span>            :     Double_t pp21= ppx1*ppx1 + ppy1*ppy1 + pz1*pz1;
<span class="lineNum">    1875 </span>            :     Double_t det = pp2*pp21 - a*a;    
<span class="lineNum">    1876 </span>            :     if( TMath::Abs(det)&gt;1.e-8 ){
<span class="lineNum">    1877 </span>            :       DS+=(a*b-pp21*c)/det;
<span class="lineNum">    1878 </span>            :       DS1+=(a*c-pp2*b)/det;
<span class="lineNum">    1879 </span>            :     }
<span class="lineNum">    1880 </span>            :   }
<span class="lineNum">    1881 </span><span class="lineCov">        148 : }</span>
<span class="lineNum">    1882 </span>            : 
<a name="1883"><span class="lineNum">    1883 </span>            : </a>
<span class="lineNum">    1884 </span>            : 
<span class="lineNum">    1885 </span>            : void AliKFParticleBase::TransportCBM( Double_t dS, 
<span class="lineNum">    1886 </span>            :                                  Double_t P[], Double_t C[] ) const
<span class="lineNum">    1887 </span>            : {  
<span class="lineNum">    1888 </span>            :   //* Transport the particle on dS, output to P[],C[], for CBM field
<span class="lineNum">    1889 </span>            :  
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :   if( fQ==0 ){</span>
<span class="lineNum">    1891 </span><span class="lineNoCov">          0 :     TransportLine( dS, P, C );</span>
<span class="lineNum">    1892 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1893 </span>            :   }
<span class="lineNum">    1894 </span>            : 
<span class="lineNum">    1895 </span>            :   const Double_t kCLight = 0.000299792458;
<span class="lineNum">    1896 </span>            : 
<span class="lineNum">    1897 </span><span class="lineNoCov">          0 :   Double_t c = fQ*kCLight;</span>
<span class="lineNum">    1898 </span>            : 
<span class="lineNum">    1899 </span>            :   // construct coefficients 
<span class="lineNum">    1900 </span>            : 
<span class="lineNum">    1901 </span>            :   Double_t 
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :     px   = fP[3],</span>
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :     py   = fP[4],</span>
<span class="lineNum">    1904 </span><span class="lineNoCov">          0 :     pz   = fP[5];</span>
<span class="lineNum">    1905 </span>            :       
<span class="lineNum">    1906 </span>            :   Double_t sx=0, sy=0, sz=0, syy=0, syz=0, syyy=0, ssx=0, ssy=0, ssz=0, ssyy=0, ssyz=0, ssyyy=0;
<span class="lineNum">    1907 </span>            : 
<span class="lineNum">    1908 </span>            :   { // get field integrals
<span class="lineNum">    1909 </span>            : 
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :     Double_t fld[3][3];   </span>
<span class="lineNum">    1911 </span><span class="lineNoCov">          0 :     Double_t p0[3], p1[3], p2[3];</span>
<span class="lineNum">    1912 </span>            : 
<span class="lineNum">    1913 </span>            :     // line track approximation
<span class="lineNum">    1914 </span>            : 
<span class="lineNum">    1915 </span><span class="lineNoCov">          0 :     p0[0] = fP[0];</span>
<span class="lineNum">    1916 </span><span class="lineNoCov">          0 :     p0[1] = fP[1];</span>
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :     p0[2] = fP[2];</span>
<span class="lineNum">    1918 </span>            :   
<span class="lineNum">    1919 </span><span class="lineNoCov">          0 :     p2[0] = fP[0] + px*dS;</span>
<span class="lineNum">    1920 </span><span class="lineNoCov">          0 :     p2[1] = fP[1] + py*dS;</span>
<span class="lineNum">    1921 </span><span class="lineNoCov">          0 :     p2[2] = fP[2] + pz*dS;</span>
<span class="lineNum">    1922 </span>            :   
<span class="lineNum">    1923 </span><span class="lineNoCov">          0 :     p1[0] = 0.5*(p0[0]+p2[0]);</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :     p1[1] = 0.5*(p0[1]+p2[1]);</span>
<span class="lineNum">    1925 </span><span class="lineNoCov">          0 :     p1[2] = 0.5*(p0[2]+p2[2]);</span>
<span class="lineNum">    1926 </span>            : 
<span class="lineNum">    1927 </span>            :     // first order track approximation
<span class="lineNum">    1928 </span>            :     {
<span class="lineNum">    1929 </span><span class="lineNoCov">          0 :       GetFieldValue( p0, fld[0] );</span>
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :       GetFieldValue( p1, fld[1] );</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :       GetFieldValue( p2, fld[2] );</span>
<span class="lineNum">    1932 </span>            : 
<span class="lineNum">    1933 </span><span class="lineNoCov">          0 :       Double_t ssy1 = ( 7*fld[0][1] + 6*fld[1][1]-fld[2][1] )*c*dS*dS/96.;</span>
<span class="lineNum">    1934 </span><span class="lineNoCov">          0 :       Double_t ssy2 = (   fld[0][1] + 2*fld[1][1]         )*c*dS*dS/6.;</span>
<span class="lineNum">    1935 </span>            : 
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 :       p1[0] -= ssy1*pz;</span>
<span class="lineNum">    1937 </span><span class="lineNoCov">          0 :       p1[2] += ssy1*px;</span>
<span class="lineNum">    1938 </span><span class="lineNoCov">          0 :       p2[0] -= ssy2*pz;</span>
<span class="lineNum">    1939 </span><span class="lineNoCov">          0 :       p2[2] += ssy2*px;   </span>
<span class="lineNum">    1940 </span>            :     }
<span class="lineNum">    1941 </span>            : 
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :     GetFieldValue( p0, fld[0] );</span>
<span class="lineNum">    1943 </span><span class="lineNoCov">          0 :     GetFieldValue( p1, fld[1] );</span>
<span class="lineNum">    1944 </span><span class="lineNoCov">          0 :     GetFieldValue( p2, fld[2] );</span>
<span class="lineNum">    1945 </span>            :     
<span class="lineNum">    1946 </span><span class="lineNoCov">          0 :     sx = c*( fld[0][0] + 4*fld[1][0] + fld[2][0] )*dS/6.;</span>
<span class="lineNum">    1947 </span><span class="lineNoCov">          0 :     sy = c*( fld[0][1] + 4*fld[1][1] + fld[2][1] )*dS/6.;</span>
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :     sz = c*( fld[0][2] + 4*fld[1][2] + fld[2][2] )*dS/6.;</span>
<span class="lineNum">    1949 </span>            : 
<span class="lineNum">    1950 </span><span class="lineNoCov">          0 :     ssx = c*( fld[0][0] + 2*fld[1][0])*dS*dS/6.;</span>
<span class="lineNum">    1951 </span><span class="lineNoCov">          0 :     ssy = c*( fld[0][1] + 2*fld[1][1])*dS*dS/6.;</span>
<span class="lineNum">    1952 </span><span class="lineNoCov">          0 :     ssz = c*( fld[0][2] + 2*fld[1][2])*dS*dS/6.;</span>
<span class="lineNum">    1953 </span>            : 
<span class="lineNum">    1954 </span><span class="lineNoCov">          0 :     Double_t c2[3][3]    =   { {  5, -4, -1},{  44,  80,  -4},{ 11, 44, 5} }; // /=360.    </span>
<span class="lineNum">    1955 </span><span class="lineNoCov">          0 :     Double_t cc2[3][3]    =   { { 38,  8, -4},{ 148, 208, -20},{  3, 36, 3} }; // /=2520.</span>
<span class="lineNum">    1956 </span><span class="lineNoCov">          0 :     for(Int_t n=0; n&lt;3; n++)</span>
<span class="lineNum">    1957 </span><span class="lineNoCov">          0 :       for(Int_t m=0; m&lt;3; m++) </span>
<span class="lineNum">    1958 </span>            :         {
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :           syz += c2[n][m]*fld[n][1]*fld[m][2];</span>
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :           ssyz += cc2[n][m]*fld[n][1]*fld[m][2];</span>
<span class="lineNum">    1961 </span>            :         }
<span class="lineNum">    1962 </span>            :  
<span class="lineNum">    1963 </span><span class="lineNoCov">          0 :     syz  *= c*c*dS*dS/360.;</span>
<span class="lineNum">    1964 </span><span class="lineNoCov">          0 :     ssyz  *= c*c*dS*dS*dS/2520.;</span>
<span class="lineNum">    1965 </span>            :     
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :     syy  = c*( fld[0][1] + 4*fld[1][1] + fld[2][1] )*dS;</span>
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 :     syyy = syy*syy*syy / 1296;</span>
<span class="lineNum">    1968 </span><span class="lineNoCov">          0 :     syy  = syy*syy/72;</span>
<span class="lineNum">    1969 </span>            : 
<span class="lineNum">    1970 </span><span class="lineNoCov">          0 :     ssyy = ( fld[0][1]*( 38*fld[0][1] + 156*fld[1][1]  -   fld[2][1] )+</span>
<span class="lineNum">    1971 </span><span class="lineNoCov">          0 :             fld[1][1]*(              208*fld[1][1]  +16*fld[2][1] )+</span>
<span class="lineNum">    1972 </span><span class="lineNoCov">          0 :             fld[2][1]*(                             3*fld[2][1] )  </span>
<span class="lineNum">    1973 </span><span class="lineNoCov">          0 :             )*dS*dS*dS*c*c/2520.;</span>
<span class="lineNum">    1974 </span>            :     ssyyy = 
<span class="lineNum">    1975 </span>            :       (
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :        fld[0][1]*( fld[0][1]*( 85*fld[0][1] + 526*fld[1][1]  - 7*fld[2][1] )+</span>
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :                  fld[1][1]*(             1376*fld[1][1]  +84*fld[2][1] )+</span>
<span class="lineNum">    1978 </span><span class="lineNoCov">          0 :                  fld[2][1]*(                            19*fld[2][1] )  )+</span>
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 :        fld[1][1]*( fld[1][1]*(             1376*fld[1][1] +256*fld[2][1] )+</span>
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :                  fld[2][1]*(                            62*fld[2][1] )  )+</span>
<span class="lineNum">    1981 </span><span class="lineNoCov">          0 :        fld[2][1]*fld[2][1]  *(                             3*fld[2][1] )       </span>
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :        )*dS*dS*dS*dS*c*c*c/90720.;    </span>
<span class="lineNum">    1983 </span>            :  
<span class="lineNum">    1984 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1985 </span>            : 
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :   Double_t mJ[8][8];</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :   for( Int_t i=0; i&lt;8; i++ ) for( Int_t j=0; j&lt;8; j++) mJ[i][j]=0;</span>
<span class="lineNum">    1988 </span>            : 
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :   mJ[0][0]=1; mJ[0][1]=0; mJ[0][2]=0; mJ[0][3]=dS-ssyy;  mJ[0][4]=ssx;  mJ[0][5]=ssyyy-ssy;</span>
<span class="lineNum">    1990 </span><span class="lineNoCov">          0 :   mJ[1][0]=0; mJ[1][1]=1; mJ[1][2]=0; mJ[1][3]=-ssz;     mJ[1][4]=dS;  mJ[1][5]=ssx+ssyz;</span>
<span class="lineNum">    1991 </span><span class="lineNoCov">          0 :   mJ[2][0]=0; mJ[2][1]=0; mJ[2][2]=1; mJ[2][3]=ssy-ssyyy; mJ[2][4]=-ssx; mJ[2][5]=dS-ssyy;</span>
<span class="lineNum">    1992 </span>            :   
<span class="lineNum">    1993 </span><span class="lineNoCov">          0 :   mJ[3][0]=0; mJ[3][1]=0; mJ[3][2]=0; mJ[3][3]=1-syy;   mJ[3][4]=sx;  mJ[3][5]=syyy-sy;</span>
<span class="lineNum">    1994 </span><span class="lineNoCov">          0 :   mJ[4][0]=0; mJ[4][1]=0; mJ[4][2]=0; mJ[4][3]=-sz;     mJ[4][4]=1;   mJ[4][5]=sx+syz;</span>
<span class="lineNum">    1995 </span><span class="lineNoCov">          0 :   mJ[5][0]=0; mJ[5][1]=0; mJ[5][2]=0; mJ[5][3]=sy-syyy; mJ[5][4]=-sx; mJ[5][5]=1-syy;</span>
<span class="lineNum">    1996 </span><span class="lineNoCov">          0 :   mJ[6][6] = mJ[7][7] = 1;</span>
<span class="lineNum">    1997 </span>            :   
<span class="lineNum">    1998 </span><span class="lineNoCov">          0 :   P[0] = fP[0] + mJ[0][3]*px + mJ[0][4]*py + mJ[0][5]*pz;</span>
<span class="lineNum">    1999 </span><span class="lineNoCov">          0 :   P[1] = fP[1] + mJ[1][3]*px + mJ[1][4]*py + mJ[1][5]*pz;</span>
<span class="lineNum">    2000 </span><span class="lineNoCov">          0 :   P[2] = fP[2] + mJ[2][3]*px + mJ[2][4]*py + mJ[2][5]*pz;</span>
<span class="lineNum">    2001 </span><span class="lineNoCov">          0 :   P[3] =        mJ[3][3]*px + mJ[3][4]*py + mJ[3][5]*pz;</span>
<span class="lineNum">    2002 </span><span class="lineNoCov">          0 :   P[4] =        mJ[4][3]*px + mJ[4][4]*py + mJ[4][5]*pz;</span>
<span class="lineNum">    2003 </span><span class="lineNoCov">          0 :   P[5] =        mJ[5][3]*px + mJ[5][4]*py + mJ[5][5]*pz;</span>
<span class="lineNum">    2004 </span><span class="lineNoCov">          0 :   P[6] = fP[6];</span>
<span class="lineNum">    2005 </span><span class="lineNoCov">          0 :   P[7] = fP[7];</span>
<span class="lineNum">    2006 </span>            : 
<span class="lineNum">    2007 </span><span class="lineNoCov">          0 :   MultQSQt( mJ[0], fC, C);</span>
<span class="lineNum">    2008 </span>            : 
<span class="lineNum">    2009 </span><span class="lineNoCov">          0 : }</span>
<a name="2010"><span class="lineNum">    2010 </span>            : </a>
<span class="lineNum">    2011 </span>            : 
<span class="lineNum">    2012 </span>            : void AliKFParticleBase::TransportBz( Double_t b, Double_t t,
<span class="lineNum">    2013 </span>            :                                      Double_t p[], Double_t e[] ) const 
<span class="lineNum">    2014 </span>            : { 
<span class="lineNum">    2015 </span>            :   //* Transport the particle on dS, output to P[],C[], for Bz field
<span class="lineNum">    2016 </span>            :  
<span class="lineNum">    2017 </span>            :   const Double_t kCLight = 0.000299792458;
<span class="lineNum">    2018 </span><span class="lineCov">       1480 :   b = b*fQ*kCLight;</span>
<span class="lineNum">    2019 </span><span class="lineCov">        740 :   Double_t bs= b*t;</span>
<span class="lineNum">    2020 </span><span class="lineCov">        740 :   Double_t s = TMath::Sin(bs), c = TMath::Cos(bs);</span>
<span class="lineNum">    2021 </span>            :   Double_t sB, cB;
<span class="lineNum">    2022 </span><span class="lineCov">        740 :   if( TMath::Abs(bs)&gt;1.e-10){</span>
<span class="lineNum">    2023 </span><span class="lineCov">        378 :     sB= s/b;</span>
<span class="lineNum">    2024 </span><span class="lineCov">        378 :     cB= (1-c)/b;</span>
<span class="lineNum">    2025 </span><span class="lineCov">        378 :   }else{</span>
<span class="lineNum">    2026 </span><span class="lineCov">        362 :     const Double_t kOvSqr6 = 1./TMath::Sqrt(6.);</span>
<span class="lineNum">    2027 </span><span class="lineCov">        362 :     sB = (1.-bs*kOvSqr6)*(1.+bs*kOvSqr6)*t;</span>
<span class="lineNum">    2028 </span><span class="lineCov">        362 :     cB = .5*sB*bs;</span>
<span class="lineNum">    2029 </span>            :   }
<span class="lineNum">    2030 </span>            :   
<span class="lineNum">    2031 </span><span class="lineCov">        740 :   Double_t px = fP[3];</span>
<span class="lineNum">    2032 </span><span class="lineCov">        740 :   Double_t py = fP[4];</span>
<span class="lineNum">    2033 </span><span class="lineCov">        740 :   Double_t pz = fP[5];</span>
<span class="lineNum">    2034 </span>            :   
<span class="lineNum">    2035 </span><span class="lineCov">        740 :   p[0] = fP[0] + sB*px + cB*py;</span>
<span class="lineNum">    2036 </span><span class="lineCov">        740 :   p[1] = fP[1] - cB*px + sB*py;</span>
<span class="lineNum">    2037 </span><span class="lineCov">        740 :   p[2] = fP[2] +  t*pz;</span>
<span class="lineNum">    2038 </span><span class="lineCov">        740 :   p[3] =          c*px + s*py;</span>
<span class="lineNum">    2039 </span><span class="lineCov">        740 :   p[4] =         -s*px + c*py;</span>
<span class="lineNum">    2040 </span><span class="lineCov">        740 :   p[5] = fP[5];</span>
<span class="lineNum">    2041 </span><span class="lineCov">        740 :   p[6] = fP[6];</span>
<span class="lineNum">    2042 </span><span class="lineCov">        740 :   p[7] = fP[7];</span>
<span class="lineNum">    2043 </span>            : 
<span class="lineNum">    2044 </span>            :   /* 
<span class="lineNum">    2045 </span>            :   Double_t mJ[8][8] = { {1,0,0,   sB, cB,  0, 0, 0 },
<span class="lineNum">    2046 </span>            :                         {0,1,0,  -cB, sB,  0, 0, 0 },
<span class="lineNum">    2047 </span>            :                         {0,0,1,    0,  0,  t, 0, 0 },
<span class="lineNum">    2048 </span>            :                         {0,0,0,    c,  s,  0, 0, 0 },
<span class="lineNum">    2049 </span>            :                         {0,0,0,   -s,  c,  0, 0, 0 },
<span class="lineNum">    2050 </span>            :                         {0,0,0,    0,  0,  1, 0, 0 },
<span class="lineNum">    2051 </span>            :                         {0,0,0,    0,  0,  0, 1, 0 },
<span class="lineNum">    2052 </span>            :                         {0,0,0,    0,  0,  0, 0, 1 }  };
<span class="lineNum">    2053 </span>            :   Double_t mA[8][8];
<span class="lineNum">    2054 </span>            :   for( Int_t k=0,i=0; i&lt;8; i++)
<span class="lineNum">    2055 </span>            :     for( Int_t j=0; j&lt;=i; j++, k++ ) mA[i][j] = mA[j][i] = fC[k]; 
<span class="lineNum">    2056 </span>            : 
<span class="lineNum">    2057 </span>            :   Double_t mJC[8][8];
<span class="lineNum">    2058 </span>            :   for( Int_t i=0; i&lt;8; i++ )
<span class="lineNum">    2059 </span>            :     for( Int_t j=0; j&lt;8; j++ ){
<span class="lineNum">    2060 </span>            :       mJC[i][j]=0;
<span class="lineNum">    2061 </span>            :       for( Int_t k=0; k&lt;8; k++ ) mJC[i][j]+=mJ[i][k]*mA[k][j];
<span class="lineNum">    2062 </span>            :     }
<span class="lineNum">    2063 </span>            :   
<span class="lineNum">    2064 </span>            :   for( Int_t k=0,i=0; i&lt;8; i++)
<span class="lineNum">    2065 </span>            :     for( Int_t j=0; j&lt;=i; j++, k++ ){
<span class="lineNum">    2066 </span>            :       e[k] = 0;
<span class="lineNum">    2067 </span>            :       for( Int_t l=0; l&lt;8; l++ ) e[k]+=mJC[i][l]*mJ[j][l];
<span class="lineNum">    2068 </span>            :     }
<span class="lineNum">    2069 </span>            :   
<span class="lineNum">    2070 </span>            :   return;
<span class="lineNum">    2071 </span>            :   */
<span class="lineNum">    2072 </span>            : 
<span class="lineNum">    2073 </span>            :   Double_t 
<span class="lineNum">    2074 </span><span class="lineCov">        740 :     c6=fC[6], c7=fC[7], c8=fC[8], c17=fC[17], c18=fC[18],</span>
<span class="lineNum">    2075 </span><span class="lineCov">        740 :     c24 = fC[24], c31 = fC[31];</span>
<span class="lineNum">    2076 </span>            : 
<span class="lineNum">    2077 </span>            :   Double_t 
<span class="lineNum">    2078 </span><span class="lineCov">        740 :     cBC13 = cB*fC[13],</span>
<span class="lineNum">    2079 </span><span class="lineCov">        740 :     mJC13 = c7 - cB*fC[9] + sB*fC[13],</span>
<span class="lineNum">    2080 </span><span class="lineCov">        740 :     mJC14 = fC[11] - cBC13 + sB*fC[14],</span>
<span class="lineNum">    2081 </span><span class="lineCov">        740 :     mJC23 = c8 + t*c18,</span>
<span class="lineNum">    2082 </span><span class="lineCov">        740 :     mJC24 = fC[12] + t*fC[19],</span>
<span class="lineNum">    2083 </span><span class="lineCov">        740 :     mJC33 = c*fC[9] + s*fC[13],</span>
<span class="lineNum">    2084 </span><span class="lineCov">        740 :     mJC34 = c*fC[13] + s*fC[14],</span>
<span class="lineNum">    2085 </span><span class="lineCov">        740 :     mJC43 = -s*fC[9] + c*fC[13],</span>
<span class="lineNum">    2086 </span><span class="lineCov">        740 :     mJC44 = -s*fC[13] + c*fC[14];</span>
<span class="lineNum">    2087 </span>            : 
<span class="lineNum">    2088 </span>            : 
<span class="lineNum">    2089 </span><span class="lineCov">        740 :   e[0]= fC[0] + 2*(sB*c6 + cB*fC[10]) + (sB*fC[9] + 2*cBC13)*sB + cB*cB*fC[14];</span>
<span class="lineNum">    2090 </span><span class="lineCov">        740 :   e[1]= fC[1] - cB*c6 + sB*fC[10] + mJC13*sB + mJC14*cB;</span>
<span class="lineNum">    2091 </span><span class="lineCov">        740 :   e[2]= fC[2] - cB*c7 + sB*fC[11] - mJC13*cB + mJC14*sB;</span>
<span class="lineNum">    2092 </span><span class="lineCov">        740 :   e[3]= fC[3] + t*fC[15] + mJC23*sB + mJC24*cB;</span>
<span class="lineNum">    2093 </span><span class="lineCov">        740 :   e[4]= fC[4] + t*fC[16] - mJC23*cB + mJC24*sB;</span>
<span class="lineNum">    2094 </span>            : 
<span class="lineNum">    2095 </span><span class="lineCov">        740 :   e[15]= fC[15] + c18*sB + fC[19]*cB;</span>
<span class="lineNum">    2096 </span><span class="lineCov">        740 :   e[16]= fC[16] - c18*cB + fC[19]*sB;</span>
<span class="lineNum">    2097 </span><span class="lineCov">        740 :   e[17]= c17 + fC[20]*t;</span>
<span class="lineNum">    2098 </span><span class="lineCov">        740 :   e[18]= c18*c + fC[19]*s;</span>
<span class="lineNum">    2099 </span><span class="lineCov">        740 :   e[19]= -c18*s + fC[19]*c;</span>
<span class="lineNum">    2100 </span>            : 
<span class="lineNum">    2101 </span><span class="lineCov">        740 :   e[5]= fC[5] + (c17 + e[17] )*t;</span>
<span class="lineNum">    2102 </span>            : 
<span class="lineNum">    2103 </span><span class="lineCov">        740 :   e[6]= c*c6 + s*fC[10] + mJC33*sB + mJC34*cB;</span>
<span class="lineNum">    2104 </span><span class="lineCov">        740 :   e[7]= c*c7 + s*fC[11] - mJC33*cB + mJC34*sB;</span>
<span class="lineNum">    2105 </span><span class="lineCov">        740 :   e[8]= c*c8 + s*fC[12] + e[18]*t;</span>
<span class="lineNum">    2106 </span><span class="lineCov">        740 :   e[9]= mJC33*c + mJC34*s;</span>
<span class="lineNum">    2107 </span><span class="lineCov">        740 :   e[10]= -s*c6 + c*fC[10] + mJC43*sB + mJC44*cB;</span>
<span class="lineNum">    2108 </span>            : 
<span class="lineNum">    2109 </span>            :     
<span class="lineNum">    2110 </span><span class="lineCov">        740 :   e[11]= -s*c7 + c*fC[11] - mJC43*cB + mJC44*sB;</span>
<span class="lineNum">    2111 </span><span class="lineCov">        740 :   e[12]= -s*c8 + c*fC[12] + e[19]*t;</span>
<span class="lineNum">    2112 </span><span class="lineCov">        740 :   e[13]= mJC43*c + mJC44*s;</span>
<span class="lineNum">    2113 </span><span class="lineCov">        740 :   e[14]= -mJC43*s + mJC44*c;</span>
<span class="lineNum">    2114 </span><span class="lineCov">        740 :   e[20]= fC[20];</span>
<span class="lineNum">    2115 </span><span class="lineCov">        740 :   e[21]= fC[21] + fC[25]*cB + c24*sB;</span>
<span class="lineNum">    2116 </span><span class="lineCov">        740 :   e[22]= fC[22] - c24*cB + fC[25]*sB;</span>
<span class="lineNum">    2117 </span><span class="lineCov">        740 :   e[23]= fC[23] + fC[26]*t;</span>
<span class="lineNum">    2118 </span><span class="lineCov">        740 :   e[24]= c*c24 + s*fC[25];</span>
<span class="lineNum">    2119 </span><span class="lineCov">        740 :   e[25]= c*fC[25] - c24*s;</span>
<span class="lineNum">    2120 </span><span class="lineCov">        740 :   e[26]= fC[26];</span>
<span class="lineNum">    2121 </span><span class="lineCov">        740 :   e[27]= fC[27];</span>
<span class="lineNum">    2122 </span><span class="lineCov">        740 :   e[28]= fC[28] + fC[32]*cB + c31*sB;</span>
<span class="lineNum">    2123 </span><span class="lineCov">        740 :   e[29]= fC[29] - c31*cB + fC[32]*sB;</span>
<span class="lineNum">    2124 </span><span class="lineCov">        740 :   e[30]= fC[30] + fC[33]*t;</span>
<span class="lineNum">    2125 </span><span class="lineCov">        740 :   e[31]= c*c31 + s*fC[32];</span>
<span class="lineNum">    2126 </span><span class="lineCov">        740 :   e[32]= c*fC[32] - s*c31;</span>
<span class="lineNum">    2127 </span><span class="lineCov">        740 :   e[33]= fC[33];</span>
<span class="lineNum">    2128 </span><span class="lineCov">        740 :   e[34]= fC[34];</span>
<span class="lineNum">    2129 </span><span class="lineCov">        740 :   e[35]= fC[35];     </span>
<span class="lineNum">    2130 </span><span class="lineCov">        740 : }</span>
<a name="2131"><span class="lineNum">    2131 </span>            : </a>
<span class="lineNum">    2132 </span>            : 
<span class="lineNum">    2133 </span>            : Double_t AliKFParticleBase::GetDistanceFromVertex( const AliKFParticleBase &amp;Vtx ) const
<span class="lineNum">    2134 </span>            : {
<span class="lineNum">    2135 </span>            :   //* Calculate distance from vertex [cm]
<span class="lineNum">    2136 </span>            : 
<span class="lineNum">    2137 </span><span class="lineNoCov">          0 :   return GetDistanceFromVertex( Vtx.fP );</span>
<a name="2138"><span class="lineNum">    2138 </span>            : }</a>
<span class="lineNum">    2139 </span>            : 
<span class="lineNum">    2140 </span>            : Double_t AliKFParticleBase::GetDistanceFromVertex( const Double_t vtx[] ) const
<span class="lineNum">    2141 </span>            : {
<span class="lineNum">    2142 </span>            :   //* Calculate distance from vertex [cm]
<span class="lineNum">    2143 </span>            : 
<span class="lineNum">    2144 </span><span class="lineNoCov">          0 :   Double_t mP[8], mC[36];  </span>
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :   Transport( GetDStoPoint(vtx), mP, mC );</span>
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 :   Double_t d[3]={ vtx[0]-mP[0], vtx[1]-mP[1], vtx[2]-mP[2]};</span>
<span class="lineNum">    2147 </span><span class="lineNoCov">          0 :   return TMath::Sqrt( d[0]*d[0]+d[1]*d[1]+d[2]*d[2] );</span>
<a name="2148"><span class="lineNum">    2148 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2149 </span>            : 
<span class="lineNum">    2150 </span>            : Double_t AliKFParticleBase::GetDistanceFromParticle( const AliKFParticleBase &amp;p ) 
<span class="lineNum">    2151 </span>            :   const
<span class="lineNum">    2152 </span>            : { 
<span class="lineNum">    2153 </span>            :   //* Calculate distance to other particle [cm]
<span class="lineNum">    2154 </span>            : 
<span class="lineNum">    2155 </span><span class="lineNoCov">          0 :   Double_t dS, dS1;</span>
<span class="lineNum">    2156 </span><span class="lineNoCov">          0 :   GetDStoParticle( p, dS, dS1 );   </span>
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :   Double_t mP[8], mC[36], mP1[8], mC1[36];</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :   Transport( dS, mP, mC ); </span>
<span class="lineNum">    2159 </span><span class="lineNoCov">          0 :   p.Transport( dS1, mP1, mC1 ); </span>
<span class="lineNum">    2160 </span><span class="lineNoCov">          0 :   Double_t dx = mP[0]-mP1[0]; </span>
<span class="lineNum">    2161 </span><span class="lineNoCov">          0 :   Double_t dy = mP[1]-mP1[1]; </span>
<span class="lineNum">    2162 </span><span class="lineNoCov">          0 :   Double_t dz = mP[2]-mP1[2]; </span>
<span class="lineNum">    2163 </span>            :   dz = 0;
<span class="lineNum">    2164 </span><span class="lineNoCov">          0 :   return TMath::Sqrt(dx*dx+dy*dy+dz*dz);</span>
<a name="2165"><span class="lineNum">    2165 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2166 </span>            : 
<span class="lineNum">    2167 </span>            : Double_t AliKFParticleBase::GetDeviationFromVertex( const AliKFParticleBase &amp;Vtx ) const
<span class="lineNum">    2168 </span>            : {
<span class="lineNum">    2169 </span>            :   //* Calculate sqrt(Chi2/ndf) deviation from vertex
<span class="lineNum">    2170 </span>            : 
<span class="lineNum">    2171 </span><span class="lineNoCov">          0 :   return GetDeviationFromVertex( Vtx.fP, Vtx.fC );</span>
<span class="lineNum">    2172 </span>            : }
<a name="2173"><span class="lineNum">    2173 </span>            : </a>
<span class="lineNum">    2174 </span>            : 
<span class="lineNum">    2175 </span>            : Double_t AliKFParticleBase::GetDeviationFromVertex( const Double_t v[], const Double_t Cv[] ) const
<span class="lineNum">    2176 </span>            : {
<span class="lineNum">    2177 </span>            :   //* Calculate sqrt(Chi2/ndf) deviation from vertex
<span class="lineNum">    2178 </span>            :   //* v = [xyz], Cv=[Cxx,Cxy,Cyy,Cxz,Cyz,Czz]-covariance matrix
<span class="lineNum">    2179 </span>            : 
<span class="lineNum">    2180 </span><span class="lineNoCov">          0 :   Double_t mP[8];</span>
<span class="lineNum">    2181 </span><span class="lineNoCov">          0 :   Double_t mC[36];</span>
<span class="lineNum">    2182 </span>            :   
<span class="lineNum">    2183 </span><span class="lineNoCov">          0 :   Transport( GetDStoPoint(v), mP, mC );  </span>
<span class="lineNum">    2184 </span>            : 
<span class="lineNum">    2185 </span><span class="lineNoCov">          0 :   Double_t d[3]={ v[0]-mP[0], v[1]-mP[1], v[2]-mP[2]};</span>
<span class="lineNum">    2186 </span>            : 
<span class="lineNum">    2187 </span><span class="lineNoCov">          0 :   Double_t sigmaS = .1+10.*TMath::Sqrt( (d[0]*d[0]+d[1]*d[1]+d[2]*d[2])/</span>
<span class="lineNum">    2188 </span><span class="lineNoCov">          0 :                                  (mP[3]*mP[3]+mP[4]*mP[4]+mP[5]*mP[5])  );</span>
<span class="lineNum">    2189 </span>            : 
<span class="lineNum">    2190 </span>            :    
<span class="lineNum">    2191 </span><span class="lineNoCov">          0 :   Double_t h[3] = { mP[3]*sigmaS, mP[4]*sigmaS, mP[5]*sigmaS };       </span>
<span class="lineNum">    2192 </span>            :   
<span class="lineNum">    2193 </span>            :   Double_t mSi[6] = 
<span class="lineNum">    2194 </span><span class="lineNoCov">          0 :     { mC[0] +h[0]*h[0], </span>
<span class="lineNum">    2195 </span><span class="lineNoCov">          0 :       mC[1] +h[1]*h[0], mC[2] +h[1]*h[1], </span>
<span class="lineNum">    2196 </span><span class="lineNoCov">          0 :       mC[3] +h[2]*h[0], mC[4] +h[2]*h[1], mC[5] +h[2]*h[2] };</span>
<span class="lineNum">    2197 </span>            : 
<span class="lineNum">    2198 </span><span class="lineNoCov">          0 :   if( Cv ){</span>
<span class="lineNum">    2199 </span><span class="lineNoCov">          0 :     mSi[0]+=Cv[0];</span>
<span class="lineNum">    2200 </span><span class="lineNoCov">          0 :     mSi[1]+=Cv[1];</span>
<span class="lineNum">    2201 </span><span class="lineNoCov">          0 :     mSi[2]+=Cv[2];</span>
<span class="lineNum">    2202 </span><span class="lineNoCov">          0 :     mSi[3]+=Cv[3];</span>
<span class="lineNum">    2203 </span><span class="lineNoCov">          0 :     mSi[4]+=Cv[4];</span>
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :     mSi[5]+=Cv[5];</span>
<span class="lineNum">    2205 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2206 </span>            :   
<span class="lineNum">    2207 </span>            :   Double_t mS[6];
<span class="lineNum">    2208 </span>            : 
<span class="lineNum">    2209 </span><span class="lineNoCov">          0 :   mS[0] = mSi[2]*mSi[5] - mSi[4]*mSi[4];</span>
<span class="lineNum">    2210 </span><span class="lineNoCov">          0 :   mS[1] = mSi[3]*mSi[4] - mSi[1]*mSi[5];</span>
<span class="lineNum">    2211 </span><span class="lineNoCov">          0 :   mS[2] = mSi[0]*mSi[5] - mSi[3]*mSi[3];</span>
<span class="lineNum">    2212 </span><span class="lineNoCov">          0 :   mS[3] = mSi[1]*mSi[4] - mSi[2]*mSi[3];</span>
<span class="lineNum">    2213 </span><span class="lineNoCov">          0 :   mS[4] = mSi[1]*mSi[3] - mSi[0]*mSi[4];</span>
<span class="lineNum">    2214 </span><span class="lineNoCov">          0 :   mS[5] = mSi[0]*mSi[2] - mSi[1]*mSi[1];         </span>
<span class="lineNum">    2215 </span>            :       
<span class="lineNum">    2216 </span><span class="lineNoCov">          0 :   Double_t s = ( mSi[0]*mS[0] + mSi[1]*mS[1] + mSi[3]*mS[3] );</span>
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :   s = ( s &gt; 1.E-20 )  ?1./s :0;        </span>
<span class="lineNum">    2218 </span>            : 
<span class="lineNum">    2219 </span><span class="lineNoCov">          0 :   return TMath::Sqrt( TMath::Abs(s*( ( mS[0]*d[0] + mS[1]*d[1] + mS[3]*d[2])*d[0]</span>
<span class="lineNum">    2220 </span><span class="lineNoCov">          0 :                    +(mS[1]*d[0] + mS[2]*d[1] + mS[4]*d[2])*d[1]</span>
<span class="lineNum">    2221 </span><span class="lineNoCov">          0 :                    +(mS[3]*d[0] + mS[4]*d[1] + mS[5]*d[2])*d[2] ))/2);</span>
<span class="lineNum">    2222 </span><span class="lineNoCov">          0 : }</span>
<a name="2223"><span class="lineNum">    2223 </span>            : </a>
<span class="lineNum">    2224 </span>            : 
<span class="lineNum">    2225 </span>            : Double_t AliKFParticleBase::GetDeviationFromParticle( const AliKFParticleBase &amp;p ) 
<span class="lineNum">    2226 </span>            :   const
<span class="lineNum">    2227 </span>            : { 
<span class="lineNum">    2228 </span>            :   //* Calculate sqrt(Chi2/ndf) deviation from other particle
<span class="lineNum">    2229 </span>            : 
<span class="lineNum">    2230 </span><span class="lineNoCov">          0 :   Double_t dS, dS1;</span>
<span class="lineNum">    2231 </span><span class="lineNoCov">          0 :   GetDStoParticle( p, dS, dS1 );   </span>
<span class="lineNum">    2232 </span><span class="lineNoCov">          0 :   Double_t mP1[8], mC1[36];</span>
<span class="lineNum">    2233 </span><span class="lineNoCov">          0 :   p.Transport( dS1, mP1, mC1 ); </span>
<span class="lineNum">    2234 </span>            : 
<span class="lineNum">    2235 </span><span class="lineNoCov">          0 :   Double_t d[3]={ fP[0]-mP1[0], fP[1]-mP1[1], fP[2]-mP1[2]};</span>
<span class="lineNum">    2236 </span>            : 
<span class="lineNum">    2237 </span><span class="lineNoCov">          0 :   Double_t sigmaS = .1+10.*TMath::Sqrt( (d[0]*d[0]+d[1]*d[1]+d[2]*d[2])/</span>
<span class="lineNum">    2238 </span><span class="lineNoCov">          0 :                                         (mP1[3]*mP1[3]+mP1[4]*mP1[4]+mP1[5]*mP1[5])  );</span>
<span class="lineNum">    2239 </span>            : 
<span class="lineNum">    2240 </span><span class="lineNoCov">          0 :   Double_t h[3] = { mP1[3]*sigmaS, mP1[4]*sigmaS, mP1[5]*sigmaS };       </span>
<span class="lineNum">    2241 </span>            :   
<span class="lineNum">    2242 </span><span class="lineNoCov">          0 :   mC1[0] +=h[0]*h[0];</span>
<span class="lineNum">    2243 </span><span class="lineNoCov">          0 :   mC1[1] +=h[1]*h[0]; </span>
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :   mC1[2] +=h[1]*h[1]; </span>
<span class="lineNum">    2245 </span><span class="lineNoCov">          0 :   mC1[3] +=h[2]*h[0]; </span>
<span class="lineNum">    2246 </span><span class="lineNoCov">          0 :   mC1[4] +=h[2]*h[1];</span>
<span class="lineNum">    2247 </span><span class="lineNoCov">          0 :   mC1[5] +=h[2]*h[2];</span>
<span class="lineNum">    2248 </span>            : 
<span class="lineNum">    2249 </span><span class="lineNoCov">          0 :   return GetDeviationFromVertex( mP1, mC1 )*TMath::Sqrt(2./1.);</span>
<span class="lineNum">    2250 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2251 </span>            : 
<a name="2252"><span class="lineNum">    2252 </span>            : </a>
<span class="lineNum">    2253 </span>            : 
<span class="lineNum">    2254 </span>            : void AliKFParticleBase::SubtractFromVertex(  AliKFParticleBase &amp;Vtx ) const
<span class="lineNum">    2255 </span>            : {
<span class="lineNum">    2256 </span>            :   //* Subtract the particle from the vertex  
<span class="lineNum">    2257 </span>            : 
<span class="lineNum">    2258 </span><span class="lineNoCov">          0 :   Double_t fld[3];  </span>
<span class="lineNum">    2259 </span>            :   {
<span class="lineNum">    2260 </span><span class="lineNoCov">          0 :     GetFieldValue( Vtx.fP, fld );</span>
<span class="lineNum">    2261 </span>            :     const Double_t kCLight =  0.000299792458;
<span class="lineNum">    2262 </span><span class="lineNoCov">          0 :     fld[0]*=kCLight; fld[1]*=kCLight; fld[2]*=kCLight;</span>
<span class="lineNum">    2263 </span>            :   }
<span class="lineNum">    2264 </span>            : 
<span class="lineNum">    2265 </span><span class="lineNoCov">          0 :   Double_t m[8];</span>
<span class="lineNum">    2266 </span><span class="lineNoCov">          0 :   Double_t mCm[36];</span>
<span class="lineNum">    2267 </span>            : 
<span class="lineNum">    2268 </span><span class="lineNoCov">          0 :   if( Vtx.fIsLinearized ){</span>
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :     GetMeasurement( Vtx.fVtxGuess, m, mCm );</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 :     GetMeasurement( Vtx.fP, m, mCm );</span>
<span class="lineNum">    2272 </span>            :   }
<span class="lineNum">    2273 </span>            :   
<span class="lineNum">    2274 </span>            :   Double_t mV[6];
<span class="lineNum">    2275 </span>            :     
<span class="lineNum">    2276 </span><span class="lineNoCov">          0 :   mV[ 0] = mCm[ 0];</span>
<span class="lineNum">    2277 </span><span class="lineNoCov">          0 :   mV[ 1] = mCm[ 1];</span>
<span class="lineNum">    2278 </span><span class="lineNoCov">          0 :   mV[ 2] = mCm[ 2];</span>
<span class="lineNum">    2279 </span><span class="lineNoCov">          0 :   mV[ 3] = mCm[ 3];</span>
<span class="lineNum">    2280 </span><span class="lineNoCov">          0 :   mV[ 4] = mCm[ 4];</span>
<span class="lineNum">    2281 </span><span class="lineNoCov">          0 :   mV[ 5] = mCm[ 5];</span>
<span class="lineNum">    2282 </span>            :      
<span class="lineNum">    2283 </span>            :   //* 
<span class="lineNum">    2284 </span>            :             
<span class="lineNum">    2285 </span>            :   Double_t mS[6];
<span class="lineNum">    2286 </span>            :   {
<span class="lineNum">    2287 </span><span class="lineNoCov">          0 :     Double_t mSi[6] = { mV[0]-Vtx.fC[0], </span>
<span class="lineNum">    2288 </span><span class="lineNoCov">          0 :                         mV[1]-Vtx.fC[1], mV[2]-Vtx.fC[2], </span>
<span class="lineNum">    2289 </span><span class="lineNoCov">          0 :                         mV[3]-Vtx.fC[3], mV[4]-Vtx.fC[4], mV[5]-Vtx.fC[5] };</span>
<span class="lineNum">    2290 </span>            :     
<span class="lineNum">    2291 </span><span class="lineNoCov">          0 :     mS[0] = mSi[2]*mSi[5] - mSi[4]*mSi[4];</span>
<span class="lineNum">    2292 </span><span class="lineNoCov">          0 :     mS[1] = mSi[3]*mSi[4] - mSi[1]*mSi[5];</span>
<span class="lineNum">    2293 </span><span class="lineNoCov">          0 :     mS[2] = mSi[0]*mSi[5] - mSi[3]*mSi[3];</span>
<span class="lineNum">    2294 </span><span class="lineNoCov">          0 :     mS[3] = mSi[1]*mSi[4] - mSi[2]*mSi[3];</span>
<span class="lineNum">    2295 </span><span class="lineNoCov">          0 :     mS[4] = mSi[1]*mSi[3] - mSi[0]*mSi[4];</span>
<span class="lineNum">    2296 </span><span class="lineNoCov">          0 :     mS[5] = mSi[0]*mSi[2] - mSi[1]*mSi[1];       </span>
<span class="lineNum">    2297 </span>            :     
<span class="lineNum">    2298 </span><span class="lineNoCov">          0 :     Double_t s = ( mSi[0]*mS[0] + mSi[1]*mS[1] + mSi[3]*mS[3] );</span>
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :     s = ( s &gt; 1.E-20 )  ?1./s :0;      </span>
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :     mS[0]*=s;</span>
<span class="lineNum">    2301 </span><span class="lineNoCov">          0 :     mS[1]*=s;</span>
<span class="lineNum">    2302 </span><span class="lineNoCov">          0 :     mS[2]*=s;</span>
<span class="lineNum">    2303 </span><span class="lineNoCov">          0 :     mS[3]*=s;</span>
<span class="lineNum">    2304 </span><span class="lineNoCov">          0 :     mS[4]*=s;</span>
<span class="lineNum">    2305 </span><span class="lineNoCov">          0 :     mS[5]*=s;</span>
<span class="lineNum">    2306 </span>            :   }
<span class="lineNum">    2307 </span>            :     
<span class="lineNum">    2308 </span>            :   //* Residual (measured - estimated)
<span class="lineNum">    2309 </span>            :     
<span class="lineNum">    2310 </span><span class="lineNoCov">          0 :   Double_t zeta[3] = { m[0]-Vtx.fP[0], m[1]-Vtx.fP[1], m[2]-Vtx.fP[2] };</span>
<span class="lineNum">    2311 </span>            :         
<span class="lineNum">    2312 </span>            :   //* mCHt = mCH' - D'
<span class="lineNum">    2313 </span>            :     
<span class="lineNum">    2314 </span><span class="lineNoCov">          0 :   Double_t mCHt0[3], mCHt1[3], mCHt2[3];</span>
<span class="lineNum">    2315 </span>            :     
<span class="lineNum">    2316 </span><span class="lineNoCov">          0 :   mCHt0[0]=Vtx.fC[ 0] ;      mCHt1[0]=Vtx.fC[ 1] ;      mCHt2[0]=Vtx.fC[ 3] ;</span>
<span class="lineNum">    2317 </span><span class="lineNoCov">          0 :   mCHt0[1]=Vtx.fC[ 1] ;      mCHt1[1]=Vtx.fC[ 2] ;      mCHt2[1]=Vtx.fC[ 4] ;</span>
<span class="lineNum">    2318 </span><span class="lineNoCov">          0 :   mCHt0[2]=Vtx.fC[ 3] ;      mCHt1[2]=Vtx.fC[ 4] ;      mCHt2[2]=Vtx.fC[ 5] ;</span>
<span class="lineNum">    2319 </span>            :   
<span class="lineNum">    2320 </span>            :   //* Kalman gain K = mCH'*S
<span class="lineNum">    2321 </span>            :     
<span class="lineNum">    2322 </span><span class="lineNoCov">          0 :   Double_t k0[3], k1[3], k2[3];</span>
<span class="lineNum">    2323 </span>            :     
<span class="lineNum">    2324 </span><span class="lineNoCov">          0 :   for(Int_t i=0;i&lt;3;++i){</span>
<span class="lineNum">    2325 </span><span class="lineNoCov">          0 :     k0[i] = mCHt0[i]*mS[0] + mCHt1[i]*mS[1] + mCHt2[i]*mS[3];</span>
<span class="lineNum">    2326 </span><span class="lineNoCov">          0 :     k1[i] = mCHt0[i]*mS[1] + mCHt1[i]*mS[2] + mCHt2[i]*mS[4];</span>
<span class="lineNum">    2327 </span><span class="lineNoCov">          0 :     k2[i] = mCHt0[i]*mS[3] + mCHt1[i]*mS[4] + mCHt2[i]*mS[5];</span>
<span class="lineNum">    2328 </span>            :   }
<span class="lineNum">    2329 </span>            :     
<span class="lineNum">    2330 </span>            :   //* New estimation of the vertex position r += K*zeta
<span class="lineNum">    2331 </span>            :     
<span class="lineNum">    2332 </span><span class="lineNoCov">          0 :   Double_t dChi2 = -(mS[0]*zeta[0] + mS[1]*zeta[1] + mS[3]*zeta[2])*zeta[0]</span>
<span class="lineNum">    2333 </span><span class="lineNoCov">          0 :     +      (mS[1]*zeta[0] + mS[2]*zeta[1] + mS[4]*zeta[2])*zeta[1]</span>
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :     +      (mS[3]*zeta[0] + mS[4]*zeta[1] + mS[5]*zeta[2])*zeta[2];</span>
<span class="lineNum">    2335 </span>            : 
<span class="lineNum">    2336 </span><span class="lineNoCov">          0 :   if( Vtx.fChi2 - dChi2 &lt; 0 ) return;</span>
<span class="lineNum">    2337 </span>            : 
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :   for(Int_t i=0;i&lt;3;++i) </span>
<span class="lineNum">    2339 </span><span class="lineNoCov">          0 :     Vtx.fP[i] -= k0[i]*zeta[0] + k1[i]*zeta[1] + k2[i]*zeta[2];       </span>
<span class="lineNum">    2340 </span>            :     
<span class="lineNum">    2341 </span>            :   //* New covariance matrix C -= K*(mCH')'
<span class="lineNum">    2342 </span>            :     
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :   for(Int_t i=0, k=0;i&lt;3;++i){</span>
<span class="lineNum">    2344 </span><span class="lineNoCov">          0 :     for(Int_t j=0;j&lt;=i;++j,++k) </span>
<span class="lineNum">    2345 </span><span class="lineNoCov">          0 :       Vtx.fC[k] += k0[i]*mCHt0[j] + k1[i]*mCHt1[j] + k2[i]*mCHt2[j];</span>
<span class="lineNum">    2346 </span>            :   }
<span class="lineNum">    2347 </span>            :     
<span class="lineNum">    2348 </span>            :   //* Calculate Chi^2 
<span class="lineNum">    2349 </span>            : 
<span class="lineNum">    2350 </span><span class="lineNoCov">          0 :   Vtx.fNDF  -= 2;</span>
<span class="lineNum">    2351 </span><span class="lineNoCov">          0 :   Vtx.fChi2 -= dChi2;</span>
<span class="lineNum">    2352 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2353 </span>            : 
<a name="2354"><span class="lineNum">    2354 </span>            : </a>
<span class="lineNum">    2355 </span>            : 
<span class="lineNum">    2356 </span>            : void AliKFParticleBase::TransportLine( Double_t dS, 
<span class="lineNum">    2357 </span>            :                                        Double_t P[], Double_t C[] ) const 
<span class="lineNum">    2358 </span>            : {
<span class="lineNum">    2359 </span>            :   //* Transport the particle as a straight line
<span class="lineNum">    2360 </span>            : 
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :   P[0] = fP[0] + dS*fP[3];</span>
<span class="lineNum">    2362 </span><span class="lineNoCov">          0 :   P[1] = fP[1] + dS*fP[4];</span>
<span class="lineNum">    2363 </span><span class="lineNoCov">          0 :   P[2] = fP[2] + dS*fP[5];</span>
<span class="lineNum">    2364 </span><span class="lineNoCov">          0 :   P[3] = fP[3];</span>
<span class="lineNum">    2365 </span><span class="lineNoCov">          0 :   P[4] = fP[4];</span>
<span class="lineNum">    2366 </span><span class="lineNoCov">          0 :   P[5] = fP[5];</span>
<span class="lineNum">    2367 </span><span class="lineNoCov">          0 :   P[6] = fP[6];</span>
<span class="lineNum">    2368 </span><span class="lineNoCov">          0 :   P[7] = fP[7];</span>
<span class="lineNum">    2369 </span>            :  
<span class="lineNum">    2370 </span><span class="lineNoCov">          0 :   Double_t c6  = fC[ 6] + dS*fC[ 9];</span>
<span class="lineNum">    2371 </span><span class="lineNoCov">          0 :   Double_t c11 = fC[11] + dS*fC[14];</span>
<span class="lineNum">    2372 </span><span class="lineNoCov">          0 :   Double_t c17 = fC[17] + dS*fC[20];</span>
<span class="lineNum">    2373 </span><span class="lineNoCov">          0 :   Double_t sc13 = dS*fC[13];</span>
<span class="lineNum">    2374 </span><span class="lineNoCov">          0 :   Double_t sc18 = dS*fC[18];</span>
<span class="lineNum">    2375 </span><span class="lineNoCov">          0 :   Double_t sc19 = dS*fC[19];</span>
<span class="lineNum">    2376 </span>            : 
<span class="lineNum">    2377 </span><span class="lineNoCov">          0 :   C[ 0] = fC[ 0] + dS*( fC[ 6] + c6  );</span>
<span class="lineNum">    2378 </span><span class="lineNoCov">          0 :   C[ 2] = fC[ 2] + dS*( fC[11] + c11 );</span>
<span class="lineNum">    2379 </span><span class="lineNoCov">          0 :   C[ 5] = fC[ 5] + dS*( fC[17] + c17 );</span>
<span class="lineNum">    2380 </span>            : 
<span class="lineNum">    2381 </span><span class="lineNoCov">          0 :   C[ 7] = fC[ 7] + sc13;</span>
<span class="lineNum">    2382 </span><span class="lineNoCov">          0 :   C[ 8] = fC[ 8] + sc18;</span>
<span class="lineNum">    2383 </span><span class="lineNoCov">          0 :   C[ 9] = fC[ 9];</span>
<span class="lineNum">    2384 </span>            : 
<span class="lineNum">    2385 </span><span class="lineNoCov">          0 :   C[12] = fC[12] + sc19;</span>
<span class="lineNum">    2386 </span>            : 
<span class="lineNum">    2387 </span><span class="lineNoCov">          0 :   C[ 1] = fC[ 1] + dS*( fC[10] + C[ 7] );</span>
<span class="lineNum">    2388 </span><span class="lineNoCov">          0 :   C[ 3] = fC[ 3] + dS*( fC[15] + C[ 8] );</span>
<span class="lineNum">    2389 </span><span class="lineNoCov">          0 :   C[ 4] = fC[ 4] + dS*( fC[16] + C[12] ); </span>
<span class="lineNum">    2390 </span><span class="lineNoCov">          0 :   C[ 6] = c6;</span>
<span class="lineNum">    2391 </span>            : 
<span class="lineNum">    2392 </span><span class="lineNoCov">          0 :   C[10] = fC[10] + sc13;</span>
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :   C[11] = c11;</span>
<span class="lineNum">    2394 </span>            : 
<span class="lineNum">    2395 </span><span class="lineNoCov">          0 :   C[13] = fC[13];</span>
<span class="lineNum">    2396 </span><span class="lineNoCov">          0 :   C[14] = fC[14];</span>
<span class="lineNum">    2397 </span><span class="lineNoCov">          0 :   C[15] = fC[15] + sc18;</span>
<span class="lineNum">    2398 </span><span class="lineNoCov">          0 :   C[16] = fC[16] + sc19;</span>
<span class="lineNum">    2399 </span><span class="lineNoCov">          0 :   C[17] = c17;</span>
<span class="lineNum">    2400 </span>            :   
<span class="lineNum">    2401 </span><span class="lineNoCov">          0 :   C[18] = fC[18];</span>
<span class="lineNum">    2402 </span><span class="lineNoCov">          0 :   C[19] = fC[19];</span>
<span class="lineNum">    2403 </span><span class="lineNoCov">          0 :   C[20] = fC[20];</span>
<span class="lineNum">    2404 </span><span class="lineNoCov">          0 :   C[21] = fC[21] + dS*fC[24];</span>
<span class="lineNum">    2405 </span><span class="lineNoCov">          0 :   C[22] = fC[22] + dS*fC[25];</span>
<span class="lineNum">    2406 </span><span class="lineNoCov">          0 :   C[23] = fC[23] + dS*fC[26];</span>
<span class="lineNum">    2407 </span>            : 
<span class="lineNum">    2408 </span><span class="lineNoCov">          0 :   C[24] = fC[24];</span>
<span class="lineNum">    2409 </span><span class="lineNoCov">          0 :   C[25] = fC[25];</span>
<span class="lineNum">    2410 </span><span class="lineNoCov">          0 :   C[26] = fC[26];</span>
<span class="lineNum">    2411 </span><span class="lineNoCov">          0 :   C[27] = fC[27];</span>
<span class="lineNum">    2412 </span><span class="lineNoCov">          0 :   C[28] = fC[28] + dS*fC[31];</span>
<span class="lineNum">    2413 </span><span class="lineNoCov">          0 :   C[29] = fC[29] + dS*fC[32];</span>
<span class="lineNum">    2414 </span><span class="lineNoCov">          0 :   C[30] = fC[30] + dS*fC[33];</span>
<span class="lineNum">    2415 </span>            : 
<span class="lineNum">    2416 </span><span class="lineNoCov">          0 :   C[31] = fC[31];</span>
<span class="lineNum">    2417 </span><span class="lineNoCov">          0 :   C[32] = fC[32];</span>
<span class="lineNum">    2418 </span><span class="lineNoCov">          0 :   C[33] = fC[33];</span>
<span class="lineNum">    2419 </span><span class="lineNoCov">          0 :   C[34] = fC[34];</span>
<span class="lineNum">    2420 </span><span class="lineNoCov">          0 :   C[35] = fC[35]; </span>
<span class="lineNum">    2421 </span><span class="lineNoCov">          0 : }</span>
<a name="2422"><span class="lineNum">    2422 </span>            : </a>
<span class="lineNum">    2423 </span>            : 
<span class="lineNum">    2424 </span>            : void AliKFParticleBase::ConstructGammaBz( const AliKFParticleBase &amp;daughter1,
<span class="lineNum">    2425 </span>            :                                           const AliKFParticleBase &amp;daughter2, double Bz  )
<span class="lineNum">    2426 </span>            : { 
<span class="lineNum">    2427 </span>            :   //* Create gamma
<span class="lineNum">    2428 </span>            :   
<span class="lineNum">    2429 </span><span class="lineNoCov">          0 :   const AliKFParticleBase *daughters[2] = { &amp;daughter1, &amp;daughter2};</span>
<span class="lineNum">    2430 </span>            : 
<span class="lineNum">    2431 </span><span class="lineNoCov">          0 :   double v0[3];</span>
<span class="lineNum">    2432 </span>            :   
<span class="lineNum">    2433 </span><span class="lineNoCov">          0 :   if( !fIsLinearized ){</span>
<span class="lineNum">    2434 </span><span class="lineNoCov">          0 :     Double_t ds, ds1;</span>
<span class="lineNum">    2435 </span><span class="lineNoCov">          0 :     Double_t m[8];</span>
<span class="lineNum">    2436 </span><span class="lineNoCov">          0 :     Double_t mCd[36];       </span>
<span class="lineNum">    2437 </span><span class="lineNoCov">          0 :     daughter1.GetDStoParticle(daughter2, ds, ds1);      </span>
<span class="lineNum">    2438 </span><span class="lineNoCov">          0 :     daughter1.Transport( ds, m, mCd );</span>
<span class="lineNum">    2439 </span><span class="lineNoCov">          0 :     fP[0] = m[0];</span>
<span class="lineNum">    2440 </span><span class="lineNoCov">          0 :     fP[1] = m[1];</span>
<span class="lineNum">    2441 </span><span class="lineNoCov">          0 :     fP[2] = m[2];</span>
<span class="lineNum">    2442 </span><span class="lineNoCov">          0 :     daughter2.Transport( ds1, m, mCd );</span>
<span class="lineNum">    2443 </span><span class="lineNoCov">          0 :     fP[0] = .5*( fP[0] + m[0] );</span>
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 :     fP[1] = .5*( fP[1] + m[1] );</span>
<span class="lineNum">    2445 </span><span class="lineNoCov">          0 :     fP[2] = .5*( fP[2] + m[2] );</span>
<span class="lineNum">    2446 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    2447 </span><span class="lineNoCov">          0 :     fP[0] = fVtxGuess[0];</span>
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :     fP[1] = fVtxGuess[1];</span>
<span class="lineNum">    2449 </span><span class="lineNoCov">          0 :     fP[2] = fVtxGuess[2];</span>
<span class="lineNum">    2450 </span>            :   }
<span class="lineNum">    2451 </span>            : 
<span class="lineNum">    2452 </span><span class="lineNoCov">          0 :   double daughterP[2][8], daughterC[2][36];</span>
<span class="lineNum">    2453 </span><span class="lineNoCov">          0 :   double vtxMom[2][3];</span>
<span class="lineNum">    2454 </span>            : 
<span class="lineNum">    2455 </span><span class="lineNoCov">          0 :   int nIter = fIsLinearized ?1 :2;</span>
<span class="lineNum">    2456 </span>            : 
<span class="lineNum">    2457 </span><span class="lineNoCov">          0 :   for( int iter=0; iter&lt;nIter; iter++){</span>
<span class="lineNum">    2458 </span>            : 
<span class="lineNum">    2459 </span><span class="lineNoCov">          0 :     v0[0] = fP[0];</span>
<span class="lineNum">    2460 </span><span class="lineNoCov">          0 :     v0[1] = fP[1];</span>
<span class="lineNum">    2461 </span><span class="lineNoCov">          0 :     v0[2] = fP[2];</span>
<span class="lineNum">    2462 </span>            :     
<span class="lineNum">    2463 </span><span class="lineNoCov">          0 :     fAtProductionVertex = 0;</span>
<span class="lineNum">    2464 </span><span class="lineNoCov">          0 :     fSFromDecay = 0;</span>
<span class="lineNum">    2465 </span><span class="lineNoCov">          0 :     fP[0] = v0[0];</span>
<span class="lineNum">    2466 </span><span class="lineNoCov">          0 :     fP[1] = v0[1];</span>
<span class="lineNum">    2467 </span><span class="lineNoCov">          0 :     fP[2] = v0[2];</span>
<span class="lineNum">    2468 </span><span class="lineNoCov">          0 :     fP[3] = 0;</span>
<span class="lineNum">    2469 </span><span class="lineNoCov">          0 :     fP[4] = 0;</span>
<span class="lineNum">    2470 </span><span class="lineNoCov">          0 :     fP[5] = 0;</span>
<span class="lineNum">    2471 </span><span class="lineNoCov">          0 :     fP[6] = 0;</span>
<span class="lineNum">    2472 </span><span class="lineNoCov">          0 :     fP[7] = 0;</span>
<span class="lineNum">    2473 </span>            : 
<span class="lineNum">    2474 </span>            :   
<span class="lineNum">    2475 </span>            :     // fit daughters to the vertex guess  
<span class="lineNum">    2476 </span>            :     
<span class="lineNum">    2477 </span>            :     {  
<span class="lineNum">    2478 </span><span class="lineNoCov">          0 :       for( int id=0; id&lt;2; id++ ){</span>
<span class="lineNum">    2479 </span>            :         
<span class="lineNum">    2480 </span><span class="lineNoCov">          0 :         double *p = daughterP[id];</span>
<span class="lineNum">    2481 </span><span class="lineNoCov">          0 :         double *mC = daughterC[id];</span>
<span class="lineNum">    2482 </span>            :         
<span class="lineNum">    2483 </span><span class="lineNoCov">          0 :         daughters[id]-&gt;GetMeasurement( v0, p, mC );</span>
<span class="lineNum">    2484 </span>            :         
<span class="lineNum">    2485 </span><span class="lineNoCov">          0 :         Double_t mAi[6];</span>
<span class="lineNum">    2486 </span><span class="lineNoCov">          0 :         InvertSym3(mC, mAi );</span>
<span class="lineNum">    2487 </span>            :         
<span class="lineNum">    2488 </span>            :         Double_t mB[3][3];
<span class="lineNum">    2489 </span>            :         
<span class="lineNum">    2490 </span><span class="lineNoCov">          0 :         mB[0][0] = mC[ 6]*mAi[0] + mC[ 7]*mAi[1] + mC[ 8]*mAi[3];</span>
<span class="lineNum">    2491 </span><span class="lineNoCov">          0 :         mB[0][1] = mC[ 6]*mAi[1] + mC[ 7]*mAi[2] + mC[ 8]*mAi[4];</span>
<span class="lineNum">    2492 </span><span class="lineNoCov">          0 :         mB[0][2] = mC[ 6]*mAi[3] + mC[ 7]*mAi[4] + mC[ 8]*mAi[5];</span>
<span class="lineNum">    2493 </span>            :         
<span class="lineNum">    2494 </span><span class="lineNoCov">          0 :         mB[1][0] = mC[10]*mAi[0] + mC[11]*mAi[1] + mC[12]*mAi[3];</span>
<span class="lineNum">    2495 </span><span class="lineNoCov">          0 :         mB[1][1] = mC[10]*mAi[1] + mC[11]*mAi[2] + mC[12]*mAi[4];</span>
<span class="lineNum">    2496 </span><span class="lineNoCov">          0 :         mB[1][2] = mC[10]*mAi[3] + mC[11]*mAi[4] + mC[12]*mAi[5];</span>
<span class="lineNum">    2497 </span>            :         
<span class="lineNum">    2498 </span><span class="lineNoCov">          0 :         mB[2][0] = mC[15]*mAi[0] + mC[16]*mAi[1] + mC[17]*mAi[3];</span>
<span class="lineNum">    2499 </span><span class="lineNoCov">          0 :         mB[2][1] = mC[15]*mAi[1] + mC[16]*mAi[2] + mC[17]*mAi[4];</span>
<span class="lineNum">    2500 </span><span class="lineNoCov">          0 :         mB[2][2] = mC[15]*mAi[3] + mC[16]*mAi[4] + mC[17]*mAi[5];</span>
<span class="lineNum">    2501 </span>            :         
<span class="lineNum">    2502 </span><span class="lineNoCov">          0 :         Double_t z[3] = { v0[0]-p[0], v0[1]-p[1], v0[2]-p[2] };</span>
<span class="lineNum">    2503 </span>            :         
<span class="lineNum">    2504 </span><span class="lineNoCov">          0 :         vtxMom[id][0] = p[3] + mB[0][0]*z[0] + mB[0][1]*z[1] + mB[0][2]*z[2];</span>
<span class="lineNum">    2505 </span><span class="lineNoCov">          0 :         vtxMom[id][1] = p[4] + mB[1][0]*z[0] + mB[1][1]*z[1] + mB[1][2]*z[2];</span>
<span class="lineNum">    2506 </span><span class="lineNoCov">          0 :         vtxMom[id][2] = p[5] + mB[2][0]*z[0] + mB[2][1]*z[1] + mB[2][2]*z[2];</span>
<span class="lineNum">    2507 </span>            :         
<span class="lineNum">    2508 </span><span class="lineNoCov">          0 :         daughters[id]-&gt;Transport( daughters[id]-&gt;GetDStoPoint(v0), p, mC );</span>
<span class="lineNum">    2509 </span>            :       
<span class="lineNum">    2510 </span><span class="lineNoCov">          0 :       }      </span>
<span class="lineNum">    2511 </span>            :       
<span class="lineNum">    2512 </span>            :     } // fit daughters to guess
<span class="lineNum">    2513 </span>            : 
<span class="lineNum">    2514 </span>            :     
<span class="lineNum">    2515 </span>            :     // fit new vertex
<span class="lineNum">    2516 </span>            :     {
<span class="lineNum">    2517 </span>            :       
<span class="lineNum">    2518 </span><span class="lineNoCov">          0 :       double mpx0 =  vtxMom[0][0]+vtxMom[1][0];</span>
<span class="lineNum">    2519 </span><span class="lineNoCov">          0 :       double mpy0 =  vtxMom[0][1]+vtxMom[1][1];</span>
<span class="lineNum">    2520 </span><span class="lineNoCov">          0 :       double mpt0 = TMath::Sqrt(mpx0*mpx0 + mpy0*mpy0);</span>
<span class="lineNum">    2521 </span>            :       // double a0 = TMath::ATan2(mpy0,mpx0);
<span class="lineNum">    2522 </span>            :       
<span class="lineNum">    2523 </span><span class="lineNoCov">          0 :       double ca0 = mpx0/mpt0;</span>
<span class="lineNum">    2524 </span><span class="lineNoCov">          0 :       double sa0 = mpy0/mpt0;</span>
<span class="lineNum">    2525 </span><span class="lineNoCov">          0 :       double r[3] = { v0[0], v0[1], v0[2] };</span>
<span class="lineNum">    2526 </span><span class="lineNoCov">          0 :       double mC[3][3] = {{1000., 0 ,   0  },</span>
<span class="lineNum">    2527 </span>            :                          {0,  1000.,   0  },
<span class="lineNum">    2528 </span>            :                          {0,     0, 1000. } };
<span class="lineNum">    2529 </span>            :       double chi2=0;
<span class="lineNum">    2530 </span>            :       
<span class="lineNum">    2531 </span><span class="lineNoCov">          0 :       for( int id=0; id&lt;2; id++ ){           </span>
<span class="lineNum">    2532 </span>            :         const Double_t kCLight = 0.000299792458;
<span class="lineNum">    2533 </span><span class="lineNoCov">          0 :         Double_t q = Bz*daughters[id]-&gt;GetQ()*kCLight;</span>
<span class="lineNum">    2534 </span><span class="lineNoCov">          0 :         Double_t px0 = vtxMom[id][0];</span>
<span class="lineNum">    2535 </span><span class="lineNoCov">          0 :         Double_t py0 = vtxMom[id][1];</span>
<span class="lineNum">    2536 </span><span class="lineNoCov">          0 :         Double_t pz0 = vtxMom[id][2];</span>
<span class="lineNum">    2537 </span><span class="lineNoCov">          0 :         Double_t pt0 = TMath::Sqrt(px0*px0+py0*py0);</span>
<span class="lineNum">    2538 </span><span class="lineNoCov">          0 :         Double_t mG[3][6], mB[3], mH[3][3];</span>
<span class="lineNum">    2539 </span>            :         // r = {vx,vy,vz};
<span class="lineNum">    2540 </span>            :         // m = {x,y,z,Px,Py,Pz};
<span class="lineNum">    2541 </span>            :         // V = daughter.C
<span class="lineNum">    2542 </span>            :         // G*m + B = H*r;
<span class="lineNum">    2543 </span>            :         // q*x + Py - q*vx - sin(a)*Pt = 0
<span class="lineNum">    2544 </span>            :         // q*y - Px - q*vy + cos(a)*Pt = 0
<span class="lineNum">    2545 </span>            :         // (Px*cos(a) + Py*sin(a) ) (vz -z) - Pz( cos(a)*(vx-x) + sin(a)*(vy-y)) = 0
<span class="lineNum">    2546 </span>            :         
<span class="lineNum">    2547 </span><span class="lineNoCov">          0 :         mG[0][0] = q;</span>
<span class="lineNum">    2548 </span><span class="lineNoCov">          0 :         mG[0][1] = 0;</span>
<span class="lineNum">    2549 </span><span class="lineNoCov">          0 :         mG[0][2] = 0;</span>
<span class="lineNum">    2550 </span><span class="lineNoCov">          0 :         mG[0][3] =   -sa0*px0/pt0;</span>
<span class="lineNum">    2551 </span><span class="lineNoCov">          0 :         mG[0][4] = 1 -sa0*py0/pt0;</span>
<span class="lineNum">    2552 </span><span class="lineNoCov">          0 :         mG[0][5] = 0;   </span>
<span class="lineNum">    2553 </span><span class="lineNoCov">          0 :         mH[0][0] = q;</span>
<span class="lineNum">    2554 </span><span class="lineNoCov">          0 :         mH[0][1] = 0;</span>
<span class="lineNum">    2555 </span><span class="lineNoCov">          0 :         mH[0][2] = 0;      </span>
<span class="lineNum">    2556 </span><span class="lineNoCov">          0 :         mB[0] = py0 - sa0*pt0 - mG[0][3]*px0 - mG[0][4]*py0 ;</span>
<span class="lineNum">    2557 </span>            :         
<span class="lineNum">    2558 </span>            :         // q*y - Px - q*vy + cos(a)*Pt = 0
<span class="lineNum">    2559 </span>            :         
<span class="lineNum">    2560 </span><span class="lineNoCov">          0 :         mG[1][0] = 0;</span>
<span class="lineNum">    2561 </span><span class="lineNoCov">          0 :         mG[1][1] = q;</span>
<span class="lineNum">    2562 </span><span class="lineNoCov">          0 :         mG[1][2] = 0;</span>
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 :         mG[1][3] = -1 + ca0*px0/pt0;</span>
<span class="lineNum">    2564 </span><span class="lineNoCov">          0 :         mG[1][4] =    + ca0*py0/pt0;</span>
<span class="lineNum">    2565 </span><span class="lineNoCov">          0 :         mG[1][5] = 0;      </span>
<span class="lineNum">    2566 </span><span class="lineNoCov">          0 :         mH[1][0] = 0;</span>
<span class="lineNum">    2567 </span><span class="lineNoCov">          0 :         mH[1][1] = q;</span>
<span class="lineNum">    2568 </span><span class="lineNoCov">          0 :         mH[1][2] = 0;      </span>
<span class="lineNum">    2569 </span><span class="lineNoCov">          0 :         mB[1] = -px0 + ca0*pt0 - mG[1][3]*px0 - mG[1][4]*py0 ;</span>
<span class="lineNum">    2570 </span>            :         
<span class="lineNum">    2571 </span>            :         // (Px*cos(a) + Py*sin(a) ) (z -vz) - Pz( cos(a)*(x-vx) + sin(a)*(y-vy)) = 0
<span class="lineNum">    2572 </span>            :       
<span class="lineNum">    2573 </span><span class="lineNoCov">          0 :         mG[2][0] = -pz0*ca0;</span>
<span class="lineNum">    2574 </span><span class="lineNoCov">          0 :         mG[2][1] = -pz0*sa0;</span>
<span class="lineNum">    2575 </span><span class="lineNoCov">          0 :         mG[2][2] =  px0*ca0 + py0*sa0;</span>
<span class="lineNum">    2576 </span><span class="lineNoCov">          0 :         mG[2][3] = 0;</span>
<span class="lineNum">    2577 </span><span class="lineNoCov">          0 :         mG[2][4] = 0;</span>
<span class="lineNum">    2578 </span><span class="lineNoCov">          0 :         mG[2][5] = 0;</span>
<span class="lineNum">    2579 </span>            :         
<span class="lineNum">    2580 </span><span class="lineNoCov">          0 :         mH[2][0] = mG[2][0];</span>
<span class="lineNum">    2581 </span><span class="lineNoCov">          0 :         mH[2][1] = mG[2][1];</span>
<span class="lineNum">    2582 </span><span class="lineNoCov">          0 :         mH[2][2] = mG[2][2];</span>
<span class="lineNum">    2583 </span>            :         
<span class="lineNum">    2584 </span><span class="lineNoCov">          0 :         mB[2] = 0;</span>
<span class="lineNum">    2585 </span>            :         
<span class="lineNum">    2586 </span>            :         // fit the vertex
<span class="lineNum">    2587 </span>            : 
<span class="lineNum">    2588 </span>            :         // V = GVGt
<span class="lineNum">    2589 </span>            : 
<span class="lineNum">    2590 </span><span class="lineNoCov">          0 :         double mGV[3][6];</span>
<span class="lineNum">    2591 </span><span class="lineNoCov">          0 :         double mV[6];</span>
<span class="lineNum">    2592 </span><span class="lineNoCov">          0 :         double m[3];</span>
<span class="lineNum">    2593 </span><span class="lineNoCov">          0 :         for( int i=0; i&lt;3; i++ ){</span>
<span class="lineNum">    2594 </span><span class="lineNoCov">          0 :           m[i] = mB[i];</span>
<span class="lineNum">    2595 </span><span class="lineNoCov">          0 :           for( int k=0; k&lt;6; k++ ) m[i]+=mG[i][k]*daughterP[id][k];</span>
<span class="lineNum">    2596 </span>            :         }
<span class="lineNum">    2597 </span><span class="lineNoCov">          0 :         for( int i=0; i&lt;3; i++ ){</span>
<span class="lineNum">    2598 </span><span class="lineNoCov">          0 :           for( int j=0; j&lt;6; j++ ){</span>
<span class="lineNum">    2599 </span><span class="lineNoCov">          0 :             mGV[i][j] = 0;</span>
<span class="lineNum">    2600 </span><span class="lineNoCov">          0 :             for( int k=0; k&lt;6; k++ ) mGV[i][j]+=mG[i][k]*daughterC[id][ IJ(k,j) ];</span>
<span class="lineNum">    2601 </span>            :           }
<span class="lineNum">    2602 </span>            :         }
<span class="lineNum">    2603 </span><span class="lineNoCov">          0 :         for( int i=0, k=0; i&lt;3; i++ ){</span>
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 :           for( int j=0; j&lt;=i; j++,k++ ){</span>
<span class="lineNum">    2605 </span><span class="lineNoCov">          0 :             mV[k] = 0;</span>
<span class="lineNum">    2606 </span><span class="lineNoCov">          0 :             for( int l=0; l&lt;6; l++ ) mV[k]+=mGV[i][l]*mG[j][l];</span>
<span class="lineNum">    2607 </span>            :           }
<span class="lineNum">    2608 </span>            :         }
<span class="lineNum">    2609 </span>            :         
<span class="lineNum">    2610 </span>            :       
<span class="lineNum">    2611 </span>            :         //* CHt
<span class="lineNum">    2612 </span>            :         
<span class="lineNum">    2613 </span><span class="lineNoCov">          0 :         Double_t mCHt[3][3];</span>
<span class="lineNum">    2614 </span><span class="lineNoCov">          0 :         Double_t mHCHt[6];</span>
<span class="lineNum">    2615 </span><span class="lineNoCov">          0 :         Double_t mHr[3];</span>
<span class="lineNum">    2616 </span><span class="lineNoCov">          0 :         for( int i=0; i&lt;3; i++ ){      </span>
<span class="lineNum">    2617 </span><span class="lineNoCov">          0 :           mHr[i] = 0;</span>
<span class="lineNum">    2618 </span><span class="lineNoCov">          0 :           for( int k=0; k&lt;3; k++ ) mHr[i]+= mH[i][k]*r[k];</span>
<span class="lineNum">    2619 </span>            :         }
<span class="lineNum">    2620 </span>            :       
<span class="lineNum">    2621 </span><span class="lineNoCov">          0 :         for( int i=0; i&lt;3; i++ ){</span>
<span class="lineNum">    2622 </span><span class="lineNoCov">          0 :           for( int j=0; j&lt;3; j++){</span>
<span class="lineNum">    2623 </span><span class="lineNoCov">          0 :             mCHt[i][j] = 0;</span>
<span class="lineNum">    2624 </span><span class="lineNoCov">          0 :             for( int k=0; k&lt;3; k++ ) mCHt[i][j]+= mC[i][k]*mH[j][k];</span>
<span class="lineNum">    2625 </span>            :           }
<span class="lineNum">    2626 </span>            :         }
<span class="lineNum">    2627 </span>            : 
<span class="lineNum">    2628 </span><span class="lineNoCov">          0 :         for( int i=0, k=0; i&lt;3; i++ ){</span>
<span class="lineNum">    2629 </span><span class="lineNoCov">          0 :           for( int j=0; j&lt;=i; j++, k++ ){</span>
<span class="lineNum">    2630 </span><span class="lineNoCov">          0 :             mHCHt[k] = 0;</span>
<span class="lineNum">    2631 </span><span class="lineNoCov">          0 :             for( int l=0; l&lt;3; l++ ) mHCHt[k]+= mH[i][l]*mCHt[l][j];</span>
<span class="lineNum">    2632 </span>            :           }
<span class="lineNum">    2633 </span>            :         }
<span class="lineNum">    2634 </span>            :       
<span class="lineNum">    2635 </span><span class="lineNoCov">          0 :         Double_t mS[6] = { mHCHt[0]+mV[0], </span>
<span class="lineNum">    2636 </span><span class="lineNoCov">          0 :                            mHCHt[1]+mV[1], mHCHt[2]+mV[2], </span>
<span class="lineNum">    2637 </span><span class="lineNoCov">          0 :                            mHCHt[3]+mV[3], mHCHt[4]+mV[4], mHCHt[5]+mV[5]    }; </span>
<span class="lineNum">    2638 </span>            :       
<span class="lineNum">    2639 </span>            : 
<span class="lineNum">    2640 </span><span class="lineNoCov">          0 :         InvertSym3(mS,mS);</span>
<span class="lineNum">    2641 </span>            :         
<span class="lineNum">    2642 </span>            :         //* Residual (measured - estimated)
<span class="lineNum">    2643 </span>            :     
<span class="lineNum">    2644 </span><span class="lineNoCov">          0 :         Double_t zeta[3] = { m[0]-mHr[0], m[1]-mHr[1], m[2]-mHr[2] };</span>
<span class="lineNum">    2645 </span>            :             
<span class="lineNum">    2646 </span>            :         //* Kalman gain K = mCH'*S
<span class="lineNum">    2647 </span>            :     
<span class="lineNum">    2648 </span><span class="lineNoCov">          0 :         Double_t k[3][3];</span>
<span class="lineNum">    2649 </span>            :       
<span class="lineNum">    2650 </span><span class="lineNoCov">          0 :         for(Int_t i=0;i&lt;3;++i){</span>
<span class="lineNum">    2651 </span><span class="lineNoCov">          0 :           k[i][0] = mCHt[i][0]*mS[0] + mCHt[i][1]*mS[1] + mCHt[i][2]*mS[3];</span>
<span class="lineNum">    2652 </span><span class="lineNoCov">          0 :           k[i][1] = mCHt[i][0]*mS[1] + mCHt[i][1]*mS[2] + mCHt[i][2]*mS[4];</span>
<span class="lineNum">    2653 </span><span class="lineNoCov">          0 :           k[i][2] = mCHt[i][0]*mS[3] + mCHt[i][1]*mS[4] + mCHt[i][2]*mS[5];</span>
<span class="lineNum">    2654 </span>            :         }
<span class="lineNum">    2655 </span>            : 
<span class="lineNum">    2656 </span>            :         //* New estimation of the vertex position r += K*zeta
<span class="lineNum">    2657 </span>            :     
<span class="lineNum">    2658 </span><span class="lineNoCov">          0 :         for(Int_t i=0;i&lt;3;++i) </span>
<span class="lineNum">    2659 </span><span class="lineNoCov">          0 :           r[i] = r[i] + k[i][0]*zeta[0] + k[i][1]*zeta[1] + k[i][2]*zeta[2];</span>
<span class="lineNum">    2660 </span>            :       
<span class="lineNum">    2661 </span>            :         //* New covariance matrix C -= K*(mCH')'
<span class="lineNum">    2662 </span>            : 
<span class="lineNum">    2663 </span><span class="lineNoCov">          0 :         for(Int_t i=0;i&lt;3;++i){</span>
<span class="lineNum">    2664 </span><span class="lineNoCov">          0 :           for(Int_t j=0;j&lt;=i;++j){</span>
<span class="lineNum">    2665 </span><span class="lineNoCov">          0 :             mC[i][j] = mC[i][j] - (k[i][0]*mCHt[j][0] + k[i][1]*mCHt[j][1] + k[i][2]*mCHt[j][2]);</span>
<span class="lineNum">    2666 </span><span class="lineNoCov">          0 :             mC[j][i] = mC[i][j];</span>
<span class="lineNum">    2667 </span>            :           }
<span class="lineNum">    2668 </span>            :         }
<span class="lineNum">    2669 </span>            : 
<span class="lineNum">    2670 </span>            :         //* Calculate Chi^2 
<span class="lineNum">    2671 </span>            :         
<span class="lineNum">    2672 </span><span class="lineNoCov">          0 :         chi2 += ( ( mS[0]*zeta[0] + mS[1]*zeta[1] + mS[3]*zeta[2] )*zeta[0]</span>
<span class="lineNum">    2673 </span><span class="lineNoCov">          0 :                   +(mS[1]*zeta[0] + mS[2]*zeta[1] + mS[4]*zeta[2] )*zeta[1]</span>
<span class="lineNum">    2674 </span><span class="lineNoCov">          0 :                   +(mS[3]*zeta[0] + mS[4]*zeta[1] + mS[5]*zeta[2] )*zeta[2]  );  </span>
<span class="lineNum">    2675 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    2676 </span>            :     
<span class="lineNum">    2677 </span>            :       // store vertex
<span class="lineNum">    2678 </span>            :     
<span class="lineNum">    2679 </span><span class="lineNoCov">          0 :       fNDF  = 2;</span>
<span class="lineNum">    2680 </span><span class="lineNoCov">          0 :       fChi2 = chi2;</span>
<span class="lineNum">    2681 </span><span class="lineNoCov">          0 :       for( int i=0; i&lt;3; i++ ) fP[i] = r[i];</span>
<span class="lineNum">    2682 </span><span class="lineNoCov">          0 :       for( int i=0,k=0; i&lt;3; i++ ){</span>
<span class="lineNum">    2683 </span><span class="lineNoCov">          0 :         for( int j=0; j&lt;=i; j++,k++ ){</span>
<span class="lineNum">    2684 </span><span class="lineNoCov">          0 :           fC[k] = mC[i][j];</span>
<span class="lineNum">    2685 </span>            :         }
<span class="lineNum">    2686 </span>            :       }
<span class="lineNum">    2687 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2688 </span>            : 
<span class="lineNum">    2689 </span>            :   } // iterations
<span class="lineNum">    2690 </span>            : 
<span class="lineNum">    2691 </span>            :   // now fit daughters to the vertex
<span class="lineNum">    2692 </span>            :   
<span class="lineNum">    2693 </span><span class="lineNoCov">          0 :   fQ     =  0;</span>
<span class="lineNum">    2694 </span><span class="lineNoCov">          0 :   fSFromDecay = 0;    </span>
<span class="lineNum">    2695 </span>            : 
<span class="lineNum">    2696 </span><span class="lineNoCov">          0 :   for(Int_t i=3;i&lt;8;++i) fP[i]=0.;</span>
<span class="lineNum">    2697 </span><span class="lineNoCov">          0 :   for(Int_t i=6;i&lt;35;++i) fC[i]=0.;</span>
<span class="lineNum">    2698 </span><span class="lineNoCov">          0 :   fC[35] = 100.;</span>
<span class="lineNum">    2699 </span>            : 
<span class="lineNum">    2700 </span><span class="lineNoCov">          0 :   for( int id=0; id&lt;2; id++ ){</span>
<span class="lineNum">    2701 </span>            : 
<span class="lineNum">    2702 </span><span class="lineNoCov">          0 :     double *p = daughterP[id];</span>
<span class="lineNum">    2703 </span><span class="lineNoCov">          0 :     double *mC = daughterC[id];      </span>
<span class="lineNum">    2704 </span><span class="lineNoCov">          0 :     daughters[id]-&gt;GetMeasurement( v0, p, mC );</span>
<span class="lineNum">    2705 </span>            : 
<span class="lineNum">    2706 </span><span class="lineNoCov">          0 :     const Double_t *m = fP, *mV = fC;</span>
<span class="lineNum">    2707 </span>            :     
<span class="lineNum">    2708 </span><span class="lineNoCov">          0 :     Double_t mAi[6];</span>
<span class="lineNum">    2709 </span><span class="lineNoCov">          0 :     InvertSym3(mC, mAi );</span>
<span class="lineNum">    2710 </span>            : 
<span class="lineNum">    2711 </span>            :     Double_t mB[4][3];
<span class="lineNum">    2712 </span>            : 
<span class="lineNum">    2713 </span><span class="lineNoCov">          0 :     mB[0][0] = mC[ 6]*mAi[0] + mC[ 7]*mAi[1] + mC[ 8]*mAi[3];</span>
<span class="lineNum">    2714 </span><span class="lineNoCov">          0 :     mB[0][1] = mC[ 6]*mAi[1] + mC[ 7]*mAi[2] + mC[ 8]*mAi[4];</span>
<span class="lineNum">    2715 </span><span class="lineNoCov">          0 :     mB[0][2] = mC[ 6]*mAi[3] + mC[ 7]*mAi[4] + mC[ 8]*mAi[5];</span>
<span class="lineNum">    2716 </span>            :     
<span class="lineNum">    2717 </span><span class="lineNoCov">          0 :     mB[1][0] = mC[10]*mAi[0] + mC[11]*mAi[1] + mC[12]*mAi[3];</span>
<span class="lineNum">    2718 </span><span class="lineNoCov">          0 :     mB[1][1] = mC[10]*mAi[1] + mC[11]*mAi[2] + mC[12]*mAi[4];</span>
<span class="lineNum">    2719 </span><span class="lineNoCov">          0 :     mB[1][2] = mC[10]*mAi[3] + mC[11]*mAi[4] + mC[12]*mAi[5];</span>
<span class="lineNum">    2720 </span>            :     
<span class="lineNum">    2721 </span><span class="lineNoCov">          0 :     mB[2][0] = mC[15]*mAi[0] + mC[16]*mAi[1] + mC[17]*mAi[3];</span>
<span class="lineNum">    2722 </span><span class="lineNoCov">          0 :     mB[2][1] = mC[15]*mAi[1] + mC[16]*mAi[2] + mC[17]*mAi[4];</span>
<span class="lineNum">    2723 </span><span class="lineNoCov">          0 :     mB[2][2] = mC[15]*mAi[3] + mC[16]*mAi[4] + mC[17]*mAi[5];</span>
<span class="lineNum">    2724 </span>            :     
<span class="lineNum">    2725 </span><span class="lineNoCov">          0 :     mB[3][0] = mC[21]*mAi[0] + mC[22]*mAi[1] + mC[23]*mAi[3];</span>
<span class="lineNum">    2726 </span><span class="lineNoCov">          0 :     mB[3][1] = mC[21]*mAi[1] + mC[22]*mAi[2] + mC[23]*mAi[4];</span>
<span class="lineNum">    2727 </span><span class="lineNoCov">          0 :     mB[3][2] = mC[21]*mAi[3] + mC[22]*mAi[4] + mC[23]*mAi[5];    </span>
<span class="lineNum">    2728 </span>            : 
<span class="lineNum">    2729 </span>            : 
<span class="lineNum">    2730 </span><span class="lineNoCov">          0 :     Double_t z[3] = { m[0]-p[0], m[1]-p[1], m[2]-p[2] };</span>
<span class="lineNum">    2731 </span>            : 
<span class="lineNum">    2732 </span>            : //     {
<span class="lineNum">    2733 </span>            : //       Double_t mAV[6] = { mC[0]-mV[0], mC[1]-mV[1], mC[2]-mV[2], 
<span class="lineNum">    2734 </span>            : //                        mC[3]-mV[3], mC[4]-mV[4], mC[5]-mV[5] };
<span class="lineNum">    2735 </span>            : //       
<span class="lineNum">    2736 </span>            : //       Double_t mAVi[6];
<span class="lineNum">    2737 </span>            : //       if( !InvertSym3(mAV, mAVi) ){
<span class="lineNum">    2738 </span>            : //      Double_t dChi2 = ( +(mAVi[0]*z[0] + mAVi[1]*z[1] + mAVi[3]*z[2])*z[0]
<span class="lineNum">    2739 </span>            : //                         +(mAVi[1]*z[0] + mAVi[2]*z[1] + mAVi[4]*z[2])*z[1]
<span class="lineNum">    2740 </span>            : //                         +(mAVi[3]*z[0] + mAVi[4]*z[1] + mAVi[5]*z[2])*z[2] );
<span class="lineNum">    2741 </span>            : //      fChi2+= TMath::Abs( dChi2 );
<span class="lineNum">    2742 </span>            : //       }
<span class="lineNum">    2743 </span>            : //       fNDF  += 2;
<span class="lineNum">    2744 </span>            : //     }
<span class="lineNum">    2745 </span>            : 
<span class="lineNum">    2746 </span>            :     //* Add the daughter momentum to the particle momentum
<span class="lineNum">    2747 </span>            :  
<span class="lineNum">    2748 </span><span class="lineNoCov">          0 :     fP[3]+= p[3] + mB[0][0]*z[0] + mB[0][1]*z[1] + mB[0][2]*z[2];</span>
<span class="lineNum">    2749 </span><span class="lineNoCov">          0 :     fP[4]+= p[4] + mB[1][0]*z[0] + mB[1][1]*z[1] + mB[1][2]*z[2];</span>
<span class="lineNum">    2750 </span><span class="lineNoCov">          0 :     fP[5]+= p[5] + mB[2][0]*z[0] + mB[2][1]*z[1] + mB[2][2]*z[2];</span>
<span class="lineNum">    2751 </span><span class="lineNoCov">          0 :     fP[6]+= p[6] + mB[3][0]*z[0] + mB[3][1]*z[1] + mB[3][2]*z[2];</span>
<span class="lineNum">    2752 </span>            :   
<span class="lineNum">    2753 </span>            :     Double_t d0, d1, d2;
<span class="lineNum">    2754 </span>            :    
<span class="lineNum">    2755 </span><span class="lineNoCov">          0 :     d0= mB[0][0]*mV[0] + mB[0][1]*mV[1] + mB[0][2]*mV[3] - mC[ 6];</span>
<span class="lineNum">    2756 </span><span class="lineNoCov">          0 :     d1= mB[0][0]*mV[1] + mB[0][1]*mV[2] + mB[0][2]*mV[4] - mC[ 7];</span>
<span class="lineNum">    2757 </span><span class="lineNoCov">          0 :     d2= mB[0][0]*mV[3] + mB[0][1]*mV[4] + mB[0][2]*mV[5] - mC[ 8];</span>
<span class="lineNum">    2758 </span>            : 
<span class="lineNum">    2759 </span>            :     //fC[6]+= mC[ 6] + d0;
<span class="lineNum">    2760 </span>            :     //fC[7]+= mC[ 7] + d1;
<span class="lineNum">    2761 </span>            :     //fC[8]+= mC[ 8] + d2;
<span class="lineNum">    2762 </span><span class="lineNoCov">          0 :     fC[9]+= mC[ 9] + d0*mB[0][0] + d1*mB[0][1] + d2*mB[0][2];</span>
<span class="lineNum">    2763 </span>            : 
<span class="lineNum">    2764 </span><span class="lineNoCov">          0 :     d0= mB[1][0]*mV[0] + mB[1][1]*mV[1] + mB[1][2]*mV[3] - mC[10];</span>
<span class="lineNum">    2765 </span><span class="lineNoCov">          0 :     d1= mB[1][0]*mV[1] + mB[1][1]*mV[2] + mB[1][2]*mV[4] - mC[11];</span>
<span class="lineNum">    2766 </span><span class="lineNoCov">          0 :     d2= mB[1][0]*mV[3] + mB[1][1]*mV[4] + mB[1][2]*mV[5] - mC[12];</span>
<span class="lineNum">    2767 </span>            : 
<span class="lineNum">    2768 </span>            :     //fC[10]+= mC[10]+ d0;
<span class="lineNum">    2769 </span>            :     //fC[11]+= mC[11]+ d1;
<span class="lineNum">    2770 </span>            :     //fC[12]+= mC[12]+ d2;
<span class="lineNum">    2771 </span><span class="lineNoCov">          0 :     fC[13]+= mC[13]+ d0*mB[0][0] + d1*mB[0][1] + d2*mB[0][2];</span>
<span class="lineNum">    2772 </span><span class="lineNoCov">          0 :     fC[14]+= mC[14]+ d0*mB[1][0] + d1*mB[1][1] + d2*mB[1][2];</span>
<span class="lineNum">    2773 </span>            : 
<span class="lineNum">    2774 </span><span class="lineNoCov">          0 :     d0= mB[2][0]*mV[0] + mB[2][1]*mV[1] + mB[2][2]*mV[3] - mC[15];</span>
<span class="lineNum">    2775 </span><span class="lineNoCov">          0 :     d1= mB[2][0]*mV[1] + mB[2][1]*mV[2] + mB[2][2]*mV[4] - mC[16];</span>
<span class="lineNum">    2776 </span><span class="lineNoCov">          0 :     d2= mB[2][0]*mV[3] + mB[2][1]*mV[4] + mB[2][2]*mV[5] - mC[17];</span>
<span class="lineNum">    2777 </span>            : 
<span class="lineNum">    2778 </span>            :     //fC[15]+= mC[15]+ d0;
<span class="lineNum">    2779 </span>            :     //fC[16]+= mC[16]+ d1;
<span class="lineNum">    2780 </span>            :     //fC[17]+= mC[17]+ d2;
<span class="lineNum">    2781 </span><span class="lineNoCov">          0 :     fC[18]+= mC[18]+ d0*mB[0][0] + d1*mB[0][1] + d2*mB[0][2];</span>
<span class="lineNum">    2782 </span><span class="lineNoCov">          0 :     fC[19]+= mC[19]+ d0*mB[1][0] + d1*mB[1][1] + d2*mB[1][2];</span>
<span class="lineNum">    2783 </span><span class="lineNoCov">          0 :     fC[20]+= mC[20]+ d0*mB[2][0] + d1*mB[2][1] + d2*mB[2][2];</span>
<span class="lineNum">    2784 </span>            : 
<span class="lineNum">    2785 </span><span class="lineNoCov">          0 :     d0= mB[3][0]*mV[0] + mB[3][1]*mV[1] + mB[3][2]*mV[3] - mC[21];</span>
<span class="lineNum">    2786 </span><span class="lineNoCov">          0 :     d1= mB[3][0]*mV[1] + mB[3][1]*mV[2] + mB[3][2]*mV[4] - mC[22];</span>
<span class="lineNum">    2787 </span><span class="lineNoCov">          0 :     d2= mB[3][0]*mV[3] + mB[3][1]*mV[4] + mB[3][2]*mV[5] - mC[23];</span>
<span class="lineNum">    2788 </span>            : 
<span class="lineNum">    2789 </span>            :     //fC[21]+= mC[21] + d0;
<span class="lineNum">    2790 </span>            :     //fC[22]+= mC[22] + d1;
<span class="lineNum">    2791 </span>            :     //fC[23]+= mC[23] + d2;
<span class="lineNum">    2792 </span><span class="lineNoCov">          0 :     fC[24]+= mC[24] + d0*mB[0][0] + d1*mB[0][1] + d2*mB[0][2];</span>
<span class="lineNum">    2793 </span><span class="lineNoCov">          0 :     fC[25]+= mC[25] + d0*mB[1][0] + d1*mB[1][1] + d2*mB[1][2];</span>
<span class="lineNum">    2794 </span><span class="lineNoCov">          0 :     fC[26]+= mC[26] + d0*mB[2][0] + d1*mB[2][1] + d2*mB[2][2];</span>
<span class="lineNum">    2795 </span><span class="lineNoCov">          0 :     fC[27]+= mC[27] + d0*mB[3][0] + d1*mB[3][1] + d2*mB[3][2];</span>
<span class="lineNum">    2796 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2797 </span>            : 
<span class="lineNum">    2798 </span>            : //  SetMassConstraint(0,0);
<span class="lineNum">    2799 </span><span class="lineNoCov">          0 :   SetNonlinearMassConstraint(0);</span>
<a name="2800"><span class="lineNum">    2800 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2801 </span>            : 
<span class="lineNum">    2802 </span>            : void AliKFParticleBase::GetArmenterosPodolanski(AliKFParticleBase&amp; positive, AliKFParticleBase&amp; negative, Double_t QtAlfa[2] )
<span class="lineNum">    2803 </span>            : {
<span class="lineNum">    2804 </span>            : // example:
<span class="lineNum">    2805 </span>            : //       AliKFParticle PosParticle(...)
<span class="lineNum">    2806 </span>            : //       AliKFParticle NegParticle(...)
<span class="lineNum">    2807 </span>            : //       Gamma.ConstructGamma(PosParticle, NegParticle);
<span class="lineNum">    2808 </span>            : //       Double_t VertexGamma[3] = {Gamma.GetX(), Gamma.GetY(), Gamma.GetZ()};
<span class="lineNum">    2809 </span>            : //       PosParticle.TransportToPoint(VertexGamma);
<span class="lineNum">    2810 </span>            : //       NegParticle.TransportToPoint(VertexGamma);
<span class="lineNum">    2811 </span>            : //       Double_t armenterosQtAlfa[2] = {0.};
<span class="lineNum">    2812 </span>            : //       AliKFParticle::GetArmenterosPodolanski(PosParticle, NegParticle, armenterosQtAlfa );
<span class="lineNum">    2813 </span>            : 
<span class="lineNum">    2814 </span>            :   Double_t alpha = 0., qt = 0.;
<span class="lineNum">    2815 </span><span class="lineNoCov">          0 :   Double_t spx = positive.GetPx() + negative.GetPx();</span>
<span class="lineNum">    2816 </span><span class="lineNoCov">          0 :   Double_t spy = positive.GetPy() + negative.GetPy();</span>
<span class="lineNum">    2817 </span><span class="lineNoCov">          0 :   Double_t spz = positive.GetPz() + negative.GetPz();</span>
<span class="lineNum">    2818 </span><span class="lineNoCov">          0 :   Double_t sp  = sqrt(spx*spx + spy*spy + spz*spz);</span>
<span class="lineNum">    2819 </span><span class="lineNoCov">          0 :   if( sp == 0.0) return;</span>
<span class="lineNum">    2820 </span>            :   Double_t pn, pln, plp; // ,pp;
<span class="lineNum">    2821 </span>            : 
<span class="lineNum">    2822 </span><span class="lineNoCov">          0 :   pn = TMath::Sqrt(negative.GetPx()*negative.GetPx() + negative.GetPy()*negative.GetPy() + negative.GetPz()*negative.GetPz());</span>
<span class="lineNum">    2823 </span>            :   //  pp = TMath::Sqrt(positive.GetPx()*positive.GetPx() + positive.GetPy()*positive.GetPy() + positive.GetPz()*positive.GetPz());
<span class="lineNum">    2824 </span><span class="lineNoCov">          0 :   pln  = (negative.GetPx()*spx+negative.GetPy()*spy+negative.GetPz()*spz)/sp;</span>
<span class="lineNum">    2825 </span><span class="lineNoCov">          0 :   plp  = (positive.GetPx()*spx+positive.GetPy()*spy+positive.GetPz()*spz)/sp;</span>
<span class="lineNum">    2826 </span>            : 
<span class="lineNum">    2827 </span><span class="lineNoCov">          0 :   if( pn == 0.0) return;</span>
<span class="lineNum">    2828 </span><span class="lineNoCov">          0 :   Double_t ptm  = (1.-((pln/pn)*(pln/pn)));</span>
<span class="lineNum">    2829 </span><span class="lineNoCov">          0 :   qt= (ptm&gt;=0.)?  pn*sqrt(ptm) :0;</span>
<span class="lineNum">    2830 </span><span class="lineNoCov">          0 :   alpha = (plp-pln)/(plp+pln);</span>
<span class="lineNum">    2831 </span>            : 
<span class="lineNum">    2832 </span><span class="lineNoCov">          0 :   QtAlfa[0] = qt;</span>
<span class="lineNum">    2833 </span><span class="lineNoCov">          0 :   QtAlfa[1] = alpha;</span>
<a name="2834"><span class="lineNum">    2834 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2835 </span>            : 
<span class="lineNum">    2836 </span>            : void AliKFParticleBase::RotateXY(Double_t angle, Double_t Vtx[3])
<span class="lineNum">    2837 </span>            : {
<span class="lineNum">    2838 </span>            :   // Rotates the KFParticle object around OZ axis, OZ axis is set by the vertex position
<span class="lineNum">    2839 </span>            :   // Double_t angle - angle of rotation in XY plane in [rad]
<span class="lineNum">    2840 </span>            :   // Double_t Vtx[3] - position of the vertex in [cm]
<span class="lineNum">    2841 </span>            : 
<span class="lineNum">    2842 </span>            :   // Before rotation the center of the coordinat system should be moved to the vertex position; move back after rotation
<span class="lineNum">    2843 </span><span class="lineNoCov">          0 :   X() = X() - Vtx[0];</span>
<span class="lineNum">    2844 </span><span class="lineNoCov">          0 :   Y() = Y() - Vtx[1];</span>
<span class="lineNum">    2845 </span><span class="lineNoCov">          0 :   Z() = Z() - Vtx[2];</span>
<span class="lineNum">    2846 </span>            : 
<span class="lineNum">    2847 </span>            :   // Rotate the kf particle
<span class="lineNum">    2848 </span><span class="lineNoCov">          0 :   Double_t c = TMath::Cos(angle);</span>
<span class="lineNum">    2849 </span><span class="lineNoCov">          0 :   Double_t s = TMath::Sin(angle);</span>
<span class="lineNum">    2850 </span>            : 
<span class="lineNum">    2851 </span><span class="lineNoCov">          0 :   Double_t mA[8][ 8];</span>
<span class="lineNum">    2852 </span><span class="lineNoCov">          0 :   for( Int_t i=0; i&lt;8; i++ ){</span>
<span class="lineNum">    2853 </span><span class="lineNoCov">          0 :     for( Int_t j=0; j&lt;8; j++){</span>
<span class="lineNum">    2854 </span><span class="lineNoCov">          0 :       mA[i][j] = 0;</span>
<span class="lineNum">    2855 </span>            :     }
<span class="lineNum">    2856 </span>            :   }
<span class="lineNum">    2857 </span><span class="lineNoCov">          0 :   for( int i=0; i&lt;8; i++ ){</span>
<span class="lineNum">    2858 </span><span class="lineNoCov">          0 :     mA[i][i] = 1;</span>
<span class="lineNum">    2859 </span>            :   }
<span class="lineNum">    2860 </span><span class="lineNoCov">          0 :   mA[0][0] =  c;  mA[0][1] = s;</span>
<span class="lineNum">    2861 </span><span class="lineNoCov">          0 :   mA[1][0] = -s;  mA[1][1] = c;</span>
<span class="lineNum">    2862 </span><span class="lineNoCov">          0 :   mA[3][3] =  c;  mA[3][4] = s;</span>
<span class="lineNum">    2863 </span><span class="lineNoCov">          0 :   mA[4][3] = -s;  mA[4][4] = c;</span>
<span class="lineNum">    2864 </span>            : 
<span class="lineNum">    2865 </span><span class="lineNoCov">          0 :   Double_t mAC[8][8];</span>
<span class="lineNum">    2866 </span><span class="lineNoCov">          0 :   Double_t mAp[8];</span>
<span class="lineNum">    2867 </span>            : 
<span class="lineNum">    2868 </span><span class="lineNoCov">          0 :   for( Int_t i=0; i&lt;8; i++ ){</span>
<span class="lineNum">    2869 </span><span class="lineNoCov">          0 :     mAp[i] = 0;</span>
<span class="lineNum">    2870 </span><span class="lineNoCov">          0 :     for( Int_t k=0; k&lt;8; k++){</span>
<span class="lineNum">    2871 </span><span class="lineNoCov">          0 :       mAp[i]+=mA[i][k] * fP[k];</span>
<span class="lineNum">    2872 </span>            :     }
<span class="lineNum">    2873 </span>            :   }
<span class="lineNum">    2874 </span>            : 
<span class="lineNum">    2875 </span><span class="lineNoCov">          0 :   for( Int_t i=0; i&lt;8; i++){</span>
<span class="lineNum">    2876 </span><span class="lineNoCov">          0 :     fP[i] = mAp[i];</span>
<span class="lineNum">    2877 </span>            :   }
<span class="lineNum">    2878 </span>            : 
<span class="lineNum">    2879 </span><span class="lineNoCov">          0 :   for( Int_t i=0; i&lt;8; i++ ){</span>
<span class="lineNum">    2880 </span><span class="lineNoCov">          0 :     for( Int_t j=0; j&lt;8; j++ ){</span>
<span class="lineNum">    2881 </span><span class="lineNoCov">          0 :       mAC[i][j] = 0;</span>
<span class="lineNum">    2882 </span><span class="lineNoCov">          0 :       for( Int_t k=0; k&lt;8; k++ ){</span>
<span class="lineNum">    2883 </span><span class="lineNoCov">          0 :         mAC[i][j]+= mA[i][k] * GetCovariance(k,j);</span>
<span class="lineNum">    2884 </span>            :       }
<span class="lineNum">    2885 </span>            :     }
<span class="lineNum">    2886 </span>            :   }
<span class="lineNum">    2887 </span>            : 
<span class="lineNum">    2888 </span><span class="lineNoCov">          0 :   for( Int_t i=0; i&lt;8; i++ ){</span>
<span class="lineNum">    2889 </span><span class="lineNoCov">          0 :     for( Int_t j=0; j&lt;=i; j++ ){</span>
<span class="lineNum">    2890 </span>            :       Double_t xx = 0;
<span class="lineNum">    2891 </span><span class="lineNoCov">          0 :       for( Int_t k=0; k&lt;8; k++){</span>
<span class="lineNum">    2892 </span><span class="lineNoCov">          0 :         xx+= mAC[i][k]*mA[j][k];</span>
<span class="lineNum">    2893 </span>            :       }
<span class="lineNum">    2894 </span><span class="lineNoCov">          0 :       Covariance(i,j) = xx;</span>
<span class="lineNum">    2895 </span>            :     }
<span class="lineNum">    2896 </span>            :   }
<span class="lineNum">    2897 </span>            : 
<span class="lineNum">    2898 </span><span class="lineNoCov">          0 :   X() = GetX() + Vtx[0];</span>
<span class="lineNum">    2899 </span><span class="lineNoCov">          0 :   Y() = GetY() + Vtx[1];</span>
<span class="lineNum">    2900 </span><span class="lineNoCov">          0 :   Z() = GetZ() + Vtx[2];</span>
<a name="2901"><span class="lineNum">    2901 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2902 </span>            : 
<span class="lineNum">    2903 </span>            : Bool_t AliKFParticleBase::InvertSym3( const Double_t A[], Double_t Ai[] )
<span class="lineNum">    2904 </span>            : {
<span class="lineNum">    2905 </span>            :   //* Invert symmetric matric stored in low-triagonal form 
<span class="lineNum">    2906 </span>            : 
<span class="lineNum">    2907 </span>            :   bool ret = 0;
<span class="lineNum">    2908 </span><span class="lineCov">        296 :   double a0 = A[0], a1 = A[1], a2 = A[2], a3 = A[3];</span>
<span class="lineNum">    2909 </span>            : 
<span class="lineNum">    2910 </span><span class="lineCov">        148 :   Ai[0] = a2*A[5] - A[4]*A[4];</span>
<span class="lineNum">    2911 </span><span class="lineCov">        148 :   Ai[1] = a3*A[4] - a1*A[5];</span>
<span class="lineNum">    2912 </span><span class="lineCov">        148 :   Ai[3] = a1*A[4] - a2*a3;</span>
<span class="lineNum">    2913 </span><span class="lineCov">        148 :   Double_t det = (a0*Ai[0] + a1*Ai[1] + a3*Ai[3]);</span>
<span class="lineNum">    2914 </span><span class="lineCov">        296 :   if( TMath::Abs(det)&gt;1.e-20 ) det = 1./det;    </span>
<span class="lineNum">    2915 </span>            :   else{ 
<span class="lineNum">    2916 </span>            :     det = 0;
<span class="lineNum">    2917 </span>            :     ret = 1;
<span class="lineNum">    2918 </span>            :   }
<span class="lineNum">    2919 </span><span class="lineCov">        148 :   Ai[0] *= det;</span>
<span class="lineNum">    2920 </span><span class="lineCov">        148 :   Ai[1] *= det;</span>
<span class="lineNum">    2921 </span><span class="lineCov">        148 :   Ai[3] *= det;</span>
<span class="lineNum">    2922 </span><span class="lineCov">        148 :   Ai[2] = ( a0*A[5] - a3*a3 )*det;</span>
<span class="lineNum">    2923 </span><span class="lineCov">        148 :   Ai[4] = ( a1*a3 - a0*A[4] )*det;</span>
<span class="lineNum">    2924 </span><span class="lineCov">        148 :   Ai[5] = ( a0*a2 - a1*a1 )*det;</span>
<span class="lineNum">    2925 </span><span class="lineCov">        148 :   return ret;</span>
<a name="2926"><span class="lineNum">    2926 </span>            : }</a>
<span class="lineNum">    2927 </span>            : 
<span class="lineNum">    2928 </span>            : void AliKFParticleBase::MultQSQt( const Double_t Q[], const Double_t S[], Double_t SOut[] )
<span class="lineNum">    2929 </span>            : {
<span class="lineNum">    2930 </span>            :   //* Matrix multiplication Q*S*Q^T, Q - square matrix, S - symmetric
<span class="lineNum">    2931 </span>            : 
<span class="lineNum">    2932 </span>            :   const Int_t kN= 8;
<span class="lineNum">    2933 </span><span class="lineNoCov">          0 :   Double_t mA[kN*kN];</span>
<span class="lineNum">    2934 </span>            :   
<span class="lineNum">    2935 </span><span class="lineNoCov">          0 :   for( Int_t i=0, ij=0; i&lt;kN; i++ ){</span>
<span class="lineNum">    2936 </span><span class="lineNoCov">          0 :     for( Int_t j=0; j&lt;kN; j++, ++ij ){</span>
<span class="lineNum">    2937 </span><span class="lineNoCov">          0 :       mA[ij] = 0 ;</span>
<span class="lineNum">    2938 </span><span class="lineNoCov">          0 :       for( Int_t k=0; k&lt;kN; ++k ) mA[ij]+= S[( k&lt;=i ) ? i*(i+1)/2+k :k*(k+1)/2+i] * Q[ j*kN+k];</span>
<span class="lineNum">    2939 </span>            :     }
<span class="lineNum">    2940 </span>            :   }
<span class="lineNum">    2941 </span>            :     
<span class="lineNum">    2942 </span><span class="lineNoCov">          0 :   for( Int_t i=0; i&lt;kN; i++ ){</span>
<span class="lineNum">    2943 </span><span class="lineNoCov">          0 :     for( Int_t j=0; j&lt;=i; j++ ){</span>
<span class="lineNum">    2944 </span><span class="lineNoCov">          0 :       Int_t ij = ( j&lt;=i ) ? i*(i+1)/2+j :j*(j+1)/2+i;</span>
<span class="lineNum">    2945 </span><span class="lineNoCov">          0 :       SOut[ij] = 0 ;</span>
<span class="lineNum">    2946 </span><span class="lineNoCov">          0 :       for( Int_t k=0; k&lt;kN; k++ )  SOut[ij] += Q[ i*kN+k ] * mA[ k*kN+j ];</span>
<span class="lineNum">    2947 </span>            :     }
<span class="lineNum">    2948 </span>            :   }
<span class="lineNum">    2949 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2950 </span>            : 
<span class="lineNum">    2951 </span>            : 
<span class="lineNum">    2952 </span>            : // 72-charachters line to define the printer border
<span class="lineNum">    2953 </span>            : //3456789012345678901234567890123456789012345678901234567890123456789012
<span class="lineNum">    2954 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
