<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - STEER/STEERBase/AliTRDPIDResponse.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">STEER/STEERBase</a> - AliTRDPIDResponse.cxx<span style="font-size: 80%;"> (source / <a href="AliTRDPIDResponse.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">58</td>
            <td class="headerCovTableEntry">266</td>
            <td class="headerCovTableEntryLo">21.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">9</td>
            <td class="headerCovTableEntry">25</td>
            <td class="headerCovTableEntryLo">36.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            : * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            : *                                                                        *
<span class="lineNum">       4 </span>            : * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            : * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            : *                                                                        *
<span class="lineNum">       7 </span>            : * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            : * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            : * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            : * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            : * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            : * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            : * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            : **************************************************************************/
<span class="lineNum">      15 </span>            : //
<span class="lineNum">      16 </span>            : // PID Response class for the TRD detector
<span class="lineNum">      17 </span>            : // Based on 1D Likelihood approach
<span class="lineNum">      18 </span>            : // Calculation of probabilities using Bayesian approach
<span class="lineNum">      19 </span>            : // Attention: This method is only used to separate electrons from pions
<span class="lineNum">      20 </span>            : //
<span class="lineNum">      21 </span>            : // Authors:
<span class="lineNum">      22 </span>            : //  Markus Fasel &lt;M.Fasel@gsi.de&gt;
<span class="lineNum">      23 </span>            : //  Anton Andronic &lt;A.Andronic@gsi.de&gt;
<span class="lineNum">      24 </span>            : //
<span class="lineNum">      25 </span>            : //  modifications 29.10. Yvonne Pachmayer &lt;pachmay@physi.uni-heidelberg.de&gt;
<span class="lineNum">      26 </span>            : //
<span class="lineNum">      27 </span>            : #include &lt;TAxis.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;TClass.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;TDirectory.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;TFile.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;TH1.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;TH2.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;TKey.h&gt;
<span class="lineNum">      34 </span>            : #include &lt;TMath.h&gt;
<span class="lineNum">      35 </span>            : #include &lt;TObjArray.h&gt;
<span class="lineNum">      36 </span>            : #include &lt;TROOT.h&gt; 
<span class="lineNum">      37 </span>            : #include &lt;TString.h&gt;
<span class="lineNum">      38 </span>            : #include &lt;TSystem.h&gt;
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      41 </span>            :  
<span class="lineNum">      42 </span>            : #include &quot;AliVTrack.h&quot;
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : #include &quot;AliTRDPIDResponseObject.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;AliTRDPIDResponse.h&quot;
<span class="lineNum">      46 </span>            : //#include &quot;AliTRDTKDInterpolator.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;AliTRDNDFast.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;AliTRDdEdxParams.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;AliExternalTrackParam.h&quot;
<span class="lineNum">      50 </span>            : 
<a name="51"><span class="lineNum">      51 </span>            : </a>
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span><span class="lineCov">        176 : ClassImp(AliTRDPIDResponse)</span>
<a name="54"><span class="lineNum">      54 </span>            : </a>
<span class="lineNum">      55 </span>            : //____________________________________________________________
<span class="lineNum">      56 </span>            : AliTRDPIDResponse::AliTRDPIDResponse():
<span class="lineNum">      57 </span><span class="lineCov">         12 :   TObject()</span>
<span class="lineNum">      58 </span><span class="lineCov">         12 :   ,fkPIDResponseObject(NULL)</span>
<span class="lineNum">      59 </span><span class="lineCov">         12 :   ,fkTRDdEdxParams(NULL)</span>
<span class="lineNum">      60 </span><span class="lineCov">         12 :   ,fGainNormalisationFactor(1.)</span>
<span class="lineNum">      61 </span><span class="lineCov">         12 :   ,fCorrectEta(kFALSE)</span>
<span class="lineNum">      62 </span><span class="lineCov">         12 :   ,fMagField(0.)</span>
<span class="lineNum">      63 </span><span class="lineCov">         60 : {</span>
<span class="lineNum">      64 </span>            :   //
<span class="lineNum">      65 </span>            :   // Default constructor
<span class="lineNum">      66 </span>            :   //
<span class="lineNum">      67 </span><span class="lineCov">         24 : }</span>
<a name="68"><span class="lineNum">      68 </span>            : </a>
<span class="lineNum">      69 </span>            : //____________________________________________________________
<span class="lineNum">      70 </span>            : AliTRDPIDResponse::AliTRDPIDResponse(const AliTRDPIDResponse &amp;ref):
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :   TObject(ref)</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :   ,fkPIDResponseObject(NULL)</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :   ,fkTRDdEdxParams(NULL)</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :   ,fGainNormalisationFactor(ref.fGainNormalisationFactor)</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :   ,fCorrectEta(kFALSE)</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :   ,fMagField(0.)</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      78 </span>            :   //
<span class="lineNum">      79 </span>            :   // Copy constructor
<span class="lineNum">      80 </span>            :   //
<span class="lineNum">      81 </span><span class="lineNoCov">          0 : }</span>
<a name="82"><span class="lineNum">      82 </span>            : </a>
<span class="lineNum">      83 </span>            : //____________________________________________________________
<span class="lineNum">      84 </span>            : AliTRDPIDResponse &amp;AliTRDPIDResponse::operator=(const AliTRDPIDResponse &amp;ref){
<span class="lineNum">      85 </span>            :   //
<span class="lineNum">      86 </span>            :   // Assignment operator
<span class="lineNum">      87 </span>            :   //
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :   if(this == &amp;ref) return *this;</span>
<span class="lineNum">      89 </span>            :   
<span class="lineNum">      90 </span>            :   // Make copy
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :   TObject::operator=(ref);</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :   fGainNormalisationFactor = ref.fGainNormalisationFactor;</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :   fkPIDResponseObject = ref.fkPIDResponseObject;</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :   fkTRDdEdxParams = ref.fkTRDdEdxParams;</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :   fCorrectEta = ref.fCorrectEta;</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :   fMagField   = ref.fMagField;</span>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   return *this;</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 : }</span>
<a name="100"><span class="lineNum">     100 </span>            : </a>
<span class="lineNum">     101 </span>            : //____________________________________________________________
<span class="lineNum">     102 </span><span class="lineCov">         40 : AliTRDPIDResponse::~AliTRDPIDResponse(){</span>
<span class="lineNum">     103 </span>            :   //
<span class="lineNum">     104 </span>            :   // Destructor
<span class="lineNum">     105 </span>            :   //
<span class="lineNum">     106 </span><span class="lineCov">         20 :   if(IsOwner()) {</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     delete fkPIDResponseObject;</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :     delete fkTRDdEdxParams;</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :     delete fhEtaCorr[0];</span>
<span class="lineNum">     110 </span>            :   }
<span class="lineNum">     111 </span><span class="lineCov">         20 : }</span>
<a name="112"><span class="lineNum">     112 </span>            : </a>
<span class="lineNum">     113 </span>            : //____________________________________________________________
<span class="lineNum">     114 </span>            : Bool_t AliTRDPIDResponse::Load(const Char_t * filename){
<span class="lineNum">     115 </span>            :   //
<span class="lineNum">     116 </span>            :   // Load References into the toolkit
<span class="lineNum">     117 </span>            :   //
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :   AliDebug(1, &quot;Loading reference histos from root file&quot;);</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :   TDirectory *owd = gDirectory;// store old working directory</span>
<span class="lineNum">     120 </span>            :   
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :   if(!filename)</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :     filename = Form(&quot;%s/STEER/LQ1dRef_v1.root&quot;,gSystem-&gt;ExpandPathName(&quot;$ALICE_ROOT&quot;));</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :   TFile *in = TFile::Open(filename);</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   if(!in){</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     AliError(&quot;Ref file not available.&quot;);</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     127 </span>            :   }
<span class="lineNum">     128 </span>            :   
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :   gROOT-&gt;cd();</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :   fkPIDResponseObject = dynamic_cast&lt;const AliTRDPIDResponseObject *&gt;(in-&gt;Get(&quot;TRDPIDResponse&quot;)-&gt;Clone());</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   in-&gt;Close(); delete in;</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :   owd-&gt;cd();</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :   SetBit(kIsOwner, kTRUE);</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :   AliDebug(2, Form(&quot;Successfully loaded References for %d Momentum bins&quot;, fkPIDResponseObject-&gt;GetNumberOfMomentumBins()));</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 : }</span>
<a name="137"><span class="lineNum">     137 </span>            : </a>
<span class="lineNum">     138 </span>            : //_________________________________________________________________________
<span class="lineNum">     139 </span>            : Bool_t AliTRDPIDResponse::SetEtaCorrMap(Int_t i,TH2D* hMap)
<span class="lineNum">     140 </span>            : {
<span class="lineNum">     141 </span>            :   //
<span class="lineNum">     142 </span>            :   // Load map for TRD eta correction (a copy is stored and will be deleted automatically).
<span class="lineNum">     143 </span>            :   // If hMap is 0x0,the eta correction will be disabled and kFALSE is returned. 
<span class="lineNum">     144 </span>            :   // If the map can be set, kTRUE is returned.
<span class="lineNum">     145 </span>            :   //
<span class="lineNum">     146 </span>            :   
<span class="lineNum">     147 </span>            : //    delete fhEtaCorr[0];
<span class="lineNum">     148 </span>            :   
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     if (!hMap) {</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :         fhEtaCorr[0] = 0x0;</span>
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :         return kFALSE;</span>
<span class="lineNum">     153 </span>            :     }
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :     fhEtaCorr[0] = (TH2D*)(hMap-&gt;Clone());</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :     return kTRUE;</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 : }</span>
<a name="159"><span class="lineNum">     159 </span>            : </a>
<span class="lineNum">     160 </span>            : //____________________________________________________________
<span class="lineNum">     161 </span>            : Double_t AliTRDPIDResponse::GetEtaCorrection(const AliVTrack *track, Double_t bg) const
<span class="lineNum">     162 </span>            : {
<span class="lineNum">     163 </span>            :     //
<span class="lineNum">     164 </span>            :     // eta correction
<span class="lineNum">     165 </span>            :     //
<span class="lineNum">     166 </span>            :     
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :     if (!fhEtaCorr[0]) {</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :         AliError(Form(&quot;Eta correction requested, but map not initialised for iterator:%i (usually via AliPIDResponse). Returning eta correction factor 1!&quot;,1));</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :         return 1.;</span>
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span>            :     }
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span>            :     Double_t fEtaCorFactor=1;
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     Int_t nch = track-&gt;GetTRDNchamberdEdx();</span>
<span class="lineNum">     178 </span>            :     
<span class="lineNum">     179 </span>            :     const Int_t iter  = 0;
<span class="lineNum">     180 </span>            :     
<span class="lineNum">     181 </span>            :     if (iter &lt; 0) {
<span class="lineNum">     182 </span>            :         AliError(Form(&quot;Eta correction requested for track with  = %i, no map available. Returning default eta correction factor = 1!&quot;, nch));
<span class="lineNum">     183 </span>            :         return 1.;
<span class="lineNum">     184 </span>            :     }
<span class="lineNum">     185 </span>            :     
<span class="lineNum">     186 </span>            : 
<span class="lineNum">     187 </span>            :     // Get eta from propagation of outer params to TRD
<span class="lineNum">     188 </span>            :     const AliExternalTrackParam *tempparam = NULL;
<span class="lineNum">     189 </span>            :     Double_t etalayer=-99;
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     if(track-&gt;GetOuterParam()) tempparam = track-&gt;GetOuterParam();</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :     else if(track-&gt;GetInnerParam()) tempparam = track-&gt;GetInnerParam();</span>
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :     if(tempparam) {</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :         AliExternalTrackParam param(*tempparam);</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :         param.PropagateTo(288.43,fMagField);   // hardwired number where TRD begins</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :         etalayer= param.Eta();</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :     } else return 1.;</span>
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     if((TMath::Abs(etalayer)&gt;0.9)||(bg&lt;0.3)||(bg&gt;1e4)){</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     203 </span>            :     } else {
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :         if ((fhEtaCorr[iter]-&gt;GetBinContent(fhEtaCorr[iter]-&gt;FindBin(etalayer,bg)) != 0)) {</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :             fEtaCorFactor= fhEtaCorr[iter]-&gt;GetBinContent(fhEtaCorr[iter]-&gt;FindBin(etalayer,bg));</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :             return fEtaCorFactor;</span>
<span class="lineNum">     207 </span>            :         }  else
<span class="lineNum">     208 </span>            :         {
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :             return 1;</span>
<span class="lineNum">     210 </span>            :         }
<span class="lineNum">     211 </span>            :     }
<span class="lineNum">     212 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span>            : 
<a name="215"><span class="lineNum">     215 </span>            : </a>
<span class="lineNum">     216 </span>            : //____________________________________________________________
<span class="lineNum">     217 </span>            : Double_t AliTRDPIDResponse::GetNumberOfSigmas(const AliVTrack *track, AliPID::EParticleType type, Bool_t fCorrectEta) const
<span class="lineNum">     218 </span>            : {
<span class="lineNum">     219 </span>            :   //
<span class="lineNum">     220 </span>            :   //calculate the TRD nSigma
<span class="lineNum">     221 </span>            :   //
<span class="lineNum">     222 </span>            : 
<span class="lineNum">     223 </span>            :   const Double_t badval = -9999;
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :   Double_t info[5]; for(int i=0; i&lt;5; i++){info[i]=badval;}</span>
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   const Double_t delta = GetSignalDelta(track, type, kFALSE, fCorrectEta, info);</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   const Double_t mean = info[0];</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :   const Double_t res = info[1];</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :   if(res&lt;0){</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :     return badval;</span>
<span class="lineNum">     232 </span>            :   }
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :   const Double_t sigma = mean*res;</span>
<span class="lineNum">     235 </span>            :   const Double_t eps = 1e-12;
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :   return delta/(sigma + eps);</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 : }</span>
<a name="238"><span class="lineNum">     238 </span>            : </a>
<span class="lineNum">     239 </span>            : //____________________________________________________________
<span class="lineNum">     240 </span>            : Double_t AliTRDPIDResponse::GetSignalDelta( const AliVTrack* track, AliPID::EParticleType type, Bool_t ratio/*=kFALSE*/, Bool_t fCorrectEta, Double_t *info/*=0x0*/) const
<span class="lineNum">     241 </span>            : {
<span class="lineNum">     242 </span>            :   //
<span class="lineNum">     243 </span>            :   //calculate the TRD signal difference w.r.t. the expected
<span class="lineNum">     244 </span>            :   //output other information in info[]
<span class="lineNum">     245 </span>            :   //
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span>            :   const Double_t badval = -9999;
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :   if(!track){</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :     return badval;</span>
<span class="lineNum">     251 </span>            :   }
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span>            :   Double_t pTRD = 0; 
<span class="lineNum">     254 </span>            :   Int_t pTRDNorm =0 ;
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :   for(Int_t ich=0; ich&lt;6; ich++){</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :       if(track-&gt;GetTRDmomentum(ich)&gt;0)</span>
<span class="lineNum">     257 </span>            :       {
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :           pTRD += track-&gt;GetTRDmomentum(ich);</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :           pTRDNorm++;</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     261 </span>            :   }
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :   if(pTRDNorm&gt;0)</span>
<span class="lineNum">     264 </span>            :   {
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :       pTRD/=pTRDNorm;</span>
<span class="lineNum">     266 </span>            :   }
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :   else return badval;</span>
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :   if(!fkTRDdEdxParams){</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     AliDebug(3,&quot;fkTRDdEdxParams null&quot;);</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     return -99999;</span>
<span class="lineNum">     272 </span>            :   }
<span class="lineNum">     273 </span>            : 
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :   const Double_t nch = track-&gt;GetTRDNchamberdEdx();</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   const Double_t ncls = track-&gt;GetTRDNclusterdEdx();</span>
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span>            : //  fkTRDdEdxParams-&gt;Print();
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   const TVectorF meanvec = fkTRDdEdxParams-&gt;GetMeanParameter(type, nch, ncls,fCorrectEta);</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :   if(meanvec.GetNrows()==0){</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :     return badval;</span>
<span class="lineNum">     282 </span>            :   }
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :   const TVectorF resvec  = fkTRDdEdxParams-&gt;GetSigmaParameter(type, nch, ncls,fCorrectEta);</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :   if(resvec.GetNrows()==0){</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     return badval;</span>
<span class="lineNum">     287 </span>            :   }
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   const Float_t *meanpar = meanvec.GetMatrixArray();</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :   const Float_t *respar  = resvec.GetMatrixArray();</span>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span>            :   //============================================================================================&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :   const Double_t bg = pTRD/AliPID::ParticleMass(type);</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :   const Double_t expsig = MeandEdxTR(&amp;bg, meanpar);</span>
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :   if(info){</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :       info[0]= expsig;</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :       info[1]= ResolutiondEdxTR(&amp;ncls, respar);</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :  }</span>
<span class="lineNum">     303 </span>            : 
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span>            :   const Double_t eps = 1e-10;
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span>            :   // eta asymmetry correction
<span class="lineNum">     309 </span>            :   Double_t corrFactorEta = 1.0;
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :   if (fCorrectEta) {</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :       corrFactorEta = GetEtaCorrection(track,bg);</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :   AliDebug(3,Form(&quot;TRD trunc PID expected signal %f exp. resolution %f bg %f nch %f ncls %f etcoron/off %i nsigma %f ratio %f \n&quot;,expsig,ResolutiondEdxTR(&amp;ncls, respar),bg,nch,ncls,fCorrectEta,(corrFactorEta*track-&gt;GetTRDsignal())/(expsig + eps),(corrFactorEta*track-&gt;GetTRDsignal()) - expsig));</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :   if(ratio){</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :       return (corrFactorEta*track-&gt;GetTRDsignal())/(expsig + eps);</span>
<span class="lineNum">     320 </span>            :   }
<span class="lineNum">     321 </span>            :   else{
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :       return (corrFactorEta*track-&gt;GetTRDsignal()) - expsig;</span>
<span class="lineNum">     323 </span>            :   }
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span>            :  
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span><span class="lineNoCov">          0 : }</span>
<a name="328"><span class="lineNum">     328 </span>            : </a>
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span>            : Double_t AliTRDPIDResponse::ResolutiondEdxTR(const Double_t * xx,  const Float_t * par)
<span class="lineNum">     331 </span>            : {
<span class="lineNum">     332 </span>            :   //
<span class="lineNum">     333 </span>            :   //resolution 
<span class="lineNum">     334 </span>            :   //npar=3
<span class="lineNum">     335 </span>            :   //
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :   const Double_t ncls = xx[0];</span>
<span class="lineNum">     338 </span>            : //  return par[0]+par[1]*TMath::Power(ncls, par[2]);
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :   return TMath::Sqrt(par[0]*par[0]+par[1]*par[1]/ncls);</span>
<a name="340"><span class="lineNum">     340 </span>            : }</a>
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span>            : Double_t AliTRDPIDResponse::MeandEdxTR(const Double_t * xx,  const Float_t * pin)
<span class="lineNum">     343 </span>            : {
<span class="lineNum">     344 </span>            :   //
<span class="lineNum">     345 </span>            :   //ALEPH+LOGISTIC parametrization for dEdx+TR, in unit of MIP
<span class="lineNum">     346 </span>            :   //npar = 8 = 3+5
<span class="lineNum">     347 </span>            :   //
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :   Float_t ptr[4]={0};</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :   for(int ii=0; ii&lt;3; ii++){</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     ptr[ii+1]=pin[ii];</span>
<span class="lineNum">     352 </span>            :   }
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :   return MeanTR(xx,ptr) + MeandEdx(xx,&amp;(pin[3]));</span>
<a name="354"><span class="lineNum">     354 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span>            : Double_t AliTRDPIDResponse::MeanTR(const Double_t * xx,  const Float_t * par)
<span class="lineNum">     357 </span>            : {
<span class="lineNum">     358 </span>            :   //
<span class="lineNum">     359 </span>            :   //LOGISTIC parametrization for TR, in unit of MIP
<span class="lineNum">     360 </span>            :   //npar = 4
<span class="lineNum">     361 </span>            :   //
<span class="lineNum">     362 </span>            :                                                                                                                                                                                                                                                         
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :   const Double_t bg = xx[0];</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :   const Double_t gamma = sqrt(1+bg*bg);</span>
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   const Double_t p0 = TMath::Abs(par[1]);</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :   const Double_t p1 = TMath::Abs(par[2]);</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :   const Double_t p2 = TMath::Abs(par[3]);</span>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :   const Double_t zz = TMath::Log(gamma);</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   const Double_t tryield = p0/( 1 + TMath::Exp(-p1*(zz-p2)) );</span>
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :   return par[0]+tryield;</span>
<a name="374"><span class="lineNum">     374 </span>            : }</a>
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span>            : Double_t AliTRDPIDResponse::MeandEdx(const Double_t * xx,  const Float_t * par)
<span class="lineNum">     377 </span>            : {
<span class="lineNum">     378 </span>            :   //
<span class="lineNum">     379 </span>            :   //ALEPH parametrization for dEdx
<span class="lineNum">     380 </span>            :   //npar = 5
<span class="lineNum">     381 </span>            :   //
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :   const Double_t bg = xx[0];</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :   const Double_t beta = bg/TMath::Sqrt(1.+ bg*bg);</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   const Double_t p0 = TMath::Abs(par[0]);</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :   const Double_t p1 = TMath::Abs(par[1]);</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :   const Double_t p2 = TMath::Abs(par[2]);</span>
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :   const Double_t p3 = TMath::Abs(par[3]);</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :   const Double_t p4 = TMath::Abs(par[4]);</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :   const Double_t aa = TMath::Power(beta, p3);</span>
<span class="lineNum">     395 </span>            : 
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :   const Double_t bb = TMath::Log( p2 + TMath::Power(1./bg, p4) );</span>
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :   return (p1-aa-bb)*p0/aa;</span>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            : }
<span class="lineNum">     401 </span>            : 
<a name="402"><span class="lineNum">     402 </span>            : </a>
<span class="lineNum">     403 </span>            : //____________________________________________________________
<span class="lineNum">     404 </span>            : Int_t AliTRDPIDResponse::GetResponse(Int_t n, const Double_t * const dedx, const Float_t * const p, Double_t prob[AliPID::kSPECIES],ETRDPIDMethod PIDmethod,Bool_t kNorm) const
<span class="lineNum">     405 </span>            : {
<span class="lineNum">     406 </span>            :   //
<span class="lineNum">     407 </span>            :   // Calculate TRD likelihood values for the track based on dedx and 
<span class="lineNum">     408 </span>            :   // momentum values. The likelihoods are calculated by query the 
<span class="lineNum">     409 </span>            :   // reference data depending on the PID method selected
<span class="lineNum">     410 </span>            :   //
<span class="lineNum">     411 </span>            :   // Input parameter :
<span class="lineNum">     412 </span>            :   //   n - number of dedx slices/chamber
<span class="lineNum">     413 </span>            :   //   dedx - array of dedx slices organized layer wise
<span class="lineNum">     414 </span>            :   //   p - array of momentum measurements organized layer wise
<span class="lineNum">     415 </span>            :   // 
<span class="lineNum">     416 </span>            :   // Return parameters
<span class="lineNum">     417 </span>            :   //   prob - probabilities allocated by TRD for particle specis
<span class="lineNum">     418 </span>            :   //   kNorm - switch to normalize probabilities to 1. By default true. If false return not normalized prob.
<span class="lineNum">     419 </span>            :   // 
<span class="lineNum">     420 </span>            :   // Return value
<span class="lineNum">     421 </span>            :   //   number of tracklets used for PID, 0 if no PID
<span class="lineNum">     422 </span>            :     //
<span class="lineNum">     423 </span><span class="lineCov">        312 :     AliDebug(3,Form(&quot; Response for PID method: %d&quot;,PIDmethod));</span>
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span><span class="lineCov">        104 :     if(!fkPIDResponseObject){</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :         AliDebug(3,&quot;Missing reference data. PID calculation not possible.&quot;);</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     429 </span>            :     }
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineCov">       1248 :     for(Int_t is(AliPID::kSPECIES); is--;) prob[is]=.2;</span>
<span class="lineNum">     432 </span><span class="lineCov">        104 :     Double_t prLayer[AliPID::kSPECIES];</span>
<span class="lineNum">     433 </span><span class="lineCov">        104 :     Double_t dE[10], s(0.);</span>
<span class="lineNum">     434 </span>            :     Int_t ntrackletsPID=0;
<span class="lineNum">     435 </span><span class="lineCov">        832 :     for(Int_t il(kNlayer); il--;){</span>
<span class="lineNum">     436 </span><span class="lineCov">        624 :         memset(prLayer, 0, AliPID::kSPECIES*sizeof(Double_t));</span>
<span class="lineNum">     437 </span><span class="lineCov">        624 :         if(!CookdEdx(n, &amp;dedx[il*n], &amp;dE[0],PIDmethod)) continue;</span>
<span class="lineNum">     438 </span>            :         s=0.;
<span class="lineNum">     439 </span>            :         Bool_t filled=kTRUE;
<span class="lineNum">     440 </span><span class="lineCov">        412 :         for(Int_t is(AliPID::kSPECIES); is--;){</span>
<span class="lineNum">     441 </span>            :             //if((PIDmethod==kLQ2D)&amp;&amp;(!(is==0||is==2)))continue;
<span class="lineNum">     442 </span><span class="lineCov">        618 :             if((dE[0] &gt; 0.) &amp;&amp; (p[il] &gt; 0.)) prLayer[is] = GetProbabilitySingleLayer(is, p[il], &amp;dE[0],PIDmethod);</span>
<span class="lineNum">     443 </span><span class="lineCov">        618 :             AliDebug(3, Form(&quot;Probability for Species %d in Layer %d: %e&quot;, is, il, prLayer[is]));</span>
<span class="lineNum">     444 </span><span class="lineCov">        206 :             if(prLayer[is]&lt;1.e-30){</span>
<span class="lineNum">     445 </span><span class="lineCov">        618 :                 AliDebug(2, Form(&quot;Null for species %d species prob layer[%d].&quot;,is,il));</span>
<span class="lineNum">     446 </span>            :                 filled=kFALSE;
<span class="lineNum">     447 </span><span class="lineCov">        206 :                 break;</span>
<span class="lineNum">     448 </span>            :             }
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :             s+=prLayer[is];</span>
<span class="lineNum">     450 </span>            :         }
<span class="lineNum">     451 </span><span class="lineCov">        206 :         if(!filled){</span>
<span class="lineNum">     452 </span><span class="lineCov">        206 :             continue;</span>
<span class="lineNum">     453 </span>            :         }
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :         if(s&lt;1.e-30){</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :             AliDebug(2, Form(&quot;Null all species prob layer[%d].&quot;, il));</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     457 </span>            :         }
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :         for(Int_t is(AliPID::kSPECIES); is--;){</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :             if(kNorm) prLayer[is] /= s;  // probability in each layer for each particle species normalized to the sum of probabilities for given layer</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :             prob[is] *= prLayer[is];  // multiply single layer probabilities to get probability for complete track</span>
<span class="lineNum">     461 </span>            :         }
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :         ntrackletsPID++;</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     464 </span><span class="lineCov">        104 :     if(!kNorm) return ntrackletsPID;</span>
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span>            :     s=0.;
<span class="lineNum">     467 </span>            :     // sum probabilities for all considered particle species
<span class="lineNum">     468 </span><span class="lineCov">       1248 :     for(Int_t is(AliPID::kSPECIES); is--;) { s+=prob[is];</span>
<span class="lineNum">     469 </span>            :     }
<span class="lineNum">     470 </span><span class="lineCov">        104 :     if(s&lt;1.e-30){</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :         AliDebug(2, &quot;Null total prob.&quot;);</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     473 </span>            :     }
<span class="lineNum">     474 </span>            :     // norm to the summed probability  (default values: s=1 prob[is]=0.2)
<span class="lineNum">     475 </span><span class="lineCov">       1248 :     for(Int_t is(AliPID::kSPECIES); is--;){ prob[is]/=s; }</span>
<span class="lineNum">     476 </span><span class="lineCov">        104 :     return ntrackletsPID;</span>
<span class="lineNum">     477 </span><span class="lineCov">        208 : }</span>
<a name="478"><span class="lineNum">     478 </span>            : </a>
<span class="lineNum">     479 </span>            : //____________________________________________________________
<span class="lineNum">     480 </span>            : Double_t AliTRDPIDResponse::GetProbabilitySingleLayer(Int_t species, Double_t plocal, Double_t *dEdx,ETRDPIDMethod PIDmethod) const {
<span class="lineNum">     481 </span>            :   //
<span class="lineNum">     482 </span>            :   // Get the non-normalized probability for a certain particle species as coming
<span class="lineNum">     483 </span>            :   // from the reference histogram
<span class="lineNum">     484 </span>            :   // Interpolation between momentum bins
<span class="lineNum">     485 </span>            :   //
<span class="lineNum">     486 </span><span class="lineCov">        824 :   AliDebug(1, Form(&quot;Make Probability for Species %d with Momentum %f&quot;, species, plocal));</span>
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span>            :   Double_t probLayer = 0.;
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineCov">        206 :   Float_t pLower, pUpper;</span>
<span class="lineNum">     491 </span>            :         
<span class="lineNum">     492 </span><span class="lineCov">        618 :   AliTRDNDFast *refUpper = dynamic_cast&lt;AliTRDNDFast *&gt;(fkPIDResponseObject-&gt;GetUpperReference((AliPID::EParticleType)species, plocal, pUpper,PIDmethod)),</span>
<span class="lineNum">     493 </span><span class="lineCov">        488 :       *refLower = dynamic_cast&lt;AliTRDNDFast *&gt;(fkPIDResponseObject-&gt;GetLowerReference((AliPID::EParticleType)species, plocal, pLower,PIDmethod));</span>
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span>            :   // Do Interpolation exept for underflow and overflow
<span class="lineNum">     496 </span><span class="lineCov">        206 :   if(refLower &amp;&amp; refUpper){</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :       Double_t probLower = refLower-&gt;Eval(dEdx);</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :       Double_t probUpper = refUpper-&gt;Eval(dEdx);</span>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :       probLayer = probLower + (probUpper - probLower)/(pUpper-pLower) * (plocal - pLower);</span>
<span class="lineNum">     501 </span><span class="lineCov">        206 :   } else if(refLower){</span>
<span class="lineNum">     502 </span>            :      // underflow
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :       probLayer = refLower-&gt;Eval(dEdx);</span>
<span class="lineNum">     504 </span><span class="lineCov">        206 :   } else if(refUpper){</span>
<span class="lineNum">     505 </span>            :       // overflow
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :       probLayer = refUpper-&gt;Eval(dEdx);</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">     508 </span><span class="lineCov">        618 :       AliDebug(3,&quot;No references available&quot;);</span>
<span class="lineNum">     509 </span>            :   }
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span><span class="lineCov">        412 :   switch(PIDmethod){</span>
<span class="lineNum">     512 </span>            :   case kLQ2D: // 2D LQ
<span class="lineNum">     513 </span>            :       {
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :           AliDebug(1,Form(&quot;Eval 2D Q0 %f Q1 %f P %e &quot;,dEdx[0],dEdx[1],probLayer));</span>
<span class="lineNum">     515 </span>            :       }
<span class="lineNum">     516 </span>            :       break;
<span class="lineNum">     517 </span>            :   case kLQ1D: // 1D LQ
<span class="lineNum">     518 </span>            :       {
<span class="lineNum">     519 </span><span class="lineCov">        618 :           AliDebug(1, Form(&quot;Eval 1D dEdx %f Probability %e&quot;, dEdx[0],probLayer));</span>
<span class="lineNum">     520 </span>            :       }
<span class="lineNum">     521 </span>            :       break;
<span class="lineNum">     522 </span>            :   case kLQ3D: // 3D LQ
<span class="lineNum">     523 </span>            :       {
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :           AliDebug(1, Form(&quot;Eval 1D dEdx %f %f %f Probability %e&quot;, dEdx[0],dEdx[1],dEdx[2],probLayer));</span>
<span class="lineNum">     525 </span>            :       }
<span class="lineNum">     526 </span>            :       break;
<span class="lineNum">     527 </span>            :   case kLQ7D: // 7D LQ
<span class="lineNum">     528 </span>            :       {
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :           AliDebug(1, Form(&quot;Eval 1D dEdx %f %f %f %f %f %f %f Probability %e&quot;, dEdx[0],dEdx[1],dEdx[2],dEdx[3],dEdx[4],dEdx[5],dEdx[6],probLayer));</span>
<span class="lineNum">     530 </span>            :       }
<span class="lineNum">     531 </span>            :       break;
<span class="lineNum">     532 </span>            :   default:
<span class="lineNum">     533 </span>            :       break;
<span class="lineNum">     534 </span>            :   }
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span><span class="lineCov">        206 :   return probLayer;</span>
<span class="lineNum">     537 </span>            : 
<span class="lineNum">     538 </span>            : /* old implementation
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span>            : switch(PIDmethod){
<span class="lineNum">     541 </span>            : case kNN: // NN
<span class="lineNum">     542 </span>            :       break;
<span class="lineNum">     543 </span>            :   case kLQ2D: // 2D LQ
<span class="lineNum">     544 </span>            :       {
<span class="lineNum">     545 </span>            :           if(species==0||species==2){ // references only for electrons and pions
<span class="lineNum">     546 </span>            :               Double_t error = 0.;
<span class="lineNum">     547 </span>            :               Double_t point[kNslicesLQ2D];
<span class="lineNum">     548 </span>            :               for(Int_t idim=0;idim&lt;kNslicesLQ2D;idim++){point[idim]=dEdx[idim];}
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span>            :               AliTRDTKDInterpolator *refUpper = dynamic_cast&lt;AliTRDTKDInterpolator *&gt;(fkPIDResponseObject-&gt;GetUpperReference((AliPID::EParticleType)species, plocal, pUpper,kLQ2D)),
<span class="lineNum">     551 </span>            :               *refLower = dynamic_cast&lt;AliTRDTKDInterpolator *&gt;(fkPIDResponseObject-&gt;GetLowerReference((AliPID::EParticleType)species, plocal, pLower,kLQ2D));
<span class="lineNum">     552 </span>            :               // Do Interpolation exept for underflow and overflow
<span class="lineNum">     553 </span>            :               if(refLower &amp;&amp; refUpper){
<span class="lineNum">     554 </span>            :                   Double_t probLower=0,probUpper=0;
<span class="lineNum">     555 </span>            :                   refLower-&gt;Eval(point,probLower,error);
<span class="lineNum">     556 </span>            :                   refUpper-&gt;Eval(point,probUpper,error);
<span class="lineNum">     557 </span>            :                   probLayer = probLower + (probUpper - probLower)/(pUpper-pLower) * (plocal - pLower);
<span class="lineNum">     558 </span>            :               } else if(refLower){
<span class="lineNum">     559 </span>            :                   // underflow
<span class="lineNum">     560 </span>            :                   refLower-&gt;Eval(point,probLayer,error);
<span class="lineNum">     561 </span>            :                   } else if(refUpper){
<span class="lineNum">     562 </span>            :                   // overflow
<span class="lineNum">     563 </span>            :                   refUpper-&gt;Eval(point,probLayer,error);
<span class="lineNum">     564 </span>            :               } else {
<span class="lineNum">     565 </span>            :                   AliError(&quot;No references available&quot;);
<span class="lineNum">     566 </span>            :               }
<span class="lineNum">     567 </span>            :               AliDebug(2,Form(&quot;Eval 2D Q0 %f Q1 %f P %e Err %e&quot;,point[0],point[1],probLayer,error));
<span class="lineNum">     568 </span>            :           }
<span class="lineNum">     569 </span>            :       }
<span class="lineNum">     570 </span>            :       break;
<span class="lineNum">     571 </span>            :   case kLQ1D: // 1D LQ
<span class="lineNum">     572 </span>            :       {
<span class="lineNum">     573 </span>            :           TH1 *refUpper = dynamic_cast&lt;TH1 *&gt;(fkPIDResponseObject-&gt;GetUpperReference((AliPID::EParticleType)species, plocal, pUpper,kLQ1D)),
<span class="lineNum">     574 </span>            :               *refLower = dynamic_cast&lt;TH1 *&gt;(fkPIDResponseObject-&gt;GetLowerReference((AliPID::EParticleType)species, plocal, pLower,kLQ1D));
<span class="lineNum">     575 </span>            :           // Do Interpolation exept for underflow and overflow
<span class="lineNum">     576 </span>            :           if(refLower &amp;&amp; refUpper){
<span class="lineNum">     577 </span>            :               Double_t probLower = refLower-&gt;GetBinContent(refLower-&gt;GetXaxis()-&gt;FindBin(dEdx[0]));
<span class="lineNum">     578 </span>            :               Double_t probUpper = refUpper-&gt;GetBinContent(refUpper-&gt;GetXaxis()-&gt;FindBin(dEdx[0]));
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span>            :               probLayer = probLower + (probUpper - probLower)/(pUpper-pLower) * (plocal - pLower);
<span class="lineNum">     581 </span>            :           } else if(refLower){
<span class="lineNum">     582 </span>            :               // underflow
<span class="lineNum">     583 </span>            :               probLayer = refLower-&gt;GetBinContent(refLower-&gt;GetXaxis()-&gt;FindBin(dEdx[0]));
<span class="lineNum">     584 </span>            :           } else if(refUpper){
<span class="lineNum">     585 </span>            :               // overflow
<span class="lineNum">     586 </span>            :               probLayer = refUpper-&gt;GetBinContent(refUpper-&gt;GetXaxis()-&gt;FindBin(dEdx[0]));
<span class="lineNum">     587 </span>            :           } else {
<span class="lineNum">     588 </span>            :               AliError(&quot;No references available&quot;);
<span class="lineNum">     589 </span>            :           }
<span class="lineNum">     590 </span>            :           AliDebug(1, Form(&quot;Eval 1D dEdx %f Probability %e&quot;, dEdx[0],probLayer));
<span class="lineNum">     591 </span>            :       }
<span class="lineNum">     592 </span>            :       break;
<span class="lineNum">     593 </span>            :   default:
<span class="lineNum">     594 </span>            :       break;
<span class="lineNum">     595 </span>            :       }
<span class="lineNum">     596 </span>            :       return probLayer;
<span class="lineNum">     597 </span>            :       */
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span><span class="lineCov">        206 : }</span>
<a name="600"><span class="lineNum">     600 </span>            : </a>
<span class="lineNum">     601 </span>            : //____________________________________________________________
<span class="lineNum">     602 </span>            : void AliTRDPIDResponse::SetOwner(){
<span class="lineNum">     603 </span>            :   //
<span class="lineNum">     604 </span>            :   // Make Deep Copy of the Reference Histograms
<span class="lineNum">     605 </span>            :   //
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :     if(!fkPIDResponseObject || IsOwner()) return;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     const AliTRDPIDResponseObject *tmp = fkPIDResponseObject;</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :     fkPIDResponseObject = dynamic_cast&lt;const AliTRDPIDResponseObject *&gt;(tmp-&gt;Clone());</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :     SetBit(kIsOwner, kTRUE);</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 : }</span>
<a name="611"><span class="lineNum">     611 </span>            : </a>
<span class="lineNum">     612 </span>            : //____________________________________________________________
<span class="lineNum">     613 </span>            : Bool_t AliTRDPIDResponse::CookdEdx(Int_t nSlice, const Double_t * const in, Double_t *out,ETRDPIDMethod PIDmethod) const
<span class="lineNum">     614 </span>            : {
<span class="lineNum">     615 </span>            :     //
<span class="lineNum">     616 </span>            :     // Recalculate dE/dx
<span class="lineNum">     617 </span>            :     // removed missing slices cut, detailed checks see presentation in TRD meeting: https://indico.cern.ch/event/506345/contribution/3/attachments/1239069/1821088/TRDPID_missingslices_charge.pdf
<span class="lineNum">     618 </span>            :     //
<span class="lineNum">     619 </span>            : 
<span class="lineNum">     620 </span><span class="lineCov">       1454 :   switch(PIDmethod){</span>
<span class="lineNum">     621 </span>            :   case kNN: // NN 
<span class="lineNum">     622 </span>            :       break;
<span class="lineNum">     623 </span>            :   case kLQ2D: // 2D LQ
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :       out[0]=0;</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :       out[1]=0;</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :       for(Int_t islice = 0; islice &lt; nSlice; islice++){</span>
<span class="lineNum">     627 </span>            :        //   if(in[islice]&lt;=0){out[0]=0;out[1]=0;return kFALSE;}  // Require that all slices are filled
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :           if(islice&lt;kNsliceQ0LQ2D)out[0]+= in[islice];</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :           else out[1]+= in[islice];</span>
<span class="lineNum">     631 </span>            :       }
<span class="lineNum">     632 </span>            :       // normalize signal to number of slices
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :       out[0]*=1./Double_t(kNsliceQ0LQ2D);</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :       out[1]*=1./Double_t(nSlice-kNsliceQ0LQ2D);</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :       if(out[0] &lt;= 0) return kFALSE;</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :       if(out[1] &lt;= 0) return kFALSE;</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :       AliDebug(3,Form(&quot;CookdEdx Q0 %f Q1 %f&quot;,out[0],out[1]));</span>
<span class="lineNum">     638 </span>            :       break;
<span class="lineNum">     639 </span>            :   case kLQ1D: // 1D LQ
<span class="lineNum">     640 </span><span class="lineCov">        624 :       out[0]= 0.;</span>
<span class="lineNum">     641 </span><span class="lineCov">       2496 :       for(Int_t islice = 0; islice &lt; nSlice; islice++) {</span>
<span class="lineNum">     642 </span>            : //        if(in[islice] &gt; 0) out[0] += in[islice] * fGainNormalisationFactor;   // Protect against negative values for slices having no dE/dx information
<span class="lineNum">     643 </span><span class="lineCov">        830 :           if(in[islice] &gt; 0) out[0] += in[islice];  // no neg dE/dx values</span>
<span class="lineNum">     644 </span>            :       }
<span class="lineNum">     645 </span><span class="lineCov">        624 :       out[0]*=1./Double_t(kNsliceQ0LQ1D);</span>
<span class="lineNum">     646 </span><span class="lineCov">       1042 :       if(out[0] &lt;= 0) return kFALSE;</span>
<span class="lineNum">     647 </span><span class="lineCov">        618 :       AliDebug(3,Form(&quot;CookdEdx dEdx %f&quot;,out[0]));</span>
<span class="lineNum">     648 </span>            :       break;
<span class="lineNum">     649 </span>            :   case kLQ3D: // 3D LQ
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :       out[0]=0;</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :       out[1]=0;</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :       out[2]=0;</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :       for(Int_t islice = 0; islice &lt; nSlice; islice++){</span>
<span class="lineNum">     654 </span>            :          // if(in[islice]&lt;=0){out[0]=0;out[1]=0;out[2]=0;return kFALSE;}  // Require that all slices are filled
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :           if(islice&lt;kNsliceQ0LQ3D)out[0]+= in[islice];</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :           out[1]=(in[3]+in[4]);</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :           out[2]=(in[5]+in[6]);</span>
<span class="lineNum">     658 </span>            :       }
<span class="lineNum">     659 </span>            :       // normalize signal to number of slices
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :       out[0]*=1./Double_t(kNsliceQ0LQ3D);</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :       out[1]*=1./2.;</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :       out[2]*=1./2.;</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :       if(out[0] &lt;= 0) return kFALSE;</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :       if(out[1] &lt;= 0) return kFALSE;</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :       if(out[2] &lt;= 0) return kFALSE;</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :       AliDebug(3,Form(&quot;CookdEdx Q0 %f Q1 %f Q2 %f&quot;,out[0],out[1],out[2]));</span>
<span class="lineNum">     667 </span>            :       break;
<span class="lineNum">     668 </span>            :   case kLQ7D: // 7D LQ
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :       for(Int_t i=0;i&lt;nSlice;i++) {out[i]=0;}</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :       for(Int_t islice = 0; islice &lt; nSlice; islice++){</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :           if(in[islice]&lt;=0){</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :               for(Int_t i=0;i&lt;8;i++){</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :                   out[i]=0;</span>
<span class="lineNum">     674 </span>            :               }
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :               return kFALSE;}  // Require that all slices are filled</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :           out[islice]=in[islice];</span>
<span class="lineNum">     677 </span>            :       }
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :       for(Int_t i=0;i&lt;nSlice;i++) {if(out[i]&lt;=0) return kFALSE; }</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :       AliDebug(3,Form(&quot;CookdEdx Q0 %f Q1 %f Q2 %f Q3 %f Q4 %f Q5 %f Q6 %f Q7 %f&quot;,out[0],out[1],out[2],out[3],out[4],out[5],out[6],out[7]));</span>
<span class="lineNum">     680 </span>            :       break;
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span>            :   default:
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     684 </span>            :   }
<span class="lineNum">     685 </span><span class="lineCov">        206 :   return kTRUE;</span>
<span class="lineNum">     686 </span><span class="lineCov">        624 : }</span>
<a name="687"><span class="lineNum">     687 </span>            : </a>
<span class="lineNum">     688 </span>            : //____________________________________________________________
<span class="lineNum">     689 </span>            : Bool_t AliTRDPIDResponse::IdentifiedAsElectron(Int_t nTracklets, const Double_t *like, Double_t p, Double_t level,Double_t centrality,ETRDPIDMethod PIDmethod) const {
<span class="lineNum">     690 </span>            :     //
<span class="lineNum">     691 </span>            :     // Check whether particle is identified as electron assuming a certain electron efficiency level
<span class="lineNum">     692 </span>            :     // Only electron and pion hypothesis is taken into account
<span class="lineNum">     693 </span>            :     //
<span class="lineNum">     694 </span>            :     // Inputs:
<span class="lineNum">     695 </span>            :     //         Number of tracklets
<span class="lineNum">     696 </span>            :     //         Likelihood values
<span class="lineNum">     697 </span>            :     //         Momentum
<span class="lineNum">     698 </span>            :     //         Electron efficiency level
<span class="lineNum">     699 </span>            :     //
<span class="lineNum">     700 </span>            :     // If the function fails when the params are not accessible, the function returns true
<span class="lineNum">     701 </span>            :     //
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :   if(!fkPIDResponseObject){</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :     AliDebug(3,&quot;No PID Param object available&quot;);</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :     return kTRUE;</span>
<span class="lineNum">     705 </span>            :   } 
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :   Double_t probEle = like[AliPID::kElectron]/(like[AliPID::kElectron] + like[AliPID::kPion]);</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :   AliDebug(3,Form(&quot;probabilities like %f %f %f \n&quot;,probEle,like[AliPID::kElectron],like[AliPID::kPion]));</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :   Double_t params[4];</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :   if(!fkPIDResponseObject-&gt;GetThresholdParameters(nTracklets, level, params,centrality,PIDmethod)){</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :     AliError(&quot;No Params found for the given configuration&quot;);</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :     return kTRUE;</span>
<span class="lineNum">     712 </span>            :   }
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span>            :   
<span class="lineNum">     715 </span>            : 
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :   Double_t threshold = 1. - params[0] - params[1] * p - params[2] * TMath::Exp(-params[3] * p);</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :   AliDebug(3,Form(&quot;is ident details %i %f %f %i %f %f %f %f \n&quot;,nTracklets, level, centrality,PIDmethod,probEle, threshold,TMath::Min(threshold, 0.99),TMath::Max(TMath::Min(threshold, 0.99), 0.2)));</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :   if(probEle &gt; TMath::Max(TMath::Min(threshold, 0.99), 0.2)) return kTRUE;  // truncate the threshold upperwards to 0.999 and lowerwards to 0.2 and exclude unphysical values</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :   return kFALSE;</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 : }</span>
<a name="721"><span class="lineNum">     721 </span>            : </a>
<span class="lineNum">     722 </span>            : //____________________________________________________________
<span class="lineNum">     723 </span>            : Bool_t AliTRDPIDResponse::SetPIDResponseObject(const AliTRDPIDResponseObject * obj){
<span class="lineNum">     724 </span>            : 
<span class="lineNum">     725 </span><span class="lineCov">          4 :     fkPIDResponseObject = obj;</span>
<span class="lineNum">     726 </span><span class="lineCov">          2 :     if((AliLog::GetDebugLevel(&quot;&quot;,IsA()-&gt;GetName()))&gt;0 &amp;&amp; obj) fkPIDResponseObject-&gt;Print(&quot;&quot;);</span>
<span class="lineNum">     727 </span><span class="lineCov">          2 :     return kTRUE;</span>
<span class="lineNum">     728 </span>            : }
<span class="lineNum">     729 </span>            : 
<a name="730"><span class="lineNum">     730 </span>            : </a>
<span class="lineNum">     731 </span>            : //____________________________________________________________    
<span class="lineNum">     732 </span>            : Bool_t AliTRDPIDResponse::SetdEdxParams(const AliTRDdEdxParams * par)
<span class="lineNum">     733 </span>            : {
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :   fkTRDdEdxParams = par;</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<span class="lineNum">     736 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
