<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - TPC/TPCcalib/AliTPCcalibGainMult.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">TPC/TPCcalib</a> - AliTPCcalibGainMult.cxx<span style="font-size: 80%;"> (source / <a href="AliTPCcalibGainMult.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">1256</td>
            <td class="headerCovTableEntryLo">0.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">23</td>
            <td class="headerCovTableEntryLo">4.3 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : </a>
<span class="lineNum">       2 </span>            : /**************************************************************************
<span class="lineNum">       3 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       4 </span>            :  *                                                                        *
<span class="lineNum">       5 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       6 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       7 </span>            :  *                                                                        *
<span class="lineNum">       8 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       9 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">      10 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      11 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      12 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      13 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      14 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      15 </span>            :  **************************************************************************/
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : /*
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : Basic calibration and QA class for the TPC gain calibration based on tracks from BEAM events.
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span>            : Send comments etc. to: A.Kalweit@gsi.de, marian.ivanov@cern.ch
<span class="lineNum">      24 </span>            : */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : #include &quot;Riostream.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;TROOT.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;TChain.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;TTree.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;TH1F.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;TH2F.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;TList.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;TMath.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;TCanvas.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;TFile.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;TF1.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;TVectorF.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;TProfile.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;TGraphErrors.h&quot;
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            : #include &quot;AliTPCcalibDB.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;AliTPCclusterMI.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;AliTPCClusterParam.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;AliTPCseed.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;AliESDVertex.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;AliESDEvent.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;AliESDfriend.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;AliESDInputHandler.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;AliAnalysisManager.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;AliTPCParam.h&quot;
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : #include &quot;AliComplexCluster.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;AliTPCclusterMI.h&quot;
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            : #include &quot;AliTPCcalibGainMult.h&quot;
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span>            : #include &quot;TTreeStream.h&quot;
<span class="lineNum">      61 </span>            : #include &quot;TDatabasePDG.h&quot;
<span class="lineNum">      62 </span>            : #include &quot;AliKFParticle.h&quot;
<span class="lineNum">      63 </span>            : #include &quot;AliKFVertex.h&quot;
<span class="lineNum">      64 </span>            : #include &quot;AliESDv0.h&quot;
<span class="lineNum">      65 </span>            : #include &quot;AliESDkink.h&quot;
<span class="lineNum">      66 </span>            : #include &quot;AliRecoParam.h&quot;
<span class="lineNum">      67 </span>            : #include &quot;AliTracker.h&quot;
<span class="lineNum">      68 </span>            : #include &quot;AliTPCTransform.h&quot;
<span class="lineNum">      69 </span>            : #include &quot;AliTPCROC.h&quot;
<span class="lineNum">      70 </span>            : #include &quot;AliTPCreco.h&quot;
<a name="71"><span class="lineNum">      71 </span>            : #include &quot;TStatToolkit.h&quot;</a>
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span><span class="lineCov">          6 : ClassImp(AliTPCcalibGainMult)</span>
<span class="lineNum">      74 </span>            : 
<a name="75"><span class="lineNum">      75 </span>            : Double_t AliTPCcalibGainMult::fgMergeEntriesCut=10000000.;</a>
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : AliTPCcalibGainMult::AliTPCcalibGainMult() 
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :   :AliTPCcalibBase(),</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :    fMIP(0),</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :    fLowerTrunc(0),</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :    fUpperTrunc(0),</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :    fUseMax(kFALSE),</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :    fCutCrossRows(0),</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :    fCutEtaWindow(0),</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :    fCutRequireITSrefit(0),</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :    fCutMaxDcaXY(0),</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :    fCutMaxDcaZ(0),</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :    fMinMomentumMIP(0),</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :    fMaxMomentumMIP(0),</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :    fAlephParameters(),</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :    fHistNTracks(0),</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :    fHistClusterShape(0),</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :    fHistQA(0),</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :    fHistGainSector(0),</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :    fHistPadEqual(0),</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :    fHistGainMult(0),</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :    fHistTopology(0),</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :    fPIDMatrix(0),</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :    fHistdEdxMap(0),</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :    fHistdEdxMax(0),</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :    fHistdEdxTot(0),</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :    fdEdxTree(0),</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :    fBBParam(0)</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 : {  </span>
<span class="lineNum">     105 </span>            :   //
<span class="lineNum">     106 </span>            :   // Empty default cosntructor
<span class="lineNum">     107 </span>            :   //
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   AliDebug(5,&quot;Default Constructor&quot;);  </span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 : }</span>
<a name="110"><span class="lineNum">     110 </span>            : </a>
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span>            : AliTPCcalibGainMult::AliTPCcalibGainMult(const Text_t *name, const Text_t *title) 
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :   :AliTPCcalibBase(),</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :    fMIP(0),</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :    fLowerTrunc(0),</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :    fUpperTrunc(0),</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :    fUseMax(kFALSE),</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :    fCutCrossRows(0),</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :    fCutEtaWindow(0),</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :    fCutRequireITSrefit(0),</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :    fCutMaxDcaXY(0),</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :    fCutMaxDcaZ(0),</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :    fMinMomentumMIP(0),</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :    fMaxMomentumMIP(0),</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :    fAlephParameters(),</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :    fHistNTracks(0),</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :    fHistClusterShape(0),</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :    fHistQA(0),</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :    fHistGainSector(0),</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :    fHistPadEqual(0),</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :    fHistGainMult(0),</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :    fHistTopology(0),</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :    fPIDMatrix(0),</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :    fHistdEdxMap(0),</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :    fHistdEdxMax(0),</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :    fHistdEdxTot(0),</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :    fdEdxTree(0),</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :    fBBParam(0)</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     140 </span>            :   //
<span class="lineNum">     141 </span>            :   //
<span class="lineNum">     142 </span>            :   //  
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :   SetName(name);</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :   SetTitle(title);</span>
<span class="lineNum">     145 </span>            :   //
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :   fMIP = 50.;</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :   fLowerTrunc = 0.02; // IMPORTANT CHANGE --&gt; REMOVE HARDWIRED TRUNCATION FROM TRACKER</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :   fUpperTrunc = 0.6;</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :   fUseMax = kTRUE; // IMPORTANT CHANGE FOR PbPb; standard: kFALSE;</span>
<span class="lineNum">     150 </span>            :   //
<span class="lineNum">     151 </span>            :   // define track cuts and default BB parameters for interpolation around mean
<span class="lineNum">     152 </span>            :   //
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   fCutCrossRows = 80;</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   fCutEtaWindow = 0.8;</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   fCutRequireITSrefit = kFALSE;</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   fCutMaxDcaXY = 3.5;</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   fCutMaxDcaZ  = 25.;</span>
<span class="lineNum">     158 </span>            :   // default values for MIP window selection
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :   fMinMomentumMIP = 0.4;</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :   fMaxMomentumMIP = 0.6;</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   fAlephParameters[0] = 0.07657; // the following parameters work for most of the periods and are therefore default</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   fAlephParameters[1] = 10.6654; // but they can be overwritten in the train setup of cpass0</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :   fAlephParameters[2] = 2.51466e-14;</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :   fAlephParameters[3] = 2.05379;</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   fAlephParameters[4] = 1.84288;</span>
<span class="lineNum">     166 </span>            :   //
<span class="lineNum">     167 </span>            :   // basic QA histograms - mainly for debugging purposes
<span class="lineNum">     168 </span>            :   //
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :   fHistNTracks = new TH1F(&quot;ntracks&quot;,&quot;Number of Tracks per Event; number of tracks per event; number of tracks&quot;,1001,-0.5,1000.5);</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :   fHistClusterShape = new TH1F(&quot;fHistClusterShape&quot;,&quot;cluster shape; rms meas. / rms exp.;&quot;,300,0,3);</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :   fHistQA = new TH3F(&quot;fHistQA&quot;,&quot;dEdx; momentum p (GeV); TPC signal (a.u.); pad&quot;,500,0.1,20.,500,0.,500,6,-0.5,5.5);</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :   AliTPCcalibBase::BinLogX(fHistQA);</span>
<span class="lineNum">     173 </span>            :   //
<span class="lineNum">     174 </span>            :   // gain per chamber
<span class="lineNum">     175 </span>            :   //                          MIP, sect,  pad (short,med,long,full,oroc),   run,      ncl
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :   Int_t binsGainSec[5]    = { 145,   72,    4,  10000000,   65};</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :   Double_t xminGainSec[5] = { 10., -0.5, -0.5,      -0.5, -0.5}; </span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   Double_t xmaxGainSec[5] = {300., 71.5,  3.5, 9999999.5, 64.5};</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :   TString axisNameSec[5]={&quot;Q&quot;,&quot;sector&quot;,&quot;pad type&quot;,&quot;run&quot;, &quot;ncl&quot;};</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   TString axisTitleSec[5]={&quot;Q (a.u)&quot;,&quot;sector&quot;,&quot;pad type&quot;,&quot;run&quot;,&quot;ncl&quot;};</span>
<span class="lineNum">     181 </span>            :   //
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   fHistGainSector = new THnSparseF(&quot;fHistGainSector&quot;,&quot;0:MIP, 1:sect, 2:pad, 3:run, 4:ncl&quot;, 5, binsGainSec, xminGainSec, xmaxGainSec);</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   for (Int_t iaxis=0; iaxis&lt;5;iaxis++){</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :     fHistGainSector-&gt;GetAxis(iaxis)-&gt;SetName(axisNameSec[iaxis]);</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :     fHistGainSector-&gt;GetAxis(iaxis)-&gt;SetTitle(axisTitleSec[iaxis]);</span>
<span class="lineNum">     186 </span>            :   }
<span class="lineNum">     187 </span>            :   //
<span class="lineNum">     188 </span>            :   // pad region equalization
<span class="lineNum">     189 </span>            :   //
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :   Int_t binsPadEqual[5]    = { 400, 400,    4,    5,   20};</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :   Double_t xminPadEqual[5] = { 0.001, 0.001, -0.5,    0,  -1.}; </span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :   Double_t xmaxPadEqual[5] = { 2.0, 2.0,  3.5, 13000,  +1};</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :   TString axisNamePadEqual[5]   = {&quot;dEdxRatioMax&quot;,&quot;dEdxRatioTot&quot;,&quot;padType&quot;,&quot;mult&quot;,&quot;dipAngle&quot;};</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :   TString axisTitlePadEqual[5]  = {&quot;dEdx_padRegion/mean_dEdx Qmax&quot;, &quot;dEdx_padRegion/mean_dEdx Qtot&quot;,&quot;padType&quot;,&quot;mult&quot;,&quot;tan(lambda)&quot;};</span>
<span class="lineNum">     195 </span>            :   //
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   fHistPadEqual = new THnSparseF(&quot;fHistPadEqual&quot;,&quot;0:dEdx_pad/dEdx_mean, 1:pad, 2:mult, 3:drift&quot;, 5, binsPadEqual, xminPadEqual, xmaxPadEqual);</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   for (Int_t iaxis=0; iaxis&lt;5;iaxis++){</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     fHistPadEqual-&gt;GetAxis(iaxis)-&gt;SetName(axisNamePadEqual[iaxis]);</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     fHistPadEqual-&gt;GetAxis(iaxis)-&gt;SetTitle(axisTitlePadEqual[iaxis]);</span>
<span class="lineNum">     200 </span>            :   }
<span class="lineNum">     201 </span>            :   //
<span class="lineNum">     202 </span>            :   // multiplicity dependence
<span class="lineNum">     203 </span>            :   //                    MIP Qmax, MIP Qtot,  z,  pad, vtx. contribut., ncl
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :   Int_t binsGainMult[6]    = { 145,  145,   25,    4,  100,  80};</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :   Double_t xminGainMult[6] = { 10.,  10.,    0, -0.5,    0, -0.5}; </span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :   Double_t xmaxGainMult[6] = {300., 300.,  250,  3.5, 13000, 159.5};</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :   TString axisNameMult[6]={&quot;Qmax&quot;,&quot;Qtot&quot;,&quot;drift&quot;,&quot;padtype&quot;&quot;multiplicity&quot;,&quot;ncl&quot;};</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :   TString axisTitleMult[6]={&quot;Qmax (a.u)&quot;,&quot;Qtot (a.u.)&quot;,&quot;driftlenght l (cm)&quot;,&quot;Pad Type&quot;,&quot;multiplicity&quot;,&quot;ncl&quot;};</span>
<span class="lineNum">     209 </span>            :   //
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :   fHistGainMult = new THnSparseF(&quot;fHistGainMult&quot;,&quot;MIP Qmax, MIP Qtot, z, type, vtx. contribut.&quot;, 6, binsGainMult, xminGainMult, xmaxGainMult); </span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :   for (Int_t iaxis=0; iaxis&lt;6;iaxis++){</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :     fHistGainMult-&gt;GetAxis(iaxis)-&gt;SetName(axisNameMult[iaxis]);</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     fHistGainMult-&gt;GetAxis(iaxis)-&gt;SetTitle(axisTitleMult[iaxis]);</span>
<span class="lineNum">     214 </span>            :   }
<span class="lineNum">     215 </span>            :   //
<span class="lineNum">     216 </span>            :   // dip-angle (theta or eta) and inclination angle (local phi) dependence -- absolute calibration
<span class="lineNum">     217 </span>            :   //
<span class="lineNum">     218 </span>            :   //              (0.) weighted dE/dx, (1.) 0:Qtot - 1:Qmax, (2.) tgl, (3.) 1./pT
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   Int_t binsTopology[4]        = {145,                    2,       20,  20};</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   Double_t xminTopology[4]     = { 10,                 -0.5,       -1,   0};</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :   Double_t xmaxTopology[4]     = { 300,                  1.5,       +1,   5};</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :   TString axisNameTopology[4]  = {&quot;dEdx&quot;,        &quot;QtotQmax&quot;,    &quot;tgl&quot;, &quot;1/pT&quot;};</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :   TString axisTitleTopology[4] = {&quot;dEdx&quot;,        &quot;QtotQmax&quot;,    &quot;tgl&quot;, &quot;1/pT&quot;};</span>
<span class="lineNum">     224 </span>            :   //
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :   fHistTopology = new THnF(&quot;fHistTopology&quot;, &quot;dEdx,QtotQmax,tgl, 1/pT&quot;, 4, binsTopology, xminTopology, xmaxTopology);</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   for (Int_t iaxis=0; iaxis&lt;4;iaxis++){</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :     fHistTopology-&gt;GetAxis(iaxis)-&gt;SetName(axisNameTopology[iaxis]);</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :     fHistTopology-&gt;GetAxis(iaxis)-&gt;SetTitle(axisTitleTopology[iaxis]);</span>
<span class="lineNum">     229 </span>            :   }
<span class="lineNum">     230 </span>            :   //
<span class="lineNum">     231 </span>            :   // MI suggestion for all dEdx histograms we shpuld keep log scale - to have the same relative resolution
<span class="lineNum">     232 </span>            :   //
<span class="lineNum">     233 </span>            :   // e.g: I want to enable -   AliTPCcalibBase::BinLogX(fHistTopology-&gt;GetAxis(0));
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            :   //
<span class="lineNum">     236 </span>            :   //
<span class="lineNum">     237 </span>            :   //                    dedx maps - bigger granulatity in phi -
<span class="lineNum">     238 </span>            :   //                                to construct the dedx sector/phi map
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :   Int_t    binsGainMap[4]  = { 100,  90,             10,   6};</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :   Double_t xminGainMap[4]  = { 0.3,  -TMath::Pi(),    0,   0}; </span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :   Double_t xmaxGainMap[4]  = {   2,  TMath::Pi(),     1,   6};</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :   TString  axisNameMap[4]  = {&quot;Q_Qexp&quot;,&quot;phi&quot;,      &quot;1/Qexp&quot;,&quot;Pad Type&quot;};</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :   TString  axisTitleMap[4] = {&quot;Q/Q_{exp}&quot;,&quot;#phi (a.u.)&quot;,&quot;1/Q_{exp}&quot;,&quot;Pad Type&quot;};</span>
<span class="lineNum">     244 </span>            :   //
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :   fHistdEdxMap = new THnSparseF(&quot;fHistdEdxMap&quot;,&quot;fHistdEdxMap&quot;, 4, binsGainMap, xminGainMap, xmaxGainMap); </span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :   for (Int_t iaxis=0; iaxis&lt;4;iaxis++){</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     fHistdEdxMap-&gt;GetAxis(iaxis)-&gt;SetName(axisNameMap[iaxis]);</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :     fHistdEdxMap-&gt;GetAxis(iaxis)-&gt;SetTitle(axisTitleMap[iaxis]);</span>
<span class="lineNum">     249 </span>            :   }
<span class="lineNum">     250 </span>            :   //
<span class="lineNum">     251 </span>            :   //
<span class="lineNum">     252 </span>            :   //
<span class="lineNum">     253 </span>            :   //                    dedx maps
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :   Int_t    binsGainMax[6]  = { 100,  10,  10,   10, 5,     3};</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :   Double_t xminGainMax[6]  = { 0.5,   0,   0,    0, 0,     0}; </span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :   Double_t xmaxGainMax[6]  = { 1.5,   1, 1.0,  1.0, 3000,  3};</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :   TString  axisNameMax[6]  = {&quot;Q_Qexp&quot;,&quot;1/Qexp&quot;,  &quot;phi&quot;,&quot;theta&quot;,&quot;mult&quot;, &quot;Pad Type&quot;};</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :   TString  axisTitleMax[6] = {&quot;Q/Q_{exp}&quot;,&quot;1/Qexp&quot;, &quot;#phi&quot;,&quot;#theta&quot;,&quot;mult&quot;,&quot;Pad Type&quot;};</span>
<span class="lineNum">     259 </span>            :   //
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :   fHistdEdxMax = new THnSparseF(&quot;fHistdEdxMax&quot;,&quot;fHistdEdxMax&quot;, 6, binsGainMax, xminGainMax, xmaxGainMax); </span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :   fHistdEdxTot = new THnSparseF(&quot;fHistdEdxTot&quot;,&quot;fHistdEdxTot&quot;, 6, binsGainMax, xminGainMax, xmaxGainMax); </span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :   for (Int_t iaxis=0; iaxis&lt;6;iaxis++){</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :     fHistdEdxMax-&gt;GetAxis(iaxis)-&gt;SetName(axisNameMax[iaxis]);</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     fHistdEdxMax-&gt;GetAxis(iaxis)-&gt;SetTitle(axisTitleMax[iaxis]);</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     fHistdEdxTot-&gt;GetAxis(iaxis)-&gt;SetName(axisNameMax[iaxis]);</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     fHistdEdxTot-&gt;GetAxis(iaxis)-&gt;SetTitle(axisTitleMax[iaxis]);</span>
<span class="lineNum">     267 </span>            :   }
<span class="lineNum">     268 </span>            :   //
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :   AliDebug(5,&quot;Non Default Constructor&quot;);  </span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 : }</span>
<a name="271"><span class="lineNum">     271 </span>            : </a>
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineNoCov">          0 : AliTPCcalibGainMult::~AliTPCcalibGainMult(){</span>
<span class="lineNum">     274 </span>            :   //
<span class="lineNum">     275 </span>            :   // Destructor
<span class="lineNum">     276 </span>            :   //
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   delete fHistNTracks;            //  histogram showing number of ESD tracks per event</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   delete fHistClusterShape;       //  histogram to check the cluster shape</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   delete fHistQA;                 //  dE/dx histogram showing the final spectrum</span>
<span class="lineNum">     280 </span>            :   //
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :   delete fHistGainSector;   //  histogram which shows MIP peak for each of the 3x36 sectors (pad region)</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :   delete fHistPadEqual;     //  histogram for the equalization of the gain in the different pad regions -&gt; pass0</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :   delete fHistGainMult;     //  histogram which shows decrease of MIP signal as a function</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :   delete fHistTopology;</span>
<span class="lineNum">     285 </span>            :   //
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :   delete fHistdEdxMap;</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :   delete fHistdEdxMax;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   delete fHistdEdxTot;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   delete fdEdxTree;</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :   if (fBBParam) delete fBBParam;</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     292 </span>            : 
<a name="293"><span class="lineNum">     293 </span>            : </a>
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span>            : void AliTPCcalibGainMult::Process(AliESDEvent *event) {
<span class="lineNum">     296 </span>            :   //
<span class="lineNum">     297 </span>            :   // Main function of the class
<span class="lineNum">     298 </span>            :   // 1. Select Identified  particles - for identified particles the flag in the PID matrix is stored
<span class="lineNum">     299 </span>            :   //    1.a) ProcessV0s  - select Electron (gamma coversion) and pion canditates (from K0s) 
<span class="lineNum">     300 </span>            :   //    1.b) ProcessTOF  - select - Proton, kaon and pions candidates
<span class="lineNum">     301 </span>            :   //                       AS THE TOF not calibrated yet in Pass0 - we are calibrating the TOF T0 in this function    
<span class="lineNum">     302 </span>            :   //    1.c) ProcessCosmic - select cosmic mumn candidates   - too few entries - not significant for the calibration
<span class="lineNum">     303 </span>            :   //    1.d) ProcessKinks - select Kaon and pion candidates. From our experience (see Kink debug streamer), the angular cut for kink daughter is not sufficient - big contamination - delta rays, hadronic  interaction (proton)
<span class="lineNum">     304 </span>            :   //          - NOT USED for the 
<span class="lineNum">     305 </span>            :   //  
<span class="lineNum">     306 </span>            :   // 2. Loop over tracks   
<span class="lineNum">     307 </span>            :   //     2.a DumpTrack() - for identified particles dump the track and dEdx information into the tree (for later fitting)
<span class="lineNum">     308 </span>            :   // 3. Actual fitting for the moment macro
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span>            :   //
<span class="lineNum">     311 </span>            :   // Criteria for the track selection
<span class="lineNum">     312 </span>            :   //
<span class="lineNum">     313 </span>            :   //  const Int_t kMinNCL=80;     // minimal number of cluster  - tracks accepted for the dedx calibration
<span class="lineNum">     314 </span>            :   //const Double_t kMaxEta=0.8; // maximal eta fo the track to be accepted
<span class="lineNum">     315 </span>            :   //const Double_t kMaxDCAR=10; // maximal DCA R of the track
<span class="lineNum">     316 </span>            :   //const Double_t kMaxDCAZ=5;  // maximal DCA Z of the track
<span class="lineNum">     317 </span>            :   //  const Double_t kMIPPt=0.525; // MIP pt
<span class="lineNum">     318 </span>            :   
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :   if (!event) {</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     Printf(&quot;ERROR: ESD not available&quot;);</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     322 </span>            :   }  
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :   fCurrentEvent=event  ;</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :   fMagF = event-&gt;GetMagneticField();</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :   Int_t ntracks=event-&gt;GetNumberOfTracks();  </span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   AliESDfriend *esdFriend=static_cast&lt;AliESDfriend*&gt;(event-&gt;FindListObject(&quot;AliESDfriend&quot;));</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :   if (!esdFriend) {</span>
<span class="lineNum">     328 </span>            :     //Printf(&quot;ERROR: esdFriend not available&quot;);
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :     delete fPIDMatrix;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     331 </span>            :   }
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :   if (!(esdFriend-&gt;TestSkipBit())) fPIDMatrix= new TMatrixD(ntracks,5);</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   fHistNTracks-&gt;Fill(ntracks);</span>
<span class="lineNum">     334 </span>            :   //  ProcessCosmic(event);  // usually not enogh statistic
<span class="lineNum">     335 </span>            : 
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :   if (esdFriend-&gt;TestSkipBit()) {</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     338 </span>            :    }
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :   AliTPCParam     *param     = AliTPCcalibDB::Instance()-&gt;GetParameters();</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :   if (!param)  {</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :     Printf(&quot;ERROR: AliTPCParam not available&quot;);</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     344 </span>            :   }
<span class="lineNum">     345 </span>            : 
<span class="lineNum">     346 </span>            :   // CookdEdxAnalytical requires the time stamp in AliTPCTransform to be set
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :   AliTPCTransform *transform = AliTPCcalibDB::Instance()-&gt;GetTransform() ;</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentRun(fRun);</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentTimeStamp((UInt_t)fTime);</span>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :   const Int_t row0 = param-&gt;GetNRowLow();</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :   const Int_t row1 = row0+param-&gt;GetNRowUp1();</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :   const Int_t row2 = row1+param-&gt;GetNRowUp2();</span>
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            :   //
<span class="lineNum">     356 </span>            :   //ProcessV0s(event);   // 
<span class="lineNum">     357 </span>            :   //ProcessTOF(event);   //
<span class="lineNum">     358 </span>            :   //ProcessKinks(event); // not relyable
<span class="lineNum">     359 </span>            :   //DumpHPT(event);      // 
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   UInt_t runNumber = event-&gt;GetRunNumber();</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :   Int_t nContributors = event-&gt;GetNumberOfTracks();</span>
<span class="lineNum">     362 </span>            :   //
<span class="lineNum">     363 </span>            :   // track loop
<span class="lineNum">     364 </span>            :   //
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;ntracks;++i) {</span>
<span class="lineNum">     366 </span>            :     //
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     AliESDtrack *track = event-&gt;GetTrack(i);</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     if (!track) continue;</span>
<span class="lineNum">     369 </span>            :     //   
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :     AliExternalTrackParam * trackIn  = (AliExternalTrackParam *)track-&gt;GetInnerParam();</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :     if (!trackIn) continue;</span>
<span class="lineNum">     372 </span>            :   
<span class="lineNum">     373 </span>            :     // calculate necessary track parameters
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :     Double_t meanP = trackIn-&gt;GetP();</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     Int_t ncls = track-&gt;GetTPCNcls();</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     Int_t nCrossedRows = track-&gt;GetTPCCrossedRows();</span>
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span>            :     // correction factor of dE/dx in MIP window
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :     Float_t corrFactorMip = AliExternalTrackParam::BetheBlochAleph(meanP/0.13957, </span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :                                                                    fAlephParameters[0], </span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :                                                                    fAlephParameters[1], </span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :                                                                    fAlephParameters[2], </span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :                                                                    fAlephParameters[3],</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :                                                                    fAlephParameters[4]);</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :     if (TMath::Abs(corrFactorMip) &lt; 1e-10) continue;</span>
<span class="lineNum">     386 </span>            :     
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     if (nCrossedRows &lt; fCutCrossRows) continue;     </span>
<span class="lineNum">     388 </span>            :     // exclude tracks which do not look like primaries or are simply too short or on wrong sectors
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :     if (TMath::Abs(trackIn-&gt;Eta()) &gt; fCutEtaWindow) continue;</span>
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     UInt_t status = track-&gt;GetStatus();</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     if ((status&amp;AliESDtrack::kTPCrefit)==0) continue;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     if ((status&amp;AliESDtrack::kITSrefit)==0 &amp;&amp; fCutRequireITSrefit) continue; // ITS cluster</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     Float_t dca[2], cov[3];</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     track-&gt;GetImpactParameters(dca,cov);</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :     Float_t primVtxDCA = TMath::Sqrt(dca[0]*dca[0]);</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     if (TMath::Abs(dca[0]) &gt; fCutMaxDcaXY || TMath::Abs(dca[0]) &lt; 0.0000001) continue;  // cut in xy</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     if (((status&amp;AliESDtrack::kITSrefit) == 1 &amp;&amp; TMath::Abs(dca[1]) &gt; 3.) || TMath::Abs(dca[1]) &gt; fCutMaxDcaZ ) continue;</span>
<span class="lineNum">     399 </span>            :     //
<span class="lineNum">     400 </span>            :     //  
<span class="lineNum">     401 </span>            :     // fill Alexander QA histogram
<span class="lineNum">     402 </span>            :     //
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :     if (primVtxDCA &lt; 3 &amp;&amp; track-&gt;GetNcls(0) &gt; 3 &amp;&amp; track-&gt;GetKinkIndex(0) == 0 &amp;&amp; ncls &gt; 100) fHistQA-&gt;Fill(meanP, track-&gt;GetTPCsignal(), 5);</span>
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span>            :     // Get seeds
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :     AliESDfriendTrack *friendTrack = (AliESDfriendTrack*)track-&gt;GetFriendTrack();//esdFriend-&gt;GetTrack(i);</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     if (!friendTrack) continue;</span>
<span class="lineNum">     408 </span>            :     TObject *calibObject;
<span class="lineNum">     409 </span>            :     AliTPCseed *seed = 0;
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :     for (Int_t l=0;(calibObject=friendTrack-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :       if ((seed=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">     412 </span>            :     }    
<span class="lineNum">     413 </span>            :     //if (seed) DumpTrack(track, friendTrack,seed,i); // MI implementation for the identified particles
<span class="lineNum">     414 </span>            :     //
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     if (seed) { // seed the container with track parameters and the clusters</span>
<span class="lineNum">     416 </span>            :       // 
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :       const AliExternalTrackParam * trackOut = friendTrack-&gt;GetTPCOut();  // tack at the outer radius of TPC</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :       if (!trackIn) continue;</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :       if (!trackOut) continue;</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :       Double_t meanDrift = 250 - 0.5*TMath::Abs(trackIn-&gt;GetZ() + trackOut-&gt;GetZ());</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :       Double_t dipAngleTgl  = trackIn-&gt;GetTgl();</span>
<span class="lineNum">     422 </span>            :       //
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :       for (Int_t irow =0; irow&lt;kMaxRow;irow++)    {</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :         const AliTPCTrackerPoints::Point * point = seed-&gt;GetTrackPoint(irow);</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :         if (point==0) continue;</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :         AliTPCclusterMI * cl = seed-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :         if (cl==0) continue;</span>
<span class="lineNum">     428 </span>            :         //
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         Float_t rsigmay =  TMath::Sqrt(point-&gt;GetSigmaY());</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :         fHistClusterShape-&gt;Fill(rsigmay);</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :       Double_t signalShortMax = seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,1,0,row0);</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :       Double_t signalMedMax   = seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,1,row0,row1);</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :       Double_t signalLongMax  = seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,1,row1,row2);</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :       Double_t signalMax      = seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,1,0,row2);</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :       Double_t signalArrayMax[4] = {signalShortMax, signalMedMax, signalLongMax, signalMax};</span>
<span class="lineNum">     441 </span>            :       //
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :       Double_t signalShortTot = seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,0,0,row0);</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :       Double_t signalMedTot   = seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,0,row0,row1);</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :       Double_t signalLongTot  = seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,0,row1,row2);</span>
<span class="lineNum">     445 </span>            :       //
<span class="lineNum">     446 </span>            :       Double_t signalTot      = 0;
<span class="lineNum">     447 </span>            :       //
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :       Double_t signalArrayTot[4] = {signalShortTot, signalMedTot, signalLongTot, signalTot};</span>
<span class="lineNum">     449 </span>            :       //
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :       Double_t mipSignalShort = fUseMax ? signalShortMax : signalShortTot;</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :       Double_t mipSignalMed   = fUseMax ? signalMedMax   : signalMedTot;</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :       Double_t mipSignalLong  = fUseMax ? signalLongMax  : signalLongTot;</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :       Double_t mipSignalOroc  = seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,fUseMax,row0,row2);</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :       Double_t signal =  fUseMax ? signalMax  : signalTot;</span>
<span class="lineNum">     455 </span>            :       //
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :       fHistQA-&gt;Fill(meanP, mipSignalShort, 0);</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :       fHistQA-&gt;Fill(meanP, mipSignalMed, 1);</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :       fHistQA-&gt;Fill(meanP, mipSignalLong, 2);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :       fHistQA-&gt;Fill(meanP, signal, 3);</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :       fHistQA-&gt;Fill(meanP, mipSignalOroc, 4);</span>
<span class="lineNum">     461 </span>            :       //
<span class="lineNum">     462 </span>            :       // normalize pad regions to their common mean
<span class="lineNum">     463 </span>            :       //
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :       Float_t meanMax = (63./kMaxRow)*signalArrayMax[0] + (64./kMaxRow)*signalArrayMax[1] + (32./kMaxRow)*signalArrayMax[2];</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :       Float_t meanTot = (63./kMaxRow)*signalArrayTot[0] + (64./kMaxRow)*signalArrayTot[1] + (32./kMaxRow)*signalArrayTot[2]; </span>
<span class="lineNum">     466 </span>            :       //MY SUGGESTION COMMENT NEXT LINE
<span class="lineNum">     467 </span>            :       //      if (meanMax &lt; 1e-5 || meanTot &lt; 1e-5) continue;      
<span class="lineNum">     468 </span>            :       //AND INTRODUCE NEW LINE
<span class="lineNum">     469 </span>            :       // 
<span class="lineNum">     470 </span>            :       const Double_t kMinAmp=0.001;
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :       if (signalArrayMax[0]&lt;=kMinAmp) continue;</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :       if (signalArrayMax[1]&lt;=kMinAmp) continue;</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :       if (signalArrayMax[2]&lt;=kMinAmp) continue;</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :       if (signalArrayTot[0]&lt;=kMinAmp) continue;</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :       if (signalArrayTot[1]&lt;=kMinAmp) continue;</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :       if (signalArrayTot[2]&lt;=kMinAmp) continue;</span>
<span class="lineNum">     477 </span>            :       //
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :       for(Int_t ipad = 0; ipad &lt; 4; ipad ++) {</span>
<span class="lineNum">     479 </span>            :         // &quot;dEdxRatioMax&quot;,&quot;dEdxRatioTot&quot;,&quot;padType&quot;,&quot;mult&quot;,&quot;driftlength&quot;
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :         Double_t vecPadEqual[5] = {signalArrayMax[ipad]/meanMax, signalArrayTot[ipad]/meanTot,  static_cast&lt;Double_t&gt;(ipad),  static_cast&lt;Double_t&gt;(nContributors), dipAngleTgl};</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :         if (fMinMomentumMIP &gt; meanP &amp;&amp; meanP &lt; fMaxMomentumMIP) fHistPadEqual-&gt;Fill(vecPadEqual);</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     483 </span>            :       //
<span class="lineNum">     484 </span>            :       //
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :       if (meanP &lt; fMaxMomentumMIP &amp;&amp; meanP &gt; fMinMomentumMIP) {</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :         Double_t vecMult[6] = {seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,1,0,row2)/corrFactorMip,</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :                                seed-&gt;CookdEdxAnalytical(fLowerTrunc,fUpperTrunc,0,0,row2)/corrFactorMip,</span>
<span class="lineNum">     488 </span>            :                                meanDrift,
<span class="lineNum">     489 </span>            :                                3,
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :                                static_cast&lt;Double_t&gt;(nContributors),</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :                                static_cast&lt;Double_t&gt;(ncls)};</span>
<span class="lineNum">     492 </span>            :         //
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :         fHistGainMult-&gt;Fill(vecMult);</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :         vecMult[0]=mipSignalShort/corrFactorMip; vecMult[1]=mipSignalShort/corrFactorMip; vecMult[3]=0;</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :         fHistGainMult-&gt;Fill(vecMult);</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :         vecMult[0]=mipSignalMed/corrFactorMip; vecMult[1]=mipSignalMed/corrFactorMip; vecMult[3]=1;</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :         fHistGainMult-&gt;Fill(vecMult);</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :         vecMult[0]=mipSignalLong/corrFactorMip; vecMult[1]=mipSignalLong/corrFactorMip; vecMult[3]=2;</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :         fHistGainMult-&gt;Fill(vecMult);</span>
<span class="lineNum">     500 </span>            :         //
<span class="lineNum">     501 </span>            :         // topology histogram (absolute)
<span class="lineNum">     502 </span>            :         //                        (0.) weighted dE/dx, (1.) 0:Qtot - 1:Qmax, (2.) tgl, (3.) 1./pT
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :         Double_t vecTopolTot[4] = {meanTot, 0, dipAngleTgl, TMath::Abs(track-&gt;GetSigned1Pt())};</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :         Double_t vecTopolMax[4] = {meanMax, 1, dipAngleTgl, TMath::Abs(track-&gt;GetSigned1Pt())};</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :         fHistTopology-&gt;Fill(vecTopolTot);</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :         fHistTopology-&gt;Fill(vecTopolMax);</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     508 </span>            :       //
<span class="lineNum">     509 </span>            :       //
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :       if (fMinMomentumMIP &lt; meanP || meanP &gt; fMaxMomentumMIP) continue;  // only MIP pions</span>
<span class="lineNum">     511 </span>            :       //if (meanP &gt; 0.5 || meanP &lt; 0.4) continue; // only MIP pions
<span class="lineNum">     512 </span>            :       //
<span class="lineNum">     513 </span>            :       // for each track, we look at the three different pad regions, split it into tracklets, check if the sector does not change and fill the histogram
<span class="lineNum">     514 </span>            :       //
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :       Bool_t isNotSplit[3] = {kTRUE, kTRUE, kTRUE}; //  short, medium, long (true if the track is not split between two chambers)</span>
<span class="lineNum">     516 </span>            :       //
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :       Double_t sector[4] = {-1, -1, -1, -1}; // sector number short, medium, long, all</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :       Int_t ncl[3] = {0,0,0};</span>
<span class="lineNum">     519 </span>            :       //
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :       for (Int_t irow=0; irow &lt; kMaxRow; irow++){</span>
<span class="lineNum">     522 </span>            :         Int_t padRegion = 0;
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :         if (irow &gt; 62) padRegion = 1;</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :         if (irow &gt; 126) padRegion = 2;</span>
<span class="lineNum">     525 </span>            :         //
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :         AliTPCclusterMI* cluster = seed-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :         if (!cluster) continue;</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :         if (sector[padRegion] == -1) {</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :           sector[padRegion] = cluster-&gt;GetDetector();</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     531 </span>            :         }
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :         if (sector[padRegion] != -1 &amp;&amp; sector[padRegion] != cluster-&gt;GetDetector()) isNotSplit[padRegion] = kFALSE;</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :         ncl[padRegion]++;</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     535 </span>            :       //
<span class="lineNum">     536 </span>            :       //                        MIP, sect,  pad,   run
<span class="lineNum">     537 </span>            :       //
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :       Double_t vecMip[5] = {mipSignalShort/corrFactorMip, mipSignalMed/corrFactorMip, mipSignalLong/corrFactorMip, signal/corrFactorMip, mipSignalOroc/corrFactorMip};</span>
<span class="lineNum">     539 </span>            :       //
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :       for(Int_t ipad = 0; ipad &lt; 3; ipad++) {</span>
<span class="lineNum">     541 </span>            :         // AK. -  run Number To be removed - not needed 
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :         Double_t vecGainSec[5] = {vecMip[ipad], sector[ipad],  static_cast&lt;Double_t&gt;(ipad),  static_cast&lt;Double_t&gt;(runNumber),  static_cast&lt;Double_t&gt;(ncl[ipad])};</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :         if (isNotSplit[ipad]) fHistGainSector-&gt;Fill(vecGainSec);</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     546 </span>            :    
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :   }    </span>
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :   delete fPIDMatrix;</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 : }  </span>
<a name="551"><span class="lineNum">     551 </span>            : </a>
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span>            : void AliTPCcalibGainMult::MakeLookup(THnSparse * /*hist*/, Char_t * /*outputFile*/) {
<span class="lineNum">     554 </span>            :   //
<span class="lineNum">     555 </span>            :   // Not  yet implemented
<span class="lineNum">     556 </span>            :   //
<span class="lineNum">     557 </span><span class="lineNoCov">          0 : }</span>
<a name="558"><span class="lineNum">     558 </span>            : </a>
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span>            : void AliTPCcalibGainMult::Analyze() {
<span class="lineNum">     561 </span>            :   //
<span class="lineNum">     562 </span>            :   // Not implemented
<span class="lineNum">     563 </span>            :   //
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :   return;</span>
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span>            : }
<a name="568"><span class="lineNum">     568 </span>            : </a>
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span>            : Long64_t AliTPCcalibGainMult::Merge(TCollection *li) {
<span class="lineNum">     571 </span>            :   //
<span class="lineNum">     572 </span>            :   // merging of the component
<span class="lineNum">     573 </span>            :   //
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span>            :   const Int_t kMaxEntriesSparse=2000000; // MI- temporary - restrict the THnSparse size
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :   TIterator* iter = li-&gt;MakeIterator();</span>
<span class="lineNum">     577 </span>            :   AliTPCcalibGainMult* cal = 0;
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :   while ((cal = (AliTPCcalibGainMult*)iter-&gt;Next())) {</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :     if (!cal-&gt;InheritsFrom(AliTPCcalibGainMult::Class())) {</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :       Error(&quot;Merge&quot;,&quot;Attempt to add object of class %s to a %s&quot;, cal-&gt;ClassName(), this-&gt;ClassName());</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :       return -1;</span>
<span class="lineNum">     583 </span>            :     }
<span class="lineNum">     584 </span>            :     
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :     if (cal-&gt;GetHistNTracks()) fHistNTracks-&gt;Add(cal-&gt;GetHistNTracks());</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :     if (cal-&gt;GetHistClusterShape()) fHistClusterShape-&gt;Add(cal-&gt;GetHistClusterShape());</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :     if (cal-&gt;GetHistQA()) fHistQA-&gt;Add(cal-&gt;GetHistQA());</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :     if (cal-&gt;GetHistGainSector() &amp;&amp; fHistGainSector )</span>
<span class="lineNum">     589 </span>            :     { 
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :       if ((fHistGainSector-&gt;GetEntries()+cal-&gt;GetHistGainSector()-&gt;GetEntries()) &lt; fgMergeEntriesCut)</span>
<span class="lineNum">     591 </span>            :       {        
<span class="lineNum">     592 </span>            :         //AliInfo(Form(&quot;fHistGainSector has %.0f tracks, going to add %.0f\n&quot;,fHistGainSector-&gt;GetEntries(),cal-&gt;GetHistGainSector()-&gt;GetEntries()));
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :         fHistGainSector-&gt;Add(cal-&gt;GetHistGainSector());</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     595 </span>            :       else 
<span class="lineNum">     596 </span>            :       { 
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :         AliInfo(Form(&quot;fHistGainSector full (has %.0f entries, trying to add %.0f., max allowed: %.0f)&quot;,</span>
<span class="lineNum">     598 </span>            :         fHistGainSector-&gt;GetEntries(),cal-&gt;GetHistGainSector()-&gt;GetEntries(),fgMergeEntriesCut));
<span class="lineNum">     599 </span>            :       }
<span class="lineNum">     600 </span>            :     }
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :     if (cal-&gt;GetHistPadEqual()) fHistPadEqual-&gt;Add(cal-&gt;GetHistPadEqual());</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :     if (cal-&gt;GetHistGainMult()) {</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :        if (fHistGainMult-&gt;GetEntries()&lt;kMaxEntriesSparse) fHistGainMult-&gt;Add(cal-&gt;GetHistGainMult());</span>
<span class="lineNum">     604 </span>            :     } 
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :     if (cal-&gt;GetHistTopology()) {</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :        fHistTopology-&gt;Add(cal-&gt;GetHistTopology());</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     } </span>
<span class="lineNum">     608 </span>            :     //
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :     if (cal-&gt;fHistdEdxMap){</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :       if (fHistdEdxMap) fHistdEdxMap-&gt;Add(cal-&gt;fHistdEdxMap);</span>
<span class="lineNum">     611 </span>            :     }
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     if (cal-&gt;fHistdEdxMax){</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :       if (fHistdEdxMax) fHistdEdxMax-&gt;Add(cal-&gt;fHistdEdxMax);</span>
<span class="lineNum">     614 </span>            :     }
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :     if (cal-&gt;fHistdEdxTot){</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :       if (fHistdEdxTot) fHistdEdxTot-&gt;Add(cal-&gt;fHistdEdxTot);</span>
<span class="lineNum">     617 </span>            :     }
<span class="lineNum">     618 </span>            :     // 
<span class="lineNum">     619 </span>            :     // Originally we tireied to write the tree to the same file as other calibration components
<span class="lineNum">     620 </span>            :     // We failed in merging =&gt; therefore this optio  was disabled
<span class="lineNum">     621 </span>            :     //
<span class="lineNum">     622 </span>            :     //    if (cal-&gt;fdEdxTree &amp;&amp; cal-&gt;fdEdxTree-&gt;GetEntries()&gt;0) {
<span class="lineNum">     623 </span>            :     //       if (fdEdxTree) {
<span class="lineNum">     624 </span>            :     //  const Int_t kMax=100000;
<span class="lineNum">     625 </span>            :     //  Int_t entriesSum = (Int_t)fdEdxTree-&gt;GetEntries();
<span class="lineNum">     626 </span>            :     //  Int_t entriesCurrent = (Int_t)cal-&gt;fdEdxTree-&gt;GetEntries();
<span class="lineNum">     627 </span>            :     //  Int_t entriesCp=TMath::Min((Int_t) entriesCurrent*(kMax*entriesSum),entriesCurrent);
<span class="lineNum">     628 </span>            :     // //       cal-&gt;fdEdxTree-&gt;SetBranchStatus(&quot;track*&quot;,0);
<span class="lineNum">     629 </span>            :     // //       cal-&gt;fdEdxTree-&gt;SetBranchStatus(&quot;vertex*&quot;,0);
<span class="lineNum">     630 </span>            :     // //       cal-&gt;fdEdxTree-&gt;SetBranchStatus(&quot;tpcOut*&quot;,0);
<span class="lineNum">     631 </span>            :     // //       cal-&gt;fdEdxTree-&gt;SetBranchStatus(&quot;vec*&quot;,0);
<span class="lineNum">     632 </span>            :     // //       fdEdxTree-&gt;SetBranchStatus(&quot;track*&quot;,0);
<span class="lineNum">     633 </span>            :     // //       fdEdxTree-&gt;SetBranchStatus(&quot;vertex*&quot;,0);
<span class="lineNum">     634 </span>            :     // //       fdEdxTree-&gt;SetBranchStatus(&quot;tpcOut*&quot;,0);
<span class="lineNum">     635 </span>            :     // //       fdEdxTree-&gt;SetBranchStatus(&quot;vec*&quot;,0);
<span class="lineNum">     636 </span>            :     //  fdEdxTree-&gt;Print();
<span class="lineNum">     637 </span>            :     //  fdEdxTree-&gt;Dump();
<span class="lineNum">     638 </span>            :     //  fdEdxTree-&gt;GetEntry(0);
<span class="lineNum">     639 </span>            :     //  for (Int_t i=0; i&lt;entriesCurrent; i++){
<span class="lineNum">     640 </span>            :     //    cal-&gt;fdEdxTree-&gt;CopyAddresses(fdEdxTree);
<span class="lineNum">     641 </span>            :     //    cal-&gt;fdEdxTree-&gt;GetEntry(i);
<span class="lineNum">     642 </span>            :     //    fdEdxTree-&gt;Fill();
<span class="lineNum">     643 </span>            :     //  }                    
<span class="lineNum">     644 </span>            :     //  TObjArray *brarray =  cal-&gt;fdEdxTree-&gt;GetListOfBranches(); 
<span class="lineNum">     645 </span>            :     //  for (Int_t i=0; i&lt;brarray-&gt;GetEntries(); i++) {TBranch * br = (TBranch *)brarray-&gt;At(i); br-&gt;SetAddress(0); }      
<span class="lineNum">     646 </span>            :     //       }
<span class="lineNum">     647 </span>            :     //       else{
<span class="lineNum">     648 </span>            :     //  fdEdxTree = (TTree*)(cal-&gt;fdEdxTree-&gt;Clone());
<span class="lineNum">     649 </span>            :     //  TObjArray *brarray =  fdEdxTree-&gt;GetListOfBranches(); 
<span class="lineNum">     650 </span>            :     //  for (Int_t i=0; i&lt;brarray-&gt;GetEntries(); i++) {TBranch * br = (TBranch *)brarray-&gt;At(i); br-&gt;SetAddress(0);}        
<span class="lineNum">     651 </span>            :     //       }
<span class="lineNum">     652 </span>            :     //}
<span class="lineNum">     653 </span>            :     
<span class="lineNum">     654 </span>            :   }
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :   delete iter;</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     657 </span>            :   
<span class="lineNum">     658 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span>            : 
<a name="662"><span class="lineNum">     662 </span>            : </a>
<span class="lineNum">     663 </span>            : 
<span class="lineNum">     664 </span>            : void AliTPCcalibGainMult::UpdateGainMap() {
<span class="lineNum">     665 </span>            :   //
<span class="lineNum">     666 </span>            :   // read in the old gain map and scale it appropriately...
<span class="lineNum">     667 </span>            :   //
<span class="lineNum">     668 </span>            :   /*
<span class="lineNum">     669 </span>            :   gSystem-&gt;Load(&quot;libANALYSIS&quot;);
<span class="lineNum">     670 </span>            :   gSystem-&gt;Load(&quot;libTPCcalib&quot;);
<span class="lineNum">     671 </span>            :   //
<span class="lineNum">     672 </span>            :   TFile jj(&quot;Run0_999999999_v1_s0.root&quot;);
<span class="lineNum">     673 </span>            :   AliTPCCalPad * pad = AliCDBEntry-&gt;GetObject()-&gt;Clone();
<span class="lineNum">     674 </span>            :   TFile hh(&quot;output.root&quot;);
<span class="lineNum">     675 </span>            :   AliTPCcalibGainMult * gain = calibTracksGain;
<span class="lineNum">     676 </span>            :   TH2D * histGainSec = gain-&gt;GetHistGainSector()-&gt;Projection(0,1);
<span class="lineNum">     677 </span>            :   //
<span class="lineNum">     678 </span>            :   TObjArray arr;
<span class="lineNum">     679 </span>            :   histGainSec-&gt;FitSlicesY(0, 0, -1, 0, &quot;QNR&quot;, &amp;arr);
<span class="lineNum">     680 </span>            :   TH1D * meanGainSec = arr-&gt;At(1);
<span class="lineNum">     681 </span>            :   Double_t gainsIROC[36];
<span class="lineNum">     682 </span>            :   Double_t gainsOROC[36];
<span class="lineNum">     683 </span>            :   Double_t gains[72];
<span class="lineNum">     684 </span>            :   //
<span class="lineNum">     685 </span>            :   for(Int_t isec = 1; isec &lt; meanGainSec-&gt;GetNbinsX() + 1; isec++) {
<span class="lineNum">     686 </span>            :     cout &lt;&lt; isec &lt;&lt; &quot; &quot; &lt;&lt; meanGainSec-&gt;GetXaxis()-&gt;GetBinCenter(isec) &lt;&lt; &quot; &quot; &lt;&lt;meanGainSec-&gt;GetBinContent(isec) &lt;&lt; endl;
<span class="lineNum">     687 </span>            :     gains[isec-1] = meanGainSec-&gt;GetBinContent(isec);
<span class="lineNum">     688 </span>            :     if (isec &lt; 37) {
<span class="lineNum">     689 </span>            :       gainsIROC[isec-1] = meanGainSec-&gt;GetBinContent(isec);
<span class="lineNum">     690 </span>            :     } else {
<span class="lineNum">     691 </span>            :       gainsOROC[isec - 36 -1] = meanGainSec-&gt;GetBinContent(isec);
<span class="lineNum">     692 </span>            :     }
<span class="lineNum">     693 </span>            :   }
<span class="lineNum">     694 </span>            :   Double_t meanIroc = TMath::Mean(36, gainsIROC);
<span class="lineNum">     695 </span>            :   Double_t meanOroc = TMath::Mean(36, gainsIROC);
<span class="lineNum">     696 </span>            :   for(Int_t i = 0; i &lt; 36; i++) gains[i] /= meanIroc;
<span class="lineNum">     697 </span>            :   for(Int_t i = 36; i &lt; 72; i++) gains[i] /= meanOroc;
<span class="lineNum">     698 </span>            :   //
<span class="lineNum">     699 </span>            :   for(Int_t i = 0; i &lt; 72; i++) {
<span class="lineNum">     700 </span>            :     AliTPCCalROC * chamber = pad-&gt;GetCalROC(i);
<span class="lineNum">     701 </span>            :     chamber-&gt;Multiply(gains[i]);
<span class="lineNum">     702 </span>            :     cout &lt;&lt; i &lt;&lt; &quot; &quot;&lt;&lt; chamber-&gt;GetMean() &lt;&lt; endl;
<span class="lineNum">     703 </span>            :   }
<span class="lineNum">     704 </span>            :   //
<span class="lineNum">     705 </span>            :   // update the OCDB
<span class="lineNum">     706 </span>            :   //
<span class="lineNum">     707 </span>            :   AliCDBMetaData *metaData= new AliCDBMetaData();
<span class="lineNum">     708 </span>            :   metaData-&gt;SetObjectClassName(&quot;AliTPCCalPad&quot;);
<span class="lineNum">     709 </span>            :   metaData-&gt;SetResponsible(&quot;Alexander Kalweit&quot;);
<span class="lineNum">     710 </span>            :   metaData-&gt;SetBeamPeriod(1);
<span class="lineNum">     711 </span>            :   metaData-&gt;SetAliRootVersion(&quot;04-19-05&quot;); //root version
<span class="lineNum">     712 </span>            :   metaData-&gt;SetComment(&quot;New gain map for 1600V OROC gain increase and equalization. Valid for runs starting after technical stop beginning of September.&quot;);
<span class="lineNum">     713 </span>            :   AliCDBId id1(&quot;TPC/Calib/GainFactorDedx&quot;, 131541, AliCDBRunRange::Infinity()); // important: new gain runs here..
<span class="lineNum">     714 </span>            :   AliCDBStorage * gStorage = AliCDBManager::Instance()-&gt;GetStorage(&quot;local:///d/alice05/akalweit/projects/OCDBupdate/HighGain_2010-09-03/OCDB/&quot;);
<span class="lineNum">     715 </span>            :   gStorage-&gt;Put(pad, id1, metaData);
<span class="lineNum">     716 </span>            :   */
<span class="lineNum">     717 </span>            :   
<a name="718"><span class="lineNum">     718 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span>            : void AliTPCcalibGainMult::UpdateClusterParam() {
<span class="lineNum">     721 </span>            :   //
<span class="lineNum">     722 </span>            :   //
<span class="lineNum">     723 </span>            :   //
<span class="lineNum">     724 </span>            :   /*
<span class="lineNum">     725 </span>            :   gSystem-&gt;Load(&quot;libANALYSIS&quot;);
<span class="lineNum">     726 </span>            :   gSystem-&gt;Load(&quot;libTPCcalib&quot;);
<span class="lineNum">     727 </span>            :   //
<span class="lineNum">     728 </span>            :   TFile ff(&quot;OldClsParam.root&quot;);
<span class="lineNum">     729 </span>            :   AliTPCClusterParam * param = AliCDBEntry-&gt;GetObject()-&gt;Clone();
<span class="lineNum">     730 </span>            :  
<span class="lineNum">     731 </span>            :   TFile hh(&quot;output.root&quot;);
<span class="lineNum">     732 </span>            :   AliTPCcalibGainMult * gain = calibGainMult;
<span class="lineNum">     733 </span>            :   TH2D * histGainSec = gain-&gt;GetHistGainSector()-&gt;Projection(0,2);
<span class="lineNum">     734 </span>            :   TObjArray arr;
<span class="lineNum">     735 </span>            :   histGainSec-&gt;FitSlicesY(0, 0, -1, 0, &quot;QNR&quot;, &amp;arr);
<span class="lineNum">     736 </span>            :   histGainSec-&gt;Draw(&quot;colz&quot;);
<span class="lineNum">     737 </span>            :   TH1D * fitVal = arr.At(1);
<span class="lineNum">     738 </span>            :   fitVal-&gt;Draw(&quot;same&quot;);
<span class="lineNum">     739 </span>            :   param-&gt;GetQnormCorrMatrix()-&gt;Print();
<span class="lineNum">     740 </span>            :   param-&gt;GetQnormCorrMatrix()(0,5) *= fitVal-&gt;GetBinContent(1)/fitVal-&gt;GetBinContent(1); // short pads Qtot
<span class="lineNum">     741 </span>            :   param-&gt;GetQnormCorrMatrix()(1,5) *= fitVal-&gt;GetBinContent(2)/fitVal-&gt;GetBinContent(1); // med pads Qtot
<span class="lineNum">     742 </span>            :   param-&gt;GetQnormCorrMatrix()(2,5) *= fitVal-&gt;GetBinContent(3)/fitVal-&gt;GetBinContent(1); // long pads Qtot
<span class="lineNum">     743 </span>            :   //
<span class="lineNum">     744 </span>            :   param-&gt;GetQnormCorrMatrix()(3,5) *= fitVal-&gt;GetBinContent(1)/fitVal-&gt;GetBinContent(1); // short pads Qmax -&gt; scaling assumed
<span class="lineNum">     745 </span>            :   param-&gt;GetQnormCorrMatrix()(4,5) *= fitVal-&gt;GetBinContent(2)/fitVal-&gt;GetBinContent(1); // med pads Qmax -&gt; scaling assumed
<span class="lineNum">     746 </span>            :   param-&gt;GetQnormCorrMatrix()(5,5) *= fitVal-&gt;GetBinContent(3)/fitVal-&gt;GetBinContent(1); // long pads Qmax -&gt; scaling assumed
<span class="lineNum">     747 </span>            :   //
<span class="lineNum">     748 </span>            :   TFile jj(&quot;newClusterParam.root&quot;,&quot;RECREATE&quot;);
<span class="lineNum">     749 </span>            :   param-&gt;Write();
<span class="lineNum">     750 </span>            :   param-&gt;GetQnormCorrMatrix()-&gt;Print();
<span class="lineNum">     751 </span>            :   //
<span class="lineNum">     752 </span>            :   // update the OCDB
<span class="lineNum">     753 </span>            :   // 
<span class="lineNum">     754 </span>            :   AliCDBMetaData *metaData= new AliCDBMetaData();
<span class="lineNum">     755 </span>            :   metaData-&gt;SetObjectClassName(&quot;AliTPCClusterParam&quot;);
<span class="lineNum">     756 </span>            :   metaData-&gt;SetResponsible(&quot;Alexander Kalweit&quot;);
<span class="lineNum">     757 </span>            :   metaData-&gt;SetBeamPeriod(1);
<span class="lineNum">     758 </span>            :   metaData-&gt;SetAliRootVersion(&quot;04-19-04&quot;); //root version
<span class="lineNum">     759 </span>            :   metaData-&gt;SetComment(&quot;1600V OROC / hard thres. / new algorithm&quot;);
<span class="lineNum">     760 </span>            :   AliCDBId id1(&quot;TPC/Calib/ClusterParam&quot;, 0, AliCDBRunRange::Infinity()); // important: new gain runs here..
<span class="lineNum">     761 </span>            :   AliCDBStorage * gStorage = AliCDBManager::Instance()-&gt;GetStorage(&quot;local:///lustre/alice/akalweit/baseline/CalibrationEntries/OldThres_NewAlgo_PP&quot;);
<span class="lineNum">     762 </span>            :   gStorage-&gt;Put(param, id1, metaData);
<span class="lineNum">     763 </span>            :   */
<span class="lineNum">     764 </span>            :   
<span class="lineNum">     765 </span>            : 
<span class="lineNum">     766 </span><span class="lineNoCov">          0 : }</span>
<a name="767"><span class="lineNum">     767 </span>            : </a>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span>            : void AliTPCcalibGainMult::DumpTrack(AliESDtrack * track, AliESDfriendTrack *ftrack, AliTPCseed * seed, Int_t index){
<span class="lineNum">     770 </span>            :   //
<span class="lineNum">     771 </span>            :   // dump interesting tracks
<span class="lineNum">     772 </span>            :   // 1. track at MIP region
<span class="lineNum">     773 </span>            :   // 2. highly ionizing protons
<span class="lineNum">     774 </span>            :   // pidType: 0 - unselected 
<span class="lineNum">     775 </span>            :   //          1 - TOF
<span class="lineNum">     776 </span>            :   //          2 - V0
<span class="lineNum">     777 </span>            :   //          4 - Cosmic
<span class="lineNum">     778 </span>            :   //          or of value
<span class="lineNum">     779 </span>            :   //
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span>            : 
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :   AliTPCParam     *param     = AliTPCcalibDB::Instance()-&gt;GetParameters();</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :   if (!param)  {</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :     Printf(&quot;ERROR: AliTPCParam not available&quot;);</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     786 </span>            :   }
<span class="lineNum">     787 </span>            : 
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :   const Int_t row0 = param-&gt;GetNRowLow();</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :   const Int_t row1 = row0+param-&gt;GetNRowUp1();</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :   const Int_t row2 = row1+param-&gt;GetNRowUp2();</span>
<span class="lineNum">     791 </span>            : 
<span class="lineNum">     792 </span>            :   const Int_t    kMax=10000;
<span class="lineNum">     793 </span>            :   const Int_t    kMinRows=80;
<span class="lineNum">     794 </span>            :   const Double_t kDCAcut=30;
<span class="lineNum">     795 </span>            :   //
<span class="lineNum">     796 </span>            :   // Bethe Bloch paramerization
<span class="lineNum">     797 </span>            :   //
<span class="lineNum">     798 </span>            :   Double_t kp1= 0.0851148;
<span class="lineNum">     799 </span>            :   Double_t kp2= 9.25771;
<span class="lineNum">     800 </span>            :   Double_t kp3= 2.6558e-05;
<span class="lineNum">     801 </span>            :   Double_t kp4= 2.32742;
<span class="lineNum">     802 </span>            :   Double_t kp5= 1.83039;
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :   if (fBBParam){</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :     kp1=(*fBBParam)[0];</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :     kp2=(*fBBParam)[1];</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :     kp3=(*fBBParam)[2];</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :     kp4=(*fBBParam)[3];</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :     kp5=(*fBBParam)[4];</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     810 </span>            :   //
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :   static const AliTPCROC *roc = AliTPCROC::Instance();</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :   static const TDatabasePDG *pdg = TDatabasePDG::Instance();</span>
<span class="lineNum">     813 </span>            : 
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :   Int_t nclITS   = track-&gt;GetNcls(0);</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :   Int_t ncl   = track-&gt;GetTPCncls();</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :   Double_t ncl21 = track-&gt;GetTPCClusterInfo(3,1);</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :   Double_t ncl20 = track-&gt;GetTPCClusterInfo(3,0);</span>
<span class="lineNum">     818 </span>            :   //
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :   if (!seed) return;</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :   if (ncl21&lt;kMinRows) return;  </span>
<span class="lineNum">     821 </span>            :   static Int_t counter=0;
<span class="lineNum">     822 </span>            :   static Int_t counterHPT=0;
<span class="lineNum">     823 </span>            :   //
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :   static TH1F     *hisBB=new TH1F(&quot;hisBB&quot;,&quot;hisBB&quot;,20,0.1,1.00);  // bethe bloch histogram  = </span>
<span class="lineNum">     825 </span>            :   //                                                                 used to cover more homegenously differnt dEdx regions
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :   static Double_t massPi = pdg-&gt;GetParticle(&quot;pi-&quot;)-&gt;Mass();      // </span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :   static Double_t massK  = pdg-&gt;GetParticle(&quot;K-&quot;)-&gt;Mass();</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :   static Double_t massP  = pdg-&gt;GetParticle(&quot;proton&quot;)-&gt;Mass();</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :   static Double_t massE  = pdg-&gt;GetParticle(&quot;e-&quot;)-&gt;Mass();</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :   static Double_t massMuon  = pdg-&gt;GetParticle(&quot;mu-&quot;)-&gt;Mass();</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :   static Double_t radius0= roc-&gt;GetPadRowRadiiLow(roc-&gt;GetNRows(0)/2);</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :   static Double_t radius1= roc-&gt;GetPadRowRadiiUp(30);</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :   static Double_t radius2= roc-&gt;GetPadRowRadiiUp(roc-&gt;GetNRows(36)-15);</span>
<span class="lineNum">     834 </span>            : 
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :   AliESDVertex *vertex= (AliESDVertex *)fCurrentEvent-&gt;GetPrimaryVertex();</span>
<span class="lineNum">     836 </span>            :   //
<span class="lineNum">     837 </span>            :   // Estimate current MIP position - 
<span class="lineNum">     838 </span>            :   //
<span class="lineNum">     839 </span>            :   static Double_t mipArray[kMax];               // mip array
<span class="lineNum">     840 </span>            :   static Int_t    counterMIP0=0;          
<span class="lineNum">     841 </span>            :   static Double_t    medianMIP0=100000;         // current MIP median position - estimated after some mimnimum number of MIP tracks
<span class="lineNum">     842 </span>            : 
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :   if (TMath::Abs(track-&gt;GetP()-0.5)&lt;0.1&amp;&amp;track-&gt;GetTPCsignal()/medianMIP0&lt;1.5){</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :     mipArray[counterMIP0%kMax]= track-&gt;GetTPCsignal();</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :     counterMIP0++;</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :     if (counterMIP0&gt;10) medianMIP0=TMath::Median(counterMIP0%kMax, mipArray);</span>
<span class="lineNum">     847 </span>            :   }
<span class="lineNum">     848 </span>            :   // the PID as defiend from the external sources
<span class="lineNum">     849 </span>            :   //
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :   Int_t isElectron   =  TMath::Nint((*fPIDMatrix)(index,0));</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :   Int_t isMuon       =  TMath::Nint((*fPIDMatrix)(index,1));</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :   Int_t isPion       =  TMath::Nint((*fPIDMatrix)(index,2));</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :   Int_t isKaon       =  TMath::Nint((*fPIDMatrix)(index,3));</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :   Int_t isProton     =  TMath::Nint((*fPIDMatrix)(index,4));</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :   Float_t dca[2];</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :   track-&gt;GetImpactParameters(dca[0],dca[1]);</span>
<span class="lineNum">     857 </span>            :   //
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :   if ( (isMuon==0 &amp;&amp; isElectron==0)  &amp;&amp; (TMath::Sqrt(dca[0]*dca[0]+dca[1]*dca[1])&gt;kDCAcut) ) return;</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :   Double_t normdEdx= track-&gt;GetTPCsignal()/(medianMIP0); // TPC signal normalized to the MIP</span>
<span class="lineNum">     860 </span>            :   //
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :   AliExternalTrackParam * trackIn  = (AliExternalTrackParam *)track-&gt;GetInnerParam();</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :   AliExternalTrackParam * trackOut = (AliExternalTrackParam *)track-&gt;GetOuterParam();</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :   AliExternalTrackParam * tpcOut   = (AliExternalTrackParam *)ftrack-&gt;GetTPCOut();</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :   if (!trackIn) return;</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :   if (!trackOut) return;</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :   if (!tpcOut) return;</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :   if (trackIn-&gt;GetZ()*trackOut-&gt;GetZ()&lt;0) return;  // remove crossing tracks</span>
<span class="lineNum">     868 </span>            :   //
<span class="lineNum">     869 </span>            :   // calculate local and global angle
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :   Int_t side = (trackIn-&gt;GetZ()&gt;0)? 1:-1;</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :   Double_t tgl=trackIn-&gt;GetTgl();</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :   Double_t gangle[3]={0,0,0};</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :   Double_t langle[3]={0,0,0};</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :   Double_t length[3]={0,0,0};</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :   Double_t pxpypz[3]={0,0,0};</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :   Double_t bz=fMagF;</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :   trackIn-&gt;GetXYZAt(radius0,bz,pxpypz);            // get the global position  at the middle of the IROC</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :   gangle[0]=TMath::ATan2(pxpypz[1],pxpypz[0]);     // global angle IROC </span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :   trackIn-&gt;GetXYZAt(radius1,bz,pxpypz);            // get the global position at the middle of the OROC - medium pads      </span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :   gangle[1]=TMath::ATan2(pxpypz[1],pxpypz[0]);     // global angle OROC</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :   trackOut-&gt;GetXYZAt(radius2,bz,pxpypz);           // get the global position at the middle of OROC - long pads</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :   gangle[2]=TMath::ATan2(pxpypz[1],pxpypz[0]);</span>
<span class="lineNum">     883 </span>            :   //
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :   trackIn-&gt;GetPxPyPzAt(radius0,bz,pxpypz);               //get momentum vector </span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :   langle[0]=TMath::ATan2(pxpypz[1],pxpypz[0])-gangle[0];  //local angle between padrow and track IROC  </span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :   trackIn-&gt;GetPxPyPzAt(radius1,bz,pxpypz); </span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :   langle[1]=TMath::ATan2(pxpypz[1],pxpypz[0])-gangle[1];                                           </span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :   trackOut-&gt;GetPxPyPzAt(radius2,bz,pxpypz);               //                                     OROC medium    </span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :   langle[2]=TMath::ATan2(pxpypz[1],pxpypz[0])-gangle[2];</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;3; i++){</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :     if (langle[i]&gt;TMath::Pi())  langle[i]-=TMath::TwoPi();</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :     if (langle[i]&lt;-TMath::Pi()) langle[i]+=TMath::TwoPi();</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :     length[i]=TMath::Sqrt(1+langle[i]*langle[i]+tgl*tgl);  // the tracklet length</span>
<span class="lineNum">     894 </span>            :   }
<span class="lineNum">     895 </span>            :   //
<span class="lineNum">     896 </span>            :   // Select the kaons and Protons which are &quot;isolated&quot; in TPC dedx curve
<span class="lineNum">     897 </span>            :   // 
<span class="lineNum">     898 </span>            :   //
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :   Double_t dedxP = AliExternalTrackParam::BetheBlochAleph(track-&gt;GetInnerParam()-&gt;GetP()/massP,kp1,kp2,kp3,kp4,kp5);</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :   Double_t dedxK = AliExternalTrackParam::BetheBlochAleph(track-&gt;GetInnerParam()-&gt;GetP()/massK,kp1,kp2,kp3,kp4,kp5);</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :   if (dedxP&gt;2 || dedxK&gt;2){</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :     if (track-&gt;GetP()&lt;1.2 &amp;&amp; normdEdx&gt;1.8&amp;&amp;counterMIP0&gt;10){ // not enough from TOF and V0s triggered by high dedx</span>
<span class="lineNum">     903 </span>            :       // signing the Proton  and kaon - using the &quot;bitmask&quot; bit 1 and 2 is dedicated for V0s and TOF selected       
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :       if ( TMath::Abs(normdEdx/dedxP-1)&lt;0.3)  isProton+=4;</span>
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :       if ( TMath::Abs(normdEdx/dedxK-1)&lt;0.3)  isKaon+=4;</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :       if (normdEdx/dedxK&gt;1.3) isProton+=8;</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :       if (normdEdx/dedxP&lt;0.7) isKaon+=8;</span>
<span class="lineNum">     908 </span>            :     }
<span class="lineNum">     909 </span>            :   }
<span class="lineNum">     910 </span>            :   //
<span class="lineNum">     911 </span>            :   //
<span class="lineNum">     912 </span>            :   //
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :   Double_t mass = 0;  </span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :   Bool_t isHighPt = ((TMath::Power(1/track-&gt;Pt(),4)*gRandom-&gt;Rndm())&lt;0.005);  // rnadomly selected HPT tracks</span>
<span class="lineNum">     915 </span>            :   // there are selected for the QA of the obtained calibration
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :   Bool_t isMIP    =  TMath::Abs(track-&gt;GetInnerParam()-&gt;P()-0.4)&lt;0.005&amp;&amp;(counter&lt;kMax); //</span>
<span class="lineNum">     917 </span>            :   // REMINDER - it is not exactly MIP - we select the regtion where the Kaon and Electrons are well separated
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :   if (isElectron&gt;0) mass = massE;</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :   if (isProton&gt;0)   mass = massP;</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :   if (isKaon&gt;0)     mass = massK;</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :   if (isMuon&gt;0)     mass = massMuon;</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :   if (isPion&gt;0)     mass = massPi;</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :   if (isHighPt)     mass = massPi;  //assign mass of pions</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :   if (isMIP&amp;&amp;track-&gt;GetTPCsignal()/medianMIP0&lt;1.5)   mass = massPi;  //assign mass of pions</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :   if (mass==0)      return;</span>
<span class="lineNum">     927 </span>            :   //
<span class="lineNum">     928 </span>            :   // calculate expected dEdx
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :   Double_t dedxDef= 0;</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :   Double_t dedxDefPion= 0,dedxDefProton=0, dedxDefKaon=0;</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :   Double_t pin=trackIn-&gt;GetP();</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :   Double_t pout=trackOut-&gt;GetP();</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :   Double_t p=(pin+pout)*0.5;  // momenta as the mean between tpc momenta at inner and outer wall of the TPC</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :   if (mass&gt;0) dedxDef = AliExternalTrackParam::BetheBlochAleph(p/mass,kp1,kp2,kp3,kp4,kp5); </span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :   dedxDefPion = AliExternalTrackParam::BetheBlochAleph(p/massPi,kp1,kp2,kp3,kp4,kp5); </span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :   dedxDefProton = AliExternalTrackParam::BetheBlochAleph(p/massP,kp1,kp2,kp3,kp4,kp5); </span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :   dedxDefKaon = AliExternalTrackParam::BetheBlochAleph(p/massK,kp1,kp2,kp3,kp4,kp5); </span>
<span class="lineNum">     938 </span>            :   //
<span class="lineNum">     939 </span>            :   // dEdx Truncated mean vectros with differnt tuncation 
<span class="lineNum">     940 </span>            :   // 11 truncations array -  0-10  - 0~50%  11=100%
<span class="lineNum">     941 </span>            :   // 3 Regions            -  IROC,OROC0, OROC1
<span class="lineNum">     942 </span>            :   // 2 Q                  -  total charge and max charge
<span class="lineNum">     943 </span>            :   // Log                  -  Logarithmic mean used
<span class="lineNum">     944 </span>            :   // Up/Dwon              -  Upper half or lower half of truncation used
<span class="lineNum">     945 </span>            :   // RMS                  -  rms of the distribction (otherwise truncated mean)
<span class="lineNum">     946 </span>            :   // M2 suffix            -  second moment ( truncated) 
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :   TVectorF truncUp(11);</span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :   TVectorF truncDown(11);</span>
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :   TVectorF vecAllMax(11);</span>
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :   TVectorF vecIROCMax(11);</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :   TVectorF vecOROCMax(11);</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :   TVectorF vecOROC0Max(11);</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :   TVectorF vecOROC1Max(11);</span>
<span class="lineNum">     954 </span>            :   //
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :   TVectorF vecAllTot(11);</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :   TVectorF vecIROCTot(11);</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :   TVectorF vecOROCTot(11);</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :   TVectorF vecOROC0Tot(11);</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :   TVectorF vecOROC1Tot(11);</span>
<span class="lineNum">     960 </span>            :   //
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :   TVectorF vecAllTotLog(11);</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :   TVectorF vecIROCTotLog(11);</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :   TVectorF vecOROCTotLog(11);</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :   TVectorF vecOROC0TotLog(11);</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :   TVectorF vecOROC1TotLog(11);</span>
<span class="lineNum">     966 </span>            :   //
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :   TVectorF vecAllTotUp(11);</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :   TVectorF vecIROCTotUp(11);</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :   TVectorF vecOROCTotUp(11);</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :   TVectorF vecOROC0TotUp(11);</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :   TVectorF vecOROC1TotUp(11);</span>
<span class="lineNum">     972 </span>            :   //
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :   TVectorF vecAllTotDown(11);</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :   TVectorF vecIROCTotDown(11);</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :   TVectorF vecOROCTotDown(11);</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :   TVectorF vecOROC0TotDown(11);</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :   TVectorF vecOROC1TotDown(11);</span>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :   TVectorF vecAllTotRMS(11);</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :   TVectorF vecIROCTotRMS(11);</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :   TVectorF vecOROCTotRMS(11);</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :   TVectorF vecOROC0TotRMS(11);</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :   TVectorF vecOROC1TotRMS(11);</span>
<span class="lineNum">     984 </span>            :   //
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :   TVectorF vecAllTotM2(11);</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :   TVectorF vecIROCTotM2(11);</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :   TVectorF vecOROCTotM2(11);</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :   TVectorF vecOROC0TotM2(11);</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :   TVectorF vecOROC1TotM2(11);</span>
<span class="lineNum">     990 </span>            :   //
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :   TVectorF vecAllTotMS(11);</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :   TVectorF vecIROCTotMS(11);</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :   TVectorF vecOROCTotMS(11);</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :   TVectorF vecOROC0TotMS(11);</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :   TVectorF vecOROC1TotMS(11);</span>
<span class="lineNum">     996 </span>            :   //
<span class="lineNum">     997 </span>            :   // Differnt number of clusters definitions - in separate regions of the TPC
<span class="lineNum">     998 </span>            :   // 20  -    ratio - found/findabel
<span class="lineNum">     999 </span>            :   // 21  -    number of clusters used for given dEdx calculation
<span class="lineNum">    1000 </span>            :   //
<span class="lineNum">    1001 </span>            :   // suffix - 3 or 4 -  number of padrows before and after given row to define findable row
<span class="lineNum">    1002 </span>            :   //
<span class="lineNum">    1003 </span>            : 
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :   Double_t ncl20All  = seed-&gt;CookdEdxAnalytical(0.0,1, 1 ,0,row2,3);</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :   Double_t ncl20IROC = seed-&gt;CookdEdxAnalytical(0.,1, 1 ,0,row0,3);</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :   Double_t ncl20OROC = seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row0,row2,3);</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :   Double_t ncl20OROC0= seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row0,row1,3);</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :   Double_t ncl20OROC1= seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row1,row2,3);</span>
<span class="lineNum">    1009 </span>            :   //
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :   Double_t ncl20All4  = seed-&gt;CookdEdxAnalytical(0.0,1, 1 ,0,row2,3,4);</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :   Double_t ncl20IROC4 = seed-&gt;CookdEdxAnalytical(0.,1, 1 ,0,row0,3,4);</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :   Double_t ncl20OROC4 = seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row0,row2,3,4);</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :   Double_t ncl20OROC04= seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row0,row1,3,4);</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :   Double_t ncl20OROC14= seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row1,row2,3,4);</span>
<span class="lineNum">    1015 </span>            :   //
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :   Double_t ncl20All3  = seed-&gt;CookdEdxAnalytical(0.0,1, 1 ,0,row2,3,3);</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :   Double_t ncl20IROC3 = seed-&gt;CookdEdxAnalytical(0.,1, 1 ,0,row0,3,3);</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :   Double_t ncl20OROC3 = seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row0,row2,3,3);</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :   Double_t ncl20OROC03= seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row0,row1,3,3);</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :   Double_t ncl20OROC13= seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row1,row2,3,3);</span>
<span class="lineNum">    1021 </span>            :   //
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :   Double_t ncl21All  = seed-&gt;CookdEdxAnalytical(0.0,1, 1 ,0,row2,2);</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :   Double_t ncl21IROC = seed-&gt;CookdEdxAnalytical(0.,1, 1 ,0,row0,2);</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :   Double_t ncl21OROC = seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row0,row2,2);</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :   Double_t ncl21OROC0= seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row0,row1,2);</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :   Double_t ncl21OROC1= seed-&gt;CookdEdxAnalytical(0.,1, 1 ,row1,row2,2);</span>
<span class="lineNum">    1027 </span>            :   // calculate truncated dEdx - mean rms M2 ... 
<span class="lineNum">    1028 </span>            :   Int_t ifrac=0;
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :   for (Int_t ifracDown=0; ifracDown&lt;1; ifracDown++){</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :     for (Int_t ifracUp=0; ifracUp&lt;11; ifracUp++){</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :       Double_t fracDown = 0.0+Double_t(ifracDown)*0.05;</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :       Double_t fracUp = 0.5+Double_t(ifracUp)*0.05;</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :       vecAllMax[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 1 ,0,row2,0);</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :       vecIROCMax[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 1 ,0,row0,0);</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :       vecOROCMax[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 1 ,row0,row2,0);</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :       vecOROC0Max[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 1 ,row0,row1,0);</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :       vecOROC1Max[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 1 ,row1,row2,0);</span>
<span class="lineNum">    1038 </span>            :       //
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :       vecAllTot[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row2,0);</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :       vecIROCTot[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row0,0);</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :       vecOROCTot[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row2,0);</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :       vecOROC0Tot[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row1,0);</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :       vecOROC1Tot[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row1,row2,0);</span>
<span class="lineNum">    1044 </span>            :       //
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :       vecAllTotLog[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row2,0,2,1);</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :       vecIROCTotLog[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row0,0,2,1);</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :       vecOROCTotLog[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row2,0,2,1);</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :       vecOROC0TotLog[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row1,0,2,1);</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :       vecOROC1TotLog[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row1,row2,0,2,1);</span>
<span class="lineNum">    1050 </span>            :       //
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :       vecAllTotUp[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row2,4,2,1);</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :       vecIROCTotUp[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row0,4,2,1);</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :       vecOROCTotUp[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row2,4,2,1);</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :       vecOROC0TotUp[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row1,4,2,1);</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :       vecOROC1TotUp[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row1,row2,4,2,1);</span>
<span class="lineNum">    1056 </span>            :       //
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :       vecAllTotDown[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row2,5,2,1);</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :       vecIROCTotDown[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row0,5,2,1);</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :       vecOROCTotDown[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row2,5,2,1);</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :       vecOROC0TotDown[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row1,5,2,1);</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :       vecOROC1TotDown[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row1,row2,5,2,1);</span>
<span class="lineNum">    1062 </span>            :       //
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :       vecAllTotRMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row2,1,2,0);</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :       vecIROCTotRMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row0,1,2,0);</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :       vecOROCTotRMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row2,1,2,0);</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :       vecOROC0TotRMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row1,1,2,0);</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :       vecOROC1TotRMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row1,row2,1,2,0);</span>
<span class="lineNum">    1068 </span>            :       //
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :       vecAllTotM2[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row2,6,2,1);</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :       vecIROCTotM2[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row0,6,2,1);</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :       vecOROCTotM2[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row2,6,2,1);</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :       vecOROC0TotM2[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row1,6,2,1);</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :       vecOROC1TotM2[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row1,row2,6,2,1);</span>
<span class="lineNum">    1074 </span>            :       //
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :       vecAllTotMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row2,8,2,1);</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :       vecIROCTotMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,0,row0,8,2,1);</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :       vecOROCTotMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row2,8,2,1);</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :       vecOROC0TotMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row0,row1,8,2,1);</span>
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :       vecOROC1TotMS[ifrac]= seed-&gt;CookdEdxAnalytical(fracDown,fracUp, 0 ,row1,row2,8,2,1);</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :       truncUp[ifrac]=fracUp;</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :       truncDown[ifrac]=fracDown;</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :       ifrac++;</span>
<span class="lineNum">    1083 </span>            :     }
<span class="lineNum">    1084 </span>            :   }
<span class="lineNum">    1085 </span>            :   //
<span class="lineNum">    1086 </span>            :   // Fill histograms
<span class="lineNum">    1087 </span>            :   //
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :   if (((isKaon||isProton||isPion||isElectron||isMIP||isMuon)&amp;&amp;(!isHighPt)) &amp;&amp; dedxDef&gt;0) {</span>
<span class="lineNum">    1089 </span>            :     //
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :     Int_t ncont = vertex-&gt;GetNContributors();</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :     for (Int_t ipad=0; ipad&lt;3; ipad++){</span>
<span class="lineNum">    1092 </span>            :       // histogram with enahanced phi granularity - to make gain phi maps
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :       Double_t xxx[4]={0,gangle[ipad],1./dedxDef, static_cast&lt;Double_t&gt;(ipad*2+((side&gt;0)?0:1))};</span>
<span class="lineNum">    1094 </span>            :       Double_t nclR=0;
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :       if (ipad==0)  {xxx[0]=vecIROCTot[4]/medianMIP0; nclR=ncl21IROC/63.;}</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :       if (ipad==1)  {xxx[0]=vecOROC0Tot[4]/medianMIP0;nclR=ncl21OROC0/63.;}</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :       if (ipad==2)  {xxx[0]=vecOROC1Tot[4]/medianMIP0;nclR=ncl21OROC1/32.;}</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :       xxx[0]/=dedxDef;</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :       if (xxx[0]&gt;0) xxx[0]=1./xxx[0];</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :       if (TMath::Abs(langle[ipad])&lt;0.25&amp;&amp;nclR&gt;0.4)  fHistdEdxMap-&gt;Fill(xxx);</span>
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :     for (Int_t ipad=0; ipad&lt;3; ipad++){</span>
<span class="lineNum">    1103 </span>            :       //
<span class="lineNum">    1104 </span>            :       // this are histogram to define  overall main gain correction
<span class="lineNum">    1105 </span>            :       // Maybe dead end - we can not put all info which can be used into the THnSparse
<span class="lineNum">    1106 </span>            :       // It is keeped there for educational point of view
<span class="lineNum">    1107 </span>            :       //
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :       Double_t xxx[6]={0,1./dedxDef, TMath::Abs(langle[ipad]), TMath::Abs(tgl),  static_cast&lt;Double_t&gt;(ncont),  static_cast&lt;Double_t&gt;(ipad) };</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :       if (ipad==0)  {xxx[0]=vecIROCTot[4]/medianMIP0;}</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :       if (ipad==1)  {xxx[0]=vecOROC0Tot[4]/medianMIP0;}</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :       if (ipad==2)  {xxx[0]=vecOROC1Tot[4]/medianMIP0;}</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :       xxx[0]/=dedxDef;</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :       if (xxx[0]&gt;0) xxx[0]=1./xxx[0];</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :       if (xxx[0]&gt;0) fHistdEdxTot-&gt;Fill(xxx);</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :       if (ipad==0)  {xxx[0]=vecIROCMax[4]/medianMIP0;}</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :       if (ipad==1)  {xxx[0]=vecOROC0Max[4]/medianMIP0;}</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :       if (ipad==2)  {xxx[0]=vecOROC1Max[4]/medianMIP0;}</span>
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :       xxx[0]=dedxDef;</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :       if (xxx[0]&gt;0) xxx[0]=1./xxx[0];</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :       fHistdEdxMax-&gt;Fill(xxx);</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :   }  </span>
<span class="lineNum">    1123 </span>            :   //
<span class="lineNum">    1124 </span>            :   // Downscale  selected tracks before filling the tree
<span class="lineNum">    1125 </span>            :   //
<span class="lineNum">    1126 </span>            :   Bool_t isSelected = kFALSE;  
<span class="lineNum">    1127 </span>            :   //
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :   if (isKaon||isProton||isPion||isElectron||isMIP||isMuon) isSelected=kTRUE;</span>
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :   isHighPt = kFALSE;</span>
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :   if (!isSelected) isHighPt = ((TMath::Power(1/track-&gt;Pt(),4)*gRandom-&gt;Rndm())&lt;0.005);  </span>
<span class="lineNum">    1131 </span>            :   //if (counter&gt;kMax &amp;&amp; ((1/track-&gt;Pt()*gRandom-&gt;Rndm())&gt;kMax/counter)) return; 
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :   isSelected|=isHighPt;</span>
<span class="lineNum">    1133 </span>            :   //
<span class="lineNum">    1134 </span>            :   //
<span class="lineNum">    1135 </span>            :   //
<span class="lineNum">    1136 </span>            :   // Equalize statistic in BB bins - special care about pions
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :   Int_t entriesBB = (Int_t)hisBB-&gt;GetEntries();</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :   if ((isElectron==0 &amp;&amp;isMuon==0 &amp;&amp; p&lt;2.) &amp;&amp; entriesBB&gt;20 &amp;&amp;dedxDef&gt;0.01){</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :     Int_t bin = hisBB-&gt;GetXaxis()-&gt;FindBin(1./dedxDef);</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :     Double_t cont = hisBB-&gt;GetBinContent(bin);</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :     Double_t mean =(entriesBB)/20.;</span>
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :     if ((isPion&gt;0)  &amp;&amp; gRandom-&gt;Rndm()*cont &gt; 0.1*mean) return;</span>
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :     if ((isPion==0) &amp;&amp; gRandom-&gt;Rndm()*cont &gt; 0.25*mean) return;</span>
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :   }  </span>
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :   if (!isSelected) return;</span>
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :   if (dedxDef&gt;0.01) hisBB-&gt;Fill(1./dedxDef);  </span>
<span class="lineNum">    1147 </span>            :   //
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :   if (isHighPt) counterHPT++;</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :   counter++;  </span>
<span class="lineNum">    1150 </span>            :   //
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :   TTreeSRedirector * pcstream =  GetDebugStreamer();</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :   Double_t ptrel0 = AliTPCcalibDB::GetPTRelative(fTime,fRun,0);</span>
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :   Double_t ptrel1 = AliTPCcalibDB::GetPTRelative(fTime,fRun,1);</span>
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :   Int_t sectorIn   = Int_t(18+9*(trackIn-&gt;GetAlpha()/TMath::Pi()))%18;</span>
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :   Int_t sectorOut  = Int_t(18+9*(trackOut-&gt;GetAlpha()/TMath::Pi()))%18;</span>
<span class="lineNum">    1156 </span>            :   //
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :   if (pcstream){</span>
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :     (*pcstream)&lt;&lt;&quot;dump&quot;&lt;&lt;</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :       &quot;vertex.=&quot;&lt;&lt;vertex&lt;&lt;</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :       &quot;bz=&quot;&lt;&lt;fMagF&lt;&lt;</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :       &quot;ptrel0=&quot;&lt;&lt;ptrel0&lt;&lt;</span>
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :       &quot;ptrel1=&quot;&lt;&lt;ptrel1&lt;&lt;</span>
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :       &quot;sectorIn=&quot;&lt;&lt;sectorIn&lt;&lt;</span>
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :       &quot;sectorOut=&quot;&lt;&lt;sectorOut&lt;&lt;</span>
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :       &quot;side=&quot;&lt;&lt;side&lt;&lt;</span>
<span class="lineNum">    1166 </span>            :       // pid type
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :       &quot;isMuon=&quot;&lt;&lt;isMuon&lt;&lt;</span>
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :       &quot;isProton=&quot;&lt;&lt;isProton&lt;&lt;</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :       &quot;isKaon=&quot;&lt;&lt;isKaon&lt;&lt;</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :       &quot;isPion=&quot;&lt;&lt;isPion&lt;&lt;</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :       &quot;isElectron=&quot;&lt;&lt;isElectron&lt;&lt;</span>
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 :       &quot;isMIP=&quot;&lt;&lt;isMIP&lt;&lt;</span>
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :       &quot;isHighPt=&quot;&lt;&lt;isHighPt&lt;&lt;</span>
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :       &quot;mass=&quot;&lt;&lt;mass&lt;&lt;</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :       &quot;dedxDef=&quot;&lt;&lt;dedxDef&lt;&lt;</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :       &quot;dedxDefPion=&quot;&lt;&lt;dedxDefPion&lt;&lt;</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :       &quot;dedxDefKaon=&quot;&lt;&lt;dedxDefKaon&lt;&lt;</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :       &quot;dedxDefProton=&quot;&lt;&lt;dedxDefProton&lt;&lt;</span>
<span class="lineNum">    1179 </span>            :       //
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :       &quot;nclITS=&quot;&lt;&lt;nclITS&lt;&lt;</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :       &quot;ncl=&quot;&lt;&lt;ncl&lt;&lt;</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :       &quot;ncl21=&quot;&lt;&lt;ncl21&lt;&lt;</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :       &quot;ncl20=&quot;&lt;&lt;ncl20&lt;&lt;</span>
<span class="lineNum">    1184 </span>            :       //
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :       &quot;ncl20All=&quot;&lt;&lt;ncl20All&lt;&lt;</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :       &quot;ncl20OROC=&quot;&lt;&lt;ncl20OROC&lt;&lt;</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :       &quot;ncl20IROC=&quot;&lt;&lt;ncl20IROC&lt;&lt;</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :       &quot;ncl20OROC0=&quot;&lt;&lt;ncl20OROC0&lt;&lt;</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :       &quot;ncl20OROC1=&quot;&lt;&lt;ncl20OROC1&lt;&lt;</span>
<span class="lineNum">    1190 </span>            :       //
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :       &quot;ncl20All4=&quot;&lt;&lt;ncl20All4&lt;&lt;</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :       &quot;ncl20OROC4=&quot;&lt;&lt;ncl20OROC4&lt;&lt;</span>
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :       &quot;ncl20IROC4=&quot;&lt;&lt;ncl20IROC4&lt;&lt;</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :       &quot;ncl20OROC04=&quot;&lt;&lt;ncl20OROC04&lt;&lt;</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :       &quot;ncl20OROC14=&quot;&lt;&lt;ncl20OROC14&lt;&lt;</span>
<span class="lineNum">    1196 </span>            :       //
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :       &quot;ncl20All3=&quot;&lt;&lt;ncl20All3&lt;&lt;</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :       &quot;ncl20OROC3=&quot;&lt;&lt;ncl20OROC3&lt;&lt;</span>
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :       &quot;ncl20IROC3=&quot;&lt;&lt;ncl20IROC3&lt;&lt;</span>
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :       &quot;ncl20OROC03=&quot;&lt;&lt;ncl20OROC03&lt;&lt;</span>
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :       &quot;ncl20OROC13=&quot;&lt;&lt;ncl20OROC13&lt;&lt;</span>
<span class="lineNum">    1202 </span>            :       //
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :       &quot;ncl21All=&quot;&lt;&lt;ncl21All&lt;&lt;</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :       &quot;ncl21OROC=&quot;&lt;&lt;ncl21OROC&lt;&lt;</span>
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :       &quot;ncl21IROC=&quot;&lt;&lt;ncl21IROC&lt;&lt;</span>
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :       &quot;ncl21OROC0=&quot;&lt;&lt;ncl21OROC0&lt;&lt;</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :       &quot;ncl21OROC1=&quot;&lt;&lt;ncl21OROC1&lt;&lt;  </span>
<span class="lineNum">    1208 </span>            :       //track properties
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :       &quot;langle0=&quot;&lt;&lt;langle[0]&lt;&lt;</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :       &quot;langle1=&quot;&lt;&lt;langle[1]&lt;&lt;</span>
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :       &quot;langle2=&quot;&lt;&lt;langle[2]&lt;&lt;</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :       &quot;gangle0=&quot;&lt;&lt;gangle[0]&lt;&lt;   //global angle phi IROC </span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :       &quot;gangle1=&quot;&lt;&lt;gangle[1]&lt;&lt;   //                 OROC medium </span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :       &quot;gangle2=&quot;&lt;&lt;gangle[2]&lt;&lt;   //                 OROC long</span>
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :       &quot;L0=&quot;&lt;&lt;length[0]&lt;&lt;</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :       &quot;L1=&quot;&lt;&lt;length[1]&lt;&lt;</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :       &quot;L2=&quot;&lt;&lt;length[2]&lt;&lt;</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :       &quot;p=&quot;&lt;&lt;p&lt;&lt;</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :       &quot;pin=&quot;&lt;&lt;pin&lt;&lt;</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :       &quot;pout=&quot;&lt;&lt;pout&lt;&lt;</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :       &quot;tgl=&quot;&lt;&lt;tgl&lt;&lt;</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :       &quot;track.=&quot;&lt;&lt;track&lt;&lt;</span>
<span class="lineNum">    1223 </span>            :       //&quot;trackIn.=&quot;&lt;&lt;trackIn&lt;&lt;
<span class="lineNum">    1224 </span>            :       //&quot;trackOut.=&quot;&lt;&lt;trackOut&lt;&lt;
<span class="lineNum">    1225 </span>            :       //&quot;tpcOut.=&quot;&lt;&lt;tpcOut&lt;&lt;
<span class="lineNum">    1226 </span>            :       //&quot;seed.=&quot;&lt;&lt;seed&lt;&lt;
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :       &quot;medianMIP0=&quot;&lt;&lt;medianMIP0&lt;&lt;    // median MIP position as estimated from the array of (not only) &quot;MIPS&quot;</span>
<span class="lineNum">    1228 </span>            :       //dedx 
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :       &quot;truncUp.=&quot;&lt;&lt;&amp;truncUp&lt;&lt;</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :       &quot;truncDown.=&quot;&lt;&lt;&amp;truncDown&lt;&lt;</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :       &quot;vecAllMax.=&quot;&lt;&lt;&amp;vecAllMax&lt;&lt;</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :       &quot;vecIROCMax.=&quot;&lt;&lt;&amp;vecIROCMax&lt;&lt;</span>
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :       &quot;vecOROCMax.=&quot;&lt;&lt;&amp;vecOROCMax&lt;&lt;</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :       &quot;vecOROC0Max.=&quot;&lt;&lt;&amp;vecOROC0Max&lt;&lt;</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :       &quot;vecOROC1Max.=&quot;&lt;&lt;&amp;vecOROC1Max&lt;&lt;</span>
<span class="lineNum">    1236 </span>            :       //
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :       &quot;vecAllTot.=&quot;&lt;&lt;&amp;vecAllTot&lt;&lt;</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :       &quot;vecIROCTot.=&quot;&lt;&lt;&amp;vecIROCTot&lt;&lt;</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :       &quot;vecOROCTot.=&quot;&lt;&lt;&amp;vecOROCTot&lt;&lt;</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :       &quot;vecOROC0Tot.=&quot;&lt;&lt;&amp;vecOROC0Tot&lt;&lt;</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :       &quot;vecOROC1Tot.=&quot;&lt;&lt;&amp;vecOROC1Tot&lt;&lt;</span>
<span class="lineNum">    1242 </span>            :       //
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :       &quot;vecAllTotLog.=&quot;&lt;&lt;&amp;vecAllTotLog&lt;&lt;</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :       &quot;vecIROCTotLog.=&quot;&lt;&lt;&amp;vecIROCTotLog&lt;&lt;</span>
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :       &quot;vecOROCTotLog.=&quot;&lt;&lt;&amp;vecOROCTotLog&lt;&lt;</span>
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :       &quot;vecOROC0TotLog.=&quot;&lt;&lt;&amp;vecOROC0TotLog&lt;&lt;</span>
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :       &quot;vecOROC1TotLog.=&quot;&lt;&lt;&amp;vecOROC1TotLog&lt;&lt;</span>
<span class="lineNum">    1248 </span>            :       //
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :       &quot;vecAllTotUp.=&quot;&lt;&lt;&amp;vecAllTotUp&lt;&lt;</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :       &quot;vecIROCTotUp.=&quot;&lt;&lt;&amp;vecIROCTotUp&lt;&lt;</span>
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :       &quot;vecOROCTotUp.=&quot;&lt;&lt;&amp;vecOROCTotUp&lt;&lt;</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :       &quot;vecOROC0TotUp.=&quot;&lt;&lt;&amp;vecOROC0TotUp&lt;&lt;</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :       &quot;vecOROC1TotUp.=&quot;&lt;&lt;&amp;vecOROC1TotUp&lt;&lt;</span>
<span class="lineNum">    1254 </span>            :       //
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :       &quot;vecAllTotDown.=&quot;&lt;&lt;&amp;vecAllTotDown&lt;&lt;</span>
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :       &quot;vecIROCTotDown.=&quot;&lt;&lt;&amp;vecIROCTotDown&lt;&lt;</span>
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :       &quot;vecOROCTotDown.=&quot;&lt;&lt;&amp;vecOROCTotDown&lt;&lt;</span>
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :       &quot;vecOROC0TotDown.=&quot;&lt;&lt;&amp;vecOROC0TotDown&lt;&lt;</span>
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :       &quot;vecOROC1TotDown.=&quot;&lt;&lt;&amp;vecOROC1TotDown&lt;&lt;</span>
<span class="lineNum">    1260 </span>            :       //
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :       &quot;vecAllTotRMS.=&quot;&lt;&lt;&amp;vecAllTotRMS&lt;&lt;</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :       &quot;vecIROCTotRMS.=&quot;&lt;&lt;&amp;vecIROCTotRMS&lt;&lt;</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :       &quot;vecOROCTotRMS.=&quot;&lt;&lt;&amp;vecOROCTotRMS&lt;&lt;</span>
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :       &quot;vecOROC0TotRMS.=&quot;&lt;&lt;&amp;vecOROC0TotRMS&lt;&lt;</span>
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :       &quot;vecOROC1TotRMS.=&quot;&lt;&lt;&amp;vecOROC1TotRMS&lt;&lt;</span>
<span class="lineNum">    1266 </span>            :       //
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :       &quot;vecAllTotM2.=&quot;&lt;&lt;&amp;vecAllTotM2&lt;&lt;</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :       &quot;vecIROCTotM2.=&quot;&lt;&lt;&amp;vecIROCTotM2&lt;&lt;</span>
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :       &quot;vecOROCTotM2.=&quot;&lt;&lt;&amp;vecOROCTotM2&lt;&lt;</span>
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :       &quot;vecOROC0TotM2.=&quot;&lt;&lt;&amp;vecOROC0TotM2&lt;&lt;</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :       &quot;vecOROC1TotM2.=&quot;&lt;&lt;&amp;vecOROC1TotM2&lt;&lt;</span>
<span class="lineNum">    1272 </span>            :       //
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :       &quot;vecAllTotMS.=&quot;&lt;&lt;&amp;vecAllTotMS&lt;&lt;</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :       &quot;vecIROCTotMS.=&quot;&lt;&lt;&amp;vecIROCTotMS&lt;&lt;</span>
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :       &quot;vecOROCTotMS.=&quot;&lt;&lt;&amp;vecOROCTotMS&lt;&lt;</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :       &quot;vecOROC0TotMS.=&quot;&lt;&lt;&amp;vecOROC0TotMS&lt;&lt;</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :       &quot;vecOROC1TotMS.=&quot;&lt;&lt;&amp;vecOROC1TotMS&lt;&lt;</span>
<span class="lineNum">    1278 </span>            :       &quot;\n&quot;;
<span class="lineNum">    1279 </span>            :   }
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1281 </span>            : 
<span class="lineNum">    1282 </span>            : 
<a name="1283"><span class="lineNum">    1283 </span>            : </a>
<span class="lineNum">    1284 </span>            : 
<span class="lineNum">    1285 </span>            : void AliTPCcalibGainMult::ProcessV0s(AliESDEvent * event){
<span class="lineNum">    1286 </span>            :   //
<span class="lineNum">    1287 </span>            :   // Select the K0s and gamma  - and sign daughter products 
<span class="lineNum">    1288 </span>            :   //  
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :   TTreeSRedirector * pcstream =  GetDebugStreamer();</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :   AliKFParticle::SetField(event-&gt;GetMagneticField()); </span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :   AliESDfriend *esdFriend=static_cast&lt;AliESDfriend*&gt;(event-&gt;FindListObject(&quot;AliESDfriend&quot;));</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :   if (!esdFriend) {</span>
<span class="lineNum">    1293 </span>            :     //Printf(&quot;ERROR: esdFriend not available&quot;);
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :    return;</span>
<span class="lineNum">    1295 </span>            :   }
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :   if (esdFriend-&gt;TestSkipBit()) return;</span>
<span class="lineNum">    1297 </span>            :   //
<span class="lineNum">    1298 </span>            :   // 
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :   static const TDatabasePDG *pdg = TDatabasePDG::Instance();  </span>
<span class="lineNum">    1300 </span>            :   const Double_t kChi2Cut=5;
<span class="lineNum">    1301 </span>            :   const Double_t kMinR=2;
<span class="lineNum">    1302 </span>            :   const Int_t    kMinNcl=110;
<span class="lineNum">    1303 </span>            :   const Double_t kMinREl=5;
<span class="lineNum">    1304 </span>            :   const Double_t kMaxREl=70;
<span class="lineNum">    1305 </span>            :   //
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :   Int_t nv0 = event-&gt;GetNumberOfV0s(); </span>
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :   AliESDVertex *vertex= (AliESDVertex *)event-&gt;GetPrimaryVertex();</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :   AliKFVertex kfvertex=*vertex;</span>
<span class="lineNum">    1309 </span>            :   //
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :   for (Int_t iv0=0;iv0&lt;nv0;iv0++){</span>
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :     AliESDv0 *v0 = event-&gt;GetV0(iv0);</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :     if (!v0) continue;</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :     if (v0-&gt;GetOnFlyStatus()&lt;0.5) continue;</span>
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :     if (v0-&gt;GetPindex()&lt;0) continue;</span>
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :     if (v0-&gt;GetNindex()&lt;0) continue;</span>
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :     if (TMath::Max(v0-&gt;GetPindex(), v0-&gt;GetNindex())&gt;event-&gt;GetNumberOfTracks()) continue;</span>
<span class="lineNum">    1317 </span>            :     //
<span class="lineNum">    1318 </span>            :     //   
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :     AliExternalTrackParam pp=(v0-&gt;GetParamP()-&gt;GetSign()&gt;0) ? (*(v0-&gt;GetParamP())):(*(v0-&gt;GetParamN()));</span>
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :     AliExternalTrackParam pn=(v0-&gt;GetParamP()-&gt;GetSign()&gt;0) ? (*(v0-&gt;GetParamN())):(*(v0-&gt;GetParamP()));</span>
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :     AliKFParticle kfp1( pp, 211 );</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :     AliKFParticle kfp2( pn, -211 );</span>
<span class="lineNum">    1323 </span>            :     //
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :     AliKFParticle *v0KFK0 = new AliKFParticle(kfp1,kfp2);</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :     AliKFParticle *v0KFK0CV = new AliKFParticle(*v0KFK0);</span>
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :     v0KFK0CV-&gt;SetProductionVertex(kfvertex);</span>
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :     v0KFK0CV-&gt;TransportToProductionVertex();</span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :     Double_t chi2K0 = v0KFK0CV-&gt;GetChi2();</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :     if (chi2K0&gt;kChi2Cut) continue;</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :     if (v0-&gt;GetRr()&lt;kMinR) continue;</span>
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :     Bool_t isOKC=TMath::Max(v0-&gt;GetCausalityP()[0],v0-&gt;GetCausalityP()[1])&lt;0.7&amp;&amp;TMath::Min(v0-&gt;GetCausalityP()[2],v0-&gt;GetCausalityP()[3])&gt;0.2;</span>
<span class="lineNum">    1332 </span>            :     //
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :     Double_t effMass22=v0-&gt;GetEffMass(2,2);</span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :     Double_t effMass42=v0-&gt;GetEffMass(4,2);</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :     Double_t effMass24=v0-&gt;GetEffMass(2,4);</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :     Double_t effMass00=v0-&gt;GetEffMass(0,0);</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :     AliKFParticle *v0KFK0CVM = new AliKFParticle(*v0KFK0CV);</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :     v0KFK0CVM-&gt;SetMassConstraint(pdg-&gt;GetParticle(&quot;K_S0&quot;)-&gt;Mass());</span>
<span class="lineNum">    1339 </span>            :     Bool_t isV0= kFALSE;
<span class="lineNum">    1340 </span>            :     //    
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :     Double_t d22   = TMath::Abs(effMass22-pdg-&gt;GetParticle(&quot;K_S0&quot;)-&gt;Mass());</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :     Double_t d42   = TMath::Abs(effMass42-pdg-&gt;GetParticle(&quot;Lambda0&quot;)-&gt;Mass());</span>
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :     Double_t d24   = TMath::Abs(effMass24-pdg-&gt;GetParticle(&quot;Lambda0&quot;)-&gt;Mass());</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :     Double_t d00   = TMath::Abs(effMass00);</span>
<span class="lineNum">    1345 </span>            :     //
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :     Bool_t isKaon      = d22&lt;0.01 &amp;&amp; d22&lt; 0.3 * TMath::Min(TMath::Min(d42,d24),d00);</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :     Bool_t isLambda    = d42&lt;0.01 &amp;&amp; d42&lt; 0.3 * TMath::Min(TMath::Min(d22,d24),d00);</span>
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :     Bool_t isAntiLambda= d24&lt;0.01 &amp;&amp; d24&lt; 0.3 * TMath::Min(TMath::Min(d22,d42),d00);</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :     Bool_t isGamma     = d00&lt;0.02 &amp;&amp; d00&lt; 0.3 * TMath::Min(TMath::Min(d42,d24),d22);</span>
<span class="lineNum">    1350 </span>            :     //
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :     if (isGamma  &amp;&amp;  (isKaon||isLambda||isAntiLambda)) continue;</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :     if (isLambda &amp;&amp;  (isKaon||isGamma||isAntiLambda)) continue;</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :     if (isKaon   &amp;&amp;  (isLambda||isGamma||isAntiLambda)) continue;    </span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :     Double_t sign= v0-&gt;GetParamP()-&gt;GetSign()* v0-&gt;GetParamN()-&gt;GetSign();</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :     if (sign&gt;0) continue;</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :     isV0=isKaon||isLambda||isAntiLambda||isGamma;</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :     if (!(isV0)) continue;</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :     if (isGamma&amp;&amp;v0-&gt;GetRr()&lt;kMinREl) continue;</span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :     if (isGamma&amp;&amp;v0-&gt;GetRr()&gt;kMaxREl) continue;</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :     if (!isOKC) continue;</span>
<span class="lineNum">    1361 </span>            :     //
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :     Int_t pindex = (v0-&gt;GetParamP()-&gt;GetSign()&gt;0) ? v0-&gt;GetPindex() : v0-&gt;GetNindex();</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :     Int_t nindex = (v0-&gt;GetParamP()-&gt;GetSign()&gt;0) ? v0-&gt;GetNindex() : v0-&gt;GetPindex();</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :     AliESDtrack * trackP = event-&gt;GetTrack(pindex);</span>
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :     AliESDtrack * trackN = event-&gt;GetTrack(nindex);</span>
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :     if (!trackN) continue;</span>
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :     if (!trackP) continue;</span>
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :     Int_t nclP= (Int_t)trackP-&gt;GetTPCClusterInfo(2,1);</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :     Int_t nclN= (Int_t)trackN-&gt;GetTPCClusterInfo(2,1);</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :     if (TMath::Min(nclP,nclN)&lt;kMinNcl) continue;</span>
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :     Double_t eta = TMath::Max(TMath::Abs(trackP-&gt;Eta()), TMath::Abs(trackN-&gt;Eta()));</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :     if (TMath::Abs(eta)&gt;1) continue;</span>
<span class="lineNum">    1373 </span>            :     //
<span class="lineNum">    1374 </span>            :     //
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :     AliESDfriendTrack *friendTrackP = (AliESDfriendTrack*)trackP-&gt;GetFriendTrack();//esdFriend-&gt;GetTrack(pindex);</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :     AliESDfriendTrack *friendTrackN = (AliESDfriendTrack*)trackN-&gt;GetFriendTrack();//esdFriend-&gt;GetTrack(nindex);</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :     if (!friendTrackP) continue;</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :     if (!friendTrackN) continue;</span>
<span class="lineNum">    1379 </span>            :     TObject *calibObject;
<span class="lineNum">    1380 </span>            :     AliTPCseed *seedP = 0;
<span class="lineNum">    1381 </span>            :     AliTPCseed *seedN = 0;
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :     for (Int_t l=0;(calibObject=friendTrackP-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :       if ((seedP=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1384 </span>            :     }    
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :     for (Int_t l=0;(calibObject=friendTrackN-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :       if ((seedN=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1387 </span>            :     }   
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :     if (isGamma){</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :       if ( TMath::Abs((trackP-&gt;GetTPCsignal()/(trackN-&gt;GetTPCsignal()+0.0001)-1)&gt;0.3)) continue;</span>
<span class="lineNum">    1390 </span>            :     }
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :     if (isGamma)   (*fPIDMatrix)(pindex, 0)+=2;</span>
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :     if (isGamma)   (*fPIDMatrix)(nindex, 0)+=2;</span>
<span class="lineNum">    1393 </span>            :     //
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :     if (isKaon)    (*fPIDMatrix)(pindex, 2)+=2;</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :     if (isKaon)    (*fPIDMatrix)(nindex, 2)+=2;</span>
<span class="lineNum">    1396 </span>            :     //
<span class="lineNum">    1397 </span>            :     //
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :     if (pcstream){</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :       (*pcstream)&lt;&lt;&quot;v0s&quot;&lt;&lt;</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :         &quot;isGamma=&quot;&lt;&lt;isGamma&lt;&lt;</span>
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :         &quot;isKaon=&quot;&lt;&lt;isKaon&lt;&lt;</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :         &quot;isLambda=&quot;&lt;&lt;isLambda&lt;&lt;</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :         &quot;isAntiLambda=&quot;&lt;&lt;isAntiLambda&lt;&lt;</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :         &quot;chi2=&quot;&lt;&lt;chi2K0&lt;&lt;</span>
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :         &quot;trackP.=&quot;&lt;&lt;trackP&lt;&lt;</span>
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :         &quot;trackN.=&quot;&lt;&lt;trackN&lt;&lt;</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :         &quot;v0.=&quot;&lt;&lt;v0&lt;&lt;</span>
<span class="lineNum">    1408 </span>            :         &quot;\n&quot;;
<span class="lineNum">    1409 </span>            :     }
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1412 </span>            : 
<span class="lineNum">    1413 </span>            : 
<a name="1414"><span class="lineNum">    1414 </span>            : </a>
<span class="lineNum">    1415 </span>            : 
<span class="lineNum">    1416 </span>            : void AliTPCcalibGainMult::ProcessCosmic(const AliESDEvent * event) {
<span class="lineNum">    1417 </span>            :   //
<span class="lineNum">    1418 </span>            :   // Find cosmic pairs trigger by random trigger
<span class="lineNum">    1419 </span>            :   // 
<span class="lineNum">    1420 </span>            :   // 
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :   AliTPCTransform *transform = AliTPCcalibDB::Instance()-&gt;GetTransform() ;</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :   AliTPCParam     *param     = AliTPCcalibDB::Instance()-&gt;GetParameters();</span>
<span class="lineNum">    1423 </span>            : 
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :   AliESDVertex *vertexSPD =  (AliESDVertex *)event-&gt;GetPrimaryVertexSPD();</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :   AliESDVertex *vertexTPC =  (AliESDVertex *)event-&gt;GetPrimaryVertexTPC(); </span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :   AliESDfriend *esdFriend=static_cast&lt;AliESDfriend*&gt;(event-&gt;FindListObject(&quot;AliESDfriend&quot;));</span>
<span class="lineNum">    1427 </span>            :   const Double_t kMinPt=4;
<span class="lineNum">    1428 </span>            :   const Double_t kMinPtMax=0.8;
<span class="lineNum">    1429 </span>            :   const Double_t kMinNcl=kMaxRow*0.5;
<span class="lineNum">    1430 </span>            :   const Double_t kMaxDelta[5]={2,600,0.02,0.02,0.1};
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :   Int_t ntracks=event-&gt;GetNumberOfTracks(); </span>
<span class="lineNum">    1432 </span>            :   const Double_t kMaxImpact=80;
<span class="lineNum">    1433 </span>            :   //  Float_t dcaTPC[2]={0,0};
<span class="lineNum">    1434 </span>            :   // Float_t covTPC[3]={0,0,0};
<span class="lineNum">    1435 </span>            : 
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :   UInt_t specie = event-&gt;GetEventSpecie();  // skip laser events</span>
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :   if (specie==AliRecoParam::kCalib) return;</span>
<span class="lineNum">    1438 </span>            :   
<span class="lineNum">    1439 </span>            : 
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :   for (Int_t itrack0=0;itrack0&lt;ntracks;itrack0++) {</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :     AliESDtrack *track0 = event-&gt;GetTrack(itrack0);</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :     if (!track0) continue;</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :     if (!track0-&gt;IsOn(AliESDtrack::kTPCrefit)) continue;</span>
<span class="lineNum">    1444 </span>            : 
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :     if (TMath::Abs(AliTracker::GetBz())&gt;1&amp;&amp;track0-&gt;Pt()&lt;kMinPt) continue;</span>
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :     if (track0-&gt;GetTPCncls()&lt;kMinNcl) continue;</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :     if (TMath::Abs(track0-&gt;GetY())&lt;2*kMaxDelta[0]) continue; </span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :     if (TMath::Abs(track0-&gt;GetY())&gt;kMaxImpact) continue; </span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :     if (track0-&gt;GetKinkIndex(0)&gt;0) continue;</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :     const Double_t * par0=track0-&gt;GetParameter(); //track param at rhe DCA</span>
<span class="lineNum">    1451 </span>            :     //rm primaries
<span class="lineNum">    1452 </span>            :     //
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :     for (Int_t itrack1=itrack0+1;itrack1&lt;ntracks;itrack1++) {</span>
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :       AliESDtrack *track1 = event-&gt;GetTrack(itrack1);</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :       if (!track1) continue;  </span>
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :       if (!track1-&gt;IsOn(AliESDtrack::kTPCrefit)) continue;</span>
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :       if (track1-&gt;GetKinkIndex(0)&gt;0) continue;</span>
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :       if (TMath::Abs(AliTracker::GetBz())&gt;1&amp;&amp;track1-&gt;Pt()&lt;kMinPt) continue;</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :       if (track1-&gt;GetTPCncls()&lt;kMinNcl) continue;</span>
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :       if (TMath::Abs(AliTracker::GetBz())&gt;1&amp;&amp;TMath::Max(track1-&gt;Pt(), track0-&gt;Pt())&lt;kMinPtMax) continue;</span>
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :       if (TMath::Abs(track1-&gt;GetY())&lt;2*kMaxDelta[0]) continue;</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :       if (TMath::Abs(track1-&gt;GetY())&gt;kMaxImpact) continue; </span>
<span class="lineNum">    1463 </span>            :       //
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :       const Double_t* par1=track1-&gt;GetParameter(); //track param at rhe DCA</span>
<span class="lineNum">    1465 </span>            :       //
<span class="lineNum">    1466 </span>            :       Bool_t isPair=kTRUE;
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :       for (Int_t ipar=0; ipar&lt;5; ipar++){</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :         if (ipar==4&amp;&amp;TMath::Abs(AliTracker::GetBz())&lt;1) continue; // 1/pt not defined for B field off</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :         if (TMath::Abs(TMath::Abs(par0[ipar])-TMath::Abs(par1[ipar]))&gt;kMaxDelta[ipar]) isPair=kFALSE;</span>
<span class="lineNum">    1470 </span>            :       }
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :       if (!isPair) continue;</span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :       if (TMath::Abs(TMath::Abs(track0-&gt;GetAlpha()-track1-&gt;GetAlpha())-TMath::Pi())&gt;kMaxDelta[2]) isPair=kFALSE;</span>
<span class="lineNum">    1473 </span>            :       //delta with correct sign
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :       if  (TMath::Abs(par0[0]+par1[0])&gt;kMaxDelta[0]) isPair=kFALSE; //delta y   opposite sign</span>
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :       if  (TMath::Abs(par0[3]+par1[3])&gt;kMaxDelta[3]) isPair=kFALSE; //delta tgl opposite sign</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :       if  (TMath::Abs(AliTracker::GetBz())&gt;1 &amp;&amp; TMath::Abs(par0[4]+par1[4])&gt;kMaxDelta[4]) isPair=kFALSE; //delta 1/pt opposite sign</span>
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :       if (!isPair) continue;</span>
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :       TString filename(AliAnalysisManager::GetAnalysisManager()-&gt;GetTree()-&gt;GetCurrentFile()-&gt;GetName());</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :       Int_t eventNumber = event-&gt;GetEventNumberInFile(); </span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :       Bool_t hasFriend=(esdFriend) ? track0-&gt;GetFriendTrack() : 0;// (esdFriend-&gt;GetTrack(itrack0)!=0):0; </span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :       Bool_t hasITS=(track0-&gt;GetNcls(0)+track1-&gt;GetNcls(0)&gt;4);</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :       AliInfo(Form(&quot;DUMPHPTCosmic:%s|%f|%d|%d|%d\n&quot;,filename.Data(),(TMath::Min(track0-&gt;Pt(),track1-&gt;Pt())), eventNumber,hasFriend,hasITS));</span>
<span class="lineNum">    1483 </span>            :       //
<span class="lineNum">    1484 </span>            :       //       
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :       TTreeSRedirector * pcstream =  GetDebugStreamer();</span>
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :       Int_t ntracksSPD = vertexSPD-&gt;GetNContributors();</span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :       Int_t ntracksTPC = vertexTPC-&gt;GetNContributors();</span>
<span class="lineNum">    1488 </span>            :       //
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :       if (pcstream){</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :         (*pcstream)&lt;&lt;&quot;cosmicPairsAll&quot;&lt;&lt;</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :           &quot;run=&quot;&lt;&lt;fRun&lt;&lt;              //  run number</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :           &quot;event=&quot;&lt;&lt;fEvent&lt;&lt;          //  event number</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :           &quot;time=&quot;&lt;&lt;fTime&lt;&lt;            //  time stamp of event</span>
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 :           &quot;trigger=&quot;&lt;&lt;fTrigger&lt;&lt;      //  trigger</span>
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :           &quot;triggerClass=&quot;&lt;&lt;&amp;fTriggerClass&lt;&lt;      //  trigger</span>
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :           &quot;bz=&quot;&lt;&lt;fMagF&lt;&lt;             //  magnetic field</span>
<span class="lineNum">    1497 </span>            :           //
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :           &quot;nSPD=&quot;&lt;&lt;ntracksSPD&lt;&lt;</span>
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :           &quot;nTPC=&quot;&lt;&lt;ntracksTPC&lt;&lt;</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :           &quot;vSPD.=&quot;&lt;&lt;vertexSPD&lt;&lt;         //primary vertex -SPD</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :           &quot;vTPC.=&quot;&lt;&lt;vertexTPC&lt;&lt;         //primary vertex -TPC</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :           &quot;t0.=&quot;&lt;&lt;track0&lt;&lt;              //track0</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :           &quot;t1.=&quot;&lt;&lt;track1&lt;&lt;              //track1</span>
<span class="lineNum">    1504 </span>            :           &quot;\n&quot;;      
<span class="lineNum">    1505 </span>            :       }
<span class="lineNum">    1506 </span>            :       //
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :       AliESDfriendTrack *friendTrack0 = (AliESDfriendTrack*)track0-&gt;GetFriendTrack(); //esdFriend-&gt;GetTrack(itrack0);</span>
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :       if (!friendTrack0) continue;</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :       AliESDfriendTrack *friendTrack1 = (AliESDfriendTrack*)track1-&gt;GetFriendTrack(); //esdFriend-&gt;GetTrack(itrack1);</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :       if (!friendTrack1) continue;</span>
<span class="lineNum">    1511 </span>            :       TObject *calibObject;
<span class="lineNum">    1512 </span>            :       AliTPCseed *seed0 = 0;   
<span class="lineNum">    1513 </span>            :       AliTPCseed *seed1 = 0;
<span class="lineNum">    1514 </span>            :       //
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :       for (Int_t l=0;(calibObject=friendTrack0-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :         if ((seed0=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1517 </span>            :       }
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :       for (Int_t l=0;(calibObject=friendTrack1-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :         if ((seed1=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1520 </span>            :       }
<span class="lineNum">    1521 </span>            :       //
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :       if (pcstream){</span>
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :         (*pcstream)&lt;&lt;&quot;cosmicPairs&quot;&lt;&lt;</span>
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :           &quot;run=&quot;&lt;&lt;fRun&lt;&lt;              //  run number</span>
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :           &quot;event=&quot;&lt;&lt;fEvent&lt;&lt;          //  event number</span>
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :           &quot;time=&quot;&lt;&lt;fTime&lt;&lt;            //  time stamp of event</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :           &quot;trigger=&quot;&lt;&lt;fTrigger&lt;&lt;      //  trigger</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :           &quot;triggerClass=&quot;&lt;&lt;&amp;fTriggerClass&lt;&lt;      //  trigger</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :           &quot;bz=&quot;&lt;&lt;fMagF&lt;&lt;             //  magnetic field</span>
<span class="lineNum">    1530 </span>            :           //
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :           &quot;nSPD=&quot;&lt;&lt;ntracksSPD&lt;&lt;</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :           &quot;nTPC=&quot;&lt;&lt;ntracksTPC&lt;&lt;</span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :           &quot;vSPD.=&quot;&lt;&lt;vertexSPD&lt;&lt;         //primary vertex -SPD</span>
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :           &quot;vTPC.=&quot;&lt;&lt;vertexTPC&lt;&lt;         //primary vertex -TPC</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :           &quot;t0.=&quot;&lt;&lt;track0&lt;&lt;              //track0</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :           &quot;t1.=&quot;&lt;&lt;track1&lt;&lt;              //track1</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :           &quot;ft0.=&quot;&lt;&lt;friendTrack0&lt;&lt;       //track0</span>
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :           &quot;ft1.=&quot;&lt;&lt;friendTrack1&lt;&lt;       //track1</span>
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :           &quot;s0.=&quot;&lt;&lt;seed0&lt;&lt;               //track0</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :           &quot;s1.=&quot;&lt;&lt;seed1&lt;&lt;               //track1</span>
<span class="lineNum">    1541 </span>            :           &quot;\n&quot;;      
<span class="lineNum">    1542 </span>            :       }
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :       if (!seed0) continue;</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :       if (!seed1) continue;</span>
<span class="lineNum">    1545 </span>            :       Int_t nclA0=0, nclC0=0;     // number of clusters
<span class="lineNum">    1546 </span>            :       Int_t nclA1=0, nclC1=0;     // number of clusters
<span class="lineNum">    1547 </span>            :       //      
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :       for (Int_t irow=0; irow&lt;kMaxRow; irow++){</span>
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :         AliTPCclusterMI *cluster0=seed0-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 :         AliTPCclusterMI *cluster1=seed1-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :         if (cluster0){</span>
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :           if (cluster0-&gt;GetQ()&gt;0 &amp;&amp;  cluster0-&gt;GetDetector()%36&lt;18)  nclA0++;</span>
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :           if (cluster0-&gt;GetQ()&gt;0 &amp;&amp;  cluster0-&gt;GetDetector()%36&gt;=18) nclC0++;</span>
<span class="lineNum">    1554 </span>            :         }
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :         if (cluster1){</span>
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :           if (cluster1-&gt;GetQ()&gt;0 &amp;&amp;  cluster1-&gt;GetDetector()%36&lt;18)  nclA1++;</span>
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :           if (cluster1-&gt;GetQ()&gt;0 &amp;&amp;  cluster1-&gt;GetDetector()%36&gt;=18) nclC1++;</span>
<span class="lineNum">    1558 </span>            :         }
<span class="lineNum">    1559 </span>            :       }
<span class="lineNum">    1560 </span>            :       Int_t cosmicType=0;  // types of cosmic topology
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :       if ((nclA0&gt;nclC0) &amp;&amp; (nclA1&gt;nclC1)) cosmicType=0; // AA side</span>
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :       if ((nclA0&lt;nclC0) &amp;&amp; (nclA1&lt;nclC1)) cosmicType=1; // CC side</span>
<span class="lineNum">    1563 </span><span class="lineNoCov">          0 :       if ((nclA0&gt;nclC0) &amp;&amp; (nclA1&lt;nclC1)) cosmicType=2; // AC side</span>
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :       if ((nclA0&lt;nclC0) &amp;&amp; (nclA1&gt;nclC1)) cosmicType=3; // CA side</span>
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :       if (cosmicType&lt;2) continue; // use only crossing tracks</span>
<span class="lineNum">    1566 </span>            :       //
<span class="lineNum">    1567 </span>            :       Double_t deltaTimeCluster=0;
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :       deltaTimeCluster=0.5*(track1-&gt;GetZ()-track0-&gt;GetZ())/param-&gt;GetZWidth();</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :       if (nclA0&gt;nclC0) deltaTimeCluster*=-1; // if A side track</span>
<span class="lineNum">    1570 </span>            :       //
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :       for (Int_t irow=0; irow&lt;kMaxRow; irow++){</span>
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 :         AliTPCclusterMI *cluster0=seed0-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :         if (cluster0 &amp;&amp;cluster0-&gt;GetX()&gt;10){</span>
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :           Double_t x0[3]={ static_cast&lt;Double_t&gt;(cluster0-&gt;GetRow()),cluster0-&gt;GetPad(),cluster0-&gt;GetTimeBin()+deltaTimeCluster};</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :           Int_t index0[1]={cluster0-&gt;GetDetector()};</span>
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :           transform-&gt;Transform(x0,index0,0,1);  </span>
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :           cluster0-&gt;SetX(x0[0]);</span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :           cluster0-&gt;SetY(x0[1]);</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :           cluster0-&gt;SetZ(x0[2]);</span>
<span class="lineNum">    1580 </span>            :           //
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :         AliTPCclusterMI *cluster1=seed1-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :         if (cluster1&amp;&amp;cluster1-&gt;GetX()&gt;10){</span>
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :           Double_t x1[3]={ static_cast&lt;Double_t&gt;(cluster1-&gt;GetRow()),cluster1-&gt;GetPad(),cluster1-&gt;GetTimeBin()+deltaTimeCluster};</span>
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :           Int_t index1[1]={cluster1-&gt;GetDetector()};</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :           transform-&gt;Transform(x1,index1,0,1);  </span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :           cluster1-&gt;SetX(x1[0]);</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :           cluster1-&gt;SetY(x1[1]);</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :           cluster1-&gt;SetZ(x1[2]);</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :         }       </span>
<span class="lineNum">    1591 </span>            :       }
<span class="lineNum">    1592 </span>            :       //
<span class="lineNum">    1593 </span>            :       //
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :       if (fPIDMatrix){</span>
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :         (*fPIDMatrix)(itrack0,1)+=4;  //</span>
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :         (*fPIDMatrix)(itrack1,1)+=4;  //</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1601 </span>            : 
<a name="1602"><span class="lineNum">    1602 </span>            : </a>
<span class="lineNum">    1603 </span>            : 
<span class="lineNum">    1604 </span>            : void AliTPCcalibGainMult::ProcessKinks(const AliESDEvent * event){
<span class="lineNum">    1605 </span>            :   //
<span class="lineNum">    1606 </span>            :   //
<span class="lineNum">    1607 </span>            :   //
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :   AliKFParticle::SetField(event-&gt;GetMagneticField()); </span>
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :   AliESDfriend *esdFriend=static_cast&lt;AliESDfriend*&gt;(event-&gt;FindListObject(&quot;AliESDfriend&quot;));</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :   if (!esdFriend) {</span>
<span class="lineNum">    1611 </span>            :     //Printf(&quot;ERROR: esdFriend not available&quot;);
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1613 </span>            :   }
<span class="lineNum">    1614 </span>            :   //  if (esdFriend-&gt;TestSkipBit()) return;
<span class="lineNum">    1615 </span>            :   //
<span class="lineNum">    1616 </span>            :   // 
<span class="lineNum">    1617 </span>            :   const Double_t kChi2Cut=10;
<span class="lineNum">    1618 </span>            :   const Double_t kMinR=100;
<span class="lineNum">    1619 </span>            :   const Double_t kMaxR=230;
<span class="lineNum">    1620 </span>            :   const Int_t    kMinNcl=110;
<span class="lineNum">    1621 </span>            :   //
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :   Int_t nkinks = event-&gt;GetNumberOfKinks(); </span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :   AliESDVertex *vertex= (AliESDVertex *)event-&gt;GetPrimaryVertex();</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :   AliKFVertex kfvertex=*vertex;</span>
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :   TTreeSRedirector * pcstream =  GetDebugStreamer();</span>
<span class="lineNum">    1626 </span>            :   //
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :   for (Int_t ikink=0;ikink&lt;nkinks;ikink++){</span>
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :     AliESDkink *kink = event-&gt;GetKink(ikink);</span>
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :     if (!kink) continue;</span>
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :     if (kink-&gt;GetIndex(0)&lt;0) continue;</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 :     if (kink-&gt;GetIndex(1)&lt;0) continue;</span>
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :     if (TMath::Max(kink-&gt;GetIndex(1), kink-&gt;GetIndex(0))&gt;event-&gt;GetNumberOfTracks()) continue;</span>
<span class="lineNum">    1633 </span>            :     //
<span class="lineNum">    1634 </span>            :     //   
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :     AliExternalTrackParam pd=kink-&gt;RefParamDaughter();</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :     AliExternalTrackParam pm=kink-&gt;RefParamMother();</span>
<span class="lineNum">    1637 </span><span class="lineNoCov">          0 :     AliKFParticle kfpd( pd, 211 );</span>
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :     AliKFParticle kfpm( pm, -13 );</span>
<span class="lineNum">    1639 </span>            :     //
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :     AliKFParticle *v0KF = new AliKFParticle(kfpm,kfpd); </span>
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :     v0KF-&gt;SetVtxGuess(kink-&gt;GetPosition()[0],kink-&gt;GetPosition()[1],kink-&gt;GetPosition()[2]);</span>
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :     Double_t chi2 = v0KF-&gt;GetChi2();</span>
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :     AliESDtrack * trackM = event-&gt;GetTrack(kink-&gt;GetIndex(0));</span>
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :     AliESDtrack * trackD = event-&gt;GetTrack(kink-&gt;GetIndex(1));</span>
<span class="lineNum">    1645 </span><span class="lineNoCov">          0 :     if (!trackM) continue;</span>
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :     if (!trackD) continue;</span>
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :     Int_t nclM= (Int_t)trackM-&gt;GetTPCClusterInfo(2,1);</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :     Int_t nclD= (Int_t)trackD-&gt;GetTPCClusterInfo(2,1);</span>
<span class="lineNum">    1649 </span><span class="lineNoCov">          0 :     Double_t eta = TMath::Max(TMath::Abs(trackM-&gt;Eta()), TMath::Abs(trackD-&gt;Eta()));</span>
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :     Double_t kx= v0KF-&gt;GetX();</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :     Double_t ky= v0KF-&gt;GetY();</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :     Double_t kz= v0KF-&gt;GetZ();</span>
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :     Double_t ex= v0KF-&gt;GetErrX();</span>
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :     Double_t ey= v0KF-&gt;GetErrY();</span>
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :     Double_t ez= v0KF-&gt;GetErrZ();</span>
<span class="lineNum">    1656 </span>            :     //
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :     Double_t radius=TMath::Sqrt(kx*kx+ky*ky);</span>
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :     Double_t alpha=TMath::ATan2(ky,kx);</span>
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :     if (!pd.Rotate(alpha)) continue;</span>
<span class="lineNum">    1660 </span><span class="lineNoCov">          0 :     if (!pm.Rotate(alpha)) continue;</span>
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :     if (!pd.PropagateTo(radius,event-&gt;GetMagneticField())) continue;</span>
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :     if (!pm.PropagateTo(radius,event-&gt;GetMagneticField())) continue;</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :     Double_t pos[2]={0,kz};</span>
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 :     Double_t cov[3]={ex*ex+ey*ey,0,ez*ez};</span>
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :     pd.Update(pos,cov);</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :     pm.Update(pos,cov);</span>
<span class="lineNum">    1667 </span>            :     //
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :     if (pcstream){</span>
<span class="lineNum">    1669 </span><span class="lineNoCov">          0 :       (*pcstream)&lt;&lt;&quot;kinks&quot;&lt;&lt;</span>
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :         &quot;eta=&quot;&lt;&lt;eta&lt;&lt;</span>
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :         &quot;nclM=&quot;&lt;&lt;nclM&lt;&lt;</span>
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :         &quot;nclD=&quot;&lt;&lt;nclD&lt;&lt;</span>
<span class="lineNum">    1673 </span><span class="lineNoCov">          0 :         &quot;kink.=&quot;&lt;&lt;kink&lt;&lt;</span>
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :         &quot;trackM.=&quot;&lt;&lt;trackM&lt;&lt;</span>
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :         &quot;trackD.=&quot;&lt;&lt;trackD&lt;&lt;</span>
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :         &quot;pm.=&quot;&lt;&lt;&amp;pm&lt;&lt;             //updated parameters</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :         &quot;pd.=&quot;&lt;&lt;&amp;pd&lt;&lt;             // updated parameters</span>
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 :         &quot;v0KF.=&quot;&lt;&lt;v0KF&lt;&lt;</span>
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :         &quot;chi2=&quot;&lt;&lt;chi2&lt;&lt;</span>
<span class="lineNum">    1680 </span>            :         &quot;\n&quot;;
<span class="lineNum">    1681 </span>            :     }
<span class="lineNum">    1682 </span>            :     /*
<span class="lineNum">    1683 </span>            :       TCut cutQ=&quot;chi2&lt;10&amp;&amp;kink.fRr&gt;90&amp;&amp;kink.fRr&lt;220&quot;;
<span class="lineNum">    1684 </span>            :       TCut cutRD=&quot;20*sqrt(pd.fC[14])&lt;abs(pd.fP[4])&amp;&amp;trackD.fTPCsignal&gt;10&amp;&amp;trackD.fTPCsignalN&gt;50&quot;;
<span class="lineNum">    1685 </span>            :       
<span class="lineNum">    1686 </span>            :     */
<span class="lineNum">    1687 </span>            :     //
<span class="lineNum">    1688 </span><span class="lineNoCov">          0 :     if (chi2&gt;kChi2Cut) continue;</span>
<span class="lineNum">    1689 </span><span class="lineNoCov">          0 :     if (kink-&gt;GetR()&lt;kMinR) continue;</span>
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :     if (kink-&gt;GetR()&gt;kMaxR) continue;</span>
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :     if ((nclM+nclD)&lt;kMinNcl) continue;</span>
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :     if (TMath::Abs(eta)&gt;1) continue;</span>
<span class="lineNum">    1693 </span>            :     //
<span class="lineNum">    1694 </span>            :     //
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :     AliESDfriendTrack *friendTrackM = (AliESDfriendTrack*)trackM-&gt;GetFriendTrack();// esdFriend-&gt;GetTrack(kink-&gt;GetIndex(0));</span>
<span class="lineNum">    1696 </span><span class="lineNoCov">          0 :     AliESDfriendTrack *friendTrackD = (AliESDfriendTrack*)trackD-&gt;GetFriendTrack();//esdFriend-&gt;GetTrack(kink-&gt;GetIndex(1));</span>
<span class="lineNum">    1697 </span><span class="lineNoCov">          0 :     if (!friendTrackM) continue;</span>
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :     if (!friendTrackD) continue;</span>
<span class="lineNum">    1699 </span>            :     TObject *calibObject;
<span class="lineNum">    1700 </span>            :     AliTPCseed *seedM = 0;
<span class="lineNum">    1701 </span>            :     AliTPCseed *seedD = 0;
<span class="lineNum">    1702 </span><span class="lineNoCov">          0 :     for (Int_t l=0;(calibObject=friendTrackM-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :       if ((seedM=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1704 </span>            :     }    
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :     for (Int_t l=0;(calibObject=friendTrackD-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :       if ((seedD=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1707 </span>            :     }    
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :   }</span>
<a name="1709"><span class="lineNum">    1709 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1710 </span>            : 
<span class="lineNum">    1711 </span>            : void AliTPCcalibGainMult::DumpHPT(const AliESDEvent * event){
<span class="lineNum">    1712 </span>            :   //
<span class="lineNum">    1713 </span>            :   // Function to select the HPT tracks and events
<span class="lineNum">    1714 </span>            :   // It is used to select event with HPT - list used later for the raw data downloading
<span class="lineNum">    1715 </span>            :   //                                     - and reconstruction
<span class="lineNum">    1716 </span>            :   // Not actualy used for the calibration of the data
<span class="lineNum">    1717 </span>            : 
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :   TTreeSRedirector * pcstream =  GetDebugStreamer();</span>
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 :   AliKFParticle::SetField(event-&gt;GetMagneticField()); </span>
<span class="lineNum">    1720 </span><span class="lineNoCov">          0 :   AliESDfriend *esdFriend=static_cast&lt;AliESDfriend*&gt;(event-&gt;FindListObject(&quot;AliESDfriend&quot;));</span>
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :   if (!esdFriend) {</span>
<span class="lineNum">    1722 </span>            :     //Printf(&quot;ERROR: esdFriend not available&quot;);
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :    return;</span>
<span class="lineNum">    1724 </span>            :   }
<span class="lineNum">    1725 </span><span class="lineNoCov">          0 :   if (esdFriend-&gt;TestSkipBit()) return;</span>
<span class="lineNum">    1726 </span>            : 
<span class="lineNum">    1727 </span><span class="lineNoCov">          0 :   Int_t ntracks=event-&gt;GetNumberOfTracks(); </span>
<span class="lineNum">    1728 </span>            :   //
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;ntracks;++i) {</span>
<span class="lineNum">    1730 </span>            :     //
<span class="lineNum">    1731 </span><span class="lineNoCov">          0 :     AliESDtrack *track = event-&gt;GetTrack(i);</span>
<span class="lineNum">    1732 </span><span class="lineNoCov">          0 :     if (!track) continue;</span>
<span class="lineNum">    1733 </span><span class="lineNoCov">          0 :     if (track-&gt;Pt()&lt;4) continue; </span>
<span class="lineNum">    1734 </span><span class="lineNoCov">          0 :     UInt_t status = track-&gt;GetStatus();</span>
<span class="lineNum">    1735 </span>            :     //   
<span class="lineNum">    1736 </span><span class="lineNoCov">          0 :     AliExternalTrackParam * trackIn  = (AliExternalTrackParam *)track-&gt;GetInnerParam();</span>
<span class="lineNum">    1737 </span><span class="lineNoCov">          0 :     if (!trackIn) continue;</span>
<span class="lineNum">    1738 </span><span class="lineNoCov">          0 :     if ((status&amp;AliESDtrack::kTPCrefit)==0) continue;</span>
<span class="lineNum">    1739 </span><span class="lineNoCov">          0 :     if ((status&amp;AliESDtrack::kITSrefit)==0) continue;</span>
<span class="lineNum">    1740 </span><span class="lineNoCov">          0 :     AliESDfriendTrack *friendTrack = (AliESDfriendTrack*)track-&gt;GetFriendTrack(); //esdFriend-&gt;GetTrack(i);</span>
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :     if (!friendTrack) continue;</span>
<span class="lineNum">    1742 </span><span class="lineNoCov">          0 :     AliExternalTrackParam * itsOut = (AliExternalTrackParam *)(friendTrack-&gt;GetITSOut());</span>
<span class="lineNum">    1743 </span><span class="lineNoCov">          0 :     if (!itsOut) continue;</span>
<span class="lineNum">    1744 </span><span class="lineNoCov">          0 :     AliExternalTrackParam * itsOut2 = (AliExternalTrackParam *)(friendTrack-&gt;GetITSOut()-&gt;Clone());</span>
<span class="lineNum">    1745 </span><span class="lineNoCov">          0 :     AliExternalTrackParam * tpcIn2 = (AliExternalTrackParam *)(trackIn-&gt;Clone());</span>
<span class="lineNum">    1746 </span><span class="lineNoCov">          0 :     if (!itsOut2-&gt;Rotate(trackIn-&gt;GetAlpha())) continue;</span>
<span class="lineNum">    1747 </span>            :     //Double_t xmiddle=0.5*(itsOut2-&gt;GetX()+tpcIn2-&gt;GetX());
<span class="lineNum">    1748 </span><span class="lineNoCov">          0 :     Double_t xmiddle=(itsOut2-&gt;GetX());</span>
<span class="lineNum">    1749 </span><span class="lineNoCov">          0 :     if (!itsOut2-&gt;PropagateTo(xmiddle,event-&gt;GetMagneticField())) continue;</span>
<span class="lineNum">    1750 </span><span class="lineNoCov">          0 :     if (!tpcIn2-&gt;PropagateTo(xmiddle,event-&gt;GetMagneticField())) continue;</span>
<span class="lineNum">    1751 </span>            :     //
<span class="lineNum">    1752 </span><span class="lineNoCov">          0 :     AliExternalTrackParam * tpcInner = (AliExternalTrackParam *)(track-&gt;GetTPCInnerParam());</span>
<span class="lineNum">    1753 </span><span class="lineNoCov">          0 :     if (!tpcInner) continue;</span>
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :     tpcInner-&gt;Rotate(track-&gt;GetAlpha());</span>
<span class="lineNum">    1755 </span><span class="lineNoCov">          0 :     tpcInner-&gt;PropagateTo(track-&gt;GetX(),event-&gt;GetMagneticField());</span>
<span class="lineNum">    1756 </span>            :     //
<span class="lineNum">    1757 </span>            :     // tpc constrained
<span class="lineNum">    1758 </span>            :     //
<span class="lineNum">    1759 </span><span class="lineNoCov">          0 :     AliExternalTrackParam * tpcInnerC = (AliExternalTrackParam *)(track-&gt;GetTPCInnerParam()-&gt;Clone());</span>
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :     if (!tpcInnerC) continue;</span>
<span class="lineNum">    1761 </span><span class="lineNoCov">          0 :     tpcInnerC-&gt;Rotate(track-&gt;GetAlpha());</span>
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :     tpcInnerC-&gt;PropagateTo(track-&gt;GetX(),event-&gt;GetMagneticField());</span>
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 :     Double_t dz[2],cov[3];</span>
<span class="lineNum">    1764 </span><span class="lineNoCov">          0 :     AliESDVertex *vtx= (AliESDVertex *)event-&gt;GetPrimaryVertex();</span>
<span class="lineNum">    1765 </span>            :   
<span class="lineNum">    1766 </span><span class="lineNoCov">          0 :     if (!tpcInnerC-&gt;PropagateToDCA(vtx, event-&gt;GetMagneticField(), 3, dz, cov)) continue;</span>
<span class="lineNum">    1767 </span><span class="lineNoCov">          0 :     Double_t covar[6]; vtx-&gt;GetCovMatrix(covar);</span>
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :     Double_t p[2]={tpcInnerC-&gt;GetParameter()[0]-dz[0],tpcInnerC-&gt;GetParameter()[1]-dz[1]};</span>
<span class="lineNum">    1769 </span><span class="lineNoCov">          0 :     Double_t c[3]={covar[2],0.,covar[5]};</span>
<span class="lineNum">    1770 </span>            :     //
<span class="lineNum">    1771 </span><span class="lineNoCov">          0 :     Double_t chi2C=tpcInnerC-&gt;GetPredictedChi2(p,c);</span>
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :     tpcInnerC-&gt;Update(p,c);</span>
<span class="lineNum">    1773 </span>            : 
<span class="lineNum">    1774 </span><span class="lineNoCov">          0 :     if (pcstream){</span>
<span class="lineNum">    1775 </span><span class="lineNoCov">          0 :       (*pcstream)&lt;&lt;&quot;hpt&quot;&lt;&lt;</span>
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :         &quot;run=&quot;&lt;&lt;fRun&lt;&lt;</span>
<span class="lineNum">    1777 </span><span class="lineNoCov">          0 :         &quot;time=&quot;&lt;&lt;fTime&lt;&lt;</span>
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :         &quot;vertex=&quot;&lt;&lt;vtx&lt;&lt;</span>
<span class="lineNum">    1779 </span><span class="lineNoCov">          0 :         &quot;bz=&quot;&lt;&lt;fMagF&lt;&lt;</span>
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :         &quot;track.=&quot;&lt;&lt;track&lt;&lt;</span>
<span class="lineNum">    1781 </span><span class="lineNoCov">          0 :         &quot;tpcInner.=&quot;&lt;&lt;tpcInner&lt;&lt;</span>
<span class="lineNum">    1782 </span><span class="lineNoCov">          0 :         &quot;tpcInnerC.=&quot;&lt;&lt;tpcInnerC&lt;&lt;</span>
<span class="lineNum">    1783 </span><span class="lineNoCov">          0 :         &quot;chi2C=&quot;&lt;&lt;chi2C&lt;&lt;</span>
<span class="lineNum">    1784 </span>            :         //
<span class="lineNum">    1785 </span><span class="lineNoCov">          0 :         &quot;its.=&quot;&lt;&lt;itsOut&lt;&lt;</span>
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :         &quot;its2.=&quot;&lt;&lt;itsOut2&lt;&lt;</span>
<span class="lineNum">    1787 </span><span class="lineNoCov">          0 :         &quot;tpc.=&quot;&lt;&lt;trackIn&lt;&lt;</span>
<span class="lineNum">    1788 </span><span class="lineNoCov">          0 :         &quot;tpc2.=&quot;&lt;&lt;tpcIn2&lt;&lt;</span>
<span class="lineNum">    1789 </span>            :         &quot;\n&quot;;
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1792 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1793 </span>            : 
<a name="1794"><span class="lineNum">    1794 </span>            : </a>
<span class="lineNum">    1795 </span>            : 
<span class="lineNum">    1796 </span>            : void AliTPCcalibGainMult::ProcessTOF(const AliESDEvent * event){
<span class="lineNum">    1797 </span>            :   //
<span class="lineNum">    1798 </span>            :   // 1. Loop over tracks
<span class="lineNum">    1799 </span>            :   // 2. Fit T0
<span class="lineNum">    1800 </span>            :   // 3. Sign positivelly identified tracks
<span class="lineNum">    1801 </span>            :   // 
<span class="lineNum">    1802 </span>            :   const Double_t kMaxDelta=1000;
<span class="lineNum">    1803 </span>            :   const Double_t kOrbit=50000; // distance in the time beween two orbits in the TOF time units  - 50000=50 ns
<span class="lineNum">    1804 </span>            :   const Double_t kMaxD=20;
<span class="lineNum">    1805 </span>            :   const Double_t kRMS0=200; 
<span class="lineNum">    1806 </span>            :   const Double_t kMaxDCAZ=10;
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 :   AliESDVertex *vtx= (AliESDVertex *)event-&gt;GetPrimaryVertex();</span>
<span class="lineNum">    1808 </span>            :   //
<span class="lineNum">    1809 </span><span class="lineNoCov">          0 :   TTreeSRedirector * pcstream =  GetDebugStreamer();</span>
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :   AliKFParticle::SetField(event-&gt;GetMagneticField()); </span>
<span class="lineNum">    1811 </span><span class="lineNoCov">          0 :   AliESDfriend *esdFriend=static_cast&lt;AliESDfriend*&gt;(event-&gt;FindListObject(&quot;AliESDfriend&quot;));</span>
<span class="lineNum">    1812 </span><span class="lineNoCov">          0 :   if (!esdFriend) {</span>
<span class="lineNum">    1813 </span>            :     //Printf(&quot;ERROR: esdFriend not available&quot;);
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :    return;</span>
<span class="lineNum">    1815 </span>            :   }
<span class="lineNum">    1816 </span>            :   //if (esdFriend-&gt;TestSkipBit()) return;
<span class="lineNum">    1817 </span>            : 
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :   Int_t ntracks=event-&gt;GetNumberOfTracks(); </span>
<span class="lineNum">    1819 </span>            :   //
<span class="lineNum">    1820 </span><span class="lineNoCov">          0 :   Double_t deltaTPion[10000];</span>
<span class="lineNum">    1821 </span><span class="lineNoCov">          0 :   Double_t medianT0=0;</span>
<span class="lineNum">    1822 </span><span class="lineNoCov">          0 :   Double_t meanT0=0;</span>
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :   Double_t rms=10000;</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :   Int_t counter=0;</span>
<span class="lineNum">    1825 </span>            :   //
<span class="lineNum">    1826 </span>            :   // Get Median time for pion hypothesy
<span class="lineNum">    1827 </span>            :   //
<span class="lineNum">    1828 </span><span class="lineNoCov">          0 :   for (Int_t iter=0; iter&lt;3; iter++){</span>
<span class="lineNum">    1829 </span><span class="lineNoCov">          0 :     counter=0;</span>
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :     for (Int_t i=0;i&lt;ntracks;++i) {</span>
<span class="lineNum">    1831 </span>            :       //
<span class="lineNum">    1832 </span><span class="lineNoCov">          0 :       AliESDtrack *track = event-&gt;GetTrack(i);</span>
<span class="lineNum">    1833 </span><span class="lineNoCov">          0 :       if (!track) continue;</span>
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :       if (!track-&gt;IsOn(AliESDtrack::kTIME)) continue;</span>
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :       if (TMath::Abs(track-&gt;GetZ())&gt;kMaxDCAZ) continue;         // remove overlaped events</span>
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :       if (TMath::Abs(track-&gt;GetTOFsignalDz())&gt;kMaxD) continue;</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :       Double_t times[1000];</span>
<span class="lineNum">    1838 </span><span class="lineNoCov">          0 :       track-&gt;GetIntegratedTimes(times);</span>
<span class="lineNum">    1839 </span><span class="lineNoCov">          0 :       Int_t norbit=TMath::Nint((track-&gt;GetTOFsignal()-times[2])/kOrbit);</span>
<span class="lineNum">    1840 </span><span class="lineNoCov">          0 :       Double_t torbit=norbit*kOrbit; </span>
<span class="lineNum">    1841 </span><span class="lineNoCov">          0 :       if (iter==1 &amp;&amp;TMath::Abs(times[2]-times[3])&lt;3*rms) continue;  // skip umbigous points - kaon pion</span>
<span class="lineNum">    1842 </span>            :       //
<span class="lineNum">    1843 </span>            :       Int_t indexBest=2;
<span class="lineNum">    1844 </span><span class="lineNoCov">          0 :       if (iter&gt;1){</span>
<span class="lineNum">    1845 </span><span class="lineNoCov">          0 :         for (Int_t j=3; j&lt;5; j++) </span>
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :           if (TMath::Abs(track-&gt;GetTOFsignal()-times[j]-torbit-medianT0)&lt;TMath::Abs(track-&gt;GetTOFsignal()-times[j]-torbit-medianT0)) indexBest=j; </span>
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1848 </span>            :       //
<span class="lineNum">    1849 </span><span class="lineNoCov">          0 :       if (iter&gt;0) if (TMath::Abs(track-&gt;GetTOFsignal()-times[indexBest]-torbit-medianT0)&gt;3*(kRMS0+rms)) continue;</span>
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :       if (iter&gt;0) if (TMath::Abs(track-&gt;GetTOFsignal()-times[indexBest]-torbit-medianT0)&gt;kMaxDelta) continue;</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :       deltaTPion[counter]=track-&gt;GetTOFsignal()-times[indexBest]-torbit;</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :       counter++;</span>
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :     }    </span>
<span class="lineNum">    1854 </span><span class="lineNoCov">          0 :     if (counter&lt;2) return;</span>
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :     medianT0=TMath::Median(counter,deltaTPion);    </span>
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :     meanT0=TMath::Median(counter,deltaTPion);    </span>
<span class="lineNum">    1857 </span><span class="lineNoCov">          0 :     rms=TMath::RMS(counter,deltaTPion);    </span>
<span class="lineNum">    1858 </span>            :   }
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 :   if (counter&lt;3) return;</span>
<span class="lineNum">    1860 </span>            :   //
<span class="lineNum">    1861 </span>            :   // Dump
<span class="lineNum">    1862 </span>            :   //
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;ntracks;++i) {</span>
<span class="lineNum">    1864 </span>            :     //
<span class="lineNum">    1865 </span><span class="lineNoCov">          0 :     AliESDtrack *track = event-&gt;GetTrack(i);</span>
<span class="lineNum">    1866 </span><span class="lineNoCov">          0 :     if (!track) continue;</span>
<span class="lineNum">    1867 </span><span class="lineNoCov">          0 :     if (!track-&gt;IsOn(AliESDtrack::kTIME)) continue;</span>
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :     if (TMath::Abs(track-&gt;GetZ())&gt;kMaxDCAZ) continue;          //remove overlapped events</span>
<span class="lineNum">    1869 </span><span class="lineNoCov">          0 :     if (TMath::Abs(track-&gt;GetTOFsignalDz())&gt;kMaxD) continue;</span>
<span class="lineNum">    1870 </span><span class="lineNoCov">          0 :     Double_t times[1000];</span>
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :     track-&gt;GetIntegratedTimes(times);  </span>
<span class="lineNum">    1872 </span><span class="lineNoCov">          0 :     Int_t norbit=TMath::Nint((track-&gt;GetTOFsignal()-times[2])/kOrbit);</span>
<span class="lineNum">    1873 </span><span class="lineNoCov">          0 :     Double_t torbit=norbit*kOrbit;</span>
<span class="lineNum">    1874 </span><span class="lineNoCov">          0 :     if (rms&lt;=0) continue;</span>
<span class="lineNum">    1875 </span>            :     //
<span class="lineNum">    1876 </span><span class="lineNoCov">          0 :     Double_t tPion  = (track-&gt;GetTOFsignal()-times[2]-medianT0-torbit);</span>
<span class="lineNum">    1877 </span><span class="lineNoCov">          0 :     Double_t tKaon  = (track-&gt;GetTOFsignal()-times[3]-medianT0-torbit);</span>
<span class="lineNum">    1878 </span><span class="lineNoCov">          0 :     Double_t tProton= (track-&gt;GetTOFsignal()-times[4]-medianT0-torbit);</span>
<span class="lineNum">    1879 </span><span class="lineNoCov">          0 :     Double_t tElectron= (track-&gt;GetTOFsignal()-times[0]-medianT0-torbit);</span>
<span class="lineNum">    1880 </span>            :     //
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 :     Bool_t isPion   = (TMath::Abs(tPion/rms)&lt;6)   &amp;&amp; TMath::Abs(tPion)&lt;(TMath::Min(TMath::Abs(tKaon), TMath::Abs(tProton))-rms);</span>
<span class="lineNum">    1882 </span><span class="lineNoCov">          0 :     Bool_t isKaon   = (TMath::Abs(tKaon/rms)&lt;3)   &amp;&amp; TMath::Abs(tKaon)&lt;0.2*(TMath::Min(TMath::Abs(tPion), TMath::Abs(tProton))-3*rms);</span>
<span class="lineNum">    1883 </span><span class="lineNoCov">          0 :     Bool_t isProton = (TMath::Abs(tProton/rms)&lt;6) &amp;&amp; TMath::Abs(tProton)&lt;0.5*(TMath::Min(TMath::Abs(tKaon), TMath::Abs(tPion))-rms);</span>
<span class="lineNum">    1884 </span><span class="lineNoCov">          0 :     Bool_t isElectron = (TMath::Abs(tElectron/rms)&lt;6) &amp;&amp; TMath::Abs(tElectron)&lt;0.2*(TMath::Min(TMath::Abs(tKaon), TMath::Abs(tPion))-rms) &amp;&amp;TMath::Abs(tElectron)&lt;0.5*(TMath::Abs(tPion)-rms);</span>
<span class="lineNum">    1885 </span>            : 
<span class="lineNum">    1886 </span><span class="lineNoCov">          0 :     if (isPion)   (*fPIDMatrix)(i,2)+=1;</span>
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :     if (isKaon)   (*fPIDMatrix)(i,3)+=1;</span>
<span class="lineNum">    1888 </span><span class="lineNoCov">          0 :     if (isProton) (*fPIDMatrix)(i,4)+=1;</span>
<span class="lineNum">    1889 </span>            :     //    if (isElectron) (*fPIDMatrix)(i,0)+=1;
<span class="lineNum">    1890 </span>            :     //
<span class="lineNum">    1891 </span><span class="lineNoCov">          0 :     if (pcstream){</span>
<span class="lineNum">    1892 </span>            :       // debug streamer to dump the information 
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 :     (*pcstream)&lt;&lt;&quot;tof&quot;&lt;&lt;</span>
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :       &quot;isPion=&quot;&lt;&lt;isPion&lt;&lt;</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :       &quot;isKaon=&quot;&lt;&lt;isKaon&lt;&lt;</span>
<span class="lineNum">    1896 </span><span class="lineNoCov">          0 :       &quot;isProton=&quot;&lt;&lt;isProton&lt;&lt;</span>
<span class="lineNum">    1897 </span><span class="lineNoCov">          0 :       &quot;isElectron=&quot;&lt;&lt;isElectron&lt;&lt;</span>
<span class="lineNum">    1898 </span>            :       //
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :       &quot;counter=&quot;&lt;&lt;counter&lt;&lt;</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :       &quot;torbit=&quot;&lt;&lt;torbit&lt;&lt;</span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :       &quot;norbit=&quot;&lt;&lt;norbit&lt;&lt;</span>
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :       &quot;medianT0=&quot;&lt;&lt;medianT0&lt;&lt;</span>
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :       &quot;meanT0=&quot;&lt;&lt;meanT0&lt;&lt;</span>
<span class="lineNum">    1904 </span><span class="lineNoCov">          0 :       &quot;rmsT0=&quot;&lt;&lt;rms&lt;&lt;</span>
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :       &quot;track.=&quot;&lt;&lt;track&lt;&lt;</span>
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :       &quot;vtx.=&quot;&lt;&lt;vtx&lt;&lt;</span>
<span class="lineNum">    1907 </span>            :       &quot;\n&quot;;
<span class="lineNum">    1908 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1909 </span>            : 
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1911 </span>            :   /*
<span class="lineNum">    1912 </span>            :     tof-&gt;SetAlias(&quot;isProton&quot;,&quot;(abs(track.fTOFsignal-track.fTrackTime[4]-medianT0-torbit)&lt;(0.5*abs(track.fTOFsignal-track.fTrackTime[3]-medianT0-torbit)-rmsT0))&quot;);
<span class="lineNum">    1913 </span>            :     tof-&gt;SetAlias(&quot;isPion&quot;,&quot;(abs(track.fTOFsignal-track.fTrackTime[2]-medianT0-torbit)&lt;(0.5*abs(track.fTOFsignal-track.fTrackTime[3]-medianT0-torbit)-rmsT0))&quot;);
<span class="lineNum">    1914 </span>            :     tof-&gt;SetAlias(&quot;isKaon&quot;,&quot;(abs(track.fTOFsignal-track.fTrackTime[3]-medianT0-torbit)&lt;(0.5*abs(track.fTOFsignal-track.fTrackTime[2]-medianT0-torbit)-rmsT0))&amp;&amp;(abs(track.fTOFsignal-track.fTrackTime[3]-medianT0-torbit)&lt;(0.5*abs(track.fTOFsignal-track.fTrackTime[4]-medianT0-torbit)-rmsT0))&quot;);
<span class="lineNum">    1915 </span>            :     
<span class="lineNum">    1916 </span>            :    */
<span class="lineNum">    1917 </span>            : 
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 : }</span>
<a name="1919"><span class="lineNum">    1919 </span>            : </a>
<span class="lineNum">    1920 </span>            : 
<span class="lineNum">    1921 </span>            : TGraphErrors* AliTPCcalibGainMult::GetGainPerChamber(Int_t padRegion/*=1*/, Bool_t plotQA/*=kFALSE*/)
<span class="lineNum">    1922 </span>            : {
<span class="lineNum">    1923 </span>            :   //
<span class="lineNum">    1924 </span>            :   // Extract gain variations per chamger for 'padRegion'
<span class="lineNum">    1925 </span>            :   //
<span class="lineNum">    1926 </span>            : 
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :   if (padRegion&lt;0||padRegion&gt;2) return 0x0;</span>
<span class="lineNum">    1928 </span>            :   
<span class="lineNum">    1929 </span><span class="lineNoCov">          0 :   if (!fHistGainSector) return NULL;</span>
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :   if (!fHistGainSector-&gt;GetAxis(2)) return NULL;</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :   fHistGainSector-&gt;GetAxis(2)-&gt;SetRangeUser(padRegion,padRegion);</span>
<span class="lineNum">    1932 </span><span class="lineNoCov">          0 :   TH2D * histGainSec = fHistGainSector-&gt;Projection(0,1);</span>
<span class="lineNum">    1933 </span>            : //   TH1D* proj=fHistGainSector-&gt;Projection(0);
<span class="lineNum">    1934 </span>            : //   Double_t max=proj-&gt;GetBinCenter(proj-&gt;GetMaximumBin());
<span class="lineNum">    1935 </span>            : //   delete proj;
<span class="lineNum">    1936 </span>            :   //
<span class="lineNum">    1937 </span><span class="lineNoCov">          0 :   TObjArray arr;</span>
<span class="lineNum">    1938 </span>            : //   TF1 fg(&quot;gaus&quot;,&quot;gaus&quot;,histGainSec-&gt;GetYaxis()-&gt;GetXmin()+1,histGainSec-&gt;GetYaxis()-&gt;GetXmax()-1);
<span class="lineNum">    1939 </span>            : //   histGainSec-&gt;FitSlicesY(&amp;fg, 0, -1, 0, &quot;QNR&quot;, &amp;arr);
<span class="lineNum">    1940 </span><span class="lineNoCov">          0 :   histGainSec-&gt;FitSlicesY(0, 0, -1, 0, &quot;QNR&quot;, &amp;arr);</span>
<span class="lineNum">    1941 </span><span class="lineNoCov">          0 :   TH1D * meanGainSec = (TH1D*)arr.At(1);</span>
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :   Double_t gainsIROC[36]={0.};</span>
<span class="lineNum">    1943 </span><span class="lineNoCov">          0 :   Double_t gainsOROC[36]={0.};</span>
<span class="lineNum">    1944 </span><span class="lineNoCov">          0 :   Double_t gains[72]={0.};</span>
<span class="lineNum">    1945 </span><span class="lineNoCov">          0 :   Double_t gainsErr[72]={0.};</span>
<span class="lineNum">    1946 </span><span class="lineNoCov">          0 :   TGraphErrors *gr=new TGraphErrors(36);</span>
<span class="lineNum">    1947 </span>            :   //
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :   for(Int_t isec = 1; isec &lt; meanGainSec-&gt;GetNbinsX() + 1; isec++) {</span>
<span class="lineNum">    1949 </span><span class="lineNoCov">          0 :     TH1D *slice=histGainSec-&gt;ProjectionY(&quot;_py&quot;,isec,isec);</span>
<span class="lineNum">    1950 </span><span class="lineNoCov">          0 :     Double_t max=slice-&gt;GetBinCenter(slice-&gt;GetMaximumBin());</span>
<span class="lineNum">    1951 </span><span class="lineNoCov">          0 :     TF1 fg(&quot;gaus&quot;,&quot;gaus&quot;,max-30,max+30);</span>
<span class="lineNum">    1952 </span><span class="lineNoCov">          0 :     slice-&gt;Fit(&amp;fg,&quot;QNR&quot;);</span>
<span class="lineNum">    1953 </span><span class="lineNoCov">          0 :     meanGainSec-&gt;SetBinContent(isec,fg.GetParameter(1));</span>
<span class="lineNum">    1954 </span><span class="lineNoCov">          0 :     meanGainSec-&gt;SetBinError(isec,fg.GetParError(1));</span>
<span class="lineNum">    1955 </span>            :     
<span class="lineNum">    1956 </span>            : //     cout &lt;&lt; isec &lt;&lt; &quot; &quot; &lt;&lt; meanGainSec-&gt;GetXaxis()-&gt;GetBinCenter(isec) &lt;&lt; &quot; &quot; &lt;&lt;meanGainSec-&gt;GetBinContent(isec) &lt;&lt; endl;
<span class="lineNum">    1957 </span><span class="lineNoCov">          0 :     gains[isec-1] = meanGainSec-&gt;GetBinContent(isec);</span>
<span class="lineNum">    1958 </span><span class="lineNoCov">          0 :     if (isec &lt; 37) {</span>
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :       gainsIROC[isec-1] = meanGainSec-&gt;GetBinContent(isec);</span>
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">    1961 </span><span class="lineNoCov">          0 :       gainsOROC[isec - 36 -1] = meanGainSec-&gt;GetBinContent(isec);</span>
<span class="lineNum">    1962 </span>            :     }
<span class="lineNum">    1963 </span><span class="lineNoCov">          0 :     gainsErr[isec-1]=meanGainSec-&gt;GetBinError(isec);</span>
<span class="lineNum">    1964 </span><span class="lineNoCov">          0 :     delete slice;</span>
<span class="lineNum">    1965 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :   Double_t meanIroc = TMath::Median(36, gainsIROC);</span>
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 :   Double_t meanOroc = TMath::Median(36, gainsOROC);</span>
<span class="lineNum">    1968 </span><span class="lineNoCov">          0 :   if (TMath::Abs(meanIroc)&lt;1e-30) meanIroc=1.;</span>
<span class="lineNum">    1969 </span><span class="lineNoCov">          0 :   if (TMath::Abs(meanOroc)&lt;1e-30) meanOroc=1.;</span>
<span class="lineNum">    1970 </span><span class="lineNoCov">          0 :   for(Int_t i = 0; i &lt; 36; i++) {</span>
<span class="lineNum">    1971 </span><span class="lineNoCov">          0 :     gains[i] /= meanIroc;</span>
<span class="lineNum">    1972 </span><span class="lineNoCov">          0 :     gainsErr[i] /= meanIroc;</span>
<span class="lineNum">    1973 </span>            :   }
<span class="lineNum">    1974 </span>            :   
<span class="lineNum">    1975 </span><span class="lineNoCov">          0 :   for(Int_t i = 36; i &lt; 72; i++){</span>
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :     gains[i] /= meanOroc;</span>
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :     gainsErr[i] /= meanOroc;</span>
<span class="lineNum">    1978 </span>            :   }
<span class="lineNum">    1979 </span>            :   //
<span class="lineNum">    1980 </span>            :   Int_t ipoint=0;
<span class="lineNum">    1981 </span><span class="lineNoCov">          0 :   for(Int_t i = 0; i &lt; 72; i++) {</span>
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :     if (padRegion==0 &amp;&amp; i&gt;35) continue;</span>
<span class="lineNum">    1983 </span><span class="lineNoCov">          0 :     if ( (padRegion==1 || padRegion==2) &amp;&amp; i&lt;36) continue;</span>
<span class="lineNum">    1984 </span>            : 
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :     if (gains[i]&lt;1e-20 || gainsErr[i]/gains[i]&gt;.2){</span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot;Invalid chamber gain in ROC/region: %d / %d&quot;, i, padRegion));</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :       gains[i]=1;</span>
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :       gainsErr[i]=1;</span>
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1990 </span>            :     
<span class="lineNum">    1991 </span><span class="lineNoCov">          0 :     gr-&gt;SetPoint(ipoint,i,gains[i]);</span>
<span class="lineNum">    1992 </span><span class="lineNoCov">          0 :     gr-&gt;SetPointError(ipoint,0,gainsErr[i]);</span>
<span class="lineNum">    1993 </span><span class="lineNoCov">          0 :     ++ipoint;</span>
<span class="lineNum">    1994 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1995 </span>            : 
<span class="lineNum">    1996 </span><span class="lineNoCov">          0 :   const char* names[3]={&quot;SHORT&quot;,&quot;MEDIUM&quot;,&quot;LONG&quot;};</span>
<span class="lineNum">    1997 </span><span class="lineNoCov">          0 :   gr-&gt;SetNameTitle(Form(&quot;TGRAPHERRORS_MEAN_CHAMBERGAIN_%s_BEAM_ALL&quot;,names[padRegion]),Form(&quot;TGRAPHERRORS_MEAN_CHAMBERGAIN_%s_BEAM_ALL&quot;,names[padRegion]));</span>
<span class="lineNum">    1998 </span>            : 
<span class="lineNum">    1999 </span>            : 
<span class="lineNum">    2000 </span>            :   //=====================================
<span class="lineNum">    2001 </span>            :   // Do QA plotting if requested
<span class="lineNum">    2002 </span><span class="lineNoCov">          0 :   if (plotQA){</span>
<span class="lineNum">    2003 </span><span class="lineNoCov">          0 :     TCanvas *c=(TCanvas*)gROOT-&gt;GetListOfCanvases()-&gt;FindObject(&quot;cQA&quot;);</span>
<span class="lineNum">    2004 </span><span class="lineNoCov">          0 :     if (!c) c=new TCanvas(&quot;cQA&quot;,&quot;cQA&quot;);</span>
<span class="lineNum">    2005 </span><span class="lineNoCov">          0 :     c-&gt;Clear();</span>
<span class="lineNum">    2006 </span><span class="lineNoCov">          0 :     c-&gt;Divide(1,2);</span>
<span class="lineNum">    2007 </span><span class="lineNoCov">          0 :     c-&gt;cd(1);</span>
<span class="lineNum">    2008 </span><span class="lineNoCov">          0 :     histGainSec-&gt;DrawCopy(&quot;colz&quot;);</span>
<span class="lineNum">    2009 </span><span class="lineNoCov">          0 :     meanGainSec-&gt;DrawCopy(&quot;same&quot;);</span>
<span class="lineNum">    2010 </span><span class="lineNoCov">          0 :     gr-&gt;SetMarkerStyle(20);</span>
<span class="lineNum">    2011 </span><span class="lineNoCov">          0 :     gr-&gt;SetMarkerSize(.5);</span>
<span class="lineNum">    2012 </span><span class="lineNoCov">          0 :     c-&gt;cd(2);</span>
<span class="lineNum">    2013 </span><span class="lineNoCov">          0 :     gr-&gt;Draw(&quot;alp&quot;);</span>
<span class="lineNum">    2014 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2015 </span>            :   
<span class="lineNum">    2016 </span><span class="lineNoCov">          0 :   delete histGainSec;</span>
<a name="2017"><span class="lineNum">    2017 </span>            :   return gr;</a>
<span class="lineNum">    2018 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2019 </span>            : TGraphErrors* AliTPCcalibGainMult::GetGainPerChamberRobust(Int_t padRegion/*=1*/, Bool_t /*plotQA=kFALSE*/, TObjArray *arrQA/*=0x0*/, Bool_t normQA/*=kTRUE*/)
<span class="lineNum">    2020 </span>            : {
<span class="lineNum">    2021 </span>            :   //
<span class="lineNum">    2022 </span>            :   // Extract gain variations per chamger for 'padRegion'
<span class="lineNum">    2023 </span>            :   // Use Robust mean - LTM with 60 % 0 should be similar to the truncated mean 60 %
<span class="lineNum">    2024 </span><span class="lineNoCov">          0 :   if (padRegion&lt;0||padRegion&gt;2) return 0x0;</span>
<span class="lineNum">    2025 </span>            :   const Int_t colors[10]={1,2,4,6};
<span class="lineNum">    2026 </span>            :   const Int_t markers[10]={21,25,22,20};
<span class="lineNum">    2027 </span>            :   //
<span class="lineNum">    2028 </span><span class="lineNoCov">          0 :   if (!fHistGainSector) return NULL;</span>
<span class="lineNum">    2029 </span><span class="lineNoCov">          0 :   if (!fHistGainSector-&gt;GetAxis(2)) return NULL;</span>
<span class="lineNum">    2030 </span><span class="lineNoCov">          0 :   fHistGainSector-&gt;GetAxis(2)-&gt;SetRangeUser(padRegion,padRegion);</span>
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :   if (padRegion==0) fHistGainSector-&gt;GetAxis(1)-&gt;SetRangeUser(0.0,35.);</span>
<span class="lineNum">    2032 </span><span class="lineNoCov">          0 :   if (padRegion&gt;0) fHistGainSector-&gt;GetAxis(1)-&gt;SetRangeUser(36.,71.);</span>
<span class="lineNum">    2033 </span>            :   //
<span class="lineNum">    2034 </span><span class="lineNoCov">          0 :   TH2D * histGainSec = fHistGainSector-&gt;Projection(0,1);</span>
<span class="lineNum">    2035 </span>            : //   TGraphErrors * gr = TStatToolkit::MakeStat1D(histGainSec, 0, 0.6,4,markers[padRegion],colors[padRegion]);
<span class="lineNum">    2036 </span><span class="lineNoCov">          0 :   TGraphErrors * gr = TStatToolkit::MakeStat1D(histGainSec, 0, 0.9,6,markers[padRegion],colors[padRegion]);</span>
<span class="lineNum">    2037 </span><span class="lineNoCov">          0 :   const char* names[3]={&quot;SHORT&quot;,&quot;MEDIUM&quot;,&quot;LONG&quot;};</span>
<span class="lineNum">    2038 </span><span class="lineNoCov">          0 :   const Double_t median = TMath::Median(gr-&gt;GetN(),gr-&gt;GetY());</span>
<span class="lineNum">    2039 </span>            : 
<span class="lineNum">    2040 </span>            :   // ---| QA histograms |---
<span class="lineNum">    2041 </span><span class="lineNoCov">          0 :   if (arrQA) {</span>
<span class="lineNum">    2042 </span>            :     // --- Qmax ---
<span class="lineNum">    2043 </span><span class="lineNoCov">          0 :     histGainSec-&gt;SetName(Form(&quot;TGRAPHERRORS_MEAN_CHAMBERGAIN_%s_BEAM_ALL_QA&quot;,names[padRegion]));</span>
<span class="lineNum">    2044 </span><span class="lineNoCov">          0 :     histGainSec-&gt;SetTitle(Form(&quot;Per chamber calibration %s;chamber;d#it{E}/d#it{x} (arb. unit)&quot;,names[padRegion]));</span>
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :     arrQA-&gt;Add(histGainSec);</span>
<span class="lineNum">    2046 </span>            : 
<span class="lineNum">    2047 </span>            :     // --- scale axis ---
<span class="lineNum">    2048 </span><span class="lineNoCov">          0 :     if (normQA &amp;&amp; median&gt;0) {</span>
<span class="lineNum">    2049 </span><span class="lineNoCov">          0 :       TAxis *a=histGainSec-&gt;GetYaxis();</span>
<span class="lineNum">    2050 </span><span class="lineNoCov">          0 :       a-&gt;SetLimits(a-&gt;GetXmin()/median, a-&gt;GetXmax()/median);</span>
<span class="lineNum">    2051 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2052 </span>            : 
<span class="lineNum">    2053 </span>            :   } else {
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :     delete histGainSec;</span>
<span class="lineNum">    2055 </span>            :   }
<span class="lineNum">    2056 </span>            : 
<span class="lineNum">    2057 </span><span class="lineNoCov">          0 :   if (median&gt;0){</span>
<span class="lineNum">    2058 </span><span class="lineNoCov">          0 :     for (Int_t i=0; i&lt;gr-&gt;GetN();i++) {</span>
<span class="lineNum">    2059 </span><span class="lineNoCov">          0 :       gr-&gt;GetY()[i]/=median;</span>
<span class="lineNum">    2060 </span><span class="lineNoCov">          0 :       gr-&gt;SetPointError(i,gr-&gt;GetErrorX(i),gr-&gt;GetErrorY(i)/median);</span>
<span class="lineNum">    2061 </span>            :     }
<span class="lineNum">    2062 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2063 </span><span class="lineNoCov">          0 :   gr-&gt;SetNameTitle(Form(&quot;TGRAPHERRORS_MEAN_CHAMBERGAIN_%s_BEAM_ALL&quot;,names[padRegion]),Form(&quot;TGRAPHERRORS_MEAN_CHAMBERGAIN_%s_BEAM_ALL&quot;,names[padRegion]));</span>
<span class="lineNum">    2064 </span>            :   return gr;
<span class="lineNum">    2065 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2066 </span>            : 
<span class="lineNum">    2067 </span>            : // void AliTPCcalibGainMult::Terminate(){
<span class="lineNum">    2068 </span>            : //   //
<span class="lineNum">    2069 </span>            : //   // Terminate function
<span class="lineNum">    2070 </span>            : //   // call base terminate + Eval of fitters
<span class="lineNum">    2071 </span>            : //   //
<span class="lineNum">    2072 </span>            : //    Info(&quot;AliTPCcalibGainMult&quot;,&quot;Terminate&quot;);
<span class="lineNum">    2073 </span>            : //    TTreeSRedirector *pcstream = GetDebugStreamer();
<span class="lineNum">    2074 </span>            : //    if (pcstream){
<span class="lineNum">    2075 </span>            : //      TTreeStream &amp;stream = (*pcstream)&lt;&lt;&quot;dump&quot;;
<span class="lineNum">    2076 </span>            : //      TTree* tree = stream.GetTree();
<span class="lineNum">    2077 </span>            : //      if (tree) if ( tree-&gt;GetEntries()&gt;0){
<span class="lineNum">    2078 </span>            : //        TObjArray *array =  tree-&gt;GetListOfBranches(); 
<span class="lineNum">    2079 </span>            : //        for (Int_t i=0; i&lt;array-&gt;GetEntries(); i++) {TBranch * br = (TBranch *)array-&gt;At(i); br-&gt;SetAddress(0);}      
<span class="lineNum">    2080 </span>            : //        gDirectory=gROOT;
<span class="lineNum">    2081 </span>            : //        fdEdxTree=tree-&gt;CloneTree(10000);
<span class="lineNum">    2082 </span>            : //      }
<span class="lineNum">    2083 </span>            : //    }
<span class="lineNum">    2084 </span>            : //    AliTPCcalibBase::Terminate();
<span class="lineNum">    2085 </span>            : // }
<span class="lineNum">    2086 </span>            : 
<a name="2087"><span class="lineNum">    2087 </span>            : </a>
<span class="lineNum">    2088 </span>            : 
<span class="lineNum">    2089 </span>            : Double_t AliTPCcalibGainMult::GetTruncatedMeanPosition(Double_t q0, Double_t q1, Double_t q2, Int_t ntracks, Int_t tuneIndex, TTreeSRedirector *pcstream){
<span class="lineNum">    2090 </span>            :   //
<span class="lineNum">    2091 </span>            :   // Simulation of truncated mean position for reweighed IROC(w0),OROCmedium(w1) and OROClong(w2)
<span class="lineNum">    2092 </span>            :   // Options:
<span class="lineNum">    2093 </span>            :   //   a.) assume that all pad-rows are used in the dEdx calcualtion
<span class="lineNum">    2094 </span>            :   //   b.) calculate effective lenght in differnt regions taking into account dead zones
<span class="lineNum">    2095 </span>            :   //       for some reason fraction is roghly the same therefore we keep scaling win n padrows 
<span class="lineNum">    2096 </span>            :   //         
<span class="lineNum">    2097 </span>            :   const Int_t row1=63;
<span class="lineNum">    2098 </span>            :   const Int_t row2=64+63;
<span class="lineNum">    2099 </span>            :   const Int_t nRows=kMaxRow;
<span class="lineNum">    2100 </span><span class="lineNoCov">          0 :   Double_t qmean=(q0+q1+q2)/3.;</span>
<span class="lineNum">    2101 </span><span class="lineNoCov">          0 :   Double_t wmean=(q0*row1+q1*(row2-row1)+q2*(nRows-row2))/nRows;</span>
<span class="lineNum">    2102 </span><span class="lineNoCov">          0 :   TVectorD vecdEdxEqualW(ntracks);</span>
<span class="lineNum">    2103 </span><span class="lineNoCov">          0 :   TVectorD vecQEqualW(nRows);</span>
<span class="lineNum">    2104 </span><span class="lineNoCov">          0 :   TVectorD vecQEqualWSorted(nRows);</span>
<span class="lineNum">    2105 </span>            :   //
<span class="lineNum">    2106 </span><span class="lineNoCov">          0 :   TVectorD vecdEdx(ntracks);</span>
<span class="lineNum">    2107 </span><span class="lineNoCov">          0 :   TVectorD vecQ(nRows);</span>
<span class="lineNum">    2108 </span><span class="lineNoCov">          0 :   TVectorD vecQSorted(nRows);</span>
<span class="lineNum">    2109 </span><span class="lineNoCov">          0 :   Int_t indexArray[nRows];</span>
<span class="lineNum">    2110 </span>            : 
<span class="lineNum">    2111 </span><span class="lineNoCov">          0 :   for (Int_t itrack=0; itrack&lt;ntracks; itrack++){</span>
<span class="lineNum">    2112 </span><span class="lineNoCov">          0 :     for (Int_t irow=0; irow&lt;nRows; irow++){</span>
<span class="lineNum">    2113 </span><span class="lineNoCov">          0 :       Double_t q=gRandom-&gt;Landau(1,0.2);</span>
<span class="lineNum">    2114 </span><span class="lineNoCov">          0 :       Double_t qnorm=q1;</span>
<span class="lineNum">    2115 </span><span class="lineNoCov">          0 :       if (irow&lt;row1) qnorm=q0;</span>
<span class="lineNum">    2116 </span><span class="lineNoCov">          0 :       if (irow&gt;row2) qnorm=q2;</span>
<span class="lineNum">    2117 </span><span class="lineNoCov">          0 :       vecQEqualW[irow]=q*wmean;</span>
<span class="lineNum">    2118 </span><span class="lineNoCov">          0 :       vecQ[irow]=q*qnorm;</span>
<span class="lineNum">    2119 </span>            :     }
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :     TMath::Sort(nRows, vecQEqualW.GetMatrixArray(), indexArray,kFALSE);</span>
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :     for (Int_t irow=0; irow&lt;nRows; irow++)      vecQEqualWSorted[irow]=vecQEqualW[indexArray[irow]];</span>
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :     TMath::Sort(nRows, vecQ.GetMatrixArray(), indexArray,kFALSE);</span>
<span class="lineNum">    2123 </span><span class="lineNoCov">          0 :     for (Int_t irow=0; irow&lt;nRows; irow++)      vecQSorted[irow]=vecQ[indexArray[irow]];</span>
<span class="lineNum">    2124 </span>            :     
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :     Double_t truncMeanEqualW=TMath::Mean(nRows*0.6,vecQEqualWSorted.GetMatrixArray());</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :     Double_t truncMean=TMath::Mean(nRows*0.6,vecQSorted.GetMatrixArray());</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :     vecdEdxEqualW[itrack]=truncMeanEqualW;</span>
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :     vecdEdx[itrack]=truncMean;</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :     if (pcstream &amp;&amp; itrack&gt;1){</span>
<span class="lineNum">    2130 </span><span class="lineNoCov">          0 :       Double_t currentMeanEqualW=TMath::Mean(itrack+1,vecdEdxEqualW.GetMatrixArray());</span>
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 :       Double_t currentMean=TMath::Mean(itrack+1,vecdEdx.GetMatrixArray());</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :       (*pcstream)&lt;&lt;&quot;dEdxTrunc&quot;&lt;&lt;</span>
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :         &quot;itrack=&quot;&lt;&lt;itrack&lt;&lt;</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :         &quot;q0=&quot;&lt;&lt;q0&lt;&lt;</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :         &quot;q1=&quot;&lt;&lt;q1&lt;&lt;</span>
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :         &quot;q2=&quot;&lt;&lt;q2&lt;&lt;</span>
<span class="lineNum">    2137 </span><span class="lineNoCov">          0 :         &quot;qmean=&quot;&lt;&lt;qmean&lt;&lt;</span>
<span class="lineNum">    2138 </span><span class="lineNoCov">          0 :         &quot;wmean=&quot;&lt;&lt;wmean&lt;&lt;</span>
<span class="lineNum">    2139 </span><span class="lineNoCov">          0 :         &quot;truncMean=&quot;&lt;&lt;truncMean&lt;&lt;</span>
<span class="lineNum">    2140 </span><span class="lineNoCov">          0 :         &quot;truncMeanEqualW=&quot;&lt;&lt;truncMeanEqualW&lt;&lt;</span>
<span class="lineNum">    2141 </span><span class="lineNoCov">          0 :         &quot;currentMean=&quot;&lt;&lt;currentMean&lt;&lt;</span>
<span class="lineNum">    2142 </span><span class="lineNoCov">          0 :         &quot;currentMeanEqualW=&quot;&lt;&lt;currentMeanEqualW&lt;&lt;</span>
<span class="lineNum">    2143 </span><span class="lineNoCov">          0 :         &quot;tuneIndex=&quot;&lt;&lt;tuneIndex&lt;&lt;</span>
<span class="lineNum">    2144 </span>            :         &quot;\n&quot;;
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 :   }  </span>
<span class="lineNum">    2147 </span><span class="lineNoCov">          0 :   Double_t fullTruncMean=TMath::Mean(ntracks,vecdEdx.GetMatrixArray());</span>
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :   if (wmean&gt;0) return fullTruncMean/wmean;</span>
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">    2150 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2151 </span>            : 
<span class="lineNum">    2152 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
