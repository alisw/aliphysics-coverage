<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - TPC/TPCbase/AliTPCCalibPedestal.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">TPC/TPCbase</a> - AliTPCCalibPedestal.cxx<span style="font-size: 80%;"> (source / <a href="AliTPCCalibPedestal.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">203</td>
            <td class="headerCovTableEntryLo">0.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">25</td>
            <td class="headerCovTableEntryLo">4.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : /// \class AliTPCCalibPedestal
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : // Root includes
<span class="lineNum">      19 </span>            : #include &lt;TH1F.h&gt;
<span class="lineNum">      20 </span>            : #include &lt;TH2F.h&gt;
<span class="lineNum">      21 </span>            : #include &lt;TString.h&gt;
<span class="lineNum">      22 </span>            : #include &lt;TMath.h&gt;
<span class="lineNum">      23 </span>            : #include &lt;TF1.h&gt;
<span class="lineNum">      24 </span>            : #include &lt;TRandom.h&gt;
<span class="lineNum">      25 </span>            : #include &lt;TDirectory.h&gt;
<span class="lineNum">      26 </span>            : #include &lt;TFile.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;TMap.h&gt;
<span class="lineNum">      28 </span>            : //AliRoot includes
<span class="lineNum">      29 </span>            : #include &quot;AliRawReader.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;AliRawReaderRoot.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;AliRawReaderDate.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;AliTPCCalROC.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;AliTPCROC.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;AliMathBase.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;TTreeStream.h&quot;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : //date
<span class="lineNum">      38 </span>            : #include &quot;event.h&quot;
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : //header file
<span class="lineNum">      41 </span>            : #include &quot;AliTPCCalibPedestal.h&quot;
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : ///////////////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      45 </span>            : //          Implementation of the TPC pedestal and noise calibration
<span class="lineNum">      46 </span>            : //
<span class="lineNum">      47 </span>            : //   Origin: Jens Wiechula, Marian Ivanov   J.Wiechula@gsi.de, Marian.Ivanov@cern.ch
<span class="lineNum">      48 </span>            : // 
<span class="lineNum">      49 </span>            : // 
<span class="lineNum">      50 </span>            : // *************************************************************************************
<span class="lineNum">      51 </span>            : // *                                Class Description                                  *
<span class="lineNum">      52 </span>            : // *************************************************************************************
<span class="lineNum">      53 </span>            : //
<span class="lineNum">      54 </span>            : // Working principle:
<span class="lineNum">      55 </span>            : // ------------------
<span class="lineNum">      56 </span>            : // Raw pedestal data is processed by calling one of the ProcessEvent(...) functions
<span class="lineNum">      57 </span>            : // (see below). These in the end call the Update(...) function, where the data is filled
<span class="lineNum">      58 </span>            : // into histograms.
<span class="lineNum">      59 </span>            : //
<span class="lineNum">      60 </span>            : // For each ROC one TH2F histo (ROC channel vs. ADC channel) is created when
<span class="lineNum">      61 </span>            : // it is filled for the first time (GetHistoPedestal(ROC,kTRUE)). All histos are stored in the
<span class="lineNum">      62 </span>            : // TObjArray fHistoPedestalArray.
<span class="lineNum">      63 </span>            : //
<span class="lineNum">      64 </span>            : // For a fast filling of the histogram the corresponding bin number of the channel and ADC channel
<span class="lineNum">      65 </span>            : // is computed by hand and the histogram array is accessed directly via its pointer.
<span class="lineNum">      66 </span>            : // ATTENTION: Doing so the the entry counter of the histogram is not increased
<span class="lineNum">      67 </span>            : //            this means that e.g. the colz draw option gives an empty plot unless
<span class="lineNum">      68 </span>            : //          calling 'histo-&gt;SetEntries(1)' before drawing.
<span class="lineNum">      69 </span>            : //
<span class="lineNum">      70 </span>            : // After accumulating the desired statistics the Analyse() function has to be called.
<span class="lineNum">      71 </span>            : // Whithin this function the pedestal and noise values are calculated for each pad, using
<span class="lineNum">      72 </span>            : // the fast gaus fit function  AliMathBase::FitGaus(...), and the calibration
<span class="lineNum">      73 </span>            : // storage classes (AliTPCCalROC) are filled for each ROC.
<span class="lineNum">      74 </span>            : // The calibration information is stored in the TObjArrays fCalRocArrayPedestal and fCalRocArrayRMS;
<span class="lineNum">      75 </span>            : //
<span class="lineNum">      76 </span>            : //
<span class="lineNum">      77 </span>            : //
<span class="lineNum">      78 </span>            : // User interface for filling data:
<span class="lineNum">      79 </span>            : // --------------------------------
<span class="lineNum">      80 </span>            : //
<span class="lineNum">      81 </span>            : // To Fill information one of the following functions can be used:
<span class="lineNum">      82 </span>            : //
<span class="lineNum">      83 </span>            : // Bool_t ProcessEvent(eventHeaderStruct *event);
<span class="lineNum">      84 </span>            : //   - process Date event
<span class="lineNum">      85 </span>            : //   - use AliTPCRawReaderDate and call ProcessEvent(AliRawReader *rawReader)
<span class="lineNum">      86 </span>            : //
<span class="lineNum">      87 </span>            : // Bool_t ProcessEvent(AliRawReader *rawReader);
<span class="lineNum">      88 </span>            : //  - process AliRawReader event
<span class="lineNum">      89 </span>            : //   - use AliTPCRawStreamV3 to loop over data and call ProcessEvent(AliTPCRawStreamV3 *rawStream)
<span class="lineNum">      90 </span>            : //
<span class="lineNum">      91 </span>            : // Bool_t ProcessEvent(AliTPCRawStreamV3 *rawStream);
<span class="lineNum">      92 </span>            : //   - process event from AliTPCRawStreamV3
<span class="lineNum">      93 </span>            : //   - call Update function for signal filling
<span class="lineNum">      94 </span>            : //
<span class="lineNum">      95 </span>            : // Int_t Update(const Int_t isector, const Int_t iRow, const Int_t
<span class="lineNum">      96 </span>            : //              iPad,  const Int_t iTimeBin, const Float_t signal);
<span class="lineNum">      97 </span>            : //   - directly  fill signal information (sector, row, pad, time bin, pad)
<span class="lineNum">      98 </span>            : //     to the reference histograms
<span class="lineNum">      99 </span>            : //
<span class="lineNum">     100 </span>            : // It is also possible to merge two independently taken calibrations using the function
<span class="lineNum">     101 </span>            : //
<span class="lineNum">     102 </span>            : // void Merge(AliTPCCalibPedestal *ped)
<span class="lineNum">     103 </span>            : //   - copy histograms in 'ped' if the do not exist in this instance
<span class="lineNum">     104 </span>            : //   - Add histograms in 'ped' to the histograms in this instance if the allready exist
<span class="lineNum">     105 </span>            : //   - After merging call Analyse again!
<span class="lineNum">     106 </span>            : //
<span class="lineNum">     107 </span>            : //
<span class="lineNum">     108 </span>            : //
<span class="lineNum">     109 </span>            : // -- example: filling data using root raw data:
<span class="lineNum">     110 </span>            : // void fillPedestal(Char_t *filename)
<span class="lineNum">     111 </span>            : // {
<span class="lineNum">     112 </span>            : //    rawReader = new AliRawReaderRoot(fileName);
<span class="lineNum">     113 </span>            : //    if ( !rawReader ) return;
<span class="lineNum">     114 </span>            : //    AliTPCCalibPedestal *calib = new AliTPCCalibPedestal;
<span class="lineNum">     115 </span>            : //    while (rawReader-&gt;NextEvent()){
<span class="lineNum">     116 </span>            : //      calib-&gt;ProcessEvent(rawReader);
<span class="lineNum">     117 </span>            : //    }
<span class="lineNum">     118 </span>            : //    calib-&gt;Analyse();
<span class="lineNum">     119 </span>            : //    calib-&gt;DumpToFile(&quot;PedestalData.root&quot;);
<span class="lineNum">     120 </span>            : //    delete rawReader;
<span class="lineNum">     121 </span>            : //    delete calib;
<span class="lineNum">     122 </span>            : // }
<span class="lineNum">     123 </span>            : //
<span class="lineNum">     124 </span>            : //
<span class="lineNum">     125 </span>            : // What kind of information is stored and how to retrieve them:
<span class="lineNum">     126 </span>            : // ------------------------------------------------------------
<span class="lineNum">     127 </span>            : //
<span class="lineNum">     128 </span>            : // - Accessing the 'Reference Histograms' (pedestal distribution histograms):
<span class="lineNum">     129 </span>            : //
<span class="lineNum">     130 </span>            : // TH2F *GetHistoPedestal(Int_t sector);
<span class="lineNum">     131 </span>            : //
<span class="lineNum">     132 </span>            : // - Accessing the calibration storage objects:
<span class="lineNum">     133 </span>            : //
<span class="lineNum">     134 </span>            : // AliTPCCalROC *GetCalRocPedestal(Int_t sector);  - for the pedestal values, mean from gaus fit
<span class="lineNum">     135 </span>            : // AliTPCCalROC *GetCalRocSigma(Int_t sector);     - for the Noise values, sigma from guas fit
<span class="lineNum">     136 </span>            : // AliTPCCalROC *GetCalRocMean(Int_t sector);  - for the pedestal values, truncated mean
<span class="lineNum">     137 </span>            : // AliTPCCalROC *GetCalRocRMS(Int_t sector);     - for the Noise values, rms from truncated mean
<span class="lineNum">     138 </span>            : //
<span class="lineNum">     139 </span>            : // example for visualisation:
<span class="lineNum">     140 </span>            : // if the file &quot;PedestalData.root&quot; was created using the above example one could do the following:
<span class="lineNum">     141 </span>            : //
<span class="lineNum">     142 </span>            : // TFile filePedestal(&quot;PedestalData.root&quot;)
<span class="lineNum">     143 </span>            : // AliTPCCalibPedestal *ped = (AliTPCCalibPedestal*)filePedestal-&gt;Get(&quot;AliTPCCalibPedestal&quot;);
<span class="lineNum">     144 </span>            : // ped-&gt;GetCalRocPedestal(0)-&gt;Draw(&quot;colz&quot;);
<span class="lineNum">     145 </span>            : // ped-&gt;GetCalRocRMS(0)-&gt;Draw(&quot;colz&quot;);
<span class="lineNum">     146 </span>            : //
<span class="lineNum">     147 </span>            : // or use the AliTPCCalPad functionality:
<span class="lineNum">     148 </span>            : // AliTPCCalPad padPedestal(ped-&gt;GetCalPadPedestal());
<span class="lineNum">     149 </span>            : // AliTPCCalPad padNoise(ped-&gt;GetCalPadRMS());
<span class="lineNum">     150 </span>            : // padPedestal-&gt;MakeHisto2D()-&gt;Draw(&quot;colz&quot;);  //Draw A-Side Pedestal Information
<span class="lineNum">     151 </span>            : // padNoise-&gt;MakeHisto2D()-&gt;Draw(&quot;colz&quot;);  //Draw A-Side Noise Information
<span class="lineNum">     152 </span>            : //
<span class="lineNum">     153 </span>            : /*
<span class="lineNum">     154 </span>            :  example: fill pedestal with gausschen noise
<span class="lineNum">     155 </span>            :  AliTPCCalibPedestal ped;
<span class="lineNum">     156 </span>            :  ped.TestEvent();
<span class="lineNum">     157 </span>            :  ped.Analyse();
<span class="lineNum">     158 </span>            :  //Draw output;
<span class="lineNum">     159 </span>            :  TCanvas* c1 = new TCanvas;
<span class="lineNum">     160 </span>            :  c1-&gt;Divide(1,2);
<span class="lineNum">     161 </span>            :  c1-&gt;cd(1);
<span class="lineNum">     162 </span>            :  ped.GetHistoPedestal(0)-&gt;SetEntries(1); //needed in order for colz to work, reason: fast filling does not increase the entries counter
<span class="lineNum">     163 </span>            :  ped.GetHistoPedestal(0)-&gt;Draw(&quot;colz&quot;);
<span class="lineNum">     164 </span>            :  c1-&gt;cd(2);
<span class="lineNum">     165 </span>            :  ped.GetHistoPedestal(36)-&gt;SetEntries(1); //needed in order for colz to work, reason: fast filling does not increase the entries counter
<span class="lineNum">     166 </span>            :  ped.GetHistoPedestal(36)-&gt;Draw(&quot;colz&quot;);
<span class="lineNum">     167 </span>            :  TCanvas* c2 = new TCanvas;
<span class="lineNum">     168 </span>            :  c2-&gt;Divide(2,2);
<span class="lineNum">     169 </span>            :  c2-&gt;cd(1);
<span class="lineNum">     170 </span>            :  ped.GetCalRocPedestal(0)-&gt;Draw(&quot;colz&quot;);
<span class="lineNum">     171 </span>            :  c2-&gt;cd(2);
<span class="lineNum">     172 </span>            :  ped.GetCalRocRMS(0)-&gt;Draw(&quot;colz&quot;);
<span class="lineNum">     173 </span>            :  c2-&gt;cd(3);
<span class="lineNum">     174 </span>            :  ped.GetCalRocPedestal(36)-&gt;Draw(&quot;colz&quot;);
<span class="lineNum">     175 </span>            :  c2-&gt;cd(4);
<span class="lineNum">     176 </span>            :  ped.GetCalRocRMS(36)-&gt;Draw(&quot;colz&quot;);
<span class="lineNum">     177 </span>            : */
<span class="lineNum">     178 </span>            : //
<span class="lineNum">     179 </span>            : // Time dependent pedestals:
<span class="lineNum">     180 </span>            : //
<span class="lineNum">     181 </span>            : // If wished there is the possibility to calculate for each channel and time bin
<span class="lineNum">     182 </span>            : // the mean pedestal [pedestals(t)]. This is done by
<span class="lineNum">     183 </span>            : //
<span class="lineNum">     184 </span>            : // 1) setting SetTimeAnalysis(kTRUE),
<span class="lineNum">     185 </span>            : // 2) processing the data by looping over the events using ProcessEvent(..)
<span class="lineNum">     186 </span>            : // 3) calling the Analyse() and AnalyseTime(nevents) functions (providing nevents)
<span class="lineNum">     187 </span>            : // 4) getting the pedestals(t) using   TArrayF **timePed = calibPedestal.GetTimePedestals();
<span class="lineNum">     188 </span>            : // 5) looking at values using   timePed[row][pad].At(timebin)
<span class="lineNum">     189 </span>            : //
<span class="lineNum">     190 </span>            : // This functionality is intended to be used on an LDC bu the detector algorithm
<span class="lineNum">     191 </span>            : // (TPCPEDESTALda) to generate a data set used for configuration of the pattern
<span class="lineNum">     192 </span>            : // memory for baseline subtraction in the ALTROs. Later the information should also
<span class="lineNum">     193 </span>            : // be stored as reference data.
<span class="lineNum">     194 </span>            : //
<span class="lineNum">     195 </span>            : 
<a name="196"><span class="lineNum">     196 </span>            : </a>
<span class="lineNum">     197 </span>            : /// \cond CLASSIMP
<span class="lineNum">     198 </span><span class="lineCov">         24 : ClassImp(AliTPCCalibPedestal)</span>
<a name="199"><span class="lineNum">     199 </span>            : /// \endcond</a>
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span>            : AliTPCCalibPedestal::AliTPCCalibPedestal() : 
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :   AliTPCCalibRawBase(),</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :   fAdcMin(1),</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :   fAdcMax(100),</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :   fAnaMeanDown(0.),</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :   fAnaMeanUp(1.),</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :   fTimeAnalysis(kFALSE),</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :   fCalRocArrayPedestal(72),</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :   fCalRocArraySigma(72),</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :   fHistoPedestalArray(72),</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :   fTimeSignal(NULL),</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :   fCalRocArrayMean(72),</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :   fCalRocArrayRMS(72)</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     215 </span>            :   //
<span class="lineNum">     216 </span>            :   // default constructor
<span class="lineNum">     217 </span>            :   //
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :   SetNameTitle(&quot;AliTPCCalibPedestal&quot;,&quot;AliTPCCalibPedestal&quot;);</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   fFirstTimeBin=60;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   fLastTimeBin=1000;</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     222 </span>            : 
<a name="223"><span class="lineNum">     223 </span>            : </a>
<span class="lineNum">     224 </span>            : //_____________________________________________________________________
<span class="lineNum">     225 </span>            : AliTPCCalibPedestal::AliTPCCalibPedestal(const AliTPCCalibPedestal &amp;ped) : 
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   AliTPCCalibRawBase(ped),</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :   fAdcMin(ped.GetAdcMin()),</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   fAdcMax(ped.GetAdcMax()),</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :   fAnaMeanDown(ped.fAnaMeanDown),</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :   fAnaMeanUp(ped.fAnaMeanUp),</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :   fTimeAnalysis(ped.fTimeAnalysis),</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :   fCalRocArrayPedestal(72),</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :   fCalRocArraySigma(72),</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :   fHistoPedestalArray(72),</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :   fTimeSignal(ped.fTimeSignal),</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :   fCalRocArrayMean(72),</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :   fCalRocArrayRMS(72)</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     239 </span>            :   /// copy constructor
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :   for (Int_t iSec = 0; iSec &lt; 72; ++iSec){</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     const AliTPCCalROC *calPed = (AliTPCCalROC*)ped.fCalRocArrayPedestal.UncheckedAt(iSec);</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :     const AliTPCCalROC *calRMS = (AliTPCCalROC*)ped.fCalRocArrayRMS.UncheckedAt(iSec);</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :     const TH2F         *hPed   = (TH2F*)ped.fHistoPedestalArray.UncheckedAt(iSec);</span>
<span class="lineNum">     245 </span>            :     
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :     if ( calPed != 0x0 ) fCalRocArrayPedestal.AddAt(new AliTPCCalROC(*calPed), iSec);</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     if ( calRMS != 0x0 ) fCalRocArrayRMS.AddAt(new AliTPCCalROC(*calRMS), iSec);</span>
<span class="lineNum">     248 </span>            :     
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :     if ( hPed != 0x0 ){</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :       TH2F *hNew = new TH2F(*hPed);</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :       hNew-&gt;SetDirectory(0);</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :       fHistoPedestalArray.AddAt(hNew,iSec);</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :     }</span>
<a name="254"><span class="lineNum">     254 </span>            :   }</a>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     256 </span>            : AliTPCCalibPedestal::AliTPCCalibPedestal(const TMap *config): 
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :   AliTPCCalibRawBase(),</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :   fAdcMin(1),</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :   fAdcMax(100),</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :   fAnaMeanDown(0.),</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :   fAnaMeanUp(1.),</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :   fTimeAnalysis(kFALSE),</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :   fCalRocArrayPedestal(72),</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :   fCalRocArraySigma(72),</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :   fHistoPedestalArray(72),</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :   fTimeSignal(NULL),</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :   fCalRocArrayMean(72),</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :   fCalRocArrayRMS(72)  </span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     270 </span>            :  /// This constructor uses a TMap for setting some parametes
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :   SetNameTitle(&quot;AliTPCCalibPedestal&quot;,&quot;AliTPCCalibPedestal&quot;);</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :   fFirstTimeBin=60;</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :   fLastTimeBin=1000;</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   if (config-&gt;GetValue(&quot;FirstTimeBin&quot;)) fFirstTimeBin = ((TObjString*)config-&gt;GetValue(&quot;FirstTimeBin&quot;))-&gt;GetString().Atoi();</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   if (config-&gt;GetValue(&quot;LastTimeBin&quot;))  fLastTimeBin = ((TObjString*)config-&gt;GetValue(&quot;LastTimeBin&quot;))-&gt;GetString().Atoi();</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   if (config-&gt;GetValue(&quot;AdcMin&quot;))       fAdcMin = ((TObjString*)config-&gt;GetValue(&quot;AdcMin&quot;))-&gt;GetString().Atoi();</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   if (config-&gt;GetValue(&quot;AdcMax&quot;))       fAdcMax = ((TObjString*)config-&gt;GetValue(&quot;AdcMax&quot;))-&gt;GetString().Atoi();</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   if (config-&gt;GetValue(&quot;TimeAnalysis&quot;)) SetTimeAnalysis(((TObjString*)config-&gt;GetValue(&quot;TimeAnalysis&quot;))-&gt;GetString().Atoi());</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 : } </span>
<span class="lineNum">     281 </span>            : 
<a name="282"><span class="lineNum">     282 </span>            : </a>
<span class="lineNum">     283 </span>            : //_____________________________________________________________________
<span class="lineNum">     284 </span>            : AliTPCCalibPedestal&amp; AliTPCCalibPedestal::operator = (const  AliTPCCalibPedestal &amp;source)
<span class="lineNum">     285 </span>            : {
<span class="lineNum">     286 </span>            :   /// assignment operator
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   if (&amp;source == this) return *this;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   new (this) AliTPCCalibPedestal(source);</span>
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :   return *this;</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     293 </span>            : 
<a name="294"><span class="lineNum">     294 </span>            : </a>
<span class="lineNum">     295 </span>            : //_____________________________________________________________________
<span class="lineNum">     296 </span>            : AliTPCCalibPedestal::~AliTPCCalibPedestal() 
<span class="lineNum">     297 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     298 </span>            :   /// destructor
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :   fCalRocArrayPedestal.Delete();</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :   fCalRocArrayRMS.Delete();</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :   fCalRocArraySigma.Delete();</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :   fHistoPedestalArray.Delete();</span>
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :   if ( fTimeSignal ) {</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     for (Int_t i = 0; i &lt; 159; i++) {</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :       delete [] fTimeSignal[i];</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :       fTimeSignal[i] = 0;</span>
<span class="lineNum">     309 </span>            :     }
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :     delete [] fTimeSignal;</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :     fTimeSignal = 0;</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span>            :   // do not delete fMapping, because we do not own it.
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     317 </span>            : 
<a name="318"><span class="lineNum">     318 </span>            : </a>
<span class="lineNum">     319 </span>            : //_____________________________________________________________________
<span class="lineNum">     320 </span>            : void AliTPCCalibPedestal::SetTimeAnalysis(Bool_t time)
<span class="lineNum">     321 </span>            : {
<span class="lineNum">     322 </span>            :   /// Use time dependent analysis: Pedestals are analysed as a function
<span class="lineNum">     323 </span>            :   /// of the drift time. There is one mean value generated for each time
<span class="lineNum">     324 </span>            :   /// bin and each channel. It can be used as reference data and for
<span class="lineNum">     325 </span>            :   /// configuration of the ALTRO pattern memory for baseline subtraction.
<span class="lineNum">     326 </span>            :   ///
<span class="lineNum">     327 </span>            :   /// ATTENTION: Use only on LDC in TPCPEDESTALda! On a LDC we get data
<span class="lineNum">     328 </span>            :   /// only from one sector. For the full TPC we would need a lot of
<span class="lineNum">     329 </span>            :   /// memory (36*159*140*1024*4bytes = 3.3GB)!
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :   fTimeAnalysis = time;</span>
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   if ( !fTimeAnalysis ) return;</span>
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span>            :   // prepare array for one sector (159*140*1024*4bytes = 92MB):
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :   fTimeSignal = new TArrayF*[159];</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :   for (Int_t i = 0; i &lt; 159; i++) {  // padrows</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :     fTimeSignal[i] = new TArrayF[140];</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     for (Int_t j = 0; j &lt; 140; j++) {  // pads per row</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :       fTimeSignal[i][j].Set(1024);</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       for (Int_t k = 0; k &lt; 1024; k++) {  // time bins per pad</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :         fTimeSignal[i][j].AddAt(0., k);</span>
<span class="lineNum">     343 </span>            :       }
<span class="lineNum">     344 </span>            :     }      
<span class="lineNum">     345 </span>            :   }
<span class="lineNum">     346 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     347 </span>            : 
<a name="348"><span class="lineNum">     348 </span>            : </a>
<span class="lineNum">     349 </span>            : //_____________________________________________________________________
<span class="lineNum">     350 </span>            : Int_t AliTPCCalibPedestal::Update(const Int_t icsector, 
<span class="lineNum">     351 </span>            :                                   const Int_t icRow,
<span class="lineNum">     352 </span>            :                                   const Int_t icPad,
<span class="lineNum">     353 </span>            :                                   const Int_t icTimeBin,
<span class="lineNum">     354 </span>            :                                   const Float_t csignal)
<span class="lineNum">     355 </span>            : {
<span class="lineNum">     356 </span>            :   /// Signal filling method
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   if (icRow&lt;0) return 0;</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :   if (icPad&lt;0) return 0;</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   if (icTimeBin&lt;0) return 0;</span>
<span class="lineNum">     361 </span>            :  
<span class="lineNum">     362 </span>            :   // Time dependent pedestals
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :   if ( fTimeAnalysis ) {</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :     if ( icsector &lt; 36 ) // IROC</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :       fTimeSignal[icRow][icPad].AddAt(fTimeSignal[icRow][icPad].At(icTimeBin)+csignal, icTimeBin);</span>
<span class="lineNum">     366 </span>            :     else 
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :       fTimeSignal[icRow+63][icPad].AddAt(fTimeSignal[icRow+63][icPad].At(icTimeBin)+csignal, icTimeBin);</span>
<span class="lineNum">     368 </span>            :   }
<span class="lineNum">     369 </span>            :   //return if we are out of the specified time bin or adc range
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :   if ( (icTimeBin&gt;fLastTimeBin) || (icTimeBin&lt;fFirstTimeBin) ) return 0;</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   if ( ((Int_t)csignal&gt;fAdcMax) || ((Int_t)csignal&lt;fAdcMin)  ) return 0;</span>
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :   Int_t iChannel  = fROC-&gt;GetRowIndexes(icsector)[icRow]+icPad; //  global pad position in sector</span>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span>            :   // fast filling method
<span class="lineNum">     376 </span>            :   // Attention: the entry counter of the histogram is not increased
<span class="lineNum">     377 </span>            :   //            this means that e.g. the colz draw option gives an empty plot
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   Int_t bin = (iChannel+1)*(fAdcMax-fAdcMin+2)+((Int_t)csignal-fAdcMin+1);</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :   GetHistoPedestal(icsector,kTRUE)-&gt;GetArray()[bin]++;</span>
<span class="lineNum">     380 </span>            :   return 0;
<span class="lineNum">     381 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     382 </span>            : 
<a name="383"><span class="lineNum">     383 </span>            : </a>
<span class="lineNum">     384 </span>            : //_____________________________________________________________________
<span class="lineNum">     385 </span>            : Bool_t AliTPCCalibPedestal::TestEvent() 
<span class="lineNum">     386 </span>            : {
<span class="lineNum">     387 </span>            :   ///  Test event loop
<span class="lineNum">     388 </span>            :   /// fill one oroc and one iroc with random gaus
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :   gRandom-&gt;SetSeed(0);</span>
<span class="lineNum">     391 </span>            : 
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :   for (UInt_t iSec=0; iSec&lt;72; ++iSec){</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     if (iSec%36&gt;0) continue;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     for (UInt_t iRow=0; iRow &lt; fROC-&gt;GetNRows(iSec); ++iRow){</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :       for (UInt_t iPad=0; iPad &lt; fROC-&gt;GetNPads(iSec,iRow); ++iPad){</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         for (UInt_t iTimeBin=0; iTimeBin&lt;1024; ++iTimeBin){</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :           Float_t signal=(Int_t)(iRow+3+gRandom-&gt;Gaus(0,.7));</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :           if ( signal&gt;0 )Update(iSec,iRow,iPad,iTimeBin,signal);</span>
<span class="lineNum">     399 </span>            :         }
<span class="lineNum">     400 </span>            :       }
<span class="lineNum">     401 </span>            :     }
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<span class="lineNum">     404 </span>            : }
<span class="lineNum">     405 </span>            : 
<a name="406"><span class="lineNum">     406 </span>            : </a>
<span class="lineNum">     407 </span>            : //_____________________________________________________________________
<span class="lineNum">     408 </span>            : TH2F* AliTPCCalibPedestal::GetHisto(Int_t sector, TObjArray *arr, 
<span class="lineNum">     409 </span>            :                                     Int_t nbinsY, Float_t ymin, Float_t ymax,
<span class="lineNum">     410 </span>            :                                     const Char_t *type, Bool_t force)
<span class="lineNum">     411 </span>            : {
<span class="lineNum">     412 </span>            :     /// return pointer to Q histogram
<span class="lineNum">     413 </span>            :     /// if force is true create a new histogram if it doesn't exist allready
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     if ( !force || arr-&gt;UncheckedAt(sector) )</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :       return (TH2F*)arr-&gt;UncheckedAt(sector);</span>
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span>            :     // if we are forced and histogram doesn't yes exist create it
<span class="lineNum">     419 </span>            :     // new histogram with Q calib information. One value for each pad!
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     TH2F* hist = new TH2F(Form(&quot;hCalib%s%.2d&quot;,type,sector),</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :                           Form(&quot;%s calibration histogram sector %.2d;ADC channel;Channel (pad)&quot;,type,sector),</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :                           nbinsY, ymin, ymax,</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :                           fROC-&gt;GetNChannels(sector),0,fROC-&gt;GetNChannels(sector)</span>
<span class="lineNum">     424 </span>            :                          );
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :     hist-&gt;SetDirectory(0);</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :     arr-&gt;AddAt(hist,sector);</span>
<span class="lineNum">     427 </span>            :     return hist;
<span class="lineNum">     428 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     429 </span>            : 
<a name="430"><span class="lineNum">     430 </span>            : </a>
<span class="lineNum">     431 </span>            : //_____________________________________________________________________
<span class="lineNum">     432 </span>            : TH2F* AliTPCCalibPedestal::GetHistoPedestal(Int_t sector, Bool_t force) 
<span class="lineNum">     433 </span>            : {
<span class="lineNum">     434 </span>            :     /// return pointer to T0 histogram
<span class="lineNum">     435 </span>            :     /// if force is true create a new histogram if it doesn't exist allready
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :     TObjArray *arr = &amp;fHistoPedestalArray;</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :     return GetHisto(sector, arr, fAdcMax-fAdcMin, fAdcMin, fAdcMax, &quot;Pedestal&quot;, force);</span>
<span class="lineNum">     439 </span>            : }
<span class="lineNum">     440 </span>            : 
<a name="441"><span class="lineNum">     441 </span>            : </a>
<span class="lineNum">     442 </span>            : //_____________________________________________________________________
<span class="lineNum">     443 </span>            : AliTPCCalROC* AliTPCCalibPedestal::GetCalRoc(Int_t sector, TObjArray* arr, Bool_t force) 
<span class="lineNum">     444 </span>            : {
<span class="lineNum">     445 </span>            :     /// return pointer to ROC Calibration
<span class="lineNum">     446 </span>            :     /// if force is true create a new histogram if it doesn't exist allready
<span class="lineNum">     447 </span>            : 
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     if ( !force || arr-&gt;UncheckedAt(sector) )</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :         return (AliTPCCalROC*)arr-&gt;UncheckedAt(sector);</span>
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span>            :     // if we are forced and the histogram doesn't yet exist create it
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            :     // new AliTPCCalROC for T0 information. One value for each pad!
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     AliTPCCalROC *croc = new AliTPCCalROC(sector);</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     arr-&gt;AddAt(croc,sector);</span>
<span class="lineNum">     456 </span>            :     return croc;
<span class="lineNum">     457 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     458 </span>            : 
<a name="459"><span class="lineNum">     459 </span>            : </a>
<span class="lineNum">     460 </span>            : //_____________________________________________________________________
<span class="lineNum">     461 </span>            : AliTPCCalROC* AliTPCCalibPedestal::GetCalRocPedestal(Int_t sector, Bool_t force) 
<span class="lineNum">     462 </span>            : {
<span class="lineNum">     463 </span>            :     /// return pointer to ROC with Pedestal data
<span class="lineNum">     464 </span>            :     /// if force is true create a new histogram if it doesn't exist allready
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :     TObjArray *arr = &amp;fCalRocArrayPedestal;</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     return GetCalRoc(sector, arr, force);</span>
<span class="lineNum">     468 </span>            : }
<span class="lineNum">     469 </span>            : 
<a name="470"><span class="lineNum">     470 </span>            : </a>
<span class="lineNum">     471 </span>            : //_____________________________________________________________________
<span class="lineNum">     472 </span>            : AliTPCCalROC* AliTPCCalibPedestal::GetCalRocSigma(Int_t sector, Bool_t force) 
<span class="lineNum">     473 </span>            : {
<span class="lineNum">     474 </span>            :     /// return pointer to  ROC with signal witdth in sigma
<span class="lineNum">     475 </span>            :     /// if force is true create a new histogram if it doesn't exist allready
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :     TObjArray *arr = &amp;fCalRocArraySigma;</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     return GetCalRoc(sector, arr, force);</span>
<a name="479"><span class="lineNum">     479 </span>            : }</a>
<span class="lineNum">     480 </span>            : //_____________________________________________________________________
<span class="lineNum">     481 </span>            : AliTPCCalROC* AliTPCCalibPedestal::GetCalRocMean(Int_t sector, Bool_t force)
<span class="lineNum">     482 </span>            : {
<span class="lineNum">     483 </span>            :   /// return pointer to ROC with signal mean information
<span class="lineNum">     484 </span>            :   /// if force is true create a new histogram if it doesn't exist allready
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :   TObjArray *arr = &amp;fCalRocArrayMean;</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :   return GetCalRoc(sector, arr, force);</span>
<span class="lineNum">     488 </span>            : }
<a name="489"><span class="lineNum">     489 </span>            : </a>
<span class="lineNum">     490 </span>            : //_____________________________________________________________________
<span class="lineNum">     491 </span>            : AliTPCCalROC* AliTPCCalibPedestal::GetCalRocRMS(Int_t sector, Bool_t force) 
<span class="lineNum">     492 </span>            : {
<span class="lineNum">     493 </span>            :   /// return pointer to signal width ROC Calibration
<span class="lineNum">     494 </span>            :   /// if force is true create a new histogram if it doesn't exist allready
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :   TObjArray *arr = &amp;fCalRocArrayRMS;</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :   return GetCalRoc(sector, arr, force);</span>
<span class="lineNum">     498 </span>            : }
<span class="lineNum">     499 </span>            : 
<a name="500"><span class="lineNum">     500 </span>            : </a>
<span class="lineNum">     501 </span>            : //_____________________________________________________________________
<span class="lineNum">     502 </span>            : void AliTPCCalibPedestal::Merge(AliTPCCalibPedestal * const ped)
<span class="lineNum">     503 </span>            : {
<span class="lineNum">     504 </span>            :   ///  Merge reference histograms of sig to the current AliTPCCalibPedestal
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :   MergeBase(ped);</span>
<span class="lineNum">     507 </span>            :   // merge histograms
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :   for (Int_t iSec=0; iSec&lt;72; ++iSec){</span>
<span class="lineNum">     509 </span>            :     // update entry counter. This is needed due to the fast filling approach
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :     if (GetHistoPedestal(iSec)) GetHistoPedestal(iSec)-&gt;SetEntries(GetHistoPedestal(iSec)-&gt;Integral());</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     if (ped-&gt;GetHistoPedestal(iSec)) ped-&gt;GetHistoPedestal(iSec)-&gt;SetEntries(ped-&gt;GetHistoPedestal(iSec)-&gt;Integral());</span>
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :     TH2F *hRefPedMerge   = ped-&gt;GetHistoPedestal(iSec);</span>
<span class="lineNum">     514 </span>            :     
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     if ( hRefPedMerge ){</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :       TDirectory *dir = hRefPedMerge-&gt;GetDirectory(); hRefPedMerge-&gt;SetDirectory(0);</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :       TH2F *hRefPed   = GetHistoPedestal(iSec);</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :       if ( hRefPed ) hRefPed-&gt;Add(hRefPedMerge);</span>
<span class="lineNum">     519 </span>            :       else {
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :         TH2F *hist = new TH2F(*hRefPedMerge);</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :         hist-&gt;SetDirectory(0);</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :         fHistoPedestalArray.AddAt(hist, iSec);</span>
<span class="lineNum">     523 </span>            :       }
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :       hRefPedMerge-&gt;SetDirectory(dir);</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     526 </span>            :   }
<span class="lineNum">     527 </span>            :   
<span class="lineNum">     528 </span>            :   // merge array
<span class="lineNum">     529 </span>            :   // ...
<span class="lineNum">     530 </span>            :   
<span class="lineNum">     531 </span><span class="lineNoCov">          0 : }</span>
<a name="532"><span class="lineNum">     532 </span>            : </a>
<span class="lineNum">     533 </span>            : //_____________________________________________________________________
<span class="lineNum">     534 </span>            : Long64_t AliTPCCalibPedestal::Merge(TCollection * const list)
<span class="lineNum">     535 </span>            : {
<span class="lineNum">     536 </span>            :   /// Merge all objects of this type in list
<span class="lineNum">     537 </span>            : 
<span class="lineNum">     538 </span>            :   Long64_t nmerged=1;
<span class="lineNum">     539 </span>            :   
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :   TIter next(list);</span>
<span class="lineNum">     541 </span>            :   AliTPCCalibPedestal *ce=0;
<span class="lineNum">     542 </span>            :   TObject *o=0;
<span class="lineNum">     543 </span>            :   
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :   while ( (o=next()) ){</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :     ce=dynamic_cast&lt;AliTPCCalibPedestal*&gt;(o);</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :     if (ce){</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :       Merge(ce);</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :       ++nmerged;</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     550 </span>            :   }
<span class="lineNum">     551 </span>            :   
<span class="lineNum">     552 </span>            :   return nmerged;
<span class="lineNum">     553 </span><span class="lineNoCov">          0 : }</span>
<a name="554"><span class="lineNum">     554 </span>            : </a>
<span class="lineNum">     555 </span>            : //_____________________________________________________________________
<span class="lineNum">     556 </span>            : void AliTPCCalibPedestal::Analyse() 
<span class="lineNum">     557 </span>            : {
<span class="lineNum">     558 </span>            :   ///  Calculate calibration constants
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :   Int_t nbinsAdc = fAdcMax-fAdcMin;</span>
<span class="lineNum">     561 </span>            : 
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :   TVectorD param(4);</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :   TMatrixD dummy(3,3);</span>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :   TH1F *hChannel=new TH1F(&quot;hChannel&quot;,&quot;hChannel&quot;,nbinsAdc,fAdcMin,fAdcMax);</span>
<span class="lineNum">     566 </span>            :   
<span class="lineNum">     567 </span>            :   Float_t *arrayhP=0;  
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :   for (Int_t iSec=0; iSec&lt;72; ++iSec){</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :     TH2F *hP = GetHistoPedestal(iSec);</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :     if ( !hP ) continue;</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :     hP-&gt;SetEntries(hP-&gt;Integral());</span>
<span class="lineNum">     573 </span>            : 
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :     AliTPCCalROC *rocPedestal = GetCalRocPedestal(iSec,kTRUE);</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :     AliTPCCalROC *rocSigma    = GetCalRocSigma(iSec,kTRUE);</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :     AliTPCCalROC *rocMean     = GetCalRocMean(iSec,kTRUE);</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :     AliTPCCalROC *rocRMS      = GetCalRocRMS(iSec,kTRUE);</span>
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :     arrayhP = hP-&gt;GetArray();</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :     UInt_t nChannels = fROC-&gt;GetNChannels(iSec);</span>
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :     for (UInt_t iChannel=0; iChannel&lt;nChannels; ++iChannel){</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :       Int_t offset = (nbinsAdc+2)*(iChannel+1)+1;</span>
<span class="lineNum">     584 </span>            :       //calculate mean and sigma using a gaus fit
<span class="lineNum">     585 </span>            :       //Double_t ret =
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :       AliMathBase::FitGaus(arrayhP+offset,nbinsAdc,fAdcMin,fAdcMax,&amp;param,&amp;dummy);</span>
<span class="lineNum">     587 </span>            :       // if the fitting failed set noise and pedestal to 0
<span class="lineNum">     588 </span>            :       // is now done in AliMathBase::FitGaus !
<span class="lineNum">     589 </span>            : //       if ( ret == -4 ) {
<span class="lineNum">     590 </span>            : //      param[1]=0;
<span class="lineNum">     591 </span>            : //      param[2]=0;
<span class="lineNum">     592 </span>            : //       }
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :       if ( param[1]&lt;fAdcMin || param[1]&gt;fAdcMax ){</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :         param[1]=0;</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         param[2]=0;</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :       rocPedestal-&gt;SetValue(iChannel,param[1]);</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :       rocSigma-&gt;SetValue(iChannel,param[2]);</span>
<span class="lineNum">     599 </span>            :       //calculate mean and RMS using a truncated means
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :       hChannel-&gt;Set(nbinsAdc+2,arrayhP+offset-1);</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :       hChannel-&gt;SetEntries(param[3]);</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :       param[1]=0;</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :       param[2]=0;</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :       if ( param[3]&gt;0 ) AliMathBase::TruncatedMean(hChannel,&amp;param,fAnaMeanDown,fAnaMeanUp);</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :       rocMean-&gt;SetValue(iChannel,param[1]);</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :       rocRMS-&gt;SetValue(iChannel,param[2]);</span>
<span class="lineNum">     607 </span>            :     }
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :   delete hChannel;</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     611 </span>            : 
<a name="612"><span class="lineNum">     612 </span>            : </a>
<span class="lineNum">     613 </span>            : //_____________________________________________________________________
<span class="lineNum">     614 </span>            : void AliTPCCalibPedestal::AnalyseTime(Int_t nevents)
<span class="lineNum">     615 </span>            : {
<span class="lineNum">     616 </span>            :   /// Calculate for each channel and time bin the mean pedestal. This
<span class="lineNum">     617 </span>            :   /// is used on LDC by TPCPEDESTALda to generate data used for configuration
<span class="lineNum">     618 </span>            :   /// of the pattern memory for baseline subtraction in the ALTROs.
<span class="lineNum">     619 </span>            : 
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :   if ( nevents &lt;= 0 ) return;</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :   if ( fTimeAnalysis ) {</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :     for (Int_t i = 0; i &lt; 159; i++) {  // padrows</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :       for (Int_t j = 0; j &lt; 140; j++) {  // pads per row</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :         for (Int_t k = 0; k &lt; 1024; k++) {  // time bins per pad</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :           fTimeSignal[i][j].AddAt(fTimeSignal[i][j].At(k)/(Float_t)nevents, k);</span>
<span class="lineNum">     626 </span>            :         }
<span class="lineNum">     627 </span>            :       }
<span class="lineNum">     628 </span>            :     }
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
