<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - TPC/TPCbase/AliTPCCalROC.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">TPC/TPCbase</a> - AliTPCCalROC.cxx<span style="font-size: 80%;"> (source / <a href="AliTPCCalROC.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">36</td>
            <td class="headerCovTableEntry">548</td>
            <td class="headerCovTableEntryLo">6.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">10</td>
            <td class="headerCovTableEntry">39</td>
            <td class="headerCovTableEntryLo">25.6 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : /// \class AliTPCCalROC
<span class="lineNum">      18 </span>            : ///
<span class="lineNum">      19 </span>            : ///     Calibration base class for a single ROC
<span class="lineNum">      20 </span>            : ///     Contains one float value per pad
<span class="lineNum">      21 </span>            : ///     mapping of the pads taken form AliTPCROC
<span class="lineNum">      22 </span>            : ///
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : // ROOT includes 
<span class="lineNum">      25 </span>            : #include &quot;TMath.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;TClass.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;TFile.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;TH1F.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;TH2F.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;TArrayI.h&quot;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : //
<span class="lineNum">      33 </span>            : //
<span class="lineNum">      34 </span>            : #include &quot;AliTPCCalROC.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;AliMathBase.h&quot;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #include &quot;TRandom3.h&quot;      // only needed by the AliTPCCalROCTest() method
<a name="38"><span class="lineNum">      38 </span>            : </a>
<span class="lineNum">      39 </span>            : /// \cond CLASSIMP
<span class="lineNum">      40 </span><span class="lineCov">         24 : ClassImp(AliTPCCalROC)</span>
<span class="lineNum">      41 </span>            : /// \endcond
<span class="lineNum">      42 </span>            : 
<a name="43"><span class="lineNum">      43 </span>            : </a>
<span class="lineNum">      44 </span>            : //_____________________________________________________________________________
<span class="lineNum">      45 </span>            : AliTPCCalROC::AliTPCCalROC()
<span class="lineNum">      46 </span><span class="lineCov">       4896 :              :TNamed(),</span>
<span class="lineNum">      47 </span><span class="lineCov">       4896 :               fSector(0),</span>
<span class="lineNum">      48 </span><span class="lineCov">       4896 :               fNChannels(0),</span>
<span class="lineNum">      49 </span><span class="lineCov">       4896 :               fNRows(0),</span>
<span class="lineNum">      50 </span><span class="lineCov">       4896 :               fkIndexes(0),</span>
<span class="lineNum">      51 </span><span class="lineCov">       4896 :               fData(0)</span>
<span class="lineNum">      52 </span><span class="lineCov">      24480 : {</span>
<span class="lineNum">      53 </span>            :   //
<span class="lineNum">      54 </span>            :   // Default constructor
<span class="lineNum">      55 </span>            :   //
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span><span class="lineCov">       9792 : }</span>
<a name="58"><span class="lineNum">      58 </span>            : </a>
<span class="lineNum">      59 </span>            : //_____________________________________________________________________________
<span class="lineNum">      60 </span>            : AliTPCCalROC::AliTPCCalROC(UInt_t  sector)
<span class="lineNum">      61 </span><span class="lineCov">        648 :              :TNamed(),</span>
<span class="lineNum">      62 </span><span class="lineCov">        648 :               fSector(0),</span>
<span class="lineNum">      63 </span><span class="lineCov">        648 :               fNChannels(0),</span>
<span class="lineNum">      64 </span><span class="lineCov">        648 :               fNRows(0),</span>
<span class="lineNum">      65 </span><span class="lineCov">        648 :               fkIndexes(0),</span>
<span class="lineNum">      66 </span><span class="lineCov">        648 :               fData(0)</span>
<span class="lineNum">      67 </span><span class="lineCov">       3240 : {</span>
<span class="lineNum">      68 </span>            :   /// Constructor that initializes a given sector
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span><span class="lineCov">        648 :   fSector = sector;</span>
<span class="lineNum">      71 </span><span class="lineCov">       1296 :   fNChannels    =  AliTPCROC::Instance()-&gt;GetNChannels(fSector);</span>
<span class="lineNum">      72 </span><span class="lineCov">       1296 :   fNRows        =  AliTPCROC::Instance()-&gt;GetNRows(fSector);</span>
<span class="lineNum">      73 </span><span class="lineCov">       1296 :   fkIndexes      =  AliTPCROC::Instance()-&gt;GetRowIndexes(fSector);</span>
<span class="lineNum">      74 </span><span class="lineCov">       1296 :   fData = new Float_t[fNChannels];</span>
<span class="lineNum">      75 </span><span class="lineCov">        648 :   Reset();</span>
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span><span class="lineCov">       1296 : }</span>
<a name="78"><span class="lineNum">      78 </span>            : </a>
<span class="lineNum">      79 </span>            : //_____________________________________________________________________________
<span class="lineNum">      80 </span>            : AliTPCCalROC::AliTPCCalROC(const AliTPCCalROC &amp;c)
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :              :TNamed(c),</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :               fSector(0),</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :               fNChannels(0),</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :               fNRows(0),</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :               fkIndexes(0),</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :               fData(0)</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      88 </span>            :   /// AliTPCCalROC copy constructor
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :   fSector = c.fSector;</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :   fNChannels    =  AliTPCROC::Instance()-&gt;GetNChannels(fSector);</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :   fNRows        =  AliTPCROC::Instance()-&gt;GetNRows(fSector);</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :   fkIndexes      =  AliTPCROC::Instance()-&gt;GetRowIndexes(fSector);</span>
<span class="lineNum">      94 </span>            :   //
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :   fData   = new Float_t[fNChannels];</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :   for (UInt_t  idata = 0; idata&lt; fNChannels; idata++) fData[idata] = c.fData[idata];</span>
<a name="97"><span class="lineNum">      97 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      98 </span>            : //____________________________________________________________________________
<span class="lineNum">      99 </span>            : AliTPCCalROC &amp; AliTPCCalROC::operator =(const AliTPCCalROC &amp; param)
<span class="lineNum">     100 </span>            : {
<span class="lineNum">     101 </span>            :   /// assignment operator - dummy
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :   if (this == &amp;param) return (*this);</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :   fSector       = param.fSector;</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :   fNChannels    =  AliTPCROC::Instance()-&gt;GetNChannels(fSector);</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :   fNRows        =  AliTPCROC::Instance()-&gt;GetNRows(fSector);</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :   fkIndexes     =  AliTPCROC::Instance()-&gt;GetRowIndexes(fSector);</span>
<span class="lineNum">     108 </span>            :   //
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :   if (fData) delete [] fData;</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :   fData         = new Float_t[fNChannels];</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :   for (UInt_t  idata = 0; idata&lt; fNChannels; idata++) fData[idata] = param.fData[idata];</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :   return (*this);</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     114 </span>            : 
<a name="115"><span class="lineNum">     115 </span>            : </a>
<span class="lineNum">     116 </span>            : //_____________________________________________________________________________
<span class="lineNum">     117 </span>            : AliTPCCalROC::~AliTPCCalROC()
<span class="lineNum">     118 </span><span class="lineCov">       7344 : {</span>
<span class="lineNum">     119 </span>            :   /// AliTPCCalROC destructor
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span><span class="lineCov">       1224 :   if (fData) {</span>
<span class="lineNum">     122 </span><span class="lineCov">       2448 :     delete [] fData;</span>
<span class="lineNum">     123 </span><span class="lineCov">       1224 :     fData = 0;</span>
<span class="lineNum">     124 </span><span class="lineCov">       1224 :   }</span>
<span class="lineNum">     125 </span><span class="lineCov">       3672 : }</span>
<span class="lineNum">     126 </span>            : 
<a name="127"><span class="lineNum">     127 </span>            : </a>
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span>            : void AliTPCCalROC::Streamer(TBuffer &amp;R__b)
<span class="lineNum">     130 </span>            : {
<span class="lineNum">     131 </span>            :    /// Stream an object of class AliTPCCalROC.
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span><span class="lineCov">      14688 :    if (R__b.IsReading()) {</span>
<span class="lineNum">     134 </span><span class="lineCov">       9792 :       AliTPCCalROC::Class()-&gt;ReadBuffer(R__b, this);</span>
<span class="lineNum">     135 </span><span class="lineCov">       4896 :       fkIndexes =  AliTPCROC::Instance()-&gt;GetRowIndexes(fSector);</span>
<span class="lineNum">     136 </span><span class="lineCov">       4896 :    } else {</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :       AliTPCCalROC::Class()-&gt;WriteBuffer(R__b,this);</span>
<span class="lineNum">     138 </span>            :    }
<a name="139"><span class="lineNum">     139 </span><span class="lineCov">       4896 : }</span></a>
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            : void AliTPCCalROC::Print(Option_t* /*option*/) const{
<span class="lineNum">     142 </span>            :   //
<span class="lineNum">     143 </span>            :   // Print summary content
<span class="lineNum">     144 </span>            :   //
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :   printf(&quot;|ROC%d|\t%f|\t%f|\t%f|\n&quot;,fSector, GetMean(),GetMedian(),GetRMS());</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span>            : 
<a name="150"><span class="lineNum">     150 </span>            : //</a>
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            : Bool_t AliTPCCalROC::MedianFilter(Int_t deltaRow, Int_t deltaPad, AliTPCCalROC* outlierROC,  Bool_t doEdge){
<span class="lineNum">     153 </span>            :   ///   Modify content of the object - raplace value by median in neighorhood
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   Float_t *newBuffer=new Float_t[fNChannels] ;</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   Double_t *cacheBuffer=new Double_t[fNChannels];</span>
<span class="lineNum">     157 </span>            :   //
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   for (Int_t iRow=0; iRow&lt; Int_t(fNRows); iRow++){</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :     Int_t nPads=GetNPads(iRow); // number of rows in current row</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :     for (Int_t iPad=0; iPad&lt;nPads; iPad++){</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :       Double_t value=GetValue(iRow,iPad);</span>
<span class="lineNum">     162 </span>            :       Int_t counter=0;
<span class="lineNum">     163 </span>            :       //
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :       for (Int_t dRow=-deltaRow; dRow&lt;=deltaRow; dRow++){</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :         Int_t jRow=iRow+dRow;  //take the row - mirror if ouside of range</span>
<span class="lineNum">     166 </span>            :         Float_t sign0=1.;
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :         if (jRow&lt;0) sign0=-1.;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :         if (UInt_t(jRow)&gt;=fNRows) sign0=-1.; </span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :         Int_t jPads= GetNPads(iRow+sign0*dRow);</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :         Int_t offset=(nPads-jPads)/2.;</span>
<span class="lineNum">     171 </span>            :         //
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :         for (Int_t dPad=-deltaPad; dPad&lt;=deltaPad; dPad++){</span>
<span class="lineNum">     173 </span>            :           Float_t sign=sign0;
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :           Int_t jPad=iPad+dPad+offset;  //take the pad - mirror if ouside of range</span>
<span class="lineNum">     175 </span>            :           Int_t kRow=jRow;
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :           if (jPad&lt;0) sign=-1;</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :           if (jPad&gt;=jPads) sign=-1;</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :           if (sign&lt;0){</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :             kRow=iRow-dRow;</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :             jPad=iPad-dPad+offset;</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :             if (!doEdge) continue;</span>
<span class="lineNum">     182 </span>            :           }       
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :           if (IsInRange(UInt_t(kRow),jPad)){</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :             Bool_t isOutlier=(outlierROC==NULL)?kFALSE:outlierROC-&gt;GetValue(kRow,jPad)&gt;0;</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :             if (!isOutlier){</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :               cacheBuffer[counter]=sign*(GetValue(kRow,jPad)-value);</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :               counter++;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     191 </span>            :       }
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :       newBuffer[fkIndexes[iRow]+iPad]=0.;</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :       if (counter&gt;1) newBuffer[fkIndexes[iRow]+iPad] = TMath::Median(counter, cacheBuffer)+value;</span>
<span class="lineNum">     194 </span>            :     }
<span class="lineNum">     195 </span>            :   }
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   memcpy(fData, newBuffer,GetNchannels()*sizeof(Float_t));</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   delete []newBuffer;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :   delete []cacheBuffer;</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<span class="lineNum">     200 </span>            : }
<span class="lineNum">     201 </span>            : 
<a name="202"><span class="lineNum">     202 </span>            : </a>
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span>            : Bool_t AliTPCCalROC::LTMFilter(Int_t deltaRow, Int_t deltaPad, Float_t fraction, Int_t type, AliTPCCalROC* outlierROC,  Bool_t doEdge){
<span class="lineNum">     205 </span>            :   ///   Modify content of the class
<span class="lineNum">     206 </span>            :   ///   write LTM mean or median
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :   if (fraction&lt;0 || fraction&gt;1) return kFALSE;</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :   Float_t *newBuffer=new Float_t[fNChannels] ;</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :   Double_t *cacheBuffer=new Double_t[fNChannels];</span>
<span class="lineNum">     211 </span>            :   //
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :   for (Int_t iRow=0; iRow&lt; Int_t(fNRows); iRow++){</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     Int_t nPads=GetNPads(iRow); // number of rows in current row</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :     for (Int_t iPad=0; iPad&lt;nPads; iPad++){</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :       Double_t value=GetValue(iRow,iPad);</span>
<span class="lineNum">     216 </span>            :       Int_t counter=0;
<span class="lineNum">     217 </span>            :       //
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :       for (Int_t dRow=-deltaRow; dRow&lt;=deltaRow; dRow++){</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :         Int_t jRow=iRow+dRow;  //take the row - mirror if ouside of range</span>
<span class="lineNum">     220 </span>            :         Float_t sign0=1.;
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         if (jRow&lt;0) sign0=-1.;</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :         if (UInt_t(jRow)&gt;=fNRows) sign0=-1.; </span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :         Int_t jPads= GetNPads(iRow+sign0*dRow);</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :         Int_t offset=(nPads-jPads)/2.;</span>
<span class="lineNum">     225 </span>            :         //
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :         for (Int_t dPad=-deltaPad; dPad&lt;=deltaPad; dPad++){</span>
<span class="lineNum">     227 </span>            :           Float_t sign=sign0;
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :           Int_t jPad=iPad+dPad+offset;  //take the pad - mirror if ouside of range</span>
<span class="lineNum">     229 </span>            :           Int_t kRow=jRow;
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :           if (jPad&lt;0) sign=-1;</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :           if (jPad&gt;=jPads) sign=-1;</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :           if (sign&lt;0){</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :             if (!doEdge) continue;</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :             kRow=iRow-dRow;</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :             jPad=iPad-dPad+offset;</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :           } </span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :           if (IsInRange(UInt_t(kRow),jPad)){</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :             Bool_t isOutlier=(outlierROC==NULL)?kFALSE:outlierROC-&gt;GetValue(kRow,jPad)&gt;0;</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :             if (!isOutlier){</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :               cacheBuffer[counter]=sign*(GetValue(kRow,jPad)-value);</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :               counter++;</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     245 </span>            :       }
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :       Double_t mean=0,rms=0;</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :       if (TMath::Nint(fraction*Double_t(counter))&gt;1 ) AliMathBase::EvaluateUni(counter,cacheBuffer,mean,rms,TMath::Nint(fraction*Double_t(counter)));</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :       mean+=value;</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :       newBuffer[fkIndexes[iRow]+iPad] = (type==0)? mean:rms;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     251 </span>            :   }
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :   memcpy(fData, newBuffer,GetNchannels()*sizeof(Float_t));</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :   delete []newBuffer;</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :   delete []cacheBuffer;</span>
<span class="lineNum">     255 </span>            :   return kTRUE;
<a name="256"><span class="lineNum">     256 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span>            : Bool_t AliTPCCalROC::Convolute(Double_t sigmaPad, Double_t sigmaRow, AliTPCCalROC*outlierROC, TF1 */*fpad*/, TF1 */*frow*/){
<span class="lineNum">     259 </span>            :   /// convolute the calibration with function fpad,frow
<span class="lineNum">     260 </span>            :   /// in range +-4 sigma
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :   Float_t *newBuffer=new Float_t[fNChannels] ;</span>
<span class="lineNum">     263 </span>            :   //
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :   for (Int_t iRow=0; iRow&lt; Int_t(fNRows); iRow++){</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     Int_t nPads=GetNPads(iRow); // number of rows in current row</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     for (Int_t iPad=0; iPad&lt;nPads; iPad++){</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :       Int_t jRow0=TMath::Max(TMath::Nint(iRow-sigmaRow*4.),0);</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :       Int_t jRow1=TMath::Min(TMath::Nint(iRow+sigmaRow*4.),Int_t(fNRows));</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :       Int_t jPad0=TMath::Max(TMath::Nint(iPad-sigmaPad*4.),0);</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :       Int_t jPad1=TMath::Min(TMath::Nint(iRow+sigmaPad*4.),Int_t(nPads));</span>
<span class="lineNum">     271 </span>            :       //
<span class="lineNum">     272 </span>            :       Double_t sumW=0;
<span class="lineNum">     273 </span>            :       Double_t sumCal=0;
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :       for (Int_t jRow=jRow0; jRow&lt;=jRow1; jRow++){</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :         for (Int_t jPad=jPad0; jPad&lt;=jPad1; jPad++){</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :           if (!IsInRange(jRow,jPad)) continue;</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :           Bool_t isOutlier=(outlierROC==NULL)?kFALSE:outlierROC-&gt;GetValue(jRow,jPad)&gt;0;</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :           if (!isOutlier){</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :             Double_t weight= TMath::Gaus(jPad,iPad,sigmaPad)*TMath::Gaus(jRow,iRow,sigmaRow);</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :             sumCal+=weight*GetValue(jRow,jPad);</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :             sumW+=weight;</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     284 </span>            :       }
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :       if (sumW&gt;0){</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :         sumCal/=sumW;</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         newBuffer[fkIndexes[iRow]+iPad]=sumCal;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     289 </span>            :     }
<span class="lineNum">     290 </span>            :   }
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :   memcpy(fData, newBuffer,GetNchannels()*sizeof(Float_t));</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :   delete []newBuffer;</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<span class="lineNum">     294 </span>            : }
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            : //
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span>            : 
<a name="303"><span class="lineNum">     303 </span>            : // algebra fuctions:</a>
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span>            : void AliTPCCalROC::Add(Float_t c1){
<span class="lineNum">     306 </span>            :   /// add c1 to each channel of the ROC  
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :   for (UInt_t  idata = 0; idata&lt; fNChannels; idata++) fData[idata]+=c1;</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 : }</span>
<a name="310"><span class="lineNum">     310 </span>            : </a>
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            : void AliTPCCalROC::Multiply(Float_t c1){
<span class="lineNum">     313 </span>            :   /// multiply each channel of the ROC with c1
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :   for (UInt_t  idata = 0; idata&lt; fNChannels; idata++) fData[idata]*=c1;</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 : }</span>
<a name="317"><span class="lineNum">     317 </span>            : </a>
<span class="lineNum">     318 </span>            : 
<span class="lineNum">     319 </span>            : void AliTPCCalROC::Add(const AliTPCCalROC * roc, Double_t c1){
<span class="lineNum">     320 </span>            :   /// multiply AliTPCCalROC roc by c1 and add each channel to the coresponing channel in the ROC
<span class="lineNum">     321 </span>            :   ///  - pad by pad 
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :   if (!roc) return;</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :   for (UInt_t  idata = 0; idata&lt; fNChannels; idata++){</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     fData[idata]+=roc-&gt;fData[idata]*c1;</span>
<span class="lineNum">     326 </span>            :   }
<span class="lineNum">     327 </span><span class="lineNoCov">          0 : }</span>
<a name="328"><span class="lineNum">     328 </span>            : </a>
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span>            : void AliTPCCalROC::Multiply(const AliTPCCalROC*  roc) {
<span class="lineNum">     331 </span>            :   /// multiply each channel of the ROC with the coresponding channel of 'roc'
<span class="lineNum">     332 </span>            :   ///     - pad by pad -
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :   if (!roc) return;</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :   for (UInt_t  idata = 0; idata&lt; fNChannels; idata++){</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     fData[idata]*=roc-&gt;fData[idata];</span>
<span class="lineNum">     337 </span>            :   }
<span class="lineNum">     338 </span><span class="lineNoCov">          0 : }</span>
<a name="339"><span class="lineNum">     339 </span>            : </a>
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            : void AliTPCCalROC::Divide(const AliTPCCalROC*  roc) {
<span class="lineNum">     342 </span>            :   /// divide each channel of the ROC by the coresponding channel of 'roc'
<span class="lineNum">     343 </span>            :   ///     - pad by pad -
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :   if (!roc) return;</span>
<span class="lineNum">     346 </span>            :   Float_t kEpsilon=0.00000000000000001;
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :   for (UInt_t  idata = 0; idata&lt; fNChannels; idata++){</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     if (TMath::Abs(roc-&gt;fData[idata])&gt;kEpsilon)</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :       fData[idata]/=roc-&gt;fData[idata];</span>
<span class="lineNum">     350 </span>            :   }
<a name="351"><span class="lineNum">     351 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span>            : void AliTPCCalROC::Reset()
<span class="lineNum">     354 </span>            : {
<span class="lineNum">     355 </span>            :   /// reset to ZERO
<span class="lineNum">     356 </span>            :   
<span class="lineNum">     357 </span><span class="lineCov">       1296 :   memset(fData,0,sizeof(Float_t)*fNChannels); // set all values to 0</span>
<span class="lineNum">     358 </span><span class="lineCov">        648 : }</span>
<a name="359"><span class="lineNum">     359 </span>            : </a>
<span class="lineNum">     360 </span>            : //____________________________________________________________
<span class="lineNum">     361 </span>            : Double_t AliTPCCalROC::GetStats(EStatType statType, AliTPCCalROC *const outlierROC, EPadType padType) const
<span class="lineNum">     362 </span>            : {
<span class="lineNum">     363 </span>            :   ///  returns the mean or median or RMS value depending on the statType 
<span class="lineNum">     364 </span>            :   ///  of the ROC or medium or long pad region
<span class="lineNum">     365 </span>            :   ///  pads with value != 0 in outlierROC are not used for the calculation
<span class="lineNum">     366 </span>            :   ///  return 0 if no data is accepted by the outlier cuts 
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :   if(fSector&lt;36) padType=kAll;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :   if (!outlierROC) {</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :     if(padType==kAll) {</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :       if     (statType==kMean)       return TMath::Mean      (fNChannels, fData);</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :       else if(statType==kMedian)     return TMath::Median    (fNChannels, fData);</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :       else if(statType==kRMS)        return TMath::RMS       (fNChannels, fData);</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :       else if(statType==kMinElement) return TMath::MinElement(fNChannels, fData);</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :       else if(statType==kMaxElement) return TMath::MaxElement(fNChannels, fData);</span>
<span class="lineNum">     376 </span>            :     }
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     else if(padType==kOROCmedium) {</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :       if     (statType==kMean)       return TMath::Mean      (fkIndexes[64], fData);</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :       else if(statType==kMedian)     return TMath::Median    (fkIndexes[64], fData);</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :       else if(statType==kRMS)        return TMath::RMS       (fkIndexes[64], fData);</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :       else if(statType==kMinElement) return TMath::MinElement(fkIndexes[64], fData);</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :       else if(statType==kMaxElement) return TMath::MaxElement(fkIndexes[64], fData);</span>
<span class="lineNum">     383 </span>            :     }
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :     else if(padType==kOROClong) {</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :       const Int_t offset=fkIndexes[64];</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :       if     (statType==kMean)       return TMath::Mean      (fNChannels-offset, fData+offset);</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :       else if(statType==kMedian)     return TMath::Median    (fNChannels-offset, fData+offset);</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :       else if(statType==kRMS)        return TMath::RMS       (fNChannels-offset, fData+offset);</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :       else if(statType==kMinElement) return TMath::MinElement(fNChannels-offset, fData+offset);</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :       else if(statType==kMaxElement) return TMath::MaxElement(fNChannels-offset, fData+offset);</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     392 </span>            :   }//end of no outlierROC
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :   Float_t ddata[fNChannels];</span>
<span class="lineNum">     395 </span>            : 
<span class="lineNum">     396 </span>            :   Int_t nPoints = 0;
<span class="lineNum">     397 </span>            :   UInt_t indexMin = 0;
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :   UInt_t indexMax = fNChannels;</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :   if(padType==kOROCmedium) indexMax=fkIndexes[64];</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :   else if(padType==kOROClong) indexMin=fkIndexes[64];</span>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :   for (UInt_t i=indexMin;i&lt;indexMax;i++) {</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :     if (outlierROC-&gt;GetValue(i)&gt;1e-20) continue;</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     ddata[nPoints]= fData[i];</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :     nPoints++;</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     407 </span>            :   Double_t value = 0;
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :   if(nPoints&gt;0){</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     if     (statType==kMean)       value = TMath::Mean      (nPoints, ddata);</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :     else if(statType==kMedian)     value = TMath::Median    (nPoints, ddata);</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :     else if(statType==kRMS)        value = TMath::RMS       (nPoints, ddata);</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :     else if(statType==kMinElement) value = TMath::MinElement(nPoints, ddata);</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     else if(statType==kMaxElement) value = TMath::MaxElement(nPoints, ddata);</span>
<span class="lineNum">     414 </span>            :   }
<span class="lineNum">     415 </span>            :   return value;
<span class="lineNum">     416 </span><span class="lineNoCov">          0 : }</span>
<a name="417"><span class="lineNum">     417 </span>            : </a>
<span class="lineNum">     418 </span>            : //_____________________________________________________________________________
<span class="lineNum">     419 </span>            : Double_t AliTPCCalROC::GetMean(AliTPCCalROC *const outlierROC,EPadType padType) const
<span class="lineNum">     420 </span>            : {
<span class="lineNum">     421 </span>            :   ///  returns the mean value of the ROC
<span class="lineNum">     422 </span>            :   ///  pads with value != 0 in outlierROC are not used for the calculation
<span class="lineNum">     423 </span>            :   ///  return 0 if no data is accepted by the outlier cuts 
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :   return GetStats(kMean,outlierROC,padType);</span>
<span class="lineNum">     426 </span>            : }
<a name="427"><span class="lineNum">     427 </span>            : </a>
<span class="lineNum">     428 </span>            : //_____________________________________________________________________________
<span class="lineNum">     429 </span>            : Double_t AliTPCCalROC::GetMedian(AliTPCCalROC *const outlierROC,EPadType padType) const
<span class="lineNum">     430 </span>            : {
<span class="lineNum">     431 </span>            :   ///  returns the median value of the ROC
<span class="lineNum">     432 </span>            :   ///  pads with value != 0 in outlierROC are not used for the calculation
<span class="lineNum">     433 </span>            :   ///  return 0 if no data is accepted by the outlier cuts 
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :   return GetStats(kMedian,outlierROC,padType);</span>
<span class="lineNum">     436 </span>            : }
<a name="437"><span class="lineNum">     437 </span>            : </a>
<span class="lineNum">     438 </span>            : //_____________________________________________________________________________
<span class="lineNum">     439 </span>            : Double_t AliTPCCalROC::GetRMS(AliTPCCalROC *const outlierROC,EPadType padType) const
<span class="lineNum">     440 </span>            : {
<span class="lineNum">     441 </span>            :    ///  returns the RMS value of the ROC
<span class="lineNum">     442 </span>            :    ///  pads with value != 0 in outlierROC are not used for the calculation
<span class="lineNum">     443 </span>            :    ///  return 0 if no data is accepted by the outlier cuts 
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :   return GetStats(kRMS,outlierROC,padType);</span>
<span class="lineNum">     446 </span>            : }
<a name="447"><span class="lineNum">     447 </span>            : </a>
<span class="lineNum">     448 </span>            : //_____________________________________________________________________________
<span class="lineNum">     449 </span>            : Double_t AliTPCCalROC::GetMinElement(AliTPCCalROC *const outlierROC,EPadType padType) const
<span class="lineNum">     450 </span>            : {
<span class="lineNum">     451 </span>            :   ///  returns the MinElement value of the ROC
<span class="lineNum">     452 </span>            :   ///  pads with value != 0 in outlierROC are not used for the calculation
<span class="lineNum">     453 </span>            :   ///  return 0 if no data is accepted by the outlier cuts
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :   return GetStats(kMinElement,outlierROC,padType);</span>
<span class="lineNum">     456 </span>            : }
<a name="457"><span class="lineNum">     457 </span>            : </a>
<span class="lineNum">     458 </span>            : //_____________________________________________________________________________
<span class="lineNum">     459 </span>            : Double_t AliTPCCalROC::GetMaxElement(AliTPCCalROC *const outlierROC,EPadType padType) const
<span class="lineNum">     460 </span>            : {
<span class="lineNum">     461 </span>            :   ///  returns the MaxElement value of the ROC
<span class="lineNum">     462 </span>            :   ///  pads with value != 0 in outlierROC are not used for the calculation
<span class="lineNum">     463 </span>            :   ///  return 0 if no data is accepted by the outlier cuts
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :   return GetStats(kMaxElement,outlierROC,padType);</span>
<span class="lineNum">     466 </span>            : }
<a name="467"><span class="lineNum">     467 </span>            : </a>
<span class="lineNum">     468 </span>            : //_____________________________________________________________________________
<span class="lineNum">     469 </span>            : Double_t AliTPCCalROC::GetLTM(Double_t *const sigma, Double_t fraction, AliTPCCalROC *const outlierROC, EPadType padType){
<span class="lineNum">     470 </span>            :   ///  returns the LTM and sigma
<span class="lineNum">     471 </span>            :   ///  pads with value != 0 in outlierROC are not used for the calculation
<span class="lineNum">     472 </span>            :   ///  return 0 if no data is accepted by the outlier cuts 
<span class="lineNum">     473 </span>            :   ///  LTM for different padType
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :   if(fSector&lt;36) padType=kAll;</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :   Double_t ddata[fNChannels];</span>
<span class="lineNum">     477 </span>            :   UInt_t nPoints = 0;
<span class="lineNum">     478 </span>            :   UInt_t indexMin = 0;
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :   UInt_t indexMax = fNChannels;</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :   if(padType==kOROCmedium) indexMax=fkIndexes[64];</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :   else if(padType==kOROClong) indexMin=fkIndexes[64];</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :   for (UInt_t i=indexMin;i&lt;indexMax;i++) {</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :      if (outlierROC &amp;&amp; (outlierROC-&gt;GetValue(i) &gt;1e-20)) continue;</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :      ddata[nPoints]= fData[i];</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :      nPoints++;</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :   Double_t ltm =0, lsigma=0;</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :   if(nPoints&gt;0) {</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :     Int_t hh = TMath::Min(TMath::Nint(fraction *nPoints), Int_t(nPoints));</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :     AliMathBase::EvaluateUni(nPoints,ddata, ltm, lsigma, hh);</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :     if (sigma) *sigma=lsigma;</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     494 </span>            :   
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :   return ltm;</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 : }</span>
<a name="497"><span class="lineNum">     497 </span>            : </a>
<span class="lineNum">     498 </span>            : //_____________________________________________________________________________
<span class="lineNum">     499 </span>            : TH1F * AliTPCCalROC::MakeHisto1D(Float_t min, Float_t max,Int_t type){
<span class="lineNum">     500 </span>            :   /// make 1D histo
<span class="lineNum">     501 </span>            :   /// type -1 = user defined range
<span class="lineNum">     502 </span>            :   ///       0 = nsigma cut nsigma=min
<span class="lineNum">     503 </span>            :   ///       1 = delta cut around median delta=min
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :   if (type&gt;=0){</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :     if (type==0){</span>
<span class="lineNum">     507 </span>            :       // nsigma range
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :       Float_t mean  = GetMean();</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :       Float_t sigma = GetRMS();</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :       Float_t nsigma = TMath::Abs(min);</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :       min = mean-nsigma*sigma;</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :       max = mean+nsigma*sigma;</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     if (type==1){</span>
<span class="lineNum">     515 </span>            :       // fixed range
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :       Float_t mean   = GetMedian();</span>
<span class="lineNum">     517 </span>            :       Float_t  delta = min;
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :       min = mean-delta;</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :       max = mean+delta;</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :     if (type==2){</span>
<span class="lineNum">     522 </span>            :       //
<span class="lineNum">     523 </span>            :       // LTM mean +- nsigma
<span class="lineNum">     524 </span>            :       //
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :       Double_t sigma;</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :       Float_t mean  = GetLTM(&amp;sigma,max);</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :       sigma*=min;</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :       min = mean-sigma;</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :       max = mean+sigma;</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     531 </span>            :   }
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :   TString name=Form(&quot;%s ROC 1D%d&quot;,GetTitle(),fSector);</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :   TH1F * his = new TH1F(name.Data(),name.Data(),100, min,max);</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :   for (UInt_t irow=0; irow&lt;fNRows; irow++){</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :     UInt_t npads = (Int_t)GetNPads(irow);</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :     for (UInt_t ipad=0; ipad&lt;npads; ipad++){</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :       his-&gt;Fill(GetValue(irow,ipad));</span>
<span class="lineNum">     538 </span>            :     }
<span class="lineNum">     539 </span>            :   }
<span class="lineNum">     540 </span>            :   return his;
<span class="lineNum">     541 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     542 </span>            : 
<a name="543"><span class="lineNum">     543 </span>            : </a>
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span>            : TH2F * AliTPCCalROC::MakeHisto2D(Float_t min, Float_t max,Int_t type){
<span class="lineNum">     546 </span>            :   /// make 2D histo
<span class="lineNum">     547 </span>            :   /// type -1 = user defined range
<span class="lineNum">     548 </span>            :   ///       0 = nsigma cut nsigma=min
<span class="lineNum">     549 </span>            :   ///       1 = delta cut around median delta=min
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :   if (type&gt;=0){</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     if (type==0){</span>
<span class="lineNum">     553 </span>            :       // nsigma range
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :       Float_t mean  = GetMean();</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :       Float_t sigma = GetRMS();</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :       Float_t nsigma = TMath::Abs(min);</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :       min = mean-nsigma*sigma;</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :       max = mean+nsigma*sigma;</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :     if (type==1){</span>
<span class="lineNum">     561 </span>            :       // fixed range
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :       Float_t mean   = GetMedian();</span>
<span class="lineNum">     563 </span>            :       Float_t  delta = min;
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :       min = mean-delta;</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :       max = mean+delta;</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :     if (type==2){</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :       Double_t sigma;</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :       Float_t mean  = GetLTM(&amp;sigma,max);</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :       sigma*=min;</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :       min = mean-sigma;</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :       max = mean+sigma;</span>
<span class="lineNum">     573 </span>            : 
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     575 </span>            :   }
<span class="lineNum">     576 </span>            :   UInt_t maxPad = 0;
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :   for (UInt_t irow=0; irow&lt;fNRows; irow++){</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :     if (GetNPads(irow)&gt;maxPad) maxPad = GetNPads(irow);</span>
<span class="lineNum">     579 </span>            :   }
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :   TString name=Form(&quot;%s ROC%d&quot;,GetTitle(),fSector);</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :   TH2F * his = new TH2F(name.Data(),name.Data(),fNRows+10,-5, fNRows+5, maxPad+10, -(Int_t(maxPad/2))-5, maxPad/2+5);</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :   for (UInt_t irow=0; irow&lt;fNRows; irow++){</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :     UInt_t npads = (Int_t)GetNPads(irow);</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :     for (UInt_t ipad=0; ipad&lt;npads; ipad++){</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :       his-&gt;Fill(irow+0.5,Int_t(ipad)-Int_t(npads/2)+0.5,GetValue(irow,ipad));</span>
<span class="lineNum">     587 </span>            :     }
<span class="lineNum">     588 </span>            :   }
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :   his-&gt;SetMaximum(max);</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :   his-&gt;SetMinimum(min);</span>
<span class="lineNum">     591 </span>            :   return his;
<a name="592"><span class="lineNum">     592 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span>            : TH2F * AliTPCCalROC::MakeHistoOutliers(Float_t delta, Float_t fraction, Int_t type){
<span class="lineNum">     595 </span>            :   /// Make Histogram with outliers
<span class="lineNum">     596 </span>            :   /// mode = 0 - sigma cut used
<span class="lineNum">     597 </span>            :   /// mode = 1 - absolute cut used
<span class="lineNum">     598 </span>            :   /// fraction - fraction of values used to define sigma
<span class="lineNum">     599 </span>            :   /// delta - in mode 0 - nsigma cut
<span class="lineNum">     600 </span>            :   ///            mode 1 - delta cut
<span class="lineNum">     601 </span>            : 
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :   Double_t sigma;</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :   Float_t mean  = GetLTM(&amp;sigma,fraction);  </span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :   if (type==0) delta*=sigma; </span>
<span class="lineNum">     605 </span>            :   UInt_t maxPad = 0;
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :   for (UInt_t irow=0; irow&lt;fNRows; irow++){</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     if (GetNPads(irow)&gt;maxPad) maxPad = GetNPads(irow);</span>
<span class="lineNum">     608 </span>            :   }
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :   TString name=Form(&quot;%s ROC Outliers%d&quot;,GetTitle(),fSector);</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :   TH2F * his = new TH2F(name.Data(),name.Data(),fNRows+10,-5, fNRows+5, maxPad+10, -(Int_t(maxPad/2))-5, maxPad/2+5);</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :   for (UInt_t irow=0; irow&lt;fNRows; irow++){</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :     UInt_t npads = (Int_t)GetNPads(irow);</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :     for (UInt_t ipad=0; ipad&lt;npads; ipad++){</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :       if (TMath::Abs(GetValue(irow,ipad)-mean)&gt;delta)</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :         his-&gt;Fill(irow+0.5,Int_t(ipad)-Int_t(npads/2)+0.5,1);</span>
<span class="lineNum">     617 </span>            :     }
<span class="lineNum">     618 </span>            :   }
<span class="lineNum">     619 </span>            :   return his;
<span class="lineNum">     620 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     621 </span>            : 
<a name="622"><span class="lineNum">     622 </span>            : </a>
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span>            : void AliTPCCalROC::Draw(Option_t* opt){
<span class="lineNum">     625 </span>            :   /// create histogram with values and draw it
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span>            :   TH1 * his=0; 
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :   TString option=opt;</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :   option.ToUpper();</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :   if (option.Contains(&quot;1D&quot;)){</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :     his = MakeHisto1D();</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     633 </span>            :   else{
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :     his = MakeHisto2D();</span>
<span class="lineNum">     635 </span>            :   }
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :   his-&gt;Draw(option);</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span>            : 
<a name="641"><span class="lineNum">     641 </span>            : </a>
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span>            : void AliTPCCalROC::Test() {
<span class="lineNum">     644 </span>            :   /// example function to show functionality and test AliTPCCalROC
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span>            :   Float_t kEpsilon=0.00001;
<span class="lineNum">     647 </span>            :   
<span class="lineNum">     648 </span>            :   // create CalROC with defined values
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :   AliTPCCalROC  roc0(0);  </span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :   for (UInt_t irow = 0; irow &lt;roc0.GetNrows(); irow++){</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :     for (UInt_t ipad = 0; ipad &lt;roc0.GetNPads(irow); ipad++){</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :       Float_t value  = irow+ipad/1000.;</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :       roc0.SetValue(irow,ipad,value);</span>
<span class="lineNum">     654 </span>            :     }
<span class="lineNum">     655 </span>            :   }
<span class="lineNum">     656 </span>            :   
<span class="lineNum">     657 </span>            :   // copy CalROC, readout values and compare to original
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :   AliTPCCalROC roc1(roc0);</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :   for (UInt_t irow = 0; irow &lt;roc1.GetNrows(); irow++){</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :     for (UInt_t ipad = 0; ipad &lt;roc1.GetNPads(irow); ipad++){</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :       Float_t value  = irow+ipad/1000.;</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :       if (roc1.GetValue(irow,ipad)!=value){</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :         printf(&quot;Read/Write error\trow=%d\tpad=%d\n&quot;,irow,ipad);</span>
<span class="lineNum">     664 </span>            :       }
<span class="lineNum">     665 </span>            :     }
<span class="lineNum">     666 </span>            :   }
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span>            :   // write original CalROC to file
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :   TFile f(&quot;calcTest.root&quot;,&quot;recreate&quot;);</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :   roc0.Write(&quot;Roc0&quot;);</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :   AliTPCCalROC * roc2 = (AliTPCCalROC*)f.Get(&quot;Roc0&quot;);</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :   f.Close();</span>
<span class="lineNum">     673 </span>            :   
<span class="lineNum">     674 </span>            :   // read CalROC from file and compare to original CalROC
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :   for (UInt_t irow = 0; irow &lt;roc0.GetNrows(); irow++){</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :     if (roc0.GetNPads(irow)!=roc2-&gt;GetNPads(irow))</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :       printf(&quot;NPads - Read/Write error\trow=%d\n&quot;,irow);</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :     for (UInt_t ipad = 0; ipad &lt;roc1.GetNPads(irow); ipad++){</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :       Float_t value  = irow+ipad/1000.;</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :       if (roc2-&gt;GetValue(irow,ipad)!=value){</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :         printf(&quot;Read/Write error\trow=%d\tpad=%d\n&quot;,irow,ipad);</span>
<span class="lineNum">     682 </span>            :       }
<span class="lineNum">     683 </span>            :     }
<span class="lineNum">     684 </span>            :   }
<span class="lineNum">     685 </span>            : 
<span class="lineNum">     686 </span>            :   // 
<span class="lineNum">     687 </span>            :   // Algebra Tests
<span class="lineNum">     688 </span>            :   //
<span class="lineNum">     689 </span>            :   
<span class="lineNum">     690 </span>            :   // Add constant
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :   AliTPCCalROC roc3(roc0);</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :   roc3.Add(1.5);</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :   for (UInt_t irow = 0; irow &lt;roc3.GetNrows(); irow++){</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :     for (UInt_t ipad = 0; ipad &lt;roc3.GetNPads(irow); ipad++){</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :       Float_t value  = irow+ipad/1000. + 1.5;</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :       if (TMath::Abs(roc3.GetValue(irow,ipad)-value) &gt; kEpsilon){</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :         printf(&quot;Add constant - error\trow=%d\tpad=%d\n&quot;,irow,ipad);</span>
<span class="lineNum">     698 </span>            :       }
<span class="lineNum">     699 </span>            :     }
<span class="lineNum">     700 </span>            :   }
<span class="lineNum">     701 </span>            : 
<span class="lineNum">     702 </span>            :   // Add another CalROC
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :   AliTPCCalROC roc4(roc0);</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :   roc4.Add(&amp;roc0, -1.5);</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :   for (UInt_t irow = 0; irow &lt;roc4.GetNrows(); irow++){</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :     for (UInt_t ipad = 0; ipad &lt;roc4.GetNPads(irow); ipad++){</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :       Float_t value  = irow+ipad/1000. - 1.5 * (irow+ipad/1000.);</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :       if (TMath::Abs(roc4.GetValue(irow,ipad)-value) &gt; kEpsilon){</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :         printf(&quot;Add CalROC - error\trow=%d\tpad=%d\n&quot;,irow,ipad);</span>
<span class="lineNum">     710 </span>            :       }
<span class="lineNum">     711 </span>            :     }
<span class="lineNum">     712 </span>            :   }
<span class="lineNum">     713 </span>            :   
<span class="lineNum">     714 </span>            :   // Multiply with constant
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :   AliTPCCalROC roc5(roc0);</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :   roc5.Multiply(-1.4);</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :   for (UInt_t irow = 0; irow &lt;roc5.GetNrows(); irow++){</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :     for (UInt_t ipad = 0; ipad &lt;roc5.GetNPads(irow); ipad++){</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :       Float_t value  = (irow+ipad/1000.) * (-1.4);</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :       if (TMath::Abs(roc5.GetValue(irow,ipad)-value) &gt; kEpsilon){</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :         printf(&quot;Multiply with constant - error\trow=%d\tpad=%d\n&quot;,irow,ipad);</span>
<span class="lineNum">     722 </span>            :       }
<span class="lineNum">     723 </span>            :     }
<span class="lineNum">     724 </span>            :   }
<span class="lineNum">     725 </span>            : 
<span class="lineNum">     726 </span>            :   // Multiply another CalROC
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :   AliTPCCalROC roc6(roc0);</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :   roc6.Multiply(&amp;roc0);</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :   for (UInt_t irow = 0; irow &lt;roc6.GetNrows(); irow++){</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :     for (UInt_t ipad = 0; ipad &lt;roc6.GetNPads(irow); ipad++){</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :       Float_t value  = (irow+ipad/1000.) * (irow+ipad/1000.);</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :       if (TMath::Abs(roc6.GetValue(irow,ipad)-value) &gt; kEpsilon*100){</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :         printf(&quot;Multiply with CalROC - error\trow=%d\tpad=%d\n&quot;,irow,ipad);</span>
<span class="lineNum">     734 </span>            :       }
<span class="lineNum">     735 </span>            :     }
<span class="lineNum">     736 </span>            :   }
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span>            :   // Divide by CalROC
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :   AliTPCCalROC roc7(roc0);</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :   roc7.Divide(&amp;roc0);</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :   for (UInt_t irow = 0; irow &lt;roc7.GetNrows(); irow++){</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :     for (UInt_t ipad = 0; ipad &lt;roc7.GetNPads(irow); ipad++){</span>
<span class="lineNum">     744 </span>            :       Float_t value  = 1.;
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :       if (irow+ipad == 0) value = roc0.GetValue(irow,ipad);</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :       if (TMath::Abs(roc7.GetValue(irow,ipad)-value) &gt; kEpsilon){</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :         printf(&quot;Multiply with CalROC - error\trow=%d\tpad=%d\n&quot;,irow,ipad);</span>
<span class="lineNum">     748 </span>            :       }
<span class="lineNum">     749 </span>            :     }
<span class="lineNum">     750 </span>            :   }
<span class="lineNum">     751 </span>            : 
<span class="lineNum">     752 </span>            :   //
<span class="lineNum">     753 </span>            :   // Statistics Test
<span class="lineNum">     754 </span>            :   //
<span class="lineNum">     755 </span>            :   
<span class="lineNum">     756 </span>            :   // create CalROC with defined values
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :   TRandom3 rnd(0);</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :   AliTPCCalROC sroc0(0);</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :   for (UInt_t ichannel = 0; ichannel &lt; sroc0.GetNchannels(); ichannel++){</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     Float_t value  = rnd.Gaus(10., 2.);</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :     sroc0.SetValue(ichannel,value);</span>
<span class="lineNum">     762 </span>            :   }
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :   printf(&quot;Mean   (should be close to 10): %f\n&quot;, sroc0.GetMean());</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :   printf(&quot;RMS    (should be close to  2): %f\n&quot;, sroc0.GetRMS());</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :   printf(&quot;Median (should be close to 10): %f\n&quot;, sroc0.GetMedian());</span>
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :   printf(&quot;LTM    (should be close to 10): %f\n&quot;, sroc0.GetLTM());</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span>            :   //AliTPCCalROC* sroc1 = sroc0.LocalFit(4, 8);
<span class="lineNum">     770 </span>            :   
<span class="lineNum">     771 </span>            :   //delete sroc1;
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span>            : //        std::cout &lt;&lt; TMath::Abs(roc5.GetValue(irow,ipad)-value) &lt;&lt; std::endl;
<span class="lineNum">     774 </span><span class="lineNoCov">          0 : }</span>
<a name="775"><span class="lineNum">     775 </span>            : </a>
<span class="lineNum">     776 </span>            : 
<span class="lineNum">     777 </span>            : AliTPCCalROC * AliTPCCalROC::LocalFit(Int_t rowRadius, Int_t padRadius, AliTPCCalROC* ROCoutliers, Bool_t robust, Double_t chi2Threshold, Double_t robustFraction) {
<span class="lineNum">     778 </span>            :   /// MakeLocalFit - smoothing
<span class="lineNum">     779 </span>            :   /// returns a AliTPCCalROC with smoothed data
<span class="lineNum">     780 </span>            :   /// rowRadius and padRadius specifies a window around a given pad. 
<span class="lineNum">     781 </span>            :   /// The data of this window are fitted with a parabolic function. 
<span class="lineNum">     782 </span>            :   /// This function is evaluated at the pad's position.
<span class="lineNum">     783 </span>            :   /// At the edges the window is shifted, so that the specified pad is not anymore in the center of the window. 
<span class="lineNum">     784 </span>            :   /// rowRadius  -  radius - rows to be used for smoothing
<span class="lineNum">     785 </span>            :   /// padradius  -  radius - pads to be used for smoothing
<span class="lineNum">     786 </span>            :   /// ROCoutlier -  map of outliers - pads not to be used for local smoothing
<span class="lineNum">     787 </span>            :   /// robust     -  robust method of fitting  - (much slower)
<span class="lineNum">     788 </span>            :   /// chi2Threshold: Threshold for chi2 when EvalRobust is called
<span class="lineNum">     789 </span>            :   /// robustFraction: Fraction of data that will be used in EvalRobust
<span class="lineNum">     790 </span>            : 
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :   AliTPCCalROC * xROCfitted = new AliTPCCalROC(fSector);</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :   TLinearFitter fitterQ(6,&quot;hyp5&quot;);</span>
<span class="lineNum">     793 </span>            :    // TLinearFitter fitterQ(6,&quot;x0++x1++x2++x3++x4++x5&quot;);
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :   fitterQ.StoreData(kTRUE);</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :   for (UInt_t row=0; row &lt; GetNrows(); row++) {</span>
<span class="lineNum">     796 </span>            :     //std::cout &lt;&lt; &quot;Entering row &quot; &lt;&lt; row &lt;&lt; &quot; of &quot; &lt;&lt; GetNrows() &lt;&lt; &quot; @ sector &quot;&lt;&lt; fSector &lt;&lt; &quot; for local fitting... &quot;&lt;&lt; std::endl;
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :     for (UInt_t pad=0; pad &lt; GetNPads(row); pad++)</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :       xROCfitted-&gt;SetValue(row, pad, GetNeighbourhoodValue(&amp;fitterQ, row, pad, rowRadius, padRadius, ROCoutliers, robust, chi2Threshold, robustFraction));</span>
<span class="lineNum">     799 </span>            :   }
<span class="lineNum">     800 </span>            :   return xROCfitted;
<span class="lineNum">     801 </span><span class="lineNoCov">          0 : }</span>
<a name="802"><span class="lineNum">     802 </span>            : </a>
<span class="lineNum">     803 </span>            : 
<span class="lineNum">     804 </span>            : Double_t AliTPCCalROC::GetNeighbourhoodValue(TLinearFitter* fitterQ, Int_t row, Int_t pad, Int_t rRadius, Int_t pRadius, AliTPCCalROC *const ROCoutliers, Bool_t robust, Double_t chi2Threshold, Double_t robustFraction) {
<span class="lineNum">     805 </span>            :   /// AliTPCCalROC::GetNeighbourhoodValue - smoothing - PRIVATE
<span class="lineNum">     806 </span>            :   /// in this function the fit for LocalFit is done
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :   fitterQ-&gt;ClearPoints();</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :   TVectorD fitParam(6);</span>
<span class="lineNum">     810 </span>            :   Int_t    npoints=0;
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :   Double_t xx[6];</span>
<span class="lineNum">     812 </span>            :   Float_t dlx, dly;
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :   Float_t lPad[3] = {0};</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :   Float_t localXY[3] = {0};</span>
<span class="lineNum">     815 </span>            :   
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :   AliTPCROC* tpcROCinstance = AliTPCROC::Instance();</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :   tpcROCinstance-&gt;GetPositionLocal(fSector, row, pad, lPad);  // calculate position lPad by pad and row number</span>
<span class="lineNum">     818 </span>            :   
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :   TArrayI *neighbourhoodRows = 0;</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :   TArrayI *neighbourhoodPads = 0;</span>
<span class="lineNum">     821 </span>            :   
<span class="lineNum">     822 </span>            :   //std::cerr &lt;&lt; &quot;Trying to get neighbourhood for row &quot; &lt;&lt; row &lt;&lt; &quot;, pad &quot; &lt;&lt; pad &lt;&lt; std::endl;
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :   GetNeighbourhood(neighbourhoodRows, neighbourhoodPads, row, pad, rRadius, pRadius);</span>
<span class="lineNum">     824 </span>            :   //std::cerr &lt;&lt; &quot;Got neighbourhood for row &quot; &lt;&lt; row &lt;&lt; &quot;, pad &quot; &lt;&lt; pad &lt;&lt; std::endl;
<span class="lineNum">     825 </span>            :   
<span class="lineNum">     826 </span>            :   Int_t r, p;
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i &lt; (2*rRadius+1)*(2*pRadius+1); i++) {</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :     r = neighbourhoodRows-&gt;At(i);</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :     p = neighbourhoodPads-&gt;At(i);</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :     if (r == -1 || p == -1) continue;   // window is bigger than ROC</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :     tpcROCinstance-&gt;GetPositionLocal(fSector, r, p, localXY);   // calculate position localXY by pad and row number</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :     dlx = lPad[0] - localXY[0];</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :     dly = lPad[1] - localXY[1];</span>
<span class="lineNum">     834 </span>            :     //xx[0] = 1;
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :     xx[1] = dlx;</span>
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :     xx[2] = dly;</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :     xx[3] = dlx*dlx;</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :     xx[4] = dly*dly;</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :     xx[5] = dlx*dly;</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :     if (!ROCoutliers || ROCoutliers-&gt;GetValue(r,p) != 1) {</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :       fitterQ-&gt;AddPoint(&amp;xx[1], GetValue(r, p), 1);</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :       npoints++;</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     844 </span>            :   }
<span class="lineNum">     845 </span>            :   
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :   delete neighbourhoodRows;</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :   delete neighbourhoodPads;</span>
<span class="lineNum">     848 </span>            :   
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :   if (npoints &lt; 0.5 * ((2*rRadius+1)*(2*pRadius+1)) ) {</span>
<span class="lineNum">     850 </span>            :     // std::cerr &lt;&lt; &quot;Too few data points for fitting @ row &quot; &lt;&lt; row &lt;&lt; &quot;, pad &quot; &lt;&lt; pad &lt;&lt; &quot; in sector &quot; &lt;&lt; fSector &lt;&lt; std::endl;
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :     return 0.;  // for diagnostic</span>
<span class="lineNum">     852 </span>            :   }
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :   fitterQ-&gt;Eval();</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :   fitterQ-&gt;GetParameters(fitParam);</span>
<span class="lineNum">     855 </span>            :   Float_t chi2Q = 0;
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :   if (robust) chi2Q = fitterQ-&gt;GetChisquare()/(npoints-6.);</span>
<span class="lineNum">     857 </span>            :   //if (robust) chi2Q = fitterQ-&gt;GetChisquare()/(npoints-6.);
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :   if (robust &amp;&amp; chi2Q &gt; chi2Threshold) {</span>
<span class="lineNum">     859 </span>            :     //std::cout &lt;&lt; &quot;robust fitter called... &quot; &lt;&lt; std::endl;
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :     fitterQ-&gt;EvalRobust(robustFraction);</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :     fitterQ-&gt;GetParameters(fitParam);</span>
<span class="lineNum">     862 </span>            :   }
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :   Double_t value = fitParam[0];</span>
<span class="lineNum">     864 </span>            :   
<span class="lineNum">     865 </span>            :   //if (value &lt; 0) std::cerr &lt;&lt; &quot;negative fit-value &quot; &lt;&lt; value &lt;&lt; &quot; in sector &quot;&lt;&lt; this-&gt;fSector &lt;&lt; &quot; @ row: &quot; &lt;&lt; row &lt;&lt; &quot; and pad: &quot; &lt;&lt; pad &lt;&lt; &quot;, with fitter Chi2 = &quot; &lt;&lt; chi2Q &lt;&lt;  std::endl;
<span class="lineNum">     866 </span>            :   return value;
<span class="lineNum">     867 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     868 </span>            : 
<span class="lineNum">     869 </span>            : 
<a name="870"><span class="lineNum">     870 </span>            : </a>
<span class="lineNum">     871 </span>            : 
<span class="lineNum">     872 </span>            : void AliTPCCalROC::GetNeighbourhood(TArrayI* &amp;rowArray, TArrayI* &amp;padArray, Int_t row, Int_t pad, Int_t rRadius, Int_t pRadius) {
<span class="lineNum">     873 </span>            :   /// AliTPCCalROC::GetNeighbourhood - PRIVATE
<span class="lineNum">     874 </span>            :   /// in this function the window for LocalFit is determined
<span class="lineNum">     875 </span>            : 
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :   rowArray = new TArrayI((2*rRadius+1)*(2*pRadius+1));</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :   padArray = new TArrayI((2*rRadius+1)*(2*pRadius+1));</span>
<span class="lineNum">     878 </span>            :   
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :   Int_t rmin = row - rRadius;</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :   UInt_t rmax = row + rRadius;</span>
<span class="lineNum">     881 </span>            :   
<span class="lineNum">     882 </span>            :   // if window goes out of ROC
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :   if (rmin &lt; 0) {</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     rmax = rmax - rmin;</span>
<span class="lineNum">     885 </span>            :     rmin = 0;
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :   if (rmax &gt;= GetNrows()) {</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :     rmin = rmin - (rmax - GetNrows()+1);</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :     rmax = GetNrows() - 1;</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :       if (rmin  &lt; 0 ) rmin = 0; // if the window is bigger than the ROC</span>
<span class="lineNum">     891 </span>            :   }
<span class="lineNum">     892 </span>            :   
<span class="lineNum">     893 </span>            :   Int_t pmin, pmax;
<span class="lineNum">     894 </span>            :   Int_t i = 0;
<span class="lineNum">     895 </span>            :   
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :   for (UInt_t r = rmin; r &lt;= rmax; r++) {</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :     pmin = pad - pRadius;</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :     pmax = pad + pRadius;</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :     if (pmin &lt; 0) {</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :       pmax = pmax - pmin;</span>
<span class="lineNum">     901 </span>            :       pmin = 0;
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :     if (pmax &gt;= (Int_t)GetNPads(r)) {</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :       pmin = pmin - (pmax - GetNPads(r)+1);</span>
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :       pmax = GetNPads(r) - 1;</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :       if (pmin  &lt; 0 ) pmin = 0; // if the window is bigger than the ROC</span>
<span class="lineNum">     907 </span>            :     }
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :     for (Int_t p = pmin; p &lt;= pmax; p++) {</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :       (*rowArray)[i] = r;</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :       (*padArray)[i] = p;</span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :       i++;</span>
<span class="lineNum">     912 </span>            :     }
<span class="lineNum">     913 </span>            :   }
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :   for (Int_t j = i; j &lt; rowArray-&gt;GetSize(); j++){  // unused padArray-entries, in the case that the window is bigger than the ROC</span>
<span class="lineNum">     915 </span>            :     //std::cout &lt;&lt; &quot;trying to write -1&quot; &lt;&lt; std::endl;
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :     (*rowArray)[j] = -1;</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :     (*padArray)[j] = -1;</span>
<span class="lineNum">     918 </span>            :     //std::cout &lt;&lt; &quot;writing -1&quot; &lt;&lt; std::endl;
<span class="lineNum">     919 </span>            :   }
<span class="lineNum">     920 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     921 </span>            : 
<a name="922"><span class="lineNum">     922 </span>            : </a>
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span>            : void AliTPCCalROC::GlobalFit(const AliTPCCalROC* ROCoutliers, Bool_t robust, TVectorD &amp;fitParam, TMatrixD &amp;covMatrix, Float_t &amp; chi2, Int_t fitType, Double_t chi2Threshold, Double_t robustFraction, Double_t err, EPadType padType){
<span class="lineNum">     925 </span>            :   /// Makes a  GlobalFit for the given sector and return fit-parameters, covariance and chi2
<span class="lineNum">     926 </span>            :   /// update of GlobalFit in 2015 to have different gain in OROC medium and long pads
<span class="lineNum">     927 </span>            :   /// The origin of the fit function is the center of the ROC!
<span class="lineNum">     928 </span>            :   /// fitType == 0: fit plane function
<span class="lineNum">     929 </span>            :   /// fitType == 1: fit parabolic function
<span class="lineNum">     930 </span>            :   /// ROCoutliers - pads with value !=0 are not used in fitting procedure
<span class="lineNum">     931 </span>            :   /// chi2Threshold: Threshold for chi2 when EvalRobust is called
<span class="lineNum">     932 </span>            :   /// robustFraction: Fraction of data that will be used in EvalRobust
<span class="lineNum">     933 </span>            :   /// err: error of the data points
<span class="lineNum">     934 </span>            : 
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :   if(fSector&lt;36) padType=kAll;</span>
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span>            :   TLinearFitter* fitterG = 0;
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :   Double_t xx[6];</span>
<span class="lineNum">     939 </span>            :   
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :   if (fitType  == 1) {</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :     fitterG = new TLinearFitter (6,&quot;x0++x1++x2++x3++x4++x5&quot;);</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :     fitParam.ResizeTo(6);</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :     covMatrix.ResizeTo(6,6);</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :     fitterG = new TLinearFitter(3,&quot;x0++x1++x2&quot;);</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :     fitParam.ResizeTo(3);</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :     covMatrix.ResizeTo(3,3);</span>
<span class="lineNum">     948 </span>            :   }
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :   fitterG-&gt;StoreData(kTRUE);   </span>
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :   fitterG-&gt;ClearPoints();</span>
<span class="lineNum">     951 </span>            :   Int_t    npoints=0;
<span class="lineNum">     952 </span>            :   
<span class="lineNum">     953 </span>            :   Float_t dlx, dly;
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :   Float_t centerPad[3] = {0};</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :   Float_t localXY[3] = {0};</span>
<span class="lineNum">     956 </span>            :   
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :   AliTPCROC* tpcROCinstance = AliTPCROC::Instance();</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :   if(padType==kAll)</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :     tpcROCinstance-&gt;GetPositionLocal(fSector, GetNrows()/2, GetNPads(GetNrows()/2)/2, centerPad);  // calculate center of ROC </span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :   else if(padType==kOROCmedium)  </span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :     tpcROCinstance-&gt;GetPositionLocal(fSector, 64/2, GetNPads(64/2)/2, centerPad);  // calculate center of ROC medium pads</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :   else if(padType==kOROClong)</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :     tpcROCinstance-&gt;GetPositionLocal(fSector, (GetNrows()-64)/2+64, GetNPads((GetNrows()-64)/2+64)/2, centerPad);  // calculate center of ROC long pads</span>
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span>            :   UInt_t irowMin = 0;
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :   UInt_t irowMax = GetNrows();</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :   if(padType==kOROCmedium) irowMax = 64;</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :   else if(padType==kOROClong) irowMin = 64;</span>
<span class="lineNum">     969 </span>            : 
<span class="lineNum">     970 </span>            :   // loop over all channels and read data into fitterG
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :   for (UInt_t irow = irowMin; irow &lt; irowMax; irow++) {</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :     for (UInt_t ipad = 0; ipad &lt; GetNPads(irow); ipad++) {</span>
<span class="lineNum">     973 </span>            :       // fill fitterG
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :       if (ROCoutliers &amp;&amp; ROCoutliers-&gt;GetValue(irow, ipad) != 0) continue;</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :       tpcROCinstance-&gt;GetPositionLocal(fSector, irow, ipad, localXY);   // calculate position localXY by pad and row number</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :       dlx = localXY[0] - centerPad[0];</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :       dly = localXY[1] - centerPad[1];</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :       xx[0] = 1;</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :       xx[1] = dlx;</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :       xx[2] = dly;</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :       xx[3] = dlx*dlx;</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :       xx[4] = dly*dly;</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :       xx[5] = dlx*dly;</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :       npoints++;</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :       fitterG-&gt;AddPoint(xx, GetValue(irow, ipad), err);</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     987 </span>            :   }
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :   if(npoints&gt;10) { // make sure there is something to fit</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :     fitterG-&gt;Eval();</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :     fitterG-&gt;GetParameters(fitParam);</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :     fitterG-&gt;GetCovarianceMatrix(covMatrix);</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :     if (fitType == 1)</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :       chi2 = fitterG-&gt;GetChisquare()/(npoints-6.);</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :     else chi2 = fitterG-&gt;GetChisquare()/(npoints-3.);</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :     if (robust &amp;&amp; chi2 &gt; chi2Threshold) {</span>
<span class="lineNum">     996 </span>            :       //    std::cout &lt;&lt; &quot;robust fitter called... &quot; &lt;&lt; std::endl;
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :       fitterG-&gt;EvalRobust(robustFraction);</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :       fitterG-&gt;GetParameters(fitParam);</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1000 </span>            :   } else {
<span class="lineNum">    1001 </span>            :     // set parameteres to 0
<span class="lineNum">    1002 </span>            :     Int_t nParameters = 3;
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :     if (fitType  == 1)</span>
<span class="lineNum">    1004 </span>            :       nParameters = 6;
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :     for(Int_t i = 0; i &lt; nParameters; i++)</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :       fitParam[i] = 0;</span>
<span class="lineNum">    1008 </span>            :   }
<span class="lineNum">    1009 </span>            :   
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :   delete fitterG;</span>
<a name="1011"><span class="lineNum">    1011 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1012 </span>            : 
<span class="lineNum">    1013 </span>            : AliTPCCalROC* AliTPCCalROC::CreateGlobalFitCalROC(TVectorD &amp;fitParam, Int_t sector, EPadType padType, AliTPCCalROC *oldTPCCalROC ){
<span class="lineNum">    1014 </span>            :   /// Create ROC with global fit parameters
<span class="lineNum">    1015 </span>            :   /// The origin of the fit function is the center of the ROC!
<span class="lineNum">    1016 </span>            :   /// loop over all channels, write fit values into new ROC and return it
<span class="lineNum">    1017 </span>            :   /// In 2015 different gain in medium and long pads 
<span class="lineNum">    1018 </span>            :   /// New CalROC is created for medium pads.
<span class="lineNum">    1019 </span>            :   /// For long pads oldTPCCalROC already contains values for medium pads.
<span class="lineNum">    1020 </span>            : 
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :   if(sector&lt;36) padType=kAll;</span>
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span>            :   Float_t dlx, dly;
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :   Float_t centerPad[3] = {0};</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :   Float_t localXY[3] = {0};</span>
<span class="lineNum">    1026 </span>            :   AliTPCCalROC * xROCfitted = NULL;
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :   if(oldTPCCalROC!=0 &amp;&amp; padType!=kAll) xROCfitted = oldTPCCalROC;</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :   else xROCfitted = new AliTPCCalROC(sector);</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :   AliTPCROC* tpcROCinstance = AliTPCROC::Instance();</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :   if(padType==kAll)</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :     tpcROCinstance-&gt;GetPositionLocal(sector, xROCfitted-&gt;GetNrows()/2, xROCfitted-&gt;GetNPads(xROCfitted-&gt;GetNrows()/2)/2, centerPad);  // calculate center of ROC </span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :   else if(padType==kOROCmedium)</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :     tpcROCinstance-&gt;GetPositionLocal(sector, 64/2, xROCfitted-&gt;GetNPads(64/2)/2, centerPad);  // calculate center of ROC medium pads </span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :   else if(padType==kOROClong)</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :     tpcROCinstance-&gt;GetPositionLocal(sector, (xROCfitted-&gt;GetNrows()-64)/2+64, xROCfitted-&gt;GetNPads((xROCfitted-&gt;GetNrows()-64)/2+64)/2, centerPad);  // calculate center of ROC long pads </span>
<span class="lineNum">    1036 </span>            : 
<span class="lineNum">    1037 </span>            :   UInt_t irowMin = 0;
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :   UInt_t irowMax = xROCfitted-&gt;GetNrows();</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :   if(padType==kOROCmedium) irowMax = 64;</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :   else if(padType==kOROClong) irowMin = 64;</span>
<span class="lineNum">    1041 </span>            : 
<span class="lineNum">    1042 </span>            :   Int_t fitType = 1;
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :   if (fitParam.GetNoElements() == 6) fitType = 1;</span>
<span class="lineNum">    1044 </span>            :   else fitType = 0;
<span class="lineNum">    1045 </span>            :   Double_t value = 0;
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :   if (fitType == 1) { // parabolic fit</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :     for (UInt_t irow = irowMin; irow &lt; irowMax; irow++) {</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :       for (UInt_t ipad = 0; ipad &lt; xROCfitted-&gt;GetNPads(irow); ipad++) {</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :         tpcROCinstance-&gt;GetPositionLocal(sector, irow, ipad, localXY);   // calculate position localXY by pad and row number</span>
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :         dlx = localXY[0] - centerPad[0];</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :         dly = localXY[1] - centerPad[1];</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :         value = fitParam[0] + fitParam[1]*dlx + fitParam[2]*dly + fitParam[3]*dlx*dlx + fitParam[4]*dly*dly + fitParam[5]*dlx*dly;</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :         xROCfitted-&gt;SetValue(irow, ipad, value);</span>
<span class="lineNum">    1054 </span>            :       }
<span class="lineNum">    1055 </span>            :     }   
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1057 </span>            :   else {  // linear fit
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :     for (UInt_t irow = irowMin; irow &lt; irowMax; irow++) {</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :       for (UInt_t ipad = 0; ipad &lt; xROCfitted-&gt;GetNPads(irow); ipad++) {</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :         tpcROCinstance-&gt;GetPositionLocal(sector, irow, ipad, localXY);   // calculate position localXY by pad and row number</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :         dlx = localXY[0] - centerPad[0];</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :         dly = localXY[1] - centerPad[1];</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :         value = fitParam[0] + fitParam[1]*dlx + fitParam[2]*dly;</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :         xROCfitted-&gt;SetValue(irow, ipad, value);</span>
<span class="lineNum">    1065 </span>            :       }
<span class="lineNum">    1066 </span>            :     }   
<span class="lineNum">    1067 </span>            :   }
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :   return xROCfitted;</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1070 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
