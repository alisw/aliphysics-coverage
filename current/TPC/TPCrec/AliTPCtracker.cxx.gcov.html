<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - TPC/TPCrec/AliTPCtracker.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">TPC/TPCrec</a> - AliTPCtracker.cxx<span style="font-size: 80%;"> (source / <a href="AliTPCtracker.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">2644</td>
            <td class="headerCovTableEntry">5462</td>
            <td class="headerCovTableEntryLo">48.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">71</td>
            <td class="headerCovTableEntry">119</td>
            <td class="headerCovTableEntryLo">59.7 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : //-------------------------------------------------------
<span class="lineNum">      18 </span>            : //          Implementation of the TPC tracker
<span class="lineNum">      19 </span>            : //
<span class="lineNum">      20 </span>            : //   Origin: Marian Ivanov   Marian.Ivanov@cern.ch
<span class="lineNum">      21 </span>            : // 
<span class="lineNum">      22 </span>            : //  AliTPC parallel tracker
<span class="lineNum">      23 </span>            : //
<span class="lineNum">      24 </span>            : //  The track fitting is based on Kalman filtering approach
<span class="lineNum">      25 </span>            : //  The track finding steps:
<span class="lineNum">      26 </span>            : //      1. Seeding - with and without vertex constraint
<span class="lineNum">      27 </span>            : //                 - seeding with vertex constain done at first n^2 proble
<span class="lineNum">      28 </span>            : //                 - seeding without vertex constraint n^3 problem
<span class="lineNum">      29 </span>            : //      2. Tracking - follow prolongation road - find cluster - update kalman track
<span class="lineNum">      30 </span>            : //  The seeding and tracking is repeated several times, in different seeding region.
<span class="lineNum">      31 </span>            : //  This approach enables to find the track which cannot be seeded in some region of TPC
<span class="lineNum">      32 </span>            : //  This can happen because of low momenta (track do not reach outer radius), or track is currently in the ded region between sectors, or the track is for the moment overlapped with other track (seed quality is poor) ...
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : //  With this approach we reach almost 100 % efficiency also for high occupancy events.
<span class="lineNum">      35 </span>            : //  (If the seeding efficiency in a region is about 90 % than with logical or of several 
<span class="lineNum">      36 </span>            : //  regions we will reach 100% (in theory - supposing independence) 
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : //  Repeating several seeding - tracking procedures some of the tracks can be find 
<span class="lineNum">      39 </span>            : //  several times. 
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : //  The procedures to remove multi find tacks are impremented:
<span class="lineNum">      42 </span>            : //  RemoveUsed2 - fast procedure n problem - 
<span class="lineNum">      43 </span>            : //                 Algorithm - Sorting tracks according quality
<span class="lineNum">      44 </span>            : //                             remove tracks with some shared fraction 
<span class="lineNum">      45 </span>            : //                             Sharing in respect to all tacks 
<span class="lineNum">      46 </span>            : //                             Signing clusters in gold region
<span class="lineNum">      47 </span>            : //  FindSplitted - slower algorithm n^2
<span class="lineNum">      48 </span>            : //                 Sort the tracks according quality
<span class="lineNum">      49 </span>            : //                 Loop over pair of tracks
<span class="lineNum">      50 </span>            : //                 If overlap with other track bigger than threshold - remove track
<span class="lineNum">      51 </span>            : //  
<span class="lineNum">      52 </span>            : //  FindCurling  - Finds the pair of tracks which are curling
<span class="lineNum">      53 </span>            : //               - About 10% of tracks can be find with this procedure
<span class="lineNum">      54 </span>            : //                 The combinatorial background is too big to be used in High 
<span class="lineNum">      55 </span>            : //                  multiplicity environment 
<span class="lineNum">      56 </span>            : //               - n^2 problem - Slow procedure - currently it is disabled because of 
<span class="lineNum">      57 </span>            : //                  low efficiency
<span class="lineNum">      58 </span>            : //                 
<span class="lineNum">      59 </span>            : //  The number of splitted tracks can be reduced disabling the sharing of the cluster.
<span class="lineNum">      60 </span>            : //  tpcRecoParam-&gt; SetClusterSharing(kFALSE);
<span class="lineNum">      61 </span>            : //  IT IS HIGHLY non recomended to use it in high flux enviroonment
<span class="lineNum">      62 </span>            : //  Even using this switch some tracks can be found more than once 
<span class="lineNum">      63 </span>            : //  (because of multiple seeding and low quality tracks which will not cross full chamber)
<span class="lineNum">      64 </span>            : //                          
<span class="lineNum">      65 </span>            : //
<span class="lineNum">      66 </span>            : // The tracker itself can be debugged  - the information about tracks can be stored in several // phases of the reconstruction
<span class="lineNum">      67 </span>            : // To enable storage of the TPC tracks in the ESD friend track
<span class="lineNum">      68 </span>            : // use AliTPCReconstructor::SetStreamLevel(n); 
<span class="lineNum">      69 </span>            : //
<span class="lineNum">      70 </span>            : // The debug level -  different procedure produce tree for numerical debugging of code and data (see comments foEStreamFlags in AliTPCtracker.h  )
<span class="lineNum">      71 </span>            : //
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            : //
<span class="lineNum">      74 </span>            : // Adding systematic errors to the covariance:
<span class="lineNum">      75 </span>            : // 
<span class="lineNum">      76 </span>            : // The systematic errors due to the misalignment and miscalibration are added to the covariance matrix
<span class="lineNum">      77 </span>            : // of the tracks (not to the clusters as they are dependent):
<span class="lineNum">      78 </span>            : // The parameters form AliTPCRecoParam are used AliTPCRecoParam::GetSystematicError
<span class="lineNum">      79 </span>            : // The systematic errors are expressed there in RMS - position (cm), angle (rad), curvature (1/GeV)
<span class="lineNum">      80 </span>            : // The default values are 0. 
<span class="lineNum">      81 </span>            : //
<span class="lineNum">      82 </span>            : // The systematic errors are added to the covariance matrix in following places:
<span class="lineNum">      83 </span>            : //
<span class="lineNum">      84 </span>            : // 1. During fisrt itteration - AliTPCtracker::FillESD
<span class="lineNum">      85 </span>            : // 2. Second iteration - 
<span class="lineNum">      86 </span>            : //      2.a ITS-&gt;TPC   - AliTPCtracker::ReadSeeds 
<span class="lineNum">      87 </span>            : //      2.b TPC-&gt;TRD   - AliTPCtracker::PropagateBack
<span class="lineNum">      88 </span>            : // 3. Third iteration  -
<span class="lineNum">      89 </span>            : //      3.a TRD-&gt;TPC   - AliTPCtracker::ReadSeeds
<span class="lineNum">      90 </span>            : //      3.b TPC-&gt;ITS   - AliTPCtracker::RefitInward
<span class="lineNum">      91 </span>            : //
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span>            : /* $Id$ */
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span>            : #include &quot;Riostream.h&quot;
<span class="lineNum">      96 </span>            : #include &lt;TClonesArray.h&gt;
<span class="lineNum">      97 </span>            : #include &lt;TFile.h&gt;
<span class="lineNum">      98 </span>            : #include &lt;TObjArray.h&gt;
<span class="lineNum">      99 </span>            : #include &lt;TTree.h&gt;
<span class="lineNum">     100 </span>            : #include &lt;TMatrixD.h&gt;
<span class="lineNum">     101 </span>            : #include &lt;TGraphErrors.h&gt;
<span class="lineNum">     102 </span>            : #include &lt;TTimeStamp.h&gt;
<span class="lineNum">     103 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">     104 </span>            : #include &quot;AliComplexCluster.h&quot;
<span class="lineNum">     105 </span>            : #include &quot;AliESDEvent.h&quot;
<span class="lineNum">     106 </span>            : #include &quot;AliESDtrack.h&quot;
<span class="lineNum">     107 </span>            : #include &quot;AliESDVertex.h&quot;
<span class="lineNum">     108 </span>            : #include &quot;AliKink.h&quot;
<span class="lineNum">     109 </span>            : #include &quot;AliV0.h&quot;
<span class="lineNum">     110 </span>            : #include &quot;AliHelix.h&quot;
<span class="lineNum">     111 </span>            : #include &quot;AliRunLoader.h&quot;
<span class="lineNum">     112 </span>            : #include &quot;AliTPCClustersRow.h&quot;
<span class="lineNum">     113 </span>            : #include &quot;AliTPCParam.h&quot;
<span class="lineNum">     114 </span>            : #include &quot;AliTPCReconstructor.h&quot;
<span class="lineNum">     115 </span>            : #include &quot;AliTPCpolyTrack.h&quot;
<span class="lineNum">     116 </span>            : #include &quot;AliTPCreco.h&quot;
<span class="lineNum">     117 </span>            : //#include &quot;AliTPCseed.h&quot;
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span>            : #include &quot;AliTPCtrackerSector.h&quot; 
<span class="lineNum">     120 </span>            : #include &quot;AliTPCtracker.h&quot;
<span class="lineNum">     121 </span>            : #include &quot;TStopwatch.h&quot;
<span class="lineNum">     122 </span>            : #include &quot;AliTPCReconstructor.h&quot;
<span class="lineNum">     123 </span>            : #include &quot;AliAlignObj.h&quot;
<span class="lineNum">     124 </span>            : #include &quot;AliTrackPointArray.h&quot;
<span class="lineNum">     125 </span>            : #include &quot;TRandom.h&quot;
<span class="lineNum">     126 </span>            : #include &quot;AliTPCcalibDB.h&quot;
<span class="lineNum">     127 </span>            : #include &quot;AliTPCcalibDButil.h&quot;
<span class="lineNum">     128 </span>            : #include &quot;AliTPCTransform.h&quot;
<span class="lineNum">     129 </span>            : #include &quot;AliTPCClusterParam.h&quot;
<span class="lineNum">     130 </span>            : #include &quot;AliTPCdEdxInfo.h&quot;
<span class="lineNum">     131 </span>            : #include &quot;AliDCSSensorArray.h&quot;
<span class="lineNum">     132 </span>            : #include &quot;AliDCSSensor.h&quot;
<span class="lineNum">     133 </span>            : #include &quot;AliDAQ.h&quot;
<span class="lineNum">     134 </span>            : #include &quot;AliCosmicTracker.h&quot;
<span class="lineNum">     135 </span>            : #include &quot;AliTPCROC.h&quot;
<span class="lineNum">     136 </span>            : #include &quot;AliMathBase.h&quot;
<span class="lineNum">     137 </span>            : #include &lt;math.h&gt;
<span class="lineNum">     138 </span>            : //
<span class="lineNum">     139 </span>            : #include &quot;AliESDfriendTrack.h&quot;
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            : using std::cout;
<a name="142"><span class="lineNum">     142 </span>            : using std::cerr;</a>
<span class="lineNum">     143 </span>            : using std::endl;
<span class="lineNum">     144 </span><span class="lineCov">         16 : ClassImp(AliTPCtracker)</span>
<a name="145"><span class="lineNum">     145 </span>            : </a>
<span class="lineNum">     146 </span>            : //__________________________________________________________________
<span class="lineNum">     147 </span>            : AliTPCtracker::AliTPCtracker()
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :   :AliTracker(),</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :   fkNIS(0),</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :   fInnerSec(0),</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   fkNOS(0),</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :   fOuterSec(0),</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   fN(0),</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   fSectors(0),</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   fInput(0),</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   fOutput(0),</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   fSeedTree(0),</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   fTreeDebug(0),</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :   fEvent(0),</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :   fEventHLT(0),</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   fDebug(0),</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   fNewIO(kFALSE),</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :   fNtracks(0),</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :   fSeeds(0),</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   fIteration(0),</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :   fkParam(0),</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :   fDebugStreamer(0),</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :   fUseHLTClusters(4),</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :   fClExtraRoadY(0.),</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :   fClExtraRoadZ(0.), </span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :   fExtraClErrYZ2(0), </span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :   fExtraClErrY2(0),</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :   fExtraClErrZ2(0),</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :   fPrimaryDCAZCut(-1),</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :   fPrimaryDCAYCut(-1),</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :   fDisableSecondaries(kFALSE),</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :   fCrossTalkSignalArray(0),</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   fClPointersPool(0),</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :   fClPointersPoolPtr(0),</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   fClPointersPoolSize(0),</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :   fSeedsPool(0),</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   fHelixPool(0),</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   fETPPool(0),</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   fFreeSeedsID(500),</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   fNFreeSeeds(0),</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   fLastSeedID(-1),</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   fAccountDistortions(0)</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     189 </span>            :   //
<span class="lineNum">     190 </span>            :   // default constructor
<span class="lineNum">     191 </span>            :   //
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :   for (Int_t irow=0; irow&lt;200; irow++){</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :     fXRow[irow]=0;</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :     fYMax[irow]=0;</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :     fPadLength[irow]=0;</span>
<span class="lineNum">     196 </span>            :   }
<span class="lineNum">     197 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     198 </span>            : //_____________________________________________________________________
<span class="lineNum">     199 </span>            : 
<a name="200"><span class="lineNum">     200 </span>            : </a>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            : Int_t AliTPCtracker::UpdateTrack(AliTPCseed * track, Int_t accept){
<span class="lineNum">     203 </span>            :   //
<span class="lineNum">     204 </span>            :   //update track information using current cluster - track-&gt;fCurrentCluster
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span><span class="lineCov">     206720 :   AliTPCclusterMI* c =track-&gt;GetCurrentCluster();</span>
<span class="lineNum">     208 </span><span class="lineCov">     206720 :   if (accept &gt; 0) //sign not accepted clusters</span>
<span class="lineNum">     209 </span><span class="lineCov">     107472 :     track-&gt;SetCurrentClusterIndex1(track-&gt;GetCurrentClusterIndex1() | 0x8000);  </span>
<span class="lineNum">     210 </span>            :   else // unsign accpeted clusters
<span class="lineNum">     211 </span><span class="lineCov">      99248 :     track-&gt;SetCurrentClusterIndex1(track-&gt;GetCurrentClusterIndex1() &amp; 0xffff7fff);  </span>
<span class="lineNum">     212 </span><span class="lineCov">     103360 :   UInt_t i = track-&gt;GetCurrentClusterIndex1();</span>
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span><span class="lineCov">     103360 :   Int_t sec=(i&amp;0xff000000)&gt;&gt;24; </span>
<span class="lineNum">     215 </span><span class="lineCov">     103360 :   Int_t row = (i&amp;0x00ff0000)&gt;&gt;16; </span>
<span class="lineNum">     216 </span><span class="lineCov">     167432 :   if (sec&gt;=fkParam-&gt;GetNInnerSector()) row += fkParam-&gt;GetNRowLow(); </span>
<span class="lineNum">     217 </span><span class="lineCov">     103360 :   track-&gt;SetRow(row);</span>
<span class="lineNum">     218 </span><span class="lineCov">     103360 :   track-&gt;SetSector(sec);</span>
<span class="lineNum">     219 </span><span class="lineCov">     103360 :   track-&gt;SetClusterIndex2(row, i);  </span>
<span class="lineNum">     220 </span>            :   //track-&gt;fFirstPoint = row;
<span class="lineNum">     221 </span>            :   //if ( track-&gt;fLastPoint&lt;row) track-&gt;fLastPoint =row;
<span class="lineNum">     222 </span>            :   //  if (track-&gt;fRow&lt;0 || track-&gt;fRow&gt;=kMaxRow) {
<span class="lineNum">     223 </span>            :   //  printf(&quot;problem\n&quot;);
<span class="lineNum">     224 </span>            :   //}
<span class="lineNum">     225 </span><span class="lineCov">     103360 :   if (track-&gt;GetFirstPoint()&gt;row) </span>
<span class="lineNum">     226 </span><span class="lineCov">      38460 :     track-&gt;SetFirstPoint(row);</span>
<span class="lineNum">     227 </span><span class="lineCov">     103360 :   if (track-&gt;GetLastPoint()&lt;row) </span>
<span class="lineNum">     228 </span><span class="lineCov">      17776 :     track-&gt;SetLastPoint(row);</span>
<span class="lineNum">     229 </span>            :   
<span class="lineNum">     230 </span><span class="lineCov">     103360 :   Double_t angle2 = track-&gt;GetSnp()*track-&gt;GetSnp();</span>
<span class="lineNum">     231 </span>            :   //
<span class="lineNum">     232 </span>            :   //SET NEW Track Point
<span class="lineNum">     233 </span>            :   //
<span class="lineNum">     234 </span><span class="lineCov">     103360 :   if (angle2&lt;1) //PH sometimes angle2 is very big. To be investigated...</span>
<span class="lineNum">     235 </span>            :   {
<span class="lineNum">     236 </span><span class="lineCov">     103360 :     angle2 = TMath::Sqrt(angle2/(1-angle2));</span>
<span class="lineNum">     237 </span><span class="lineCov">     103360 :     AliTPCTrackerPoints::Point   &amp;point =*((AliTPCTrackerPoints::Point*)track-&gt;GetTrackPoint(row));</span>
<span class="lineNum">     238 </span>            :     //
<span class="lineNum">     239 </span><span class="lineCov">     103360 :     point.SetSigmaY(c-&gt;GetSigmaY2()/track-&gt;GetCurrentSigmaY2());</span>
<span class="lineNum">     240 </span><span class="lineCov">     103360 :     point.SetSigmaZ(c-&gt;GetSigmaZ2()/track-&gt;GetCurrentSigmaZ2());</span>
<span class="lineNum">     241 </span><span class="lineCov">     103360 :     point.SetErrY(sqrt(track-&gt;GetErrorY2()));</span>
<span class="lineNum">     242 </span><span class="lineCov">     103360 :     point.SetErrZ(sqrt(track-&gt;GetErrorZ2()));</span>
<span class="lineNum">     243 </span>            :     //
<span class="lineNum">     244 </span><span class="lineCov">     103360 :     point.SetX(track-&gt;GetX());</span>
<span class="lineNum">     245 </span><span class="lineCov">     103360 :     point.SetY(track-&gt;GetY());</span>
<span class="lineNum">     246 </span><span class="lineCov">     103360 :     point.SetZ(track-&gt;GetZ());</span>
<span class="lineNum">     247 </span><span class="lineCov">     103360 :     point.SetAngleY(angle2);</span>
<span class="lineNum">     248 </span><span class="lineCov">     103360 :     point.SetAngleZ(track-&gt;GetTgl());</span>
<span class="lineNum">     249 </span><span class="lineCov">     103360 :     if (track-&gt;IsShared(row)){</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :       track-&gt;SetErrorY2(track-&gt;GetErrorY2()*4);</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :       track-&gt;SetErrorZ2(track-&gt;GetErrorZ2()*4);</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     253 </span><span class="lineCov">     103360 :   }  </span>
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineCov">     107472 :   if (accept&gt;0) return 0;</span>
<span class="lineNum">     256 </span><span class="lineCov">      99248 :   Double_t chi2 = track-&gt;GetPredictedChi2(track-&gt;GetCurrentCluster());</span>
<span class="lineNum">     257 </span>            :   //
<span class="lineNum">     258 </span>            : //   track-&gt;SetErrorY2(track-&gt;GetErrorY2()*1.3);
<span class="lineNum">     259 </span>            : //   track-&gt;SetErrorY2(track-&gt;GetErrorY2()+0.01);    
<span class="lineNum">     260 </span>            : //   track-&gt;SetErrorZ2(track-&gt;GetErrorZ2()*1.3);   
<span class="lineNum">     261 </span>            : //   track-&gt;SetErrorZ2(track-&gt;GetErrorZ2()+0.005);      
<span class="lineNum">     262 </span>            :     //}
<span class="lineNum">     263 </span><span class="lineCov">      99248 :   if (track-&gt;GetNumberOfClusters()%20==0){</span>
<span class="lineNum">     264 </span>            :     //    if (track-&gt;fHelixIn){
<span class="lineNum">     265 </span>            :     //  TClonesArray &amp; larr = *(track-&gt;fHelixIn);    
<span class="lineNum">     266 </span>            :     //  Int_t ihelix = larr.GetEntriesFast();
<span class="lineNum">     267 </span>            :     //  new(larr[ihelix]) AliHelix(*track) ;    
<span class="lineNum">     268 </span>            :     //}
<span class="lineNum">     269 </span>            :   }
<span class="lineNum">     270 </span><span class="lineCov">      99248 :   if (AliTPCReconstructor::StreamLevel()&amp;kStreamUpdateTrack) {</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     Int_t event = (fEvent==NULL)? 0: fEvent-&gt;GetEventNumberInFile();</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     AliExternalTrackParam param(*track);</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :     cstream&lt;&lt;&quot;UpdateTrack&quot;&lt;&lt;</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :       &quot;cl.=&quot;&lt;&lt;c&lt;&lt;</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :       &quot;event=&quot;&lt;&lt;event&lt;&lt;</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :       &quot;track.=&quot;&lt;&lt;&amp;param&lt;&lt;</span>
<span class="lineNum">     278 </span>            :       &quot;\n&quot;;
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     280 </span><span class="lineCov">      99248 :   track-&gt;SetNoCluster(0);</span>
<span class="lineNum">     281 </span><span class="lineCov">      99248 :   return track-&gt;Update(c,chi2,i);</span>
<span class="lineNum">     282 </span><span class="lineCov">     103360 : }</span>
<span class="lineNum">     283 </span>            : 
<a name="284"><span class="lineNum">     284 </span>            : </a>
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            : Int_t AliTPCtracker::AcceptCluster(AliTPCseed * seed, AliTPCclusterMI * cluster)
<span class="lineNum">     287 </span>            : {
<span class="lineNum">     288 </span>            :   //
<span class="lineNum">     289 </span>            :   // decide according desired precision to accept given 
<span class="lineNum">     290 </span>            :   // cluster for tracking
<span class="lineNum">     291 </span><span class="lineCov">     209276 :   Double_t  yt = seed-&gt;GetY(),zt = seed-&gt;GetZ();</span>
<span class="lineNum">     292 </span>            :   // RS: use propagation only if the seed in far from the cluster
<span class="lineNum">     293 </span>            :   const double kTolerance = 10e-4; // assume track is at cluster X if X-distance below this
<span class="lineNum">     294 </span><span class="lineCov">     175082 :   if (TMath::Abs(seed-&gt;GetX()-cluster-&gt;GetX())&gt;kTolerance) seed-&gt;GetProlongation(cluster-&gt;GetX(),yt,zt); </span>
<span class="lineNum">     295 </span><span class="lineCov">     104638 :   Double_t sy2=0;//ErrY2(seed,cluster);</span>
<span class="lineNum">     296 </span><span class="lineCov">     104638 :   Double_t sz2=0;//ErrZ2(seed,cluster);</span>
<span class="lineNum">     297 </span><span class="lineCov">     104638 :   ErrY2Z2(seed,cluster,sy2,sz2);</span>
<span class="lineNum">     298 </span>            :   
<span class="lineNum">     299 </span><span class="lineCov">     104638 :   Double_t sdistancey2 = sy2+seed-&gt;GetSigmaY2();</span>
<span class="lineNum">     300 </span><span class="lineCov">     104638 :   Double_t sdistancez2 = sz2+seed-&gt;GetSigmaZ2();</span>
<span class="lineNum">     301 </span><span class="lineCov">     104638 :   Double_t dy=seed-&gt;GetCurrentCluster()-&gt;GetY()-yt;</span>
<span class="lineNum">     302 </span><span class="lineCov">     104638 :   Double_t dz=seed-&gt;GetCurrentCluster()-&gt;GetZ()-zt;</span>
<span class="lineNum">     303 </span><span class="lineCov">     104638 :   Double_t rdistancey2 = dy*dy/sdistancey2;</span>
<span class="lineNum">     304 </span><span class="lineCov">     104638 :   Double_t rdistancez2 = dz*dz/sdistancez2;</span>
<span class="lineNum">     305 </span>            :   
<span class="lineNum">     306 </span><span class="lineCov">     104638 :   Double_t rdistance2  = rdistancey2+rdistancez2;</span>
<span class="lineNum">     307 </span>            :   //Int_t  accept =0;
<span class="lineNum">     308 </span>            :   
<span class="lineNum">     309 </span><span class="lineCov">     104638 :   if (AliTPCReconstructor::StreamLevel()&gt;2 &amp;&amp; ( (fIteration&gt;0)|| (seed-&gt;GetNumberOfClusters()&gt;20))) {</span>
<span class="lineNum">     310 </span>            :     //  if (AliTPCReconstructor::StreamLevel()&gt;2 &amp;&amp; seed-&gt;GetNumberOfClusters()&gt;20) {
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :     Float_t rmsy2 = seed-&gt;GetCurrentSigmaY2();</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :     Float_t rmsz2 = seed-&gt;GetCurrentSigmaZ2();</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :     Float_t rmsy2p30 = seed-&gt;GetCMeanSigmaY2p30();</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     Float_t rmsz2p30 = seed-&gt;GetCMeanSigmaZ2p30();</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     Float_t rmsy2p30R  = seed-&gt;GetCMeanSigmaY2p30R();</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :     Float_t rmsz2p30R  = seed-&gt;GetCMeanSigmaZ2p30R();</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     AliExternalTrackParam param(*seed);</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :     static TVectorD gcl(3),gtr(3);</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     Float_t gclf[3];</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     param.GetXYZ(gcl.GetMatrixArray());</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     cluster-&gt;GetGlobalXYZ(gclf);</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :     gcl[0]=gclf[0];    gcl[1]=gclf[1];    gcl[2]=gclf[2];</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :     Int_t nclSeed=seed-&gt;GetNumberOfClusters();</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :     int seedType = seed-&gt;GetSeedType();</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     if (AliTPCReconstructor::StreamLevel()&amp;kStreamErrParam) { // flag:stream in debug mode cluster and track extrapolation at given row together with error nad shape estimate</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :       Int_t eventNr = fEvent-&gt;GetEventNumberInFile();</span>
<span class="lineNum">     327 </span>            :         
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     (*fDebugStreamer)&lt;&lt;&quot;ErrParam&quot;&lt;&lt;</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       &quot;iter=&quot;&lt;&lt;fIteration&lt;&lt;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :       &quot;eventNr=&quot;&lt;&lt;eventNr&lt;&lt;</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :       &quot;Cl.=&quot;&lt;&lt;cluster&lt;&lt;</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :       &quot;nclSeed=&quot;&lt;&lt;nclSeed&lt;&lt;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :       &quot;seedType=&quot;&lt;&lt;seedType&lt;&lt;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :       &quot;T.=&quot;&lt;&lt;&amp;param&lt;&lt;</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       &quot;dy=&quot;&lt;&lt;dy&lt;&lt;</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :       &quot;dz=&quot;&lt;&lt;dz&lt;&lt;</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :       &quot;yt=&quot;&lt;&lt;yt&lt;&lt;</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :       &quot;zt=&quot;&lt;&lt;zt&lt;&lt;</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :       &quot;gcl.=&quot;&lt;&lt;&amp;gcl&lt;&lt;</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :       &quot;gtr.=&quot;&lt;&lt;&amp;gtr&lt;&lt;</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       &quot;erry2=&quot;&lt;&lt;sy2&lt;&lt;</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :       &quot;errz2=&quot;&lt;&lt;sz2&lt;&lt;</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :       &quot;rmsy2=&quot;&lt;&lt;rmsy2&lt;&lt;</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :       &quot;rmsz2=&quot;&lt;&lt;rmsz2&lt;&lt;   </span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :       &quot;rmsy2p30=&quot;&lt;&lt;rmsy2p30&lt;&lt;</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :       &quot;rmsz2p30=&quot;&lt;&lt;rmsz2p30&lt;&lt;     </span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :       &quot;rmsy2p30R=&quot;&lt;&lt;rmsy2p30R&lt;&lt;</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :       &quot;rmsz2p30R=&quot;&lt;&lt;rmsz2p30R&lt;&lt;   </span>
<span class="lineNum">     349 </span>            :       // normalize distance - 
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :       &quot;rdisty=&quot;&lt;&lt;rdistancey2&lt;&lt;</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :       &quot;rdistz=&quot;&lt;&lt;rdistancez2&lt;&lt;</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :       &quot;rdist=&quot;&lt;&lt;rdistance2&lt;&lt; //       </span>
<span class="lineNum">     353 </span>            :       &quot;\n&quot;;
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     356 </span>            :   //return 0;  // temporary
<span class="lineNum">     357 </span><span class="lineCov">     105918 :   if (rdistance2&gt;32) return 3;</span>
<span class="lineNum">     358 </span>            :   
<span class="lineNum">     359 </span>            :   
<span class="lineNum">     360 </span><span class="lineCov">     107702 :   if ((rdistancey2&gt;9. || rdistancez2&gt;9.) &amp;&amp; cluster-&gt;GetType()==0)  </span>
<span class="lineNum">     361 </span><span class="lineCov">       3832 :     return 2;  //suspisiouce - will be changed</span>
<span class="lineNum">     362 </span>            :   
<span class="lineNum">     363 </span><span class="lineCov">     103838 :   if ((rdistancey2&gt;6.25 || rdistancez2&gt;6.25) &amp;&amp; cluster-&gt;GetType()&gt;0)  </span>
<span class="lineNum">     364 </span>            :     // strict cut on overlaped cluster
<span class="lineNum">     365 </span><span class="lineCov">        662 :     return  2;  //suspisiouce - will be changed</span>
<span class="lineNum">     366 </span>            :   
<span class="lineNum">     367 </span><span class="lineCov">     130849 :   if ( (rdistancey2&gt;1. || rdistancez2&gt;6.25 ) </span>
<span class="lineNum">     368 </span><span class="lineCov">      31985 :        &amp;&amp; cluster-&gt;GetType()&lt;0){</span>
<span class="lineNum">     369 </span><span class="lineCov">         54 :     seed-&gt;SetNFoundable(seed-&gt;GetNFoundable()-1);</span>
<span class="lineNum">     370 </span><span class="lineCov">         54 :     return 2;    </span>
<span class="lineNum">     371 </span>            :   }
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span><span class="lineCov">     197620 :   if (fUseHLTClusters == 3 || fUseHLTClusters == 4) {</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :     if (fIteration==2){</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :       if(!AliTPCReconstructor::GetRecoParam()-&gt;GetUseHLTOnePadCluster()) {</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :         if (TMath::Abs(cluster-&gt;GetSigmaY2()) &lt; kAlmost0)</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :           return 2;</span>
<span class="lineNum">     378 </span>            :       }
<span class="lineNum">     379 </span>            :     }
<span class="lineNum">     380 </span>            :   }
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineCov">      98810 :   return 0;</span>
<span class="lineNum">     383 </span><span class="lineCov">     104638 : }</span>
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span>            : 
<a name="388"><span class="lineNum">     388 </span>            : </a>
<span class="lineNum">     389 </span>            : //_____________________________________________________________________________
<span class="lineNum">     390 </span>            : AliTPCtracker::AliTPCtracker(const AliTPCParam *par): 
<span class="lineNum">     391 </span><span class="lineCov">          2 :   AliTracker(), </span>
<span class="lineNum">     392 </span><span class="lineCov">          2 :   fkNIS(par-&gt;GetNInnerSector()/2),</span>
<span class="lineNum">     393 </span><span class="lineCov">          2 :   fInnerSec(0),</span>
<span class="lineNum">     394 </span><span class="lineCov">          2 :   fkNOS(par-&gt;GetNOuterSector()/2),</span>
<span class="lineNum">     395 </span><span class="lineCov">          2 :   fOuterSec(0),</span>
<span class="lineNum">     396 </span><span class="lineCov">          2 :   fN(0),</span>
<span class="lineNum">     397 </span><span class="lineCov">          2 :   fSectors(0),</span>
<span class="lineNum">     398 </span><span class="lineCov">          2 :   fInput(0),</span>
<span class="lineNum">     399 </span><span class="lineCov">          2 :   fOutput(0),</span>
<span class="lineNum">     400 </span><span class="lineCov">          2 :   fSeedTree(0),</span>
<span class="lineNum">     401 </span><span class="lineCov">          2 :   fTreeDebug(0),</span>
<span class="lineNum">     402 </span><span class="lineCov">          2 :   fEvent(0),</span>
<span class="lineNum">     403 </span><span class="lineCov">          2 :   fEventHLT(0),</span>
<span class="lineNum">     404 </span><span class="lineCov">          2 :   fDebug(0),</span>
<span class="lineNum">     405 </span><span class="lineCov">          2 :   fNewIO(0),</span>
<span class="lineNum">     406 </span><span class="lineCov">          2 :   fNtracks(0),</span>
<span class="lineNum">     407 </span><span class="lineCov">          2 :   fSeeds(0),</span>
<span class="lineNum">     408 </span><span class="lineCov">          2 :   fIteration(0),</span>
<span class="lineNum">     409 </span><span class="lineCov">          2 :   fkParam(0), </span>
<span class="lineNum">     410 </span><span class="lineCov">          2 :   fDebugStreamer(0),</span>
<span class="lineNum">     411 </span><span class="lineCov">          2 :   fUseHLTClusters(4),</span>
<span class="lineNum">     412 </span><span class="lineCov">          2 :   fClExtraRoadY(0.),</span>
<span class="lineNum">     413 </span><span class="lineCov">          2 :   fClExtraRoadZ(0.), </span>
<span class="lineNum">     414 </span><span class="lineCov">          2 :   fExtraClErrYZ2(0), </span>
<span class="lineNum">     415 </span><span class="lineCov">          2 :   fExtraClErrY2(0),</span>
<span class="lineNum">     416 </span><span class="lineCov">          2 :   fExtraClErrZ2(0),</span>
<span class="lineNum">     417 </span><span class="lineCov">          2 :   fPrimaryDCAZCut(-1),</span>
<span class="lineNum">     418 </span><span class="lineCov">          2 :   fPrimaryDCAYCut(-1),</span>
<span class="lineNum">     419 </span><span class="lineCov">          2 :   fDisableSecondaries(kFALSE),</span>
<span class="lineNum">     420 </span><span class="lineCov">          2 :   fCrossTalkSignalArray(0),</span>
<span class="lineNum">     421 </span><span class="lineCov">          2 :   fClPointersPool(0),</span>
<span class="lineNum">     422 </span><span class="lineCov">          2 :   fClPointersPoolPtr(0),</span>
<span class="lineNum">     423 </span><span class="lineCov">          2 :   fClPointersPoolSize(0),</span>
<span class="lineNum">     424 </span><span class="lineCov">          2 :   fSeedsPool(0),</span>
<span class="lineNum">     425 </span><span class="lineCov">          2 :   fHelixPool(0),</span>
<span class="lineNum">     426 </span><span class="lineCov">          2 :   fETPPool(0),</span>
<span class="lineNum">     427 </span><span class="lineCov">          2 :   fFreeSeedsID(500),</span>
<span class="lineNum">     428 </span><span class="lineCov">          2 :   fNFreeSeeds(0),</span>
<span class="lineNum">     429 </span><span class="lineCov">          2 :   fLastSeedID(-1),</span>
<span class="lineNum">     430 </span><span class="lineCov">          2 :   fAccountDistortions(0)</span>
<span class="lineNum">     431 </span><span class="lineCov">         10 : {</span>
<span class="lineNum">     432 </span>            :   //---------------------------------------------------------------------
<span class="lineNum">     433 </span>            :   // The main TPC tracker constructor
<span class="lineNum">     434 </span>            :   //---------------------------------------------------------------------
<span class="lineNum">     435 </span><span class="lineCov">         80 :   fInnerSec=new AliTPCtrackerSector[fkNIS];         </span>
<span class="lineNum">     436 </span><span class="lineCov">         80 :   fOuterSec=new AliTPCtrackerSector[fkNOS];</span>
<span class="lineNum">     437 </span>            :  
<span class="lineNum">     438 </span>            :   Int_t i;
<span class="lineNum">     439 </span><span class="lineCov">        112 :   for (i=0; i&lt;fkNIS; i++) fInnerSec[i].Setup(par,0);</span>
<span class="lineNum">     440 </span><span class="lineCov">        112 :   for (i=0; i&lt;fkNOS; i++) fOuterSec[i].Setup(par,1);</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineCov">          2 :   fkParam = par;  </span>
<span class="lineNum">     443 </span><span class="lineCov">          2 :   Int_t nrowlow = par-&gt;GetNRowLow();</span>
<span class="lineNum">     444 </span><span class="lineCov">          2 :   Int_t nrowup = par-&gt;GetNRowUp();</span>
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span>            :   
<span class="lineNum">     447 </span><span class="lineCov">        256 :   for (i=0;i&lt;nrowlow;i++){</span>
<span class="lineNum">     448 </span><span class="lineCov">        252 :     fXRow[i]     = par-&gt;GetPadRowRadiiLow(i);</span>
<span class="lineNum">     449 </span><span class="lineCov">        126 :     fPadLength[i]= par-&gt;GetPadPitchLength(0,i);</span>
<span class="lineNum">     450 </span><span class="lineCov">        252 :     fYMax[i]     = fXRow[i]*TMath::Tan(0.5*par-&gt;GetInnerAngle());</span>
<span class="lineNum">     451 </span>            :   }
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            :   
<span class="lineNum">     454 </span><span class="lineCov">        388 :   for (i=0;i&lt;nrowup;i++){</span>
<span class="lineNum">     455 </span><span class="lineCov">        384 :     fXRow[i+nrowlow]      = par-&gt;GetPadRowRadiiUp(i);</span>
<span class="lineNum">     456 </span><span class="lineCov">        192 :     fPadLength[i+nrowlow] = par-&gt;GetPadPitchLength(60,i);</span>
<span class="lineNum">     457 </span><span class="lineCov">        384 :     fYMax[i+nrowlow]      = fXRow[i+nrowlow]*TMath::Tan(0.5*par-&gt;GetOuterAngle());</span>
<span class="lineNum">     458 </span>            :   }
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineCov">          2 :   if (AliTPCReconstructor::StreamLevel()&gt;0) {</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :     fDebugStreamer = new TTreeSRedirector(&quot;TPCdebug.root&quot;,&quot;recreate&quot;);</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :     AliTPCReconstructor::SetDebugStreamer(fDebugStreamer);</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     464 </span>            :   //
<span class="lineNum">     465 </span><span class="lineCov">          6 :   fSeedsPool = new TClonesArray(&quot;AliTPCseed&quot;,1000);</span>
<span class="lineNum">     466 </span><span class="lineCov">          4 :   fClPointersPool = new AliTPCclusterMI*[kMaxFriendTracks*kMaxRow];</span>
<span class="lineNum">     467 </span><span class="lineCov">          2 :   memset(fClPointersPool,0,kMaxFriendTracks*kMaxRow*sizeof(AliTPCclusterMI*));</span>
<span class="lineNum">     468 </span><span class="lineCov">          2 :   fClPointersPoolPtr = fClPointersPool;</span>
<span class="lineNum">     469 </span><span class="lineCov">          2 :   fClPointersPoolSize = kMaxFriendTracks;</span>
<span class="lineNum">     470 </span>            :   //
<span class="lineNum">     471 </span>            :   // crosstalk array and matrix initialization
<span class="lineNum">     472 </span>            :   Int_t nROCs   = 72;
<span class="lineNum">     473 </span><span class="lineCov">          4 :   Int_t nTimeBinsAll  = AliTPCcalibDB::Instance()-&gt;GetMaxTimeBinAllPads() ;</span>
<span class="lineNum">     474 </span>            :   Int_t nWireSegments = 11;
<span class="lineNum">     475 </span><span class="lineCov">          6 :   fCrossTalkSignalArray = new TObjArray(nROCs*4);  //  </span>
<span class="lineNum">     476 </span><span class="lineCov">          2 :   fCrossTalkSignalArray-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     477 </span><span class="lineCov">       1156 :   for (Int_t isector=0; isector&lt;4*nROCs; isector++){</span>
<span class="lineNum">     478 </span><span class="lineCov">       1152 :     TMatrixD * crossTalkSignal = new TMatrixD(nWireSegments,nTimeBinsAll);</span>
<span class="lineNum">     479 </span><span class="lineCov">      13824 :     for (Int_t imatrix = 0; imatrix&lt;11; imatrix++)</span>
<span class="lineNum">     480 </span><span class="lineCov">   12177792 :       for (Int_t jmatrix = 0; jmatrix&lt;nTimeBinsAll; jmatrix++){</span>
<span class="lineNum">     481 </span><span class="lineCov">   18247680 :         (*crossTalkSignal)[imatrix][jmatrix]=0.;</span>
<span class="lineNum">     482 </span>            :       }
<span class="lineNum">     483 </span><span class="lineCov">        576 :     fCrossTalkSignalArray-&gt;AddAt(crossTalkSignal,isector);</span>
<span class="lineNum">     484 </span>            :   }
<span class="lineNum">     485 </span>            : 
<a name="486"><span class="lineNum">     486 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">     487 </span>            : //________________________________________________________________________
<span class="lineNum">     488 </span>            : AliTPCtracker::AliTPCtracker(const AliTPCtracker &amp;t):
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :   AliTracker(t),</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :   fkNIS(t.fkNIS),</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :   fInnerSec(0),</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :   fkNOS(t.fkNOS),</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :   fOuterSec(0),</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :   fN(0),</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :   fSectors(0),</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :   fInput(0),</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :   fOutput(0),</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :   fSeedTree(0),</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :   fTreeDebug(0),</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :   fEvent(0),</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :   fEventHLT(0),</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :   fDebug(0),</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :   fNewIO(kFALSE),</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :   fNtracks(0),</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :   fSeeds(0),</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :   fIteration(0),</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :   fkParam(0),</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :   fDebugStreamer(0),</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :   fUseHLTClusters(4),</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :   fClExtraRoadY(0.),</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :   fClExtraRoadZ(0.), </span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :   fExtraClErrYZ2(0), </span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :   fExtraClErrY2(0),</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :   fExtraClErrZ2(0),</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :   fPrimaryDCAZCut(-1),</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :   fPrimaryDCAYCut(-1),</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :   fDisableSecondaries(kFALSE),</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :   fCrossTalkSignalArray(0),</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :   fClPointersPool(0),</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :   fClPointersPoolPtr(0),</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :   fClPointersPoolSize(0),</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :   fSeedsPool(0),</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :   fHelixPool(0),</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :   fETPPool(0),</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :   fFreeSeedsID(500),</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :   fNFreeSeeds(0),</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :   fLastSeedID(-1),</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :   fAccountDistortions(0)</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     530 </span>            :   //------------------------------------
<span class="lineNum">     531 </span>            :   // dummy copy constructor
<span class="lineNum">     532 </span>            :   //------------------------------------------------------------------
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :   fOutput=t.fOutput;</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :   for (Int_t irow=0; irow&lt;200; irow++){</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :     fXRow[irow]=0;</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :     fYMax[irow]=0;</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :     fPadLength[irow]=0;</span>
<span class="lineNum">     538 </span>            :   }
<a name="539"><span class="lineNum">     539 </span>            : </a>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     541 </span>            : AliTPCtracker &amp; AliTPCtracker::operator=(const AliTPCtracker&amp; /*r*/)
<span class="lineNum">     542 </span>            : {
<span class="lineNum">     543 </span>            :   //------------------------------
<span class="lineNum">     544 </span>            :   // dummy 
<span class="lineNum">     545 </span>            :   //--------------------------------------------------------------
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :   return *this;</span>
<a name="547"><span class="lineNum">     547 </span>            : }</a>
<span class="lineNum">     548 </span>            : //_____________________________________________________________________________
<span class="lineNum">     549 </span><span class="lineCov">         12 : AliTPCtracker::~AliTPCtracker() {</span>
<span class="lineNum">     550 </span>            :   //------------------------------------------------------------------
<span class="lineNum">     551 </span>            :   // TPC tracker destructor
<span class="lineNum">     552 </span>            :   //------------------------------------------------------------------
<span class="lineNum">     553 </span><span class="lineCov">         42 :   delete[] fInnerSec;</span>
<span class="lineNum">     554 </span><span class="lineCov">         42 :   delete[] fOuterSec;</span>
<span class="lineNum">     555 </span><span class="lineCov">          2 :   if (fSeeds) {</span>
<span class="lineNum">     556 </span><span class="lineCov">          2 :     fSeeds-&gt;Clear(); </span>
<span class="lineNum">     557 </span><span class="lineCov">          4 :     delete fSeeds;</span>
<span class="lineNum">     558 </span>            :   }
<span class="lineNum">     559 </span><span class="lineCov">          4 :   delete[] fClPointersPool;</span>
<span class="lineNum">     560 </span><span class="lineCov">          6 :   if (fCrossTalkSignalArray) delete fCrossTalkSignalArray;</span>
<span class="lineNum">     561 </span><span class="lineCov">          2 :   if (fDebugStreamer) delete fDebugStreamer;</span>
<span class="lineNum">     562 </span><span class="lineCov">          2 :   if (fSeedsPool) {</span>
<span class="lineNum">     563 </span><span class="lineCov">         62 :     for (int isd=fSeedsPool-&gt;GetEntriesFast();isd--;) {</span>
<span class="lineNum">     564 </span><span class="lineCov">         56 :       AliTPCseed* seed = (AliTPCseed*)fSeedsPool-&gt;At(isd);</span>
<span class="lineNum">     565 </span><span class="lineCov">         28 :       if (seed) {</span>
<span class="lineNum">     566 </span><span class="lineCov">         28 :         seed-&gt;SetClusterOwner(kFALSE);</span>
<span class="lineNum">     567 </span><span class="lineCov">         28 :         seed-&gt;SetClustersArrayTMP(0);</span>
<span class="lineNum">     568 </span><span class="lineCov">         28 :       }</span>
<span class="lineNum">     569 </span>            :     }
<span class="lineNum">     570 </span><span class="lineCov">          4 :     delete fSeedsPool;</span>
<span class="lineNum">     571 </span>            :   }
<span class="lineNum">     572 </span><span class="lineCov">          4 :   if (fHelixPool) fHelixPool-&gt;Delete();</span>
<span class="lineNum">     573 </span><span class="lineCov">          4 :   delete fHelixPool;</span>
<span class="lineNum">     574 </span><span class="lineCov">          4 :   if (fETPPool) fETPPool-&gt;Delete();</span>
<span class="lineNum">     575 </span><span class="lineCov">          4 :   delete fETPPool;</span>
<span class="lineNum">     576 </span><span class="lineCov">          6 : }</span>
<a name="577"><span class="lineNum">     577 </span>            : </a>
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span>            : void AliTPCtracker::FillESD(const TObjArray* arr)
<span class="lineNum">     580 </span>            : {
<span class="lineNum">     581 </span>            :   //
<span class="lineNum">     582 </span>            :   //
<span class="lineNum">     583 </span>            :   //fill esds using updated tracks
<span class="lineNum">     584 </span>            : 
<span class="lineNum">     585 </span><span class="lineCov">         16 :   if (!fEvent) return;</span>
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span><span class="lineCov">          8 :   AliESDtrack iotrack;</span>
<span class="lineNum">     588 </span>            :   
<span class="lineNum">     589 </span>            :     // write tracks to the event
<span class="lineNum">     590 </span>            :     // store index of the track
<span class="lineNum">     591 </span><span class="lineCov">          8 :     Int_t nseed=arr-&gt;GetEntriesFast();</span>
<span class="lineNum">     592 </span>            :     //FindKinks(arr,fEvent);
<span class="lineNum">     593 </span><span class="lineCov">        288 :     for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">     594 </span><span class="lineCov">        136 :       AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i);    </span>
<span class="lineNum">     595 </span><span class="lineCov">        136 :       if (!pt) continue; </span>
<span class="lineNum">     596 </span><span class="lineCov">        136 :       pt-&gt;UpdatePoints();</span>
<span class="lineNum">     597 </span><span class="lineCov">        136 :       AddCovariance(pt);</span>
<span class="lineNum">     598 </span><span class="lineCov">        136 :       if (AliTPCReconstructor::StreamLevel()&amp;kStreamFillESD) {</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :         (*fDebugStreamer)&lt;&lt;&quot;FillESD&quot;&lt;&lt;  // flag: stream track information in FillESD function (after track Iteration 0)</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :           &quot;Tr0.=&quot;&lt;&lt;pt&lt;&lt;</span>
<span class="lineNum">     601 </span>            :           &quot;\n&quot;;       
<span class="lineNum">     602 </span>            :       }
<span class="lineNum">     603 </span>            :       //      pt-&gt;PropagateTo(fkParam-&gt;GetInnerRadiusLow());
<span class="lineNum">     604 </span><span class="lineCov">        272 :       if (pt-&gt;GetKinkIndex(0)&lt;=0){  //don't propagate daughter tracks </span>
<span class="lineNum">     605 </span><span class="lineCov">        132 :         pt-&gt;PropagateTo(fkParam-&gt;GetInnerRadiusLow());</span>
<span class="lineNum">     606 </span><span class="lineCov">        132 :         pt-&gt;SetRow(0); // RS: memorise row</span>
<span class="lineNum">     607 </span><span class="lineCov">        132 :       }</span>
<span class="lineNum">     608 </span>            :  
<span class="lineNum">     609 </span><span class="lineCov">        272 :       if (( pt-&gt;GetPoints()[2]- pt-&gt;GetPoints()[0])&gt;5 &amp;&amp; pt-&gt;GetPoints()[3]&gt;0.8){</span>
<span class="lineNum">     610 </span><span class="lineCov">        136 :         iotrack.~AliESDtrack();</span>
<span class="lineNum">     611 </span><span class="lineCov">        272 :         new(&amp;iotrack) AliESDtrack;</span>
<span class="lineNum">     612 </span><span class="lineCov">        136 :         iotrack.UpdateTrackParams(pt,AliESDtrack::kTPCin);</span>
<span class="lineNum">     613 </span><span class="lineCov">        136 :         iotrack.SetTPCsignal(pt-&gt;GetdEdx(), pt-&gt;GetSDEDX(0), pt-&gt;GetNCDEDX(0)); </span>
<span class="lineNum">     614 </span><span class="lineCov">        136 :         iotrack.SetTPCPoints(pt-&gt;GetPoints());</span>
<span class="lineNum">     615 </span><span class="lineCov">        136 :         iotrack.SetKinkIndexes(pt-&gt;GetKinkIndexes());</span>
<span class="lineNum">     616 </span><span class="lineCov">        136 :         iotrack.SetV0Indexes(pt-&gt;GetV0Indexes());</span>
<span class="lineNum">     617 </span>            :         //      iotrack.SetTPCpid(pt-&gt;fTPCr);
<span class="lineNum">     618 </span>            :         //iotrack.SetTPCindex(i); 
<span class="lineNum">     619 </span><span class="lineCov">        136 :         MakeESDBitmaps(pt, &amp;iotrack);</span>
<span class="lineNum">     620 </span><span class="lineCov">        136 :         fEvent-&gt;AddTrack(&amp;iotrack);</span>
<span class="lineNum">     621 </span><span class="lineCov">        136 :         continue;</span>
<span class="lineNum">     622 </span>            :       }
<span class="lineNum">     623 </span>            :        
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :       if ( (pt-&gt;GetNumberOfClusters()&gt;70)&amp;&amp; (Float_t(pt-&gt;GetNumberOfClusters())/Float_t(pt-&gt;GetNFoundable()))&gt;0.55) {</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :         iotrack.~AliESDtrack();</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :         new(&amp;iotrack) AliESDtrack;</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :         iotrack.UpdateTrackParams(pt,AliESDtrack::kTPCin);</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :         iotrack.SetTPCsignal(pt-&gt;GetdEdx(), pt-&gt;GetSDEDX(0), pt-&gt;GetNCDEDX(0)); </span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :         iotrack.SetTPCPoints(pt-&gt;GetPoints());</span>
<span class="lineNum">     630 </span>            :         //iotrack.SetTPCindex(i);
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :         iotrack.SetKinkIndexes(pt-&gt;GetKinkIndexes());</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :         iotrack.SetV0Indexes(pt-&gt;GetV0Indexes());</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :         MakeESDBitmaps(pt, &amp;iotrack);</span>
<span class="lineNum">     634 </span>            :         //      iotrack.SetTPCpid(pt-&gt;fTPCr);
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :         fEvent-&gt;AddTrack(&amp;iotrack);</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     637 </span>            :       } 
<span class="lineNum">     638 </span>            :       //
<span class="lineNum">     639 </span>            :       // short tracks  - maybe decays
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            :       //RS Seed don't keep their cluster pointers, cache cluster usage stat. for fast evaluation
<span class="lineNum">     642 </span>            :       // FillSeedClusterStatCache(pt); // RS use this slow method only if info on shared statistics is needed
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :       if ( (pt-&gt;GetNumberOfClusters()&gt;30) &amp;&amp; (Float_t(pt-&gt;GetNumberOfClusters())/Float_t(pt-&gt;GetNFoundable()))&gt;0.70) {</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :         Int_t found,foundable; //,shared;</span>
<span class="lineNum">     646 </span>            :         //GetCachedSeedClusterStatistic(0,60,found, foundable,shared,kFALSE); // RS make sure FillSeedClusterStatCache is called
<span class="lineNum">     647 </span>            :         //pt-&gt;GetClusterStatistic(0,60,found, foundable,shared,kFALSE); //RS: avoid this method: seed does not keep clusters
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :         pt-&gt;GetClusterStatistic(0,60,found, foundable);</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :         if ( (found&gt;20) &amp;&amp; (pt-&gt;GetNShared()/float(pt-&gt;GetNumberOfClusters())&lt;0.2)){</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :           iotrack.~AliESDtrack();</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :           new(&amp;iotrack) AliESDtrack;</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :           iotrack.UpdateTrackParams(pt,AliESDtrack::kTPCin);    </span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :           iotrack.SetTPCsignal(pt-&gt;GetdEdx(), pt-&gt;GetSDEDX(0), pt-&gt;GetNCDEDX(0)); </span>
<span class="lineNum">     654 </span>            :           //iotrack.SetTPCindex(i);
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :           iotrack.SetTPCPoints(pt-&gt;GetPoints());</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :           iotrack.SetKinkIndexes(pt-&gt;GetKinkIndexes());</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :           iotrack.SetV0Indexes(pt-&gt;GetV0Indexes());</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :           MakeESDBitmaps(pt, &amp;iotrack);</span>
<span class="lineNum">     659 </span>            :           //iotrack.SetTPCpid(pt-&gt;fTPCr);
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :           fEvent-&gt;AddTrack(&amp;iotrack);</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     662 </span>            :         }
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :       }       </span>
<span class="lineNum">     664 </span>            :       
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :       if ( (pt-&gt;GetNumberOfClusters()&gt;20) &amp;&amp; (Float_t(pt-&gt;GetNumberOfClusters())/Float_t(pt-&gt;GetNFoundable()))&gt;0.8) {</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :         Int_t found,foundable;//,shared;</span>
<span class="lineNum">     667 </span>            :         //RS GetCachedSeedClusterStatistic(0,60,found, foundable,shared,kFALSE); // RS make sure FillSeedClusterStatCache is called
<span class="lineNum">     668 </span>            :         //pt-&gt;GetClusterStatistic(0,60,found, foundable,shared,kFALSE); //RS: avoid this method: seed does not keep clusters
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :         pt-&gt;GetClusterStatistic(0,60,found,foundable);</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :         if (found&lt;20) continue;</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :         if (pt-&gt;GetNShared()/float(pt-&gt;GetNumberOfClusters())&gt;0.2) continue;</span>
<span class="lineNum">     672 </span>            :         //
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :         iotrack.~AliESDtrack();</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :         new(&amp;iotrack) AliESDtrack;</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :         iotrack.UpdateTrackParams(pt,AliESDtrack::kTPCin);      </span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :         iotrack.SetTPCsignal(pt-&gt;GetdEdx(), pt-&gt;GetSDEDX(0), pt-&gt;GetNCDEDX(0)); </span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :         iotrack.SetTPCPoints(pt-&gt;GetPoints());</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :         iotrack.SetKinkIndexes(pt-&gt;GetKinkIndexes());</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :         iotrack.SetV0Indexes(pt-&gt;GetV0Indexes());</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :         MakeESDBitmaps(pt, &amp;iotrack);</span>
<span class="lineNum">     681 </span>            :         //iotrack.SetTPCpid(pt-&gt;fTPCr);
<span class="lineNum">     682 </span>            :         //iotrack.SetTPCindex(i);
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :         fEvent-&gt;AddTrack(&amp;iotrack);</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">     686 </span>            :       // short tracks  - secondaties
<span class="lineNum">     687 </span>            :       //
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :       if ( (pt-&gt;GetNumberOfClusters()&gt;30) ) {</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :         Int_t found,foundable;//,shared;</span>
<span class="lineNum">     690 </span>            :         //GetCachedSeedClusterStatistic(128,158,found, foundable,shared,kFALSE); // RS make sure FillSeedClusterStatCache is called
<span class="lineNum">     691 </span>            :         //pt-&gt;GetClusterStatistic(128,158,found, foundable,shared,kFALSE);  //RS: avoid this method: seed does not keep clusters
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :         pt-&gt;GetClusterStatistic(128,158,found, foundable);</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :         if ( (found&gt;20) &amp;&amp; (pt-&gt;GetNShared()/float(pt-&gt;GetNumberOfClusters())&lt;0.2) &amp;&amp;float(found)/float(foundable)&gt;0.8){</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :           iotrack.~AliESDtrack();</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :           new(&amp;iotrack) AliESDtrack;</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :           iotrack.UpdateTrackParams(pt,AliESDtrack::kTPCin);    </span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :           iotrack.SetTPCsignal(pt-&gt;GetdEdx(), pt-&gt;GetSDEDX(0), pt-&gt;GetNCDEDX(0)); </span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :           iotrack.SetTPCPoints(pt-&gt;GetPoints());</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :           iotrack.SetKinkIndexes(pt-&gt;GetKinkIndexes());</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :           iotrack.SetV0Indexes(pt-&gt;GetV0Indexes());</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :           MakeESDBitmaps(pt, &amp;iotrack);</span>
<span class="lineNum">     702 </span>            :           //iotrack.SetTPCpid(pt-&gt;fTPCr);    
<span class="lineNum">     703 </span>            :           //iotrack.SetTPCindex(i);
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :           fEvent-&gt;AddTrack(&amp;iotrack);</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     706 </span>            :         }
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :       }       </span>
<span class="lineNum">     708 </span>            :       
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :       if ( (pt-&gt;GetNumberOfClusters()&gt;15)) {</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :         Int_t found,foundable,shared;</span>
<span class="lineNum">     711 </span>            :         //GetCachedSeedClusterStatistic(138,158,found, foundable,shared,kFALSE); // RS make sure FillSeedClusterStatCache is called
<span class="lineNum">     712 </span>            :         //RS pt-&gt;GetClusterStatistic(138,158,found, foundable,shared,kFALSE);  //RS: avoid this method: seed does not keep clusters
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :         pt-&gt;GetClusterStatistic(138,158,found, foundable);</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :         if (found&lt;15) continue;</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :         if (foundable&lt;=0) continue;</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :         if (pt-&gt;GetNShared()/float(pt-&gt;GetNumberOfClusters())&gt;0.2) continue;</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :         if (float(found)/float(foundable)&lt;0.8) continue;</span>
<span class="lineNum">     718 </span>            :         //
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :         iotrack.~AliESDtrack();</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :         new(&amp;iotrack) AliESDtrack;</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :         iotrack.UpdateTrackParams(pt,AliESDtrack::kTPCin);      </span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :         iotrack.SetTPCsignal(pt-&gt;GetdEdx(), pt-&gt;GetSDEDX(0), pt-&gt;GetNCDEDX(0)); </span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :         iotrack.SetTPCPoints(pt-&gt;GetPoints());</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :         iotrack.SetKinkIndexes(pt-&gt;GetKinkIndexes());</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :         iotrack.SetV0Indexes(pt-&gt;GetV0Indexes());</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :         MakeESDBitmaps(pt, &amp;iotrack);</span>
<span class="lineNum">     727 </span>            :         //      iotrack.SetTPCpid(pt-&gt;fTPCr);
<span class="lineNum">     728 </span>            :         //iotrack.SetTPCindex(i);
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :         fEvent-&gt;AddTrack(&amp;iotrack);</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :       }   </span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     733 </span>            :     // &gt;&gt; account for suppressed tracks in the kink indices (RS)
<span class="lineNum">     734 </span><span class="lineCov">          8 :     int nESDtracks = fEvent-&gt;GetNumberOfTracks();</span>
<span class="lineNum">     735 </span><span class="lineCov">        152 :     for (int it=nESDtracks;it--;) {</span>
<span class="lineNum">     736 </span><span class="lineCov">        136 :       AliESDtrack* esdTr = fEvent-&gt;GetTrack(it);</span>
<span class="lineNum">     737 </span><span class="lineCov">        536 :       if (!esdTr || !esdTr-&gt;GetKinkIndex(0)) continue;</span>
<span class="lineNum">     738 </span><span class="lineCov">         32 :       for (int ik=0;ik&lt;3;ik++) {</span>
<span class="lineNum">     739 </span>            :         int knkId=0;
<span class="lineNum">     740 </span><span class="lineCov">         40 :         if (!(knkId=esdTr-&gt;GetKinkIndex(ik))) break; // no more kinks for this track</span>
<span class="lineNum">     741 </span><span class="lineCov">          8 :         AliESDkink* kink = fEvent-&gt;GetKink(TMath::Abs(knkId)-1);</span>
<span class="lineNum">     742 </span><span class="lineCov">          8 :         if (!kink) {</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :           AliError(Form(&quot;ESDTrack%d refers to non-existing kink %d&quot;,it,TMath::Abs(knkId)-1));</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     745 </span>            :         }
<span class="lineNum">     746 </span><span class="lineCov">          8 :         kink-&gt;SetIndex(it, knkId&lt;0 ? 0:1); // update track index of the kink: mother at 0, daughter at 1</span>
<span class="lineNum">     747 </span><span class="lineCov">          8 :       }</span>
<span class="lineNum">     748 </span><span class="lineCov">          8 :     }</span>
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span>            :     // &lt;&lt; account for suppressed tracks in the kink indices (RS)  
<span class="lineNum">     751 </span><span class="lineCov">         32 :     AliInfo(Form(&quot;Number of filled ESDs-\t%d\n&quot;,fEvent-&gt;GetNumberOfTracks()));</span>
<span class="lineNum">     752 </span>            :   
<span class="lineNum">     753 </span><span class="lineCov">         16 : }</span>
<a name="754"><span class="lineNum">     754 </span>            : </a>
<span class="lineNum">     755 </span>            : //_____________________________________________________________________________________
<span class="lineNum">     756 </span>            : void AliTPCtracker::ErrY2Z2(AliTPCseed* seed, const AliTPCclusterMI * cl, double &amp;erry2, double &amp;errz2)
<span class="lineNum">     757 </span>            : {
<span class="lineNum">     758 </span>            :   //
<span class="lineNum">     759 </span>            :   //
<span class="lineNum">     760 </span>            :   // Use calibrated cluster error from OCDB
<span class="lineNum">     761 </span>            :   //
<span class="lineNum">     762 </span><span class="lineCov">     209276 :   const AliTPCRecoParam* rp = AliTPCReconstructor::GetRecoParam();</span>
<span class="lineNum">     763 </span><span class="lineCov">     104638 :   AliTPCClusterParam * clparam = AliTPCcalibDB::Instance()-&gt;GetClusterParam();</span>
<span class="lineNum">     764 </span>            :   //
<span class="lineNum">     765 </span><span class="lineCov">     104638 :   Float_t z = TMath::Abs(fkParam-&gt;GetZLength(0)-TMath::Abs(seed-&gt;GetZ()));</span>
<span class="lineNum">     766 </span><span class="lineCov">     104638 :   Int_t ctype = cl-&gt;GetType();  </span>
<span class="lineNum">     767 </span><span class="lineCov">     231950 :   Int_t    type = (cl-&gt;GetRow()&lt;63) ? 0: (cl-&gt;GetRow()&gt;126) ? 1:2;</span>
<span class="lineNum">     768 </span><span class="lineCov">     104638 :   double   snp2 = seed-&gt;GetSnp()*seed-&gt;GetSnp();</span>
<span class="lineNum">     769 </span><span class="lineCov">     104638 :   if (snp2&gt;1.-1e-6) snp2 = 1.-1e-6;</span>
<span class="lineNum">     770 </span><span class="lineCov">     104638 :   double   tgp2 = snp2/(1.f-snp2);</span>
<span class="lineNum">     771 </span><span class="lineCov">     104638 :   double   tgp  = TMath::Sqrt(tgp2);</span>
<span class="lineNum">     772 </span><span class="lineCov">     104638 :   double   tgl2m = seed-&gt;GetTgl()*seed-&gt;GetTgl()*(1+tgp2); </span>
<span class="lineNum">     773 </span><span class="lineCov">     104638 :   Double_t tglm = TMath::Sqrt(tgl2m);</span>
<span class="lineNum">     774 </span><span class="lineCov">     104638 :   erry2 = clparam-&gt;GetError0Par(0,type, z,tgp);</span>
<span class="lineNum">     775 </span><span class="lineCov">     104638 :   errz2 = clparam-&gt;GetError0Par(1,type, z,tglm);</span>
<span class="lineNum">     776 </span><span class="lineCov">     104638 :   if (ctype&lt;0) { // edge cluster</span>
<span class="lineNum">     777 </span><span class="lineCov">       2622 :     erry2+=0.5;  </span>
<span class="lineNum">     778 </span><span class="lineCov">       2622 :     errz2+=0.5; </span>
<span class="lineNum">     779 </span><span class="lineCov">       2622 :   }</span>
<span class="lineNum">     780 </span><span class="lineCov">     104638 :   erry2 *= erry2;</span>
<span class="lineNum">     781 </span><span class="lineCov">     104638 :   errz2 *= errz2;</span>
<span class="lineNum">     782 </span>            :   // additional systematic error on the cluster
<span class="lineNum">     783 </span><span class="lineCov">     104638 :   double serry2=0,serrz2=0;</span>
<span class="lineNum">     784 </span><span class="lineCov">     104638 :   AliTPCcalibDB::Instance()-&gt;GetTransform()-&gt;ErrY2Z2Syst(cl, tgp, seed-&gt;GetTgl(), serry2,serrz2);</span>
<span class="lineNum">     785 </span><span class="lineCov">     104638 :   erry2 += serry2;</span>
<span class="lineNum">     786 </span><span class="lineCov">     104638 :   errz2 += serrz2;</span>
<span class="lineNum">     787 </span><span class="lineCov">     104638 :   seed-&gt;SetErrorY2(erry2);</span>
<span class="lineNum">     788 </span><span class="lineCov">     104638 :   seed-&gt;SetErrorZ2(errz2);</span>
<span class="lineNum">     789 </span>            :   //
<span class="lineNum">     790 </span><span class="lineCov">     104638 : }</span>
<span class="lineNum">     791 </span>            : 
<span class="lineNum">     792 </span>            : 
<a name="793"><span class="lineNum">     793 </span>            : </a>
<span class="lineNum">     794 </span>            : //_____________________________________________________________________________________
<span class="lineNum">     795 </span>            : Double_t AliTPCtracker::ErrY2(AliTPCseed* seed, const AliTPCclusterMI * cl){
<span class="lineNum">     796 </span>            :   //
<span class="lineNum">     797 </span>            :   //
<span class="lineNum">     798 </span>            :   // Use calibrated cluster error from OCDB
<span class="lineNum">     799 </span>            :   //
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :   const AliTPCRecoParam* rp = AliTPCReconstructor::GetRecoParam();</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :   AliTPCClusterParam * clparam = AliTPCcalibDB::Instance()-&gt;GetClusterParam();</span>
<span class="lineNum">     802 </span>            :   //
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :   Float_t z = TMath::Abs(fkParam-&gt;GetZLength(0)-TMath::Abs(seed-&gt;GetZ()));</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :   Int_t ctype = cl-&gt;GetType();  </span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :   Int_t    type = (cl-&gt;GetRow()&lt;63) ? 0: (cl-&gt;GetRow()&gt;126) ? 1:2;</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :   double   angle2 = seed-&gt;GetSnp()*seed-&gt;GetSnp();</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :   double   angle = TMath::Sqrt(TMath::Abs(angle2/(1.f-angle2)));</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :   Double_t erry2 = clparam-&gt;GetError0Par(0,type, z,angle);</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :   if (ctype&lt;0) {</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :     erry2+=0.5;  // edge cluster</span>
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :   erry2 *= erry2;</span>
<span class="lineNum">     813 </span>            :   // additional systematic error on the cluster
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :   erry2 += AliTPCcalibDB::Instance()-&gt;GetTransform()-&gt;ErrY2Syst(cl, angle);</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :   seed-&gt;SetErrorY2(erry2);</span>
<span class="lineNum">     816 </span>            :   //
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :   return erry2;</span>
<span class="lineNum">     818 </span>            : 
<span class="lineNum">     819 </span>            : //calculate look-up table at the beginning
<span class="lineNum">     820 </span>            : //   static Bool_t  ginit = kFALSE;
<span class="lineNum">     821 </span>            : //   static Float_t gnoise1,gnoise2,gnoise3;
<span class="lineNum">     822 </span>            : //   static Float_t ggg1[10000];
<span class="lineNum">     823 </span>            : //   static Float_t ggg2[10000];
<span class="lineNum">     824 </span>            : //   static Float_t ggg3[10000];
<span class="lineNum">     825 </span>            : //   static Float_t glandau1[10000];
<span class="lineNum">     826 </span>            : //   static Float_t glandau2[10000];
<span class="lineNum">     827 </span>            : //   static Float_t glandau3[10000];
<span class="lineNum">     828 </span>            : //   //
<span class="lineNum">     829 </span>            : //   static Float_t gcor01[500];
<span class="lineNum">     830 </span>            : //   static Float_t gcor02[500];
<span class="lineNum">     831 </span>            : //   static Float_t gcorp[500];
<span class="lineNum">     832 </span>            : //   //
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span>            : //   //
<span class="lineNum">     835 </span>            : //   if (ginit==kFALSE){
<span class="lineNum">     836 </span>            : //     for (Int_t i=1;i&lt;500;i++){
<span class="lineNum">     837 </span>            : //       Float_t rsigma = float(i)/100.;
<span class="lineNum">     838 </span>            : //       gcor02[i] = TMath::Max(0.78 +TMath::Exp(7.4*(rsigma-1.2)),0.6);
<span class="lineNum">     839 </span>            : //       gcor01[i] = TMath::Max(0.72 +TMath::Exp(3.36*(rsigma-1.2)),0.6);
<span class="lineNum">     840 </span>            : //       gcorp[i]  = TMath::Max(TMath::Power((rsigma+0.5),1.5),1.2);
<span class="lineNum">     841 </span>            : //     }
<span class="lineNum">     842 </span>            : 
<span class="lineNum">     843 </span>            : //     //
<span class="lineNum">     844 </span>            : //     for (Int_t i=3;i&lt;10000;i++){
<span class="lineNum">     845 </span>            : //       //
<span class="lineNum">     846 </span>            : //       //
<span class="lineNum">     847 </span>            : //       // inner sector
<span class="lineNum">     848 </span>            : //       Float_t amp = float(i);
<span class="lineNum">     849 </span>            : //       Float_t padlength =0.75;
<span class="lineNum">     850 </span>            : //       gnoise1 = 0.0004/padlength;
<span class="lineNum">     851 </span>            : //       Float_t nel     = 0.268*amp;
<span class="lineNum">     852 </span>            : //       Float_t nprim   = 0.155*amp;
<span class="lineNum">     853 </span>            : //       ggg1[i]          = fkParam-&gt;GetDiffT()*fkParam-&gt;GetDiffT()*(2+0.001*nel/(padlength*padlength))/nel;
<span class="lineNum">     854 </span>            : //       glandau1[i]      = (2.+0.12*nprim)*0.5* (2.+nprim*nprim*0.001/(padlength*padlength))/nprim;
<span class="lineNum">     855 </span>            : //       if (glandau1[i]&gt;1) glandau1[i]=1;
<span class="lineNum">     856 </span>            : //       glandau1[i]*=padlength*padlength/12.;      
<span class="lineNum">     857 </span>            : //       //
<span class="lineNum">     858 </span>            : //       // outer short
<span class="lineNum">     859 </span>            : //       padlength =1.;
<span class="lineNum">     860 </span>            : //       gnoise2   = 0.0004/padlength;
<span class="lineNum">     861 </span>            : //       nel       = 0.3*amp;
<span class="lineNum">     862 </span>            : //       nprim     = 0.133*amp;
<span class="lineNum">     863 </span>            : //       ggg2[i]      = fkParam-&gt;GetDiffT()*fkParam-&gt;GetDiffT()*(2+0.0008*nel/(padlength*padlength))/nel;
<span class="lineNum">     864 </span>            : //       glandau2[i]  = (2.+0.12*nprim)*0.5*(2.+nprim*nprim*0.001/(padlength*padlength))/nprim;
<span class="lineNum">     865 </span>            : //       if (glandau2[i]&gt;1) glandau2[i]=1;
<span class="lineNum">     866 </span>            : //       glandau2[i]*=padlength*padlength/12.;
<span class="lineNum">     867 </span>            : //       //
<span class="lineNum">     868 </span>            : //       //
<span class="lineNum">     869 </span>            : //       // outer long
<span class="lineNum">     870 </span>            : //       padlength =1.5;
<span class="lineNum">     871 </span>            : //       gnoise3   = 0.0004/padlength;
<span class="lineNum">     872 </span>            : //       nel       = 0.3*amp;
<span class="lineNum">     873 </span>            : //       nprim     = 0.133*amp;
<span class="lineNum">     874 </span>            : //       ggg3[i]      = fkParam-&gt;GetDiffT()*fkParam-&gt;GetDiffT()*(2+0.0008*nel/(padlength*padlength))/nel;
<span class="lineNum">     875 </span>            : //       glandau3[i]  = (2.+0.12*nprim)*0.5*(2.+nprim*nprim*0.001/(padlength*padlength))/nprim;
<span class="lineNum">     876 </span>            : //       if (glandau3[i]&gt;1) glandau3[i]=1;
<span class="lineNum">     877 </span>            : //       glandau3[i]*=padlength*padlength/12.;
<span class="lineNum">     878 </span>            : //       //
<span class="lineNum">     879 </span>            : //     }
<span class="lineNum">     880 </span>            : //     ginit = kTRUE;
<span class="lineNum">     881 </span>            : //   }
<span class="lineNum">     882 </span>            : //   //
<span class="lineNum">     883 </span>            : //   //
<span class="lineNum">     884 </span>            : //   //
<span class="lineNum">     885 </span>            : //   Int_t amp = int(TMath::Abs(cl-&gt;GetQ()));  
<span class="lineNum">     886 </span>            : //   if (amp&gt;9999) {
<span class="lineNum">     887 </span>            : //     seed-&gt;SetErrorY2(1.);
<span class="lineNum">     888 </span>            : //     return 1.;
<span class="lineNum">     889 </span>            : //   }
<span class="lineNum">     890 </span>            : //   Float_t snoise2;
<span class="lineNum">     891 </span>            : //   Float_t z = TMath::Abs(fkParam-&gt;GetZLength(0)-TMath::Abs(seed-&gt;GetZ()));
<span class="lineNum">     892 </span>            : //   Int_t ctype = cl-&gt;GetType();  
<span class="lineNum">     893 </span>            : //   Float_t padlength= GetPadPitchLength(seed-&gt;GetRow());
<span class="lineNum">     894 </span>            : //   Double_t angle2 = seed-&gt;GetSnp()*seed-&gt;GetSnp();
<span class="lineNum">     895 </span>            : //   angle2 = angle2/(1-angle2); 
<span class="lineNum">     896 </span>            : //   //
<span class="lineNum">     897 </span>            : //   //cluster &quot;quality&quot;
<span class="lineNum">     898 </span>            : //   Int_t rsigmay = int(100.*cl-&gt;GetSigmaY2()/(seed-&gt;GetCurrentSigmaY2()));
<span class="lineNum">     899 </span>            : //   Float_t res;
<span class="lineNum">     900 </span>            : //   //
<span class="lineNum">     901 </span>            : //   if (fSectors==fInnerSec){
<span class="lineNum">     902 </span>            : //     snoise2 = gnoise1;
<span class="lineNum">     903 </span>            : //     res     = ggg1[amp]*z+glandau1[amp]*angle2;     
<span class="lineNum">     904 </span>            : //     if (ctype==0) res *= gcor01[rsigmay];
<span class="lineNum">     905 </span>            : //     if ((ctype&gt;0)){
<span class="lineNum">     906 </span>            : //       res+=0.002;
<span class="lineNum">     907 </span>            : //       res*= gcorp[rsigmay];
<span class="lineNum">     908 </span>            : //     }
<span class="lineNum">     909 </span>            : //   }
<span class="lineNum">     910 </span>            : //   else {
<span class="lineNum">     911 </span>            : //     if (padlength&lt;1.1){
<span class="lineNum">     912 </span>            : //       snoise2 = gnoise2;
<span class="lineNum">     913 </span>            : //       res     = ggg2[amp]*z+glandau2[amp]*angle2; 
<span class="lineNum">     914 </span>            : //       if (ctype==0) res *= gcor02[rsigmay];      
<span class="lineNum">     915 </span>            : //       if ((ctype&gt;0)){
<span class="lineNum">     916 </span>            : //      res+=0.002;
<span class="lineNum">     917 </span>            : //      res*= gcorp[rsigmay];
<span class="lineNum">     918 </span>            : //       }
<span class="lineNum">     919 </span>            : //     }
<span class="lineNum">     920 </span>            : //     else{
<span class="lineNum">     921 </span>            : //       snoise2 = gnoise3;      
<span class="lineNum">     922 </span>            : //       res     = ggg3[amp]*z+glandau3[amp]*angle2; 
<span class="lineNum">     923 </span>            : //       if (ctype==0) res *= gcor02[rsigmay];
<span class="lineNum">     924 </span>            : //       if ((ctype&gt;0)){
<span class="lineNum">     925 </span>            : //      res+=0.002;
<span class="lineNum">     926 </span>            : //      res*= gcorp[rsigmay];
<span class="lineNum">     927 </span>            : //       }
<span class="lineNum">     928 </span>            : //     }
<span class="lineNum">     929 </span>            : //   }  
<span class="lineNum">     930 </span>            : 
<span class="lineNum">     931 </span>            : //   if (ctype&lt;0){
<span class="lineNum">     932 </span>            : //     res+=0.005;
<span class="lineNum">     933 </span>            : //     res*=2.4;  // overestimate error 2 times
<span class="lineNum">     934 </span>            : //   }
<span class="lineNum">     935 </span>            : //   res+= snoise2;
<span class="lineNum">     936 </span>            :  
<span class="lineNum">     937 </span>            : //   if (res&lt;2*snoise2)
<span class="lineNum">     938 </span>            : //     res = 2*snoise2;
<span class="lineNum">     939 </span>            :   
<span class="lineNum">     940 </span>            : //   seed-&gt;SetErrorY2(res);
<span class="lineNum">     941 </span>            : //   return res;
<span class="lineNum">     942 </span>            : 
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span>            : }
<span class="lineNum">     945 </span>            : 
<a name="946"><span class="lineNum">     946 </span>            : </a>
<span class="lineNum">     947 </span>            : //__________________________________________________________________________________
<span class="lineNum">     948 </span>            : Double_t AliTPCtracker::ErrZ2(AliTPCseed* seed, const AliTPCclusterMI * cl){
<span class="lineNum">     949 </span>            :   //
<span class="lineNum">     950 </span>            :   //
<span class="lineNum">     951 </span>            :   // Use calibrated cluster error from OCDB
<span class="lineNum">     952 </span>            :   //
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :   const AliTPCRecoParam* rp = AliTPCReconstructor::GetRecoParam();</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :   AliTPCClusterParam * clparam = AliTPCcalibDB::Instance()-&gt;GetClusterParam();</span>
<span class="lineNum">     955 </span>            :   //
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :   Float_t z = TMath::Abs(fkParam-&gt;GetZLength(0)-TMath::Abs(seed-&gt;GetZ()));</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :   Int_t ctype = cl-&gt;GetType();  </span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :   Int_t    type = (cl-&gt;GetRow()&lt;63) ? 0: (cl-&gt;GetRow()&gt;126) ? 1:2;</span>
<span class="lineNum">     959 </span>            :   //
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :   double angle2 = seed-&gt;GetSnp()*seed-&gt;GetSnp();</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :   angle2 = seed-&gt;GetTgl()*seed-&gt;GetTgl()*(1+angle2/(1-angle2)); </span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :   Double_t angle = TMath::Sqrt(TMath::Abs(angle2));</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :   Double_t errz2 = clparam-&gt;GetError0Par(1,type, z,angle);</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :   if (ctype&lt;0) {</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :     errz2+=0.5;  // edge cluster</span>
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :   errz2*=errz2;</span>
<span class="lineNum">     968 </span>            :   // additional systematic error on the cluster
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :   errz2 += AliTPCcalibDB::Instance()-&gt;GetTransform()-&gt;ErrZ2Syst(cl, seed-&gt;GetTgl());</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :   seed-&gt;SetErrorZ2(errz2);</span>
<span class="lineNum">     971 </span>            :   //
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :   return errz2;</span>
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span>            : 
<span class="lineNum">     975 </span>            : 
<span class="lineNum">     976 </span>            : //   //seed-&gt;SetErrorY2(0.1);
<span class="lineNum">     977 </span>            : //   //return 0.1;
<span class="lineNum">     978 </span>            : //   //calculate look-up table at the beginning
<span class="lineNum">     979 </span>            : //   static Bool_t  ginit = kFALSE;
<span class="lineNum">     980 </span>            : //   static Float_t gnoise1,gnoise2,gnoise3;
<span class="lineNum">     981 </span>            : //   static Float_t ggg1[10000];
<span class="lineNum">     982 </span>            : //   static Float_t ggg2[10000];
<span class="lineNum">     983 </span>            : //   static Float_t ggg3[10000];
<span class="lineNum">     984 </span>            : //   static Float_t glandau1[10000];
<span class="lineNum">     985 </span>            : //   static Float_t glandau2[10000];
<span class="lineNum">     986 </span>            : //   static Float_t glandau3[10000];
<span class="lineNum">     987 </span>            : //   //
<span class="lineNum">     988 </span>            : //   static Float_t gcor01[1000];
<span class="lineNum">     989 </span>            : //   static Float_t gcor02[1000];
<span class="lineNum">     990 </span>            : //   static Float_t gcorp[1000];
<span class="lineNum">     991 </span>            : //   //
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span>            : //   //
<span class="lineNum">     994 </span>            : //   if (ginit==kFALSE){
<span class="lineNum">     995 </span>            : //     for (Int_t i=1;i&lt;1000;i++){
<span class="lineNum">     996 </span>            : //       Float_t rsigma = float(i)/100.;
<span class="lineNum">     997 </span>            : //       gcor02[i] = TMath::Max(0.81 +TMath::Exp(6.8*(rsigma-1.2)),0.6);
<span class="lineNum">     998 </span>            : //       gcor01[i] = TMath::Max(0.72 +TMath::Exp(2.04*(rsigma-1.2)),0.6);
<span class="lineNum">     999 </span>            : //       gcorp[i]  = TMath::Max(TMath::Power((rsigma+0.5),1.5),1.2);
<span class="lineNum">    1000 </span>            : //     }
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span>            : //     //
<span class="lineNum">    1003 </span>            : //     for (Int_t i=3;i&lt;10000;i++){
<span class="lineNum">    1004 </span>            : //       //
<span class="lineNum">    1005 </span>            : //       //
<span class="lineNum">    1006 </span>            : //       // inner sector
<span class="lineNum">    1007 </span>            : //       Float_t amp = float(i);
<span class="lineNum">    1008 </span>            : //       Float_t padlength =0.75;
<span class="lineNum">    1009 </span>            : //       gnoise1 = 0.0004/padlength;
<span class="lineNum">    1010 </span>            : //       Float_t nel     = 0.268*amp;
<span class="lineNum">    1011 </span>            : //       Float_t nprim   = 0.155*amp;
<span class="lineNum">    1012 </span>            : //       ggg1[i]          = fkParam-&gt;GetDiffT()*fkParam-&gt;GetDiffT()*(2+0.001*nel/(padlength*padlength))/nel;
<span class="lineNum">    1013 </span>            : //       glandau1[i]      = (2.+0.12*nprim)*0.5* (2.+nprim*nprim*0.001/(padlength*padlength))/nprim;
<span class="lineNum">    1014 </span>            : //       if (glandau1[i]&gt;1) glandau1[i]=1;
<span class="lineNum">    1015 </span>            : //       glandau1[i]*=padlength*padlength/12.;      
<span class="lineNum">    1016 </span>            : //       //
<span class="lineNum">    1017 </span>            : //       // outer short
<span class="lineNum">    1018 </span>            : //       padlength =1.;
<span class="lineNum">    1019 </span>            : //       gnoise2   = 0.0004/padlength;
<span class="lineNum">    1020 </span>            : //       nel       = 0.3*amp;
<span class="lineNum">    1021 </span>            : //       nprim     = 0.133*amp;
<span class="lineNum">    1022 </span>            : //       ggg2[i]      = fkParam-&gt;GetDiffT()*fkParam-&gt;GetDiffT()*(2+0.0008*nel/(padlength*padlength))/nel;
<span class="lineNum">    1023 </span>            : //       glandau2[i]  = (2.+0.12*nprim)*0.5*(2.+nprim*nprim*0.001/(padlength*padlength))/nprim;
<span class="lineNum">    1024 </span>            : //       if (glandau2[i]&gt;1) glandau2[i]=1;
<span class="lineNum">    1025 </span>            : //       glandau2[i]*=padlength*padlength/12.;
<span class="lineNum">    1026 </span>            : //       //
<span class="lineNum">    1027 </span>            : //       //
<span class="lineNum">    1028 </span>            : //       // outer long
<span class="lineNum">    1029 </span>            : //       padlength =1.5;
<span class="lineNum">    1030 </span>            : //       gnoise3   = 0.0004/padlength;
<span class="lineNum">    1031 </span>            : //       nel       = 0.3*amp;
<span class="lineNum">    1032 </span>            : //       nprim     = 0.133*amp;
<span class="lineNum">    1033 </span>            : //       ggg3[i]      = fkParam-&gt;GetDiffT()*fkParam-&gt;GetDiffT()*(2+0.0008*nel/(padlength*padlength))/nel;
<span class="lineNum">    1034 </span>            : //       glandau3[i]  = (2.+0.12*nprim)*0.5*(2.+nprim*nprim*0.001/(padlength*padlength))/nprim;
<span class="lineNum">    1035 </span>            : //       if (glandau3[i]&gt;1) glandau3[i]=1;
<span class="lineNum">    1036 </span>            : //       glandau3[i]*=padlength*padlength/12.;
<span class="lineNum">    1037 </span>            : //       //
<span class="lineNum">    1038 </span>            : //     }
<span class="lineNum">    1039 </span>            : //     ginit = kTRUE;
<span class="lineNum">    1040 </span>            : //   }
<span class="lineNum">    1041 </span>            : //   //
<span class="lineNum">    1042 </span>            : //   //
<span class="lineNum">    1043 </span>            : //   //
<span class="lineNum">    1044 </span>            : //   Int_t amp = int(TMath::Abs(cl-&gt;GetQ()));  
<span class="lineNum">    1045 </span>            : //   if (amp&gt;9999) {
<span class="lineNum">    1046 </span>            : //     seed-&gt;SetErrorY2(1.);
<span class="lineNum">    1047 </span>            : //     return 1.;
<span class="lineNum">    1048 </span>            : //   }
<span class="lineNum">    1049 </span>            : //   Float_t snoise2;
<span class="lineNum">    1050 </span>            : //   Float_t z = TMath::Abs(fkParam-&gt;GetZLength(0)-TMath::Abs(seed-&gt;GetZ()));
<span class="lineNum">    1051 </span>            : //   Int_t ctype = cl-&gt;GetType();  
<span class="lineNum">    1052 </span>            : //   Float_t padlength= GetPadPitchLength(seed-&gt;GetRow());
<span class="lineNum">    1053 </span>            : //   //
<span class="lineNum">    1054 </span>            : //   Double_t angle2 = seed-&gt;GetSnp()*seed-&gt;GetSnp();
<span class="lineNum">    1055 </span>            : //   //  if (angle2&lt;0.6) angle2 = 0.6;
<span class="lineNum">    1056 </span>            : //   angle2 = seed-&gt;GetTgl()*seed-&gt;GetTgl()*(1+angle2/(1-angle2)); 
<span class="lineNum">    1057 </span>            : //   //
<span class="lineNum">    1058 </span>            : //   //cluster &quot;quality&quot;
<span class="lineNum">    1059 </span>            : //   Int_t rsigmaz = int(100.*cl-&gt;GetSigmaZ2()/(seed-&gt;GetCurrentSigmaZ2()));
<span class="lineNum">    1060 </span>            : //   Float_t res;
<span class="lineNum">    1061 </span>            : //   //
<span class="lineNum">    1062 </span>            : //   if (fSectors==fInnerSec){
<span class="lineNum">    1063 </span>            : //     snoise2 = gnoise1;
<span class="lineNum">    1064 </span>            : //     res     = ggg1[amp]*z+glandau1[amp]*angle2;     
<span class="lineNum">    1065 </span>            : //     if (ctype==0) res *= gcor01[rsigmaz];
<span class="lineNum">    1066 </span>            : //     if ((ctype&gt;0)){
<span class="lineNum">    1067 </span>            : //       res+=0.002;
<span class="lineNum">    1068 </span>            : //       res*= gcorp[rsigmaz];
<span class="lineNum">    1069 </span>            : //     }
<span class="lineNum">    1070 </span>            : //   }
<span class="lineNum">    1071 </span>            : //   else {
<span class="lineNum">    1072 </span>            : //     if (padlength&lt;1.1){
<span class="lineNum">    1073 </span>            : //       snoise2 = gnoise2;
<span class="lineNum">    1074 </span>            : //       res     = ggg2[amp]*z+glandau2[amp]*angle2; 
<span class="lineNum">    1075 </span>            : //       if (ctype==0) res *= gcor02[rsigmaz];      
<span class="lineNum">    1076 </span>            : //       if ((ctype&gt;0)){
<span class="lineNum">    1077 </span>            : //      res+=0.002;
<span class="lineNum">    1078 </span>            : //      res*= gcorp[rsigmaz];
<span class="lineNum">    1079 </span>            : //       }
<span class="lineNum">    1080 </span>            : //     }
<span class="lineNum">    1081 </span>            : //     else{
<span class="lineNum">    1082 </span>            : //       snoise2 = gnoise3;      
<span class="lineNum">    1083 </span>            : //       res     = ggg3[amp]*z+glandau3[amp]*angle2; 
<span class="lineNum">    1084 </span>            : //       if (ctype==0) res *= gcor02[rsigmaz];
<span class="lineNum">    1085 </span>            : //       if ((ctype&gt;0)){
<span class="lineNum">    1086 </span>            : //      res+=0.002;
<span class="lineNum">    1087 </span>            : //      res*= gcorp[rsigmaz];
<span class="lineNum">    1088 </span>            : //       }
<span class="lineNum">    1089 </span>            : //     }
<span class="lineNum">    1090 </span>            : //   }  
<span class="lineNum">    1091 </span>            : 
<span class="lineNum">    1092 </span>            : //   if (ctype&lt;0){
<span class="lineNum">    1093 </span>            : //     res+=0.002;
<span class="lineNum">    1094 </span>            : //     res*=1.3;
<span class="lineNum">    1095 </span>            : //   }
<span class="lineNum">    1096 </span>            : //   if ((ctype&lt;0) &amp;&amp;amp&lt;70){
<span class="lineNum">    1097 </span>            : //     res+=0.002;
<span class="lineNum">    1098 </span>            : //     res*=1.3;  
<span class="lineNum">    1099 </span>            : //   }
<span class="lineNum">    1100 </span>            : //   res += snoise2;
<span class="lineNum">    1101 </span>            : //   if (res&lt;2*snoise2)
<span class="lineNum">    1102 </span>            : //      res = 2*snoise2;
<span class="lineNum">    1103 </span>            : //   if (res&gt;3) res =3;
<span class="lineNum">    1104 </span>            : //   seed-&gt;SetErrorZ2(res);
<span class="lineNum">    1105 </span>            : //   return res;
<span class="lineNum">    1106 </span>            : }
<span class="lineNum">    1107 </span>            : 
<span class="lineNum">    1108 </span>            : 
<span class="lineNum">    1109 </span>            : 
<a name="1110"><span class="lineNum">    1110 </span>            : </a>
<span class="lineNum">    1111 </span>            : 
<span class="lineNum">    1112 </span>            : void AliTPCtracker::RotateToLocal(AliTPCseed *seed)
<span class="lineNum">    1113 </span>            : {
<span class="lineNum">    1114 </span>            :   //rotate to track &quot;local coordinata
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :   Float_t x = seed-&gt;GetX();</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :   Float_t y = seed-&gt;GetY();</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :   Float_t ymax = x*TMath::Tan(0.5*fSectors-&gt;GetAlpha());</span>
<span class="lineNum">    1118 </span>            :   
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :   if (y &gt; ymax) {</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :     seed-&gt;SetRelativeSector((seed-&gt;GetRelativeSector()+1) % fN);</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :     if (!seed-&gt;Rotate(fSectors-&gt;GetAlpha())) </span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :   } else if (y &lt;-ymax) {</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :     seed-&gt;SetRelativeSector((seed-&gt;GetRelativeSector()-1+fN) % fN);</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :     if (!seed-&gt;Rotate(-fSectors-&gt;GetAlpha())) </span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    1127 </span>            :   }   
<span class="lineNum">    1128 </span>            : 
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1130 </span>            : 
<span class="lineNum">    1131 </span>            : 
<a name="1132"><span class="lineNum">    1132 </span>            : </a>
<span class="lineNum">    1133 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1134 </span>            : Double_t AliTPCtracker::F1old(Double_t x1,Double_t y1,
<span class="lineNum">    1135 </span>            :                    Double_t x2,Double_t y2,
<span class="lineNum">    1136 </span>            :                    Double_t x3,Double_t y3) const
<span class="lineNum">    1137 </span>            : {
<span class="lineNum">    1138 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1139 </span>            :   // Initial approximation of the track curvature
<span class="lineNum">    1140 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :   Double_t d=(x2-x1)*(y3-y2)-(x3-x2)*(y2-y1);</span>
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :   Double_t a=0.5*((y3-y2)*(y2*y2-y1*y1+x2*x2-x1*x1)-</span>
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :                   (y2-y1)*(y3*y3-y2*y2+x3*x3-x2*x2));</span>
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :   Double_t b=0.5*((x2-x1)*(y3*y3-y2*y2+x3*x3-x2*x2)-</span>
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :                   (x3-x2)*(y2*y2-y1*y1+x2*x2-x1*x1));</span>
<span class="lineNum">    1146 </span>            : 
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :   Double_t xr=TMath::Abs(d/(d*x1-a)), yr=d/(d*y1-b);</span>
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :   if ( xr*xr+yr*yr&lt;=0.00000000000001) return 100;</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :   return -xr*yr/sqrt(xr*xr+yr*yr); </span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1151 </span>            : 
<span class="lineNum">    1152 </span>            : 
<a name="1153"><span class="lineNum">    1153 </span>            : </a>
<span class="lineNum">    1154 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1155 </span>            : Double_t AliTPCtracker::F1(Double_t x1,Double_t y1,
<span class="lineNum">    1156 </span>            :                    Double_t x2,Double_t y2,
<span class="lineNum">    1157 </span>            :                    Double_t x3,Double_t y3) const
<span class="lineNum">    1158 </span>            : {
<span class="lineNum">    1159 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1160 </span>            :   // Initial approximation of the track curvature
<span class="lineNum">    1161 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1162 </span><span class="lineCov">       5144 :   x3 -=x1;</span>
<span class="lineNum">    1163 </span><span class="lineCov">       2572 :   x2 -=x1;</span>
<span class="lineNum">    1164 </span><span class="lineCov">       2572 :   y3 -=y1;</span>
<span class="lineNum">    1165 </span><span class="lineCov">       2572 :   y2 -=y1;</span>
<span class="lineNum">    1166 </span>            :   //  
<span class="lineNum">    1167 </span><span class="lineCov">       2572 :   Double_t det = x3*y2-x2*y3;</span>
<span class="lineNum">    1168 </span><span class="lineCov">       2572 :   if (TMath::Abs(det)&lt;1e-10){</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :     return 100;</span>
<span class="lineNum">    1170 </span>            :   }
<span class="lineNum">    1171 </span>            :   //
<span class="lineNum">    1172 </span><span class="lineCov">       2572 :   Double_t u = 0.5* (x2*(x2-x3)+y2*(y2-y3))/det;</span>
<span class="lineNum">    1173 </span><span class="lineCov">       2572 :   Double_t x0 = x3*0.5-y3*u;</span>
<span class="lineNum">    1174 </span><span class="lineCov">       2572 :   Double_t y0 = y3*0.5+x3*u;</span>
<span class="lineNum">    1175 </span><span class="lineCov">       2572 :   Double_t c2 = 1/TMath::Sqrt(x0*x0+y0*y0);</span>
<span class="lineNum">    1176 </span><span class="lineCov">       3854 :   if (det&lt;0) c2*=-1;</span>
<span class="lineNum">    1177 </span>            :   return c2;
<span class="lineNum">    1178 </span><span class="lineCov">       2572 : }</span>
<a name="1179"><span class="lineNum">    1179 </span>            : </a>
<span class="lineNum">    1180 </span>            : 
<span class="lineNum">    1181 </span>            : Double_t AliTPCtracker::F2(Double_t x1,Double_t y1,
<span class="lineNum">    1182 </span>            :                    Double_t x2,Double_t y2,
<span class="lineNum">    1183 </span>            :                    Double_t x3,Double_t y3) const 
<span class="lineNum">    1184 </span>            : {
<span class="lineNum">    1185 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1186 </span>            :   // Initial approximation of the track curvature
<span class="lineNum">    1187 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1188 </span><span class="lineCov">       5144 :   x3 -=x1;</span>
<span class="lineNum">    1189 </span><span class="lineCov">       2572 :   x2 -=x1;</span>
<span class="lineNum">    1190 </span><span class="lineCov">       2572 :   y3 -=y1;</span>
<span class="lineNum">    1191 </span><span class="lineCov">       2572 :   y2 -=y1;</span>
<span class="lineNum">    1192 </span>            :   //  
<span class="lineNum">    1193 </span><span class="lineCov">       2572 :   Double_t det = x3*y2-x2*y3;</span>
<span class="lineNum">    1194 </span><span class="lineCov">       2572 :   if (TMath::Abs(det)&lt;1e-10) {</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :     return 100;</span>
<span class="lineNum">    1196 </span>            :   }
<span class="lineNum">    1197 </span>            :   //
<span class="lineNum">    1198 </span><span class="lineCov">       2572 :   Double_t u = 0.5* (x2*(x2-x3)+y2*(y2-y3))/det;</span>
<span class="lineNum">    1199 </span><span class="lineCov">       2572 :   Double_t x0 = x3*0.5-y3*u; </span>
<span class="lineNum">    1200 </span><span class="lineCov">       2572 :   Double_t y0 = y3*0.5+x3*u;</span>
<span class="lineNum">    1201 </span><span class="lineCov">       2572 :   Double_t c2 = 1/TMath::Sqrt(x0*x0+y0*y0);</span>
<span class="lineNum">    1202 </span><span class="lineCov">       3854 :   if (det&lt;0) c2*=-1;</span>
<span class="lineNum">    1203 </span><span class="lineCov">       2572 :   x0+=x1;</span>
<span class="lineNum">    1204 </span><span class="lineCov">       2572 :   x0*=c2;  </span>
<span class="lineNum">    1205 </span>            :   return x0;
<span class="lineNum">    1206 </span><span class="lineCov">       2572 : }</span>
<span class="lineNum">    1207 </span>            : 
<span class="lineNum">    1208 </span>            : 
<a name="1209"><span class="lineNum">    1209 </span>            : </a>
<span class="lineNum">    1210 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1211 </span>            : Double_t AliTPCtracker::F2old(Double_t x1,Double_t y1,
<span class="lineNum">    1212 </span>            :                    Double_t x2,Double_t y2,
<span class="lineNum">    1213 </span>            :                    Double_t x3,Double_t y3) const
<span class="lineNum">    1214 </span>            : {
<span class="lineNum">    1215 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1216 </span>            :   // Initial approximation of the track curvature times center of curvature
<span class="lineNum">    1217 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :   Double_t d=(x2-x1)*(y3-y2)-(x3-x2)*(y2-y1);</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :   Double_t a=0.5*((y3-y2)*(y2*y2-y1*y1+x2*x2-x1*x1)-</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                   (y2-y1)*(y3*y3-y2*y2+x3*x3-x2*x2));</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :   Double_t b=0.5*((x2-x1)*(y3*y3-y2*y2+x3*x3-x2*x2)-</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :                   (x3-x2)*(y2*y2-y1*y1+x2*x2-x1*x1));</span>
<span class="lineNum">    1223 </span>            : 
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :   Double_t xr=TMath::Abs(d/(d*x1-a)), yr=d/(d*y1-b);</span>
<span class="lineNum">    1225 </span>            :   
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :   return -a/(d*y1-b)*xr/sqrt(xr*xr+yr*yr);</span>
<span class="lineNum">    1227 </span>            : }
<a name="1228"><span class="lineNum">    1228 </span>            : </a>
<span class="lineNum">    1229 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1230 </span>            : Double_t AliTPCtracker::F3(Double_t x1,Double_t y1, 
<span class="lineNum">    1231 </span>            :                    Double_t x2,Double_t y2,
<span class="lineNum">    1232 </span>            :                    Double_t z1,Double_t z2) const
<span class="lineNum">    1233 </span>            : {
<span class="lineNum">    1234 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1235 </span>            :   // Initial approximation of the tangent of the track dip angle
<span class="lineNum">    1236 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1237 </span><span class="lineCov">       5600 :   return (z1 - z2)/sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));</span>
<span class="lineNum">    1238 </span>            : }
<a name="1239"><span class="lineNum">    1239 </span>            : </a>
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span>            : Double_t AliTPCtracker::F3n(Double_t x1,Double_t y1, 
<span class="lineNum">    1242 </span>            :                    Double_t x2,Double_t y2,
<span class="lineNum">    1243 </span>            :                    Double_t z1,Double_t z2, Double_t c) const
<span class="lineNum">    1244 </span>            : {
<span class="lineNum">    1245 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1246 </span>            :   // Initial approximation of the tangent of the track dip angle
<span class="lineNum">    1247 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1248 </span>            : 
<span class="lineNum">    1249 </span>            :   //  Double_t angle1;
<span class="lineNum">    1250 </span>            :   
<span class="lineNum">    1251 </span>            :   //angle1    =  (z1-z2)*c/(TMath::ASin(c*x1-ni)-TMath::ASin(c*x2-ni));
<span class="lineNum">    1252 </span>            :   //
<span class="lineNum">    1253 </span><span class="lineCov">        944 :   Double_t d  =  TMath::Sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));</span>
<span class="lineNum">    1254 </span><span class="lineCov">        472 :   if (TMath::Abs(d*c*0.5)&gt;1) return 0;</span>
<span class="lineNum">    1255 </span><span class="lineCov">        472 :   Double_t   angle2    = asinf(d*c*0.5);</span>
<span class="lineNum">    1256 </span>            : 
<span class="lineNum">    1257 </span><span class="lineCov">        472 :   angle2  = (z1-z2)*c/(angle2*2.);</span>
<span class="lineNum">    1258 </span>            :   return angle2;
<a name="1259"><span class="lineNum">    1259 </span><span class="lineCov">        472 : }</span></a>
<span class="lineNum">    1260 </span>            : 
<span class="lineNum">    1261 </span>            : Bool_t   AliTPCtracker::GetProlongation(Double_t x1, Double_t x2, Double_t x[5], Double_t &amp;y, Double_t &amp;z) const
<span class="lineNum">    1262 </span>            : {//-----------------------------------------------------------------
<span class="lineNum">    1263 </span>            :   // This function find proloncation of a track to a reference plane x=x2.
<span class="lineNum">    1264 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1265 </span>            :   
<span class="lineNum">    1266 </span><span class="lineCov">        668 :   Double_t dx=x2-x1;</span>
<span class="lineNum">    1267 </span><span class="lineCov">        334 :   Double_t c1=x[4]*x1 - x[2];</span>
<span class="lineNum">    1268 </span><span class="lineCov">        334 :   if (TMath::Abs(c1) &gt;= 0.999) return kFALSE;</span>
<span class="lineNum">    1269 </span><span class="lineCov">        334 :   Double_t c2=x[4]*x2 - x[2];</span>
<span class="lineNum">    1270 </span><span class="lineCov">        334 :   if (TMath::Abs(c2) &gt;= 0.999) return kFALSE;</span>
<span class="lineNum">    1271 </span><span class="lineCov">        334 :   Double_t r1=TMath::Sqrt((1.-c1)*(1.+c1)),r2=TMath::Sqrt((1.-c2)*(1.+c2));  </span>
<span class="lineNum">    1272 </span><span class="lineCov">        334 :   y = x[0];</span>
<span class="lineNum">    1273 </span><span class="lineCov">        334 :   z = x[1];</span>
<span class="lineNum">    1274 </span>            :   
<span class="lineNum">    1275 </span><span class="lineCov">        334 :   Double_t dy = dx*(c1+c2)/(r1+r2);</span>
<span class="lineNum">    1276 </span>            :   //
<span class="lineNum">    1277 </span><span class="lineCov">        334 :   Double_t delta = x[4]*dx*(c1+c2)/(c1*r2 + c2*r1);</span>
<span class="lineNum">    1278 </span><span class="lineCov">        334 :   Double_t dz = x[3]*asinf(delta)/x[4];</span>
<span class="lineNum">    1279 </span>            :   
<span class="lineNum">    1280 </span><span class="lineCov">        334 :   y+=dy;</span>
<span class="lineNum">    1281 </span><span class="lineCov">        334 :   z+=dz;</span>
<span class="lineNum">    1282 </span>            :   
<span class="lineNum">    1283 </span>            :   return kTRUE;  
<a name="1284"><span class="lineNum">    1284 </span><span class="lineCov">        334 : }</span></a>
<span class="lineNum">    1285 </span>            : 
<span class="lineNum">    1286 </span>            : Bool_t   AliTPCtracker::GetProlongationLine(Double_t x1, Double_t x2, Double_t x[5], Double_t &amp;y, Double_t &amp;z) const
<span class="lineNum">    1287 </span>            : {//-----------------------------------------------------------------
<span class="lineNum">    1288 </span>            :   // This function find straight line prolongation of a track to a reference plane x=x2.
<span class="lineNum">    1289 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    1290 </span>            :   
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :   if (TMath::Abs(x[2]) &gt;= 0.999) return kFALSE;</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :   Double_t c1=- x[2], dx2r = (x2-x1)/TMath::Sqrt((1.-c1)*(1.+c1));</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :   y = x[0] + dx2r*c1;</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :   z = x[1] + dx2r*x[3];</span>
<span class="lineNum">    1295 </span>            :   return kTRUE;  
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 : }</span>
<a name="1297"><span class="lineNum">    1297 </span>            : </a>
<span class="lineNum">    1298 </span>            : 
<span class="lineNum">    1299 </span>            : Int_t  AliTPCtracker::LoadClusters (TTree *const tree)
<span class="lineNum">    1300 </span>            : {
<span class="lineNum">    1301 </span>            :   // load clusters
<span class="lineNum">    1302 </span>            :   //
<span class="lineNum">    1303 </span><span class="lineCov">         16 :   fInput = tree;</span>
<span class="lineNum">    1304 </span><span class="lineCov">          8 :   return LoadClusters();</span>
<span class="lineNum">    1305 </span>            : }
<a name="1306"><span class="lineNum">    1306 </span>            : </a>
<span class="lineNum">    1307 </span>            : 
<span class="lineNum">    1308 </span>            : Int_t  AliTPCtracker::LoadClusters(const TObjArray *arr)
<span class="lineNum">    1309 </span>            : {
<span class="lineNum">    1310 </span>            :   //
<span class="lineNum">    1311 </span>            :   // load clusters to the memory
<span class="lineNum">    1312 </span>            :   AliTPCClustersRow *clrow = 0; //RS: why this new? new AliTPCClustersRow(&quot;AliTPCclusterMI&quot;);
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :   Int_t lower   = arr-&gt;LowerBound();</span>
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :   Int_t entries = arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    1315 </span>            : 
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :   AliTPCcalibDB * calibDB = AliTPCcalibDB::Instance();</span>
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :   AliTPCTransform *transform = calibDB-&gt;GetTransform() ;</span>
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentRecoParam((AliTPCRecoParam*)AliTPCReconstructor::GetRecoParam());</span>
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentTimeStamp( GetTimeStamp());</span>
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentRun( GetRunNumber() );</span>
<span class="lineNum">    1321 </span>            : 
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :   AliWarning(&quot;Sector Change ins not checked in LoadClusters(const TObjArray *arr)&quot;);</span>
<span class="lineNum">    1323 </span>            : 
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :   for (Int_t i=lower; i&lt;entries; i++) {</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :     clrow = (AliTPCClustersRow*) arr-&gt;At(i);</span>
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :     if(!clrow) continue;</span>
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :     TClonesArray* arr = clrow-&gt;GetArray();</span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :     if(!arr) continue;</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :     int ncl = arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :     if (ncl&lt;1) continue;</span>
<span class="lineNum">    1331 </span>            :     //  
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :     Int_t sec,row;</span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :     fkParam-&gt;AdjustSectorRow(clrow-&gt;GetID(),sec,row);</span>
<span class="lineNum">    1334 </span>            :     
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :     for (Int_t icl=ncl; icl--;) {</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :       Transform((AliTPCclusterMI*)(arr-&gt;At(icl)));</span>
<span class="lineNum">    1337 </span>            :     }
<span class="lineNum">    1338 </span>            :     //
<span class="lineNum">    1339 </span>            :     // RS: Check for possible sector change due to the distortions: TODO
<span class="lineNum">    1340 </span>            :     //
<span class="lineNum">    1341 </span>            :     AliTPCtrackerRow * tpcrow=0;
<span class="lineNum">    1342 </span>            :     Int_t left=0;
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :     if (sec&lt;fkNIS*2){</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :       tpcrow = &amp;(fInnerSec[sec%fkNIS][row]);    </span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :       left = sec/fkNIS;</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1347 </span>            :     else{
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :       tpcrow = &amp;(fOuterSec[(sec-fkNIS*2)%fkNOS][row]);</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :       left = (sec-fkNIS*2)/fkNOS;</span>
<span class="lineNum">    1350 </span>            :     }
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :     if (left ==0){</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :       tpcrow-&gt;SetN1(ncl);</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :       for (Int_t j=0;j&lt;ncl;++j) </span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :         tpcrow-&gt;SetCluster1(j, *(AliTPCclusterMI*)(arr-&gt;At(j)));</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :     if (left ==1){</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :       tpcrow-&gt;SetN2(ncl);</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :       for (Int_t j=0;j&lt;ncl;++j) </span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :         tpcrow-&gt;SetCluster2(j, *(AliTPCclusterMI*)(arr-&gt;At(j)));</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :     clrow-&gt;GetArray()-&gt;Clear(); // RS AliTPCclusterMI does not allocate memory</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1363 </span>            :   //
<span class="lineNum">    1364 </span>            :   //  delete clrow;
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :   LoadOuterSectors();</span>
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :   LoadInnerSectors();</span>
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="1368"><span class="lineNum">    1368 </span>            : }</a>
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span>            : Int_t  AliTPCtracker::LoadClusters(const TClonesArray *arr)
<span class="lineNum">    1371 </span>            : {
<span class="lineNum">    1372 </span>            :   //
<span class="lineNum">    1373 </span>            :   // load clusters to the memory from one 
<span class="lineNum">    1374 </span>            :   // TClonesArray
<span class="lineNum">    1375 </span>            :   //
<span class="lineNum">    1376 </span>            :   // RS: Check for possible sector change due to the distortions: TODO
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :   AliWarning(&quot;Sector Change ins not checked in LoadClusters(const TClonesArray *arr)&quot;);</span>
<span class="lineNum">    1378 </span>            :   //
<span class="lineNum">    1379 </span>            : 
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :   AliTPCcalibDB * calibDB = AliTPCcalibDB::Instance();</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :   AliTPCTransform *transform = calibDB-&gt;GetTransform() ;</span>
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentRecoParam((AliTPCRecoParam*)AliTPCReconstructor::GetRecoParam());</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentTimeStamp( GetTimeStamp());</span>
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentRun( GetRunNumber() );</span>
<span class="lineNum">    1385 </span>            :   //
<span class="lineNum">    1386 </span>            :   AliTPCclusterMI *clust=0;
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :   Int_t count[72][96] = { {0} , {0} }; </span>
<span class="lineNum">    1388 </span>            : 
<span class="lineNum">    1389 </span>            :   // loop over clusters
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :   for (Int_t icl=0; icl&lt;arr-&gt;GetEntriesFast(); icl++) {</span>
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :     clust = (AliTPCclusterMI*)arr-&gt;At(icl);</span>
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :     if(!clust) continue;</span>
<span class="lineNum">    1393 </span>            :     //printf(&quot;cluster: det %d, row %d \n&quot;, clust-&gt;GetDetector(),clust-&gt;GetRow());
<span class="lineNum">    1394 </span>            : 
<span class="lineNum">    1395 </span>            :     // transform clusters
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :     Transform(clust);</span>
<span class="lineNum">    1397 </span>            : 
<span class="lineNum">    1398 </span>            :     // count clusters per pad row
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :     count[clust-&gt;GetDetector()][clust-&gt;GetRow()]++;</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1401 </span>            : 
<span class="lineNum">    1402 </span>            :   // insert clusters to sectors
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :   for (Int_t icl=0; icl&lt;arr-&gt;GetEntriesFast(); icl++) {</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :     clust = (AliTPCclusterMI*)arr-&gt;At(icl);</span>
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :     if(!clust) continue;</span>
<span class="lineNum">    1406 </span>            : 
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :     Int_t sec = clust-&gt;GetDetector();</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :     Int_t row = clust-&gt;GetRow();</span>
<span class="lineNum">    1409 </span>            : 
<span class="lineNum">    1410 </span>            :     // filter overlapping pad rows needed by HLT
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :     if(sec&lt;fkNIS*2) { //IROCs</span>
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :      if(row == 30) continue;</span>
<span class="lineNum">    1413 </span>            :     }
<span class="lineNum">    1414 </span>            :     else { // OROCs
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :       if(row == 27 || row == 76) continue;</span>
<span class="lineNum">    1416 </span>            :     }
<span class="lineNum">    1417 </span>            : 
<span class="lineNum">    1418 </span>            :     //    Int_t left=0;
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :     if (sec&lt;fkNIS*2){</span>
<span class="lineNum">    1420 </span>            :       //      left = sec/fkNIS;
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :       fInnerSec[sec%fkNIS].InsertCluster(clust, count[sec][row], fkParam);    </span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1423 </span>            :     else{
<span class="lineNum">    1424 </span>            :       //      left = (sec-fkNIS*2)/fkNOS;
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :       fOuterSec[(sec-fkNIS*2)%fkNOS].InsertCluster(clust, count[sec][row], fkParam);</span>
<span class="lineNum">    1426 </span>            :     }
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1428 </span>            : 
<span class="lineNum">    1429 </span>            :   // Load functions must be called behind LoadCluster(TClonesArray*)
<span class="lineNum">    1430 </span>            :   // needed by HLT
<span class="lineNum">    1431 </span>            :   //LoadOuterSectors();
<span class="lineNum">    1432 </span>            :   //LoadInnerSectors();
<span class="lineNum">    1433 </span>            : 
<span class="lineNum">    1434 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="1435"><span class="lineNum">    1435 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1436 </span>            : 
<span class="lineNum">    1437 </span>            : Int_t  AliTPCtracker::LoadClusters()
<span class="lineNum">    1438 </span>            : {
<span class="lineNum">    1439 </span>            :  //
<span class="lineNum">    1440 </span>            :   // load clusters to the memory
<span class="lineNum">    1441 </span><span class="lineCov">         24 :   static AliTPCClustersRow *clrow= new AliTPCClustersRow(&quot;AliTPCclusterMI&quot;);</span>
<span class="lineNum">    1442 </span>            :   //
<span class="lineNum">    1443 </span>            : 
<span class="lineNum">    1444 </span><span class="lineCov">          8 :   AliTPCcalibDB * calibDB = AliTPCcalibDB::Instance();</span>
<span class="lineNum">    1445 </span><span class="lineCov">          8 :   AliTPCTransform *transform = calibDB-&gt;GetTransform() ;</span>
<span class="lineNum">    1446 </span><span class="lineCov">          8 :   transform-&gt;SetCurrentRecoParam((AliTPCRecoParam*)AliTPCReconstructor::GetRecoParam());</span>
<span class="lineNum">    1447 </span><span class="lineCov">          8 :   transform-&gt;SetCurrentTimeStamp( GetTimeStamp());</span>
<span class="lineNum">    1448 </span><span class="lineCov">          8 :   transform-&gt;SetCurrentRun( GetRunNumber() );</span>
<span class="lineNum">    1449 </span>            : 
<span class="lineNum">    1450 </span>            :   //  TTree * tree = fClustersArray.GetTree();
<span class="lineNum">    1451 </span><span class="lineCov">          8 :   AliInfo(&quot;LoadClusters()\n&quot;);</span>
<span class="lineNum">    1452 </span>            : 
<span class="lineNum">    1453 </span><span class="lineCov">          8 :   fNClusters = 0;</span>
<span class="lineNum">    1454 </span>            : 
<span class="lineNum">    1455 </span><span class="lineCov">          8 :   TTree * tree = fInput;</span>
<span class="lineNum">    1456 </span><span class="lineCov">          8 :   TBranch * br = tree-&gt;GetBranch(&quot;Segment&quot;);</span>
<span class="lineNum">    1457 </span><span class="lineCov">          8 :   br-&gt;SetAddress(&amp;clrow);</span>
<span class="lineNum">    1458 </span>            : 
<span class="lineNum">    1459 </span>            :   // Conversion of pad, row coordinates in local tracking coords.
<span class="lineNum">    1460 </span>            :   // Could be skipped here; is already done in clusterfinder
<span class="lineNum">    1461 </span>            : 
<span class="lineNum">    1462 </span><span class="lineCov">          8 :   double cutZ2X = AliTPCReconstructor::GetPrimaryZ2XCut();</span>
<span class="lineNum">    1463 </span><span class="lineCov">          8 :   double cutZOutSector = AliTPCReconstructor::GetZOutSectorCut();</span>
<span class="lineNum">    1464 </span><span class="lineCov">          8 :   if (cutZOutSector&gt;0 &amp;&amp; AliTPCReconstructor::GetExtendedRoads()) </span>
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :     cutZOutSector += AliTPCReconstructor::GetExtendedRoads()[1];</span>
<span class="lineNum">    1466 </span>            :   //
<span class="lineNum">    1467 </span><span class="lineCov">          8 :   if (cutZ2X&gt;0 || cutZOutSector&gt;0) {</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :     AliInfoF(&quot;Cut on cluster |Z/X| : %s, on cluster Z on wrong CE side: %s&quot;,</span>
<span class="lineNum">    1469 </span>            :              cutZ2X&gt;0        ? Form(&quot;%.3f&quot;,cutZ2X) : &quot;N/A&quot;,
<span class="lineNum">    1470 </span>            :              cutZOutSector&gt;0 ? Form(&quot;%.3f&quot;,cutZOutSector) : &quot;N/A&quot;);
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1472 </span><span class="lineCov">          8 :   Int_t j=Int_t(tree-&gt;GetEntries());</span>
<span class="lineNum">    1473 </span><span class="lineCov">      91474 :   for (Int_t i=0; i&lt;j; i++) {</span>
<span class="lineNum">    1474 </span><span class="lineCov">      45729 :     br-&gt;GetEntry(i);</span>
<span class="lineNum">    1475 </span>            :     //
<span class="lineNum">    1476 </span><span class="lineCov">      45729 :     TClonesArray* clArr = clrow-&gt;GetArray();</span>
<span class="lineNum">    1477 </span><span class="lineCov">      45729 :     int nClus = clArr-&gt;GetEntriesFast();</span>
<span class="lineNum">    1478 </span><span class="lineCov">      45729 :     Int_t sec,row;</span>
<span class="lineNum">    1479 </span><span class="lineCov">      45729 :     fkParam-&gt;AdjustSectorRow(clrow-&gt;GetID(),sec,row);</span>
<span class="lineNum">    1480 </span><span class="lineCov">     221354 :     for (Int_t icl=nClus; icl--;) Transform((AliTPCclusterMI*)(clArr-&gt;At(icl)));</span>
<span class="lineNum">    1481 </span>            :     //
<span class="lineNum">    1482 </span>            :     AliTPCtrackerRow * tpcrow=0;
<span class="lineNum">    1483 </span>            :     Int_t left=0;
<span class="lineNum">    1484 </span><span class="lineCov">      45729 :     if (sec&lt;fkNIS*2){</span>
<span class="lineNum">    1485 </span><span class="lineCov">      18081 :       tpcrow = &amp;(fInnerSec[sec%fkNIS][row]);    </span>
<span class="lineNum">    1486 </span><span class="lineCov">      18081 :       left = sec/fkNIS;</span>
<span class="lineNum">    1487 </span><span class="lineCov">      18081 :     }</span>
<span class="lineNum">    1488 </span>            :     else{
<span class="lineNum">    1489 </span><span class="lineCov">      27648 :       tpcrow = &amp;(fOuterSec[(sec-fkNIS*2)%fkNOS][row]);</span>
<span class="lineNum">    1490 </span><span class="lineCov">      27648 :       left = (sec-fkNIS*2)/fkNOS;</span>
<span class="lineNum">    1491 </span>            :     }
<span class="lineNum">    1492 </span>            :     int nClusAdd = 0;
<span class="lineNum">    1493 </span><span class="lineCov">      45729 :     if (left ==0){  // A side     </span>
<span class="lineNum">    1494 </span><span class="lineCov">     113132 :       for (int k=0;k&lt;nClus;k++) {</span>
<span class="lineNum">    1495 </span><span class="lineCov">      33670 :         const AliTPCclusterMI&amp; cl = *((AliTPCclusterMI*)clArr-&gt;At(k));</span>
<span class="lineNum">    1496 </span><span class="lineCov">      33670 :         if (cutZOutSector&gt;0 &amp;&amp; cl.GetZ()&lt;-cutZOutSector) continue;</span>
<span class="lineNum">    1497 </span><span class="lineCov">      33670 :         if (cutZ2X&gt;0 &amp;&amp; cl.GetZ()/cl.GetX() &gt; cutZ2X) continue;</span>
<span class="lineNum">    1498 </span><span class="lineCov">      33670 :         tpcrow-&gt;SetCluster1(nClusAdd++, cl);</span>
<span class="lineNum">    1499 </span><span class="lineCov">      33670 :       }</span>
<span class="lineNum">    1500 </span><span class="lineCov">      22896 :       tpcrow-&gt;SetN1(nClusAdd);</span>
<span class="lineNum">    1501 </span><span class="lineCov">      22896 :     }</span>
<span class="lineNum">    1502 </span><span class="lineCov">      45729 :     if (left ==1){ // C side</span>
<span class="lineNum">    1503 </span><span class="lineCov">     108222 :       for (int k=0;k&lt;nClus;k++) {</span>
<span class="lineNum">    1504 </span><span class="lineCov">      31278 :         const AliTPCclusterMI&amp; cl = *((AliTPCclusterMI*)clArr-&gt;At(k));</span>
<span class="lineNum">    1505 </span><span class="lineCov">      31278 :         if (cutZOutSector&gt;0 &amp;&amp; cl.GetZ()&gt;cutZOutSector) continue;</span>
<span class="lineNum">    1506 </span><span class="lineCov">      31278 :         if (cutZ2X&gt;0 &amp;&amp; cl.GetZ()/cl.GetX() &lt; -cutZ2X) continue;</span>
<span class="lineNum">    1507 </span><span class="lineCov">      31278 :         tpcrow-&gt;SetCluster2(nClusAdd++, cl);</span>
<span class="lineNum">    1508 </span><span class="lineCov">      31278 :       }</span>
<span class="lineNum">    1509 </span><span class="lineCov">      22833 :       tpcrow-&gt;SetN2(nClusAdd);</span>
<span class="lineNum">    1510 </span><span class="lineCov">      22833 :     }</span>
<span class="lineNum">    1511 </span><span class="lineCov">      45729 :     fNClusters += nClusAdd;</span>
<span class="lineNum">    1512 </span><span class="lineCov">      45729 :   }</span>
<span class="lineNum">    1513 </span>            :   //
<span class="lineNum">    1514 </span>            :   //clrow-&gt;Clear(&quot;C&quot;);
<span class="lineNum">    1515 </span><span class="lineCov">          8 :   clrow-&gt;Clear(); // RS AliTPCclusterMI does not allocate memory</span>
<span class="lineNum">    1516 </span><span class="lineCov">          8 :   LoadOuterSectors();</span>
<span class="lineNum">    1517 </span><span class="lineCov">          8 :   LoadInnerSectors();</span>
<span class="lineNum">    1518 </span>            : 
<span class="lineNum">    1519 </span><span class="lineCov">          8 :   cout &lt;&lt; &quot; =================================================================================================================================== &quot; &lt;&lt; endl;</span>
<span class="lineNum">    1520 </span><span class="lineCov">          8 :   cout &lt;&lt; &quot; AliTPCReconstructor::GetRecoParam()-&gt;GetUseIonTailCorrection() =  &quot; &lt;&lt; AliTPCReconstructor::GetRecoParam()-&gt;GetUseIonTailCorrection() &lt;&lt; endl;</span>
<span class="lineNum">    1521 </span><span class="lineCov">          8 :   cout &lt;&lt; &quot; AliTPCReconstructor::GetRecoParam()-&gt;GetCrosstalkCorrection()  =  &quot; &lt;&lt; AliTPCReconstructor::GetRecoParam()-&gt;GetCrosstalkCorrection()  &lt;&lt; endl;</span>
<span class="lineNum">    1522 </span><span class="lineCov">          8 :   cout &lt;&lt; &quot; =================================================================================================================================== &quot; &lt;&lt; endl;</span>
<span class="lineNum">    1523 </span>            : 
<span class="lineNum">    1524 </span><span class="lineCov">          8 :   if (AliTPCReconstructor::GetRecoParam()-&gt;GetUseIonTailCorrection()) ApplyTailCancellation();</span>
<span class="lineNum">    1525 </span><span class="lineCov">          8 :   if (AliTPCReconstructor::GetRecoParam()-&gt;GetCrosstalkCorrection()!=0.) CalculateXtalkCorrection();</span>
<span class="lineNum">    1526 </span><span class="lineCov">          8 :   if (AliTPCReconstructor::GetRecoParam()-&gt;GetCrosstalkCorrection()!=0.) ApplyXtalkCorrection();</span>
<span class="lineNum">    1527 </span>            :   //if (AliTPCReconstructor::GetRecoParam()-&gt;GetUseOulierClusterFilter()) FilterOutlierClusters();  
<span class="lineNum">    1528 </span>            : 
<span class="lineNum">    1529 </span>            :   /*
<span class="lineNum">    1530 </span>            :   static int maxClus[18][2][kMaxRow]={0};
<span class="lineNum">    1531 </span>            :   int maxAcc=0,nclEv=0, capacity=0;
<span class="lineNum">    1532 </span>            :   for (int isec=0;isec&lt;18;isec++) {
<span class="lineNum">    1533 </span>            :     for (int irow=0;irow&lt;kMaxRow;irow++) {
<span class="lineNum">    1534 </span>            :       AliTPCtrackerRow * tpcrow = irow&gt;62 ?  &amp;(fOuterSec[isec][irow-63]) : &amp;(fInnerSec[isec][irow]);
<span class="lineNum">    1535 </span>            :       maxClus[isec][0][irow] = TMath::Max(maxClus[isec][0][irow], tpcrow-&gt;GetN1());
<span class="lineNum">    1536 </span>            :       maxClus[isec][1][irow] = TMath::Max(maxClus[isec][1][irow], tpcrow-&gt;GetN2());
<span class="lineNum">    1537 </span>            :       maxAcc += maxClus[isec][0][irow]+maxClus[isec][1][irow];
<span class="lineNum">    1538 </span>            :       nclEv += tpcrow-&gt;GetN();
<span class="lineNum">    1539 </span>            :       capacity += tpcrow-&gt;GetClusters1()-&gt;Capacity();
<span class="lineNum">    1540 </span>            :       capacity += tpcrow-&gt;GetClusters2()-&gt;Capacity();
<span class="lineNum">    1541 </span>            :     }
<span class="lineNum">    1542 </span>            :   }
<span class="lineNum">    1543 </span>            :   printf(&quot;RS:AccumulatedSpace: %d for %d | pointers: %d\n&quot;,maxAcc,nclEv,capacity);
<span class="lineNum">    1544 </span>            :   */
<span class="lineNum">    1545 </span><span class="lineCov">          8 :   return 0;</span>
<a name="1546"><span class="lineNum">    1546 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1547 </span>            : 
<span class="lineNum">    1548 </span>            : void  AliTPCtracker::CalculateXtalkCorrection(){
<span class="lineNum">    1549 </span>            :   //
<span class="lineNum">    1550 </span>            :   // Calculate crosstalk estimate
<span class="lineNum">    1551 </span>            :   //
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :   TStopwatch sw;</span>
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :   sw.Start();</span>
<span class="lineNum">    1554 </span>            :   const Int_t nROCs   = 72;
<span class="lineNum">    1555 </span>            :   const Int_t   nIterations=3;  // 
<span class="lineNum">    1556 </span>            :   // 0.) reset crosstalk matrix 
<span class="lineNum">    1557 </span>            :   //
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :   for (Int_t isector=0; isector&lt;nROCs*4; isector++){  //set all ellemts of crosstalk matrix to 0 </span>
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 :     TMatrixD * crossTalkMatrix = (TMatrixD*)fCrossTalkSignalArray-&gt;At(isector);</span>
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :     if (crossTalkMatrix)(*crossTalkMatrix)*=0;</span>
<span class="lineNum">    1561 </span>            :   }
<span class="lineNum">    1562 </span>            :   
<span class="lineNum">    1563 </span>            :   //
<span class="lineNum">    1564 </span>            :   // 1.) Filling part -- loop over clusters
<span class="lineNum">    1565 </span>            :   //
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :   Double_t missingChargeFactor= AliTPCReconstructor::GetRecoParam()-&gt;GetCrosstalkCorrectionMissingCharge();</span>
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :   for (Int_t iter=0; iter&lt;nIterations;iter++){</span>
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :     for (Int_t isector=0; isector&lt;36; isector++){      // loop over sectors</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :       for (Int_t iside=0; iside&lt;2; iside++){           // loop over sides A/C</span>
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :         AliTPCtrackerSector &amp;sector= (isector&lt;18)?fInnerSec[isector%18]:fOuterSec[isector%18];</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :         Int_t nrows = sector.GetNRows();</span>
<span class="lineNum">    1572 </span>            :         Int_t sec=0;
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :         if (isector&lt;18) sec=isector+18*iside;</span>
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :         if (isector&gt;=18) sec=18+isector+18*iside;</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :         for (Int_t row = 0;row&lt;nrows;row++){           // loop over rows       </span>
<span class="lineNum">    1576 </span>            :           //
<span class="lineNum">    1577 </span>            :           //
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :           Int_t wireSegmentID     = fkParam-&gt;GetWireSegment(sec,row);</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :           Float_t nPadsPerSegment = (Float_t)(fkParam-&gt;GetNPadsPerSegment(wireSegmentID));</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :           TMatrixD &amp;crossTalkSignal =  *((TMatrixD*)fCrossTalkSignalArray-&gt;At(sec));</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :           TMatrixD &amp;crossTalkSignalCache =  *((TMatrixD*)fCrossTalkSignalArray-&gt;At(sec+nROCs*2));   // this is the cache value of the crosstalk from previous iteration</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :           TMatrixD &amp;crossTalkSignalBelow =  *((TMatrixD*)fCrossTalkSignalArray-&gt;At(sec+nROCs));</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :           Int_t nCols=crossTalkSignal.GetNcols();</span>
<span class="lineNum">    1584 </span>            :           //
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :           AliTPCtrackerRow&amp;  tpcrow = sector[row];       </span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :           Int_t ncl = tpcrow.GetN1();                  // number of clusters in the row</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :           if (iside&gt;0) ncl=tpcrow.GetN2();</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :           for (Int_t i=0;i&lt;ncl;i++) {  // loop over clusters</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :             AliTPCclusterMI *clXtalk= (iside&gt;0)?(tpcrow.GetCluster2(i)):(tpcrow.GetCluster1(i));</span>
<span class="lineNum">    1590 </span>            :             
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :             Int_t timeBinXtalk = clXtalk-&gt;GetTimeBin();      </span>
<span class="lineNum">    1592 </span><span class="lineNoCov">          0 :             Double_t rmsPadMin2=0.5*0.5+(fkParam-&gt;GetDiffT()*fkParam-&gt;GetDiffT())*(TMath::Abs((clXtalk-&gt;GetZ()-fkParam-&gt;GetZLength())))/(fkParam-&gt;GetPadPitchWidth(sec)*fkParam-&gt;GetPadPitchWidth(sec)); // minimal PRF width - 0.5 is the PRF in the pad units - we should et it from fkparam getters </span>
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :             Double_t rmsTimeMin2=1+(fkParam-&gt;GetDiffL()*fkParam-&gt;GetDiffL())*(TMath::Abs((clXtalk-&gt;GetZ()-fkParam-&gt;GetZLength())))/(fkParam-&gt;GetZWidth()*fkParam-&gt;GetZWidth()); // minimal PRF width - 1 is the TRF in the time bin units - we should et it from fkParam getters</span>
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :             Double_t rmsTime2   = clXtalk-&gt;GetSigmaZ2()/(fkParam-&gt;GetZWidth()*fkParam-&gt;GetZWidth()); </span>
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :             Double_t rmsPad2    = clXtalk-&gt;GetSigmaY2()/(fkParam-&gt;GetPadPitchWidth(sec)*fkParam-&gt;GetPadPitchWidth(sec)); </span>
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :             if (rmsPadMin2&gt;rmsPad2){</span>
<span class="lineNum">    1597 </span>            :               rmsPad2=rmsPadMin2;
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :             if (rmsTimeMin2&gt;rmsTime2){</span>
<span class="lineNum">    1600 </span>            :               rmsTime2=rmsTimeMin2;
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1602 </span>            :             
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :             Double_t norm= 2.*TMath::Exp(-1.0/(2.*rmsTime2))+2.*TMath::Exp(-4.0/(2.*rmsTime2))+1.;</span>
<span class="lineNum">    1604 </span>            :             Double_t qTotXtalk = 0.;   
<span class="lineNum">    1605 </span>            :             Double_t qTotXtalkMissing = 0.;   
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :             for (Int_t itb=timeBinXtalk-2, idelta=-2; itb&lt;=timeBinXtalk+2; itb++,idelta++) {        </span>
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :               if (itb&lt;0 || itb&gt;=nCols) continue;</span>
<span class="lineNum">    1608 </span>            :               Double_t missingCharge=0;
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :               Double_t trf= TMath::Exp(-idelta*idelta/(2.*rmsTime2));</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :               if (missingChargeFactor&gt;0) {</span>
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 :                 for (Int_t dpad=-2; dpad&lt;=2; dpad++){</span>
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :                   Double_t qPad =   clXtalk-&gt;GetMax()*TMath::Exp(-dpad*dpad/(2.*rmsPad2))*trf;</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :                   if (TMath::Nint(qPad-crossTalkSignalCache[wireSegmentID][itb])&lt;=fkParam-&gt;GetZeroSup()){</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :                     missingCharge+=qPad+crossTalkSignalCache[wireSegmentID][itb];</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :                   }else{</span>
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :                     missingCharge+=crossTalkSignalCache[wireSegmentID][itb];</span>
<span class="lineNum">    1617 </span>            :                   }
<span class="lineNum">    1618 </span>            :                 }
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :               }</span>
<span class="lineNum">    1620 </span><span class="lineNoCov">          0 :               qTotXtalk = clXtalk-&gt;GetQ()*trf/norm+missingCharge*missingChargeFactor;</span>
<span class="lineNum">    1621 </span>            :               qTotXtalkMissing = missingCharge;
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :               crossTalkSignal[wireSegmentID][itb]+= qTotXtalk/nPadsPerSegment; </span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :               crossTalkSignalBelow[wireSegmentID][itb]+= qTotXtalkMissing/nPadsPerSegment; </span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :             } // end of time bin loop</span>
<span class="lineNum">    1625 </span>            :           } // end of cluster loop      
<span class="lineNum">    1626 </span>            :         } // end of rows loop
<span class="lineNum">    1627 </span>            :       }  // end of side loop
<span class="lineNum">    1628 </span>            :     }    // end of sector loop
<span class="lineNum">    1629 </span>            :     //
<span class="lineNum">    1630 </span>            :     // copy crosstalk matrix to cached used for next itteration
<span class="lineNum">    1631 </span>            :     //
<span class="lineNum">    1632 </span>            :     //
<span class="lineNum">    1633 </span>            :     // 2.) dump the crosstalk matrices to tree for further investigation
<span class="lineNum">    1634 </span>            :     //     a.) to estimate fluctuation of pedestal in indiviula wire segments
<span class="lineNum">    1635 </span>            :     //     b.) to check correlation between regions
<span class="lineNum">    1636 </span>            :     //     c.) to check relative conribution of signal below threshold to crosstalk
<span class="lineNum">    1637 </span>            :     
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :     if (AliTPCReconstructor::StreamLevel()&amp;kStreamCrosstalkMatrix) {</span>
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :       for (Int_t isector=0; isector&lt;nROCs; isector++){  //set all ellemts of crosstalk matrix to 0</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :         TMatrixD * crossTalkMatrix = (TMatrixD*)fCrossTalkSignalArray-&gt;At(isector);</span>
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :         TMatrixD * crossTalkMatrixBelow = (TMatrixD*)fCrossTalkSignalArray-&gt;At(isector+nROCs);</span>
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :         TMatrixD * crossTalkMatrixCache = (TMatrixD*)fCrossTalkSignalArray-&gt;At(isector+nROCs*2);</span>
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :         TVectorD vecAll(crossTalkMatrix-&gt;GetNrows());</span>
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :         TVectorD vecBelow(crossTalkMatrix-&gt;GetNrows());</span>
<span class="lineNum">    1645 </span><span class="lineNoCov">          0 :         TVectorD vecCache(crossTalkMatrixCache-&gt;GetNrows());</span>
<span class="lineNum">    1646 </span>            :         //
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :         for (Int_t itime=0; itime&lt;crossTalkMatrix-&gt;GetNcols(); itime++){</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :           for (Int_t iwire=0; iwire&lt;crossTalkMatrix-&gt;GetNrows(); iwire++){</span>
<span class="lineNum">    1649 </span><span class="lineNoCov">          0 :             vecAll[iwire]=(*crossTalkMatrix)(iwire,itime);</span>
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :             vecBelow[iwire]=(*crossTalkMatrixBelow)(iwire,itime);</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :             vecCache[iwire]=(*crossTalkMatrixCache)(iwire,itime);</span>
<span class="lineNum">    1652 </span>            :           }
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :           (*fDebugStreamer)&lt;&lt;&quot;crosstalkMatrix&quot;&lt;&lt;</span>
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :             &quot;iter=&quot;&lt;&lt;iter&lt;&lt;                      //iteration</span>
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :             &quot;sector=&quot;&lt;&lt;isector&lt;&lt;                 // sector</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :             &quot;itime=&quot;&lt;&lt;itime&lt;&lt;                    // time bin index</span>
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :             &quot;vecAll.=&quot;&lt;&lt;&amp;vecAll&lt;&lt;                // crosstalk charge + charge below threshold</span>
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :             &quot;vecCache.=&quot;&lt;&lt;&amp;vecCache&lt;&lt;                // crosstalk charge + charge below threshold       </span>
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :             &quot;vecBelow.=&quot;&lt;&lt;&amp;vecBelow&lt;&lt;            // crosstalk contribution from signal below threshold</span>
<span class="lineNum">    1660 </span>            :             &quot;\n&quot;;
<span class="lineNum">    1661 </span>            :         }
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 :     if (iter&lt;nIterations-1) for (Int_t isector=0; isector&lt;nROCs*2; isector++){  //set all ellemts of crosstalk matrix to 0 </span>
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :       TMatrixD * crossTalkMatrix = (TMatrixD*)fCrossTalkSignalArray-&gt;At(isector);</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :       TMatrixD * crossTalkMatrixCache = (TMatrixD*)fCrossTalkSignalArray-&gt;At(isector+nROCs*2);</span>
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :       if (crossTalkMatrix){</span>
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :         (*crossTalkMatrixCache)*=0;</span>
<span class="lineNum">    1669 </span><span class="lineNoCov">          0 :         (*crossTalkMatrixCache)+=(*crossTalkMatrix);</span>
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :         (*crossTalkMatrix)*=0;</span>
<span class="lineNum">    1671 </span>            :       }
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :     }      </span>
<span class="lineNum">    1673 </span>            :   }
<span class="lineNum">    1674 </span>            : 
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :   sw.Stop();</span>
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :   AliInfoF(&quot;timing: %e/%e real/cpu&quot;,sw.RealTime(),sw.CpuTime());</span>
<span class="lineNum">    1677 </span>            :   //
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1679 </span>            : 
<span class="lineNum">    1680 </span>            : 
<a name="1681"><span class="lineNum">    1681 </span>            : </a>
<span class="lineNum">    1682 </span>            : 
<span class="lineNum">    1683 </span>            : void    AliTPCtracker::FilterOutlierClusters(){
<span class="lineNum">    1684 </span>            :   //
<span class="lineNum">    1685 </span>            :   // filter outlier clusters  
<span class="lineNum">    1686 </span>            :   //
<span class="lineNum">    1687 </span>            :   /*
<span class="lineNum">    1688 </span>            :     1.)..... booking part
<span class="lineNum">    1689 </span>            :     nSectors=72;
<span class="lineNum">    1690 </span>            :     nTimeBins=fParam-&gt;Get....
<span class="lineNum">    1691 </span>            :     TH2F hisTime(&quot;&quot;,&quot;&quot;, sector,0,sector, nTimeBins,0,nTimeBins);
<span class="lineNum">    1692 </span>            :     TH2F hisPadRow(&quot;&quot;,&quot;&quot;, sector,0,sector, nPadRows,0,nPadRows);
<span class="lineNum">    1693 </span>            :     2.) .... filling part
<span class="lineNum">    1694 </span>            :     .... cluster loop { hisTime.Fill(cluster-&gt;GetDetector(),cluster-&gt;GetTimeBin()); }
<span class="lineNum">    1695 </span>            :     
<span class="lineNum">    1696 </span>            :     3.) ...filtering part 
<span class="lineNum">    1697 </span>            :     sector loop { calculate median,mean80 and rms80 of the nclusters per time bin; calculate median,mean80 and rms80 of the nclusters per par row; .... export values to the debug streamers - to decide which threshold to be used... }
<span class="lineNum">    1698 </span>            :     
<span class="lineNum">    1699 </span>            :     sector loop
<span class="lineNum">    1700 </span>            :     { disable clusters in time bins &gt; mean+ n rms80+ offsetTime disable clusters in padRow &gt; mean+ n rms80+ offsetPadRow // how to dislable clusters? - new bit to introduce } 
<span class="lineNum">    1701 </span>            :     //
<span class="lineNum">    1702 </span>            :     4. Disabling clusters
<span class="lineNum">    1703 </span>            :     
<span class="lineNum">    1704 </span>            :   */
<span class="lineNum">    1705 </span>            :   
<span class="lineNum">    1706 </span>            :   //
<span class="lineNum">    1707 </span>            :   // 1.) booking part 
<span class="lineNum">    1708 </span>            :   // 
<span class="lineNum">    1709 </span>            :   //  AliTPCcalibDB *db=AliTPCcalibDB::Instance();
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :   Int_t nSectors=AliTPCROC::Instance()-&gt;GetNSectors(); </span>
<span class="lineNum">    1711 </span>            :   Int_t nTimeBins= 1100; // *Bug here - we should get NTimeBins from ALTRO - Parameters not relyable
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :   Int_t nPadRows=(AliTPCROC::Instance()-&gt;GetNRows(0) + AliTPCROC::Instance()-&gt;GetNRows(36));</span>
<span class="lineNum">    1713 </span>            :   // parameters for filtering
<span class="lineNum">    1714 </span>            :   const Double_t nSigmaCut=9.;           // should be in recoParam ?
<span class="lineNum">    1715 </span>            :   const Double_t offsetTime=100;         // should be in RecoParam ?  -
<span class="lineNum">    1716 </span>            :   const Double_t offsetPadRow=300;       // should be in RecoParam ?
<span class="lineNum">    1717 </span>            :   const Double_t offsetTimeAccept=8;     // should be in RecoParam ?  - obtained as mean +1 rms in high IR pp
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :   TH2F hisTime(&quot;hisSectorTime&quot;,&quot;hisSectorTime&quot;, nSectors,0,nSectors, nTimeBins,0,nTimeBins);</span>
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 :   TH2F hisPadRow(&quot;hisSectorRow&quot;,&quot;hisSectorRow&quot;, nSectors,0,nSectors, nPadRows,0,nPadRows);</span>
<span class="lineNum">    1720 </span>            :   //
<span class="lineNum">    1721 </span>            :   // 2.) Filling part -- loop over clusters
<span class="lineNum">    1722 </span>            :   //
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :   for (Int_t isector=0; isector&lt;36; isector++){      // loop over sectors</span>
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :     for (Int_t iside=0; iside&lt;2; iside++){           // loop over sides A/C</span>
<span class="lineNum">    1725 </span><span class="lineNoCov">          0 :       AliTPCtrackerSector &amp;sector= (isector&lt;18)?fInnerSec[isector%18]:fOuterSec[isector%18];</span>
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :       Int_t nrows = sector.GetNRows();</span>
<span class="lineNum">    1727 </span><span class="lineNoCov">          0 :       for (Int_t row = 0;row&lt;nrows;row++){           // loop over rows       </span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :         AliTPCtrackerRow&amp;  tpcrow = sector[row];       </span>
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 :         Int_t ncl = tpcrow.GetN1();                  // number of clusters in the row</span>
<span class="lineNum">    1730 </span><span class="lineNoCov">          0 :         if (iside&gt;0) ncl=tpcrow.GetN2();</span>
<span class="lineNum">    1731 </span><span class="lineNoCov">          0 :         for (Int_t i=0;i&lt;ncl;i++) {  // loop over clusters</span>
<span class="lineNum">    1732 </span><span class="lineNoCov">          0 :           AliTPCclusterMI *cluster= (iside&gt;0)?(tpcrow.GetCluster2(i)):(tpcrow.GetCluster1(i));</span>
<span class="lineNum">    1733 </span><span class="lineNoCov">          0 :           hisTime.Fill(cluster-&gt;GetDetector(),cluster-&gt;GetTimeBin()); </span>
<span class="lineNum">    1734 </span><span class="lineNoCov">          0 :           hisPadRow.Fill(cluster-&gt;GetDetector(),cluster-&gt;GetRow()); </span>
<span class="lineNum">    1735 </span>            :         }
<span class="lineNum">    1736 </span>            :       } 
<span class="lineNum">    1737 </span>            :     } 
<span class="lineNum">    1738 </span>            :   } 
<span class="lineNum">    1739 </span>            : 
<span class="lineNum">    1740 </span>            :   //
<span class="lineNum">    1741 </span>            :   // 3. Filtering part
<span class="lineNum">    1742 </span>            :   //
<span class="lineNum">    1743 </span><span class="lineNoCov">          0 :   TVectorD vecTime(nTimeBins);</span>
<span class="lineNum">    1744 </span><span class="lineNoCov">          0 :   TVectorD vecPadRow(nPadRows);</span>
<span class="lineNum">    1745 </span><span class="lineNoCov">          0 :   TVectorD vecMedianSectorTime(nSectors);</span>
<span class="lineNum">    1746 </span><span class="lineNoCov">          0 :   TVectorD vecRMSSectorTime(nSectors);</span>
<span class="lineNum">    1747 </span><span class="lineNoCov">          0 :   TVectorD vecMedianSectorTimeOut6(nSectors);</span>
<span class="lineNum">    1748 </span><span class="lineNoCov">          0 :   TVectorD vecMedianSectorTimeOut9(nSectors);//</span>
<span class="lineNum">    1749 </span><span class="lineNoCov">          0 :   TVectorD vecMedianSectorTimeOut(nSectors);//</span>
<span class="lineNum">    1750 </span><span class="lineNoCov">          0 :   TVectorD vecMedianSectorPadRow(nSectors);</span>
<span class="lineNum">    1751 </span><span class="lineNoCov">          0 :   TVectorD vecRMSSectorPadRow(nSectors);</span>
<span class="lineNum">    1752 </span><span class="lineNoCov">          0 :   TVectorD vecMedianSectorPadRowOut6(nSectors);</span>
<span class="lineNum">    1753 </span><span class="lineNoCov">          0 :   TVectorD vecMedianSectorPadRowOut9(nSectors);</span>
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :   TVectorD vecMedianSectorPadRowOut(nSectors);</span>
<span class="lineNum">    1755 </span><span class="lineNoCov">          0 :   TVectorD vecSectorOut6(nSectors);</span>
<span class="lineNum">    1756 </span><span class="lineNoCov">          0 :   TVectorD vecSectorOut9(nSectors);</span>
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :   TMatrixD matSectorCluster(nSectors,2);</span>
<span class="lineNum">    1758 </span>            :   //
<span class="lineNum">    1759 </span>            :   // 3.a)  median, rms calculations for hisTime 
<span class="lineNum">    1760 </span>            :   //
<span class="lineNum">    1761 </span><span class="lineNoCov">          0 :   for (Int_t isec=0; isec&lt;nSectors; isec++){</span>
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :     vecMedianSectorTimeOut6[isec]=0;</span>
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 :     vecMedianSectorTimeOut9[isec]=0;</span>
<span class="lineNum">    1764 </span><span class="lineNoCov">          0 :     for (Int_t itime=0; itime&lt;nTimeBins; itime++){</span>
<span class="lineNum">    1765 </span><span class="lineNoCov">          0 :       vecTime[itime]=hisTime.GetBinContent(isec+1, itime+1);      </span>
<span class="lineNum">    1766 </span>            :     }
<span class="lineNum">    1767 </span><span class="lineNoCov">          0 :     Double_t median= TMath::Mean(nTimeBins,vecTime.GetMatrixArray());</span>
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :     Double_t rms= TMath::RMS(nTimeBins,vecTime.GetMatrixArray()); </span>
<span class="lineNum">    1769 </span><span class="lineNoCov">          0 :     vecMedianSectorTime[isec]=median;</span>
<span class="lineNum">    1770 </span><span class="lineNoCov">          0 :     vecRMSSectorTime[isec]=rms;</span>
<span class="lineNum">    1771 </span><span class="lineNoCov">          0 :     if ((AliTPCReconstructor::StreamLevel()&amp;kStreamFilterClusterInfo)&gt;0) AliInfo(TString::Format(&quot;Sector TimeStat: %d\t%8.0f\t%8.0f&quot;,isec,median,rms).Data());</span>
<span class="lineNum">    1772 </span>            :     //
<span class="lineNum">    1773 </span>            :     // declare outliers
<span class="lineNum">    1774 </span><span class="lineNoCov">          0 :     for (Int_t itime=0; itime&lt;nTimeBins; itime++){</span>
<span class="lineNum">    1775 </span><span class="lineNoCov">          0 :       Double_t entries= hisTime.GetBinContent(isec+1, itime+1); </span>
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :       if (entries&gt;median+6.*rms+offsetTime) {</span>
<span class="lineNum">    1777 </span><span class="lineNoCov">          0 :         vecMedianSectorTimeOut6[isec]+=1;</span>
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1779 </span><span class="lineNoCov">          0 :       if (entries&gt;median+9.*rms+offsetTime) {</span>
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :         vecMedianSectorTimeOut9[isec]+=1;</span>
<span class="lineNum">    1781 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1782 </span>            :     }
<span class="lineNum">    1783 </span>            :   }    
<span class="lineNum">    1784 </span>            :   //
<span class="lineNum">    1785 </span>            :   // 3.b) median, rms calculations for hisPadRow
<span class="lineNum">    1786 </span>            :   // 
<span class="lineNum">    1787 </span><span class="lineNoCov">          0 :   for (Int_t isec=0; isec&lt;nSectors; isec++){</span>
<span class="lineNum">    1788 </span><span class="lineNoCov">          0 :     vecMedianSectorPadRowOut6[isec]=0;</span>
<span class="lineNum">    1789 </span><span class="lineNoCov">          0 :     vecMedianSectorPadRowOut9[isec]=0;</span>
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 :     for (Int_t ipadrow=0; ipadrow&lt;nPadRows; ipadrow++){</span>
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :       vecPadRow[ipadrow]=hisPadRow.GetBinContent(isec+1, ipadrow+1);      </span>
<span class="lineNum">    1792 </span>            :     }
<span class="lineNum">    1793 </span><span class="lineNoCov">          0 :     Int_t nPadRowsSector= AliTPCROC::Instance()-&gt;GetNRows(isec);</span>
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :     Double_t median= TMath::Mean(nPadRowsSector,vecPadRow.GetMatrixArray());</span>
<span class="lineNum">    1795 </span><span class="lineNoCov">          0 :     Double_t rms= TMath::RMS(nPadRowsSector,vecPadRow.GetMatrixArray());</span>
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :     vecMedianSectorPadRow[isec]=median;</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :     vecRMSSectorPadRow[isec]=rms;</span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :     if ((AliTPCReconstructor::StreamLevel()&amp;kStreamFilterClusterInfo)&gt;0) AliInfo(TString::Format(&quot;Sector PadRowStat: %d\t%8.0f\t%8.0f&quot;,isec,median,rms).Data());</span>
<span class="lineNum">    1799 </span>            :     //
<span class="lineNum">    1800 </span>            :     // declare outliers
<span class="lineNum">    1801 </span><span class="lineNoCov">          0 :     for (Int_t ipadrow=0; ipadrow&lt;nPadRows; ipadrow++){</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :       Double_t entries= hisPadRow.GetBinContent(isec+1, ipadrow+1);</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 :       if (entries&gt;median+6.*rms+offsetPadRow) {</span>
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :         vecMedianSectorPadRowOut6[isec]+=1;</span>
<span class="lineNum">    1805 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1806 </span><span class="lineNoCov">          0 :       if (entries&gt;median+9.*rms+offsetPadRow) {</span>
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 :         vecMedianSectorPadRowOut9[isec]+=1;</span>
<span class="lineNum">    1808 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1809 </span>            :     }
<span class="lineNum">    1810 </span>            :   }
<span class="lineNum">    1811 </span>            :   //
<span class="lineNum">    1812 </span>            :   // 3.c) filter outlier sectors
<span class="lineNum">    1813 </span>            :   //
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :   Double_t medianSectorTime = TMath::Median(nSectors, vecTime.GetMatrixArray());</span>
<span class="lineNum">    1815 </span><span class="lineNoCov">          0 :   Double_t mean69SectorTime, rms69SectorTime=0;</span>
<span class="lineNum">    1816 </span><span class="lineNoCov">          0 :   AliMathBase::EvaluateUni(nSectors,  vecTime.GetMatrixArray(), mean69SectorTime,rms69SectorTime,69);</span>
<span class="lineNum">    1817 </span><span class="lineNoCov">          0 :   for (Int_t isec=0; isec&lt;nSectors; isec++){</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :     vecSectorOut6[isec]=0;</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :     vecSectorOut9[isec]=0;</span>
<span class="lineNum">    1820 </span><span class="lineNoCov">          0 :     matSectorCluster(isec,0)=0;</span>
<span class="lineNum">    1821 </span><span class="lineNoCov">          0 :     matSectorCluster(isec,1)=0;</span>
<span class="lineNum">    1822 </span><span class="lineNoCov">          0 :     if (TMath::Abs(vecMedianSectorTime[isec])&gt;(mean69SectorTime+6.*(rms69SectorTime+ offsetTimeAccept))) {</span>
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :       vecSectorOut6[isec]=1;</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1825 </span><span class="lineNoCov">          0 :     if (TMath::Abs(vecMedianSectorTime[isec])&gt;(mean69SectorTime+9.*(rms69SectorTime+ offsetTimeAccept))){</span>
<span class="lineNum">    1826 </span><span class="lineNoCov">          0 :       vecSectorOut9[isec]=1;</span>
<span class="lineNum">    1827 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1828 </span>            :   }
<span class="lineNum">    1829 </span>            :   // light version of export variable
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :   Int_t filteredSector= vecSectorOut9.Sum();                  // light version of export variable</span>
<span class="lineNum">    1831 </span><span class="lineNoCov">          0 :   Int_t filteredSectorTime= vecMedianSectorTimeOut9.Sum();</span>
<span class="lineNum">    1832 </span><span class="lineNoCov">          0 :   Int_t filteredSectorPadRow= vecMedianSectorPadRowOut9.Sum();</span>
<span class="lineNum">    1833 </span><span class="lineNoCov">          0 :   if (fEvent) if (fEvent-&gt;GetHeader()){</span>
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :     fEvent-&gt;GetHeader()-&gt;SetTPCNoiseFilterCounter(0,TMath::Min(filteredSector,255));</span>
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :     fEvent-&gt;GetHeader()-&gt;SetTPCNoiseFilterCounter(1,TMath::Min(filteredSectorTime,255));</span>
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :     fEvent-&gt;GetHeader()-&gt;SetTPCNoiseFilterCounter(2,TMath::Min(filteredSectorPadRow,255));</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1838 </span>            :  
<span class="lineNum">    1839 </span>            :   //
<span class="lineNum">    1840 </span>            :   // 4. Disabling clusters in outlier layers
<span class="lineNum">    1841 </span>            :   //
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :   Int_t counterAll=0;</span>
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 :   Int_t counterOut=0;</span>
<span class="lineNum">    1844 </span><span class="lineNoCov">          0 :   for (Int_t isector=0; isector&lt;36; isector++){      // loop over sectors</span>
<span class="lineNum">    1845 </span><span class="lineNoCov">          0 :     for (Int_t iside=0; iside&lt;2; iside++){           // loop over sides A/C</span>
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :       AliTPCtrackerSector &amp;sector= (isector&lt;18)?fInnerSec[isector%18]:fOuterSec[isector%18];</span>
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 :       Int_t nrows = sector.GetNRows();</span>
<span class="lineNum">    1848 </span><span class="lineNoCov">          0 :       for (Int_t row = 0;row&lt;nrows;row++){           // loop over rows       </span>
<span class="lineNum">    1849 </span><span class="lineNoCov">          0 :         AliTPCtrackerRow&amp;  tpcrow = sector[row];       </span>
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :         Int_t ncl = tpcrow.GetN1();                  // number of clusters in the row</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :         if (iside&gt;0) ncl=tpcrow.GetN2();</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :         for (Int_t i=0;i&lt;ncl;i++) {  // loop over clusters</span>
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :           AliTPCclusterMI *cluster= (iside&gt;0)?(tpcrow.GetCluster2(i)):(tpcrow.GetCluster1(i));</span>
<span class="lineNum">    1854 </span><span class="lineNoCov">          0 :           Double_t medianTime=vecMedianSectorTime[cluster-&gt;GetDetector()];</span>
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :           Double_t medianPadRow=vecMedianSectorPadRow[cluster-&gt;GetDetector()];</span>
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :           Double_t rmsTime=vecRMSSectorTime[cluster-&gt;GetDetector()];</span>
<span class="lineNum">    1857 </span><span class="lineNoCov">          0 :           Double_t rmsPadRow=vecRMSSectorPadRow[cluster-&gt;GetDetector()];</span>
<span class="lineNum">    1858 </span><span class="lineNoCov">          0 :           Int_t entriesPadRow=hisPadRow.GetBinContent(cluster-&gt;GetDetector()+1, cluster-&gt;GetRow()+1);</span>
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 :           Int_t entriesTime=hisTime.GetBinContent(cluster-&gt;GetDetector()+1, cluster-&gt;GetTimeBin()+1);</span>
<span class="lineNum">    1860 </span>            :           Bool_t isOut=kFALSE;
<span class="lineNum">    1861 </span><span class="lineNoCov">          0 :           if (vecSectorOut9[cluster-&gt;GetDetector()]&gt;0.5) {</span>
<span class="lineNum">    1862 </span>            :             isOut=kTRUE;
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    1864 </span>            :           
<span class="lineNum">    1865 </span><span class="lineNoCov">          0 :           if (entriesTime&gt;medianTime+nSigmaCut*rmsTime+offsetTime) {</span>
<span class="lineNum">    1866 </span>            :             isOut=kTRUE;
<span class="lineNum">    1867 </span><span class="lineNoCov">          0 :             vecMedianSectorTimeOut[cluster-&gt;GetDetector()]++;</span>
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    1869 </span><span class="lineNoCov">          0 :           if (entriesPadRow&gt;medianPadRow+nSigmaCut*rmsPadRow+offsetPadRow) {</span>
<span class="lineNum">    1870 </span>            :             isOut=kTRUE;
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :             vecMedianSectorPadRowOut[cluster-&gt;GetDetector()]++;</span>
<span class="lineNum">    1872 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    1873 </span><span class="lineNoCov">          0 :           counterAll++;</span>
<span class="lineNum">    1874 </span><span class="lineNoCov">          0 :           matSectorCluster(cluster-&gt;GetDetector(),0)+=1;</span>
<span class="lineNum">    1875 </span><span class="lineNoCov">          0 :           if (isOut){</span>
<span class="lineNum">    1876 </span><span class="lineNoCov">          0 :             cluster-&gt;Disable();</span>
<span class="lineNum">    1877 </span><span class="lineNoCov">          0 :             counterOut++;</span>
<span class="lineNum">    1878 </span><span class="lineNoCov">          0 :             matSectorCluster(cluster-&gt;GetDetector(),1)+=1;</span>
<span class="lineNum">    1879 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    1880 </span>            :         }
<span class="lineNum">    1881 </span>            :       }
<span class="lineNum">    1882 </span>            :     }
<span class="lineNum">    1883 </span>            :   }
<span class="lineNum">    1884 </span><span class="lineNoCov">          0 :   for (Int_t isec=0; isec&lt;nSectors; isec++){</span>
<span class="lineNum">    1885 </span><span class="lineNoCov">          0 :     if ((AliTPCReconstructor::StreamLevel()&amp;kStreamFilterClusterInfo)&gt;0) AliInfo(TString::Format(&quot;Sector Stat: %d\t%8.0f\t%8.0f&quot;,isec,matSectorCluster(isec,1),matSectorCluster(isec,0)).Data());</span>
<span class="lineNum">    1886 </span>            :   }
<span class="lineNum">    1887 </span>            :   //
<span class="lineNum">    1888 </span>            :   // dump info to streamer - for later tuning of cuts
<span class="lineNum">    1889 </span>            :   //
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :   if ((AliTPCReconstructor::StreamLevel()&amp;kStreamFilterClusterInfo)&gt;0) {  // stream TPC data ouliers filtering infomation</span>
<span class="lineNum">    1891 </span><span class="lineNoCov">          0 :     AliLog::Flush();</span>
<span class="lineNum">    1892 </span><span class="lineNoCov">          0 :     AliInfo(TString::Format(&quot;Cluster counter: (%d/%d) (Filtered/All)&quot;,counterOut,counterAll).Data());</span>
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 :     for (Int_t iSec=0; iSec&lt;nSectors; iSec++){</span>
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :       if (vecSectorOut9[iSec]&gt;0 ||  matSectorCluster(iSec,1)&gt;0) {</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :         AliInfo(TString::Format(&quot;Filtered sector\t%d&quot;,iSec).Data());</span>
<span class="lineNum">    1896 </span><span class="lineNoCov">          0 :         Double_t vecMedTime =TMath::Median(72,vecMedianSectorTime.GetMatrixArray());</span>
<span class="lineNum">    1897 </span><span class="lineNoCov">          0 :         Double_t vecMedPadRow =TMath::Median(72,vecMedianSectorPadRow.GetMatrixArray());</span>
<span class="lineNum">    1898 </span><span class="lineNoCov">          0 :         Double_t vecMedCluster=(counterAll-counterOut)/72;</span>
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :         AliInfo(TString::Format(&quot;VecMedianSectorTime\t(%4.4f/%4.4f/%4.4f)&quot;,       vecMedianSectorTimeOut[iSec],vecMedianSectorTime[iSec],vecMedTime).Data());</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :         AliInfo(TString::Format(&quot;VecMedianSectorPadRow\t(%4.4f/%4.4f/%4.4f)&quot;,     vecMedianSectorPadRowOut[iSec],vecMedianSectorPadRow[iSec],vecMedPadRow).Data());</span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :         AliInfo(TString::Format(&quot;MatSectorCluster\t(%4.4f/%4.4f/%4.4f)\n&quot;,          matSectorCluster(iSec,1), matSectorCluster(iSec,0),  vecMedCluster).Data());</span>
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :         AliLog::Flush();</span>
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1904 </span>            :     }
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :     AliLog::Flush();</span>
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :     Int_t eventNr = fEvent-&gt;GetEventNumberInFile();</span>
<span class="lineNum">    1907 </span><span class="lineNoCov">          0 :     (*fDebugStreamer)&lt;&lt;&quot;filterClusterInfo&quot;&lt;&lt;</span>
<span class="lineNum">    1908 </span>            :       // minimal set variables for the ESDevent
<span class="lineNum">    1909 </span><span class="lineNoCov">          0 :       &quot;eventNr=&quot;&lt;&lt;eventNr&lt;&lt;</span>
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :       &quot;counterAll=&quot;&lt;&lt;counterAll&lt;&lt;</span>
<span class="lineNum">    1911 </span><span class="lineNoCov">          0 :       &quot;counterOut=&quot;&lt;&lt;counterOut&lt;&lt;</span>
<span class="lineNum">    1912 </span><span class="lineNoCov">          0 :       &quot;matSectotCluster.=&quot;&lt;&lt;&amp;matSectorCluster&lt;&lt;                   // </span>
<span class="lineNum">    1913 </span>            :       //
<span class="lineNum">    1914 </span><span class="lineNoCov">          0 :       &quot;filteredSector=&quot;&lt;&lt;filteredSector&lt;&lt;                        //  counter filtered sectors                   </span>
<span class="lineNum">    1915 </span><span class="lineNoCov">          0 :       &quot;filteredSectorTime=&quot;&lt;&lt;filteredSectorTime&lt;&lt;                //  counter filtered time bins</span>
<span class="lineNum">    1916 </span><span class="lineNoCov">          0 :       &quot;filteredSectorPadRow=&quot;&lt;&lt;filteredSectorPadRow&lt;&lt;            //  counter filtered pad-rows</span>
<span class="lineNum">    1917 </span>            :       // per sector outlier information
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :       &quot;medianSectorTime=&quot;&lt;&lt;medianSectorTime&lt;&lt;                    // median number of clusters per sector/timebin</span>
<span class="lineNum">    1919 </span><span class="lineNoCov">          0 :       &quot;mean69SectorTime=&quot;&lt;&lt;mean69SectorTime&lt;&lt;                    // LTM statistic  mean of clusters per sector/timebin</span>
<span class="lineNum">    1920 </span><span class="lineNoCov">          0 :       &quot;rms69SectorTime=&quot;&lt;&lt;rms69SectorTime&lt;&lt;                      // LTM statistic  RMS of clusters per sector/timebin</span>
<span class="lineNum">    1921 </span><span class="lineNoCov">          0 :       &quot;vecSectorOut6.=&quot;&lt;&lt;&amp;vecSectorOut6&lt;&lt;                        // flag array sector  - 6 sigma +accept margin outlier</span>
<span class="lineNum">    1922 </span><span class="lineNoCov">          0 :       &quot;vecSectorOut9.=&quot;&lt;&lt;&amp;vecSectorOut9&lt;&lt;                        // flag array sector  - 9 sigma + accept margin outlier</span>
<span class="lineNum">    1923 </span>            :       // per sector/timebin outlier detection
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :       &quot;vecMedianSectorTime.=&quot;&lt;&lt;&amp;vecMedianSectorTime&lt;&lt;</span>
<span class="lineNum">    1925 </span><span class="lineNoCov">          0 :       &quot;vecRMSSectorTime.=&quot;&lt;&lt;&amp;vecRMSSectorTime&lt;&lt;</span>
<span class="lineNum">    1926 </span><span class="lineNoCov">          0 :       &quot;vecMedianSectorTimeOut6.=&quot;&lt;&lt;&amp;vecMedianSectorTimeOut6&lt;&lt;</span>
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :       &quot;vecMedianSectorTimeOut9.=&quot;&lt;&lt;&amp;vecMedianSectorTimeOut9&lt;&lt;</span>
<span class="lineNum">    1928 </span><span class="lineNoCov">          0 :       &quot;vecMedianSectorTimeOut0.=&quot;&lt;&lt;&amp;vecMedianSectorTimeOut&lt;&lt;</span>
<span class="lineNum">    1929 </span>            :       // per sector/pad-row outlier detection
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :       &quot;vecMedianSectorPadRow.=&quot;&lt;&lt;&amp;vecMedianSectorPadRow&lt;&lt;</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :       &quot;vecRMSSectorPadRow.=&quot;&lt;&lt;&amp;vecRMSSectorPadRow&lt;&lt;</span>
<span class="lineNum">    1932 </span><span class="lineNoCov">          0 :       &quot;vecMedianSectorPadRowOut6.=&quot;&lt;&lt;&amp;vecMedianSectorPadRowOut6&lt;&lt;</span>
<span class="lineNum">    1933 </span><span class="lineNoCov">          0 :       &quot;vecMedianSectorPadRowOut9.=&quot;&lt;&lt;&amp;vecMedianSectorPadRowOut9&lt;&lt;</span>
<span class="lineNum">    1934 </span><span class="lineNoCov">          0 :       &quot;vecMedianSectorPadRowOut9.=&quot;&lt;&lt;&amp;vecMedianSectorPadRowOut&lt;&lt;</span>
<span class="lineNum">    1935 </span>            :       &quot;\n&quot;;
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 :     ((*fDebugStreamer)&lt;&lt;&quot;filterClusterInfo&quot;).GetTree()-&gt;Write();</span>
<span class="lineNum">    1937 </span><span class="lineNoCov">          0 :     fDebugStreamer-&gt;GetFile()-&gt;Flush();</span>
<span class="lineNum">    1938 </span><span class="lineNoCov">          0 :   }</span>
<a name="1939"><span class="lineNum">    1939 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1940 </span>            : 
<span class="lineNum">    1941 </span>            : void AliTPCtracker::UnloadClusters()
<span class="lineNum">    1942 </span>            : {
<span class="lineNum">    1943 </span>            :   //
<span class="lineNum">    1944 </span>            :   // unload clusters from the memory
<span class="lineNum">    1945 </span>            :   //
<span class="lineNum">    1946 </span><span class="lineCov">         16 :   Int_t nrows = fOuterSec-&gt;GetNRows();</span>
<span class="lineNum">    1947 </span><span class="lineCov">        304 :   for (Int_t sec = 0;sec&lt;fkNOS;sec++)</span>
<span class="lineNum">    1948 </span><span class="lineCov">      27936 :     for (Int_t row = 0;row&lt;nrows;row++){</span>
<span class="lineNum">    1949 </span><span class="lineCov">      13824 :       AliTPCtrackerRow*  tpcrow = &amp;(fOuterSec[sec%fkNOS][row]);</span>
<span class="lineNum">    1950 </span>            :       //      if (tpcrow){
<span class="lineNum">    1951 </span>            :       //        if (tpcrow-&gt;fClusters1) delete []tpcrow-&gt;fClusters1; 
<span class="lineNum">    1952 </span>            :       //        if (tpcrow-&gt;fClusters2) delete []tpcrow-&gt;fClusters2; 
<span class="lineNum">    1953 </span>            :       //}
<span class="lineNum">    1954 </span><span class="lineCov">      13824 :       tpcrow-&gt;ResetClusters();</span>
<span class="lineNum">    1955 </span>            :     }
<span class="lineNum">    1956 </span>            :   //
<span class="lineNum">    1957 </span><span class="lineCov">          8 :   nrows = fInnerSec-&gt;GetNRows();</span>
<span class="lineNum">    1958 </span><span class="lineCov">        304 :   for (Int_t sec = 0;sec&lt;fkNIS;sec++)</span>
<span class="lineNum">    1959 </span><span class="lineCov">      18432 :     for (Int_t row = 0;row&lt;nrows;row++){</span>
<span class="lineNum">    1960 </span><span class="lineCov">       9072 :       AliTPCtrackerRow*  tpcrow = &amp;(fInnerSec[sec%fkNIS][row]);</span>
<span class="lineNum">    1961 </span>            :       //if (tpcrow){
<span class="lineNum">    1962 </span>            :       //        if (tpcrow-&gt;fClusters1) delete []tpcrow-&gt;fClusters1; 
<span class="lineNum">    1963 </span>            :       //if (tpcrow-&gt;fClusters2) delete []tpcrow-&gt;fClusters2; 
<span class="lineNum">    1964 </span>            :       //}
<span class="lineNum">    1965 </span><span class="lineCov">       9072 :       tpcrow-&gt;ResetClusters();</span>
<span class="lineNum">    1966 </span>            :     }
<span class="lineNum">    1967 </span>            : 
<span class="lineNum">    1968 </span><span class="lineCov">          8 :   fNClusters = 0;</span>
<span class="lineNum">    1969 </span>            :   return ;
<a name="1970"><span class="lineNum">    1970 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">    1971 </span>            : 
<span class="lineNum">    1972 </span>            : void AliTPCtracker::FillClusterArray(TObjArray* array) const{
<span class="lineNum">    1973 </span>            :   //
<span class="lineNum">    1974 </span>            :   // Filling cluster to the array - For visualization purposes
<span class="lineNum">    1975 </span>            :   //
<span class="lineNum">    1976 </span>            :   Int_t nrows=0;
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :   nrows = fOuterSec-&gt;GetNRows();</span>
<span class="lineNum">    1978 </span><span class="lineNoCov">          0 :   for (Int_t sec = 0;sec&lt;fkNOS;sec++)</span>
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 :     for (Int_t row = 0;row&lt;nrows;row++){</span>
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :       AliTPCtrackerRow*  tpcrow = &amp;(fOuterSec[sec%fkNOS][row]);</span>
<span class="lineNum">    1981 </span><span class="lineNoCov">          0 :       if (!tpcrow) continue;</span>
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :       for (Int_t icl = 0;icl&lt;tpcrow-&gt;GetN();icl++){</span>
<span class="lineNum">    1983 </span><span class="lineNoCov">          0 :         array-&gt;AddLast((TObject*)((*tpcrow)[icl]));</span>
<span class="lineNum">    1984 </span>            :       }
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :     } </span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :   nrows = fInnerSec-&gt;GetNRows();</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :   for (Int_t sec = 0;sec&lt;fkNIS;sec++)</span>
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :     for (Int_t row = 0;row&lt;nrows;row++){</span>
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :       AliTPCtrackerRow*  tpcrow = &amp;(fInnerSec[sec%fkNIS][row]);</span>
<span class="lineNum">    1990 </span><span class="lineNoCov">          0 :       if (!tpcrow) continue;</span>
<span class="lineNum">    1991 </span><span class="lineNoCov">          0 :       for (Int_t icl = 0;icl&lt;tpcrow-&gt;GetN();icl++){</span>
<span class="lineNum">    1992 </span><span class="lineNoCov">          0 :         array-&gt;AddLast((TObject*)(*tpcrow)[icl]);</span>
<span class="lineNum">    1993 </span>            :       }
<span class="lineNum">    1994 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1995 </span><span class="lineNoCov">          0 : }</span>
<a name="1996"><span class="lineNum">    1996 </span>            : </a>
<span class="lineNum">    1997 </span>            : 
<span class="lineNum">    1998 </span>            : void AliTPCtracker::Transform(AliTPCclusterMI * cluster){
<span class="lineNum">    1999 </span>            :   //
<span class="lineNum">    2000 </span>            :   // transformation
<span class="lineNum">    2001 </span>            :   //
<span class="lineNum">    2002 </span><span class="lineCov">     129896 :   const double kMaxY2X = AliTPCTransform::GetMaxY2X();  // tg of sector angular span</span>
<span class="lineNum">    2003 </span><span class="lineCov">      64948 :   const double kSinSect = TMath::Sin(TMath::Pi()/9), kCosSect = TMath::Cos(TMath::Pi()/9);</span>
<span class="lineNum">    2004 </span>            :   //
<span class="lineNum">    2005 </span><span class="lineCov">      64948 :   AliTPCcalibDB * calibDB = AliTPCcalibDB::Instance();</span>
<span class="lineNum">    2006 </span><span class="lineCov">      64948 :   AliTPCTransform *transform = calibDB-&gt;GetTransform() ;</span>
<span class="lineNum">    2007 </span><span class="lineCov">      64948 :   if (!transform) {</span>
<span class="lineNum">    2008 </span><span class="lineNoCov">          0 :     AliFatal(&quot;Tranformations not in calibDB&quot;);</span>
<span class="lineNum">    2009 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    2010 </span>            :   }
<span class="lineNum">    2011 </span>            :   //  if (!transform-&gt;GetCurrentRecoParam()) transform-&gt;SetCurrentRecoParam((AliTPCRecoParam*)AliTPCReconstructor::GetRecoParam());
<span class="lineNum">    2012 </span><span class="lineCov">      64948 :   Double_t x[3]={static_cast&lt;Double_t&gt;(cluster-&gt;GetRow()),static_cast&lt;Double_t&gt;(cluster-&gt;GetPad()),static_cast&lt;Double_t&gt;(cluster-&gt;GetTimeBin())};</span>
<span class="lineNum">    2013 </span><span class="lineCov">      64948 :   Int_t idROC = cluster-&gt;GetDetector();</span>
<span class="lineNum">    2014 </span><span class="lineCov">      64948 :   transform-&gt;Transform(x,&amp;idROC,0,1);</span>
<span class="lineNum">    2015 </span><span class="lineCov">      64948 :   const float* clCorr = transform-&gt;GetLastMapCorrection();</span>
<span class="lineNum">    2016 </span><span class="lineCov">      64948 :   const float* clCorrRef = transform-&gt;GetLastMapCorrectionRef();</span>
<span class="lineNum">    2017 </span>            :   //
<span class="lineNum">    2018 </span><span class="lineCov">     129896 :   cluster-&gt;SetDistortions(clCorr[0]-clCorrRef[0],</span>
<span class="lineNum">    2019 </span><span class="lineCov">      64948 :                           clCorr[1]-clCorrRef[1],</span>
<span class="lineNum">    2020 </span><span class="lineCov">      64948 :                           clCorr[2]-clCorrRef[2]); // memorize distortions (difference to reference one)</span>
<span class="lineNum">    2021 </span>            :   // store the dispersion difference
<span class="lineNum">    2022 </span><span class="lineCov">      64948 :   cluster-&gt;SetDistortionDispersion(clCorr[3]); // ref error is already subtracted</span>
<span class="lineNum">    2023 </span>            :   //
<span class="lineNum">    2024 </span><span class="lineCov">      64948 :   cluster-&gt;SetX(x[0]);</span>
<span class="lineNum">    2025 </span><span class="lineCov">      64948 :   cluster-&gt;SetY(x[1]);</span>
<span class="lineNum">    2026 </span><span class="lineCov">      64948 :   cluster-&gt;SetZ(x[2]);</span>
<span class="lineNum">    2027 </span>            :   // in debug mode  check the transformation
<span class="lineNum">    2028 </span>            :   //
<span class="lineNum">    2029 </span><span class="lineCov">      64948 :   if ((AliTPCReconstructor::StreamLevel()&amp;kStreamTransform)&gt;0) { </span>
<span class="lineNum">    2030 </span><span class="lineNoCov">          0 :     Float_t gx[3];</span>
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :     cluster-&gt;GetGlobalXYZ(gx);</span>
<span class="lineNum">    2032 </span><span class="lineNoCov">          0 :     Int_t event = (fEvent==NULL)? 0: fEvent-&gt;GetEventNumberInFile();</span>
<span class="lineNum">    2033 </span><span class="lineNoCov">          0 :     TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    2034 </span><span class="lineNoCov">          0 :     Int_t timeStamp=transform-&gt;GetCurrentTimeStamp();</span>
<span class="lineNum">    2035 </span><span class="lineNoCov">          0 :     float* nCclCorr = (float*)transform-&gt;GetLastMapCorrection();  </span>
<span class="lineNum">    2036 </span><span class="lineNoCov">          0 :     float* nCclCorrRef = (float*)transform-&gt;GetLastMapCorrectionRef();</span>
<span class="lineNum">    2037 </span><span class="lineNoCov">          0 :     transform-&gt;SetDebugStreamer(fDebugStreamer);</span>
<span class="lineNum">    2038 </span>            : 
<span class="lineNum">    2039 </span><span class="lineNoCov">          0 :     cstream&lt;&lt;&quot;Transform&quot;&lt;&lt;  // needed for debugging of the cluster transformation, resp. used for later visualization </span>
<span class="lineNum">    2040 </span><span class="lineNoCov">          0 :       &quot;event=&quot;&lt;&lt;event&lt;&lt;</span>
<span class="lineNum">    2041 </span><span class="lineNoCov">          0 :       &quot;timeStamp=&quot;&lt;&lt;timeStamp&lt;&lt;</span>
<span class="lineNum">    2042 </span><span class="lineNoCov">          0 :       &quot;x0=&quot;&lt;&lt;x[0]&lt;&lt;</span>
<span class="lineNum">    2043 </span><span class="lineNoCov">          0 :       &quot;x1=&quot;&lt;&lt;x[1]&lt;&lt;</span>
<span class="lineNum">    2044 </span><span class="lineNoCov">          0 :       &quot;x2=&quot;&lt;&lt;x[2]&lt;&lt;</span>
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :       &quot;gx0=&quot;&lt;&lt;gx[0]&lt;&lt;</span>
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 :       &quot;gx1=&quot;&lt;&lt;gx[1]&lt;&lt;</span>
<span class="lineNum">    2047 </span><span class="lineNoCov">          0 :       &quot;gx2=&quot;&lt;&lt;gx[2]&lt;&lt;</span>
<span class="lineNum">    2048 </span><span class="lineNoCov">          0 :       &quot;dx=&quot;&lt;&lt;nCclCorr[0]&lt;&lt;</span>
<span class="lineNum">    2049 </span><span class="lineNoCov">          0 :       &quot;dy=&quot;&lt;&lt;nCclCorr[1]&lt;&lt;</span>
<span class="lineNum">    2050 </span><span class="lineNoCov">          0 :       &quot;dz=&quot;&lt;&lt;nCclCorr[2]&lt;&lt;</span>
<span class="lineNum">    2051 </span><span class="lineNoCov">          0 :       &quot;dxRef=&quot;&lt;&lt;nCclCorrRef[0]&lt;&lt;</span>
<span class="lineNum">    2052 </span><span class="lineNoCov">          0 :       &quot;dyRef=&quot;&lt;&lt;nCclCorrRef[1]&lt;&lt;</span>
<span class="lineNum">    2053 </span><span class="lineNoCov">          0 :       &quot;dzRef=&quot;&lt;&lt;nCclCorrRef[2]&lt;&lt;</span>
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :       &quot;Cl.=&quot;&lt;&lt;cluster&lt;&lt;</span>
<span class="lineNum">    2055 </span>            :       &quot;\n&quot;; 
<span class="lineNum">    2056 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2057 </span>            :   // The old stuff:
<span class="lineNum">    2058 </span>            :   //
<span class="lineNum">    2059 </span>            :   // 
<span class="lineNum">    2060 </span>            :   //
<span class="lineNum">    2061 </span>            :   //if (!fkParam-&gt;IsGeoRead()) fkParam-&gt;ReadGeoMatrices();
<span class="lineNum">    2062 </span><span class="lineCov">     129896 :   if (AliTPCReconstructor::GetRecoParam()-&gt;GetUseSectorAlignment() &amp;&amp; (!calibDB-&gt;HasAlignmentOCDB())){</span>
<span class="lineNum">    2063 </span><span class="lineCov">      64948 :     TGeoHMatrix  *mat = fkParam-&gt;GetClusterMatrix(cluster-&gt;GetDetector());</span>
<span class="lineNum">    2064 </span>            :     //TGeoHMatrix  mat;
<span class="lineNum">    2065 </span><span class="lineCov">      64948 :     Double_t pos[3]= {cluster-&gt;GetX(),cluster-&gt;GetY(),cluster-&gt;GetZ()};</span>
<span class="lineNum">    2066 </span><span class="lineCov">      64948 :     Double_t posC[3]={cluster-&gt;GetX(),cluster-&gt;GetY(),cluster-&gt;GetZ()};</span>
<span class="lineNum">    2067 </span><span class="lineCov">     129896 :     if (mat) mat-&gt;LocalToMaster(pos,posC);</span>
<span class="lineNum">    2068 </span>            :     else{
<span class="lineNum">    2069 </span>            :       // chack Loading of Geo matrices from GeoManager - TEMPORARY FIX
<span class="lineNum">    2070 </span>            :     }
<span class="lineNum">    2071 </span><span class="lineCov">      64948 :     cluster-&gt;SetX(posC[0]);</span>
<span class="lineNum">    2072 </span><span class="lineCov">      64948 :     cluster-&gt;SetY(posC[1]);</span>
<span class="lineNum">    2073 </span><span class="lineCov">      64948 :     cluster-&gt;SetZ(posC[2]);</span>
<span class="lineNum">    2074 </span><span class="lineCov">      64948 :   }</span>
<a name="2075"><span class="lineNum">    2075 </span><span class="lineCov">     129896 : }</span></a>
<span class="lineNum">    2076 </span>            : 
<span class="lineNum">    2077 </span>            : void  AliTPCtracker::ApplyXtalkCorrection(){
<span class="lineNum">    2078 </span>            :   //
<span class="lineNum">    2079 </span>            :   // ApplyXtalk correction 
<span class="lineNum">    2080 </span>            :   // Loop over all clusters
<span class="lineNum">    2081 </span>            :   //      add to each cluster signal corresponding to common Xtalk mode for given time bin at given wire segment
<span class="lineNum">    2082 </span>            :   // cluster loop
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :   TStopwatch sw;</span>
<span class="lineNum">    2084 </span><span class="lineNoCov">          0 :   sw.Start();</span>
<span class="lineNum">    2085 </span><span class="lineNoCov">          0 :   for (Int_t isector=0; isector&lt;36; isector++){  //loop tracking sectors</span>
<span class="lineNum">    2086 </span><span class="lineNoCov">          0 :     for (Int_t iside=0; iside&lt;2; iside++){       // loop over sides A/C</span>
<span class="lineNum">    2087 </span><span class="lineNoCov">          0 :       AliTPCtrackerSector &amp;sector= (isector&lt;18)?fInnerSec[isector%18]:fOuterSec[isector%18];</span>
<span class="lineNum">    2088 </span><span class="lineNoCov">          0 :       Int_t nrows     = sector.GetNRows();       </span>
<span class="lineNum">    2089 </span><span class="lineNoCov">          0 :       for (Int_t row = 0;row&lt;nrows;row++){           // loop over rows       </span>
<span class="lineNum">    2090 </span><span class="lineNoCov">          0 :         AliTPCtrackerRow&amp;  tpcrow = sector[row];     // row object   </span>
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :         Int_t ncl = tpcrow.GetN1();                  // number of clusters in the row</span>
<span class="lineNum">    2092 </span><span class="lineNoCov">          0 :         if (iside&gt;0) ncl=tpcrow.GetN2();</span>
<span class="lineNum">    2093 </span><span class="lineNoCov">          0 :         Int_t xSector=0;    // sector number in the TPC convention 0-72</span>
<span class="lineNum">    2094 </span><span class="lineNoCov">          0 :         if (isector&lt;18){  //if IROC</span>
<span class="lineNum">    2095 </span><span class="lineNoCov">          0 :           xSector=isector+(iside&gt;0)*18;</span>
<span class="lineNum">    2096 </span><span class="lineNoCov">          0 :         }else{</span>
<span class="lineNum">    2097 </span><span class="lineNoCov">          0 :           xSector=isector+18;  // isector -18 +36   </span>
<span class="lineNum">    2098 </span><span class="lineNoCov">          0 :           if (iside&gt;0) xSector+=18;</span>
<span class="lineNum">    2099 </span>            :         }       
<span class="lineNum">    2100 </span><span class="lineNoCov">          0 :         TMatrixD &amp;crossTalkMatrix= *((TMatrixD*)fCrossTalkSignalArray-&gt;At(xSector));</span>
<span class="lineNum">    2101 </span><span class="lineNoCov">          0 :         Int_t wireSegmentID     = fkParam-&gt;GetWireSegment(xSector,row);</span>
<span class="lineNum">    2102 </span><span class="lineNoCov">          0 :         for (Int_t i=0;i&lt;ncl;i++) {</span>
<span class="lineNum">    2103 </span><span class="lineNoCov">          0 :           AliTPCclusterMI *cluster= (iside&gt;0)?(tpcrow.GetCluster2(i)):(tpcrow.GetCluster1(i));</span>
<span class="lineNum">    2104 </span><span class="lineNoCov">          0 :           Int_t iTimeBin=TMath::Nint(cluster-&gt;GetTimeBin());</span>
<span class="lineNum">    2105 </span><span class="lineNoCov">          0 :           Double_t xTalk= crossTalkMatrix[wireSegmentID][iTimeBin];</span>
<span class="lineNum">    2106 </span><span class="lineNoCov">          0 :           cluster-&gt;SetMax(cluster-&gt;GetMax()+xTalk);</span>
<span class="lineNum">    2107 </span>            :           const Double_t kDummy=4;
<span class="lineNum">    2108 </span><span class="lineNoCov">          0 :           Double_t sumxTalk=xTalk*kDummy; // should be calculated via time response function</span>
<span class="lineNum">    2109 </span><span class="lineNoCov">          0 :           cluster-&gt;SetQ(cluster-&gt;GetQ()+sumxTalk);</span>
<span class="lineNum">    2110 </span>            : 
<span class="lineNum">    2111 </span>            : 
<span class="lineNum">    2112 </span><span class="lineNoCov">          0 :           if ((AliTPCReconstructor::StreamLevel()&amp;kStreamXtalk)&gt;0) {  // flag: stream crosstalk correctio as applied to cluster</span>
<span class="lineNum">    2113 </span><span class="lineNoCov">          0 :             TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    2114 </span><span class="lineNoCov">          0 :             if (gRandom-&gt;Rndm() &gt; 0.){</span>
<span class="lineNum">    2115 </span><span class="lineNoCov">          0 :               cstream&lt;&lt;&quot;Xtalk&quot;&lt;&lt;</span>
<span class="lineNum">    2116 </span><span class="lineNoCov">          0 :                 &quot;isector=&quot; &lt;&lt; isector &lt;&lt;               // sector [0,36]</span>
<span class="lineNum">    2117 </span><span class="lineNoCov">          0 :                 &quot;iside=&quot; &lt;&lt; iside &lt;&lt;                   // side A or C</span>
<span class="lineNum">    2118 </span><span class="lineNoCov">          0 :                 &quot;row=&quot; &lt;&lt; row &lt;&lt;                       // padrow</span>
<span class="lineNum">    2119 </span><span class="lineNoCov">          0 :                 &quot;i=&quot; &lt;&lt; i &lt;&lt;                           // index of the cluster </span>
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :                 &quot;xSector=&quot; &lt;&lt; xSector &lt;&lt;               // sector [0,72] </span>
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :                 &quot;wireSegmentID=&quot; &lt;&lt; wireSegmentID &lt;&lt;   // anode wire segment id [0,10] </span>
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :                 &quot;iTimeBin=&quot; &lt;&lt; iTimeBin &lt;&lt;             // timebin of the corrected cluster </span>
<span class="lineNum">    2123 </span><span class="lineNoCov">          0 :                 &quot;xTalk=&quot; &lt;&lt; xTalk &lt;&lt;                   // Xtalk contribution added to Qmax</span>
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :                 &quot;sumxTalk=&quot; &lt;&lt; sumxTalk &lt;&lt;             // Xtalk contribution added to Qtot (roughly 3*Xtalk) </span>
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :                 &quot;cluster.=&quot; &lt;&lt; cluster &lt;&lt;              // corrected cluster object </span>
<span class="lineNum">    2126 </span>            :                 &quot;\n&quot;;
<span class="lineNum">    2127 </span>            :             }
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :           }// dump the results to the debug streamer if in debug mode</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    2130 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    2131 </span>            :     }
<span class="lineNum">    2132 </span>            :   }
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :   sw.Stop();</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :   AliInfoF(&quot;timing: %e/%e real/cpu&quot;,sw.RealTime(),sw.CpuTime());</span>
<span class="lineNum">    2135 </span>            :   //
<a name="2136"><span class="lineNum">    2136 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2137 </span>            : 
<span class="lineNum">    2138 </span>            : void  AliTPCtracker::ApplyTailCancellation(){
<span class="lineNum">    2139 </span>            :   //
<span class="lineNum">    2140 </span>            :   // Correct the cluster charge for the ion tail effect 
<span class="lineNum">    2141 </span>            :   // The TimeResponse function accessed via  AliTPCcalibDB (TPC/Calib/IonTail)
<span class="lineNum">    2142 </span>            :   //
<span class="lineNum">    2143 </span><span class="lineNoCov">          0 :   TStopwatch sw;</span>
<span class="lineNum">    2144 </span><span class="lineNoCov">          0 :   sw.Start();</span>
<span class="lineNum">    2145 </span>            :   // Retrieve
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 :   TObjArray *ionTailArr = (TObjArray*)AliTPCcalibDB::Instance()-&gt;GetIonTailArray();</span>
<span class="lineNum">    2147 </span><span class="lineNoCov">          0 :   if (!ionTailArr) {AliFatal(&quot;TPC - Missing IonTail OCDB object&quot;);}</span>
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :   TObject *rocFactorIROC  = ionTailArr-&gt;FindObject(&quot;factorIROC&quot;);</span>
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :   TObject *rocFactorOROC  = ionTailArr-&gt;FindObject(&quot;factorOROC&quot;);   </span>
<span class="lineNum">    2150 </span><span class="lineNoCov">          0 :   Float_t factorIROC      = (atof(rocFactorIROC-&gt;GetTitle()));</span>
<span class="lineNum">    2151 </span><span class="lineNoCov">          0 :   Float_t factorOROC      = (atof(rocFactorOROC-&gt;GetTitle()));</span>
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span>            :   // find the number of clusters for the whole TPC (nclALL)
<span class="lineNum">    2154 </span><span class="lineNoCov">          0 :   Int_t nclALL=0;</span>
<span class="lineNum">    2155 </span><span class="lineNoCov">          0 :   for (Int_t isector=0; isector&lt;36; isector++){</span>
<span class="lineNum">    2156 </span><span class="lineNoCov">          0 :     AliTPCtrackerSector &amp;sector= (isector&lt;18)?fInnerSec[isector%18]:fOuterSec[isector%18];</span>
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :     nclALL += sector.GetNClInSector(0);</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :     nclALL += sector.GetNClInSector(1);</span>
<span class="lineNum">    2159 </span>            :   }
<span class="lineNum">    2160 </span>            : 
<span class="lineNum">    2161 </span>            :   //RS changed from heap allocation in the loop to stack allocation
<span class="lineNum">    2162 </span><span class="lineNoCov">          0 :   TGraphErrors * graphRes[20]; </span>
<span class="lineNum">    2163 </span><span class="lineNoCov">          0 :   Float_t        indexAmpGraphs[20];      </span>
<span class="lineNum">    2164 </span>            :   //  AliTPCclusterMI* rowClusterArray[kMaxClusterPerRow]; // caches clusters for each row  // RS avoid trashing the heap
<span class="lineNum">    2165 </span>            : 
<span class="lineNum">    2166 </span>            :   // start looping over all clusters 
<span class="lineNum">    2167 </span><span class="lineNoCov">          0 :   for (Int_t iside=0; iside&lt;2; iside++){    // loop over sides</span>
<span class="lineNum">    2168 </span>            :     //
<span class="lineNum">    2169 </span>            :     //
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :     for (Int_t secType=0; secType&lt;2; secType++){  //loop over inner or outer sector</span>
<span class="lineNum">    2171 </span>            :       // cache experimantal tuning factor for the different chamber type 
<span class="lineNum">    2172 </span><span class="lineNoCov">          0 :       const Float_t ampfactor = (secType==0)?factorIROC:factorOROC;</span>
<span class="lineNum">    2173 </span>            : //       std::cout &lt;&lt; &quot; ampfactor = &quot; &lt;&lt; ampfactor &lt;&lt; std::endl;
<span class="lineNum">    2174 </span>            :       //
<span class="lineNum">    2175 </span><span class="lineNoCov">          0 :       for (Int_t sec = 0;sec&lt;fkNOS;sec++){        //loop overs sectors</span>
<span class="lineNum">    2176 </span>            :         //
<span class="lineNum">    2177 </span>            :         //
<span class="lineNum">    2178 </span>            :         // Cache time response functions and their positons to COG of the cluster       
<span class="lineNum">    2179 </span>            :         // TGraphErrors ** graphRes   = new TGraphErrors *[20]; // RS avoid heap allocations if stack can be used
<span class="lineNum">    2180 </span>            :         // Float_t * indexAmpGraphs   = new Float_t[20];        // RS Moved outside of the loop
<span class="lineNum">    2181 </span><span class="lineNoCov">          0 :         memset(graphRes,0,20*sizeof(TGraphErrors*));</span>
<span class="lineNum">    2182 </span><span class="lineNoCov">          0 :         memset(indexAmpGraphs,0,20*sizeof(float));</span>
<span class="lineNum">    2183 </span>            :         //for (Int_t icache=0; icache&lt;20; icache++)  //RS
<span class="lineNum">    2184 </span>            :         //{
<span class="lineNum">    2185 </span>            :         //  graphRes[icache]       = NULL;
<span class="lineNum">    2186 </span>            :         //  indexAmpGraphs[icache] = 0;
<span class="lineNum">    2187 </span>            :         // }
<span class="lineNum">    2188 </span>            :         /////////////////////////////  --&gt; position fo sie loop
<span class="lineNum">    2189 </span><span class="lineNoCov">          0 :         if (!AliTPCcalibDB::Instance()-&gt;GetTailcancelationGraphs(sec+36*secType+18*iside,graphRes,indexAmpGraphs))</span>
<span class="lineNum">    2190 </span>            :         {
<span class="lineNum">    2191 </span>            :           continue;
<span class="lineNum">    2192 </span>            :         }
<span class="lineNum">    2193 </span>            : 
<span class="lineNum">    2194 </span>            :         // set time range from graph
<span class="lineNum">    2195 </span><span class="lineNoCov">          0 :         const Int_t timeRangeMax=graphRes[0]?graphRes[0]-&gt;GetN():600;</span>
<span class="lineNum">    2196 </span>            : //         std::cout &lt;&lt; &quot; timeRangeMax = &quot; &lt;&lt; timeRangeMax &lt;&lt; std::endl;
<span class="lineNum">    2197 </span>            : 
<span class="lineNum">    2198 </span><span class="lineNoCov">          0 :         AliTPCtrackerSector &amp;sector= (secType==0)?fInnerSec[sec]:fOuterSec[sec];  </span>
<span class="lineNum">    2199 </span><span class="lineNoCov">          0 :         Int_t nrows     = sector.GetNRows();                                       // number of rows</span>
<span class="lineNum">    2200 </span><span class="lineNoCov">          0 :         Int_t nclSector = sector.GetNClInSector(iside);                            // ncl per sector to be used for debugging</span>
<span class="lineNum">    2201 </span>            : 
<span class="lineNum">    2202 </span><span class="lineNoCov">          0 :         for (Int_t row = 0;row&lt;nrows;row++){           // loop over rows</span>
<span class="lineNum">    2203 </span>            : 
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :           AliTPCtrackerRow&amp;  tpcrow = sector[row];     // row object   </span>
<span class="lineNum">    2205 </span><span class="lineNoCov">          0 :           Int_t ncl = tpcrow.GetN1();                  // number of clusters in the row</span>
<span class="lineNum">    2206 </span><span class="lineNoCov">          0 :           if (iside&gt;0) ncl=tpcrow.GetN2();</span>
<span class="lineNum">    2207 </span>            : 
<span class="lineNum">    2208 </span>            :           // Order clusters in time for the proper correction of ion tail
<span class="lineNum">    2209 </span><span class="lineNoCov">          0 :           Float_t qTotArray[ncl];          // arrays to be filled with modified Qtot and Qmax values in order to avoid float-&gt;int conversion  </span>
<span class="lineNum">    2210 </span><span class="lineNoCov">          0 :           Float_t qMaxArray[ncl];</span>
<span class="lineNum">    2211 </span><span class="lineNoCov">          0 :           Int_t sortedClusterIndex[ncl];</span>
<span class="lineNum">    2212 </span><span class="lineNoCov">          0 :           Float_t sortedClusterTimeBin[ncl];</span>
<span class="lineNum">    2213 </span>            :           //TObjArray *rowClusterArray = new TObjArray(ncl);  // cache clusters for each row  // RS avoid trashing the heap
<span class="lineNum">    2214 </span><span class="lineNoCov">          0 :           AliTPCclusterMI* rowClusterArray[ncl]; // caches clusters for each row  // RS avoid trashing the heap </span>
<span class="lineNum">    2215 </span>            :           //  memset(rowClusterArray,0,sizeof(AliTPCclusterMI*)*ncl);  //.Clear();
<span class="lineNum">    2216 </span>            :           //if (rowClusterArray.GetSize()&lt;ncl) rowClusterArray.Expand(ncl);
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :           for (Int_t i=0;i&lt;ncl;i++) </span>
<span class="lineNum">    2218 </span>            :           {
<span class="lineNum">    2219 </span><span class="lineNoCov">          0 :             qTotArray[i]=0;</span>
<span class="lineNum">    2220 </span><span class="lineNoCov">          0 :             qMaxArray[i]=0;</span>
<span class="lineNum">    2221 </span><span class="lineNoCov">          0 :             sortedClusterIndex[i]=i;</span>
<span class="lineNum">    2222 </span><span class="lineNoCov">          0 :             AliTPCclusterMI *rowcl= (iside&gt;0)?(tpcrow.GetCluster2(i)):(tpcrow.GetCluster1(i));</span>
<span class="lineNum">    2223 </span><span class="lineNoCov">          0 :             rowClusterArray[i] = rowcl;</span>
<span class="lineNum">    2224 </span>            :             //if (rowcl) {
<span class="lineNum">    2225 </span>            :             //  rowClusterArray.AddAt(rowcl,i);
<span class="lineNum">    2226 </span>            :             //} else {
<span class="lineNum">    2227 </span>            :             //  rowClusterArray.RemoveAt(i);
<span class="lineNum">    2228 </span>            :             //}
<span class="lineNum">    2229 </span>            :             // Fill the timebin info to the array in order to sort wrt tb
<span class="lineNum">    2230 </span><span class="lineNoCov">          0 :             if (!rowcl) {</span>
<span class="lineNum">    2231 </span><span class="lineNoCov">          0 :               sortedClusterTimeBin[i]=0.0;</span>
<span class="lineNum">    2232 </span><span class="lineNoCov">          0 :             } else {</span>
<span class="lineNum">    2233 </span><span class="lineNoCov">          0 :               sortedClusterTimeBin[i] = rowcl-&gt;GetTimeBin();</span>
<span class="lineNum">    2234 </span>            :             }
<span class="lineNum">    2235 </span>            : 
<span class="lineNum">    2236 </span>            :           } 
<span class="lineNum">    2237 </span><span class="lineNoCov">          0 :           TMath::Sort(ncl,sortedClusterTimeBin,sortedClusterIndex,kFALSE);       // sort clusters in time</span>
<span class="lineNum">    2238 </span>            :      
<span class="lineNum">    2239 </span>            :           // Main cluster correction loops over clusters
<span class="lineNum">    2240 </span><span class="lineNoCov">          0 :           for (Int_t icl0=0; icl0&lt;ncl;icl0++){    // first loop over clusters</span>
<span class="lineNum">    2241 </span>            : 
<span class="lineNum">    2242 </span><span class="lineNoCov">          0 :             AliTPCclusterMI *cl0= rowClusterArray[sortedClusterIndex[icl0]]; //RS static_cast&lt;AliTPCclusterMI*&gt;(rowClusterArray.At(sortedClusterIndex[icl0]));</span>
<span class="lineNum">    2243 </span>            :             
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :             if (!cl0) continue;</span>
<span class="lineNum">    2245 </span><span class="lineNoCov">          0 :             Int_t nclPad=0;</span>
<span class="lineNum">    2246 </span>            :             //for (Int_t icl1=0; icl1&lt;ncl;icl1++){  // second loop over clusters        
<span class="lineNum">    2247 </span>            :             // RS: time increases with index since sorted -&gt; cl0-&gt;GetTimeBin()&gt;cl1-&gt;GetTimeBin() means that icl0&gt;icl1
<span class="lineNum">    2248 </span><span class="lineNoCov">          0 :             for (Int_t icl1=0; icl1&lt;icl0;icl1++){  // second loop over clusters</span>
<span class="lineNum">    2249 </span><span class="lineNoCov">          0 :               AliTPCclusterMI *cl1= rowClusterArray[sortedClusterIndex[icl1]];//RS static_cast&lt;AliTPCclusterMI*&gt;(rowClusterArray.At(sortedClusterIndex[icl1]));</span>
<span class="lineNum">    2250 </span><span class="lineNoCov">          0 :               if (!cl1) continue;</span>
<span class="lineNum">    2251 </span>            :               // RS no needed with proper loop organization
<span class="lineNum">    2252 </span>            :               //if (cl0-&gt;GetTimeBin()&lt;= cl1-&gt;GetTimeBin()) continue;               // no contibution to the tail if later
<span class="lineNum">    2253 </span>            : 
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 :               int dpad = TMath::Abs(cl0-&gt;GetPad()-cl1-&gt;GetPad());</span>
<span class="lineNum">    2255 </span><span class="lineNoCov">          0 :               if (dpad&gt;4) continue;           // no contribution if far away in pad direction</span>
<span class="lineNum">    2256 </span>            : 
<span class="lineNum">    2257 </span>            :               // RS no point in iterating further with sorted clusters once large distance reached
<span class="lineNum">    2258 </span><span class="lineNoCov">          0 :               if (cl0-&gt;GetTimeBin()-cl1-&gt;GetTimeBin()&gt;=timeRangeMax) continue; // out of the range of response function</span>
<span class="lineNum">    2259 </span>            : 
<span class="lineNum">    2260 </span>            :               // RS: what about dpad=4?
<span class="lineNum">    2261 </span><span class="lineNoCov">          0 :               if (dpad&lt;4) nclPad++;           // count ncl for every pad for debugging</span>
<span class="lineNum">    2262 </span>            :             
<span class="lineNum">    2263 </span>            :               // Get the correction values for Qmax and Qtot and find total correction for a given cluster
<span class="lineNum">    2264 </span><span class="lineNoCov">          0 :               Double_t ionTailMax=0.;  </span>
<span class="lineNum">    2265 </span><span class="lineNoCov">          0 :               Double_t ionTailTotal=0.;  </span>
<span class="lineNum">    2266 </span><span class="lineNoCov">          0 :               GetTailValue(ampfactor,ionTailMax,ionTailTotal,graphRes,indexAmpGraphs,cl0,cl1);</span>
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :               ionTailMax=TMath::Abs(ionTailMax);</span>
<span class="lineNum">    2268 </span><span class="lineNoCov">          0 :               ionTailTotal=TMath::Abs(ionTailTotal);</span>
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :               qTotArray[icl0]+=ionTailTotal;</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :               qMaxArray[icl0]+=ionTailMax;</span>
<span class="lineNum">    2271 </span>            : 
<span class="lineNum">    2272 </span>            :               // Dump some info for debugging while clusters are being corrected
<span class="lineNum">    2273 </span><span class="lineNoCov">          0 :               if ((AliTPCReconstructor::StreamLevel()&amp;kStreamIonTail)&gt;0) {  // flag: stream ion tail correction  as applied to cluster</span>
<span class="lineNum">    2274 </span><span class="lineNoCov">          0 :                 TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    2275 </span><span class="lineNoCov">          0 :                 if (gRandom-&gt;Rndm() &gt; 0.999){</span>
<span class="lineNum">    2276 </span><span class="lineNoCov">          0 :                   cstream&lt;&lt;&quot;IonTail&quot;&lt;&lt;</span>
<span class="lineNum">    2277 </span><span class="lineNoCov">          0 :                       &quot;cl0.=&quot;         &lt;&lt;cl0          &lt;&lt;   // cluster 0 (to be corrected)</span>
<span class="lineNum">    2278 </span><span class="lineNoCov">          0 :                       &quot;cl1.=&quot;         &lt;&lt;cl1          &lt;&lt;   // cluster 1 (previous cluster)</span>
<span class="lineNum">    2279 </span><span class="lineNoCov">          0 :                       &quot;ionTailTotal=&quot; &lt;&lt;ionTailTotal &lt;&lt;   // ion Tail from cluster 1 contribution to cluster0</span>
<span class="lineNum">    2280 </span><span class="lineNoCov">          0 :                       &quot;ionTailMax=&quot;   &lt;&lt;ionTailMax   &lt;&lt;   // ion Tail from cluster 1 contribution to cluster0 </span>
<span class="lineNum">    2281 </span>            :                       &quot;\n&quot;;
<span class="lineNum">    2282 </span>            :                 }
<span class="lineNum">    2283 </span><span class="lineNoCov">          0 :               }// dump the results to the debug streamer if in debug mode</span>
<span class="lineNum">    2284 </span>            :             
<span class="lineNum">    2285 </span><span class="lineNoCov">          0 :             }//end of second loop over clusters</span>
<span class="lineNum">    2286 </span>            :             
<span class="lineNum">    2287 </span>            :             // Set corrected values of the corrected cluster          
<span class="lineNum">    2288 </span><span class="lineNoCov">          0 :             cl0-&gt;SetQ(TMath::Nint(Float_t(cl0-&gt;GetQ())+Float_t(qTotArray[icl0])));</span>
<span class="lineNum">    2289 </span><span class="lineNoCov">          0 :             cl0-&gt;SetMax(TMath::Nint(Float_t(cl0-&gt;GetMax())+qMaxArray[icl0]));</span>
<span class="lineNum">    2290 </span>            :           
<span class="lineNum">    2291 </span>            :             // Dump some info for debugging after clusters are corrected 
<span class="lineNum">    2292 </span><span class="lineNoCov">          0 :             if ((AliTPCReconstructor::StreamLevel()&amp;kStreamIonTail)&gt;0) {</span>
<span class="lineNum">    2293 </span><span class="lineNoCov">          0 :               TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    2294 </span><span class="lineNoCov">          0 :               if (gRandom-&gt;Rndm() &gt; 0.999){</span>
<span class="lineNum">    2295 </span><span class="lineNoCov">          0 :               cstream&lt;&lt;&quot;IonTailCorrected&quot;&lt;&lt;</span>
<span class="lineNum">    2296 </span><span class="lineNoCov">          0 :                   &quot;cl0.=&quot;                     &lt;&lt; cl0              &lt;&lt;   // cluster 0 with huge Qmax</span>
<span class="lineNum">    2297 </span><span class="lineNoCov">          0 :                   &quot;ionTailTotalPerCluster=&quot;   &lt;&lt; qTotArray[icl0]  &lt;&lt;</span>
<span class="lineNum">    2298 </span><span class="lineNoCov">          0 :                   &quot;ionTailMaxPerCluster=&quot;     &lt;&lt; qMaxArray[icl0]  &lt;&lt;</span>
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :                   &quot;nclALL=&quot;                   &lt;&lt; nclALL           &lt;&lt;</span>
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :                   &quot;nclSector=&quot;                &lt;&lt; nclSector        &lt;&lt;</span>
<span class="lineNum">    2301 </span><span class="lineNoCov">          0 :                   &quot;nclRow=&quot;                   &lt;&lt; ncl              &lt;&lt;</span>
<span class="lineNum">    2302 </span><span class="lineNoCov">          0 :                   &quot;nclPad=&quot;                   &lt;&lt; nclPad           &lt;&lt;</span>
<span class="lineNum">    2303 </span><span class="lineNoCov">          0 :                   &quot;row=&quot;                      &lt;&lt; row              &lt;&lt;</span>
<span class="lineNum">    2304 </span><span class="lineNoCov">          0 :                   &quot;sector=&quot;                   &lt;&lt; sec              &lt;&lt;</span>
<span class="lineNum">    2305 </span><span class="lineNoCov">          0 :                   &quot;icl0=&quot;                     &lt;&lt; icl0             &lt;&lt;</span>
<span class="lineNum">    2306 </span>            :                   &quot;\n&quot;;
<span class="lineNum">    2307 </span>            :               }
<span class="lineNum">    2308 </span><span class="lineNoCov">          0 :             }// dump the results to the debug streamer if in debug mode</span>
<span class="lineNum">    2309 </span>            :           
<span class="lineNum">    2310 </span><span class="lineNoCov">          0 :           }//end of first loop over cluster</span>
<span class="lineNum">    2311 </span>            :           // delete rowClusterArray; // RS was moved to stack allocation
<span class="lineNum">    2312 </span><span class="lineNoCov">          0 :         }//end of loop over rows</span>
<span class="lineNum">    2313 </span><span class="lineNoCov">          0 :         for (int i=0; i&lt;20; i++) delete graphRes[i];</span>
<span class="lineNum">    2314 </span>            :         //        delete [] graphRes; //RS was changed to stack allocation
<span class="lineNum">    2315 </span>            :         //        delete [] indexAmpGraphs;
<span class="lineNum">    2316 </span>            :       
<span class="lineNum">    2317 </span><span class="lineNoCov">          0 :       }//end of loop over sectors</span>
<span class="lineNum">    2318 </span>            :     }//end of loop over IROC/OROC
<span class="lineNum">    2319 </span>            :   }// end of side loop
<span class="lineNum">    2320 </span><span class="lineNoCov">          0 :   sw.Stop();</span>
<span class="lineNum">    2321 </span><span class="lineNoCov">          0 :   AliInfoF(&quot;timing: %e/%e real/cpu&quot;,sw.RealTime(),sw.CpuTime());</span>
<span class="lineNum">    2322 </span>            :   //
<a name="2323"><span class="lineNum">    2323 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2324 </span>            : //_____________________________________________________________________________
<span class="lineNum">    2325 </span>            : void AliTPCtracker::GetTailValue(Float_t ampfactor,Double_t &amp;ionTailMax, Double_t &amp;ionTailTotal,TGraphErrors **graphRes,Float_t *indexAmpGraphs,AliTPCclusterMI *cl0,AliTPCclusterMI *cl1){
<span class="lineNum">    2326 </span>            : 
<span class="lineNum">    2327 </span>            :   //
<span class="lineNum">    2328 </span>            :   // Function in order to calculate the amount of the correction to be added for a given cluster, return values are ionTailTaoltal and ionTailMax
<span class="lineNum">    2329 </span>            :   // Parameters:
<span class="lineNum">    2330 </span>            :   // cl0 -  cluster to be modified
<span class="lineNum">    2331 </span>            :   // cl1 -  source cluster ion tail of this cluster will be added to the cl0 (accroding time and pad response function)
<span class="lineNum">    2332 </span>            :   // 
<span class="lineNum">    2333 </span>            :   const float kMinPRF       = 0.5f;                          // minimal PRF width
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :   ionTailTotal              = 0.;                            // correction value to be added to Qtot of cl0</span>
<span class="lineNum">    2335 </span><span class="lineNoCov">          0 :   ionTailMax                = 0.;                            // correction value to be added to Qmax of cl0</span>
<span class="lineNum">    2336 </span>            : 
<span class="lineNum">    2337 </span><span class="lineNoCov">          0 :   Float_t qTot0             =  cl0-&gt;GetQ();                  // cl0 Qtot info</span>
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :   Float_t qTot1             =  cl1-&gt;GetQ();                  // cl1 Qtot info</span>
<span class="lineNum">    2339 </span><span class="lineNoCov">          0 :   Int_t sectorPad           =  cl1-&gt;GetDetector();           // sector number</span>
<span class="lineNum">    2340 </span><span class="lineNoCov">          0 :   Int_t padcl0              =  TMath::Nint(cl0-&gt;GetPad());   // pad0</span>
<span class="lineNum">    2341 </span><span class="lineNoCov">          0 :   Int_t padcl1              =  TMath::Nint(cl1-&gt;GetPad());   // pad1</span>
<span class="lineNum">    2342 </span><span class="lineNoCov">          0 :   Float_t padWidth          = (sectorPad &lt; 36)?0.4:0.6;      // pad width in cm</span>
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :   const Int_t deltaTimebin  =  TMath::Nint(TMath::Abs(cl1-&gt;GetTimeBin()-cl0-&gt;GetTimeBin()))+12;  //distance between pads of cl1 and cl0 increased by 12 bins</span>
<span class="lineNum">    2344 </span><span class="lineNoCov">          0 :   float rmsPad1I            = (cl1-&gt;GetSigmaY2()==0)?0.5f/kMinPRF:(0.5f*padWidth/sqrtf(cl1-&gt;GetSigmaY2()));</span>
<span class="lineNum">    2345 </span><span class="lineNoCov">          0 :   float rmsPad0I            = (cl0-&gt;GetSigmaY2()==0)?0.5f/kMinPRF:(0.5f*padWidth/sqrtf(cl0-&gt;GetSigmaY2()));</span>
<span class="lineNum">    2346 </span>            :   
<span class="lineNum">    2347 </span>            :   // RS avoid useless calculations
<span class="lineNum">    2348 </span>            :   //Double_t sumAmp1=0.;
<span class="lineNum">    2349 </span>            :   //for (Int_t idelta =-2; idelta&lt;=2;idelta++){
<span class="lineNum">    2350 </span>            :   //  sumAmp1+=TMath::Exp(-idelta*idelta*rmsPad1I);
<span class="lineNum">    2351 </span>            :   //}
<span class="lineNum">    2352 </span>            :   // Double_t sumAmp0=0.;
<span class="lineNum">    2353 </span>            :   //for (Int_t idelta =-2; idelta&lt;=2;idelta++){
<span class="lineNum">    2354 </span>            :   //  sumAmp0+=TMath::Exp(-idelta*idelta*rmsPad0I));
<span class="lineNum">    2355 </span>            :   //}
<span class="lineNum">    2356 </span>            : 
<span class="lineNum">    2357 </span><span class="lineNoCov">          0 :   float tmp = expf(-rmsPad1I);</span>
<span class="lineNum">    2358 </span><span class="lineNoCov">          0 :   float sumAmp1 = 1.f/(1.f+2.f*tmp*(1.f+tmp*tmp*tmp));</span>
<span class="lineNum">    2359 </span><span class="lineNoCov">          0 :   tmp = expf(-rmsPad0I);</span>
<span class="lineNum">    2360 </span><span class="lineNoCov">          0 :   float sumAmp0 = 1.f/(1.f+2.f*tmp*(1.f+tmp*tmp*tmp));</span>
<span class="lineNum">    2361 </span>            : 
<span class="lineNum">    2362 </span>            :   // Apply the correction  --&gt;   cl1 corrects cl0 (loop over cl1's pads and find which pads of cl0 are going to be corrected)
<span class="lineNum">    2363 </span>            :   Int_t padScan=2;      // +-2 pad-timebin window will be scanned
<span class="lineNum">    2364 </span><span class="lineNoCov">          0 :   for (Int_t ipad1=padcl1-padScan; ipad1&lt;=padcl1+padScan; ipad1++) {</span>
<span class="lineNum">    2365 </span>            :     //
<span class="lineNum">    2366 </span>            :     //
<span class="lineNum">    2367 </span><span class="lineNoCov">          0 :     Float_t deltaPad1  = TMath::Abs(cl1-&gt;GetPad()-(Float_t)ipad1);</span>
<span class="lineNum">    2368 </span><span class="lineNoCov">          0 :     Float_t amp1       = TMath::Exp(-(deltaPad1*deltaPad1)*rmsPad1I)*sumAmp1;  // normalized pad response function</span>
<span class="lineNum">    2369 </span><span class="lineNoCov">          0 :     Float_t qTotPad1   = amp1*qTot1;                                           // used as a factor to multipliy the response function</span>
<span class="lineNum">    2370 </span>            :       
<span class="lineNum">    2371 </span>            :     // find closest value of cl1 to COG (among the time response functions' amplitude array --&gt; to select proper t.r.f.)
<span class="lineNum">    2372 </span>            :     Int_t ampIndex = 0;
<span class="lineNum">    2373 </span><span class="lineNoCov">          0 :     Float_t diffAmp  = TMath::Abs(deltaPad1-indexAmpGraphs[0]);</span>
<span class="lineNum">    2374 </span><span class="lineNoCov">          0 :     for (Int_t j=0;j&lt;20;j++) {</span>
<span class="lineNum">    2375 </span><span class="lineNoCov">          0 :       if (diffAmp &gt; TMath::Abs(deltaPad1-indexAmpGraphs[j]) &amp;&amp; indexAmpGraphs[j]!=0)</span>
<span class="lineNum">    2376 </span>            :         {
<span class="lineNum">    2377 </span><span class="lineNoCov">          0 :           diffAmp  = TMath::Abs(deltaPad1-indexAmpGraphs[j]);</span>
<span class="lineNum">    2378 </span>            :           ampIndex = j;
<span class="lineNum">    2379 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    2380 </span>            :     }
<span class="lineNum">    2381 </span><span class="lineNoCov">          0 :     if (!graphRes[ampIndex]) continue;</span>
<span class="lineNum">    2382 </span><span class="lineNoCov">          0 :     if (deltaTimebin+2 &gt;= graphRes[ampIndex]-&gt;GetN()) continue;</span>
<span class="lineNum">    2383 </span><span class="lineNoCov">          0 :     if (graphRes[ampIndex]-&gt;GetY()[deltaTimebin+2]&gt;=0) continue;</span>
<span class="lineNum">    2384 </span>            :      
<span class="lineNum">    2385 </span><span class="lineNoCov">          0 :     for (Int_t ipad0=padcl0-padScan; ipad0&lt;=padcl0+padScan; ipad0++) {</span>
<span class="lineNum">    2386 </span>            :       //
<span class="lineNum">    2387 </span>            :       //
<span class="lineNum">    2388 </span><span class="lineNoCov">          0 :       if (ipad1!=ipad0) continue;                                     // check if ipad1 channel sees ipad0 channel, if not no correction to be applied.</span>
<span class="lineNum">    2389 </span>            :       
<span class="lineNum">    2390 </span><span class="lineNoCov">          0 :       Float_t deltaPad0  = TMath::Abs(cl0-&gt;GetPad()-(Float_t)ipad0);</span>
<span class="lineNum">    2391 </span><span class="lineNoCov">          0 :       Float_t amp0       = expf(-(deltaPad0*deltaPad0)*rmsPad0I)*sumAmp0;  // normalized pad resp function</span>
<span class="lineNum">    2392 </span><span class="lineNoCov">          0 :       Float_t qMaxPad0   = amp0*qTot0;</span>
<span class="lineNum">    2393 </span>            :            
<span class="lineNum">    2394 </span>            :       // Add 5 timebin range contribution around the max peak (-+2 tb window)
<span class="lineNum">    2395 </span><span class="lineNoCov">          0 :       for (Int_t itb=deltaTimebin-2; itb&lt;=deltaTimebin+2; itb++) {</span>
<span class="lineNum">    2396 </span>            : 
<span class="lineNum">    2397 </span><span class="lineNoCov">          0 :         if (itb&lt;0) continue; </span>
<span class="lineNum">    2398 </span><span class="lineNoCov">          0 :         if (itb&gt;=graphRes[ampIndex]-&gt;GetN()) continue;</span>
<span class="lineNum">    2399 </span>            :        
<span class="lineNum">    2400 </span>            :         // calculate contribution to qTot
<span class="lineNum">    2401 </span><span class="lineNoCov">          0 :         Float_t tailCorr =  TMath::Abs((qTotPad1*ampfactor)*(graphRes[ampIndex])-&gt;GetY()[itb]);</span>
<span class="lineNum">    2402 </span><span class="lineNoCov">          0 :         if (ipad1!=padcl0) { </span>
<span class="lineNum">    2403 </span><span class="lineNoCov">          0 :           ionTailTotal += TMath::Min(qMaxPad0,tailCorr);   // for side pad</span>
<span class="lineNum">    2404 </span><span class="lineNoCov">          0 :         } else {             </span>
<span class="lineNum">    2405 </span><span class="lineNoCov">          0 :           ionTailTotal += tailCorr;                        // for center pad</span>
<span class="lineNum">    2406 </span>            :         }
<span class="lineNum">    2407 </span>            :         // calculate contribution to qMax
<span class="lineNum">    2408 </span><span class="lineNoCov">          0 :         if (itb == deltaTimebin &amp;&amp; ipad1 == padcl0) ionTailMax += tailCorr;   </span>
<span class="lineNum">    2409 </span>            :         
<span class="lineNum">    2410 </span><span class="lineNoCov">          0 :       } // end of tb correction loop which is applied over 5 tb range</span>
<span class="lineNum">    2411 </span>            : 
<span class="lineNum">    2412 </span><span class="lineNoCov">          0 :     } // end of cl0 loop</span>
<span class="lineNum">    2413 </span><span class="lineNoCov">          0 :   } // end of cl1 loop</span>
<span class="lineNum">    2414 </span>            :   
<span class="lineNum">    2415 </span><span class="lineNoCov">          0 : }</span>
<a name="2416"><span class="lineNum">    2416 </span>            : </a>
<span class="lineNum">    2417 </span>            : //_____________________________________________________________________________
<span class="lineNum">    2418 </span>            : Int_t AliTPCtracker::LoadOuterSectors() {
<span class="lineNum">    2419 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2420 </span>            :   // This function fills outer TPC sectors with clusters.
<span class="lineNum">    2421 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2422 </span><span class="lineCov">         16 :   Int_t nrows = fOuterSec-&gt;GetNRows();</span>
<span class="lineNum">    2423 </span>            :   UInt_t index=0;
<span class="lineNum">    2424 </span><span class="lineCov">        304 :   for (Int_t sec = 0;sec&lt;fkNOS;sec++)</span>
<span class="lineNum">    2425 </span><span class="lineCov">      27936 :     for (Int_t row = 0;row&lt;nrows;row++){</span>
<span class="lineNum">    2426 </span><span class="lineCov">      13824 :       AliTPCtrackerRow*  tpcrow = &amp;(fOuterSec[sec%fkNOS][row]);  </span>
<span class="lineNum">    2427 </span><span class="lineCov">      13824 :       Int_t sec2 = sec+2*fkNIS;</span>
<span class="lineNum">    2428 </span>            :       //left
<span class="lineNum">    2429 </span><span class="lineCov">      13824 :       Int_t ncl = tpcrow-&gt;GetN1();</span>
<span class="lineNum">    2430 </span><span class="lineCov">      43732 :       while (ncl--) {</span>
<span class="lineNum">    2431 </span><span class="lineCov">       8042 :         AliTPCclusterMI *c= (tpcrow-&gt;GetCluster1(ncl));</span>
<span class="lineNum">    2432 </span><span class="lineCov">       8042 :         index=(((sec2&lt;&lt;8)+row)&lt;&lt;16)+ncl;</span>
<span class="lineNum">    2433 </span><span class="lineCov">       8042 :         tpcrow-&gt;InsertCluster(c,index);</span>
<span class="lineNum">    2434 </span>            :       }
<span class="lineNum">    2435 </span>            :       //right
<span class="lineNum">    2436 </span><span class="lineCov">      13824 :       ncl = tpcrow-&gt;GetN2();</span>
<span class="lineNum">    2437 </span><span class="lineCov">      49260 :       while (ncl--) {</span>
<span class="lineNum">    2438 </span><span class="lineCov">      10806 :         AliTPCclusterMI *c= (tpcrow-&gt;GetCluster2(ncl));</span>
<span class="lineNum">    2439 </span><span class="lineCov">      10806 :         index=((((sec2+fkNOS)&lt;&lt;8)+row)&lt;&lt;16)+ncl;</span>
<span class="lineNum">    2440 </span><span class="lineCov">      10806 :         tpcrow-&gt;InsertCluster(c,index);</span>
<span class="lineNum">    2441 </span>            :       }
<span class="lineNum">    2442 </span>            :       //
<span class="lineNum">    2443 </span>            :       // write indexes for fast acces
<span class="lineNum">    2444 </span>            :       //
<span class="lineNum">    2445 </span><span class="lineCov">   14128128 :       for (Int_t i=510;i--;) tpcrow-&gt;SetFastCluster(i,-1);</span>
<span class="lineNum">    2446 </span><span class="lineCov">      65344 :       for (Int_t i=0;i&lt;tpcrow-&gt;GetN();i++){</span>
<span class="lineNum">    2447 </span><span class="lineCov">      18848 :         Int_t zi = Int_t((*tpcrow)[i]-&gt;GetZ()+255.);</span>
<span class="lineNum">    2448 </span><span class="lineCov">      18848 :         tpcrow-&gt;SetFastCluster(zi,i);  // write index</span>
<span class="lineNum">    2449 </span>            :       }
<span class="lineNum">    2450 </span>            :       Int_t last = 0;
<span class="lineNum">    2451 </span><span class="lineCov">   14128128 :       for (Int_t i=0;i&lt;510;i++){</span>
<span class="lineNum">    2452 </span><span class="lineCov">    7050240 :         if (tpcrow-&gt;GetFastCluster(i)&lt;0)</span>
<span class="lineNum">    2453 </span><span class="lineCov">    7033150 :           tpcrow-&gt;SetFastCluster(i,last);</span>
<span class="lineNum">    2454 </span>            :         else
<span class="lineNum">    2455 </span><span class="lineCov">      17090 :           last = tpcrow-&gt;GetFastCluster(i);</span>
<span class="lineNum">    2456 </span>            :       }
<span class="lineNum">    2457 </span>            :     }  
<span class="lineNum">    2458 </span><span class="lineCov">          8 :   fN=fkNOS;</span>
<span class="lineNum">    2459 </span><span class="lineCov">          8 :   fSectors=fOuterSec;</span>
<span class="lineNum">    2460 </span><span class="lineCov">          8 :   return 0;</span>
<span class="lineNum">    2461 </span>            : }
<span class="lineNum">    2462 </span>            : 
<a name="2463"><span class="lineNum">    2463 </span>            : </a>
<span class="lineNum">    2464 </span>            : //_____________________________________________________________________________
<span class="lineNum">    2465 </span>            : Int_t  AliTPCtracker::LoadInnerSectors() {
<span class="lineNum">    2466 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2467 </span>            :   // This function fills inner TPC sectors with clusters.
<span class="lineNum">    2468 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2469 </span><span class="lineCov">         16 :   Int_t nrows = fInnerSec-&gt;GetNRows();</span>
<span class="lineNum">    2470 </span>            :   UInt_t index=0;
<span class="lineNum">    2471 </span><span class="lineCov">        304 :   for (Int_t sec = 0;sec&lt;fkNIS;sec++)</span>
<span class="lineNum">    2472 </span><span class="lineCov">      18432 :     for (Int_t row = 0;row&lt;nrows;row++){</span>
<span class="lineNum">    2473 </span><span class="lineCov">       9072 :       AliTPCtrackerRow*  tpcrow = &amp;(fInnerSec[sec%fkNIS][row]);</span>
<span class="lineNum">    2474 </span>            :       //
<span class="lineNum">    2475 </span>            :       //left
<span class="lineNum">    2476 </span><span class="lineCov">       9072 :       Int_t ncl = tpcrow-&gt;GetN1();</span>
<span class="lineNum">    2477 </span><span class="lineCov">      69400 :       while (ncl--) {</span>
<span class="lineNum">    2478 </span><span class="lineCov">      25628 :         AliTPCclusterMI *c= (tpcrow-&gt;GetCluster1(ncl));</span>
<span class="lineNum">    2479 </span><span class="lineCov">      25628 :         index=(((sec&lt;&lt;8)+row)&lt;&lt;16)+ncl;</span>
<span class="lineNum">    2480 </span><span class="lineCov">      25628 :         tpcrow-&gt;InsertCluster(c,index);</span>
<span class="lineNum">    2481 </span>            :       }
<span class="lineNum">    2482 </span>            :       //right
<span class="lineNum">    2483 </span><span class="lineCov">       9072 :       ncl = tpcrow-&gt;GetN2();</span>
<span class="lineNum">    2484 </span><span class="lineCov">      59088 :       while (ncl--) {</span>
<span class="lineNum">    2485 </span><span class="lineCov">      20472 :         AliTPCclusterMI *c= (tpcrow-&gt;GetCluster2(ncl));</span>
<span class="lineNum">    2486 </span><span class="lineCov">      20472 :         index=((((sec+fkNIS)&lt;&lt;8)+row)&lt;&lt;16)+ncl;</span>
<span class="lineNum">    2487 </span><span class="lineCov">      20472 :         tpcrow-&gt;InsertCluster(c,index);</span>
<span class="lineNum">    2488 </span>            :       }
<span class="lineNum">    2489 </span>            :       //
<span class="lineNum">    2490 </span>            :       // write indexes for fast acces
<span class="lineNum">    2491 </span>            :       //
<span class="lineNum">    2492 </span><span class="lineCov">    9271584 :       for (Int_t i=0;i&lt;510;i++)</span>
<span class="lineNum">    2493 </span><span class="lineCov">    4626720 :         tpcrow-&gt;SetFastCluster(i,-1);</span>
<span class="lineNum">    2494 </span><span class="lineCov">     110344 :       for (Int_t i=0;i&lt;tpcrow-&gt;GetN();i++){</span>
<span class="lineNum">    2495 </span><span class="lineCov">      46100 :         Int_t zi = Int_t((*tpcrow)[i]-&gt;GetZ()+255.);</span>
<span class="lineNum">    2496 </span><span class="lineCov">      46100 :         tpcrow-&gt;SetFastCluster(zi,i);  // write index</span>
<span class="lineNum">    2497 </span>            :       }
<span class="lineNum">    2498 </span>            :       Int_t last = 0;
<span class="lineNum">    2499 </span><span class="lineCov">    9271584 :       for (Int_t i=0;i&lt;510;i++){</span>
<span class="lineNum">    2500 </span><span class="lineCov">    4626720 :         if (tpcrow-&gt;GetFastCluster(i)&lt;0)</span>
<span class="lineNum">    2501 </span><span class="lineCov">    4586956 :           tpcrow-&gt;SetFastCluster(i,last);</span>
<span class="lineNum">    2502 </span>            :         else
<span class="lineNum">    2503 </span><span class="lineCov">      39764 :           last = tpcrow-&gt;GetFastCluster(i);</span>
<span class="lineNum">    2504 </span>            :       }
<span class="lineNum">    2505 </span>            : 
<span class="lineNum">    2506 </span>            :     }  
<span class="lineNum">    2507 </span>            :    
<span class="lineNum">    2508 </span><span class="lineCov">          8 :   fN=fkNIS;</span>
<span class="lineNum">    2509 </span><span class="lineCov">          8 :   fSectors=fInnerSec;</span>
<span class="lineNum">    2510 </span><span class="lineCov">          8 :   return 0;</span>
<span class="lineNum">    2511 </span>            : }
<span class="lineNum">    2512 </span>            : 
<span class="lineNum">    2513 </span>            : 
<a name="2514"><span class="lineNum">    2514 </span>            : </a>
<span class="lineNum">    2515 </span>            : //_________________________________________________________________________
<span class="lineNum">    2516 </span>            : AliTPCclusterMI *AliTPCtracker::GetClusterMI(Int_t index) const {
<span class="lineNum">    2517 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2518 </span>            :   //       Return pointer to a given cluster
<span class="lineNum">    2519 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    2520 </span><span class="lineCov">     883542 :   if (index&lt;0) return 0; // no cluster</span>
<span class="lineNum">    2521 </span><span class="lineCov">     441771 :   Int_t sec=(index&amp;0xff000000)&gt;&gt;24; </span>
<span class="lineNum">    2522 </span><span class="lineCov">     441771 :   Int_t row=(index&amp;0x00ff0000)&gt;&gt;16; </span>
<span class="lineNum">    2523 </span><span class="lineCov">     441771 :   Int_t ncl=(index&amp;0x00007fff)&gt;&gt;00;</span>
<span class="lineNum">    2524 </span>            : 
<span class="lineNum">    2525 </span>            :   const AliTPCtrackerRow * tpcrow=0;
<span class="lineNum">    2526 </span>            :   TClonesArray * clrow =0;
<span class="lineNum">    2527 </span>            : 
<span class="lineNum">    2528 </span><span class="lineCov">     883542 :   if (sec&lt;0 || sec&gt;=fkNIS*4) {</span>
<span class="lineNum">    2529 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Wrong sector %d&quot;,sec));</span>
<span class="lineNum">    2530 </span><span class="lineNoCov">          0 :     return 0x0;</span>
<span class="lineNum">    2531 </span>            :   }
<span class="lineNum">    2532 </span>            : 
<span class="lineNum">    2533 </span><span class="lineCov">     441771 :   if (sec&lt;fkNIS*2){</span>
<span class="lineNum">    2534 </span><span class="lineCov">     172991 :     AliTPCtrackerSector&amp; tracksec = fInnerSec[sec%fkNIS];</span>
<span class="lineNum">    2535 </span><span class="lineCov">     172991 :     if (tracksec.GetNRows()&lt;=row) return 0;</span>
<span class="lineNum">    2536 </span><span class="lineCov">     172991 :     tpcrow = &amp;(tracksec[row]);</span>
<span class="lineNum">    2537 </span><span class="lineCov">     172991 :     if (tpcrow==0) return 0;</span>
<span class="lineNum">    2538 </span>            : 
<span class="lineNum">    2539 </span><span class="lineCov">     172991 :     if (sec&lt;fkNIS) {</span>
<span class="lineNum">    2540 </span><span class="lineCov">      84911 :       if (tpcrow-&gt;GetN1()&lt;=ncl) return 0;</span>
<span class="lineNum">    2541 </span><span class="lineCov">      84911 :       clrow = tpcrow-&gt;GetClusters1();</span>
<span class="lineNum">    2542 </span><span class="lineCov">      84911 :     }</span>
<span class="lineNum">    2543 </span>            :     else {
<span class="lineNum">    2544 </span><span class="lineCov">      88080 :       if (tpcrow-&gt;GetN2()&lt;=ncl) return 0;</span>
<span class="lineNum">    2545 </span><span class="lineCov">      88080 :       clrow = tpcrow-&gt;GetClusters2();</span>
<span class="lineNum">    2546 </span>            :     }
<span class="lineNum">    2547 </span><span class="lineCov">     172991 :   }</span>
<span class="lineNum">    2548 </span>            :   else {
<span class="lineNum">    2549 </span><span class="lineCov">     268780 :     AliTPCtrackerSector&amp; tracksec = fOuterSec[(sec-fkNIS*2)%fkNOS];</span>
<span class="lineNum">    2550 </span><span class="lineCov">     268780 :     if (tracksec.GetNRows()&lt;=row) return 0;</span>
<span class="lineNum">    2551 </span><span class="lineCov">     268780 :     tpcrow = &amp;(tracksec[row]);</span>
<span class="lineNum">    2552 </span><span class="lineCov">     268780 :     if (tpcrow==0) return 0;</span>
<span class="lineNum">    2553 </span>            : 
<span class="lineNum">    2554 </span><span class="lineCov">     268780 :     if (sec-2*fkNIS&lt;fkNOS) {</span>
<span class="lineNum">    2555 </span><span class="lineCov">     135699 :       if (tpcrow-&gt;GetN1()&lt;=ncl) return 0;</span>
<span class="lineNum">    2556 </span><span class="lineCov">     135699 :       clrow = tpcrow-&gt;GetClusters1();</span>
<span class="lineNum">    2557 </span><span class="lineCov">     135699 :     }</span>
<span class="lineNum">    2558 </span>            :     else {
<span class="lineNum">    2559 </span><span class="lineCov">     133081 :       if (tpcrow-&gt;GetN2()&lt;=ncl) return 0;</span>
<span class="lineNum">    2560 </span><span class="lineCov">     133081 :       clrow = tpcrow-&gt;GetClusters2();</span>
<span class="lineNum">    2561 </span>            :     }
<span class="lineNum">    2562 </span><span class="lineCov">     268780 :   }</span>
<span class="lineNum">    2563 </span>            : 
<span class="lineNum">    2564 </span><span class="lineCov">     441771 :   return (AliTPCclusterMI*)clrow-&gt;At(ncl);</span>
<span class="lineNum">    2565 </span>            :   
<span class="lineNum">    2566 </span><span class="lineCov">     441771 : }</span>
<span class="lineNum">    2567 </span>            : 
<a name="2568"><span class="lineNum">    2568 </span>            : </a>
<span class="lineNum">    2569 </span>            : 
<span class="lineNum">    2570 </span>            : Int_t AliTPCtracker::FollowToNext(AliTPCseed&amp; t, Int_t nr) {
<span class="lineNum">    2571 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2572 </span>            :   // This function tries to find a track prolongation to next pad row
<span class="lineNum">    2573 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2574 </span>            :   //
<span class="lineNum">    2575 </span>            :   const double kRoadY = 1., kRoadZ = 1.;
<span class="lineNum">    2576 </span><span class="lineCov">     179588 :   Double_t  x= GetXrow(nr), ymax=GetMaxY(nr);</span>
<span class="lineNum">    2577 </span>            :   //
<span class="lineNum">    2578 </span>            :   //
<span class="lineNum">    2579 </span>            :   AliTPCclusterMI *cl=0;
<span class="lineNum">    2580 </span><span class="lineCov">      89794 :   Int_t tpcindex= t.GetClusterIndex2(nr);</span>
<span class="lineNum">    2581 </span>            :   //
<span class="lineNum">    2582 </span>            :   // update current shape info every 5 pad-row
<span class="lineNum">    2583 </span>            :   //  if ( (nr%5==0) || t.GetNumberOfClusters()&lt;2 || (t.fCurrentSigmaY2&lt;0.0001) ){
<span class="lineNum">    2584 </span><span class="lineCov">      89794 :     GetShape(&amp;t,nr);    </span>
<span class="lineNum">    2585 </span>            :     //}
<span class="lineNum">    2586 </span>            :   //  
<span class="lineNum">    2587 </span><span class="lineCov">      89794 :   if (fIteration&gt;0 &amp;&amp; tpcindex&gt;=-1){  //if we have already clusters </span>
<span class="lineNum">    2588 </span>            :     //        
<span class="lineNum">    2589 </span><span class="lineCov">      37240 :     if (tpcindex==-1) return 0; //track in dead zone</span>
<span class="lineNum">    2590 </span><span class="lineCov">      33152 :     if (tpcindex &gt;= 0){     //</span>
<span class="lineNum">    2591 </span><span class="lineCov">      33152 :       cl = t.GetClusterPointer(nr);         // cluster might not be there during track finding, but is attached in refits</span>
<span class="lineNum">    2592 </span><span class="lineCov">      66304 :       if (cl==0) cl = GetClusterMI(tpcindex); </span>
<span class="lineNum">    2593 </span><span class="lineCov">      33152 :       t.SetCurrentClusterIndex1(tpcindex); </span>
<span class="lineNum">    2594 </span><span class="lineCov">      33152 :     }</span>
<span class="lineNum">    2595 </span><span class="lineCov">      33152 :     if (cl){      </span>
<span class="lineNum">    2596 </span><span class="lineCov">      33152 :       Int_t relativesector = ((tpcindex&amp;0xff000000)&gt;&gt;24)%18;  // if previously accepted cluster in different sector</span>
<span class="lineNum">    2597 </span><span class="lineCov">      33152 :       Float_t angle = relativesector*fSectors-&gt;GetAlpha()+fSectors-&gt;GetAlphaShift();</span>
<span class="lineNum">    2598 </span>            :       //
<span class="lineNum">    2599 </span><span class="lineCov">      33152 :       if (angle&lt;-TMath::Pi()) angle += 2*TMath::Pi();</span>
<span class="lineNum">    2600 </span><span class="lineCov">      44776 :       if (angle&gt;=TMath::Pi()) angle -= 2*TMath::Pi();</span>
<span class="lineNum">    2601 </span>            :       
<span class="lineNum">    2602 </span><span class="lineCov">      33152 :       if (TMath::Abs(angle-t.GetAlpha())&gt;0.001){</span>
<span class="lineNum">    2603 </span><span class="lineCov">        130 :         Double_t rotation = angle-t.GetAlpha();</span>
<span class="lineNum">    2604 </span><span class="lineCov">        130 :         t.SetRelativeSector(relativesector);</span>
<span class="lineNum">    2605 </span><span class="lineCov">        130 :         if (!t.Rotate(rotation)) {</span>
<span class="lineNum">    2606 </span><span class="lineNoCov">          0 :           t.SetClusterIndex(nr, t.GetClusterIndex(nr) | 0x8000);</span>
<span class="lineNum">    2607 </span><span class="lineNoCov">          0 :           return 0;</span>
<span class="lineNum">    2608 </span>            :         }       
<span class="lineNum">    2609 </span><span class="lineCov">        130 :       }</span>
<span class="lineNum">    2610 </span><span class="lineCov">      33152 :       if (!t.PropagateTo(cl-&gt;GetX())) { // RS: go directly to cluster X</span>
<span class="lineNum">    2611 </span><span class="lineNoCov">          0 :         t.SetClusterIndex(nr, t.GetClusterIndex(nr) | 0x8000);</span>
<span class="lineNum">    2612 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    2613 </span>            :       }
<span class="lineNum">    2614 </span>            :       //
<span class="lineNum">    2615 </span><span class="lineCov">      33152 :       t.SetCurrentCluster(cl); </span>
<span class="lineNum">    2616 </span><span class="lineCov">      33152 :       t.SetRow(nr); // RS: memorise row</span>
<span class="lineNum">    2617 </span><span class="lineCov">      33152 :       Int_t accept = AcceptCluster(&amp;t,t.GetCurrentCluster());</span>
<span class="lineNum">    2618 </span><span class="lineCov">      33152 :       if ((tpcindex&amp;0x8000)==0) accept =0;</span>
<span class="lineNum">    2619 </span><span class="lineCov">      33152 :       if (accept&lt;3) { </span>
<span class="lineNum">    2620 </span>            :         //if founded cluster is acceptible
<span class="lineNum">    2621 </span><span class="lineCov">      33098 :         if (cl-&gt;IsUsed(11)) {  // id cluster is shared inrease uncertainty</span>
<span class="lineNum">    2622 </span><span class="lineCov">        652 :           t.SetErrorY2(t.GetErrorY2()+0.03);</span>
<span class="lineNum">    2623 </span><span class="lineCov">        652 :           t.SetErrorZ2(t.GetErrorZ2()+0.03); </span>
<span class="lineNum">    2624 </span><span class="lineCov">        652 :           t.SetErrorY2(t.GetErrorY2()*3);</span>
<span class="lineNum">    2625 </span><span class="lineCov">        652 :           t.SetErrorZ2(t.GetErrorZ2()*3); </span>
<span class="lineNum">    2626 </span><span class="lineCov">        652 :         }</span>
<span class="lineNum">    2627 </span><span class="lineCov">      33098 :         t.SetNFoundable(t.GetNFoundable()+1);</span>
<span class="lineNum">    2628 </span><span class="lineCov">      33098 :         UpdateTrack(&amp;t,accept);</span>
<span class="lineNum">    2629 </span><span class="lineCov">      33098 :         return 1;</span>
<span class="lineNum">    2630 </span>            :       }
<span class="lineNum">    2631 </span>            :       else { // Remove old cluster from track
<span class="lineNum">    2632 </span><span class="lineCov">         54 :         t.SetClusterIndex(nr, -3);</span>
<span class="lineNum">    2633 </span>            :         //RS t.SetClusterPointer(nr, 0);
<span class="lineNum">    2634 </span>            :       }
<span class="lineNum">    2635 </span><span class="lineCov">         54 :     }</span>
<span class="lineNum">    2636 </span>            :   }
<span class="lineNum">    2637 </span><span class="lineCov">      57422 :   if (TMath::Abs(t.GetSnp())&gt;AliTPCReconstructor::GetMaxSnpTracker()) return 0;  // cut on angle</span>
<span class="lineNum">    2638 </span><span class="lineCov">      53892 :   if (fIteration&gt;1 &amp;&amp; IsFindable(t)){</span>
<span class="lineNum">    2639 </span>            :     // not look for new cluster during refitting    
<span class="lineNum">    2640 </span><span class="lineCov">       2010 :     t.SetNFoundable(t.GetNFoundable()+1);</span>
<span class="lineNum">    2641 </span><span class="lineCov">       2010 :     return 0;</span>
<span class="lineNum">    2642 </span>            :   }
<span class="lineNum">    2643 </span>            :   //
<span class="lineNum">    2644 </span><span class="lineCov">      49872 :   UInt_t index=0;</span>
<span class="lineNum">    2645 </span>            :   //  if (TMath::Abs(t.GetSnp())&gt;0.95 || TMath::Abs(x*t.GetC()-t.GetEta())&gt;0.95) return 0;// patch 28 fev 06
<span class="lineNum">    2646 </span>            :   //
<span class="lineNum">    2647 </span><span class="lineCov">      49872 :   if (fAccountDistortions &amp;&amp; !DistortX(&amp;t,x,nr)) {if (fIteration==0) t.SetRemoval(10); return 0;}</span>
<span class="lineNum">    2648 </span><span class="lineCov">      49908 :   if (!t.PropagateTo(x))                         {if (fIteration==0) t.SetRemoval(10); return 0;}</span>
<span class="lineNum">    2649 </span><span class="lineCov">      49860 :   t.SetRow(nr); //RS:? memorise reached row?</span>
<span class="lineNum">    2650 </span>            :   //
<span class="lineNum">    2651 </span><span class="lineCov">      49860 :   double y=t.GetY(), z=t.GetZ();</span>
<span class="lineNum">    2652 </span>            :   double yEdgeDist =  y;
<span class="lineNum">    2653 </span><span class="lineCov">      49860 :   if  (fAccountDistortions) yEdgeDist -= GetYSectEdgeDist(t.GetRelativeSector(),nr,y,z);</span>
<span class="lineNum">    2654 </span>            :   Bool_t rot = kFALSE;
<span class="lineNum">    2655 </span><span class="lineCov">      68230 :   if (y&gt;0 &amp;&amp; yEdgeDist&gt;ymax) { //RS y sign here is used to deduce which edge is used</span>
<span class="lineNum">    2656 </span><span class="lineCov">         82 :     t.SetRelativeSector((t.GetRelativeSector() + 1) % fN);</span>
<span class="lineNum">    2657 </span><span class="lineCov">         86 :     if (!t.Rotate(fSectors-&gt;GetAlpha())) return 0;</span>
<span class="lineNum">    2658 </span>            :     rot = kTRUE;
<span class="lineNum">    2659 </span><span class="lineCov">         78 :   }</span>
<span class="lineNum">    2660 </span><span class="lineCov">      81268 :   else if (y&lt;0 &amp;&amp; yEdgeDist&lt;-ymax) {</span>
<span class="lineNum">    2661 </span><span class="lineCov">        126 :     t.SetRelativeSector((t.GetRelativeSector() + fN - 1) % fN);</span>
<span class="lineNum">    2662 </span><span class="lineCov">        134 :     if (!t.Rotate(-fSectors-&gt;GetAlpha())) return 0;</span>
<span class="lineNum">    2663 </span>            :     rot = kTRUE;
<span class="lineNum">    2664 </span><span class="lineCov">        118 :   }</span>
<span class="lineNum">    2665 </span><span class="lineCov">      49848 :   if (rot) {</span>
<span class="lineNum">    2666 </span><span class="lineCov">        196 :     x = GetXrow(nr);</span>
<span class="lineNum">    2667 </span><span class="lineCov">        196 :     if (fAccountDistortions &amp;&amp; !DistortX(&amp;t,x,nr)) {if (fIteration==0) t.SetRemoval(10); return 0;}</span>
<span class="lineNum">    2668 </span><span class="lineCov">        202 :     if (!t.PropagateTo(x))                         {if (fIteration==0) t.SetRemoval(10); return 0; }</span>
<span class="lineNum">    2669 </span><span class="lineCov">        194 :     y = t.GetY();</span>
<span class="lineNum">    2670 </span>            :     yEdgeDist =  y;
<span class="lineNum">    2671 </span><span class="lineCov">        194 :     if (fAccountDistortions) yEdgeDist -= GetYSectEdgeDist(t.GetRelativeSector(),nr,y,z);</span>
<span class="lineNum">    2672 </span>            :   }
<span class="lineNum">    2673 </span>            :   //
<span class="lineNum">    2674 </span><span class="lineCov">      49846 :   if (!IsActive(t.GetRelativeSector(),nr)) { // RS:? How distortions affect this</span>
<span class="lineNum">    2675 </span><span class="lineCov">       1320 :     t.SetInDead(kTRUE);</span>
<span class="lineNum">    2676 </span><span class="lineCov">       1320 :     t.SetClusterIndex2(nr,-1); </span>
<span class="lineNum">    2677 </span><span class="lineCov">       1320 :     return 0;</span>
<span class="lineNum">    2678 </span>            :   }
<span class="lineNum">    2679 </span>            :   //AliInfo(Form(&quot;A - Sector%d phi %f - alpha %f&quot;, t.fRelativeSector,y/x, t.GetAlpha()));
<span class="lineNum">    2680 </span><span class="lineCov">      48526 :   Bool_t isActive  = IsActive(t.GetRelativeSector(),nr); //RS:? Why do we check this again?</span>
<span class="lineNum">    2681 </span><span class="lineCov">     194104 :   Bool_t isActive2 = (nr&gt;=fInnerSec-&gt;GetNRows()) ? </span>
<span class="lineNum">    2682 </span><span class="lineCov">     129288 :     fOuterSec[t.GetRelativeSector()][nr-fInnerSec-&gt;GetNRows()].GetN()&gt;0 : </span>
<span class="lineNum">    2683 </span><span class="lineCov">      16290 :     fInnerSec[t.GetRelativeSector()][nr].GetN()&gt;0;</span>
<span class="lineNum">    2684 </span>            :   
<span class="lineNum">    2685 </span><span class="lineCov">      97052 :   if (!isActive || !isActive2) return 0;</span>
<span class="lineNum">    2686 </span>            : 
<span class="lineNum">    2687 </span><span class="lineCov">      48526 :   const AliTPCtrackerRow &amp;krow=GetRow(t.GetRelativeSector(),nr);</span>
<span class="lineNum">    2688 </span><span class="lineCov">      97052 :   if ( (t.GetSigmaY2()&lt;0) || t.GetSigmaZ2()&lt;0) return 0;</span>
<span class="lineNum">    2689 </span>            :   //
<span class="lineNum">    2690 </span>            :   // RS: account for eventual modifications in dead zone definition due to distortions
<span class="lineNum">    2691 </span><span class="lineCov">      48526 :   double margin = (y&gt;0 ? ymax-yEdgeDist : ymax + yEdgeDist);</span>
<span class="lineNum">    2692 </span><span class="lineCov">      48526 :   if (margin&lt;krow.GetDeadZone()){</span>
<span class="lineNum">    2693 </span><span class="lineCov">       1062 :     t.SetInDead(kTRUE);</span>
<span class="lineNum">    2694 </span><span class="lineCov">       1062 :     t.SetClusterIndex2(nr,-1); </span>
<span class="lineNum">    2695 </span><span class="lineCov">       1062 :     return 0;</span>
<span class="lineNum">    2696 </span>            :   } 
<span class="lineNum">    2697 </span>            :   else {
<span class="lineNum">    2698 </span><span class="lineCov">      94850 :     if (IsFindable(t))  t.SetNFoundable(t.GetNFoundable()+1);</span>
<span class="lineNum">    2699 </span><span class="lineCov">         78 :     else                return 0;</span>
<span class="lineNum">    2700 </span>            :   }   
<span class="lineNum">    2701 </span>            :   //calculate 
<span class="lineNum">    2702 </span><span class="lineCov">     137358 :   if (krow &amp;&amp; (cl=krow.FindNearest2(y,z,kRoadY+fClExtraRoadY,kRoadZ+fClExtraRoadZ,index)) ) t.SetCurrentClusterIndex1(krow.GetIndex(index));</span>
<span class="lineNum">    2703 </span><span class="lineCov">      47386 :   if (cl) {</span>
<span class="lineNum">    2704 </span><span class="lineCov">      42586 :     t.SetCurrentCluster(cl); </span>
<span class="lineNum">    2705 </span>            :     //    t.SetRow(nr); //RS: memorise row | already set at propagation
<span class="lineNum">    2706 </span><span class="lineCov">      42586 :     if (fIteration==2&amp;&amp;cl-&gt;IsUsed(10)) return 0; </span>
<span class="lineNum">    2707 </span><span class="lineCov">      42586 :     Int_t accept = AcceptCluster(&amp;t,t.GetCurrentCluster());</span>
<span class="lineNum">    2708 </span><span class="lineCov">      42586 :     if (fIteration==2&amp;&amp;cl-&gt;IsUsed(11)) {</span>
<span class="lineNum">    2709 </span><span class="lineNoCov">          0 :       t.SetErrorY2(t.GetErrorY2()+0.03);</span>
<span class="lineNum">    2710 </span><span class="lineNoCov">          0 :       t.SetErrorZ2(t.GetErrorZ2()+0.03); </span>
<span class="lineNum">    2711 </span><span class="lineNoCov">          0 :       t.SetErrorY2(t.GetErrorY2()*3);</span>
<span class="lineNum">    2712 </span><span class="lineNoCov">          0 :       t.SetErrorZ2(t.GetErrorZ2()*3); </span>
<span class="lineNum">    2713 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2714 </span>            :     /*    
<span class="lineNum">    2715 </span>            :     if (t.fCurrentCluster-&gt;IsUsed(10)){
<span class="lineNum">    2716 </span>            :       //
<span class="lineNum">    2717 </span>            :       //     
<span class="lineNum">    2718 </span>            : 
<span class="lineNum">    2719 </span>            :       t.fNShared++;
<span class="lineNum">    2720 </span>            :       if (t.fNShared&gt;0.7*t.GetNumberOfClusters()) {
<span class="lineNum">    2721 </span>            :         t.fRemoval =10;
<span class="lineNum">    2722 </span>            :         return 0;
<span class="lineNum">    2723 </span>            :       }
<span class="lineNum">    2724 </span>            :     }
<span class="lineNum">    2725 </span>            :     */
<span class="lineNum">    2726 </span><span class="lineCov">      84422 :     if (accept&lt;3) UpdateTrack(&amp;t,accept);</span>
<span class="lineNum">    2727 </span>            : 
<span class="lineNum">    2728 </span><span class="lineCov">      42586 :   } else {  </span>
<span class="lineNum">    2729 </span><span class="lineCov">       8820 :     if ( fIteration==0 &amp;&amp; t.GetNFoundable()*0.5 &gt; t.GetNumberOfClusters()) t.SetRemoval(10);</span>
<span class="lineNum">    2730 </span>            :     
<span class="lineNum">    2731 </span>            :   }
<span class="lineNum">    2732 </span><span class="lineCov">      47386 :   return 1;</span>
<span class="lineNum">    2733 </span><span class="lineCov">     139666 : }</span>
<span class="lineNum">    2734 </span>            : 
<span class="lineNum">    2735 </span>            : 
<a name="2736"><span class="lineNum">    2736 </span>            : </a>
<span class="lineNum">    2737 </span>            : //_________________________________________________________________________
<span class="lineNum">    2738 </span>            : Bool_t AliTPCtracker::GetTrackPoint(Int_t index, AliTrackPoint &amp;p ) const
<span class="lineNum">    2739 </span>            : {
<span class="lineNum">    2740 </span>            :   // Get track space point by index
<span class="lineNum">    2741 </span>            :   // return false in case the cluster doesn't exist
<span class="lineNum">    2742 </span><span class="lineCov">      16802 :   AliTPCclusterMI *cl = GetClusterMI(index);</span>
<span class="lineNum">    2743 </span><span class="lineCov">       8401 :   if (!cl) return kFALSE;</span>
<span class="lineNum">    2744 </span><span class="lineCov">       8401 :   Int_t sector = (index&amp;0xff000000)&gt;&gt;24;</span>
<span class="lineNum">    2745 </span>            :   //  Int_t row = (index&amp;0x00ff0000)&gt;&gt;16;
<span class="lineNum">    2746 </span>            :   Float_t xyz[3];
<span class="lineNum">    2747 </span>            :   //  xyz[0] = fkParam-&gt;GetPadRowRadii(sector,row);
<span class="lineNum">    2748 </span><span class="lineCov">       8401 :   xyz[0] = cl-&gt;GetX();</span>
<span class="lineNum">    2749 </span><span class="lineCov">       8401 :   xyz[1] = cl-&gt;GetY();</span>
<span class="lineNum">    2750 </span><span class="lineCov">       8401 :   xyz[2] = cl-&gt;GetZ();</span>
<span class="lineNum">    2751 </span><span class="lineCov">       8401 :   Float_t sin,cos;</span>
<span class="lineNum">    2752 </span><span class="lineCov">       8401 :   fkParam-&gt;AdjustCosSin(sector,cos,sin);</span>
<span class="lineNum">    2753 </span><span class="lineCov">       8401 :   Float_t x = cos*xyz[0]-sin*xyz[1];</span>
<span class="lineNum">    2754 </span><span class="lineCov">       8401 :   Float_t y = cos*xyz[1]+sin*xyz[0];</span>
<span class="lineNum">    2755 </span><span class="lineCov">       8401 :   Float_t cov[6];</span>
<span class="lineNum">    2756 </span><span class="lineCov">       8401 :   Float_t sigmaY2 = 0.027*cl-&gt;GetSigmaY2();</span>
<span class="lineNum">    2757 </span><span class="lineCov">      11738 :   if (sector &lt; fkParam-&gt;GetNInnerSector()) sigmaY2 *= 2.07;</span>
<span class="lineNum">    2758 </span><span class="lineCov">       8401 :   Float_t sigmaZ2 = 0.066*cl-&gt;GetSigmaZ2();</span>
<span class="lineNum">    2759 </span><span class="lineCov">      11738 :   if (sector &lt; fkParam-&gt;GetNInnerSector()) sigmaZ2 *= 1.77;</span>
<span class="lineNum">    2760 </span><span class="lineCov">       8401 :   cov[0] = sin*sin*sigmaY2;</span>
<span class="lineNum">    2761 </span><span class="lineCov">       8401 :   cov[1] = -sin*cos*sigmaY2;</span>
<span class="lineNum">    2762 </span><span class="lineCov">       8401 :   cov[2] = 0.;</span>
<span class="lineNum">    2763 </span><span class="lineCov">       8401 :   cov[3] = cos*cos*sigmaY2;</span>
<span class="lineNum">    2764 </span><span class="lineCov">       8401 :   cov[4] = 0.;</span>
<span class="lineNum">    2765 </span><span class="lineCov">       8401 :   cov[5] = sigmaZ2;</span>
<span class="lineNum">    2766 </span><span class="lineCov">       8401 :   p.SetXYZ(x,y,xyz[2],cov);</span>
<span class="lineNum">    2767 </span>            :   AliGeomManager::ELayerID iLayer;
<span class="lineNum">    2768 </span>            :   Int_t idet;
<span class="lineNum">    2769 </span><span class="lineCov">       8401 :   if (sector &lt; fkParam-&gt;GetNInnerSector()) {</span>
<span class="lineNum">    2770 </span>            :     iLayer = AliGeomManager::kTPC1;
<span class="lineNum">    2771 </span>            :     idet = sector;
<span class="lineNum">    2772 </span><span class="lineCov">       3337 :   }</span>
<span class="lineNum">    2773 </span>            :   else {
<span class="lineNum">    2774 </span>            :     iLayer = AliGeomManager::kTPC2;
<span class="lineNum">    2775 </span><span class="lineCov">       5064 :     idet = sector - fkParam-&gt;GetNInnerSector();</span>
<span class="lineNum">    2776 </span>            :   }
<span class="lineNum">    2777 </span><span class="lineCov">       8401 :   UShort_t volid = AliGeomManager::LayerToVolUID(iLayer,idet);</span>
<span class="lineNum">    2778 </span><span class="lineCov">       8401 :   p.SetVolumeID(volid);</span>
<span class="lineNum">    2779 </span>            :   return kTRUE;
<span class="lineNum">    2780 </span><span class="lineCov">      16802 : }</span>
<span class="lineNum">    2781 </span>            : 
<a name="2782"><span class="lineNum">    2782 </span>            : </a>
<span class="lineNum">    2783 </span>            : 
<span class="lineNum">    2784 </span>            : Int_t AliTPCtracker::UpdateClusters(AliTPCseed&amp; t,  Int_t nr) {
<span class="lineNum">    2785 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2786 </span>            :   // This function tries to find a track prolongation to next pad row
<span class="lineNum">    2787 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2788 </span><span class="lineCov">      87280 :   t.SetCurrentCluster(0);</span>
<span class="lineNum">    2789 </span><span class="lineCov">      43640 :   t.SetCurrentClusterIndex1(-3);   </span>
<span class="lineNum">    2790 </span>            :    
<span class="lineNum">    2791 </span><span class="lineCov">     130920 :   Int_t     row = (fAccountDistortions ? GetRowNumber(&amp;t):GetRowNumber(t.GetX()))-1;  //RS: with distortions cannot rely on X</span>
<span class="lineNum">    2792 </span><span class="lineCov">      43640 :   Double_t  ymax= GetMaxY(nr);</span>
<span class="lineNum">    2793 </span>            : 
<span class="lineNum">    2794 </span><span class="lineCov">      53738 :   if (row &lt; nr) return 1; // don't prolongate if not information until now -</span>
<span class="lineNum">    2795 </span>            : 
<span class="lineNum">    2796 </span>            :   const double kRoadY = 1., kRoadZ = 1.;
<span class="lineNum">    2797 </span>            : 
<span class="lineNum">    2798 </span><span class="lineCov">      33542 :   Double_t x= GetXrow(nr);</span>
<span class="lineNum">    2799 </span><span class="lineCov">      33542 :   if (fAccountDistortions &amp;&amp; !DistortX(&amp;t,x,nr)) return 0; // RS: if needed, account distortion</span>
<span class="lineNum">    2800 </span>            :   //
<span class="lineNum">    2801 </span><span class="lineCov">      34110 :   if (!t.PropagateTo(x)) return 0;</span>
<span class="lineNum">    2802 </span><span class="lineCov">      32974 :   t.SetRow(nr); //RS: memorise row</span>
<span class="lineNum">    2803 </span>            :   //
<span class="lineNum">    2804 </span><span class="lineCov">      32974 :   double y=t.GetY(), z=t.GetZ();</span>
<span class="lineNum">    2805 </span>            :   double yEdgeDist =  y;
<span class="lineNum">    2806 </span><span class="lineCov">      32974 :   if  (fAccountDistortions) yEdgeDist -= GetYSectEdgeDist(t.GetRelativeSector(),nr,y,z);</span>
<span class="lineNum">    2807 </span><span class="lineCov">      46872 :   if (y&gt;0 &amp;&amp; yEdgeDist&gt;ymax) { //RS y sign is used to determine which edge is used</span>
<span class="lineNum">    2808 </span><span class="lineCov">         38 :     t.SetRelativeSector((t.GetRelativeSector()+1) % fN);</span>
<span class="lineNum">    2809 </span><span class="lineCov">         40 :     if (!t.Rotate(fSectors-&gt;GetAlpha())) return 0;</span>
<span class="lineNum">    2810 </span><span class="lineCov">         36 :     t.SetRow(-1); //RS: after rotation the row is not known</span>
<span class="lineNum">    2811 </span><span class="lineCov">         36 :     return 1;</span>
<span class="lineNum">    2812 </span>            :   }
<span class="lineNum">    2813 </span><span class="lineCov">      52012 :   else if (y&lt;0 &amp;&amp; yEdgeDist&lt;-ymax) {</span>
<span class="lineNum">    2814 </span><span class="lineCov">         96 :     t.SetRelativeSector((t.GetRelativeSector()+fN-1) % fN);</span>
<span class="lineNum">    2815 </span><span class="lineCov">        142 :     if (!t.Rotate(-fSectors-&gt;GetAlpha())) return 0;</span>
<span class="lineNum">    2816 </span><span class="lineCov">         50 :     t.SetRow(-1); //RS: after rotation the row is not known</span>
<span class="lineNum">    2817 </span><span class="lineCov">         50 :     return 1;</span>
<span class="lineNum">    2818 </span>            :   }
<span class="lineNum">    2819 </span>            :   //
<span class="lineNum">    2820 </span><span class="lineCov">      32860 :   if (TMath::Abs(t.GetSnp())&gt;AliTPCReconstructor::GetMaxSnpTracker()) return 0;</span>
<span class="lineNum">    2821 </span>            : 
<span class="lineNum">    2822 </span><span class="lineCov">      32820 :   if (!IsActive(t.GetRelativeSector(),nr)) {</span>
<span class="lineNum">    2823 </span><span class="lineCov">        714 :     t.SetInDead(kTRUE);</span>
<span class="lineNum">    2824 </span><span class="lineCov">        714 :     t.SetClusterIndex2(nr,-1); </span>
<span class="lineNum">    2825 </span><span class="lineCov">        714 :     return 0;</span>
<span class="lineNum">    2826 </span>            :   }
<span class="lineNum">    2827 </span>            :   //AliInfo(Form(&quot;A - Sector%d phi %f - alpha %f&quot;, t.fRelativeSector,y/x, t.GetAlpha()));
<span class="lineNum">    2828 </span>            : 
<span class="lineNum">    2829 </span><span class="lineCov">      32106 :   AliTPCtrackerRow &amp;krow=GetRow(t.GetRelativeSector(),nr);</span>
<span class="lineNum">    2830 </span><span class="lineCov">      32106 :   double margin = (y&gt;0 ? ymax-yEdgeDist : ymax + yEdgeDist);</span>
<span class="lineNum">    2831 </span><span class="lineCov">      32106 :   if (margin&lt;krow.GetDeadZone()) {</span>
<span class="lineNum">    2832 </span><span class="lineCov">        858 :     t.SetInDead(kTRUE);</span>
<span class="lineNum">    2833 </span><span class="lineCov">        858 :     t.SetClusterIndex2(nr,-1); </span>
<span class="lineNum">    2834 </span><span class="lineCov">        858 :     return 0;</span>
<span class="lineNum">    2835 </span>            :   } 
<span class="lineNum">    2836 </span>            :   else {
<span class="lineNum">    2837 </span>            :     //      if (TMath::Abs(t.GetZ())&lt;(AliTPCReconstructor::GetCtgRange()*t.GetX()+10) &amp;&amp; (TMath::Abs(t.GetSnp())&lt;AliTPCReconstructor::GetMaxSnpTracker())) 
<span class="lineNum">    2838 </span><span class="lineCov">      62492 :     if (IsFindable(t)) t.SetNFoundable(t.GetNFoundable()+1);</span>
<span class="lineNum">    2839 </span><span class="lineCov">          4 :     else return 0;      </span>
<span class="lineNum">    2840 </span>            :   }
<span class="lineNum">    2841 </span>            : 
<span class="lineNum">    2842 </span>            :   // update current
<span class="lineNum">    2843 </span><span class="lineCov">      46800 :   if ( (nr%2==0) || t.GetNumberOfClusters()&lt;2){</span>
<span class="lineNum">    2844 </span>            :     //    t.fCurrentSigmaY = GetSigmaY(&amp;t);
<span class="lineNum">    2845 </span>            :     //t.fCurrentSigmaZ = GetSigmaZ(&amp;t);
<span class="lineNum">    2846 </span><span class="lineCov">      15688 :     GetShape(&amp;t,nr);</span>
<span class="lineNum">    2847 </span><span class="lineCov">      15688 :   }</span>
<span class="lineNum">    2848 </span>            :     
<span class="lineNum">    2849 </span>            :   AliTPCclusterMI *cl=0;
<span class="lineNum">    2850 </span>            :   Int_t index=0;
<span class="lineNum">    2851 </span>            :   //
<span class="lineNum">    2852 </span>            :   Double_t roady = 1.;
<span class="lineNum">    2853 </span>            :   Double_t roadz = 1.;
<span class="lineNum">    2854 </span>            :   //
<span class="lineNum">    2855 </span>            : 
<span class="lineNum">    2856 </span><span class="lineCov">      31244 :   if (!cl){</span>
<span class="lineNum">    2857 </span><span class="lineCov">      31244 :     index = t.GetClusterIndex2(nr);    </span>
<span class="lineNum">    2858 </span><span class="lineCov">      31244 :     if ( (index &gt;= 0) &amp;&amp; (index&amp;0x8000)==0){</span>
<span class="lineNum">    2859 </span>            :       //RS cl = t.GetClusterPointer(nr);
<span class="lineNum">    2860 </span>            :       //RS if ( (cl==0) &amp;&amp; (index &gt;= 0)) cl = GetClusterMI(index);
<span class="lineNum">    2861 </span><span class="lineNoCov">          0 :       if ( index &gt;= 0 ) cl = GetClusterMI(index);</span>
<span class="lineNum">    2862 </span><span class="lineNoCov">          0 :       t.SetCurrentClusterIndex1(index);</span>
<span class="lineNum">    2863 </span><span class="lineNoCov">          0 :       if (cl) {</span>
<span class="lineNum">    2864 </span><span class="lineNoCov">          0 :         t.SetCurrentCluster(cl);</span>
<span class="lineNum">    2865 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">    2866 </span>            :       }
<span class="lineNum">    2867 </span>            :     }
<span class="lineNum">    2868 </span>            :   }
<span class="lineNum">    2869 </span>            : 
<span class="lineNum">    2870 </span>            :   //  if (index&lt;0) return 0;
<span class="lineNum">    2871 </span><span class="lineCov">      31244 :   UInt_t uindex = TMath::Abs(index);</span>
<span class="lineNum">    2872 </span>            : 
<span class="lineNum">    2873 </span><span class="lineCov">      31244 :   if (krow) {</span>
<span class="lineNum">    2874 </span>            :     //cl = krow.FindNearest2(y+10,z,roady,roadz,uindex);      
<span class="lineNum">    2875 </span><span class="lineCov">      31244 :     cl = krow.FindNearest2(y,z,kRoadY+fClExtraRoadY,kRoadZ+fClExtraRoadZ,uindex);      </span>
<span class="lineNum">    2876 </span><span class="lineCov">      31244 :   }</span>
<span class="lineNum">    2877 </span>            : 
<span class="lineNum">    2878 </span><span class="lineCov">      60144 :   if (cl) t.SetCurrentClusterIndex1(krow.GetIndex(uindex));   </span>
<span class="lineNum">    2879 </span><span class="lineCov">      31244 :   t.SetCurrentCluster(cl);</span>
<span class="lineNum">    2880 </span>            : 
<span class="lineNum">    2881 </span>            :   return 1;
<span class="lineNum">    2882 </span><span class="lineCov">     108426 : }</span>
<a name="2883"><span class="lineNum">    2883 </span>            : </a>
<span class="lineNum">    2884 </span>            : 
<span class="lineNum">    2885 </span>            : Int_t AliTPCtracker::FollowToNextCluster(AliTPCseed &amp; t, Int_t nr) {
<span class="lineNum">    2886 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2887 </span>            :   // This function tries to find a track prolongation to next pad row
<span class="lineNum">    2888 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2889 </span>            : 
<span class="lineNum">    2890 </span>            :   //update error according neighborhoud
<span class="lineNum">    2891 </span>            : 
<span class="lineNum">    2892 </span><span class="lineCov">      87280 :   if (t.GetCurrentCluster()) {</span>
<span class="lineNum">    2893 </span><span class="lineCov">      28900 :     t.SetRow(nr); </span>
<span class="lineNum">    2894 </span><span class="lineCov">      28900 :     Int_t accept = AcceptCluster(&amp;t,t.GetCurrentCluster());</span>
<span class="lineNum">    2895 </span>            :     
<span class="lineNum">    2896 </span><span class="lineCov">      28900 :     if (t.GetCurrentCluster()-&gt;IsUsed(10)){</span>
<span class="lineNum">    2897 </span>            :       //
<span class="lineNum">    2898 </span>            :       //
<span class="lineNum">    2899 </span>            :       //  t.fErrorZ2*=2;
<span class="lineNum">    2900 </span>            :       //  t.fErrorY2*=2;
<span class="lineNum">    2901 </span><span class="lineCov">        116 :       t.SetNShared(t.GetNShared()+1);</span>
<span class="lineNum">    2902 </span><span class="lineCov">        116 :       if (t.GetNShared()&gt;0.7*t.GetNumberOfClusters()) {</span>
<span class="lineNum">    2903 </span><span class="lineCov">          6 :         t.SetRemoval(10);</span>
<span class="lineNum">    2904 </span><span class="lineCov">          6 :         return 0;</span>
<span class="lineNum">    2905 </span>            :       }
<span class="lineNum">    2906 </span>            :     }   
<span class="lineNum">    2907 </span><span class="lineCov">      28894 :     if (fIteration&gt;0) accept = 0;</span>
<span class="lineNum">    2908 </span><span class="lineCov">      57320 :     if (accept&lt;3)  UpdateTrack(&amp;t,accept);  </span>
<span class="lineNum">    2909 </span>            :  
<span class="lineNum">    2910 </span><span class="lineCov">      28894 :   } else {</span>
<span class="lineNum">    2911 </span><span class="lineCov">      14740 :     if (fIteration==0){</span>
<span class="lineNum">    2912 </span>            :       //RS: with distortions related cluster errors the track error may grow, don't use this cut
<span class="lineNum">    2913 </span>            :       //if ( t.GetNumberOfClusters()&gt;18 &amp;&amp; ( (t.GetSigmaY2()+t.GetSigmaZ2())&gt;0.16 + fExtraClErrYZ2 )) t.SetRemoval(10); 
<span class="lineNum">    2914 </span><span class="lineCov">      22132 :       if ( t.GetNumberOfClusters()&gt;18 &amp;&amp; t.GetChi2()/t.GetNumberOfClusters()&gt;6 ) t.SetRemoval(10);      </span>
<span class="lineNum">    2915 </span>            : 
<span class="lineNum">    2916 </span><span class="lineCov">      29480 :       if (( (t.GetNFoundable()*0.5 &gt; t.GetNumberOfClusters()) || t.GetNoCluster()&gt;15)) t.SetRemoval(10);</span>
<span class="lineNum">    2917 </span>            :     }
<span class="lineNum">    2918 </span>            :   }
<span class="lineNum">    2919 </span><span class="lineCov">      43634 :   return 1;</span>
<span class="lineNum">    2920 </span><span class="lineCov">      43640 : }</span>
<span class="lineNum">    2921 </span>            : 
<span class="lineNum">    2922 </span>            : 
<a name="2923"><span class="lineNum">    2923 </span>            : </a>
<span class="lineNum">    2924 </span>            : //_____________________________________________________________________________
<span class="lineNum">    2925 </span>            : Int_t AliTPCtracker::FollowProlongation(AliTPCseed&amp; t, Int_t rf, Int_t step, Bool_t fromSeeds) {
<span class="lineNum">    2926 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2927 </span>            :   // This function tries to find a track prolongation.
<span class="lineNum">    2928 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2929 </span>            :   // Double_t xt=t.GetX(); // RS: with distortions we cannot rely on rowID from X
<span class="lineNum">    2930 </span>            :   //
<span class="lineNum">    2931 </span><span class="lineCov">       3654 :   Double_t alpha=t.GetAlpha();</span>
<span class="lineNum">    2932 </span><span class="lineCov">       3654 :   if (alpha &gt; 2.*TMath::Pi()) alpha -= 2.*TMath::Pi();  </span>
<span class="lineNum">    2933 </span><span class="lineCov">       4766 :   if (alpha &lt; 0.            ) alpha += 2.*TMath::Pi();  </span>
<span class="lineNum">    2934 </span>            :   //
<span class="lineNum">    2935 </span><span class="lineCov">       3654 :   t.SetRelativeSector(Int_t(alpha/fSectors-&gt;GetAlpha()+0.0001)%fN);</span>
<span class="lineNum">    2936 </span>            :     
<span class="lineNum">    2937 </span><span class="lineCov">      10962 :   Int_t first = fAccountDistortions ? GetRowNumber(&amp;t):GetRowNumber(t.GetX());  //RS: with distortions cannot rely on X</span>
<span class="lineNum">    2938 </span>            :   //Int_t first = GetRowNumber(xt);
<span class="lineNum">    2939 </span><span class="lineCov">       3654 :   if (!fromSeeds)</span>
<span class="lineNum">    2940 </span><span class="lineCov">       3518 :     first -= step;</span>
<span class="lineNum">    2941 </span><span class="lineCov">       3654 :   if (first &lt; 0)</span>
<span class="lineNum">    2942 </span><span class="lineNoCov">          0 :     first = 0;</span>
<span class="lineNum">    2943 </span><span class="lineCov">     113624 :   for (Int_t nr= first; nr&gt;=rf; nr-=step) {</span>
<span class="lineNum">    2944 </span>            :     // update kink info
<span class="lineNum">    2945 </span><span class="lineCov">      51478 :     if (t.GetKinkIndexes()[0]&gt;0){</span>
<span class="lineNum">    2946 </span><span class="lineCov">       2544 :       for (Int_t i=0;i&lt;3;i++){</span>
<span class="lineNum">    2947 </span><span class="lineCov">       1272 :         Int_t index = t.GetKinkIndexes()[i];</span>
<span class="lineNum">    2948 </span><span class="lineCov">       1908 :         if (index==0) break;</span>
<span class="lineNum">    2949 </span><span class="lineCov">        636 :         if (index&lt;0) continue;</span>
<span class="lineNum">    2950 </span>            :         //
<span class="lineNum">    2951 </span><span class="lineCov">        636 :         AliKink * kink = (AliKink*)fEvent-&gt;GetKink(index-1);</span>
<span class="lineNum">    2952 </span><span class="lineCov">        636 :         if (!kink){</span>
<span class="lineNum">    2953 </span><span class="lineNoCov">          0 :           printf(&quot;PROBLEM\n&quot;);</span>
<span class="lineNum">    2954 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    2955 </span>            :         else{
<span class="lineNum">    2956 </span><span class="lineCov">        636 :           Int_t kinkrow = kink-&gt;GetTPCRow0()+2+Int_t(0.5/(0.05+kink-&gt;GetAngle(2)));</span>
<span class="lineNum">    2957 </span><span class="lineCov">        636 :           if (kinkrow==nr){</span>
<span class="lineNum">    2958 </span><span class="lineCov">          4 :             AliExternalTrackParam paramd(t);</span>
<span class="lineNum">    2959 </span><span class="lineCov">          4 :             kink-&gt;SetDaughter(paramd);</span>
<span class="lineNum">    2960 </span><span class="lineCov">          4 :             kink-&gt;SetStatus(2,5);</span>
<span class="lineNum">    2961 </span><span class="lineCov">          4 :             kink-&gt;Update();</span>
<span class="lineNum">    2962 </span><span class="lineCov">          4 :           }</span>
<span class="lineNum">    2963 </span>            :         }
<span class="lineNum">    2964 </span><span class="lineCov">        636 :       }</span>
<span class="lineNum">    2965 </span><span class="lineCov">        636 :     }</span>
<span class="lineNum">    2966 </span>            : 
<span class="lineNum">    2967 </span><span class="lineCov">      51750 :     if (nr==80) t.UpdateReference();</span>
<span class="lineNum">    2968 </span><span class="lineCov">      51478 :     if (nr&lt;fInnerSec-&gt;GetNRows()) </span>
<span class="lineNum">    2969 </span><span class="lineCov">      18682 :       fSectors = fInnerSec;</span>
<span class="lineNum">    2970 </span>            :     else
<span class="lineNum">    2971 </span><span class="lineCov">      32796 :       fSectors = fOuterSec;</span>
<span class="lineNum">    2972 </span><span class="lineCov">      51478 :     if (FollowToNext(t,nr)==0) </span>
<span class="lineNum">    2973 </span><span class="lineCov">       6264 :       if (!t.IsActive()) </span>
<span class="lineNum">    2974 </span><span class="lineCov">         98 :         return 0;</span>
<span class="lineNum">    2975 </span>            :     
<span class="lineNum">    2976 </span>            :   }   
<span class="lineNum">    2977 </span><span class="lineCov">       3556 :   return 1;</span>
<span class="lineNum">    2978 </span><span class="lineCov">       3654 : }</span>
<span class="lineNum">    2979 </span>            : 
<span class="lineNum">    2980 </span>            : 
<span class="lineNum">    2981 </span>            : 
<span class="lineNum">    2982 </span>            : 
<a name="2983"><span class="lineNum">    2983 </span>            : </a>
<span class="lineNum">    2984 </span>            : 
<span class="lineNum">    2985 </span>            : Int_t AliTPCtracker::FollowBackProlongation(AliTPCseed&amp; t, Int_t rf, Bool_t fromSeeds) {
<span class="lineNum">    2986 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2987 </span>            :   // This function tries to find a track prolongation.
<span class="lineNum">    2988 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    2989 </span>            :   //
<span class="lineNum">    2990 </span>            :   //  Double_t xt=t.GetX();   //RS: with distortions cannot rely on row from X
<span class="lineNum">    2991 </span><span class="lineCov">       2268 :   Double_t alpha=t.GetAlpha();</span>
<span class="lineNum">    2992 </span><span class="lineCov">       2268 :   if (alpha &gt; 2.*TMath::Pi()) alpha -= 2.*TMath::Pi();  </span>
<span class="lineNum">    2993 </span><span class="lineCov">       2890 :   if (alpha &lt; 0.            ) alpha += 2.*TMath::Pi();  </span>
<span class="lineNum">    2994 </span><span class="lineCov">       2268 :   t.SetRelativeSector(Int_t(alpha/fSectors-&gt;GetAlpha()+0.0001)%fN);</span>
<span class="lineNum">    2995 </span>            :     
<span class="lineNum">    2996 </span><span class="lineCov">       2268 :   Int_t first = t.GetFirstPoint();</span>
<span class="lineNum">    2997 </span><span class="lineCov">       6804 :   Int_t ri = fAccountDistortions ? GetRowNumber(&amp;t) :  GetRowNumber(t.GetX());  //RS: with distortions cannot rely on X</span>
<span class="lineNum">    2998 </span>            :   //  Int_t ri = GetRowNumber(xt); 
<span class="lineNum">    2999 </span><span class="lineCov">       2268 :   if (!fromSeeds)</span>
<span class="lineNum">    3000 </span><span class="lineCov">       2132 :     ri += 1;</span>
<span class="lineNum">    3001 </span>            : 
<span class="lineNum">    3002 </span><span class="lineCov">       4390 :   if (first&lt;ri) first = ri;</span>
<span class="lineNum">    3003 </span>            :   //
<span class="lineNum">    3004 </span><span class="lineCov">       2268 :   if (first&lt;0) first=0;</span>
<span class="lineNum">    3005 </span><span class="lineCov">      81168 :   for (Int_t nr=first; nr&lt;=rf; nr++) {</span>
<span class="lineNum">    3006 </span>            :     //    if ( (TMath::Abs(t.GetSnp())&gt;0.95)) break;//patch 28 fev 06
<span class="lineNum">    3007 </span><span class="lineCov">      38316 :     if (t.GetKinkIndexes()[0]&lt;0){</span>
<span class="lineNum">    3008 </span><span class="lineCov">       2544 :       for (Int_t i=0;i&lt;3;i++){</span>
<span class="lineNum">    3009 </span><span class="lineCov">       1272 :         Int_t index = t.GetKinkIndexes()[i];</span>
<span class="lineNum">    3010 </span><span class="lineCov">       1908 :         if (index==0) break;</span>
<span class="lineNum">    3011 </span><span class="lineCov">        636 :         if (index&gt;0) continue;</span>
<span class="lineNum">    3012 </span><span class="lineCov">        636 :         index = TMath::Abs(index);</span>
<span class="lineNum">    3013 </span><span class="lineCov">        636 :         AliKink * kink = (AliKink*)fEvent-&gt;GetKink(index-1);</span>
<span class="lineNum">    3014 </span><span class="lineCov">        636 :         if (!kink){</span>
<span class="lineNum">    3015 </span><span class="lineNoCov">          0 :           printf(&quot;PROBLEM\n&quot;);</span>
<span class="lineNum">    3016 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3017 </span>            :         else{
<span class="lineNum">    3018 </span><span class="lineCov">        636 :           Int_t kinkrow = kink-&gt;GetTPCRow0()-2-Int_t(0.5/(0.05+kink-&gt;GetAngle(2)));</span>
<span class="lineNum">    3019 </span><span class="lineCov">        636 :           if (kinkrow==nr){</span>
<span class="lineNum">    3020 </span><span class="lineCov">          8 :             AliExternalTrackParam paramm(t);</span>
<span class="lineNum">    3021 </span><span class="lineCov">          8 :             kink-&gt;SetMother(paramm);</span>
<span class="lineNum">    3022 </span><span class="lineCov">          8 :             kink-&gt;SetStatus(2,1);</span>
<span class="lineNum">    3023 </span><span class="lineCov">          8 :             kink-&gt;Update();</span>
<span class="lineNum">    3024 </span><span class="lineCov">          8 :           }</span>
<span class="lineNum">    3025 </span>            :         }
<span class="lineNum">    3026 </span><span class="lineCov">        636 :       }      </span>
<span class="lineNum">    3027 </span><span class="lineCov">        636 :     }</span>
<span class="lineNum">    3028 </span>            :     //
<span class="lineNum">    3029 </span><span class="lineCov">      38316 :     if (nr&lt;fInnerSec-&gt;GetNRows()) </span>
<span class="lineNum">    3030 </span><span class="lineCov">      14676 :       fSectors = fInnerSec;</span>
<span class="lineNum">    3031 </span>            :     else
<span class="lineNum">    3032 </span><span class="lineCov">      23640 :       fSectors = fOuterSec;</span>
<span class="lineNum">    3033 </span>            : 
<span class="lineNum">    3034 </span><span class="lineCov">      38316 :     FollowToNext(t,nr);                                                             </span>
<span class="lineNum">    3035 </span>            :   }   
<span class="lineNum">    3036 </span><span class="lineCov">       2268 :   return 1;</span>
<span class="lineNum">    3037 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3038 </span>            : 
<span class="lineNum">    3039 </span>            : 
<span class="lineNum">    3040 </span>            : 
<a name="3041"><span class="lineNum">    3041 </span>            : </a>
<span class="lineNum">    3042 </span>            :    
<span class="lineNum">    3043 </span>            : Float_t AliTPCtracker::OverlapFactor(AliTPCseed * s1, AliTPCseed * s2, Int_t &amp;sum1, Int_t &amp; sum2)
<span class="lineNum">    3044 </span>            : {
<span class="lineNum">    3045 </span>            :   // overlapping factor
<span class="lineNum">    3046 </span>            :   //
<span class="lineNum">    3047 </span><span class="lineNoCov">          0 :   sum1=0;</span>
<span class="lineNum">    3048 </span><span class="lineNoCov">          0 :   sum2=0;</span>
<span class="lineNum">    3049 </span>            :   Int_t sum=0;
<span class="lineNum">    3050 </span>            :   //
<span class="lineNum">    3051 </span><span class="lineNoCov">          0 :   Float_t dz2 =(s1-&gt;GetZ() - s2-&gt;GetZ());</span>
<span class="lineNum">    3052 </span><span class="lineNoCov">          0 :   dz2*=dz2;  </span>
<span class="lineNum">    3053 </span>            : 
<span class="lineNum">    3054 </span><span class="lineNoCov">          0 :   Float_t dy2 =TMath::Abs((s1-&gt;GetY() - s2-&gt;GetY()));</span>
<span class="lineNum">    3055 </span><span class="lineNoCov">          0 :   dy2*=dy2;</span>
<span class="lineNum">    3056 </span><span class="lineNoCov">          0 :   Float_t distance = TMath::Sqrt(dz2+dy2);</span>
<span class="lineNum">    3057 </span><span class="lineNoCov">          0 :   if (distance&gt;4.) return 0; // if there are far away  - not overlap - to reduce combinatorics</span>
<span class="lineNum">    3058 </span>            :  
<span class="lineNum">    3059 </span>            :   //  Int_t offset =0;
<span class="lineNum">    3060 </span><span class="lineNoCov">          0 :   Int_t firstpoint = TMath::Min(s1-&gt;GetFirstPoint(),s2-&gt;GetFirstPoint());</span>
<span class="lineNum">    3061 </span><span class="lineNoCov">          0 :   Int_t lastpoint = TMath::Max(s1-&gt;GetLastPoint(),s2-&gt;GetLastPoint());</span>
<span class="lineNum">    3062 </span><span class="lineNoCov">          0 :   if (lastpoint&gt;=kMaxRow) </span>
<span class="lineNum">    3063 </span>            :     lastpoint = kMaxRow-1;
<span class="lineNum">    3064 </span><span class="lineNoCov">          0 :   if (firstpoint&lt;0) </span>
<span class="lineNum">    3065 </span><span class="lineNoCov">          0 :     firstpoint = 0;</span>
<span class="lineNum">    3066 </span><span class="lineNoCov">          0 :   if (firstpoint&gt;lastpoint) {</span>
<span class="lineNum">    3067 </span>            :     firstpoint =lastpoint;
<span class="lineNum">    3068 </span>            :     //    lastpoint  = kMaxRow-1;
<span class="lineNum">    3069 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    3070 </span>            :     
<span class="lineNum">    3071 </span>            :   
<span class="lineNum">    3072 </span>            :   // for (Int_t i=firstpoint-1;i&lt;lastpoint+1;i++){
<span class="lineNum">    3073 </span>            :   //   if (s1-&gt;GetClusterIndex2(i)&gt;0) sum1++;
<span class="lineNum">    3074 </span>            :   //   if (s2-&gt;GetClusterIndex2(i)&gt;0) sum2++;
<span class="lineNum">    3075 </span>            :   //   if (s1-&gt;GetClusterIndex2(i)==s2-&gt;GetClusterIndex2(i) &amp;&amp; s1-&gt;GetClusterIndex2(i)&gt;0) {
<span class="lineNum">    3076 </span>            :   //     sum++;
<span class="lineNum">    3077 </span>            :   //   }
<span class="lineNum">    3078 </span>            :   // }
<span class="lineNum">    3079 </span>            :   // RS: faster version + fix(?): clusterindex starts from 0 
<span class="lineNum">    3080 </span><span class="lineNoCov">          0 :   for (Int_t i=firstpoint-1;i&lt;lastpoint+1;i++){</span>
<span class="lineNum">    3081 </span><span class="lineNoCov">          0 :     int ind1=s1-&gt;GetClusterIndex2(i), ind2=s2-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    3082 </span><span class="lineNoCov">          0 :     if (ind1&gt;=0) sum1++;</span>
<span class="lineNum">    3083 </span><span class="lineNoCov">          0 :     if (ind2&gt;=0) sum2++;</span>
<span class="lineNum">    3084 </span><span class="lineNoCov">          0 :     if (ind1==ind2 &amp;&amp; ind1&gt;=0) sum++;</span>
<span class="lineNum">    3085 </span>            :   }
<span class="lineNum">    3086 </span><span class="lineNoCov">          0 :   if (sum&lt;5) return 0;</span>
<span class="lineNum">    3087 </span>            :   
<span class="lineNum">    3088 </span><span class="lineNoCov">          0 :   Float_t summin = TMath::Min(sum1+1,sum2+1);</span>
<span class="lineNum">    3089 </span><span class="lineNoCov">          0 :   Float_t ratio = (sum+1)/Float_t(summin);</span>
<span class="lineNum">    3090 </span>            :   return ratio;
<a name="3091"><span class="lineNum">    3091 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3092 </span>            : 
<span class="lineNum">    3093 </span>            : void  AliTPCtracker::SignShared(AliTPCseed * s1, AliTPCseed * s2)
<span class="lineNum">    3094 </span>            : {
<span class="lineNum">    3095 </span>            :   // shared clusters
<span class="lineNum">    3096 </span>            :   //
<span class="lineNum">    3097 </span>            :   Float_t thetaCut = 0.2;//+10.*TMath::Sqrt(s1-&gt;GetSigmaTglZ()+ s2-&gt;GetSigmaTglZ());
<span class="lineNum">    3098 </span><span class="lineCov">       1418 :   if (TMath::Abs(s1-&gt;GetTgl()-s2-&gt;GetTgl())&gt;thetaCut) return;</span>
<span class="lineNum">    3099 </span><span class="lineCov">        262 :   Float_t minCl = TMath::Min(s1-&gt;GetNumberOfClusters(),s2-&gt;GetNumberOfClusters());</span>
<span class="lineNum">    3100 </span><span class="lineCov">        262 :   Int_t cutN0 = TMath::Max(5,TMath::Nint(0.1*minCl));</span>
<span class="lineNum">    3101 </span>            :   
<span class="lineNum">    3102 </span>            :   //
<span class="lineNum">    3103 </span>            :   Int_t sumshared=0;
<span class="lineNum">    3104 </span>            :   //
<span class="lineNum">    3105 </span>            :   //Int_t firstpoint = TMath::Max(s1-&gt;GetFirstPoint(),s2-&gt;GetFirstPoint());
<span class="lineNum">    3106 </span>            :   //Int_t lastpoint = TMath::Min(s1-&gt;GetLastPoint(),s2-&gt;GetLastPoint());
<span class="lineNum">    3107 </span>            :   Int_t firstpoint = 0;
<span class="lineNum">    3108 </span>            :   Int_t lastpoint = kMaxRow;
<span class="lineNum">    3109 </span>            :   //
<span class="lineNum">    3110 </span>            :   //  if (firstpoint&gt;=lastpoint-5) return;;
<span class="lineNum">    3111 </span>            : 
<span class="lineNum">    3112 </span><span class="lineCov">      83840 :   for (Int_t i=firstpoint;i&lt;lastpoint;i++){</span>
<span class="lineNum">    3113 </span>            :     //    if ( (s1-&gt;GetClusterIndex2(i)&amp;0xFFFF8FFF)==(s2-&gt;GetClusterIndex2(i)&amp;0xFFFF8FFF) &amp;&amp; s1-&gt;GetClusterIndex2(i)&gt;0) {
<span class="lineNum">    3114 </span><span class="lineCov">      45484 :     if ( (s1-&gt;GetClusterIndex2(i))==(s2-&gt;GetClusterIndex2(i)) &amp;&amp; s1-&gt;GetClusterIndex2(i)&gt;=0) {</span>
<span class="lineNum">    3115 </span><span class="lineCov">        320 :       sumshared++;</span>
<span class="lineNum">    3116 </span><span class="lineCov">        320 :     }</span>
<span class="lineNum">    3117 </span>            :   }
<span class="lineNum">    3118 </span><span class="lineCov">        262 :   if (sumshared&gt;cutN0){</span>
<span class="lineNum">    3119 </span>            :     // sign clusters
<span class="lineNum">    3120 </span>            :     //
<span class="lineNum">    3121 </span><span class="lineCov">       3200 :     for (Int_t i=firstpoint;i&lt;lastpoint;i++){</span>
<span class="lineNum">    3122 </span>            :       //      if ( (s1-&gt;GetClusterIndex2(i)&amp;0xFFFF8FFF)==(s2-&gt;GetClusterIndex2(i)&amp;0xFFFF8FFF) &amp;&amp; s1-&gt;GetClusterIndex2(i)&gt;0) {
<span class="lineNum">    3123 </span><span class="lineCov">       1950 :       if ( (s1-&gt;GetClusterIndex2(i))==(s2-&gt;GetClusterIndex2(i)) &amp;&amp; s1-&gt;GetClusterIndex2(i)&gt;=0) {</span>
<span class="lineNum">    3124 </span><span class="lineCov">        288 :         const AliTPCTrackerPoints::Point *p1  = s1-&gt;GetTrackPoint(i);</span>
<span class="lineNum">    3125 </span><span class="lineCov">        288 :         const AliTPCTrackerPoints::Point *p2  = s2-&gt;GetTrackPoint(i);; </span>
<span class="lineNum">    3126 </span><span class="lineCov">        576 :         if (s1-&gt;IsActive()&amp;&amp;s2-&gt;IsActive()){</span>
<span class="lineNum">    3127 </span><span class="lineCov">        288 :           s1-&gt;SetShared(i);</span>
<span class="lineNum">    3128 </span><span class="lineCov">        288 :           s2-&gt;SetShared(i);</span>
<span class="lineNum">    3129 </span><span class="lineCov">        288 :         }       </span>
<span class="lineNum">    3130 </span><span class="lineCov">        288 :       }</span>
<span class="lineNum">    3131 </span>            :     }
<span class="lineNum">    3132 </span><span class="lineCov">         10 :   }</span>
<span class="lineNum">    3133 </span>            :   //  
<span class="lineNum">    3134 </span><span class="lineCov">        262 :   if (sumshared&gt;cutN0){</span>
<span class="lineNum">    3135 </span><span class="lineCov">         20 :     for (Int_t i=0;i&lt;4;i++){</span>
<span class="lineNum">    3136 </span><span class="lineCov">         10 :       if (s1-&gt;GetOverlapLabel(3*i)==0){</span>
<span class="lineNum">    3137 </span><span class="lineCov">         10 :         s1-&gt;SetOverlapLabel(3*i,  s2-&gt;GetLabel());</span>
<span class="lineNum">    3138 </span><span class="lineCov">         10 :         s1-&gt;SetOverlapLabel(3*i+1,sumshared);</span>
<span class="lineNum">    3139 </span><span class="lineCov">         10 :         s1-&gt;SetOverlapLabel(3*i+2,s2-&gt;GetUniqueID());</span>
<span class="lineNum">    3140 </span><span class="lineCov">         10 :         break;</span>
<span class="lineNum">    3141 </span>            :       } 
<span class="lineNum">    3142 </span>            :     }
<span class="lineNum">    3143 </span><span class="lineCov">         20 :     for (Int_t i=0;i&lt;4;i++){</span>
<span class="lineNum">    3144 </span><span class="lineCov">         10 :       if (s2-&gt;GetOverlapLabel(3*i)==0){</span>
<span class="lineNum">    3145 </span><span class="lineCov">         10 :         s2-&gt;SetOverlapLabel(3*i,  s1-&gt;GetLabel());</span>
<span class="lineNum">    3146 </span><span class="lineCov">         10 :         s2-&gt;SetOverlapLabel(3*i+1,sumshared);</span>
<span class="lineNum">    3147 </span><span class="lineCov">         10 :         s2-&gt;SetOverlapLabel(3*i+2,s1-&gt;GetUniqueID());</span>
<span class="lineNum">    3148 </span><span class="lineCov">         10 :         break;</span>
<span class="lineNum">    3149 </span>            :       } 
<span class="lineNum">    3150 </span>            :     }    
<span class="lineNum">    3151 </span><span class="lineCov">         10 :   }</span>
<a name="3152"><span class="lineNum">    3152 </span><span class="lineCov">        822 : }</span></a>
<span class="lineNum">    3153 </span>            : 
<span class="lineNum">    3154 </span>            : void  AliTPCtracker::SignShared(TObjArray * arr)
<span class="lineNum">    3155 </span>            : {
<span class="lineNum">    3156 </span>            :   //
<span class="lineNum">    3157 </span>            :   //sort trackss according sectors
<span class="lineNum">    3158 </span>            :   //  
<span class="lineNum">    3159 </span><span class="lineCov">        836 :   for (Int_t i=0; i&lt;arr-&gt;GetEntriesFast(); i++) {</span>
<span class="lineNum">    3160 </span><span class="lineCov">        394 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    3161 </span><span class="lineCov">        516 :     if (!pt) continue;</span>
<span class="lineNum">    3162 </span>            :     //if (pt) RotateToLocal(pt);
<span class="lineNum">    3163 </span><span class="lineCov">        272 :     pt-&gt;SetSort(0);</span>
<span class="lineNum">    3164 </span><span class="lineCov">        272 :   }</span>
<span class="lineNum">    3165 </span><span class="lineCov">         16 :   arr-&gt;UnSort();</span>
<span class="lineNum">    3166 </span><span class="lineCov">         16 :   arr-&gt;Sort();  // sorting according relative sectors</span>
<span class="lineNum">    3167 </span><span class="lineCov">         16 :   arr-&gt;Expand(arr-&gt;GetEntries());</span>
<span class="lineNum">    3168 </span>            :   //
<span class="lineNum">    3169 </span>            :   //
<span class="lineNum">    3170 </span><span class="lineCov">         16 :   Int_t nseed=arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    3171 </span><span class="lineCov">        576 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    3172 </span><span class="lineCov">        272 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    3173 </span><span class="lineCov">        272 :     if (!pt) continue;</span>
<span class="lineNum">    3174 </span><span class="lineCov">       7072 :     for (Int_t j=0;j&lt;12;j++){</span>
<span class="lineNum">    3175 </span><span class="lineCov">       3264 :       pt-&gt;SetOverlapLabel(j,0);</span>
<span class="lineNum">    3176 </span>            :     }
<span class="lineNum">    3177 </span><span class="lineCov">        272 :   }</span>
<span class="lineNum">    3178 </span><span class="lineCov">        576 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    3179 </span><span class="lineCov">        272 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    3180 </span><span class="lineCov">        272 :     if (!pt) continue;</span>
<span class="lineNum">    3181 </span><span class="lineCov">        272 :     if (pt-&gt;GetRemoval()&gt;10) continue;</span>
<span class="lineNum">    3182 </span><span class="lineCov">       5360 :     for (Int_t j=i+1; j&lt;nseed; j++){</span>
<span class="lineNum">    3183 </span><span class="lineCov">       2408 :       AliTPCseed *pt2=(AliTPCseed*)arr-&gt;UncheckedAt(j);</span>
<span class="lineNum">    3184 </span><span class="lineCov">       4256 :       if (TMath::Abs(pt-&gt;GetRelativeSector()-pt2-&gt;GetRelativeSector())&gt;1) continue;</span>
<span class="lineNum">    3185 </span>            :       //      if (pt2){
<span class="lineNum">    3186 </span><span class="lineCov">        560 :       if (pt2-&gt;GetRemoval()&lt;=10) {</span>
<span class="lineNum">    3187 </span>            :         //if ( TMath::Abs(pt-&gt;GetRelativeSector()-pt2-&gt;GetRelativeSector())&gt;0) break;
<span class="lineNum">    3188 </span><span class="lineCov">        560 :         SignShared(pt,pt2);</span>
<span class="lineNum">    3189 </span><span class="lineCov">        560 :       }</span>
<span class="lineNum">    3190 </span><span class="lineCov">        560 :     }  </span>
<span class="lineNum">    3191 </span><span class="lineCov">        272 :   }</span>
<span class="lineNum">    3192 </span><span class="lineCov">         16 : }</span>
<a name="3193"><span class="lineNum">    3193 </span>            : </a>
<span class="lineNum">    3194 </span>            : 
<span class="lineNum">    3195 </span>            : void AliTPCtracker::SortTracks(TObjArray * arr, Int_t mode) const
<span class="lineNum">    3196 </span>            : {
<span class="lineNum">    3197 </span>            :   //
<span class="lineNum">    3198 </span>            :   //sort tracks in array according mode criteria
<span class="lineNum">    3199 </span><span class="lineCov">         16 :   Int_t nseed = arr-&gt;GetEntriesFast();    </span>
<span class="lineNum">    3200 </span><span class="lineCov">        288 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    3201 </span><span class="lineCov">        136 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    3202 </span><span class="lineCov">        136 :     if (!pt) {</span>
<span class="lineNum">    3203 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    3204 </span>            :     }
<span class="lineNum">    3205 </span><span class="lineCov">        136 :     pt-&gt;SetSort(mode);</span>
<span class="lineNum">    3206 </span><span class="lineCov">        136 :   }</span>
<span class="lineNum">    3207 </span><span class="lineCov">          8 :   arr-&gt;UnSort();</span>
<span class="lineNum">    3208 </span><span class="lineCov">          8 :   arr-&gt;Sort();</span>
<span class="lineNum">    3209 </span><span class="lineCov">          8 : }</span>
<a name="3210"><span class="lineNum">    3210 </span>            : </a>
<span class="lineNum">    3211 </span>            : 
<span class="lineNum">    3212 </span>            : void AliTPCtracker::RemoveUsed2(TObjArray * arr, Float_t factor1,  Float_t factor2, Int_t minimal)
<span class="lineNum">    3213 </span>            : {
<span class="lineNum">    3214 </span>            :   //
<span class="lineNum">    3215 </span>            :   // Loop over all tracks and remove overlaped tracks (with lower quality)
<span class="lineNum">    3216 </span>            :   // Algorithm:
<span class="lineNum">    3217 </span>            :   //    1. Unsign clusters
<span class="lineNum">    3218 </span>            :   //    2. Sort tracks according quality
<span class="lineNum">    3219 </span>            :   //       Quality is defined by the number of cluster between first and last points 
<span class="lineNum">    3220 </span>            :   //       
<span class="lineNum">    3221 </span>            :   //    3. Loop over tracks - decreasing quality order
<span class="lineNum">    3222 </span>            :   //       a.) remove - If the fraction of shared cluster less than factor (1- n or 2) 
<span class="lineNum">    3223 </span>            :   //       b.) remove - If the minimal number of clusters less than minimal and not ITS
<span class="lineNum">    3224 </span>            :   //       c.) if track accepted - sign clusters
<span class="lineNum">    3225 </span>            :   //
<span class="lineNum">    3226 </span>            :   //Called in - AliTPCtracker::Clusters2Tracks()
<span class="lineNum">    3227 </span>            :   //          - AliTPCtracker::PropagateBack()
<span class="lineNum">    3228 </span>            :   //          - AliTPCtracker::RefitInward()
<span class="lineNum">    3229 </span>            :   //
<span class="lineNum">    3230 </span>            :   // Arguments:
<span class="lineNum">    3231 </span>            :   //   factor1 - factor for constrained
<span class="lineNum">    3232 </span>            :   //   factor2 -        for non constrained tracks 
<span class="lineNum">    3233 </span>            :   //            if (Float_t(shared+1)/Float_t(found+1)&gt;factor) - DELETE
<span class="lineNum">    3234 </span>            :   //
<span class="lineNum">    3235 </span><span class="lineCov">         80 :   UnsignClusters();</span>
<span class="lineNum">    3236 </span>            :   //
<span class="lineNum">    3237 </span><span class="lineCov">         40 :   Int_t nseed = arr-&gt;GetEntriesFast();  </span>
<span class="lineNum">    3238 </span>            :   //  Float_t quality = new Float_t[nseed];
<span class="lineNum">    3239 </span>            :   //  Int_t   * indexes = new Int_t[nseed];
<span class="lineNum">    3240 </span><span class="lineCov">         40 :   Float_t quality[nseed]; //RS Use stack allocations</span>
<span class="lineNum">    3241 </span><span class="lineCov">         40 :   Int_t   indexes[nseed];</span>
<span class="lineNum">    3242 </span>            :   Int_t good =0;
<span class="lineNum">    3243 </span>            :   //
<span class="lineNum">    3244 </span>            :   //
<span class="lineNum">    3245 </span><span class="lineCov">       2236 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    3246 </span><span class="lineCov">       1078 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    3247 </span><span class="lineCov">       1078 :     if (!pt){</span>
<span class="lineNum">    3248 </span><span class="lineCov">        242 :       quality[i]=-1;</span>
<span class="lineNum">    3249 </span><span class="lineCov">        242 :       continue;</span>
<span class="lineNum">    3250 </span>            :     }
<span class="lineNum">    3251 </span><span class="lineCov">        836 :     pt-&gt;UpdatePoints();    //select first last max dens points</span>
<span class="lineNum">    3252 </span><span class="lineCov">        836 :     Float_t * points = pt-&gt;GetPoints();</span>
<span class="lineNum">    3253 </span><span class="lineCov">        836 :     if (points[3]&lt;0.8) quality[i] =-1;</span>
<span class="lineNum">    3254 </span><span class="lineCov">        836 :     quality[i] = (points[2]-points[0])+pt-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    3255 </span>            :     //prefer high momenta tracks if overlaps
<span class="lineNum">    3256 </span><span class="lineCov">        836 :     quality[i] *= TMath::Sqrt(TMath::Abs(pt-&gt;Pt())+0.5); </span>
<span class="lineNum">    3257 </span><span class="lineCov">        836 :   }</span>
<span class="lineNum">    3258 </span><span class="lineCov">         40 :   TMath::Sort(nseed,quality,indexes);</span>
<span class="lineNum">    3259 </span>            :   //
<span class="lineNum">    3260 </span>            :   //
<span class="lineNum">    3261 </span><span class="lineCov">       2236 :   for (Int_t itrack=0; itrack&lt;nseed; itrack++) {</span>
<span class="lineNum">    3262 </span><span class="lineCov">       1078 :     Int_t trackindex = indexes[itrack];</span>
<span class="lineNum">    3263 </span><span class="lineCov">       1078 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(trackindex);   </span>
<span class="lineNum">    3264 </span><span class="lineCov">       1320 :     if (!pt) continue;</span>
<span class="lineNum">    3265 </span>            :     //
<span class="lineNum">    3266 </span><span class="lineCov">        836 :     if (quality[trackindex]&lt;0){</span>
<span class="lineNum">    3267 </span><span class="lineNoCov">          0 :       MarkSeedFree( arr-&gt;RemoveAt(trackindex) );</span>
<span class="lineNum">    3268 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    3269 </span>            :     }
<span class="lineNum">    3270 </span>            :     //
<span class="lineNum">    3271 </span>            :     //
<span class="lineNum">    3272 </span><span class="lineCov">        836 :     Int_t first = Int_t(pt-&gt;GetPoints()[0]);</span>
<span class="lineNum">    3273 </span><span class="lineCov">        836 :     Int_t last  = Int_t(pt-&gt;GetPoints()[2]);</span>
<span class="lineNum">    3274 </span><span class="lineCov">        836 :     Double_t factor = (pt-&gt;GetBConstrain()) ? factor1: factor2;</span>
<span class="lineNum">    3275 </span>            :     //
<span class="lineNum">    3276 </span><span class="lineCov">        836 :     Int_t found,foundable,shared;</span>
<span class="lineNum">    3277 </span><span class="lineCov">        836 :     GetSeedClusterStatistic(pt, first,last, found, foundable,shared,kFALSE); //RS: seeds don't keep their clusters</span>
<span class="lineNum">    3278 </span>            :     //RS pt-&gt;GetClusterStatistic(first,last, found, foundable,shared,kFALSE); // better to get statistic in &quot;high-dens&quot;  region do't use full track as in line bellow
<span class="lineNum">    3279 </span>            :     //MI  pt-&gt;GetClusterStatistic(0,kMaxRow, found, foundable,shared,kFALSE);
<span class="lineNum">    3280 </span>            :     Bool_t itsgold =kFALSE;
<span class="lineNum">    3281 </span><span class="lineCov">        836 :     if (pt-&gt;GetESD()){</span>
<span class="lineNum">    3282 </span><span class="lineCov">        272 :       Int_t dummy[12];</span>
<span class="lineNum">    3283 </span><span class="lineCov">        416 :       if (pt-&gt;GetESD()-&gt;GetITSclusters(dummy)&gt;4) itsgold= kTRUE;</span>
<span class="lineNum">    3284 </span><span class="lineCov">        272 :     }</span>
<span class="lineNum">    3285 </span><span class="lineCov">        836 :     if (!itsgold){</span>
<span class="lineNum">    3286 </span>            :       //
<span class="lineNum">    3287 </span><span class="lineCov">        692 :       if (Float_t(shared+1)/Float_t(found+1)&gt;factor){</span>
<span class="lineNum">    3288 </span><span class="lineCov">        140 :         if (pt-&gt;GetKinkIndexes()[0]!=0) continue;  //don't remove tracks  - part of the kinks</span>
<span class="lineNum">    3289 </span><span class="lineCov">        140 :         if( (AliTPCReconstructor::StreamLevel()&amp;kStreamRemoveUsed)&gt;0){ // flag:stream  information about TPC tracks which were descarded (double track removal)</span>
<span class="lineNum">    3290 </span><span class="lineNoCov">          0 :           TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    3291 </span><span class="lineNoCov">          0 :           cstream&lt;&lt;&quot;RemoveUsed&quot;&lt;&lt;</span>
<span class="lineNum">    3292 </span><span class="lineNoCov">          0 :             &quot;iter=&quot;&lt;&lt;fIteration&lt;&lt;</span>
<span class="lineNum">    3293 </span><span class="lineNoCov">          0 :             &quot;pt.=&quot;&lt;&lt;pt&lt;&lt;</span>
<span class="lineNum">    3294 </span>            :             &quot;\n&quot;;
<span class="lineNum">    3295 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3296 </span><span class="lineCov">        140 :         MarkSeedFree( arr-&gt;RemoveAt(trackindex) );</span>
<span class="lineNum">    3297 </span><span class="lineCov">        140 :         continue;</span>
<span class="lineNum">    3298 </span>            :       }      
<span class="lineNum">    3299 </span><span class="lineCov">        606 :       if (pt-&gt;GetNumberOfClusters()&lt;50&amp;&amp;(found-0.5*shared)&lt;minimal){  //remove short tracks</span>
<span class="lineNum">    3300 </span><span class="lineCov">          8 :         if (pt-&gt;GetKinkIndexes()[0]!=0) continue;  //don't remove tracks  - part of the kinks</span>
<span class="lineNum">    3301 </span><span class="lineCov">          8 :         if( (AliTPCReconstructor::StreamLevel()&amp;kStreamRemoveShort)&gt;0){ // flag:stream  information about TPC tracks which were discarded (short track removal)</span>
<span class="lineNum">    3302 </span><span class="lineNoCov">          0 :           TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    3303 </span><span class="lineNoCov">          0 :           cstream&lt;&lt;&quot;RemoveShort&quot;&lt;&lt;</span>
<span class="lineNum">    3304 </span><span class="lineNoCov">          0 :             &quot;iter=&quot;&lt;&lt;fIteration&lt;&lt;</span>
<span class="lineNum">    3305 </span><span class="lineNoCov">          0 :             &quot;pt.=&quot;&lt;&lt;pt&lt;&lt;</span>
<span class="lineNum">    3306 </span>            :             &quot;\n&quot;;
<span class="lineNum">    3307 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3308 </span><span class="lineCov">          8 :         MarkSeedFree( arr-&gt;RemoveAt(trackindex) );</span>
<span class="lineNum">    3309 </span><span class="lineCov">          8 :         continue;</span>
<span class="lineNum">    3310 </span>            :       }
<span class="lineNum">    3311 </span>            :     }
<span class="lineNum">    3312 </span>            : 
<span class="lineNum">    3313 </span><span class="lineCov">        688 :     good++;</span>
<span class="lineNum">    3314 </span>            :     //if (sharedfactor&gt;0.4) continue;
<span class="lineNum">    3315 </span><span class="lineCov">        700 :     if (pt-&gt;GetKinkIndexes()[0]&gt;0) continue;</span>
<span class="lineNum">    3316 </span>            :     //Remove tracks with undefined properties - seems
<span class="lineNum">    3317 </span><span class="lineCov">        676 :     if (pt-&gt;GetSigmaY2()&lt;kAlmost0) continue; // ? what is the origin ? </span>
<span class="lineNum">    3318 </span>            :     //
<span class="lineNum">    3319 </span><span class="lineCov">     159172 :     for (Int_t i=first; i&lt;last; i++) {</span>
<span class="lineNum">    3320 </span><span class="lineCov">      78910 :       Int_t index=pt-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    3321 </span>            :       // if (index&lt;0 || index&amp;0x8000 ) continue;
<span class="lineNum">    3322 </span><span class="lineCov">     159922 :       if (index&lt;0 || index&amp;0x8000 ) continue;</span>
<span class="lineNum">    3323 </span><span class="lineCov">      67942 :       AliTPCclusterMI *c= GetClusterMI(index); //RS pt-&gt;GetClusterPointer(i);        </span>
<span class="lineNum">    3324 </span><span class="lineCov">      67942 :       if (!c) continue;</span>
<span class="lineNum">    3325 </span><span class="lineCov">      67942 :       c-&gt;Use(10);  </span>
<span class="lineNum">    3326 </span><span class="lineCov">      67942 :     }    </span>
<span class="lineNum">    3327 </span><span class="lineCov">       1512 :   }</span>
<span class="lineNum">    3328 </span><span class="lineCov">         40 :   fNtracks = good;</span>
<span class="lineNum">    3329 </span><span class="lineCov">         40 :   if (fDebug&gt;0){</span>
<span class="lineNum">    3330 </span><span class="lineNoCov">          0 :     Info(&quot;RemoveUsed&quot;,&quot;\n*****\nNumber of good tracks after shared removal\t%d\n&quot;,fNtracks);</span>
<span class="lineNum">    3331 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    3332 </span>            :   //  delete []quality; // RS was moved to stack allocation
<span class="lineNum">    3333 </span>            :   //  delete []indexes;
<a name="3334"><span class="lineNum">    3334 </span><span class="lineCov">         40 : }</span></a>
<span class="lineNum">    3335 </span>            : 
<span class="lineNum">    3336 </span>            : void AliTPCtracker::DumpClusters(Int_t iter, TObjArray *trackArray) 
<span class="lineNum">    3337 </span>            : {
<span class="lineNum">    3338 </span>            :   //
<span class="lineNum">    3339 </span>            :   // Dump clusters after reco
<span class="lineNum">    3340 </span>            :   // signed and unsigned cluster can be visualized   
<span class="lineNum">    3341 </span>            :   // 1. Unsign all cluster
<span class="lineNum">    3342 </span>            :   // 2. Sign all used clusters
<span class="lineNum">    3343 </span>            :   // 3. Dump clusters
<span class="lineNum">    3344 </span><span class="lineNoCov">          0 :   UnsignClusters();</span>
<span class="lineNum">    3345 </span><span class="lineNoCov">          0 :   Int_t nseed = trackArray-&gt;GetEntries();</span>
<span class="lineNum">    3346 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;nseed; i++){</span>
<span class="lineNum">    3347 </span><span class="lineNoCov">          0 :     AliTPCseed *pt=(AliTPCseed*)trackArray-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    3348 </span><span class="lineNoCov">          0 :     if (!pt) {</span>
<span class="lineNum">    3349 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    3350 </span>            :     }    
<span class="lineNum">    3351 </span><span class="lineNoCov">          0 :     Bool_t isKink=pt-&gt;GetKinkIndex(0)!=0;</span>
<span class="lineNum">    3352 </span><span class="lineNoCov">          0 :     for (Int_t j=0; j&lt;kMaxRow; ++j) {</span>
<span class="lineNum">    3353 </span><span class="lineNoCov">          0 :       Int_t index=pt-&gt;GetClusterIndex2(j);</span>
<span class="lineNum">    3354 </span><span class="lineNoCov">          0 :       if (index&lt;0) continue;</span>
<span class="lineNum">    3355 </span><span class="lineNoCov">          0 :       AliTPCclusterMI *c= GetClusterMI(index); //RS pt-&gt;GetClusterPointer(j);</span>
<span class="lineNum">    3356 </span><span class="lineNoCov">          0 :       if (!c) continue;</span>
<span class="lineNum">    3357 </span><span class="lineNoCov">          0 :       if (isKink) c-&gt;Use(100);   // kink</span>
<span class="lineNum">    3358 </span><span class="lineNoCov">          0 :       c-&gt;Use(10);                // by default usage 10</span>
<span class="lineNum">    3359 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3360 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    3361 </span>            :   //
<span class="lineNum">    3362 </span><span class="lineNoCov">          0 :   Int_t eventNr = fEvent-&gt;GetEventNumberInFile();</span>
<span class="lineNum">    3363 </span>            : 
<span class="lineNum">    3364 </span><span class="lineNoCov">          0 :   for (Int_t sec=0;sec&lt;fkNIS;sec++){</span>
<span class="lineNum">    3365 </span><span class="lineNoCov">          0 :     for (Int_t row=0;row&lt;fInnerSec-&gt;GetNRows();row++){</span>
<span class="lineNum">    3366 </span><span class="lineNoCov">          0 :       TClonesArray *cla = fInnerSec[sec][row].GetClusters1();</span>
<span class="lineNum">    3367 </span><span class="lineNoCov">          0 :       for (Int_t icl =0;icl&lt; fInnerSec[sec][row].GetN1();icl++){    </span>
<span class="lineNum">    3368 </span><span class="lineNoCov">          0 :         AliTPCclusterMI* cl = (AliTPCclusterMI*)cla-&gt;At(icl);</span>
<span class="lineNum">    3369 </span><span class="lineNoCov">          0 :         Float_t gx[3];  cl-&gt;GetGlobalXYZ(gx);</span>
<span class="lineNum">    3370 </span><span class="lineNoCov">          0 :         (*fDebugStreamer)&lt;&lt;&quot;clDump&quot;&lt;&lt; </span>
<span class="lineNum">    3371 </span><span class="lineNoCov">          0 :           &quot;eventNr=&quot;&lt;&lt;eventNr&lt;&lt;</span>
<span class="lineNum">    3372 </span><span class="lineNoCov">          0 :           &quot;iter=&quot;&lt;&lt;iter&lt;&lt;</span>
<span class="lineNum">    3373 </span><span class="lineNoCov">          0 :           &quot;cl.=&quot;&lt;&lt;cl&lt;&lt;      </span>
<span class="lineNum">    3374 </span><span class="lineNoCov">          0 :           &quot;gx0=&quot;&lt;&lt;gx[0]&lt;&lt;</span>
<span class="lineNum">    3375 </span><span class="lineNoCov">          0 :           &quot;gx1=&quot;&lt;&lt;gx[1]&lt;&lt;</span>
<span class="lineNum">    3376 </span><span class="lineNoCov">          0 :           &quot;gx2=&quot;&lt;&lt;gx[2]&lt;&lt;</span>
<span class="lineNum">    3377 </span>            :           &quot;\n&quot;;
<span class="lineNum">    3378 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3379 </span><span class="lineNoCov">          0 :       cla = fInnerSec[sec][row].GetClusters2();</span>
<span class="lineNum">    3380 </span><span class="lineNoCov">          0 :       for (Int_t icl =0;icl&lt; fInnerSec[sec][row].GetN2();icl++){</span>
<span class="lineNum">    3381 </span><span class="lineNoCov">          0 :         AliTPCclusterMI* cl = (AliTPCclusterMI*)cla-&gt;At(icl);</span>
<span class="lineNum">    3382 </span><span class="lineNoCov">          0 :         Float_t gx[3];  cl-&gt;GetGlobalXYZ(gx);</span>
<span class="lineNum">    3383 </span><span class="lineNoCov">          0 :         (*fDebugStreamer)&lt;&lt;&quot;clDump&quot;&lt;&lt; </span>
<span class="lineNum">    3384 </span><span class="lineNoCov">          0 :           &quot;eventNr=&quot;&lt;&lt;eventNr&lt;&lt;</span>
<span class="lineNum">    3385 </span><span class="lineNoCov">          0 :           &quot;iter=&quot;&lt;&lt;iter&lt;&lt;</span>
<span class="lineNum">    3386 </span><span class="lineNoCov">          0 :           &quot;cl.=&quot;&lt;&lt;cl&lt;&lt;</span>
<span class="lineNum">    3387 </span><span class="lineNoCov">          0 :           &quot;gx0=&quot;&lt;&lt;gx[0]&lt;&lt;</span>
<span class="lineNum">    3388 </span><span class="lineNoCov">          0 :           &quot;gx1=&quot;&lt;&lt;gx[1]&lt;&lt;</span>
<span class="lineNum">    3389 </span><span class="lineNoCov">          0 :           &quot;gx2=&quot;&lt;&lt;gx[2]&lt;&lt;</span>
<span class="lineNum">    3390 </span>            :           &quot;\n&quot;;
<span class="lineNum">    3391 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3392 </span>            :     }
<span class="lineNum">    3393 </span>            :   }
<span class="lineNum">    3394 </span>            :   
<span class="lineNum">    3395 </span><span class="lineNoCov">          0 :   for (Int_t sec=0;sec&lt;fkNOS;sec++){</span>
<span class="lineNum">    3396 </span><span class="lineNoCov">          0 :     for (Int_t row=0;row&lt;fOuterSec-&gt;GetNRows();row++){</span>
<span class="lineNum">    3397 </span><span class="lineNoCov">          0 :       TClonesArray *cla = fOuterSec[sec][row].GetClusters1();</span>
<span class="lineNum">    3398 </span><span class="lineNoCov">          0 :       for (Int_t icl =0;icl&lt; fOuterSec[sec][row].GetN1();icl++){</span>
<span class="lineNum">    3399 </span><span class="lineNoCov">          0 :         Float_t gx[3];  </span>
<span class="lineNum">    3400 </span><span class="lineNoCov">          0 :         AliTPCclusterMI* cl = (AliTPCclusterMI*) cla-&gt;At(icl);</span>
<span class="lineNum">    3401 </span><span class="lineNoCov">          0 :         cl-&gt;GetGlobalXYZ(gx);</span>
<span class="lineNum">    3402 </span><span class="lineNoCov">          0 :         (*fDebugStreamer)&lt;&lt;&quot;clDump&quot;&lt;&lt; </span>
<span class="lineNum">    3403 </span><span class="lineNoCov">          0 :           &quot;eventNr=&quot;&lt;&lt;eventNr&lt;&lt;</span>
<span class="lineNum">    3404 </span><span class="lineNoCov">          0 :           &quot;iter=&quot;&lt;&lt;iter&lt;&lt;</span>
<span class="lineNum">    3405 </span><span class="lineNoCov">          0 :           &quot;cl.=&quot;&lt;&lt;cl&lt;&lt;</span>
<span class="lineNum">    3406 </span><span class="lineNoCov">          0 :           &quot;gx0=&quot;&lt;&lt;gx[0]&lt;&lt;</span>
<span class="lineNum">    3407 </span><span class="lineNoCov">          0 :           &quot;gx1=&quot;&lt;&lt;gx[1]&lt;&lt;</span>
<span class="lineNum">    3408 </span><span class="lineNoCov">          0 :           &quot;gx2=&quot;&lt;&lt;gx[2]&lt;&lt;</span>
<span class="lineNum">    3409 </span>            :           &quot;\n&quot;;      
<span class="lineNum">    3410 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3411 </span><span class="lineNoCov">          0 :       cla = fOuterSec[sec][row].GetClusters2();</span>
<span class="lineNum">    3412 </span><span class="lineNoCov">          0 :       for (Int_t icl =0;icl&lt; fOuterSec[sec][row].GetN2();icl++){</span>
<span class="lineNum">    3413 </span><span class="lineNoCov">          0 :         Float_t gx[3];  </span>
<span class="lineNum">    3414 </span><span class="lineNoCov">          0 :         AliTPCclusterMI* cl = (AliTPCclusterMI*) cla-&gt;At(icl);</span>
<span class="lineNum">    3415 </span><span class="lineNoCov">          0 :         cl-&gt;GetGlobalXYZ(gx);</span>
<span class="lineNum">    3416 </span><span class="lineNoCov">          0 :         (*fDebugStreamer)&lt;&lt;&quot;clDump&quot;&lt;&lt; </span>
<span class="lineNum">    3417 </span><span class="lineNoCov">          0 :           &quot;eventNr=&quot;&lt;&lt;eventNr&lt;&lt;</span>
<span class="lineNum">    3418 </span><span class="lineNoCov">          0 :           &quot;iter=&quot;&lt;&lt;iter&lt;&lt;</span>
<span class="lineNum">    3419 </span><span class="lineNoCov">          0 :           &quot;cl.=&quot;&lt;&lt;cl&lt;&lt;</span>
<span class="lineNum">    3420 </span><span class="lineNoCov">          0 :           &quot;gx0=&quot;&lt;&lt;gx[0]&lt;&lt;</span>
<span class="lineNum">    3421 </span><span class="lineNoCov">          0 :           &quot;gx1=&quot;&lt;&lt;gx[1]&lt;&lt;</span>
<span class="lineNum">    3422 </span><span class="lineNoCov">          0 :           &quot;gx2=&quot;&lt;&lt;gx[2]&lt;&lt;</span>
<span class="lineNum">    3423 </span>            :           &quot;\n&quot;;      
<span class="lineNum">    3424 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3425 </span>            :     }
<span class="lineNum">    3426 </span>            :   }
<a name="3427"><span class="lineNum">    3427 </span>            :   </a>
<span class="lineNum">    3428 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3429 </span>            : void AliTPCtracker::UnsignClusters() 
<span class="lineNum">    3430 </span>            : {
<span class="lineNum">    3431 </span>            :   //
<span class="lineNum">    3432 </span>            :   // loop over all clusters and unsign them
<span class="lineNum">    3433 </span>            :   //
<span class="lineNum">    3434 </span>            :   
<span class="lineNum">    3435 </span><span class="lineCov">       2496 :   for (Int_t sec=0;sec&lt;fkNIS;sec++){</span>
<span class="lineNum">    3436 </span><span class="lineCov">     147456 :     for (Int_t row=0;row&lt;fInnerSec-&gt;GetNRows();row++){</span>
<span class="lineNum">    3437 </span><span class="lineCov">      72576 :       TClonesArray *cla = fInnerSec[sec][row].GetClusters1();</span>
<span class="lineNum">    3438 </span><span class="lineCov">     555200 :       for (Int_t icl =0;icl&lt; fInnerSec[sec][row].GetN1();icl++)</span>
<span class="lineNum">    3439 </span>            :         //      if (cl[icl].IsUsed(10))         
<span class="lineNum">    3440 </span><span class="lineCov">     205024 :         ((AliTPCclusterMI*) cla-&gt;At(icl))-&gt;Use(-1);</span>
<span class="lineNum">    3441 </span><span class="lineCov">      72576 :       cla = fInnerSec[sec][row].GetClusters2();</span>
<span class="lineNum">    3442 </span><span class="lineCov">     472704 :       for (Int_t icl =0;icl&lt; fInnerSec[sec][row].GetN2();icl++)</span>
<span class="lineNum">    3443 </span>            :         //if (cl[icl].IsUsed(10))       
<span class="lineNum">    3444 </span><span class="lineCov">     163776 :         ((AliTPCclusterMI*) cla-&gt;At(icl))-&gt;Use(-1);</span>
<span class="lineNum">    3445 </span>            :     }
<span class="lineNum">    3446 </span>            :   }
<span class="lineNum">    3447 </span>            :   
<span class="lineNum">    3448 </span><span class="lineCov">       2432 :   for (Int_t sec=0;sec&lt;fkNOS;sec++){</span>
<span class="lineNum">    3449 </span><span class="lineCov">     223488 :     for (Int_t row=0;row&lt;fOuterSec-&gt;GetNRows();row++){</span>
<span class="lineNum">    3450 </span><span class="lineCov">     110592 :       TClonesArray *cla = fOuterSec[sec][row].GetClusters1();</span>
<span class="lineNum">    3451 </span><span class="lineCov">     349856 :       for (Int_t icl =0;icl&lt; fOuterSec[sec][row].GetN1();icl++)</span>
<span class="lineNum">    3452 </span>            :         //if (cl[icl].IsUsed(10))       
<span class="lineNum">    3453 </span><span class="lineCov">      64336 :         ((AliTPCclusterMI*) cla-&gt;At(icl))-&gt;Use(-1);</span>
<span class="lineNum">    3454 </span><span class="lineCov">     110592 :       cla = fOuterSec[sec][row].GetClusters2();</span>
<span class="lineNum">    3455 </span><span class="lineCov">     394080 :       for (Int_t icl =0;icl&lt; fOuterSec[sec][row].GetN2();icl++)</span>
<span class="lineNum">    3456 </span>            :         //if (cl[icl].IsUsed(10))       
<span class="lineNum">    3457 </span><span class="lineCov">      86448 :         ((AliTPCclusterMI*) cla-&gt;At(icl))-&gt;Use(-1);</span>
<span class="lineNum">    3458 </span>            :     }
<span class="lineNum">    3459 </span>            :   }
<span class="lineNum">    3460 </span>            :   
<span class="lineNum">    3461 </span><span class="lineCov">         64 : }</span>
<span class="lineNum">    3462 </span>            : 
<a name="3463"><span class="lineNum">    3463 </span>            : </a>
<span class="lineNum">    3464 </span>            : 
<span class="lineNum">    3465 </span>            : void AliTPCtracker::SignClusters(const TObjArray * arr, Float_t fnumber, Float_t fdensity)
<span class="lineNum">    3466 </span>            : {
<span class="lineNum">    3467 </span>            :   //
<span class="lineNum">    3468 </span>            :   //sign clusters to be &quot;used&quot;
<span class="lineNum">    3469 </span>            :   //
<span class="lineNum">    3470 </span>            :   // snumber and sdensity sign number of sigmas - bellow mean value to be accepted
<span class="lineNum">    3471 </span>            :   // loop over &quot;primaries&quot;
<span class="lineNum">    3472 </span>            :   
<span class="lineNum">    3473 </span>            :   Float_t sumdens=0;
<span class="lineNum">    3474 </span>            :   Float_t sumdens2=0;
<span class="lineNum">    3475 </span>            :   Float_t sumn   =0;
<span class="lineNum">    3476 </span>            :   Float_t sumn2  =0;
<span class="lineNum">    3477 </span>            :   Float_t sumchi =0;
<span class="lineNum">    3478 </span>            :   Float_t sumchi2 =0;
<span class="lineNum">    3479 </span>            : 
<span class="lineNum">    3480 </span>            :   Float_t sum    =0;
<span class="lineNum">    3481 </span>            : 
<span class="lineNum">    3482 </span><span class="lineCov">       1392 :   TStopwatch timer;</span>
<span class="lineNum">    3483 </span><span class="lineCov">        696 :   timer.Start();</span>
<span class="lineNum">    3484 </span>            : 
<span class="lineNum">    3485 </span><span class="lineCov">        696 :   Int_t nseed = arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    3486 </span><span class="lineCov">      40608 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    3487 </span><span class="lineCov">      19608 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    3488 </span><span class="lineCov">      19608 :     if (!pt) {</span>
<span class="lineNum">    3489 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    3490 </span>            :     }    
<span class="lineNum">    3491 </span><span class="lineCov">      19866 :     if (!(pt-&gt;IsActive())) continue;</span>
<span class="lineNum">    3492 </span><span class="lineCov">      38700 :     Float_t dens = pt-&gt;GetNumberOfClusters()/Float_t(pt-&gt;GetNFoundable());</span>
<span class="lineNum">    3493 </span><span class="lineCov">      58042 :     if ( (dens&gt;0.7) &amp;&amp; (pt-&gt;GetNumberOfClusters()&gt;70)){</span>
<span class="lineNum">    3494 </span><span class="lineCov">      18966 :       sumdens += dens;</span>
<span class="lineNum">    3495 </span><span class="lineCov">      18966 :       sumdens2+= dens*dens;</span>
<span class="lineNum">    3496 </span><span class="lineCov">      37932 :       sumn    += pt-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    3497 </span><span class="lineCov">      56898 :       sumn2   += pt-&gt;GetNumberOfClusters()*pt-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    3498 </span><span class="lineCov">      37932 :       Float_t chi2 = pt-&gt;GetChi2()/pt-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    3499 </span><span class="lineCov">      18966 :       if (chi2&gt;5) chi2=5;</span>
<span class="lineNum">    3500 </span><span class="lineCov">      18966 :       sumchi  +=chi2;</span>
<span class="lineNum">    3501 </span><span class="lineCov">      18966 :       sumchi2 +=chi2*chi2;</span>
<span class="lineNum">    3502 </span><span class="lineCov">      18966 :       sum++;</span>
<span class="lineNum">    3503 </span><span class="lineCov">      18966 :     }</span>
<span class="lineNum">    3504 </span><span class="lineCov">      19350 :   }</span>
<span class="lineNum">    3505 </span>            : 
<span class="lineNum">    3506 </span>            :   Float_t mdensity = 0.9;
<span class="lineNum">    3507 </span>            :   Float_t meann    = 130;
<span class="lineNum">    3508 </span>            :   Float_t meanchi  = 1;
<span class="lineNum">    3509 </span>            :   Float_t sdensity = 0.1;
<span class="lineNum">    3510 </span>            :   Float_t smeann    = 10;
<span class="lineNum">    3511 </span>            :   Float_t smeanchi  =0.4;
<span class="lineNum">    3512 </span>            :   
<span class="lineNum">    3513 </span>            : 
<span class="lineNum">    3514 </span><span class="lineCov">        696 :   if (sum&gt;20){</span>
<span class="lineNum">    3515 </span><span class="lineCov">        680 :     mdensity = sumdens/sum;</span>
<span class="lineNum">    3516 </span><span class="lineCov">        680 :     meann    = sumn/sum;</span>
<span class="lineNum">    3517 </span><span class="lineCov">        680 :     meanchi  = sumchi/sum;</span>
<span class="lineNum">    3518 </span>            :     //
<span class="lineNum">    3519 </span><span class="lineCov">        680 :     sdensity = sumdens2/sum-mdensity*mdensity;</span>
<span class="lineNum">    3520 </span><span class="lineCov">        680 :     if (sdensity &gt;= 0)</span>
<span class="lineNum">    3521 </span><span class="lineCov">        680 :        sdensity = TMath::Sqrt(sdensity);</span>
<span class="lineNum">    3522 </span>            :     else
<span class="lineNum">    3523 </span>            :        sdensity = 0.1;
<span class="lineNum">    3524 </span>            :     //
<span class="lineNum">    3525 </span><span class="lineCov">        680 :     smeann   = sumn2/sum-meann*meann;</span>
<span class="lineNum">    3526 </span><span class="lineCov">        680 :     if (smeann &gt;= 0)</span>
<span class="lineNum">    3527 </span><span class="lineCov">        680 :       smeann   = TMath::Sqrt(smeann);</span>
<span class="lineNum">    3528 </span>            :     else 
<span class="lineNum">    3529 </span>            :       smeann   = 10;
<span class="lineNum">    3530 </span>            :     //
<span class="lineNum">    3531 </span><span class="lineCov">        680 :     smeanchi = sumchi2/sum - meanchi*meanchi;</span>
<span class="lineNum">    3532 </span><span class="lineCov">        680 :     if (smeanchi &gt;= 0)</span>
<span class="lineNum">    3533 </span><span class="lineCov">        680 :       smeanchi = TMath::Sqrt(smeanchi);</span>
<span class="lineNum">    3534 </span>            :     else
<span class="lineNum">    3535 </span>            :       smeanchi = 0.4;
<span class="lineNum">    3536 </span>            :   }
<span class="lineNum">    3537 </span>            : 
<span class="lineNum">    3538 </span>            : 
<span class="lineNum">    3539 </span>            :   //REMOVE  SHORT DELTAS or tracks going out of sensitive volume of TPC
<span class="lineNum">    3540 </span>            :   //
<span class="lineNum">    3541 </span><span class="lineCov">      40608 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    3542 </span><span class="lineCov">      19608 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    3543 </span><span class="lineCov">      19608 :     if (!pt) {</span>
<span class="lineNum">    3544 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    3545 </span>            :     }
<span class="lineNum">    3546 </span><span class="lineCov">      57722 :     if (pt-&gt;GetBSigned()) continue;</span>
<span class="lineNum">    3547 </span><span class="lineCov">       1512 :     if (pt-&gt;GetBConstrain()) continue;    </span>
<span class="lineNum">    3548 </span>            :     //if (!(pt-&gt;IsActive())) continue;
<span class="lineNum">    3549 </span>            :     /*
<span class="lineNum">    3550 </span>            :     Int_t found,foundable,shared;    
<span class="lineNum">    3551 </span>            :     pt-&gt;GetClusterStatistic(0,kMaxRow,found, foundable,shared);
<span class="lineNum">    3552 </span>            :     if (shared/float(found)&gt;0.3) {
<span class="lineNum">    3553 </span>            :       if (shared/float(found)&gt;0.9 ){
<span class="lineNum">    3554 </span>            :         //MarkSeedFree( arr-&gt;RemoveAt(i) );
<span class="lineNum">    3555 </span>            :       }
<span class="lineNum">    3556 </span>            :       continue;
<span class="lineNum">    3557 </span>            :     }
<span class="lineNum">    3558 </span>            :     */
<span class="lineNum">    3559 </span>            :     Bool_t isok =kFALSE;
<span class="lineNum">    3560 </span><span class="lineCov">       2768 :     if ( (pt-&gt;GetNShared()/pt-&gt;GetNumberOfClusters()&lt;0.5) &amp;&amp;pt-&gt;GetNumberOfClusters()&gt;60)</span>
<span class="lineNum">    3561 </span><span class="lineCov">         76 :       isok = kTRUE;</span>
<span class="lineNum">    3562 </span><span class="lineCov">       1976 :     if ((TMath::Abs(1/pt-&gt;GetC())&lt;100.) &amp;&amp; (pt-&gt;GetNShared()/pt-&gt;GetNumberOfClusters()&lt;0.7))</span>
<span class="lineNum">    3563 </span><span class="lineCov">        296 :       isok =kTRUE;</span>
<span class="lineNum">    3564 </span><span class="lineCov">       2076 :     if  (TMath::Abs(pt-&gt;GetZ()/pt-&gt;GetX())&gt;1.1)</span>
<span class="lineNum">    3565 </span><span class="lineCov">        206 :       isok =kTRUE;</span>
<span class="lineNum">    3566 </span><span class="lineCov">       1388 :     if ( (TMath::Abs(pt-&gt;GetSnp()&gt;0.7) &amp;&amp; pt-&gt;GetD(0,0)&gt;60.))</span>
<span class="lineNum">    3567 </span><span class="lineNoCov">          0 :       isok =kTRUE;</span>
<span class="lineNum">    3568 </span>            :     
<span class="lineNum">    3569 </span><span class="lineCov">        692 :     if (isok)     </span>
<span class="lineNum">    3570 </span><span class="lineCov">     138880 :       for (Int_t j=0; j&lt;kMaxRow; ++j) {      </span>
<span class="lineNum">    3571 </span><span class="lineCov">      69006 :         Int_t index=pt-&gt;GetClusterIndex2(j);</span>
<span class="lineNum">    3572 </span><span class="lineCov">     115568 :         if (index&lt;0) continue;</span>
<span class="lineNum">    3573 </span><span class="lineCov">      22444 :         AliTPCclusterMI *c= GetClusterMI(index);//pt-&gt;GetClusterPointer(j);</span>
<span class="lineNum">    3574 </span><span class="lineCov">      22444 :         if (!c) continue;</span>
<span class="lineNum">    3575 </span>            :         //if (!(c-&gt;IsUsed(10))) c-&gt;Use();  
<span class="lineNum">    3576 </span><span class="lineCov">      22444 :         c-&gt;Use(10);  </span>
<span class="lineNum">    3577 </span><span class="lineCov">      22878 :       }</span>
<span class="lineNum">    3578 </span><span class="lineCov">        692 :   }</span>
<span class="lineNum">    3579 </span>            :   
<span class="lineNum">    3580 </span>            :   
<span class="lineNum">    3581 </span>            :   //
<span class="lineNum">    3582 </span><span class="lineCov">        696 :   Double_t maxchi  = meanchi+2.*smeanchi;</span>
<span class="lineNum">    3583 </span>            : 
<span class="lineNum">    3584 </span><span class="lineCov">      40608 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    3585 </span><span class="lineCov">      19608 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    3586 </span><span class="lineCov">      19608 :     if (!pt) {</span>
<span class="lineNum">    3587 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    3588 </span>            :     }    
<span class="lineNum">    3589 </span>            :     //if (!(pt-&gt;IsActive())) continue;
<span class="lineNum">    3590 </span><span class="lineCov">      57722 :     if (pt-&gt;GetBSigned()) continue;</span>
<span class="lineNum">    3591 </span><span class="lineCov">       2204 :     Double_t chi     = pt-&gt;GetChi2()/pt-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    3592 </span><span class="lineCov">       1384 :     if (chi&gt;maxchi) continue;</span>
<span class="lineNum">    3593 </span>            : 
<span class="lineNum">    3594 </span>            :     Float_t bfactor=1;
<span class="lineNum">    3595 </span><span class="lineCov">       1640 :     Float_t dens = pt-&gt;GetNumberOfClusters()/Float_t(pt-&gt;GetNFoundable());</span>
<span class="lineNum">    3596 </span>            :    
<span class="lineNum">    3597 </span>            :     //sign only tracks with enoug big density at the beginning
<span class="lineNum">    3598 </span>            :     
<span class="lineNum">    3599 </span><span class="lineCov">       2204 :     if ((pt-&gt;GetDensityFirst(40)&lt;0.75) &amp;&amp; pt-&gt;GetNumberOfClusters()&lt;meann) continue; </span>
<span class="lineNum">    3600 </span>            :     
<span class="lineNum">    3601 </span>            :     
<span class="lineNum">    3602 </span><span class="lineCov">        632 :     Double_t mindens = TMath::Max(double(mdensity-sdensity*fdensity*bfactor),0.65);</span>
<span class="lineNum">    3603 </span><span class="lineCov">        632 :     Double_t minn    = TMath::Max(Int_t(meann-fnumber*smeann*bfactor),50);</span>
<span class="lineNum">    3604 </span>            :    
<span class="lineNum">    3605 </span>            :     //    if (pt-&gt;fBConstrain) mindens = TMath::Max(mdensity-sdensity*fdensity*bfactor,0.65);
<span class="lineNum">    3606 </span><span class="lineCov">        808 :     if ( (pt-&gt;GetRemoval()==10) &amp;&amp; (pt-&gt;GetSnp()&gt;0.8)&amp;&amp;(dens&gt;mindens))</span>
<span class="lineNum">    3607 </span><span class="lineNoCov">          0 :       minn=0;</span>
<span class="lineNum">    3608 </span>            : 
<span class="lineNum">    3609 </span><span class="lineCov">       2126 :     if ((dens&gt;mindens &amp;&amp; pt-&gt;GetNumberOfClusters()&gt;minn) &amp;&amp; chi&lt;maxchi ){</span>
<span class="lineNum">    3610 </span>            :       //Int_t noc=pt-&gt;GetNumberOfClusters();
<span class="lineNum">    3611 </span><span class="lineCov">        230 :       pt-&gt;SetBSigned(kTRUE);</span>
<span class="lineNum">    3612 </span><span class="lineCov">      73600 :       for (Int_t j=0; j&lt;kMaxRow; ++j) {</span>
<span class="lineNum">    3613 </span>            : 
<span class="lineNum">    3614 </span><span class="lineCov">      36570 :         Int_t index=pt-&gt;GetClusterIndex2(j);</span>
<span class="lineNum">    3615 </span><span class="lineCov">      41778 :         if (index&lt;0) continue;</span>
<span class="lineNum">    3616 </span><span class="lineCov">      31362 :         AliTPCclusterMI *c= GetClusterMI(index); //RS pt-&gt;GetClusterPointer(j);</span>
<span class="lineNum">    3617 </span><span class="lineCov">      31362 :         if (!c) continue;</span>
<span class="lineNum">    3618 </span>            :         //      if (!(c-&gt;IsUsed(10))) c-&gt;Use();  
<span class="lineNum">    3619 </span><span class="lineCov">      31362 :         c-&gt;Use(10);  </span>
<span class="lineNum">    3620 </span><span class="lineCov">      31362 :       }</span>
<span class="lineNum">    3621 </span><span class="lineCov">        230 :     }</span>
<span class="lineNum">    3622 </span><span class="lineCov">        632 :   }</span>
<span class="lineNum">    3623 </span>            :   //  gLastCheck = nseed;
<span class="lineNum">    3624 </span>            :   //  arr-&gt;Compress();
<span class="lineNum">    3625 </span><span class="lineCov">        696 :   if (fDebug&gt;0){</span>
<span class="lineNum">    3626 </span><span class="lineNoCov">          0 :     timer.Print();</span>
<span class="lineNum">    3627 </span>            :   }
<span class="lineNum">    3628 </span><span class="lineCov">        696 : }</span>
<span class="lineNum">    3629 </span>            : 
<a name="3630"><span class="lineNum">    3630 </span>            : </a>
<span class="lineNum">    3631 </span>            : 
<span class="lineNum">    3632 </span>            : Int_t AliTPCtracker::RefitInward(AliESDEvent *event)
<span class="lineNum">    3633 </span>            : {
<span class="lineNum">    3634 </span>            :   //
<span class="lineNum">    3635 </span>            :   // back propagation of ESD tracks
<span class="lineNum">    3636 </span>            :   //
<span class="lineNum">    3637 </span>            :   //return 0;
<span class="lineNum">    3638 </span><span class="lineCov">         16 :   if (!event) return 0;</span>
<span class="lineNum">    3639 </span><span class="lineCov">          8 :   fEvent = event;</span>
<span class="lineNum">    3640 </span><span class="lineCov">          8 :   fEventHLT = 0;</span>
<span class="lineNum">    3641 </span>            :   // extract correction object for multiplicity dependence of dEdx
<span class="lineNum">    3642 </span><span class="lineCov">          8 :   TObjArray * gainCalibArray = AliTPCcalibDB::Instance()-&gt;GetTimeGainSplinesRun(event-&gt;GetRunNumber());</span>
<span class="lineNum">    3643 </span>            : 
<span class="lineNum">    3644 </span><span class="lineCov">          8 :   AliTPCTransform *transform = AliTPCcalibDB::Instance()-&gt;GetTransform() ;</span>
<span class="lineNum">    3645 </span><span class="lineCov">          8 :   if (!transform) {</span>
<span class="lineNum">    3646 </span><span class="lineNoCov">          0 :     AliFatal(&quot;Tranformations not in RefitInward&quot;);</span>
<span class="lineNum">    3647 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">    3648 </span>            :   }
<span class="lineNum">    3649 </span><span class="lineCov">          8 :   transform-&gt;SetCurrentRecoParam((AliTPCRecoParam*)AliTPCReconstructor::GetRecoParam());</span>
<span class="lineNum">    3650 </span><span class="lineCov">          8 :   const AliTPCRecoParam * recoParam = AliTPCcalibDB::Instance()-&gt;GetTransform()-&gt;GetCurrentRecoParam();</span>
<span class="lineNum">    3651 </span><span class="lineCov">          8 :   Int_t nContribut = event-&gt;GetNumberOfTracks();</span>
<span class="lineNum">    3652 </span>            :   TGraphErrors * graphMultDependenceDeDx = 0x0;
<span class="lineNum">    3653 </span><span class="lineCov">         16 :   if (recoParam &amp;&amp; recoParam-&gt;GetUseMultiplicityCorrectionDedx() &amp;&amp; gainCalibArray) {</span>
<span class="lineNum">    3654 </span><span class="lineNoCov">          0 :     if (recoParam-&gt;GetUseTotCharge()) {</span>
<span class="lineNum">    3655 </span><span class="lineNoCov">          0 :       graphMultDependenceDeDx = (TGraphErrors *) gainCalibArray-&gt;FindObject(&quot;TGRAPHERRORS_MEANQTOT_MULTIPLICITYDEPENDENCE_BEAM_ALL&quot;);</span>
<span class="lineNum">    3656 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">    3657 </span><span class="lineNoCov">          0 :       graphMultDependenceDeDx = (TGraphErrors *) gainCalibArray-&gt;FindObject(&quot;TGRAPHERRORS_MEANQMAX_MULTIPLICITYDEPENDENCE_BEAM_ALL&quot;);</span>
<span class="lineNum">    3658 </span>            :     }
<span class="lineNum">    3659 </span>            :   }
<span class="lineNum">    3660 </span>            :   //
<span class="lineNum">    3661 </span><span class="lineCov">          8 :   ReadSeeds(event,2);</span>
<span class="lineNum">    3662 </span><span class="lineCov">          8 :   fIteration=2;</span>
<span class="lineNum">    3663 </span>            :   //PrepareForProlongation(fSeeds,1);
<span class="lineNum">    3664 </span><span class="lineCov">          8 :   PropagateForward2(fSeeds);</span>
<span class="lineNum">    3665 </span><span class="lineCov">          8 :   RemoveUsed2(fSeeds,0.4,0.4,20);</span>
<span class="lineNum">    3666 </span>            : 
<span class="lineNum">    3667 </span><span class="lineCov">          8 :   Int_t entriesSeed=fSeeds-&gt;GetEntries();</span>
<span class="lineNum">    3668 </span><span class="lineCov">          8 :   TObjArray arraySeed(entriesSeed);</span>
<span class="lineNum">    3669 </span><span class="lineCov">        288 :   for (Int_t i=0;i&lt;entriesSeed;i++) {</span>
<span class="lineNum">    3670 </span><span class="lineCov">        272 :     arraySeed.AddAt(fSeeds-&gt;At(i),i);    </span>
<span class="lineNum">    3671 </span>            :   }
<span class="lineNum">    3672 </span><span class="lineCov">          8 :   SignShared(&amp;arraySeed);</span>
<span class="lineNum">    3673 </span>            :   //  FindCurling(fSeeds, event,2); // find multi found tracks
<span class="lineNum">    3674 </span><span class="lineCov">          8 :   FindSplitted(fSeeds, event,2); // find multi found tracks</span>
<span class="lineNum">    3675 </span><span class="lineCov">          8 :   if ((AliTPCReconstructor::StreamLevel()&amp;kStreamFindMultiMC)&gt;0)  FindMultiMC(fSeeds, fEvent,2); // flag: stream MC infomation about the multiple find track (ONLY for MC data)</span>
<span class="lineNum">    3676 </span>            : 
<span class="lineNum">    3677 </span>            :   Int_t ntracks=0;
<span class="lineNum">    3678 </span><span class="lineCov">          8 :   Int_t nseed = fSeeds-&gt;GetEntriesFast();</span>
<span class="lineNum">    3679 </span>            :   //
<span class="lineNum">    3680 </span>            :   // RS: the cluster pointers are not permanently attached to the seed during the tracking, need to attach temporarily
<span class="lineNum">    3681 </span><span class="lineCov">          8 :   AliTPCclusterMI* seedClusters[kMaxRow];</span>
<span class="lineNum">    3682 </span>            :   int seedsInFriends = 0;
<span class="lineNum">    3683 </span><span class="lineCov">          8 :   int seedsInFriendsNorm = event-&gt;GetNTPCFriend2Store();</span>
<span class="lineNum">    3684 </span><span class="lineCov">         12 :   if (seedsInFriendsNorm&gt;nseed) seedsInFriendsNorm = nseed; // all friends are stored</span>
<span class="lineNum">    3685 </span>            :   //
<span class="lineNum">    3686 </span><span class="lineCov">          8 :   fClPointersPoolPtr = fClPointersPool;</span>
<span class="lineNum">    3687 </span>            :   //
<span class="lineNum">    3688 </span><span class="lineCov">        288 :   for (Int_t i=0;i&lt;nseed;i++) {</span>
<span class="lineNum">    3689 </span><span class="lineCov">        136 :     AliTPCseed * seed = (AliTPCseed*) fSeeds-&gt;UncheckedAt(i);</span>
<span class="lineNum">    3690 </span><span class="lineCov">        136 :     if (!seed) continue;</span>
<span class="lineNum">    3691 </span><span class="lineCov">        276 :     if (seed-&gt;GetKinkIndex(0)&gt;0)  UpdateKinkQualityD(seed);  // update quality informations for kinks</span>
<span class="lineNum">    3692 </span><span class="lineCov">        136 :     AliESDtrack *esd=event-&gt;GetTrack(i);</span>
<span class="lineNum">    3693 </span>            :     //
<span class="lineNum">    3694 </span>            :     //RS: if needed, attach temporary cluster array
<span class="lineNum">    3695 </span><span class="lineCov">        136 :     const AliTPCclusterMI** seedClustersSave = seed-&gt;GetClusters();</span>
<span class="lineNum">    3696 </span><span class="lineCov">        136 :     if (!seedClustersSave) { //RS: temporary attach clusters</span>
<span class="lineNum">    3697 </span><span class="lineCov">      43520 :       for (int ir=kMaxRow;ir--;) {</span>
<span class="lineNum">    3698 </span><span class="lineCov">      21624 :         int idx = seed-&gt;GetClusterIndex2(ir);</span>
<span class="lineNum">    3699 </span><span class="lineCov">      63404 :         seedClusters[ir] = idx&lt;0 ? 0 : GetClusterMI(idx);</span>
<span class="lineNum">    3700 </span>            :       }
<span class="lineNum">    3701 </span><span class="lineCov">        136 :       seed-&gt;SetClustersArrayTMP(seedClusters);</span>
<span class="lineNum">    3702 </span><span class="lineCov">        136 :     }</span>
<span class="lineNum">    3703 </span>            :     //
<span class="lineNum">    3704 </span>            :     //
<span class="lineNum">    3705 </span><span class="lineCov">        302 :     if (seed-&gt;GetNumberOfClusters()&lt;60 &amp;&amp; seed-&gt;GetNumberOfClusters()&lt;(esd-&gt;GetTPCclusters(0) -5)*0.8) {</span>
<span class="lineNum">    3706 </span><span class="lineCov">          2 :       AliExternalTrackParam paramIn;</span>
<span class="lineNum">    3707 </span><span class="lineCov">          2 :       AliExternalTrackParam paramOut;</span>
<span class="lineNum">    3708 </span>            :       //
<span class="lineNum">    3709 </span><span class="lineCov">          4 :       Int_t ncl = seed-&gt;RefitTrack(seed,&amp;paramIn,&amp;paramOut);</span>
<span class="lineNum">    3710 </span>            :       //
<span class="lineNum">    3711 </span><span class="lineCov">          2 :       if ((AliTPCReconstructor::StreamLevel() &amp; kStreamRecoverIn)&gt;0) {  // flag: stream track information for track  failing in RefitInward function and recovered back</span>
<span class="lineNum">    3712 </span><span class="lineNoCov">          0 :         (*fDebugStreamer)&lt;&lt;&quot;RecoverIn&quot;&lt;&lt; </span>
<span class="lineNum">    3713 </span><span class="lineNoCov">          0 :           &quot;seed.=&quot;&lt;&lt;seed&lt;&lt;</span>
<span class="lineNum">    3714 </span><span class="lineNoCov">          0 :           &quot;esd.=&quot;&lt;&lt;esd&lt;&lt;</span>
<span class="lineNum">    3715 </span><span class="lineNoCov">          0 :           &quot;pin.=&quot;&lt;&lt;&amp;paramIn&lt;&lt;</span>
<span class="lineNum">    3716 </span><span class="lineNoCov">          0 :           &quot;pout.=&quot;&lt;&lt;&amp;paramOut&lt;&lt;</span>
<span class="lineNum">    3717 </span><span class="lineNoCov">          0 :           &quot;ncl=&quot;&lt;&lt;ncl&lt;&lt;</span>
<span class="lineNum">    3718 </span>            :           &quot;\n&quot;;
<span class="lineNum">    3719 </span>            :       }
<span class="lineNum">    3720 </span><span class="lineCov">          2 :       if (ncl&gt;15) {</span>
<span class="lineNum">    3721 </span><span class="lineCov">          2 :         seed-&gt;Set(paramIn.GetX(),paramIn.GetAlpha(),paramIn.GetParameter(),paramIn.GetCovariance());</span>
<span class="lineNum">    3722 </span><span class="lineCov">          2 :         seed-&gt;SetNumberOfClusters(ncl);</span>
<span class="lineNum">    3723 </span><span class="lineCov">          2 :       }</span>
<span class="lineNum">    3724 </span><span class="lineCov">          2 :     }</span>
<span class="lineNum">    3725 </span>            : 
<span class="lineNum">    3726 </span><span class="lineCov">        136 :     seed-&gt;PropagateTo(fkParam-&gt;GetInnerRadiusLow());</span>
<span class="lineNum">    3727 </span><span class="lineCov">        136 :     seed-&gt;SetRow(0);</span>
<span class="lineNum">    3728 </span><span class="lineCov">        136 :     seed-&gt;UpdatePoints();</span>
<span class="lineNum">    3729 </span><span class="lineCov">        136 :     AddCovariance(seed);</span>
<span class="lineNum">    3730 </span><span class="lineCov">        136 :     MakeESDBitmaps(seed, esd);</span>
<span class="lineNum">    3731 </span><span class="lineCov">        136 :     seed-&gt;CookdEdx(0.02,0.6);</span>
<span class="lineNum">    3732 </span><span class="lineCov">        136 :     CookLabel(seed,0.1); //For comparison only</span>
<span class="lineNum">    3733 </span>            :     //
<span class="lineNum">    3734 </span><span class="lineCov">        136 :     if (((AliTPCReconstructor::StreamLevel()&amp;kStreamRefitInward)&gt;0) &amp;&amp; seed!=0) {</span>
<span class="lineNum">    3735 </span><span class="lineNoCov">          0 :       TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    3736 </span><span class="lineNoCov">          0 :       cstream&lt;&lt;&quot;RefitInward&quot;&lt;&lt;  // flag: stream track information in RefitInward function (after tracking Iteration 2)</span>
<span class="lineNum">    3737 </span><span class="lineNoCov">          0 :         &quot;Esd.=&quot;&lt;&lt;esd&lt;&lt;</span>
<span class="lineNum">    3738 </span><span class="lineNoCov">          0 :         &quot;Track.=&quot;&lt;&lt;seed&lt;&lt;</span>
<span class="lineNum">    3739 </span>            :         &quot;\n&quot;; 
<span class="lineNum">    3740 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3741 </span><span class="lineCov">        272 :     if (seed-&gt;GetNumberOfClusters()&gt;15) {</span>
<span class="lineNum">    3742 </span><span class="lineCov">        136 :       esd-&gt;UpdateTrackParams(seed,AliESDtrack::kTPCrefit); </span>
<span class="lineNum">    3743 </span><span class="lineCov">        136 :       esd-&gt;SetTPCPoints(seed-&gt;GetPoints());</span>
<span class="lineNum">    3744 </span><span class="lineCov">        136 :       esd-&gt;SetTPCPointsF(seed-&gt;GetNFoundable());</span>
<span class="lineNum">    3745 </span><span class="lineCov">        136 :       Int_t   ndedx = seed-&gt;GetNCDEDX(0);</span>
<span class="lineNum">    3746 </span><span class="lineCov">        136 :       Float_t sdedx = seed-&gt;GetSDEDX(0);</span>
<span class="lineNum">    3747 </span><span class="lineCov">        136 :       Float_t dedx  = seed-&gt;GetdEdx();</span>
<span class="lineNum">    3748 </span>            :       // apply mutliplicity dependent dEdx correction if available
<span class="lineNum">    3749 </span><span class="lineCov">        136 :       if (graphMultDependenceDeDx) {</span>
<span class="lineNum">    3750 </span><span class="lineNoCov">          0 :         Double_t corrGain =  AliTPCcalibDButil::EvalGraphConst(graphMultDependenceDeDx, nContribut);</span>
<span class="lineNum">    3751 </span><span class="lineNoCov">          0 :         dedx += (1 - corrGain)*50.; // MIP is normalized to 50</span>
<span class="lineNum">    3752 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3753 </span><span class="lineCov">        136 :       esd-&gt;SetTPCsignal(dedx, sdedx, ndedx);</span>
<span class="lineNum">    3754 </span>            :       //
<span class="lineNum">    3755 </span>            :       // fill new dEdx information
<span class="lineNum">    3756 </span>            :       //
<span class="lineNum">    3757 </span><span class="lineCov">        136 :       Double32_t signal[4]; </span>
<span class="lineNum">    3758 </span><span class="lineCov">        136 :       Double32_t signalMax[4]; </span>
<span class="lineNum">    3759 </span><span class="lineCov">        136 :       Char_t ncl[3]; </span>
<span class="lineNum">    3760 </span><span class="lineCov">        136 :       Char_t nrows[3];</span>
<span class="lineNum">    3761 </span>            :       //
<span class="lineNum">    3762 </span><span class="lineCov">       1088 :       for(Int_t iarr=0;iarr&lt;3;iarr++) {</span>
<span class="lineNum">    3763 </span><span class="lineCov">        408 :         signal[iarr] = seed-&gt;GetDEDXregion(iarr+1);</span>
<span class="lineNum">    3764 </span><span class="lineCov">        408 :         signalMax[iarr] = seed-&gt;GetDEDXregion(iarr+5);</span>
<span class="lineNum">    3765 </span><span class="lineCov">        408 :         ncl[iarr] = seed-&gt;GetNCDEDX(iarr+1);</span>
<span class="lineNum">    3766 </span><span class="lineCov">        408 :         nrows[iarr] = seed-&gt;GetNCDEDXInclThres(iarr+1);</span>
<span class="lineNum">    3767 </span>            :       }
<span class="lineNum">    3768 </span><span class="lineCov">        136 :       signal[3] = seed-&gt;GetDEDXregion(4);</span>
<span class="lineNum">    3769 </span><span class="lineCov">        136 :       signalMax[3] = seed-&gt;GetDEDXregion(8);</span>
<span class="lineNum">    3770 </span>            :       
<span class="lineNum">    3771 </span>            :       //
<span class="lineNum">    3772 </span><span class="lineCov">        272 :       AliTPCdEdxInfo * infoTpcPid = new AliTPCdEdxInfo();</span>
<span class="lineNum">    3773 </span><span class="lineCov">        136 :       infoTpcPid-&gt;SetTPCSignalRegionInfo(signal, ncl, nrows);</span>
<span class="lineNum">    3774 </span><span class="lineCov">        136 :       infoTpcPid-&gt;SetTPCSignalsQmax(signalMax);</span>
<span class="lineNum">    3775 </span><span class="lineCov">        136 :       esd-&gt;SetTPCdEdxInfo(infoTpcPid);</span>
<span class="lineNum">    3776 </span>            :       //
<span class="lineNum">    3777 </span>            :       // add seed to the esd track in Calib level
<span class="lineNum">    3778 </span>            :       //
<span class="lineNum">    3779 </span><span class="lineCov">        340 :       Bool_t storeFriend = seedsInFriendsNorm&gt;0 &amp;&amp; (!esd-&gt;GetFriendNotStored()) </span>
<span class="lineNum">    3780 </span><span class="lineCov">         68 :         &amp;&amp; seedsInFriends&lt;(kMaxFriendTracks-1) </span>
<span class="lineNum">    3781 </span><span class="lineCov">        136 :         &amp;&amp; gRandom-&gt;Rndm()&lt;(kMaxFriendTracks)/Float_t(seedsInFriendsNorm);</span>
<span class="lineNum">    3782 </span>            :       //      if (AliTPCReconstructor::StreamLevel()&gt;0 &amp;&amp;storeFriend){
<span class="lineNum">    3783 </span>            :       //AliInfoF(&quot;Store: %d Stored %d / %d FrOff: %d&quot;,storeFriend,seedsInFriends,seedsInFriendsNorm,esd-&gt;GetFriendNotStored());
<span class="lineNum">    3784 </span><span class="lineCov">        136 :       if (storeFriend){ // RS: seed is needed for calibration, regardless on streamlevel</span>
<span class="lineNum">    3785 </span><span class="lineCov">         68 :         seedsInFriends++;</span>
<span class="lineNum">    3786 </span>            :         // RS: this is the only place where the seed is created not in the pool, 
<span class="lineNum">    3787 </span>            :         // since it should belong to ESDevent
<span class="lineNum">    3788 </span>            :         //AliTPCseed * seedCopy = new AliTPCseed(*seed, kTRUE); 
<span class="lineNum">    3789 </span>            :         //esd-&gt;AddCalibObject(seedCopy);
<span class="lineNum">    3790 </span>            :         //
<span class="lineNum">    3791 </span>            :         //RS to avoid the cloning the seeds and clusters we will declare the seed to own its
<span class="lineNum">    3792 </span>            :         // clusters and reattach the clusters pointers from the pool, so they are saved in the friends
<span class="lineNum">    3793 </span><span class="lineCov">         68 :         seed-&gt;SetClusterOwner(kTRUE);</span>
<span class="lineNum">    3794 </span><span class="lineCov">         68 :         memcpy(fClPointersPoolPtr,seedClusters,kMaxRow*sizeof(AliTPCclusterMI*));</span>
<span class="lineNum">    3795 </span><span class="lineCov">         68 :         seed-&gt;SetClustersArrayTMP(fClPointersPoolPtr);</span>
<span class="lineNum">    3796 </span><span class="lineCov">         68 :         esd-&gt;AddCalibObject(seed);</span>
<span class="lineNum">    3797 </span><span class="lineCov">         68 :         fClPointersPoolPtr += kMaxRow;</span>
<span class="lineNum">    3798 </span><span class="lineCov">         68 :       }</span>
<span class="lineNum">    3799 </span><span class="lineCov">         68 :       else seed-&gt;SetClustersArrayTMP((AliTPCclusterMI**)seedClustersSave);</span>
<span class="lineNum">    3800 </span>            :       //
<span class="lineNum">    3801 </span><span class="lineCov">        136 :       ntracks++;</span>
<span class="lineNum">    3802 </span><span class="lineCov">        136 :     }</span>
<span class="lineNum">    3803 </span>            :     else{
<span class="lineNum">    3804 </span>            :       //printf(&quot;problem\n&quot;);
<span class="lineNum">    3805 </span>            :     }
<span class="lineNum">    3806 </span>            :     //
<span class="lineNum">    3807 </span>            :     //RS if seed does not own clusters, then it was not added to friends: detach temporary clusters !!!
<span class="lineNum">    3808 </span><span class="lineCov">        340 :     if (!seedClustersSave &amp;&amp; !seed-&gt;GetClusterOwner()) seed-&gt;SetClustersArrayTMP(0); </span>
<span class="lineNum">    3809 </span>            :     //
<span class="lineNum">    3810 </span><span class="lineCov">        136 :   }</span>
<span class="lineNum">    3811 </span>            :   //FindKinks(fSeeds,event);
<span class="lineNum">    3812 </span><span class="lineCov">          8 :   if ((AliTPCReconstructor::StreamLevel()&amp;kStreamClDump)&gt;0)  DumpClusters(2,fSeeds);  // dump clusters at the end of process (signed with useage flags)</span>
<span class="lineNum">    3813 </span><span class="lineCov">          8 :   Info(&quot;RefitInward&quot;,&quot;Number of refitted tracks %d&quot;,ntracks);</span>
<span class="lineNum">    3814 </span>            : 
<span class="lineNum">    3815 </span><span class="lineCov">          8 :   AliCosmicTracker::FindCosmic(event, kTRUE);</span>
<span class="lineNum">    3816 </span>            : 
<span class="lineNum">    3817 </span><span class="lineCov">          8 :   FillClusterOccupancyInfo();</span>
<span class="lineNum">    3818 </span>            : 
<span class="lineNum">    3819 </span>            :   return 0;
<span class="lineNum">    3820 </span><span class="lineCov">         16 : }</span>
<a name="3821"><span class="lineNum">    3821 </span>            : </a>
<span class="lineNum">    3822 </span>            : 
<span class="lineNum">    3823 </span>            : Int_t AliTPCtracker::PropagateBack(AliESDEvent *event)
<span class="lineNum">    3824 </span>            : {
<span class="lineNum">    3825 </span>            :   //
<span class="lineNum">    3826 </span>            :   // back propagation of ESD tracks
<span class="lineNum">    3827 </span>            :   //
<span class="lineNum">    3828 </span><span class="lineCov">         16 :   if (!event) return 0;</span>
<span class="lineNum">    3829 </span><span class="lineCov">          8 :   fEvent = event;</span>
<span class="lineNum">    3830 </span><span class="lineCov">          8 :   fEventHLT = 0;</span>
<span class="lineNum">    3831 </span><span class="lineCov">          8 :   fIteration = 1;</span>
<span class="lineNum">    3832 </span><span class="lineCov">          8 :   ReadSeeds(event,1);</span>
<span class="lineNum">    3833 </span><span class="lineCov">          8 :   PropagateBack(fSeeds); </span>
<span class="lineNum">    3834 </span><span class="lineCov">          8 :   RemoveUsed2(fSeeds,0.4,0.4,20);</span>
<span class="lineNum">    3835 </span>            :   //FindCurling(fSeeds, fEvent,1);  
<span class="lineNum">    3836 </span><span class="lineCov">          8 :   FindSplitted(fSeeds, event,1); // find multi found tracks</span>
<span class="lineNum">    3837 </span><span class="lineCov">          8 :   if ((AliTPCReconstructor::StreamLevel()&amp;kStreamFindMultiMC)&gt;0)  FindMultiMC(fSeeds, fEvent,1); // find multi found tracks</span>
<span class="lineNum">    3838 </span>            :   //
<span class="lineNum">    3839 </span>            :   // RS: the cluster pointers are not permanently attached to the seed during the tracking, need to attach temporarily
<span class="lineNum">    3840 </span><span class="lineCov">          8 :   AliTPCclusterMI* seedClusters[kMaxRow];</span>
<span class="lineNum">    3841 </span>            :   //
<span class="lineNum">    3842 </span><span class="lineCov">          8 :   Int_t nseed = fSeeds-&gt;GetEntriesFast();</span>
<span class="lineNum">    3843 </span>            :   Int_t ntracks=0;
<span class="lineNum">    3844 </span><span class="lineCov">        288 :   for (Int_t i=0;i&lt;nseed;i++){</span>
<span class="lineNum">    3845 </span><span class="lineCov">        136 :     AliTPCseed * seed = (AliTPCseed*) fSeeds-&gt;UncheckedAt(i);</span>
<span class="lineNum">    3846 </span><span class="lineCov">        138 :     if (!seed) continue;</span>
<span class="lineNum">    3847 </span><span class="lineCov">        134 :     AliESDtrack *esd=event-&gt;GetTrack(i);</span>
<span class="lineNum">    3848 </span><span class="lineCov">        134 :     if (!esd) continue; //never happen</span>
<span class="lineNum">    3849 </span>            :     //
<span class="lineNum">    3850 </span>            :     //RS: if needed, attach temporary cluster array
<span class="lineNum">    3851 </span><span class="lineCov">        134 :     const AliTPCclusterMI** seedClustersSave = seed-&gt;GetClusters();</span>
<span class="lineNum">    3852 </span><span class="lineCov">        134 :     if (!seedClustersSave) { //RS: temporary attach clusters</span>
<span class="lineNum">    3853 </span><span class="lineCov">      42880 :       for (int ir=kMaxRow;ir--;) {</span>
<span class="lineNum">    3854 </span><span class="lineCov">      21306 :         int idx = seed-&gt;GetClusterIndex2(ir);</span>
<span class="lineNum">    3855 </span><span class="lineCov">      59486 :         seedClusters[ir] = idx&lt;0 ? 0 : GetClusterMI(idx);</span>
<span class="lineNum">    3856 </span>            :       }
<span class="lineNum">    3857 </span><span class="lineCov">        134 :       seed-&gt;SetClustersArrayTMP(seedClusters);</span>
<span class="lineNum">    3858 </span><span class="lineCov">        134 :     }</span>
<span class="lineNum">    3859 </span>            :     //
<span class="lineNum">    3860 </span><span class="lineCov">        138 :     if (seed-&gt;GetKinkIndex(0)&lt;0)  UpdateKinkQualityM(seed);  // update quality informations for kinks</span>
<span class="lineNum">    3861 </span><span class="lineCov">        134 :     seed-&gt;UpdatePoints();</span>
<span class="lineNum">    3862 </span><span class="lineCov">        134 :     AddCovariance(seed);</span>
<span class="lineNum">    3863 </span><span class="lineCov">        142 :     if (seed-&gt;GetNumberOfClusters()&lt;60 &amp;&amp; seed-&gt;GetNumberOfClusters()&lt;(esd-&gt;GetTPCclusters(0) -5)*0.8){</span>
<span class="lineNum">    3864 </span><span class="lineNoCov">          0 :       AliExternalTrackParam paramIn;</span>
<span class="lineNum">    3865 </span><span class="lineNoCov">          0 :       AliExternalTrackParam paramOut;</span>
<span class="lineNum">    3866 </span><span class="lineNoCov">          0 :       Int_t ncl = seed-&gt;RefitTrack(seed,&amp;paramIn,&amp;paramOut);</span>
<span class="lineNum">    3867 </span><span class="lineNoCov">          0 :       if ((AliTPCReconstructor::StreamLevel()&amp;kStreamRecoverBack)&gt;0) { // flag: stream track information for track  faling PropagateBack function and recovered back (RefitTrack)</span>
<span class="lineNum">    3868 </span><span class="lineNoCov">          0 :         (*fDebugStreamer)&lt;&lt;&quot;RecoverBack&quot;&lt;&lt;</span>
<span class="lineNum">    3869 </span><span class="lineNoCov">          0 :           &quot;seed.=&quot;&lt;&lt;seed&lt;&lt;</span>
<span class="lineNum">    3870 </span><span class="lineNoCov">          0 :           &quot;esd.=&quot;&lt;&lt;esd&lt;&lt;</span>
<span class="lineNum">    3871 </span><span class="lineNoCov">          0 :           &quot;pin.=&quot;&lt;&lt;&amp;paramIn&lt;&lt;</span>
<span class="lineNum">    3872 </span><span class="lineNoCov">          0 :           &quot;pout.=&quot;&lt;&lt;&amp;paramOut&lt;&lt;</span>
<span class="lineNum">    3873 </span><span class="lineNoCov">          0 :           &quot;ncl=&quot;&lt;&lt;ncl&lt;&lt;</span>
<span class="lineNum">    3874 </span>            :           &quot;\n&quot;;
<span class="lineNum">    3875 </span>            :       }
<span class="lineNum">    3876 </span><span class="lineNoCov">          0 :       if (ncl&gt;15) {</span>
<span class="lineNum">    3877 </span><span class="lineNoCov">          0 :         seed-&gt;Set(paramOut.GetX(),paramOut.GetAlpha(),paramOut.GetParameter(),paramOut.GetCovariance());</span>
<span class="lineNum">    3878 </span><span class="lineNoCov">          0 :         seed-&gt;SetNumberOfClusters(ncl);</span>
<span class="lineNum">    3879 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3880 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3881 </span><span class="lineCov">        134 :     seed-&gt;CookdEdx(0.02,0.6);</span>
<span class="lineNum">    3882 </span><span class="lineCov">        134 :     CookLabel(seed,0.1); //For comparison only</span>
<span class="lineNum">    3883 </span><span class="lineCov">        134 :     if (seed-&gt;GetNumberOfClusters()&gt;15){</span>
<span class="lineNum">    3884 </span><span class="lineCov">        134 :       esd-&gt;UpdateTrackParams(seed,AliESDtrack::kTPCout);</span>
<span class="lineNum">    3885 </span><span class="lineCov">        134 :       esd-&gt;SetTPCPoints(seed-&gt;GetPoints());</span>
<span class="lineNum">    3886 </span><span class="lineCov">        134 :       esd-&gt;SetTPCPointsF(seed-&gt;GetNFoundable());</span>
<span class="lineNum">    3887 </span><span class="lineCov">        134 :       Int_t   ndedx = seed-&gt;GetNCDEDX(0);</span>
<span class="lineNum">    3888 </span><span class="lineCov">        134 :       Float_t sdedx = seed-&gt;GetSDEDX(0);</span>
<span class="lineNum">    3889 </span><span class="lineCov">        134 :       Float_t dedx  = seed-&gt;GetdEdx();</span>
<span class="lineNum">    3890 </span><span class="lineCov">        134 :       esd-&gt;SetTPCsignal(dedx, sdedx, ndedx);</span>
<span class="lineNum">    3891 </span><span class="lineCov">        134 :       ntracks++;</span>
<span class="lineNum">    3892 </span><span class="lineCov">        134 :       Int_t eventnumber = event-&gt;GetEventNumberInFile();// patch 28 fev 06</span>
<span class="lineNum">    3893 </span>            :       // This is most likely NOT the event number you'd like to use. It has nothing to do with the 'real' event number      
<span class="lineNum">    3894 </span><span class="lineCov">        134 :       if (((AliTPCReconstructor::StreamLevel()&amp;kStreamCPropagateBack)&gt;0) &amp;&amp; esd) {</span>
<span class="lineNum">    3895 </span><span class="lineNoCov">          0 :         (*fDebugStreamer)&lt;&lt;&quot;PropagateBack&quot;&lt;&lt;  // flag: stream track information in PropagateBack function (after tracking Iteration 1)</span>
<span class="lineNum">    3896 </span><span class="lineNoCov">          0 :           &quot;Tr0.=&quot;&lt;&lt;seed&lt;&lt;</span>
<span class="lineNum">    3897 </span><span class="lineNoCov">          0 :           &quot;esd.=&quot;&lt;&lt;esd&lt;&lt;</span>
<span class="lineNum">    3898 </span><span class="lineNoCov">          0 :           &quot;EventNrInFile=&quot;&lt;&lt;eventnumber&lt;&lt;</span>
<span class="lineNum">    3899 </span>            :           &quot;\n&quot;;       
<span class="lineNum">    3900 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    3901 </span><span class="lineCov">        134 :     }</span>
<span class="lineNum">    3902 </span>            :     //
<span class="lineNum">    3903 </span><span class="lineCov">        268 :     if (!seedClustersSave) seed-&gt;SetClustersArrayTMP(0); //RS detach temporary clusters !!!</span>
<span class="lineNum">    3904 </span>            :     //
<span class="lineNum">    3905 </span><span class="lineCov">        134 :   }</span>
<span class="lineNum">    3906 </span><span class="lineCov">          8 :   if (AliTPCReconstructor::StreamLevel()&amp;kStreamClDump)  DumpClusters(1,fSeeds); // flag:stream clusters at the end of process (signed with usage flag)</span>
<span class="lineNum">    3907 </span>            :   //FindKinks(fSeeds,event);
<span class="lineNum">    3908 </span><span class="lineCov">          8 :   Info(&quot;PropagateBack&quot;,&quot;Number of back propagated tracks %d&quot;,ntracks);</span>
<span class="lineNum">    3909 </span><span class="lineCov">          8 :   fEvent =0;</span>
<span class="lineNum">    3910 </span><span class="lineCov">          8 :   fEventHLT = 0;</span>
<span class="lineNum">    3911 </span>            : 
<span class="lineNum">    3912 </span>            :   return 0;
<span class="lineNum">    3913 </span><span class="lineCov">         16 : }</span>
<a name="3914"><span class="lineNum">    3914 </span>            : </a>
<span class="lineNum">    3915 </span>            : 
<span class="lineNum">    3916 </span>            : Int_t AliTPCtracker::PostProcess(AliESDEvent *event)
<span class="lineNum">    3917 </span>            : {
<span class="lineNum">    3918 </span>            :   //
<span class="lineNum">    3919 </span>            :   // Post process events 
<span class="lineNum">    3920 </span>            :   //
<span class="lineNum">    3921 </span><span class="lineCov">         16 :   if (!event) return 0;</span>
<span class="lineNum">    3922 </span>            : 
<span class="lineNum">    3923 </span>            :   //
<span class="lineNum">    3924 </span>            :   // Set TPC event status
<span class="lineNum">    3925 </span>            :   // 
<span class="lineNum">    3926 </span>            : 
<span class="lineNum">    3927 </span>            :   // event affected by HV dip
<span class="lineNum">    3928 </span>            :   // reset TPC status
<span class="lineNum">    3929 </span><span class="lineCov">          8 :   if(IsTPCHVDipEvent(event)) { </span>
<span class="lineNum">    3930 </span><span class="lineNoCov">          0 :     event-&gt;ResetDetectorStatus(AliDAQ::kTPC);</span>
<span class="lineNum">    3931 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    3932 </span>            :  
<span class="lineNum">    3933 </span>            :   //printf(&quot;Status %d \n&quot;, event-&gt;IsDetectorOn(AliDAQ::kTPC));
<span class="lineNum">    3934 </span>            : 
<span class="lineNum">    3935 </span><span class="lineCov">          8 :   return 0;</span>
<span class="lineNum">    3936 </span><span class="lineCov">          8 : }</span>
<a name="3937"><span class="lineNum">    3937 </span>            : </a>
<span class="lineNum">    3938 </span>            : 
<span class="lineNum">    3939 </span>            :  void AliTPCtracker::DeleteSeeds()
<span class="lineNum">    3940 </span>            : {
<span class="lineNum">    3941 </span>            :   //
<span class="lineNum">    3942 </span><span class="lineCov">         44 :   fSeeds-&gt;Clear();</span>
<span class="lineNum">    3943 </span><span class="lineCov">         22 :   ResetSeedsPool();</span>
<span class="lineNum">    3944 </span>            :   //  delete fSeeds; // RS avoid unnecessary deletes
<span class="lineNum">    3945 </span>            :   // fSeeds =0;
<a name="3946"><span class="lineNum">    3946 </span><span class="lineCov">         22 : }</span></a>
<span class="lineNum">    3947 </span>            : 
<span class="lineNum">    3948 </span>            : void AliTPCtracker::ReadSeeds(const AliESDEvent *const event, Int_t direction)
<span class="lineNum">    3949 </span>            : {
<span class="lineNum">    3950 </span>            :   //
<span class="lineNum">    3951 </span>            :   //read seeds from the event
<span class="lineNum">    3952 </span>            :   
<span class="lineNum">    3953 </span><span class="lineCov">         32 :   Int_t nentr=event-&gt;GetNumberOfTracks();</span>
<span class="lineNum">    3954 </span><span class="lineCov">         16 :   if (fDebug&gt;0){</span>
<span class="lineNum">    3955 </span><span class="lineNoCov">          0 :     Info(&quot;ReadSeeds&quot;, &quot;Number of ESD tracks: %d\n&quot;, nentr);</span>
<span class="lineNum">    3956 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    3957 </span><span class="lineCov">         16 :   if (fSeeds) </span>
<span class="lineNum">    3958 </span><span class="lineCov">         16 :     DeleteSeeds();</span>
<span class="lineNum">    3959 </span><span class="lineCov">         16 :   if (!fSeeds) fSeeds = new TObjArray(nentr);</span>
<span class="lineNum">    3960 </span><span class="lineCov">         24 :   else if (fSeeds-&gt;GetSize()&lt;nentr) fSeeds-&gt;Expand(nentr);  //RS reuse array</span>
<span class="lineNum">    3961 </span>            :   //
<span class="lineNum">    3962 </span><span class="lineCov">         16 :   UnsignClusters();</span>
<span class="lineNum">    3963 </span>            :   //  Int_t ntrk=0;  
<span class="lineNum">    3964 </span><span class="lineCov">        640 :   for (Int_t i=0; i&lt;nentr; i++) {</span>
<span class="lineNum">    3965 </span><span class="lineCov">        304 :     AliESDtrack *esd=event-&gt;GetTrack(i);</span>
<span class="lineNum">    3966 </span><span class="lineCov">        304 :     ULong_t status=esd-&gt;GetStatus();</span>
<span class="lineNum">    3967 </span><span class="lineCov">        336 :     if (!(status&amp;AliESDtrack::kTPCin)) continue;</span>
<span class="lineNum">    3968 </span><span class="lineCov">        272 :     AliTPCtrack t(*esd);</span>
<span class="lineNum">    3969 </span><span class="lineCov">        272 :     t.SetNumberOfClusters(0);</span>
<span class="lineNum">    3970 </span>            :     //    AliTPCseed *seed = new AliTPCseed(t,t.GetAlpha());
<span class="lineNum">    3971 </span><span class="lineCov">        816 :     AliTPCseed *seed = new( NextFreeSeed() ) AliTPCseed(t/*,t.GetAlpha()*/);</span>
<span class="lineNum">    3972 </span><span class="lineCov">        272 :     seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    3973 </span><span class="lineCov">        544 :     seed-&gt;SetUniqueID(esd-&gt;GetID());</span>
<span class="lineNum">    3974 </span><span class="lineCov">        272 :     AddCovariance(seed);   //add systematic ucertainty</span>
<span class="lineNum">    3975 </span><span class="lineCov">       2176 :     for (Int_t ikink=0;ikink&lt;3;ikink++) {</span>
<span class="lineNum">    3976 </span><span class="lineCov">        816 :       Int_t index = esd-&gt;GetKinkIndex(ikink);</span>
<span class="lineNum">    3977 </span><span class="lineCov">        816 :       seed-&gt;GetKinkIndexes()[ikink] = index;</span>
<span class="lineNum">    3978 </span><span class="lineCov">       1616 :       if (index==0) continue;</span>
<span class="lineNum">    3979 </span><span class="lineCov">         16 :       index = TMath::Abs(index);</span>
<span class="lineNum">    3980 </span><span class="lineCov">         16 :       AliESDkink * kink = fEvent-&gt;GetKink(index-1);</span>
<span class="lineNum">    3981 </span><span class="lineCov">         48 :       if (kink&amp;&amp;esd-&gt;GetKinkIndex(ikink)&lt;0){</span>
<span class="lineNum">    3982 </span><span class="lineCov">          8 :         if ((status &amp; AliESDtrack::kTRDrefit) != 0) kink-&gt;SetStatus(1,2);</span>
<span class="lineNum">    3983 </span><span class="lineCov">          8 :         if ((status &amp; AliESDtrack::kITSout) != 0)   kink-&gt;SetStatus(1,0);</span>
<span class="lineNum">    3984 </span>            :       }
<span class="lineNum">    3985 </span><span class="lineCov">         48 :       if (kink&amp;&amp;esd-&gt;GetKinkIndex(ikink)&gt;0){</span>
<span class="lineNum">    3986 </span><span class="lineCov">          8 :         if ((status &amp; AliESDtrack::kTRDrefit) != 0) kink-&gt;SetStatus(1,6);</span>
<span class="lineNum">    3987 </span><span class="lineCov">          8 :         if ((status &amp; AliESDtrack::kITSout) != 0)   kink-&gt;SetStatus(1,4);</span>
<span class="lineNum">    3988 </span>            :       }
<span class="lineNum">    3989 </span>            : 
<span class="lineNum">    3990 </span><span class="lineCov">         16 :     }</span>
<span class="lineNum">    3991 </span>            :     // RS: resetting is done in the AliTPCtrack constructor 
<span class="lineNum">    3992 </span>            :     // if (((status&amp;AliESDtrack::kITSout)==0)&amp;&amp;(direction==1)) seed-&gt;ResetCovariance(10.); 
<span class="lineNum">    3993 </span>            :     // if ( direction ==2 &amp;&amp;(status &amp; AliESDtrack::kTRDrefit) == 0 ) seed-&gt;ResetCovariance(10.);
<span class="lineNum">    3994 </span>            :     //if ( direction ==2 &amp;&amp; ((status &amp; AliESDtrack::kTPCout) == 0) ) {
<span class="lineNum">    3995 </span>            :     //  fSeeds-&gt;AddAt(0,i);
<span class="lineNum">    3996 </span>            :     //  MarkSeedFree( seed );
<span class="lineNum">    3997 </span>            :     //  continue;    
<span class="lineNum">    3998 </span>            :     //}
<span class="lineNum">    3999 </span>            :     
<span class="lineNum">    4000 </span>            :     //
<span class="lineNum">    4001 </span>            :     //
<span class="lineNum">    4002 </span>            :     // rotate to the local coordinate system
<span class="lineNum">    4003 </span>            :     //   
<span class="lineNum">    4004 </span><span class="lineCov">        272 :     fSectors=fInnerSec; fN=fkNIS;    </span>
<span class="lineNum">    4005 </span><span class="lineCov">        272 :     Double_t alpha=seed-&gt;GetAlpha();</span>
<span class="lineNum">    4006 </span><span class="lineCov">        272 :     if (alpha &gt; 2.*TMath::Pi()) alpha -= 2.*TMath::Pi();</span>
<span class="lineNum">    4007 </span><span class="lineCov">        370 :     if (alpha &lt; 0.            ) alpha += 2.*TMath::Pi();</span>
<span class="lineNum">    4008 </span><span class="lineCov">        272 :     Int_t ns=Int_t(alpha/fSectors-&gt;GetAlpha()+0.0001)%fN;</span>
<span class="lineNum">    4009 </span><span class="lineCov">        272 :     alpha =ns*fSectors-&gt;GetAlpha() + fSectors-&gt;GetAlphaShift();</span>
<span class="lineNum">    4010 </span><span class="lineCov">        544 :     alpha-=seed-&gt;GetAlpha();  </span>
<span class="lineNum">    4011 </span><span class="lineCov">        272 :     if (alpha&lt;-TMath::Pi()) alpha += 2*TMath::Pi();</span>
<span class="lineNum">    4012 </span><span class="lineCov">        370 :     if (alpha&gt;=TMath::Pi()) alpha -= 2*TMath::Pi();</span>
<span class="lineNum">    4013 </span><span class="lineCov">        272 :     if (TMath::Abs(alpha) &gt; 0.001) { // This should not happen normally</span>
<span class="lineNum">    4014 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot;Rotating track over %f&quot;,alpha));</span>
<span class="lineNum">    4015 </span><span class="lineNoCov">          0 :       if (!seed-&gt;Rotate(alpha)) {</span>
<span class="lineNum">    4016 </span><span class="lineNoCov">          0 :         MarkSeedFree( seed );</span>
<span class="lineNum">    4017 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    4018 </span>            :       }
<span class="lineNum">    4019 </span>            :     }
<span class="lineNum">    4020 </span><span class="lineCov">        272 :     seed-&gt;SetESD(esd);</span>
<span class="lineNum">    4021 </span>            :     // sign clusters
<span class="lineNum">    4022 </span><span class="lineCov">        544 :     if (esd-&gt;GetKinkIndex(0)&lt;=0){</span>
<span class="lineNum">    4023 </span><span class="lineCov">      84480 :       for (Int_t irow=0;irow&lt;kMaxRow;irow++){</span>
<span class="lineNum">    4024 </span><span class="lineCov">      41976 :         Int_t index = seed-&gt;GetClusterIndex2(irow);    </span>
<span class="lineNum">    4025 </span><span class="lineCov">      41976 :         if (index &gt;= 0){ </span>
<span class="lineNum">    4026 </span>            :           //
<span class="lineNum">    4027 </span><span class="lineCov">      33148 :           AliTPCclusterMI * cl = GetClusterMI(index);</span>
<span class="lineNum">    4028 </span>            :           //RS seed-&gt;SetClusterPointer(irow,cl);
<span class="lineNum">    4029 </span><span class="lineCov">      33148 :           if (cl){</span>
<span class="lineNum">    4030 </span><span class="lineCov">      66296 :             if ((index &amp; 0x8000)==0){</span>
<span class="lineNum">    4031 </span><span class="lineCov">      65336 :               cl-&gt;Use(10);  // accepted cluster        </span>
<span class="lineNum">    4032 </span>            :             }else{
<span class="lineNum">    4033 </span><span class="lineCov">        960 :               cl-&gt;Use(6);   // close cluster not accepted</span>
<span class="lineNum">    4034 </span>            :             }   
<span class="lineNum">    4035 </span>            :           }else{
<span class="lineNum">    4036 </span><span class="lineNoCov">          0 :             Info(&quot;ReadSeeds&quot;,&quot;Not found cluster&quot;);</span>
<span class="lineNum">    4037 </span>            :           }
<span class="lineNum">    4038 </span><span class="lineCov">      33148 :         }</span>
<span class="lineNum">    4039 </span>            :       }
<span class="lineNum">    4040 </span><span class="lineCov">        264 :     }</span>
<span class="lineNum">    4041 </span><span class="lineCov">        272 :     fSeeds-&gt;AddAt(seed,i);</span>
<span class="lineNum">    4042 </span><span class="lineCov">        544 :   }</span>
<span class="lineNum">    4043 </span><span class="lineCov">         16 : }</span>
<a name="4044"><span class="lineNum">    4044 </span>            : </a>
<span class="lineNum">    4045 </span>            : //_____________________________________________________________________________
<span class="lineNum">    4046 </span>            : void AliTPCtracker::MakeSeeds3(TObjArray * arr, Int_t sec, Int_t i1, Int_t i2,  Float_t cuts[4],
<span class="lineNum">    4047 </span>            :                                  Float_t deltay, Int_t ddsec) {
<span class="lineNum">    4048 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4049 </span>            :   // This function creates track seeds.
<span class="lineNum">    4050 </span>            :   // SEEDING WITH VERTEX CONSTRAIN 
<span class="lineNum">    4051 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4052 </span>            :   // cuts[0]   - fP4 cut
<span class="lineNum">    4053 </span>            :   // cuts[1]   - tan(phi)  cut
<span class="lineNum">    4054 </span>            :   // cuts[2]   - zvertex cut
<span class="lineNum">    4055 </span>            :   // cuts[3]   - fP3 cut
<span class="lineNum">    4056 </span>            : 
<span class="lineNum">    4057 </span>            :   const double kRoadY = 1., kRoadZ = 0.6;
<span class="lineNum">    4058 </span>            : 
<span class="lineNum">    4059 </span>            :   Int_t nin0  = 0;
<span class="lineNum">    4060 </span>            :   Int_t nin1  = 0;
<span class="lineNum">    4061 </span>            :   Int_t nin2  = 0;
<span class="lineNum">    4062 </span>            :   Int_t nin   = 0;
<span class="lineNum">    4063 </span>            :   Int_t nout1 = 0;
<span class="lineNum">    4064 </span>            :   Int_t nout2 = 0;
<span class="lineNum">    4065 </span>            : 
<span class="lineNum">    4066 </span><span class="lineCov">      12384 :   Double_t x[5], c[15];</span>
<span class="lineNum">    4067 </span>            :   //  Int_t di = i1-i2;
<span class="lineNum">    4068 </span>            :   //
<span class="lineNum">    4069 </span><span class="lineCov">       6192 :   AliTPCseed * seed = new( NextFreeSeed() ) AliTPCseed();</span>
<span class="lineNum">    4070 </span><span class="lineCov">       6192 :   seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    4071 </span><span class="lineCov">       6192 :   Double_t alpha=fSectors-&gt;GetAlpha(), shift=fSectors-&gt;GetAlphaShift();</span>
<span class="lineNum">    4072 </span><span class="lineCov">       6192 :   Double_t cs=cos(alpha), sn=sin(alpha);</span>
<span class="lineNum">    4073 </span>            :   //
<span class="lineNum">    4074 </span>            :   //  Double_t x1 =fOuterSec-&gt;GetX(i1);
<span class="lineNum">    4075 </span>            :   //Double_t xx2=fOuterSec-&gt;GetX(i2);
<span class="lineNum">    4076 </span>            :   
<span class="lineNum">    4077 </span><span class="lineCov">       6192 :   Double_t x1 =GetXrow(i1);</span>
<span class="lineNum">    4078 </span><span class="lineCov">       6192 :   Double_t xx2=GetXrow(i2);</span>
<span class="lineNum">    4079 </span>            : 
<span class="lineNum">    4080 </span><span class="lineCov">       6192 :   Double_t x3=GetX(), y3=GetY(), z3=GetZ();</span>
<span class="lineNum">    4081 </span>            : 
<span class="lineNum">    4082 </span><span class="lineCov">       6192 :   Int_t imiddle = (i2+i1)/2;    //middle pad row index</span>
<span class="lineNum">    4083 </span><span class="lineCov">       6192 :   Double_t xm = GetXrow(imiddle); // radius of middle pad-row</span>
<span class="lineNum">    4084 </span><span class="lineCov">       6192 :   const AliTPCtrackerRow&amp; krm=GetRow(sec,imiddle); //middle pad -row</span>
<span class="lineNum">    4085 </span>            :   //
<span class="lineNum">    4086 </span>            :   Int_t ns =sec;   
<span class="lineNum">    4087 </span>            : 
<span class="lineNum">    4088 </span><span class="lineCov">       6192 :   const AliTPCtrackerRow&amp; kr1=GetRow(ns,i1);</span>
<span class="lineNum">    4089 </span><span class="lineCov">       6192 :   Double_t ymax  = GetMaxY(i1)-kr1.GetDeadZone()-1.5;  </span>
<span class="lineNum">    4090 </span><span class="lineCov">       6192 :   Double_t ymaxm = GetMaxY(imiddle)-kr1.GetDeadZone()-1.5;  </span>
<span class="lineNum">    4091 </span>            : 
<span class="lineNum">    4092 </span>            :   //
<span class="lineNum">    4093 </span>            :   // change cut on curvature if it can't reach this layer
<span class="lineNum">    4094 </span>            :   // maximal curvature set to reach it
<span class="lineNum">    4095 </span><span class="lineCov">       6192 :   Double_t dvertexmax  = TMath::Sqrt((x1-x3)*(x1-x3)+(ymax+5-y3)*(ymax+5-y3));</span>
<span class="lineNum">    4096 </span><span class="lineCov">       6192 :   if (dvertexmax*0.5*cuts[0]&gt;0.85){</span>
<span class="lineNum">    4097 </span><span class="lineCov">          8 :     cuts[0] = 0.85/(dvertexmax*0.5+1.);</span>
<span class="lineNum">    4098 </span><span class="lineCov">          8 :   }</span>
<span class="lineNum">    4099 </span><span class="lineCov">       6192 :   Double_t r2min = 1/(cuts[0]*cuts[0]);  //minimal square of radius given by cut</span>
<span class="lineNum">    4100 </span>            : 
<span class="lineNum">    4101 </span>            :   //  Int_t ddsec = 1;
<span class="lineNum">    4102 </span><span class="lineCov">       6192 :   if (deltay&gt;0) ddsec = 0; </span>
<span class="lineNum">    4103 </span>            :   // loop over clusters  
<span class="lineNum">    4104 </span><span class="lineCov">      32836 :   for (Int_t is=0; is &lt; kr1; is++) {</span>
<span class="lineNum">    4105 </span>            :     //
<span class="lineNum">    4106 </span><span class="lineCov">      10226 :     if (kr1[is]-&gt;IsUsed(10)) continue;</span>
<span class="lineNum">    4107 </span><span class="lineCov">       6708 :     if (kr1[is]-&gt;IsDisabled()) {</span>
<span class="lineNum">    4108 </span>            :       continue;
<span class="lineNum">    4109 </span>            :     }
<span class="lineNum">    4110 </span>            : 
<span class="lineNum">    4111 </span><span class="lineCov">       6708 :     Double_t y1=kr1[is]-&gt;GetY(), z1=kr1[is]-&gt;GetZ();    </span>
<span class="lineNum">    4112 </span>            :     //if (TMath::Abs(y1)&gt;ymax) continue;
<span class="lineNum">    4113 </span>            : 
<span class="lineNum">    4114 </span><span class="lineCov">       6708 :     if (deltay&gt;0 &amp;&amp; TMath::Abs(ymax-TMath::Abs(y1))&gt; deltay ) continue;  // seed only at the edge</span>
<span class="lineNum">    4115 </span>            : 
<span class="lineNum">    4116 </span>            :     // find possible directions    
<span class="lineNum">    4117 </span><span class="lineCov">       6708 :     Float_t anglez = (z1-z3)/(x1-x3); </span>
<span class="lineNum">    4118 </span><span class="lineCov">       6708 :     Float_t extraz = z1 - anglez*(x1-xx2);  // extrapolated z      </span>
<span class="lineNum">    4119 </span>            :     //
<span class="lineNum">    4120 </span>            :     //
<span class="lineNum">    4121 </span>            :     //find   rotation angles relative to line given by vertex and point 1
<span class="lineNum">    4122 </span><span class="lineCov">       6708 :     Double_t dvertex2 = (x1-x3)*(x1-x3)+(y1-y3)*(y1-y3);</span>
<span class="lineNum">    4123 </span><span class="lineCov">       6708 :     Double_t dvertex  = TMath::Sqrt(dvertex2);</span>
<span class="lineNum">    4124 </span><span class="lineCov">       6708 :     Double_t angle13  = TMath::ATan((y1-y3)/(x1-x3));</span>
<span class="lineNum">    4125 </span><span class="lineCov">       6708 :     Double_t cs13     = cos(-angle13), sn13 = sin(-angle13);            </span>
<span class="lineNum">    4126 </span>            :     
<span class="lineNum">    4127 </span>            :     //
<span class="lineNum">    4128 </span>            :     // loop over 2 sectors
<span class="lineNum">    4129 </span><span class="lineCov">       6708 :     Int_t dsec1=-ddsec;</span>
<span class="lineNum">    4130 </span>            :     Int_t dsec2= ddsec;
<span class="lineNum">    4131 </span><span class="lineCov">      11178 :     if (y1&lt;0)  dsec2= 0;</span>
<span class="lineNum">    4132 </span><span class="lineCov">       8946 :     if (y1&gt;0)  dsec1= 0;</span>
<span class="lineNum">    4133 </span>            :     
<span class="lineNum">    4134 </span>            :     Double_t dddz1=0;  // direction of delta inclination in z axis
<span class="lineNum">    4135 </span>            :     Double_t dddz2=0;
<span class="lineNum">    4136 </span><span class="lineCov">       6708 :     if ( (z1-z3)&gt;0)</span>
<span class="lineNum">    4137 </span><span class="lineCov">       3102 :       dddz1 =1;    </span>
<span class="lineNum">    4138 </span>            :     else
<span class="lineNum">    4139 </span>            :       dddz2 =1;
<span class="lineNum">    4140 </span>            :     //
<span class="lineNum">    4141 </span><span class="lineCov">      31116 :     for (Int_t dsec = dsec1; dsec&lt;=dsec2;dsec++){</span>
<span class="lineNum">    4142 </span><span class="lineCov">       8850 :       Int_t sec2 = sec + dsec;</span>
<span class="lineNum">    4143 </span>            :       // 
<span class="lineNum">    4144 </span>            :       //      AliTPCtrackerRow&amp;  kr2  = fOuterSec[(sec2+fkNOS)%fkNOS][i2];
<span class="lineNum">    4145 </span>            :       //AliTPCtrackerRow&amp;  kr2m = fOuterSec[(sec2+fkNOS)%fkNOS][imiddle];
<span class="lineNum">    4146 </span><span class="lineCov">       8850 :       AliTPCtrackerRow&amp;  kr2  = GetRow((sec2+fkNOS)%fkNOS,i2);</span>
<span class="lineNum">    4147 </span><span class="lineCov">       8850 :       AliTPCtrackerRow&amp;  kr2m = GetRow((sec2+fkNOS)%fkNOS,imiddle);</span>
<span class="lineNum">    4148 </span><span class="lineCov">       8850 :       Int_t  index1 = TMath::Max(kr2.Find(extraz-0.6-dddz1*TMath::Abs(z1)*0.05)-1,0);</span>
<span class="lineNum">    4149 </span><span class="lineCov">       8850 :       Int_t  index2 = TMath::Min(kr2.Find(extraz+0.6+dddz2*TMath::Abs(z1)*0.05)+1,kr2);</span>
<span class="lineNum">    4150 </span>            : 
<span class="lineNum">    4151 </span>            :       // rotation angles to p1-p3
<span class="lineNum">    4152 </span><span class="lineCov">       8850 :       Double_t cs13r     = cos(-angle13+dsec*alpha)/dvertex, sn13r = sin(-angle13+dsec*alpha)/dvertex;            </span>
<span class="lineNum">    4153 </span>            :       Double_t x2,   y2,   z2; 
<span class="lineNum">    4154 </span>            :       //
<span class="lineNum">    4155 </span>            :       //      Double_t dymax = maxangle*TMath::Abs(x1-xx2);
<span class="lineNum">    4156 </span>            : 
<span class="lineNum">    4157 </span>            :       //
<span class="lineNum">    4158 </span><span class="lineCov">       8850 :       Double_t dxx0 =  (xx2-x3)*cs13r;</span>
<span class="lineNum">    4159 </span><span class="lineCov">       8850 :       Double_t dyy0 =  (xx2-x3)*sn13r;</span>
<span class="lineNum">    4160 </span><span class="lineCov">      41978 :       for (Int_t js=index1; js &lt; index2; js++) {</span>
<span class="lineNum">    4161 </span><span class="lineCov">       8026 :         const AliTPCclusterMI *kcl = kr2[js];</span>
<span class="lineNum">    4162 </span><span class="lineCov">      10314 :         if (kcl-&gt;IsUsed(10)) continue;       </span>
<span class="lineNum">    4163 </span><span class="lineCov">       5738 :         if (kcl-&gt;IsDisabled()) {</span>
<span class="lineNum">    4164 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">    4165 </span>            :         }
<span class="lineNum">    4166 </span>            :         //
<span class="lineNum">    4167 </span>            :         //calcutate parameters
<span class="lineNum">    4168 </span>            :         //      
<span class="lineNum">    4169 </span><span class="lineCov">       5738 :         Double_t yy0 =  dyy0 +(kcl-&gt;GetY()-y3)*cs13r;</span>
<span class="lineNum">    4170 </span>            :         // stright track
<span class="lineNum">    4171 </span><span class="lineCov">       5738 :         if (TMath::Abs(yy0)&lt;0.000001) continue;</span>
<span class="lineNum">    4172 </span><span class="lineCov">       5738 :         Double_t xx0 =  dxx0 -(kcl-&gt;GetY()-y3)*sn13r;</span>
<span class="lineNum">    4173 </span><span class="lineCov">       5738 :         Double_t y0  =  0.5*(xx0*xx0+yy0*yy0-xx0)/yy0;</span>
<span class="lineNum">    4174 </span><span class="lineCov">       5738 :         Double_t r02 = (0.25+y0*y0)*dvertex2;   </span>
<span class="lineNum">    4175 </span>            :         //curvature (radius) cut
<span class="lineNum">    4176 </span><span class="lineCov">       9614 :         if (r02&lt;r2min) continue;             </span>
<span class="lineNum">    4177 </span>            :        
<span class="lineNum">    4178 </span><span class="lineCov">       1862 :         nin0++; </span>
<span class="lineNum">    4179 </span>            :         //
<span class="lineNum">    4180 </span><span class="lineCov">       1862 :         Double_t c0  = 1/TMath::Sqrt(r02);</span>
<span class="lineNum">    4181 </span><span class="lineCov">       2698 :         if (yy0&gt;0) c0*=-1.;  </span>
<span class="lineNum">    4182 </span>            :                
<span class="lineNum">    4183 </span>            :        
<span class="lineNum">    4184 </span>            :         //Double_t dfi0   = 2.*TMath::ASin(dvertex*c0*0.5);
<span class="lineNum">    4185 </span>            :         //Double_t dfi1   = 2.*TMath::ASin(TMath::Sqrt(yy0*yy0+(1-xx0)*(1-xx0))*dvertex*c0*0.5);
<span class="lineNum">    4186 </span><span class="lineCov">       1862 :         Double_t dfi0   = 2.*asinf(dvertex*c0*0.5);</span>
<span class="lineNum">    4187 </span><span class="lineCov">       1862 :         Double_t dfi1   = 2.*asinf(TMath::Sqrt(yy0*yy0+(1-xx0)*(1-xx0))*dvertex*c0*0.5);  </span>
<span class="lineNum">    4188 </span>            :         //
<span class="lineNum">    4189 </span>            :         //
<span class="lineNum">    4190 </span><span class="lineCov">       1862 :         Double_t z0  =  kcl-&gt;GetZ();  </span>
<span class="lineNum">    4191 </span><span class="lineCov">       1862 :         Double_t zzzz2    = z1-(z1-z3)*dfi1/dfi0;</span>
<span class="lineNum">    4192 </span><span class="lineCov">       3416 :         if (TMath::Abs(zzzz2-z0)&gt;0.5) continue;       </span>
<span class="lineNum">    4193 </span><span class="lineCov">        308 :         nin1++;              </span>
<span class="lineNum">    4194 </span>            :         //      
<span class="lineNum">    4195 </span><span class="lineCov">        308 :         Double_t dip    = (z1-z0)*c0/dfi1;        </span>
<span class="lineNum">    4196 </span><span class="lineCov">        308 :         Double_t x0 = (0.5*cs13+y0*sn13)*dvertex*c0;</span>
<span class="lineNum">    4197 </span>            :         //
<span class="lineNum">    4198 </span><span class="lineCov">        308 :         y2 = kcl-&gt;GetY(); </span>
<span class="lineNum">    4199 </span><span class="lineCov">        308 :         if (dsec==0){</span>
<span class="lineNum">    4200 </span>            :           x2 = xx2; 
<span class="lineNum">    4201 </span><span class="lineCov">        282 :           z2 = kcl-&gt;GetZ();    </span>
<span class="lineNum">    4202 </span><span class="lineCov">        282 :         }</span>
<span class="lineNum">    4203 </span>            :         else
<span class="lineNum">    4204 </span>            :           {
<span class="lineNum">    4205 </span>            :             // rotation 
<span class="lineNum">    4206 </span><span class="lineCov">         26 :             z2 = kcl-&gt;GetZ();  </span>
<span class="lineNum">    4207 </span><span class="lineCov">         26 :             x2= xx2*cs-y2*sn*dsec;</span>
<span class="lineNum">    4208 </span><span class="lineCov">         26 :             y2=+xx2*sn*dsec+y2*cs;</span>
<span class="lineNum">    4209 </span>            :           }
<span class="lineNum">    4210 </span>            :         
<span class="lineNum">    4211 </span><span class="lineCov">        308 :         x[0] = y1;</span>
<span class="lineNum">    4212 </span><span class="lineCov">        308 :         x[1] = z1;</span>
<span class="lineNum">    4213 </span><span class="lineCov">        308 :         x[2] = x0;</span>
<span class="lineNum">    4214 </span><span class="lineCov">        308 :         x[3] = dip;</span>
<span class="lineNum">    4215 </span><span class="lineCov">        308 :         x[4] = c0;</span>
<span class="lineNum">    4216 </span>            :         //
<span class="lineNum">    4217 </span>            :         //
<span class="lineNum">    4218 </span>            :         // do we have cluster at the middle ?
<span class="lineNum">    4219 </span><span class="lineCov">        308 :         Double_t ym,zm;</span>
<span class="lineNum">    4220 </span><span class="lineCov">        308 :         GetProlongation(x1,xm,x,ym,zm);</span>
<span class="lineNum">    4221 </span><span class="lineCov">        308 :         UInt_t dummy; </span>
<span class="lineNum">    4222 </span>            :         AliTPCclusterMI * cm=0;
<span class="lineNum">    4223 </span><span class="lineCov">        308 :         if (TMath::Abs(ym)-ymaxm&lt;0){   </span>
<span class="lineNum">    4224 </span><span class="lineCov">        282 :           cm = krm.FindNearest2(ym,zm,kRoadY+fClExtraRoadY,kRoadZ+fClExtraRoadZ,dummy);</span>
<span class="lineNum">    4225 </span><span class="lineCov">        500 :           if ((!cm) || (cm-&gt;IsUsed(10))) {     </span>
<span class="lineNum">    4226 </span><span class="lineCov">         78 :             continue;</span>
<span class="lineNum">    4227 </span>            :           }
<span class="lineNum">    4228 </span>            :         }
<span class="lineNum">    4229 </span>            :         else{     
<span class="lineNum">    4230 </span>            :           // rotate y1 to system 0
<span class="lineNum">    4231 </span>            :           // get state vector in rotated system 
<span class="lineNum">    4232 </span><span class="lineCov">         26 :           Double_t yr1  = (-0.5*sn13+y0*cs13)*dvertex*c0;</span>
<span class="lineNum">    4233 </span><span class="lineCov">         26 :           Double_t xr2  =  x0*cs+yr1*sn*dsec;</span>
<span class="lineNum">    4234 </span><span class="lineCov">         26 :           Double_t xr[5]={kcl-&gt;GetY(),kcl-&gt;GetZ(), xr2, dip, c0};</span>
<span class="lineNum">    4235 </span>            :           //
<span class="lineNum">    4236 </span><span class="lineCov">         26 :           GetProlongation(xx2,xm,xr,ym,zm);</span>
<span class="lineNum">    4237 </span><span class="lineCov">         26 :           if (TMath::Abs(ym)-ymaxm&lt;0){</span>
<span class="lineNum">    4238 </span><span class="lineCov">          2 :             cm = kr2m.FindNearest2(ym,zm,kRoadY+fClExtraRoadY,kRoadZ+fClExtraRoadZ,dummy);</span>
<span class="lineNum">    4239 </span><span class="lineCov">          2 :             if ((!cm) || (cm-&gt;IsUsed(10))) {   </span>
<span class="lineNum">    4240 </span><span class="lineCov">          2 :               continue;</span>
<span class="lineNum">    4241 </span>            :             }
<span class="lineNum">    4242 </span>            :           }
<span class="lineNum">    4243 </span><span class="lineCov">         50 :         }</span>
<span class="lineNum">    4244 </span>            :        
<span class="lineNum">    4245 </span>            : 
<span class="lineNum">    4246 </span>            :         // Double_t dym = 0;
<span class="lineNum">    4247 </span>            :         // Double_t dzm = 0;
<span class="lineNum">    4248 </span>            :         // if (cm){
<span class="lineNum">    4249 </span>            :         //   dym = ym - cm-&gt;GetY();
<span class="lineNum">    4250 </span>            :         //   dzm = zm - cm-&gt;GetZ();
<span class="lineNum">    4251 </span>            :         // }
<span class="lineNum">    4252 </span><span class="lineCov">        228 :         nin2++;</span>
<span class="lineNum">    4253 </span>            : 
<span class="lineNum">    4254 </span>            : 
<span class="lineNum">    4255 </span>            :         //
<span class="lineNum">    4256 </span>            :         //
<span class="lineNum">    4257 </span><span class="lineCov">        228 :         Double_t sy1=kr1[is]-&gt;GetSigmaY2()*2., sz1=kr1[is]-&gt;GetSigmaZ2()*2.;</span>
<span class="lineNum">    4258 </span><span class="lineCov">        228 :         Double_t sy2=kcl-&gt;GetSigmaY2()*2.,     sz2=kcl-&gt;GetSigmaZ2()*2.;</span>
<span class="lineNum">    4259 </span>            :         //Double_t sy3=400*3./12., sy=0.1, sz=0.1;
<span class="lineNum">    4260 </span><span class="lineCov">        228 :         Double_t sy3=25000*x[4]*x[4]+0.1, sy=0.1, sz=0.1;</span>
<span class="lineNum">    4261 </span>            :         //Double_t sy3=25000*x[4]*x[4]*60+0.5, sy=0.1, sz=0.1;
<span class="lineNum">    4262 </span>            : 
<span class="lineNum">    4263 </span><span class="lineCov">        228 :         Double_t f40=(F1(x1,y1+sy,x2,y2,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    4264 </span><span class="lineCov">        228 :         Double_t f42=(F1(x1,y1,x2,y2+sy,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    4265 </span><span class="lineCov">        228 :         Double_t f43=(F1(x1,y1,x2,y2,x3,y3+sy)-x[4])/sy;</span>
<span class="lineNum">    4266 </span><span class="lineCov">        228 :         Double_t f20=(F2(x1,y1+sy,x2,y2,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    4267 </span><span class="lineCov">        228 :         Double_t f22=(F2(x1,y1,x2,y2+sy,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    4268 </span><span class="lineCov">        228 :         Double_t f23=(F2(x1,y1,x2,y2,x3,y3+sy)-x[2])/sy;</span>
<span class="lineNum">    4269 </span>            :         
<span class="lineNum">    4270 </span><span class="lineCov">        228 :         Double_t f30=(F3(x1,y1+sy,x2,y2,z1,z2)-x[3])/sy;</span>
<span class="lineNum">    4271 </span><span class="lineCov">        228 :         Double_t f31=(F3(x1,y1,x2,y2,z1+sz,z2)-x[3])/sz;</span>
<span class="lineNum">    4272 </span><span class="lineCov">        228 :         Double_t f32=(F3(x1,y1,x2,y2+sy,z1,z2)-x[3])/sy;</span>
<span class="lineNum">    4273 </span><span class="lineCov">        228 :         Double_t f34=(F3(x1,y1,x2,y2,z1,z2+sz)-x[3])/sz;</span>
<span class="lineNum">    4274 </span>            :         
<span class="lineNum">    4275 </span><span class="lineCov">        228 :         c[0]=sy1;</span>
<span class="lineNum">    4276 </span><span class="lineCov">        228 :         c[1]=0.;       c[2]=sz1;</span>
<span class="lineNum">    4277 </span><span class="lineCov">        228 :         c[3]=f20*sy1;  c[4]=0.;       c[5]=f20*sy1*f20+f22*sy2*f22+f23*sy3*f23;</span>
<span class="lineNum">    4278 </span><span class="lineCov">        228 :         c[6]=f30*sy1;  c[7]=f31*sz1;  c[8]=f30*sy1*f20+f32*sy2*f22;</span>
<span class="lineNum">    4279 </span><span class="lineCov">        228 :                        c[9]=f30*sy1*f30+f31*sz1*f31+f32*sy2*f32+f34*sz2*f34;</span>
<span class="lineNum">    4280 </span><span class="lineCov">        228 :         c[10]=f40*sy1; c[11]=0.; c[12]=f40*sy1*f20+f42*sy2*f22+f43*sy3*f23;</span>
<span class="lineNum">    4281 </span><span class="lineCov">        228 :         c[13]=f30*sy1*f40+f32*sy2*f42;</span>
<span class="lineNum">    4282 </span><span class="lineCov">        228 :         c[14]=f40*sy1*f40+f42*sy2*f42+f43*sy3*f43;</span>
<span class="lineNum">    4283 </span>            :         
<span class="lineNum">    4284 </span>            :         //      if (!BuildSeed(kr1[is],kcl,0,x1,x2,x3,x,c)) continue;
<span class="lineNum">    4285 </span>            :         
<span class="lineNum">    4286 </span><span class="lineCov">        228 :         UInt_t index=kr1.GetIndex(is);</span>
<span class="lineNum">    4287 </span><span class="lineCov">        454 :         if (seed) {MarkSeedFree(seed); seed = 0;}</span>
<span class="lineNum">    4288 </span><span class="lineCov">        228 :         AliTPCseed *track = seed = new( NextFreeSeed() ) AliTPCseed(x1, ns*alpha+shift, x, c, index);</span>
<span class="lineNum">    4289 </span><span class="lineCov">        228 :         seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    4290 </span><span class="lineCov">        228 :         seed-&gt;SetRow(i1); //RS: memorise current row</span>
<span class="lineNum">    4291 </span><span class="lineCov">        228 :         track-&gt;SetIsSeeding(kTRUE);</span>
<span class="lineNum">    4292 </span><span class="lineCov">        228 :         track-&gt;SetSeed1(i1);</span>
<span class="lineNum">    4293 </span><span class="lineCov">        228 :         track-&gt;SetSeed2(i2);</span>
<span class="lineNum">    4294 </span><span class="lineCov">        228 :         track-&gt;SetSeedType(3);</span>
<span class="lineNum">    4295 </span>            : 
<span class="lineNum">    4296 </span>            :        
<span class="lineNum">    4297 </span>            :         //if (dsec==0) {
<span class="lineNum">    4298 </span><span class="lineCov">        228 :           FollowProlongation(*track, (i1+i2)/2,1);</span>
<span class="lineNum">    4299 </span><span class="lineCov">        228 :           Int_t foundable,found,shared;   </span>
<span class="lineNum">    4300 </span><span class="lineCov">        228 :           GetSeedClusterStatistic(track,(i1+i2)/2,i1, found, foundable, shared, kTRUE); //RS: seeds don't keep their clusters</span>
<span class="lineNum">    4301 </span>            :           //RS track-&gt;GetClusterStatistic((i1+i2)/2,i1, found, foundable, shared, kTRUE);
<span class="lineNum">    4302 </span><span class="lineCov">        680 :           if ((found&lt;0.55*foundable)  || shared&gt;0.5*found || (track-&gt;GetSigmaY2()+track-&gt;GetSigmaZ2())&gt;0.5){</span>
<span class="lineNum">    4303 </span><span class="lineCov">          2 :             MarkSeedFree(seed); seed = 0;</span>
<span class="lineNum">    4304 </span><span class="lineCov">          2 :             continue;</span>
<span class="lineNum">    4305 </span>            :           }
<span class="lineNum">    4306 </span>            :           //}
<span class="lineNum">    4307 </span>            :         
<span class="lineNum">    4308 </span><span class="lineCov">        226 :         nin++;</span>
<span class="lineNum">    4309 </span><span class="lineCov">        226 :         FollowProlongation(*track, i2,1);</span>
<span class="lineNum">    4310 </span>            :         
<span class="lineNum">    4311 </span>            :         
<span class="lineNum">    4312 </span>            :         //Int_t rc = 1;
<span class="lineNum">    4313 </span><span class="lineCov">        226 :         track-&gt;SetBConstrain(1);</span>
<span class="lineNum">    4314 </span>            :         //      track-&gt;fLastPoint = i1+fInnerSec-&gt;GetNRows();  // first cluster in track position
<span class="lineNum">    4315 </span><span class="lineCov">        226 :         track-&gt;SetLastPoint(i1);  // first cluster in track position</span>
<span class="lineNum">    4316 </span><span class="lineCov">        226 :         track-&gt;SetFirstPoint(track-&gt;GetLastPoint());</span>
<span class="lineNum">    4317 </span>            :         
<span class="lineNum">    4318 </span><span class="lineCov">        440 :         if (track-&gt;GetNumberOfClusters()&lt;(i1-i2)*0.5 || </span>
<span class="lineNum">    4319 </span><span class="lineCov">        214 :             track-&gt;GetNumberOfClusters() &lt; track-&gt;GetNFoundable()*0.6 || </span>
<span class="lineNum">    4320 </span><span class="lineCov">        214 :             track-&gt;GetNShared()&gt;0.4*track-&gt;GetNumberOfClusters() ) {</span>
<span class="lineNum">    4321 </span><span class="lineCov">         12 :           MarkSeedFree(seed); seed = 0;</span>
<span class="lineNum">    4322 </span><span class="lineCov">         12 :           continue;</span>
<span class="lineNum">    4323 </span>            :         }
<span class="lineNum">    4324 </span><span class="lineCov">        214 :         nout1++;</span>
<span class="lineNum">    4325 </span><span class="lineCov">        214 :         Double_t zv, bz=GetBz();</span>
<span class="lineNum">    4326 </span><span class="lineCov">        214 :         if ( !track-&gt;GetZAt(0.,bz,zv) )       { MarkSeedFree( seed ); seed = 0; continue; }</span>
<span class="lineNum">    4327 </span>            :         //
<span class="lineNum">    4328 </span><span class="lineCov">        214 :         if (fDisableSecondaries) {</span>
<span class="lineNum">    4329 </span><span class="lineNoCov">          0 :           if (TMath::Abs(zv)&gt;fPrimaryDCAZCut) { MarkSeedFree( seed ); seed = 0; continue; }</span>
<span class="lineNum">    4330 </span><span class="lineNoCov">          0 :           double yv; </span>
<span class="lineNum">    4331 </span><span class="lineNoCov">          0 :           if ( !track-&gt;GetZAt(0.,bz,yv) )     { MarkSeedFree( seed ); seed = 0; continue; }</span>
<span class="lineNum">    4332 </span><span class="lineNoCov">          0 :           if (TMath::Abs(zv)&gt;fPrimaryDCAZCut) { MarkSeedFree( seed ); seed = 0; continue; }</span>
<span class="lineNum">    4333 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    4334 </span>            :         
<span class="lineNum">    4335 </span>            :         //
<span class="lineNum">    4336 </span>            :         // Z VERTEX CONDITION
<span class="lineNum">    4337 </span><span class="lineCov">        214 :         if (TMath::Abs(zv-z3)&gt;cuts[2]) {</span>
<span class="lineNum">    4338 </span><span class="lineCov">          4 :           FollowProlongation(*track, TMath::Max(i2-20,0));</span>
<span class="lineNum">    4339 </span><span class="lineCov">          4 :           if ( !track-&gt;GetZAt(0.,bz,zv) ) continue;</span>
<span class="lineNum">    4340 </span><span class="lineCov">          4 :           if (TMath::Abs(zv-z3)&gt;cuts[2]){</span>
<span class="lineNum">    4341 </span><span class="lineCov">          2 :             FollowProlongation(*track, TMath::Max(i2-40,0));</span>
<span class="lineNum">    4342 </span><span class="lineCov">          2 :             if ( !track-&gt;GetZAt(0.,bz,zv) ) continue;</span>
<span class="lineNum">    4343 </span><span class="lineCov">          4 :             if (TMath::Abs(zv-z3)&gt;cuts[2] &amp;&amp;(track-&gt;GetNumberOfClusters() &gt; track-&gt;GetNFoundable()*0.7)){</span>
<span class="lineNum">    4344 </span>            :               // make seed without constrain
<span class="lineNum">    4345 </span><span class="lineCov">          2 :               AliTPCseed * track2 = MakeSeed(track,0.2,0.5,1.);</span>
<span class="lineNum">    4346 </span><span class="lineCov">          2 :               FollowProlongation(*track2, i2,1);</span>
<span class="lineNum">    4347 </span><span class="lineCov">          2 :               track2-&gt;SetBConstrain(kFALSE);</span>
<span class="lineNum">    4348 </span><span class="lineCov">          2 :               track2-&gt;SetSeedType(1);</span>
<span class="lineNum">    4349 </span><span class="lineCov">          2 :               arr-&gt;AddLast(track2); </span>
<span class="lineNum">    4350 </span><span class="lineCov">          2 :               MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    4351 </span>            :               continue;         
<span class="lineNum">    4352 </span>            :             }
<span class="lineNum">    4353 </span>            :             else{
<span class="lineNum">    4354 </span><span class="lineNoCov">          0 :               MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    4355 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">    4356 </span>            :             
<span class="lineNum">    4357 </span>            :             }
<span class="lineNum">    4358 </span>            :           }
<span class="lineNum">    4359 </span>            :         }
<span class="lineNum">    4360 </span>            :       
<span class="lineNum">    4361 </span><span class="lineCov">        212 :         track-&gt;SetSeedType(0);</span>
<span class="lineNum">    4362 </span><span class="lineCov">        212 :         arr-&gt;AddLast(track); // note, track is seed, don't free the seed</span>
<span class="lineNum">    4363 </span><span class="lineCov">        212 :         seed = new( NextFreeSeed() ) AliTPCseed;        </span>
<span class="lineNum">    4364 </span><span class="lineCov">        212 :         seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    4365 </span><span class="lineCov">        212 :         nout2++;</span>
<span class="lineNum">    4366 </span>            :         // don't consider other combinations
<span class="lineNum">    4367 </span><span class="lineCov">        212 :         if (track-&gt;GetNumberOfClusters() &gt; track-&gt;GetNFoundable()*0.8)</span>
<span class="lineNum">    4368 </span><span class="lineCov">        208 :           break;</span>
<span class="lineNum">    4369 </span><span class="lineCov">        754 :       }</span>
<span class="lineNum">    4370 </span>            :     }
<span class="lineNum">    4371 </span><span class="lineCov">       6708 :   }</span>
<span class="lineNum">    4372 </span><span class="lineCov">       6192 :   if (fDebug&gt;3){</span>
<span class="lineNum">    4373 </span><span class="lineNoCov">          0 :     Info(&quot;MakeSeeds3&quot;,&quot;\nSeeding statistic:\t%d\t%d\t%d\t%d\t%d\t%d&quot;,nin0,nin1,nin2,nin,nout1,nout2);</span>
<span class="lineNum">    4374 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    4375 </span><span class="lineCov">      12370 :   if (seed) MarkSeedFree( seed );</span>
<span class="lineNum">    4376 </span><span class="lineCov">       6192 : }</span>
<a name="4377"><span class="lineNum">    4377 </span>            : </a>
<span class="lineNum">    4378 </span>            : //_____________________________________________________________________________
<span class="lineNum">    4379 </span>            : void AliTPCtracker::MakeSeeds3Dist(TObjArray * arr, Int_t sec, Int_t i1, Int_t i2,  Float_t cuts[4],
<span class="lineNum">    4380 </span>            :                                    Float_t deltay, Int_t ddsec) {
<span class="lineNum">    4381 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4382 </span>            :   // This function creates track seeds, accounting for distortions
<span class="lineNum">    4383 </span>            :   // SEEDING WITH VERTEX CONSTRAIN 
<span class="lineNum">    4384 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4385 </span>            :   // cuts[0]   - fP4 cut
<span class="lineNum">    4386 </span>            :   // cuts[1]   - tan(phi)  cut
<span class="lineNum">    4387 </span>            :   // cuts[2]   - zvertex cut
<span class="lineNum">    4388 </span>            :   // cuts[3]   - fP3 cut
<span class="lineNum">    4389 </span>            :   const double kRoadY = 1., kRoadZ = 0.6;
<span class="lineNum">    4390 </span>            : 
<span class="lineNum">    4391 </span>            :   Int_t nin0  = 0;
<span class="lineNum">    4392 </span>            :   Int_t nin1  = 0;
<span class="lineNum">    4393 </span>            :   Int_t nin2  = 0;
<span class="lineNum">    4394 </span>            :   Int_t nin   = 0;
<span class="lineNum">    4395 </span>            :   Int_t nout1 = 0;
<span class="lineNum">    4396 </span>            :   Int_t nout2 = 0;
<span class="lineNum">    4397 </span>            : 
<span class="lineNum">    4398 </span><span class="lineNoCov">          0 :   Double_t x[5], c[15];</span>
<span class="lineNum">    4399 </span>            :   //  Int_t di = i1-i2;
<span class="lineNum">    4400 </span>            :   //
<span class="lineNum">    4401 </span><span class="lineNoCov">          0 :   AliTPCseed * seed = new( NextFreeSeed() ) AliTPCseed();</span>
<span class="lineNum">    4402 </span><span class="lineNoCov">          0 :   seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    4403 </span><span class="lineNoCov">          0 :   Double_t alpha=fSectors-&gt;GetAlpha(), shift=fSectors-&gt;GetAlphaShift();</span>
<span class="lineNum">    4404 </span><span class="lineNoCov">          0 :   Double_t cs=cos(alpha), sn=sin(alpha);</span>
<span class="lineNum">    4405 </span>            :   //
<span class="lineNum">    4406 </span><span class="lineNoCov">          0 :   Double_t x1def = GetXrow(i1);</span>
<span class="lineNum">    4407 </span><span class="lineNoCov">          0 :   Double_t xx2def = GetXrow(i2);</span>
<span class="lineNum">    4408 </span>            : 
<span class="lineNum">    4409 </span><span class="lineNoCov">          0 :   Double_t x3=GetX(), y3=GetY(), z3=GetZ();</span>
<span class="lineNum">    4410 </span>            : 
<span class="lineNum">    4411 </span><span class="lineNoCov">          0 :   Int_t imiddle = (i2+i1)/2;    //middle pad row index</span>
<span class="lineNum">    4412 </span><span class="lineNoCov">          0 :   const AliTPCtrackerRow&amp; krm=GetRow(sec,imiddle); //middle pad -row</span>
<span class="lineNum">    4413 </span>            :   //
<span class="lineNum">    4414 </span>            :   Int_t ns =sec;   
<span class="lineNum">    4415 </span>            : 
<span class="lineNum">    4416 </span><span class="lineNoCov">          0 :   const AliTPCtrackerRow&amp; kr1=GetRow(ns,i1);</span>
<span class="lineNum">    4417 </span><span class="lineNoCov">          0 :   Double_t ymax  = GetMaxY(i1)-kr1.GetDeadZone()-1.5;  </span>
<span class="lineNum">    4418 </span><span class="lineNoCov">          0 :   Double_t ymaxm = GetMaxY(imiddle)-kr1.GetDeadZone()-1.5; </span>
<span class="lineNum">    4419 </span>            : 
<span class="lineNum">    4420 </span>            :   //
<span class="lineNum">    4421 </span>            :   // change cut on curvature if it can't reach this layer
<span class="lineNum">    4422 </span>            :   // maximal curvature set to reach it
<span class="lineNum">    4423 </span><span class="lineNoCov">          0 :   Double_t dvertexmax  = TMath::Sqrt((x1def-x3)*(x1def-x3)+(ymax+5-y3)*(ymax+5-y3));</span>
<span class="lineNum">    4424 </span><span class="lineNoCov">          0 :   if (dvertexmax*0.5*cuts[0]&gt;0.85){</span>
<span class="lineNum">    4425 </span><span class="lineNoCov">          0 :     cuts[0] = 0.85/(dvertexmax*0.5+1.);</span>
<span class="lineNum">    4426 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    4427 </span><span class="lineNoCov">          0 :   Double_t r2min = 1/(cuts[0]*cuts[0]);  //minimal square of radius given by cut</span>
<span class="lineNum">    4428 </span>            : 
<span class="lineNum">    4429 </span>            :   //  Int_t ddsec = 1;
<span class="lineNum">    4430 </span><span class="lineNoCov">          0 :   if (deltay&gt;0) ddsec = 0; </span>
<span class="lineNum">    4431 </span>            :   // loop over clusters  
<span class="lineNum">    4432 </span><span class="lineNoCov">          0 :   for (Int_t is=0; is &lt; kr1; is++) {</span>
<span class="lineNum">    4433 </span>            :     //
<span class="lineNum">    4434 </span><span class="lineNoCov">          0 :     if (kr1[is]-&gt;IsUsed(10)) continue;</span>
<span class="lineNum">    4435 </span><span class="lineNoCov">          0 :     if (kr1[is]-&gt;IsDisabled()) {</span>
<span class="lineNum">    4436 </span>            :       continue;
<span class="lineNum">    4437 </span>            :     }
<span class="lineNum">    4438 </span><span class="lineNoCov">          0 :     const AliTPCclusterMI* clkr1 = kr1[is];</span>
<span class="lineNum">    4439 </span><span class="lineNoCov">          0 :     Double_t x1=clkr1-&gt;GetX(), y1=clkr1-&gt;GetY(), z1=clkr1-&gt;GetZ();    </span>
<span class="lineNum">    4440 </span>            :     //if (TMath::Abs(y1)&gt;ymax) continue;
<span class="lineNum">    4441 </span>            :     double y1EdgeDist = y1;
<span class="lineNum">    4442 </span><span class="lineNoCov">          0 :     if  (fAccountDistortions) y1EdgeDist -= GetYSectEdgeDist(sec,ns,y1,z1);</span>
<span class="lineNum">    4443 </span><span class="lineNoCov">          0 :     if (deltay&gt;0) {</span>
<span class="lineNum">    4444 </span><span class="lineNoCov">          0 :       double margin = (y1&gt;0 ? ymax-y1EdgeDist : ymax + y1EdgeDist);</span>
<span class="lineNum">    4445 </span><span class="lineNoCov">          0 :       if (margin&lt;deltay ) continue;  // seed only at the edge</span>
<span class="lineNum">    4446 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    4447 </span>            :     //
<span class="lineNum">    4448 </span>            :     // find possible directions
<span class="lineNum">    4449 </span><span class="lineNoCov">          0 :     double dx13 = x1-x3, dy13 = y1-y3, dz13 = z1-z3;</span>
<span class="lineNum">    4450 </span><span class="lineNoCov">          0 :     double anglez = dz13/dx13;</span>
<span class="lineNum">    4451 </span><span class="lineNoCov">          0 :     double extraz = z1 - anglez*(x1-xx2def);  // extrapolated z      </span>
<span class="lineNum">    4452 </span>            :     //
<span class="lineNum">    4453 </span>            :     //
<span class="lineNum">    4454 </span>            :     //find   rotation angles relative to line given by vertex and point 1
<span class="lineNum">    4455 </span><span class="lineNoCov">          0 :     Double_t dvertex2 = dx13*dx13+dy13*dy13;</span>
<span class="lineNum">    4456 </span><span class="lineNoCov">          0 :     Double_t dvertex  = TMath::Sqrt(dvertex2);</span>
<span class="lineNum">    4457 </span><span class="lineNoCov">          0 :     Double_t angle13  = TMath::ATan(dy13/dx13);</span>
<span class="lineNum">    4458 </span><span class="lineNoCov">          0 :     Double_t cs13     = cos(-angle13), sn13 = sin(-angle13);            </span>
<span class="lineNum">    4459 </span>            :     
<span class="lineNum">    4460 </span>            :     //
<span class="lineNum">    4461 </span>            :     // loop over 2 sectors
<span class="lineNum">    4462 </span><span class="lineNoCov">          0 :     Int_t dsec1=-ddsec;</span>
<span class="lineNum">    4463 </span>            :     Int_t dsec2= ddsec;
<span class="lineNum">    4464 </span><span class="lineNoCov">          0 :     if (y1&lt;0)  dsec2= 0;</span>
<span class="lineNum">    4465 </span><span class="lineNoCov">          0 :     if (y1&gt;0)  dsec1= 0;</span>
<span class="lineNum">    4466 </span>            :     
<span class="lineNum">    4467 </span>            :     Double_t dddz1=0;  // direction of delta inclination in z axis
<span class="lineNum">    4468 </span>            :     Double_t dddz2=0;
<span class="lineNum">    4469 </span><span class="lineNoCov">          0 :     if ( dz13&gt;0 ) dddz1 =1;    </span>
<span class="lineNum">    4470 </span>            :     else          dddz2 =1;
<span class="lineNum">    4471 </span>            :     //
<span class="lineNum">    4472 </span><span class="lineNoCov">          0 :     for (Int_t dsec = dsec1; dsec&lt;=dsec2;dsec++){</span>
<span class="lineNum">    4473 </span><span class="lineNoCov">          0 :       Int_t sec2 = sec + dsec;</span>
<span class="lineNum">    4474 </span>            :       // 
<span class="lineNum">    4475 </span>            :       //      AliTPCtrackerRow&amp;  kr2  = fOuterSec[(sec2+fkNOS)%fkNOS][i2];
<span class="lineNum">    4476 </span>            :       //AliTPCtrackerRow&amp;  kr2m = fOuterSec[(sec2+fkNOS)%fkNOS][imiddle];
<span class="lineNum">    4477 </span><span class="lineNoCov">          0 :       AliTPCtrackerRow&amp;  kr2  = GetRow((sec2+fkNOS)%fkNOS,i2);</span>
<span class="lineNum">    4478 </span><span class="lineNoCov">          0 :       AliTPCtrackerRow&amp;  kr2m = GetRow((sec2+fkNOS)%fkNOS,imiddle);</span>
<span class="lineNum">    4479 </span><span class="lineNoCov">          0 :       Int_t  index1 = TMath::Max(kr2.Find(extraz-0.6-dddz1*TMath::Abs(z1)*0.05)-1,0);</span>
<span class="lineNum">    4480 </span><span class="lineNoCov">          0 :       Int_t  index2 = TMath::Min(kr2.Find(extraz+0.6+dddz2*TMath::Abs(z1)*0.05)+1,kr2);</span>
<span class="lineNum">    4481 </span>            : 
<span class="lineNum">    4482 </span>            :       // rotation angles to p1-p3
<span class="lineNum">    4483 </span><span class="lineNoCov">          0 :       Double_t cs13r     = cos(-angle13+dsec*alpha)/dvertex, sn13r = sin(-angle13+dsec*alpha)/dvertex;            </span>
<span class="lineNum">    4484 </span>            :       //
<span class="lineNum">    4485 </span>            :       //      Double_t dymax = maxangle*TMath::Abs(x1-xx2);
<span class="lineNum">    4486 </span>            :       //
<span class="lineNum">    4487 </span><span class="lineNoCov">          0 :       for (Int_t js=index1; js &lt; index2; js++) {</span>
<span class="lineNum">    4488 </span><span class="lineNoCov">          0 :         const AliTPCclusterMI *kcl = kr2[js];</span>
<span class="lineNum">    4489 </span><span class="lineNoCov">          0 :         if (kcl-&gt;IsUsed(10)) continue;       </span>
<span class="lineNum">    4490 </span><span class="lineNoCov">          0 :         if (kcl-&gt;IsDisabled()) {</span>
<span class="lineNum">    4491 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">    4492 </span>            :         }
<span class="lineNum">    4493 </span>            :         //
<span class="lineNum">    4494 </span><span class="lineNoCov">          0 :         double x2=kcl-&gt;GetX(), y2=kcl-&gt;GetY(), z2=kcl-&gt;GetZ();</span>
<span class="lineNum">    4495 </span><span class="lineNoCov">          0 :         double dy23 = y2-y3, dx23 = x2-x3;</span>
<span class="lineNum">    4496 </span>            :         //calcutate parameters
<span class="lineNum">    4497 </span><span class="lineNoCov">          0 :         Double_t dxx0 =  dx23*cs13r;</span>
<span class="lineNum">    4498 </span><span class="lineNoCov">          0 :         Double_t dyy0 =  dx23*sn13r;</span>
<span class="lineNum">    4499 </span>            :         //      
<span class="lineNum">    4500 </span><span class="lineNoCov">          0 :         Double_t yy0 =  dyy0 +dy23*cs13r;</span>
<span class="lineNum">    4501 </span>            :         // stright track
<span class="lineNum">    4502 </span><span class="lineNoCov">          0 :         if (TMath::Abs(yy0)&lt;0.000001) continue;</span>
<span class="lineNum">    4503 </span><span class="lineNoCov">          0 :         Double_t xx0 =  dxx0 -dy23*sn13r;</span>
<span class="lineNum">    4504 </span><span class="lineNoCov">          0 :         Double_t y0  =  0.5*(xx0*xx0+yy0*yy0-xx0)/yy0;</span>
<span class="lineNum">    4505 </span><span class="lineNoCov">          0 :         Double_t r02 = (0.25+y0*y0)*dvertex2;   </span>
<span class="lineNum">    4506 </span>            :         //curvature (radius) cut
<span class="lineNum">    4507 </span><span class="lineNoCov">          0 :         if (r02&lt;r2min) continue;             </span>
<span class="lineNum">    4508 </span>            :        
<span class="lineNum">    4509 </span><span class="lineNoCov">          0 :         nin0++; </span>
<span class="lineNum">    4510 </span>            :         //
<span class="lineNum">    4511 </span><span class="lineNoCov">          0 :         Double_t c0  = 1/TMath::Sqrt(r02);</span>
<span class="lineNum">    4512 </span><span class="lineNoCov">          0 :         if (yy0&gt;0) c0*=-1.;  </span>
<span class="lineNum">    4513 </span>            :        
<span class="lineNum">    4514 </span><span class="lineNoCov">          0 :         Double_t dfi0   = 2.*TMath::ASin(dvertex*c0*0.5);</span>
<span class="lineNum">    4515 </span><span class="lineNoCov">          0 :         Double_t dfi1   = 2.*TMath::ASin(TMath::Sqrt(yy0*yy0+(1-xx0)*(1-xx0))*dvertex*c0*0.5);</span>
<span class="lineNum">    4516 </span>            :         //      Double_t dfi0   = 2.*AliTPCFastMath::FastAsin(dvertex*c0*0.5);
<span class="lineNum">    4517 </span>            :         //      Double_t dfi1   = 2.*AliTPCFastMath::FastAsin(TMath::Sqrt(yy0*yy0+(1-xx0)*(1-xx0))*dvertex*c0*0.5);  
<span class="lineNum">    4518 </span>            :         //
<span class="lineNum">    4519 </span><span class="lineNoCov">          0 :         Double_t zzzz2    = z1-dz13*dfi1/dfi0;</span>
<span class="lineNum">    4520 </span><span class="lineNoCov">          0 :         if (TMath::Abs(zzzz2-z2)&gt;0.5) continue;       </span>
<span class="lineNum">    4521 </span><span class="lineNoCov">          0 :         nin1++;              </span>
<span class="lineNum">    4522 </span>            :         //      
<span class="lineNum">    4523 </span><span class="lineNoCov">          0 :         Double_t dip    = (z1-z2)*c0/dfi1;        </span>
<span class="lineNum">    4524 </span><span class="lineNoCov">          0 :         Double_t x0 = (0.5*cs13+y0*sn13)*dvertex*c0;</span>
<span class="lineNum">    4525 </span>            :         //
<span class="lineNum">    4526 </span><span class="lineNoCov">          0 :         if (dsec!=0) {</span>
<span class="lineNum">    4527 </span>            :           // rotation
<span class="lineNum">    4528 </span>            :           double xt2 = x2;
<span class="lineNum">    4529 </span><span class="lineNoCov">          0 :           x2= xt2*cs-y2*sn*dsec;</span>
<span class="lineNum">    4530 </span><span class="lineNoCov">          0 :           y2=+xt2*sn*dsec+y2*cs;</span>
<span class="lineNum">    4531 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    4532 </span>            :         
<span class="lineNum">    4533 </span><span class="lineNoCov">          0 :         x[0] = y1;</span>
<span class="lineNum">    4534 </span><span class="lineNoCov">          0 :         x[1] = z1;</span>
<span class="lineNum">    4535 </span><span class="lineNoCov">          0 :         x[2] = x0;</span>
<span class="lineNum">    4536 </span><span class="lineNoCov">          0 :         x[3] = dip;</span>
<span class="lineNum">    4537 </span><span class="lineNoCov">          0 :         x[4] = c0;</span>
<span class="lineNum">    4538 </span>            :         //
<span class="lineNum">    4539 </span>            :         //
<span class="lineNum">    4540 </span>            :         // do we have cluster at the middle ?
<span class="lineNum">    4541 </span><span class="lineNoCov">          0 :         Double_t xm = GetXrow(imiddle), ym, zm; // radius of middle pad-row</span>
<span class="lineNum">    4542 </span><span class="lineNoCov">          0 :         GetProlongation(x1,xm,x,ym,zm);</span>
<span class="lineNum">    4543 </span>            :         // account for distortion
<span class="lineNum">    4544 </span><span class="lineNoCov">          0 :         double dxDist = GetDistortionX(xm,ym,zm,sec,imiddle);</span>
<span class="lineNum">    4545 </span><span class="lineNoCov">          0 :         if (TMath::Abs(dxDist)&gt;0.05) GetProlongation(x1,xm+dxDist,x,ym,zm); //RS:? can we use straight line here?</span>
<span class="lineNum">    4546 </span><span class="lineNoCov">          0 :         UInt_t dummy; </span>
<span class="lineNum">    4547 </span>            :         AliTPCclusterMI * cm=0;
<span class="lineNum">    4548 </span><span class="lineNoCov">          0 :         double ymEdgeDist = ym;</span>
<span class="lineNum">    4549 </span><span class="lineNoCov">          0 :         if (fAccountDistortions) ymEdgeDist -= GetYSectEdgeDist(sec,imiddle,ym,zm); // ym shifted by edge distortion</span>
<span class="lineNum">    4550 </span><span class="lineNoCov">          0 :         if ( (ym&gt;0&amp;&amp;ymEdgeDist&lt;ymaxm) || (ym&lt;=0&amp;&amp;ymEdgeDist&gt;-ymaxm) ) { //RS  //    if (TMath::Abs(ym)-ymaxm&lt;0){</span>
<span class="lineNum">    4551 </span><span class="lineNoCov">          0 :           cm = krm.FindNearest2(ym,zm,kRoadY+fClExtraRoadY,kRoadZ+fClExtraRoadZ,dummy);</span>
<span class="lineNum">    4552 </span><span class="lineNoCov">          0 :           if ((!cm) || (cm-&gt;IsUsed(10))) continue;</span>
<span class="lineNum">    4553 </span>            :         }
<span class="lineNum">    4554 </span>            :         else{     
<span class="lineNum">    4555 </span>            :           // rotate y1 to system 0
<span class="lineNum">    4556 </span>            :           // get state vector in rotated system 
<span class="lineNum">    4557 </span><span class="lineNoCov">          0 :           Double_t yr1  = (-0.5*sn13+y0*cs13)*dvertex*c0;</span>
<span class="lineNum">    4558 </span><span class="lineNoCov">          0 :           Double_t xr2  =  x0*cs+yr1*sn*dsec;</span>
<span class="lineNum">    4559 </span><span class="lineNoCov">          0 :           Double_t xr[5]={kcl-&gt;GetY(),kcl-&gt;GetZ(), xr2, dip, c0};</span>
<span class="lineNum">    4560 </span>            :           //
<span class="lineNum">    4561 </span><span class="lineNoCov">          0 :           GetProlongation(kcl-&gt;GetX(),xm,xr,ym,zm);</span>
<span class="lineNum">    4562 </span><span class="lineNoCov">          0 :           double dxDist = GetDistortionX(xm,ym,zm,sec2,imiddle);</span>
<span class="lineNum">    4563 </span><span class="lineNoCov">          0 :           if (TMath::Abs(dxDist)&gt;0.05) GetProlongation(x1,xm+dxDist,x,ym,zm); //RS:? can we use straight line here?</span>
<span class="lineNum">    4564 </span>            :           //
<span class="lineNum">    4565 </span><span class="lineNoCov">          0 :           ymEdgeDist = ym;</span>
<span class="lineNum">    4566 </span><span class="lineNoCov">          0 :           if (fAccountDistortions) ymEdgeDist -= GetYSectEdgeDist(sec2,imiddle,ym,zm); // ym shifted by edge distortion</span>
<span class="lineNum">    4567 </span><span class="lineNoCov">          0 :           if ( (ym&gt;0&amp;&amp;ymEdgeDist&lt;ymaxm) || (ym&lt;=0&amp;&amp;ymEdgeDist&gt;-ymaxm) ) { //RS //if (TMath::Abs(ym)-ymaxm&lt;0){</span>
<span class="lineNum">    4568 </span><span class="lineNoCov">          0 :             cm = kr2m.FindNearest2(ym,zm,kRoadY+fClExtraRoadY,kRoadZ+fClExtraRoadZ,dummy);</span>
<span class="lineNum">    4569 </span><span class="lineNoCov">          0 :             if ((!cm) || (cm-&gt;IsUsed(10))) continue;</span>
<span class="lineNum">    4570 </span>            :           }
<span class="lineNum">    4571 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    4572 </span>            :        
<span class="lineNum">    4573 </span>            :         // Double_t dym = 0;
<span class="lineNum">    4574 </span>            :         // Double_t dzm = 0;
<span class="lineNum">    4575 </span>            :         // if (cm){
<span class="lineNum">    4576 </span>            :         //   dym = ym - cm-&gt;GetY();
<span class="lineNum">    4577 </span>            :         //   dzm = zm - cm-&gt;GetZ();
<span class="lineNum">    4578 </span>            :         // }
<span class="lineNum">    4579 </span><span class="lineNoCov">          0 :         nin2++;</span>
<span class="lineNum">    4580 </span>            : 
<span class="lineNum">    4581 </span>            : 
<span class="lineNum">    4582 </span>            :         //
<span class="lineNum">    4583 </span>            :         //
<span class="lineNum">    4584 </span><span class="lineNoCov">          0 :         Double_t sy1=kr1[is]-&gt;GetSigmaY2()*2., sz1=kr1[is]-&gt;GetSigmaZ2()*2.;</span>
<span class="lineNum">    4585 </span><span class="lineNoCov">          0 :         Double_t sy2=kcl-&gt;GetSigmaY2()*2.,     sz2=kcl-&gt;GetSigmaZ2()*2.;</span>
<span class="lineNum">    4586 </span>            :         //Double_t sy3=400*3./12., sy=0.1, sz=0.1;
<span class="lineNum">    4587 </span><span class="lineNoCov">          0 :         Double_t sy3=25000*x[4]*x[4]+0.1, sy=0.1, sz=0.1;</span>
<span class="lineNum">    4588 </span>            :         //Double_t sy3=25000*x[4]*x[4]*60+0.5, sy=0.1, sz=0.1;
<span class="lineNum">    4589 </span>            : 
<span class="lineNum">    4590 </span><span class="lineNoCov">          0 :         Double_t f40=(F1(x1,y1+sy,x2,y2,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    4591 </span><span class="lineNoCov">          0 :         Double_t f42=(F1(x1,y1,x2,y2+sy,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    4592 </span><span class="lineNoCov">          0 :         Double_t f43=(F1(x1,y1,x2,y2,x3,y3+sy)-x[4])/sy;</span>
<span class="lineNum">    4593 </span><span class="lineNoCov">          0 :         Double_t f20=(F2(x1,y1+sy,x2,y2,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    4594 </span><span class="lineNoCov">          0 :         Double_t f22=(F2(x1,y1,x2,y2+sy,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    4595 </span><span class="lineNoCov">          0 :         Double_t f23=(F2(x1,y1,x2,y2,x3,y3+sy)-x[2])/sy;</span>
<span class="lineNum">    4596 </span>            :         
<span class="lineNum">    4597 </span><span class="lineNoCov">          0 :         Double_t f30=(F3(x1,y1+sy,x2,y2,z1,z2)-x[3])/sy;</span>
<span class="lineNum">    4598 </span><span class="lineNoCov">          0 :         Double_t f31=(F3(x1,y1,x2,y2,z1+sz,z2)-x[3])/sz;</span>
<span class="lineNum">    4599 </span><span class="lineNoCov">          0 :         Double_t f32=(F3(x1,y1,x2,y2+sy,z1,z2)-x[3])/sy;</span>
<span class="lineNum">    4600 </span><span class="lineNoCov">          0 :         Double_t f34=(F3(x1,y1,x2,y2,z1,z2+sz)-x[3])/sz;</span>
<span class="lineNum">    4601 </span>            :         
<span class="lineNum">    4602 </span><span class="lineNoCov">          0 :         c[0]=sy1;</span>
<span class="lineNum">    4603 </span><span class="lineNoCov">          0 :         c[1]=0.;       c[2]=sz1;</span>
<span class="lineNum">    4604 </span><span class="lineNoCov">          0 :         c[3]=f20*sy1;  c[4]=0.;       c[5]=f20*sy1*f20+f22*sy2*f22+f23*sy3*f23;</span>
<span class="lineNum">    4605 </span><span class="lineNoCov">          0 :         c[6]=f30*sy1;  c[7]=f31*sz1;  c[8]=f30*sy1*f20+f32*sy2*f22;</span>
<span class="lineNum">    4606 </span><span class="lineNoCov">          0 :                        c[9]=f30*sy1*f30+f31*sz1*f31+f32*sy2*f32+f34*sz2*f34;</span>
<span class="lineNum">    4607 </span><span class="lineNoCov">          0 :         c[10]=f40*sy1; c[11]=0.; c[12]=f40*sy1*f20+f42*sy2*f22+f43*sy3*f23;</span>
<span class="lineNum">    4608 </span><span class="lineNoCov">          0 :         c[13]=f30*sy1*f40+f32*sy2*f42;</span>
<span class="lineNum">    4609 </span><span class="lineNoCov">          0 :         c[14]=f40*sy1*f40+f42*sy2*f42+f43*sy3*f43;</span>
<span class="lineNum">    4610 </span>            :         
<span class="lineNum">    4611 </span>            :         //      if (!BuildSeed(kr1[is],kcl,0,x1,x2,x3,x,c)) continue;
<span class="lineNum">    4612 </span>            :         
<span class="lineNum">    4613 </span><span class="lineNoCov">          0 :         UInt_t index=kr1.GetIndex(is);</span>
<span class="lineNum">    4614 </span><span class="lineNoCov">          0 :         if (seed) {MarkSeedFree(seed); seed = 0;}</span>
<span class="lineNum">    4615 </span><span class="lineNoCov">          0 :         AliTPCseed *track = seed = new( NextFreeSeed() ) AliTPCseed(x1, ns*alpha+shift, x, c, index);</span>
<span class="lineNum">    4616 </span><span class="lineNoCov">          0 :         seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    4617 </span><span class="lineNoCov">          0 :         seed-&gt;SetRow(i1); //RS: memorise current row</span>
<span class="lineNum">    4618 </span><span class="lineNoCov">          0 :         track-&gt;SetIsSeeding(kTRUE);</span>
<span class="lineNum">    4619 </span><span class="lineNoCov">          0 :         track-&gt;SetSeed1(i1);</span>
<span class="lineNum">    4620 </span><span class="lineNoCov">          0 :         track-&gt;SetSeed2(i2);</span>
<span class="lineNum">    4621 </span><span class="lineNoCov">          0 :         track-&gt;SetSeedType(3);</span>
<span class="lineNum">    4622 </span>            : 
<span class="lineNum">    4623 </span>            :        
<span class="lineNum">    4624 </span>            :         //if (dsec==0) {
<span class="lineNum">    4625 </span><span class="lineNoCov">          0 :           FollowProlongation(*track, (i1+i2)/2,1);</span>
<span class="lineNum">    4626 </span><span class="lineNoCov">          0 :           Int_t foundable,found,shared;</span>
<span class="lineNum">    4627 </span><span class="lineNoCov">          0 :           GetSeedClusterStatistic(track,(i1+i2)/2,i1, found, foundable, shared, kTRUE); //RS: seeds don't keep their clusters</span>
<span class="lineNum">    4628 </span>            :           //RS track-&gt;GetClusterStatistic((i1+i2)/2,i1, found, foundable, shared, kTRUE);
<span class="lineNum">    4629 </span><span class="lineNoCov">          0 :           if ((found&lt;0.55*foundable)  || shared&gt;0.5*found) {</span>
<span class="lineNum">    4630 </span>            :             //RS: with distortions related cluster errors the track error may grow, don't use this cut
<span class="lineNum">    4631 </span>            :             //|| (track-&gt;GetSigmaY2()+track-&gt;GetSigmaZ2())&gt;0.5){
<span class="lineNum">    4632 </span><span class="lineNoCov">          0 :             MarkSeedFree(seed); seed = 0;</span>
<span class="lineNum">    4633 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    4634 </span>            :           }
<span class="lineNum">    4635 </span>            :           //}
<span class="lineNum">    4636 </span>            :         
<span class="lineNum">    4637 </span><span class="lineNoCov">          0 :         nin++;</span>
<span class="lineNum">    4638 </span><span class="lineNoCov">          0 :         FollowProlongation(*track, i2,1);</span>
<span class="lineNum">    4639 </span>            :         
<span class="lineNum">    4640 </span>            :         
<span class="lineNum">    4641 </span>            :         //Int_t rc = 1;
<span class="lineNum">    4642 </span><span class="lineNoCov">          0 :         track-&gt;SetBConstrain(1);</span>
<span class="lineNum">    4643 </span>            :         //      track-&gt;fLastPoint = i1+fInnerSec-&gt;GetNRows();  // first cluster in track position
<span class="lineNum">    4644 </span><span class="lineNoCov">          0 :         track-&gt;SetLastPoint(i1);  // first cluster in track position</span>
<span class="lineNum">    4645 </span><span class="lineNoCov">          0 :         track-&gt;SetFirstPoint(track-&gt;GetLastPoint());</span>
<span class="lineNum">    4646 </span>            :         
<span class="lineNum">    4647 </span><span class="lineNoCov">          0 :         if (track-&gt;GetNumberOfClusters()&lt;(i1-i2)*0.5 || </span>
<span class="lineNum">    4648 </span><span class="lineNoCov">          0 :             track-&gt;GetNumberOfClusters() &lt; track-&gt;GetNFoundable()*0.6 || </span>
<span class="lineNum">    4649 </span><span class="lineNoCov">          0 :             track-&gt;GetNShared()&gt;0.4*track-&gt;GetNumberOfClusters() ) {</span>
<span class="lineNum">    4650 </span><span class="lineNoCov">          0 :           MarkSeedFree(seed); seed = 0;</span>
<span class="lineNum">    4651 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">    4652 </span>            :         }
<span class="lineNum">    4653 </span><span class="lineNoCov">          0 :         nout1++;</span>
<span class="lineNum">    4654 </span><span class="lineNoCov">          0 :         Double_t zv, bz=GetBz();</span>
<span class="lineNum">    4655 </span><span class="lineNoCov">          0 :         if ( !track-&gt;GetZAt(0.,bz,zv) )       { MarkSeedFree( seed ); seed = 0; continue; }</span>
<span class="lineNum">    4656 </span>            :         //
<span class="lineNum">    4657 </span><span class="lineNoCov">          0 :         if (fDisableSecondaries) {</span>
<span class="lineNum">    4658 </span><span class="lineNoCov">          0 :           if (TMath::Abs(zv)&gt;fPrimaryDCAZCut) { MarkSeedFree( seed ); seed = 0; continue; }</span>
<span class="lineNum">    4659 </span><span class="lineNoCov">          0 :           double yv; </span>
<span class="lineNum">    4660 </span><span class="lineNoCov">          0 :           if ( !track-&gt;GetZAt(0.,bz,yv) )     { MarkSeedFree( seed ); seed = 0; continue; }</span>
<span class="lineNum">    4661 </span><span class="lineNoCov">          0 :           if (TMath::Abs(zv)&gt;fPrimaryDCAZCut) { MarkSeedFree( seed ); seed = 0; continue; }</span>
<span class="lineNum">    4662 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    4663 </span>            :         
<span class="lineNum">    4664 </span>            :         //
<span class="lineNum">    4665 </span>            :         // Z VERTEX CONDITION
<span class="lineNum">    4666 </span><span class="lineNoCov">          0 :         if (TMath::Abs(zv-z3)&gt;cuts[2]) {</span>
<span class="lineNum">    4667 </span><span class="lineNoCov">          0 :           FollowProlongation(*track, TMath::Max(i2-20,0));</span>
<span class="lineNum">    4668 </span><span class="lineNoCov">          0 :           if ( !track-&gt;GetZAt(0.,bz,zv) ) continue;</span>
<span class="lineNum">    4669 </span><span class="lineNoCov">          0 :           if (TMath::Abs(zv-z3)&gt;cuts[2]){</span>
<span class="lineNum">    4670 </span><span class="lineNoCov">          0 :             FollowProlongation(*track, TMath::Max(i2-40,0));</span>
<span class="lineNum">    4671 </span><span class="lineNoCov">          0 :             if ( !track-&gt;GetZAt(0.,bz,zv) ) continue;</span>
<span class="lineNum">    4672 </span><span class="lineNoCov">          0 :             if (TMath::Abs(zv-z3)&gt;cuts[2] &amp;&amp;(track-&gt;GetNumberOfClusters() &gt; track-&gt;GetNFoundable()*0.7)){</span>
<span class="lineNum">    4673 </span>            :               // make seed without constrain
<span class="lineNum">    4674 </span><span class="lineNoCov">          0 :               AliTPCseed * track2 = MakeSeed(track,0.2,0.5,1.);</span>
<span class="lineNum">    4675 </span><span class="lineNoCov">          0 :               FollowProlongation(*track2, i2,1);</span>
<span class="lineNum">    4676 </span><span class="lineNoCov">          0 :               track2-&gt;SetBConstrain(kFALSE);</span>
<span class="lineNum">    4677 </span><span class="lineNoCov">          0 :               track2-&gt;SetSeedType(1);</span>
<span class="lineNum">    4678 </span><span class="lineNoCov">          0 :               arr-&gt;AddLast(track2); </span>
<span class="lineNum">    4679 </span><span class="lineNoCov">          0 :               MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    4680 </span>            :               continue;         
<span class="lineNum">    4681 </span>            :             }
<span class="lineNum">    4682 </span>            :             else{
<span class="lineNum">    4683 </span><span class="lineNoCov">          0 :               MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    4684 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">    4685 </span>            :             
<span class="lineNum">    4686 </span>            :             }
<span class="lineNum">    4687 </span>            :           }
<span class="lineNum">    4688 </span>            :         }
<span class="lineNum">    4689 </span>            :       
<span class="lineNum">    4690 </span><span class="lineNoCov">          0 :         track-&gt;SetSeedType(0);</span>
<span class="lineNum">    4691 </span><span class="lineNoCov">          0 :         arr-&gt;AddLast(track); // note, track is seed, don't free the seed</span>
<span class="lineNum">    4692 </span><span class="lineNoCov">          0 :         seed = new( NextFreeSeed() ) AliTPCseed;        </span>
<span class="lineNum">    4693 </span><span class="lineNoCov">          0 :         seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    4694 </span><span class="lineNoCov">          0 :         nout2++;</span>
<span class="lineNum">    4695 </span>            :         // don't consider other combinations
<span class="lineNum">    4696 </span><span class="lineNoCov">          0 :         if (track-&gt;GetNumberOfClusters() &gt; track-&gt;GetNFoundable()*0.8)</span>
<span class="lineNum">    4697 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    4698 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4699 </span>            :     }
<span class="lineNum">    4700 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    4701 </span><span class="lineNoCov">          0 :   if (fDebug&gt;3){</span>
<span class="lineNum">    4702 </span><span class="lineNoCov">          0 :     Info(&quot;MakeSeeds3Dist&quot;,&quot;\nSeeding statistic:\t%d\t%d\t%d\t%d\t%d\t%d&quot;,nin0,nin1,nin2,nin,nout1,nout2);</span>
<span class="lineNum">    4703 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    4704 </span><span class="lineNoCov">          0 :   if (seed) MarkSeedFree( seed );</span>
<span class="lineNum">    4705 </span><span class="lineNoCov">          0 : }</span>
<a name="4706"><span class="lineNum">    4706 </span>            : </a>
<span class="lineNum">    4707 </span>            : 
<span class="lineNum">    4708 </span>            : void AliTPCtracker::MakeSeeds5(TObjArray * arr, Int_t sec, Int_t i1, Int_t i2,  Float_t cuts[4],
<span class="lineNum">    4709 </span>            :                                  Float_t deltay) {
<span class="lineNum">    4710 </span>            :   
<span class="lineNum">    4711 </span>            : 
<span class="lineNum">    4712 </span>            : 
<span class="lineNum">    4713 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4714 </span>            :   // This function creates track seeds.
<span class="lineNum">    4715 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4716 </span>            :   // cuts[0]   - fP4 cut
<span class="lineNum">    4717 </span>            :   // cuts[1]   - tan(phi)  cut
<span class="lineNum">    4718 </span>            :   // cuts[2]   - zvertex cut
<span class="lineNum">    4719 </span>            :   // cuts[3]   - fP3 cut
<span class="lineNum">    4720 </span>            : 
<span class="lineNum">    4721 </span>            : 
<span class="lineNum">    4722 </span>            :   Int_t nin0  = 0;
<span class="lineNum">    4723 </span>            :   Int_t nin1  = 0;
<span class="lineNum">    4724 </span>            :   Int_t nin2  = 0;
<span class="lineNum">    4725 </span>            :   Int_t nin   = 0;
<span class="lineNum">    4726 </span>            :   Int_t nout1 = 0;
<span class="lineNum">    4727 </span>            :   Int_t nout2 = 0;
<span class="lineNum">    4728 </span>            :   Int_t nout3 =0;
<span class="lineNum">    4729 </span><span class="lineCov">      12672 :   Double_t x[5], c[15];</span>
<span class="lineNum">    4730 </span>            :   //
<span class="lineNum">    4731 </span>            :   // make temporary seed
<span class="lineNum">    4732 </span><span class="lineCov">       6336 :   AliTPCseed * seed = new( NextFreeSeed() ) AliTPCseed;</span>
<span class="lineNum">    4733 </span><span class="lineCov">       6336 :   seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    4734 </span><span class="lineCov">       6336 :   Double_t alpha=fOuterSec-&gt;GetAlpha(), shift=fOuterSec-&gt;GetAlphaShift();</span>
<span class="lineNum">    4735 </span>            :   //  Double_t cs=cos(alpha), sn=sin(alpha);
<span class="lineNum">    4736 </span>            :   //
<span class="lineNum">    4737 </span>            :   //
<span class="lineNum">    4738 </span>            : 
<span class="lineNum">    4739 </span>            :   // first 3 padrows
<span class="lineNum">    4740 </span><span class="lineCov">       6336 :   Double_t x1 = GetXrow(i1-1);</span>
<span class="lineNum">    4741 </span><span class="lineCov">       6336 :   const    AliTPCtrackerRow&amp; kr1=GetRow(sec,i1-1);</span>
<span class="lineNum">    4742 </span><span class="lineCov">       6336 :   Double_t y1max  = GetMaxY(i1-1)-kr1.GetDeadZone()-1.5;  </span>
<span class="lineNum">    4743 </span>            :   //
<span class="lineNum">    4744 </span><span class="lineCov">       6336 :   Double_t x1p = GetXrow(i1);</span>
<span class="lineNum">    4745 </span><span class="lineCov">       6336 :   const    AliTPCtrackerRow&amp; kr1p=GetRow(sec,i1);</span>
<span class="lineNum">    4746 </span>            :   //
<span class="lineNum">    4747 </span><span class="lineCov">       6336 :   Double_t x1m = GetXrow(i1-2);</span>
<span class="lineNum">    4748 </span><span class="lineCov">       6336 :   const    AliTPCtrackerRow&amp; kr1m=GetRow(sec,i1-2);</span>
<span class="lineNum">    4749 </span>            : 
<span class="lineNum">    4750 </span>            :   //
<span class="lineNum">    4751 </span>            :   //last 3 padrow for seeding
<span class="lineNum">    4752 </span><span class="lineCov">       6336 :   AliTPCtrackerRow&amp;  kr3  = GetRow((sec+fkNOS)%fkNOS,i1-7);</span>
<span class="lineNum">    4753 </span><span class="lineCov">       6336 :   Double_t    x3   =  GetXrow(i1-7);</span>
<span class="lineNum">    4754 </span>            :   //  Double_t    y3max= GetMaxY(i1-7)-kr3.fDeadZone-1.5;  
<span class="lineNum">    4755 </span>            :   //
<span class="lineNum">    4756 </span><span class="lineCov">       6336 :   AliTPCtrackerRow&amp;  kr3p  = GetRow((sec+fkNOS)%fkNOS,i1-6);</span>
<span class="lineNum">    4757 </span><span class="lineCov">       6336 :   Double_t    x3p   = GetXrow(i1-6);</span>
<span class="lineNum">    4758 </span>            :   //
<span class="lineNum">    4759 </span><span class="lineCov">       6336 :   AliTPCtrackerRow&amp;  kr3m  = GetRow((sec+fkNOS)%fkNOS,i1-8);</span>
<span class="lineNum">    4760 </span><span class="lineCov">       6336 :   Double_t    x3m   = GetXrow(i1-8);</span>
<span class="lineNum">    4761 </span>            : 
<span class="lineNum">    4762 </span>            :   //
<span class="lineNum">    4763 </span>            :   //
<span class="lineNum">    4764 </span>            :   // middle padrow
<span class="lineNum">    4765 </span><span class="lineCov">       6336 :   Int_t im = i1-4;                           //middle pad row index</span>
<span class="lineNum">    4766 </span><span class="lineCov">       6336 :   Double_t xm         = GetXrow(im);         // radius of middle pad-row</span>
<span class="lineNum">    4767 </span><span class="lineCov">       6336 :   const AliTPCtrackerRow&amp; krm=GetRow(sec,im);   //middle pad -row</span>
<span class="lineNum">    4768 </span>            :   //  Double_t ymmax = GetMaxY(im)-kr1.fDeadZone-1.5;  
<span class="lineNum">    4769 </span>            :   //
<span class="lineNum">    4770 </span>            :   //
<span class="lineNum">    4771 </span><span class="lineCov">       6336 :   Double_t deltax  = x1-x3;</span>
<span class="lineNum">    4772 </span><span class="lineCov">       6336 :   Double_t dymax   = deltax*cuts[1];</span>
<span class="lineNum">    4773 </span><span class="lineCov">       6336 :   Double_t dzmax   = deltax*cuts[3];</span>
<span class="lineNum">    4774 </span>            :   //
<span class="lineNum">    4775 </span>            :   // loop over clusters  
<span class="lineNum">    4776 </span><span class="lineCov">      32240 :   for (Int_t is=0; is &lt; kr1; is++) {</span>
<span class="lineNum">    4777 </span>            :     //
<span class="lineNum">    4778 </span><span class="lineCov">       9784 :     if (kr1[is]-&gt;IsUsed(10)) continue;       </span>
<span class="lineNum">    4779 </span><span class="lineCov">       5284 :     if (kr1[is]-&gt;IsDisabled()) {</span>
<span class="lineNum">    4780 </span>            :       continue;
<span class="lineNum">    4781 </span>            :     }
<span class="lineNum">    4782 </span>            : 
<span class="lineNum">    4783 </span><span class="lineCov">       5284 :     Double_t y1=kr1[is]-&gt;GetY(), z1=kr1[is]-&gt;GetZ();    </span>
<span class="lineNum">    4784 </span>            :     //
<span class="lineNum">    4785 </span><span class="lineCov">       7728 :     if (deltay&gt;0 &amp;&amp; TMath::Abs(y1max-TMath::Abs(y1))&gt; deltay ) continue;  // seed only at the edge    </span>
<span class="lineNum">    4786 </span>            :     // 
<span class="lineNum">    4787 </span><span class="lineCov">       4354 :     Int_t  index1 = TMath::Max(kr3.Find(z1-dzmax)-1,0);</span>
<span class="lineNum">    4788 </span><span class="lineCov">       4354 :     Int_t  index2 = TMath::Min(kr3.Find(z1+dzmax)+1,kr3);</span>
<span class="lineNum">    4789 </span>            :     //    
<span class="lineNum">    4790 </span>            :     Double_t y3,   z3;
<span class="lineNum">    4791 </span>            :     //
<span class="lineNum">    4792 </span>            :     //
<span class="lineNum">    4793 </span><span class="lineCov">       4354 :     UInt_t index;</span>
<span class="lineNum">    4794 </span><span class="lineCov">      27000 :     for (Int_t js=index1; js &lt; index2; js++) {</span>
<span class="lineNum">    4795 </span><span class="lineCov">       9146 :       const AliTPCclusterMI *kcl = kr3[js];</span>
<span class="lineNum">    4796 </span><span class="lineCov">       9146 :       if (kcl-&gt;IsDisabled()) {</span>
<span class="lineNum">    4797 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    4798 </span>            :       }
<span class="lineNum">    4799 </span>            : 
<span class="lineNum">    4800 </span><span class="lineCov">      11272 :       if (kcl-&gt;IsUsed(10)) continue;</span>
<span class="lineNum">    4801 </span><span class="lineCov">       7020 :       y3 = kcl-&gt;GetY(); </span>
<span class="lineNum">    4802 </span>            :       // apply angular cuts
<span class="lineNum">    4803 </span><span class="lineCov">       8114 :       if (TMath::Abs(y1-y3)&gt;dymax) continue;</span>
<span class="lineNum">    4804 </span>            :       //x3 = x3; 
<span class="lineNum">    4805 </span><span class="lineCov">       5926 :       z3 = kcl-&gt;GetZ();      </span>
<span class="lineNum">    4806 </span><span class="lineCov">       8278 :       if (TMath::Abs(z1-z3)&gt;dzmax) continue;</span>
<span class="lineNum">    4807 </span>            :       //
<span class="lineNum">    4808 </span><span class="lineCov">       3574 :       Double_t angley = (y1-y3)/(x1-x3);</span>
<span class="lineNum">    4809 </span><span class="lineCov">       3574 :       Double_t anglez = (z1-z3)/(x1-x3);</span>
<span class="lineNum">    4810 </span>            :       //
<span class="lineNum">    4811 </span><span class="lineCov">       3574 :       Double_t erry = TMath::Abs(angley)*(x1-x1m)*0.5+0.5;</span>
<span class="lineNum">    4812 </span><span class="lineCov">       3574 :       Double_t errz = TMath::Abs(anglez)*(x1-x1m)*0.5+0.5;</span>
<span class="lineNum">    4813 </span>            :       //
<span class="lineNum">    4814 </span><span class="lineCov">       3574 :       Double_t yyym = angley*(xm-x1)+y1;</span>
<span class="lineNum">    4815 </span><span class="lineCov">       3574 :       Double_t zzzm = anglez*(xm-x1)+z1;</span>
<span class="lineNum">    4816 </span>            : 
<span class="lineNum">    4817 </span><span class="lineCov">       3574 :       const AliTPCclusterMI *kcm = krm.FindNearest2(yyym,zzzm,erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    4818 </span><span class="lineCov">       6566 :       if (!kcm) continue;</span>
<span class="lineNum">    4819 </span><span class="lineCov">        590 :       if (kcm-&gt;IsUsed(10)) continue;</span>
<span class="lineNum">    4820 </span><span class="lineCov">        574 :       if (kcm-&gt;IsDisabled()) {</span>
<span class="lineNum">    4821 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    4822 </span>            :       }
<span class="lineNum">    4823 </span>            : 
<span class="lineNum">    4824 </span><span class="lineCov">        574 :       erry = TMath::Abs(angley)*(x1-x1m)*0.4+0.5;</span>
<span class="lineNum">    4825 </span><span class="lineCov">        574 :       errz = TMath::Abs(anglez)*(x1-x1m)*0.4+0.5;</span>
<span class="lineNum">    4826 </span>            :       //
<span class="lineNum">    4827 </span>            :       //
<span class="lineNum">    4828 </span>            :       //
<span class="lineNum">    4829 </span>            :       Int_t used  =0;
<span class="lineNum">    4830 </span>            :       Int_t found =0;
<span class="lineNum">    4831 </span>            :       //
<span class="lineNum">    4832 </span>            :       // look around first
<span class="lineNum">    4833 </span><span class="lineCov">       1148 :       const AliTPCclusterMI *kc1m = kr1m.FindNearest2(angley*(x1m-x1)+y1,</span>
<span class="lineNum">    4834 </span><span class="lineCov">        574 :                                                       anglez*(x1m-x1)+z1,</span>
<span class="lineNum">    4835 </span><span class="lineCov">        574 :                                                       erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    4836 </span>            :       //
<span class="lineNum">    4837 </span><span class="lineCov">        574 :       if (kc1m){</span>
<span class="lineNum">    4838 </span>            :         found++;
<span class="lineNum">    4839 </span><span class="lineCov">        460 :         if (kc1m-&gt;IsUsed(10)) used++;</span>
<span class="lineNum">    4840 </span>            :       }
<span class="lineNum">    4841 </span><span class="lineCov">       1148 :       const AliTPCclusterMI *kc1p = kr1p.FindNearest2(angley*(x1p-x1)+y1,</span>
<span class="lineNum">    4842 </span><span class="lineCov">        574 :                                                       anglez*(x1p-x1)+z1,</span>
<span class="lineNum">    4843 </span><span class="lineCov">        574 :                                                       erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    4844 </span>            :       //
<span class="lineNum">    4845 </span><span class="lineCov">        574 :       if (kc1p){</span>
<span class="lineNum">    4846 </span><span class="lineCov">        354 :         found++;</span>
<span class="lineNum">    4847 </span><span class="lineCov">        354 :         if (kc1p-&gt;IsUsed(10)) used++;</span>
<span class="lineNum">    4848 </span>            :       }
<span class="lineNum">    4849 </span><span class="lineCov">        574 :       if (used&gt;1)  continue;</span>
<span class="lineNum">    4850 </span><span class="lineCov">        672 :       if (found&lt;1) continue; </span>
<span class="lineNum">    4851 </span>            : 
<span class="lineNum">    4852 </span>            :       //
<span class="lineNum">    4853 </span>            :       // look around last
<span class="lineNum">    4854 </span><span class="lineCov">        952 :       const AliTPCclusterMI *kc3m = kr3m.FindNearest2(angley*(x3m-x3)+y3,</span>
<span class="lineNum">    4855 </span><span class="lineCov">        476 :                                                       anglez*(x3m-x3)+z3,</span>
<span class="lineNum">    4856 </span><span class="lineCov">        476 :                                                       erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    4857 </span>            :       //
<span class="lineNum">    4858 </span><span class="lineCov">        476 :       if (kc3m){</span>
<span class="lineNum">    4859 </span><span class="lineCov">        348 :         found++;</span>
<span class="lineNum">    4860 </span><span class="lineCov">        348 :         if (kc3m-&gt;IsUsed(10)) used++;</span>
<span class="lineNum">    4861 </span>            :       }
<span class="lineNum">    4862 </span>            :       else 
<span class="lineNum">    4863 </span><span class="lineCov">        128 :         continue;</span>
<span class="lineNum">    4864 </span><span class="lineCov">        696 :       const AliTPCclusterMI *kc3p = kr3p.FindNearest2(angley*(x3p-x3)+y3,</span>
<span class="lineNum">    4865 </span><span class="lineCov">        348 :                                                       anglez*(x3p-x3)+z3,</span>
<span class="lineNum">    4866 </span><span class="lineCov">        348 :                                                       erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    4867 </span>            :       //
<span class="lineNum">    4868 </span><span class="lineCov">        348 :       if (kc3p){</span>
<span class="lineNum">    4869 </span><span class="lineCov">        334 :         found++;</span>
<span class="lineNum">    4870 </span><span class="lineCov">        334 :         if (kc3p-&gt;IsUsed(10)) used++;</span>
<span class="lineNum">    4871 </span>            :       }
<span class="lineNum">    4872 </span>            :       else 
<span class="lineNum">    4873 </span><span class="lineCov">         14 :         continue;</span>
<span class="lineNum">    4874 </span><span class="lineCov">        334 :       if (used&gt;1)  continue;</span>
<span class="lineNum">    4875 </span><span class="lineCov">        334 :       if (found&lt;3) continue;       </span>
<span class="lineNum">    4876 </span>            :       //
<span class="lineNum">    4877 </span>            :       Double_t x2,y2,z2;
<span class="lineNum">    4878 </span>            :       x2 = xm;
<span class="lineNum">    4879 </span><span class="lineCov">        334 :       y2 = kcm-&gt;GetY();</span>
<span class="lineNum">    4880 </span><span class="lineCov">        334 :       z2 = kcm-&gt;GetZ();</span>
<span class="lineNum">    4881 </span>            :       //
<span class="lineNum">    4882 </span>            :                         
<span class="lineNum">    4883 </span><span class="lineCov">        334 :       x[0]=y1;</span>
<span class="lineNum">    4884 </span><span class="lineCov">        334 :       x[1]=z1;</span>
<span class="lineNum">    4885 </span><span class="lineCov">        334 :       x[4]=F1(x1,y1,x2,y2,x3,y3);</span>
<span class="lineNum">    4886 </span>            :       //if (TMath::Abs(x[4]) &gt;= cuts[0]) continue;
<span class="lineNum">    4887 </span><span class="lineCov">        334 :       nin0++;</span>
<span class="lineNum">    4888 </span>            :       //
<span class="lineNum">    4889 </span><span class="lineCov">        334 :       x[2]=F2(x1,y1,x2,y2,x3,y3);</span>
<span class="lineNum">    4890 </span><span class="lineCov">        334 :       nin1++;</span>
<span class="lineNum">    4891 </span>            :       //
<span class="lineNum">    4892 </span><span class="lineCov">        334 :       x[3]=F3n(x1,y1,x2,y2,z1,z2,x[4]);</span>
<span class="lineNum">    4893 </span>            :       //if (TMath::Abs(x[3]) &gt; cuts[3]) continue;
<span class="lineNum">    4894 </span><span class="lineCov">        334 :       nin2++;</span>
<span class="lineNum">    4895 </span>            :       //
<span class="lineNum">    4896 </span>            :       //
<span class="lineNum">    4897 </span>            :       Double_t sy1=0.1,  sz1=0.1;
<span class="lineNum">    4898 </span>            :       Double_t sy2=0.1,  sz2=0.1;
<span class="lineNum">    4899 </span>            :       Double_t sy3=0.1,  sy=0.1, sz=0.1;
<span class="lineNum">    4900 </span>            :       
<span class="lineNum">    4901 </span><span class="lineCov">        334 :       Double_t f40=(F1(x1,y1+sy,x2,y2,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    4902 </span><span class="lineCov">        334 :       Double_t f42=(F1(x1,y1,x2,y2+sy,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    4903 </span><span class="lineCov">        334 :       Double_t f43=(F1(x1,y1,x2,y2,x3,y3+sy)-x[4])/sy;</span>
<span class="lineNum">    4904 </span><span class="lineCov">        334 :       Double_t f20=(F2(x1,y1+sy,x2,y2,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    4905 </span><span class="lineCov">        334 :       Double_t f22=(F2(x1,y1,x2,y2+sy,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    4906 </span><span class="lineCov">        334 :       Double_t f23=(F2(x1,y1,x2,y2,x3,y3+sy)-x[2])/sy;</span>
<span class="lineNum">    4907 </span>            :       
<span class="lineNum">    4908 </span><span class="lineCov">        334 :       Double_t f30=(F3(x1,y1+sy,x2,y2,z1,z2)-x[3])/sy;</span>
<span class="lineNum">    4909 </span><span class="lineCov">        334 :       Double_t f31=(F3(x1,y1,x2,y2,z1+sz,z2)-x[3])/sz;</span>
<span class="lineNum">    4910 </span><span class="lineCov">        334 :       Double_t f32=(F3(x1,y1,x2,y2+sy,z1,z2)-x[3])/sy;</span>
<span class="lineNum">    4911 </span><span class="lineCov">        334 :       Double_t f34=(F3(x1,y1,x2,y2,z1,z2+sz)-x[3])/sz;</span>
<span class="lineNum">    4912 </span>            :       
<span class="lineNum">    4913 </span><span class="lineCov">        334 :       c[0]=sy1;</span>
<span class="lineNum">    4914 </span><span class="lineCov">        334 :       c[1]=0.;       c[2]=sz1; </span>
<span class="lineNum">    4915 </span><span class="lineCov">        334 :       c[3]=f20*sy1;  c[4]=0.;       c[5]=f20*sy1*f20+f22*sy2*f22+f23*sy3*f23;</span>
<span class="lineNum">    4916 </span><span class="lineCov">        334 :       c[6]=f30*sy1;  c[7]=f31*sz1;  c[8]=f30*sy1*f20+f32*sy2*f22;</span>
<span class="lineNum">    4917 </span><span class="lineCov">        334 :       c[9]=f30*sy1*f30+f31*sz1*f31+f32*sy2*f32+f34*sz2*f34;</span>
<span class="lineNum">    4918 </span><span class="lineCov">        334 :       c[10]=f40*sy1; c[11]=0.; c[12]=f40*sy1*f20+f42*sy2*f22+f43*sy3*f23;</span>
<span class="lineNum">    4919 </span><span class="lineCov">        334 :       c[13]=f30*sy1*f40+f32*sy2*f42;</span>
<span class="lineNum">    4920 </span><span class="lineCov">        334 :       c[14]=f40*sy1*f40+f42*sy2*f42+f43*sy3*f43;</span>
<span class="lineNum">    4921 </span>            :       
<span class="lineNum">    4922 </span>            :       //        if (!BuildSeed(kr1[is],kcl,0,x1,x2,x3,x,c)) continue;
<span class="lineNum">    4923 </span>            :       
<span class="lineNum">    4924 </span><span class="lineCov">        334 :       index=kr1.GetIndex(is);</span>
<span class="lineNum">    4925 </span><span class="lineCov">        504 :       if (seed) {MarkSeedFree( seed ); seed = 0;}</span>
<span class="lineNum">    4926 </span><span class="lineCov">        334 :       AliTPCseed *track = seed = new( NextFreeSeed() ) AliTPCseed(x1, sec*alpha+shift, x, c, index);</span>
<span class="lineNum">    4927 </span><span class="lineCov">        334 :       seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    4928 </span><span class="lineCov">        334 :       seed-&gt;SetRow(i1-1); //RS: memorise current row      </span>
<span class="lineNum">    4929 </span><span class="lineCov">        334 :       track-&gt;SetIsSeeding(kTRUE);</span>
<span class="lineNum">    4930 </span>            : 
<span class="lineNum">    4931 </span><span class="lineCov">        334 :       nin++;      </span>
<span class="lineNum">    4932 </span><span class="lineCov">        334 :       FollowProlongation(*track, i1-7,1);</span>
<span class="lineNum">    4933 </span><span class="lineCov">        640 :       if (track-&gt;GetNumberOfClusters() &lt; track-&gt;GetNFoundable()*0.75 || </span>
<span class="lineNum">    4934 </span><span class="lineCov">        612 :           track-&gt;GetNShared()&gt;0.6*track-&gt;GetNumberOfClusters() || ( track-&gt;GetSigmaY2()+ track-&gt;GetSigmaZ2())&gt;0.6+fExtraClErrYZ2){</span>
<span class="lineNum">    4935 </span><span class="lineCov">         28 :         MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    4936 </span><span class="lineCov">         28 :         continue;</span>
<span class="lineNum">    4937 </span>            :       }
<span class="lineNum">    4938 </span><span class="lineCov">        306 :       nout1++;</span>
<span class="lineNum">    4939 </span><span class="lineCov">        306 :       nout2++;  </span>
<span class="lineNum">    4940 </span>            :       //Int_t rc = 1;
<span class="lineNum">    4941 </span><span class="lineCov">        306 :       FollowProlongation(*track, i2,1);</span>
<span class="lineNum">    4942 </span><span class="lineCov">        306 :       track-&gt;SetBConstrain(0);</span>
<span class="lineNum">    4943 </span><span class="lineCov">        306 :       track-&gt;SetLastPoint(i1+fInnerSec-&gt;GetNRows());  // first cluster in track position</span>
<span class="lineNum">    4944 </span><span class="lineCov">        306 :       track-&gt;SetFirstPoint(track-&gt;GetLastPoint());</span>
<span class="lineNum">    4945 </span>            :       
<span class="lineNum">    4946 </span><span class="lineCov">        418 :       if (track-&gt;GetNumberOfClusters()&lt;(i1-i2)*0.5 || </span>
<span class="lineNum">    4947 </span><span class="lineCov">        116 :           track-&gt;GetNumberOfClusters()&lt;track-&gt;GetNFoundable()*0.7 || </span>
<span class="lineNum">    4948 </span><span class="lineCov">        336 :           track-&gt;GetNShared()&gt;2. || track-&gt;GetChi2()/track-&gt;GetNumberOfClusters()&gt;6 || ( track-&gt;GetSigmaY2()+ track-&gt;GetSigmaZ2())&gt;0.5+fExtraClErrYZ2) {</span>
<span class="lineNum">    4949 </span><span class="lineCov">        222 :         MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    4950 </span><span class="lineCov">        222 :         continue;</span>
<span class="lineNum">    4951 </span>            :       }
<span class="lineNum">    4952 </span>            :    
<span class="lineNum">    4953 </span>            :       {
<span class="lineNum">    4954 </span><span class="lineCov">         84 :         FollowProlongation(*track, TMath::Max(i2-10,0),1);</span>
<span class="lineNum">    4955 </span><span class="lineCov">         84 :         AliTPCseed * track2 = MakeSeed(track,0.2,0.5,0.9);</span>
<span class="lineNum">    4956 </span><span class="lineCov">         84 :         FollowProlongation(*track2, i2,1);</span>
<span class="lineNum">    4957 </span><span class="lineCov">         84 :         track2-&gt;SetBConstrain(kFALSE);</span>
<span class="lineNum">    4958 </span><span class="lineCov">         84 :         track2-&gt;SetSeedType(4);</span>
<span class="lineNum">    4959 </span><span class="lineCov">         84 :         arr-&gt;AddLast(track2);</span>
<span class="lineNum">    4960 </span><span class="lineCov">         84 :         MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    4961 </span>            :       }
<span class="lineNum">    4962 </span>            :       
<span class="lineNum">    4963 </span>            :    
<span class="lineNum">    4964 </span>            :       //arr-&gt;AddLast(track); 
<span class="lineNum">    4965 </span>            :       //seed = new AliTPCseed;  
<span class="lineNum">    4966 </span><span class="lineCov">         84 :       nout3++;</span>
<span class="lineNum">    4967 </span><span class="lineCov">         84 :     }</span>
<span class="lineNum">    4968 </span><span class="lineCov">       4354 :   }</span>
<span class="lineNum">    4969 </span>            :   
<span class="lineNum">    4970 </span><span class="lineCov">       6336 :   if (fDebug&gt;3){</span>
<span class="lineNum">    4971 </span><span class="lineNoCov">          0 :     Info(&quot;MakeSeeds5&quot;,&quot;\nSeeding statiistic:\t%d\t%d\t%d\t%d\t%d\t%d\t%d&quot;,nin0,nin1,nin2,nin,nout1,nout2,nout3);</span>
<span class="lineNum">    4972 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    4973 </span><span class="lineCov">      12502 :   if (seed) MarkSeedFree(seed);</span>
<a name="4974"><span class="lineNum">    4974 </span><span class="lineCov">       6336 : }</span></a>
<span class="lineNum">    4975 </span>            : 
<span class="lineNum">    4976 </span>            : void AliTPCtracker::MakeSeeds5Dist(TObjArray * arr, Int_t sec, Int_t i1, Int_t i2,  Float_t cuts[4],
<span class="lineNum">    4977 </span>            :                                  Float_t deltay) {
<span class="lineNum">    4978 </span>            :   
<span class="lineNum">    4979 </span>            : 
<span class="lineNum">    4980 </span>            : 
<span class="lineNum">    4981 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4982 </span>            :   // This function creates track seeds, accounting for distortions
<span class="lineNum">    4983 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    4984 </span>            :   // cuts[0]   - fP4 cut
<span class="lineNum">    4985 </span>            :   // cuts[1]   - tan(phi)  cut
<span class="lineNum">    4986 </span>            :   // cuts[2]   - zvertex cut
<span class="lineNum">    4987 </span>            :   // cuts[3]   - fP3 cut
<span class="lineNum">    4988 </span>            : 
<span class="lineNum">    4989 </span>            : 
<span class="lineNum">    4990 </span>            :   Int_t nin0  = 0;
<span class="lineNum">    4991 </span>            :   Int_t nin1  = 0;
<span class="lineNum">    4992 </span>            :   Int_t nin2  = 0;
<span class="lineNum">    4993 </span>            :   Int_t nin   = 0;
<span class="lineNum">    4994 </span>            :   Int_t nout1 = 0;
<span class="lineNum">    4995 </span>            :   Int_t nout2 = 0;
<span class="lineNum">    4996 </span>            :   Int_t nout3 =0;
<span class="lineNum">    4997 </span><span class="lineNoCov">          0 :   Double_t x[5], c[15];</span>
<span class="lineNum">    4998 </span>            :   //
<span class="lineNum">    4999 </span>            :   // make temporary seed
<span class="lineNum">    5000 </span><span class="lineNoCov">          0 :   AliTPCseed * seed = new( NextFreeSeed() ) AliTPCseed;</span>
<span class="lineNum">    5001 </span><span class="lineNoCov">          0 :   seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    5002 </span><span class="lineNoCov">          0 :   Double_t alpha=fOuterSec-&gt;GetAlpha(), shift=fOuterSec-&gt;GetAlphaShift();</span>
<span class="lineNum">    5003 </span>            :   //  Double_t cs=cos(alpha), sn=sin(alpha);
<span class="lineNum">    5004 </span>            :   //
<span class="lineNum">    5005 </span>            :   //
<span class="lineNum">    5006 </span>            : 
<span class="lineNum">    5007 </span>            :   // first 3 padrows
<span class="lineNum">    5008 </span><span class="lineNoCov">          0 :   Double_t x1Def = GetXrow(i1-1);</span>
<span class="lineNum">    5009 </span><span class="lineNoCov">          0 :   const    AliTPCtrackerRow&amp; kr1=GetRow(sec,i1-1);</span>
<span class="lineNum">    5010 </span><span class="lineNoCov">          0 :   Double_t y1max  = GetMaxY(i1-1)-kr1.GetDeadZone()-1.5;  </span>
<span class="lineNum">    5011 </span>            :   //
<span class="lineNum">    5012 </span><span class="lineNoCov">          0 :   Double_t x1pDef = GetXrow(i1);</span>
<span class="lineNum">    5013 </span><span class="lineNoCov">          0 :   const    AliTPCtrackerRow&amp; kr1p=GetRow(sec,i1);</span>
<span class="lineNum">    5014 </span>            :   //
<span class="lineNum">    5015 </span><span class="lineNoCov">          0 :   Double_t x1mDef = GetXrow(i1-2);</span>
<span class="lineNum">    5016 </span><span class="lineNoCov">          0 :   const    AliTPCtrackerRow&amp; kr1m=GetRow(sec,i1-2);</span>
<span class="lineNum">    5017 </span>            : 
<span class="lineNum">    5018 </span><span class="lineNoCov">          0 :   double dx11mDef = x1Def-x1mDef;</span>
<span class="lineNum">    5019 </span><span class="lineNoCov">          0 :   double dx11pDef = x1Def-x1pDef;</span>
<span class="lineNum">    5020 </span>            :   //
<span class="lineNum">    5021 </span>            :   //last 3 padrow for seeding
<span class="lineNum">    5022 </span><span class="lineNoCov">          0 :   AliTPCtrackerRow&amp;  kr3  = GetRow((sec+fkNOS)%fkNOS,i1-7);</span>
<span class="lineNum">    5023 </span><span class="lineNoCov">          0 :   Double_t    x3Def   =  GetXrow(i1-7);</span>
<span class="lineNum">    5024 </span>            :   //
<span class="lineNum">    5025 </span><span class="lineNoCov">          0 :   AliTPCtrackerRow&amp;  kr3p  = GetRow((sec+fkNOS)%fkNOS,i1-6);</span>
<span class="lineNum">    5026 </span><span class="lineNoCov">          0 :   Double_t    x3pDef   = GetXrow(i1-6);</span>
<span class="lineNum">    5027 </span>            :   //
<span class="lineNum">    5028 </span><span class="lineNoCov">          0 :   AliTPCtrackerRow&amp;  kr3m  = GetRow((sec+fkNOS)%fkNOS,i1-8);</span>
<span class="lineNum">    5029 </span><span class="lineNoCov">          0 :   Double_t    x3mDef   = GetXrow(i1-8);</span>
<span class="lineNum">    5030 </span>            : 
<span class="lineNum">    5031 </span>            :   //
<span class="lineNum">    5032 </span><span class="lineNoCov">          0 :   double dx33mDef = x3Def-x3mDef;</span>
<span class="lineNum">    5033 </span><span class="lineNoCov">          0 :   double dx33pDef = x3Def-x3pDef;</span>
<span class="lineNum">    5034 </span>            : 
<span class="lineNum">    5035 </span>            :   //
<span class="lineNum">    5036 </span>            :   // middle padrow
<span class="lineNum">    5037 </span><span class="lineNoCov">          0 :   Int_t im = i1-4;                           //middle pad row index</span>
<span class="lineNum">    5038 </span><span class="lineNoCov">          0 :   Double_t xmDef         = GetXrow(im);         // radius of middle pad-row</span>
<span class="lineNum">    5039 </span><span class="lineNoCov">          0 :   const AliTPCtrackerRow&amp; krm=GetRow(sec,im);   //middle pad -row</span>
<span class="lineNum">    5040 </span>            :   //
<span class="lineNum">    5041 </span>            :   //
<span class="lineNum">    5042 </span><span class="lineNoCov">          0 :   Double_t deltax  = x1Def-x3Def;</span>
<span class="lineNum">    5043 </span><span class="lineNoCov">          0 :   Double_t dymax   = deltax*cuts[1];</span>
<span class="lineNum">    5044 </span><span class="lineNoCov">          0 :   Double_t dzmax   = deltax*cuts[3];</span>
<span class="lineNum">    5045 </span>            :   //
<span class="lineNum">    5046 </span>            :   // loop over clusters  
<span class="lineNum">    5047 </span><span class="lineNoCov">          0 :   for (Int_t is=0; is &lt; kr1; is++) {</span>
<span class="lineNum">    5048 </span>            :     //
<span class="lineNum">    5049 </span><span class="lineNoCov">          0 :     if (kr1[is]-&gt;IsUsed(10)) continue;       </span>
<span class="lineNum">    5050 </span><span class="lineNoCov">          0 :     if (kr1[is]-&gt;IsDisabled()) {</span>
<span class="lineNum">    5051 </span>            :       continue;
<span class="lineNum">    5052 </span>            :     }
<span class="lineNum">    5053 </span><span class="lineNoCov">          0 :     const AliTPCclusterMI* clkr1 = kr1[is];</span>
<span class="lineNum">    5054 </span><span class="lineNoCov">          0 :     Double_t x1=clkr1-&gt;GetX(), y1=clkr1-&gt;GetY(), z1=clkr1-&gt;GetZ();    </span>
<span class="lineNum">    5055 </span>            :     //
<span class="lineNum">    5056 </span>            :     double y1EdgeDist =  y1;
<span class="lineNum">    5057 </span><span class="lineNoCov">          0 :     if  (fAccountDistortions) y1EdgeDist -= GetYSectEdgeDist(sec,i1-1,y1,z1);</span>
<span class="lineNum">    5058 </span><span class="lineNoCov">          0 :     if (deltay&gt;0) {</span>
<span class="lineNum">    5059 </span><span class="lineNoCov">          0 :       double margin = (y1&gt;0 ? y1max-y1EdgeDist : y1max + y1EdgeDist);</span>
<span class="lineNum">    5060 </span><span class="lineNoCov">          0 :       if (margin&lt;deltay ) continue;  // seed only at the edge</span>
<span class="lineNum">    5061 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    5062 </span>            : 
<span class="lineNum">    5063 </span>            :     // 
<span class="lineNum">    5064 </span><span class="lineNoCov">          0 :     Int_t  index1 = TMath::Max(kr3.Find(z1-dzmax)-1,0);</span>
<span class="lineNum">    5065 </span><span class="lineNoCov">          0 :     Int_t  index2 = TMath::Min(kr3.Find(z1+dzmax)+1,kr3);</span>
<span class="lineNum">    5066 </span>            :     //    
<span class="lineNum">    5067 </span>            :     Double_t x3,y3,z3;
<span class="lineNum">    5068 </span>            :     //
<span class="lineNum">    5069 </span>            :     //
<span class="lineNum">    5070 </span><span class="lineNoCov">          0 :     UInt_t index;</span>
<span class="lineNum">    5071 </span><span class="lineNoCov">          0 :     for (Int_t js=index1; js &lt; index2; js++) {</span>
<span class="lineNum">    5072 </span><span class="lineNoCov">          0 :       const AliTPCclusterMI *kcl = kr3[js];</span>
<span class="lineNum">    5073 </span><span class="lineNoCov">          0 :       if (kcl-&gt;IsDisabled()) {</span>
<span class="lineNum">    5074 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5075 </span>            :       }
<span class="lineNum">    5076 </span>            : 
<span class="lineNum">    5077 </span><span class="lineNoCov">          0 :       if (kcl-&gt;IsUsed(10)) continue;</span>
<span class="lineNum">    5078 </span><span class="lineNoCov">          0 :       y3 = kcl-&gt;GetY(); </span>
<span class="lineNum">    5079 </span>            :       // apply angular cuts
<span class="lineNum">    5080 </span><span class="lineNoCov">          0 :       if (TMath::Abs(y1-y3)&gt;dymax) continue;</span>
<span class="lineNum">    5081 </span>            :       //x3 = x3; 
<span class="lineNum">    5082 </span><span class="lineNoCov">          0 :       z3 = kcl-&gt;GetZ();      </span>
<span class="lineNum">    5083 </span><span class="lineNoCov">          0 :       if (TMath::Abs(z1-z3)&gt;dzmax) continue;</span>
<span class="lineNum">    5084 </span>            :       
<span class="lineNum">    5085 </span><span class="lineNoCov">          0 :       x3 = kcl-&gt;GetX();</span>
<span class="lineNum">    5086 </span>            :       //
<span class="lineNum">    5087 </span><span class="lineNoCov">          0 :       double dx13 = x1-x3;</span>
<span class="lineNum">    5088 </span><span class="lineNoCov">          0 :       if (TMath::Abs(dx13)&lt;0.1) {</span>
<span class="lineNum">    5089 </span>            :         //AliErrorF(&quot;Wrong X correction? Sec%d : row%d@X=%.2f-&gt;%.2f (z=%.2f) row%d@X=%.2f-&gt;%.2f (z=%.2f)\n&quot;,sec,
<span class="lineNum">    5090 </span>            :         //        i1-1,x1Def,x1,z1, i1-7,x3Def,x3,z3);
<span class="lineNum">    5091 </span><span class="lineNoCov">          0 :         continue; // distortions should not make distance so small</span>
<span class="lineNum">    5092 </span>            :       }
<span class="lineNum">    5093 </span>            : 
<span class="lineNum">    5094 </span><span class="lineNoCov">          0 :       Double_t angley = (y1-y3)/dx13;</span>
<span class="lineNum">    5095 </span><span class="lineNoCov">          0 :       Double_t anglez = (z1-z3)/dx13;</span>
<span class="lineNum">    5096 </span>            :       //
<span class="lineNum">    5097 </span><span class="lineNoCov">          0 :       Double_t erry = TMath::Abs(angley)*dx11mDef*0.5+0.5; // RS: use ideal X differences assuming</span>
<span class="lineNum">    5098 </span><span class="lineNoCov">          0 :       Double_t errz = TMath::Abs(anglez)*dx11mDef*0.5+0.5; // that the distortions are ~same on close rows</span>
<span class="lineNum">    5099 </span>            :       //
<span class="lineNum">    5100 </span><span class="lineNoCov">          0 :       Double_t yyym = angley*(xmDef-x1Def)+y1; // RS: idem, assume distortions cancels in the difference</span>
<span class="lineNum">    5101 </span><span class="lineNoCov">          0 :       Double_t zzzm = anglez*(xmDef-x1Def)+z1;</span>
<span class="lineNum">    5102 </span>            : 
<span class="lineNum">    5103 </span><span class="lineNoCov">          0 :       const AliTPCclusterMI *kcm = krm.FindNearest2(yyym,zzzm,erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    5104 </span><span class="lineNoCov">          0 :       if (!kcm) continue;</span>
<span class="lineNum">    5105 </span><span class="lineNoCov">          0 :       if (kcm-&gt;IsUsed(10)) continue;</span>
<span class="lineNum">    5106 </span><span class="lineNoCov">          0 :       if (kcm-&gt;IsDisabled()) {</span>
<span class="lineNum">    5107 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5108 </span>            :       }
<span class="lineNum">    5109 </span>            : 
<span class="lineNum">    5110 </span><span class="lineNoCov">          0 :       erry = TMath::Abs(angley)*dx11mDef*0.4+0.5;</span>
<span class="lineNum">    5111 </span><span class="lineNoCov">          0 :       errz = TMath::Abs(anglez)*dx11mDef*0.4+0.5;</span>
<span class="lineNum">    5112 </span>            :       //
<span class="lineNum">    5113 </span>            :       //
<span class="lineNum">    5114 </span>            :       //
<span class="lineNum">    5115 </span>            :       Int_t used  =0;
<span class="lineNum">    5116 </span>            :       Int_t found =0;
<span class="lineNum">    5117 </span>            :       //
<span class="lineNum">    5118 </span>            :       // look around first
<span class="lineNum">    5119 </span><span class="lineNoCov">          0 :       const AliTPCclusterMI *kc1m = kr1m.FindNearest2(-angley*dx11mDef+y1, // RS: idem, assume distortions cancels in the difference</span>
<span class="lineNum">    5120 </span><span class="lineNoCov">          0 :                                                       -anglez*dx11mDef+z1,</span>
<span class="lineNum">    5121 </span><span class="lineNoCov">          0 :                                                       erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    5122 </span>            :       //
<span class="lineNum">    5123 </span><span class="lineNoCov">          0 :       if (kc1m){</span>
<span class="lineNum">    5124 </span>            :         found++;
<span class="lineNum">    5125 </span><span class="lineNoCov">          0 :         if (kc1m-&gt;IsUsed(10)) used++;</span>
<span class="lineNum">    5126 </span>            :       }
<span class="lineNum">    5127 </span><span class="lineNoCov">          0 :       const AliTPCclusterMI *kc1p = kr1p.FindNearest2(-angley*dx11pDef+y1, // RS: idem, assume distortions cancels in the difference</span>
<span class="lineNum">    5128 </span><span class="lineNoCov">          0 :                                                       -anglez*dx11pDef+z1,</span>
<span class="lineNum">    5129 </span><span class="lineNoCov">          0 :                                                       erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    5130 </span>            :       //
<span class="lineNum">    5131 </span><span class="lineNoCov">          0 :       if (kc1p){</span>
<span class="lineNum">    5132 </span><span class="lineNoCov">          0 :         found++;</span>
<span class="lineNum">    5133 </span><span class="lineNoCov">          0 :         if (kc1p-&gt;IsUsed(10)) used++;</span>
<span class="lineNum">    5134 </span>            :       }
<span class="lineNum">    5135 </span><span class="lineNoCov">          0 :       if (used&gt;1)  continue;</span>
<span class="lineNum">    5136 </span><span class="lineNoCov">          0 :       if (found&lt;1) continue; </span>
<span class="lineNum">    5137 </span>            : 
<span class="lineNum">    5138 </span>            :       //
<span class="lineNum">    5139 </span>            :       // look around last
<span class="lineNum">    5140 </span><span class="lineNoCov">          0 :       const AliTPCclusterMI *kc3m = kr3m.FindNearest2(-angley*dx33mDef+y3, // RS: idem, assume distortions cancels in the difference</span>
<span class="lineNum">    5141 </span><span class="lineNoCov">          0 :                                                       -anglez*dx33mDef+z3,</span>
<span class="lineNum">    5142 </span><span class="lineNoCov">          0 :                                                       erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    5143 </span>            :       //
<span class="lineNum">    5144 </span><span class="lineNoCov">          0 :       if (kc3m){</span>
<span class="lineNum">    5145 </span><span class="lineNoCov">          0 :         found++;</span>
<span class="lineNum">    5146 </span><span class="lineNoCov">          0 :         if (kc3m-&gt;IsUsed(10)) used++;</span>
<span class="lineNum">    5147 </span>            :       }
<span class="lineNum">    5148 </span>            :       else 
<span class="lineNum">    5149 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5150 </span><span class="lineNoCov">          0 :       const AliTPCclusterMI *kc3p = kr3p.FindNearest2(-angley*dx33pDef+y3, // RS: idem, assume distortions cancels in the difference</span>
<span class="lineNum">    5151 </span><span class="lineNoCov">          0 :                                                       -anglez*dx33pDef+z3,</span>
<span class="lineNum">    5152 </span><span class="lineNoCov">          0 :                                                       erry+fClExtraRoadY,errz+fClExtraRoadZ,index);</span>
<span class="lineNum">    5153 </span>            :       //
<span class="lineNum">    5154 </span><span class="lineNoCov">          0 :       if (kc3p){</span>
<span class="lineNum">    5155 </span><span class="lineNoCov">          0 :         found++;</span>
<span class="lineNum">    5156 </span><span class="lineNoCov">          0 :         if (kc3p-&gt;IsUsed(10)) used++;</span>
<span class="lineNum">    5157 </span>            :       }
<span class="lineNum">    5158 </span>            :       else 
<span class="lineNum">    5159 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5160 </span><span class="lineNoCov">          0 :       if (used&gt;1)  continue;</span>
<span class="lineNum">    5161 </span><span class="lineNoCov">          0 :       if (found&lt;3) continue;       </span>
<span class="lineNum">    5162 </span>            :       //
<span class="lineNum">    5163 </span>            :       Double_t x2,y2,z2;
<span class="lineNum">    5164 </span><span class="lineNoCov">          0 :       x2 = kcm-&gt;GetX();</span>
<span class="lineNum">    5165 </span><span class="lineNoCov">          0 :       y2 = kcm-&gt;GetY();</span>
<span class="lineNum">    5166 </span><span class="lineNoCov">          0 :       z2 = kcm-&gt;GetZ();</span>
<span class="lineNum">    5167 </span>            :       //
<span class="lineNum">    5168 </span>            :                         
<span class="lineNum">    5169 </span><span class="lineNoCov">          0 :       x[0]=y1;</span>
<span class="lineNum">    5170 </span><span class="lineNoCov">          0 :       x[1]=z1;</span>
<span class="lineNum">    5171 </span><span class="lineNoCov">          0 :       x[4]=F1(x1,y1,x2,y2,x3,y3);</span>
<span class="lineNum">    5172 </span>            :       //if (TMath::Abs(x[4]) &gt;= cuts[0]) continue;
<span class="lineNum">    5173 </span><span class="lineNoCov">          0 :       nin0++;</span>
<span class="lineNum">    5174 </span>            :       //
<span class="lineNum">    5175 </span><span class="lineNoCov">          0 :       x[2]=F2(x1,y1,x2,y2,x3,y3);</span>
<span class="lineNum">    5176 </span><span class="lineNoCov">          0 :       nin1++;</span>
<span class="lineNum">    5177 </span>            :       //
<span class="lineNum">    5178 </span><span class="lineNoCov">          0 :       x[3]=F3n(x1,y1,x2,y2,z1,z2,x[4]);</span>
<span class="lineNum">    5179 </span>            :       //if (TMath::Abs(x[3]) &gt; cuts[3]) continue;
<span class="lineNum">    5180 </span><span class="lineNoCov">          0 :       nin2++;</span>
<span class="lineNum">    5181 </span>            :       //
<span class="lineNum">    5182 </span>            :       //
<span class="lineNum">    5183 </span>            :       Double_t sy1=0.1,  sz1=0.1;
<span class="lineNum">    5184 </span>            :       Double_t sy2=0.1,  sz2=0.1;
<span class="lineNum">    5185 </span>            :       Double_t sy3=0.1,  sy=0.1, sz=0.1;
<span class="lineNum">    5186 </span>            :       
<span class="lineNum">    5187 </span><span class="lineNoCov">          0 :       Double_t f40=(F1(x1,y1+sy,x2,y2,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    5188 </span><span class="lineNoCov">          0 :       Double_t f42=(F1(x1,y1,x2,y2+sy,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    5189 </span><span class="lineNoCov">          0 :       Double_t f43=(F1(x1,y1,x2,y2,x3,y3+sy)-x[4])/sy;</span>
<span class="lineNum">    5190 </span><span class="lineNoCov">          0 :       Double_t f20=(F2(x1,y1+sy,x2,y2,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    5191 </span><span class="lineNoCov">          0 :       Double_t f22=(F2(x1,y1,x2,y2+sy,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    5192 </span><span class="lineNoCov">          0 :       Double_t f23=(F2(x1,y1,x2,y2,x3,y3+sy)-x[2])/sy;</span>
<span class="lineNum">    5193 </span>            :       
<span class="lineNum">    5194 </span><span class="lineNoCov">          0 :       Double_t f30=(F3(x1,y1+sy,x2,y2,z1,z2)-x[3])/sy;</span>
<span class="lineNum">    5195 </span><span class="lineNoCov">          0 :       Double_t f31=(F3(x1,y1,x2,y2,z1+sz,z2)-x[3])/sz;</span>
<span class="lineNum">    5196 </span><span class="lineNoCov">          0 :       Double_t f32=(F3(x1,y1,x2,y2+sy,z1,z2)-x[3])/sy;</span>
<span class="lineNum">    5197 </span><span class="lineNoCov">          0 :       Double_t f34=(F3(x1,y1,x2,y2,z1,z2+sz)-x[3])/sz;</span>
<span class="lineNum">    5198 </span>            :       
<span class="lineNum">    5199 </span><span class="lineNoCov">          0 :       c[0]=sy1;</span>
<span class="lineNum">    5200 </span><span class="lineNoCov">          0 :       c[1]=0.;       c[2]=sz1; </span>
<span class="lineNum">    5201 </span><span class="lineNoCov">          0 :       c[3]=f20*sy1;  c[4]=0.;       c[5]=f20*sy1*f20+f22*sy2*f22+f23*sy3*f23;</span>
<span class="lineNum">    5202 </span><span class="lineNoCov">          0 :       c[6]=f30*sy1;  c[7]=f31*sz1;  c[8]=f30*sy1*f20+f32*sy2*f22;</span>
<span class="lineNum">    5203 </span><span class="lineNoCov">          0 :       c[9]=f30*sy1*f30+f31*sz1*f31+f32*sy2*f32+f34*sz2*f34;</span>
<span class="lineNum">    5204 </span><span class="lineNoCov">          0 :       c[10]=f40*sy1; c[11]=0.; c[12]=f40*sy1*f20+f42*sy2*f22+f43*sy3*f23;</span>
<span class="lineNum">    5205 </span><span class="lineNoCov">          0 :       c[13]=f30*sy1*f40+f32*sy2*f42;</span>
<span class="lineNum">    5206 </span><span class="lineNoCov">          0 :       c[14]=f40*sy1*f40+f42*sy2*f42+f43*sy3*f43;</span>
<span class="lineNum">    5207 </span>            :       
<span class="lineNum">    5208 </span>            :       //        if (!BuildSeed(kr1[is],kcl,0,x1,x2,x3,x,c)) continue;
<span class="lineNum">    5209 </span>            :       
<span class="lineNum">    5210 </span><span class="lineNoCov">          0 :       index=kr1.GetIndex(is);</span>
<span class="lineNum">    5211 </span><span class="lineNoCov">          0 :       if (seed) {MarkSeedFree( seed ); seed = 0;}</span>
<span class="lineNum">    5212 </span><span class="lineNoCov">          0 :       AliTPCseed *track = seed = new( NextFreeSeed() ) AliTPCseed(x1, sec*alpha+shift, x, c, index);</span>
<span class="lineNum">    5213 </span><span class="lineNoCov">          0 :       seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    5214 </span><span class="lineNoCov">          0 :       seed-&gt;SetRow(i1-1); // RS: memorise current row      </span>
<span class="lineNum">    5215 </span><span class="lineNoCov">          0 :       track-&gt;SetIsSeeding(kTRUE);</span>
<span class="lineNum">    5216 </span>            : 
<span class="lineNum">    5217 </span><span class="lineNoCov">          0 :       nin++;      </span>
<span class="lineNum">    5218 </span><span class="lineNoCov">          0 :       FollowProlongation(*track, i1-7,1);</span>
<span class="lineNum">    5219 </span><span class="lineNoCov">          0 :       if (track-&gt;GetNumberOfClusters() &lt; track-&gt;GetNFoundable()*0.75 || </span>
<span class="lineNum">    5220 </span><span class="lineNoCov">          0 :           track-&gt;GetNShared()&gt;0.6*track-&gt;GetNumberOfClusters()) {</span>
<span class="lineNum">    5221 </span>            :         //RS: with distortions related cluster errors the track error may grow, don't use this cut
<span class="lineNum">    5222 </span>            :         //|| ( track-&gt;GetSigmaY2()+ track-&gt;GetSigmaZ2())&gt;0.6){
<span class="lineNum">    5223 </span><span class="lineNoCov">          0 :         MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    5224 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5225 </span>            :       }
<span class="lineNum">    5226 </span><span class="lineNoCov">          0 :       nout1++;</span>
<span class="lineNum">    5227 </span><span class="lineNoCov">          0 :       nout2++;  </span>
<span class="lineNum">    5228 </span>            :       //Int_t rc = 1;
<span class="lineNum">    5229 </span><span class="lineNoCov">          0 :       FollowProlongation(*track, i2,1);</span>
<span class="lineNum">    5230 </span><span class="lineNoCov">          0 :       track-&gt;SetBConstrain(0);</span>
<span class="lineNum">    5231 </span><span class="lineNoCov">          0 :       track-&gt;SetLastPoint(i1+fInnerSec-&gt;GetNRows());  // first cluster in track position</span>
<span class="lineNum">    5232 </span><span class="lineNoCov">          0 :       track-&gt;SetFirstPoint(track-&gt;GetLastPoint());</span>
<span class="lineNum">    5233 </span>            :       
<span class="lineNum">    5234 </span><span class="lineNoCov">          0 :       if (track-&gt;GetNumberOfClusters()&lt;(i1-i2)*0.5 || </span>
<span class="lineNum">    5235 </span><span class="lineNoCov">          0 :           track-&gt;GetNumberOfClusters()&lt;track-&gt;GetNFoundable()*0.7 || </span>
<span class="lineNum">    5236 </span><span class="lineNoCov">          0 :           track-&gt;GetNShared()&gt;2. || track-&gt;GetChi2()/track-&gt;GetNumberOfClusters()&gt;6) {</span>
<span class="lineNum">    5237 </span>            :         //RS: with distortions related cluster errors the track error may grow, don't use this cut
<span class="lineNum">    5238 </span>            :         //|| ( track-&gt;GetSigmaY2()+ track-&gt;GetSigmaZ2())&gt;0.5 ) {
<span class="lineNum">    5239 </span><span class="lineNoCov">          0 :         MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    5240 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5241 </span>            :       }
<span class="lineNum">    5242 </span>            :    
<span class="lineNum">    5243 </span>            :       {
<span class="lineNum">    5244 </span><span class="lineNoCov">          0 :         FollowProlongation(*track, TMath::Max(i2-10,0),1);</span>
<span class="lineNum">    5245 </span><span class="lineNoCov">          0 :         AliTPCseed * track2 = MakeSeed(track,0.2,0.5,0.9);</span>
<span class="lineNum">    5246 </span><span class="lineNoCov">          0 :         FollowProlongation(*track2, i2,1);</span>
<span class="lineNum">    5247 </span><span class="lineNoCov">          0 :         track2-&gt;SetBConstrain(kFALSE);</span>
<span class="lineNum">    5248 </span><span class="lineNoCov">          0 :         track2-&gt;SetSeedType(4);</span>
<span class="lineNum">    5249 </span><span class="lineNoCov">          0 :         arr-&gt;AddLast(track2);</span>
<span class="lineNum">    5250 </span><span class="lineNoCov">          0 :         MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    5251 </span>            :       }
<span class="lineNum">    5252 </span>            :       
<span class="lineNum">    5253 </span>            :    
<span class="lineNum">    5254 </span>            :       //arr-&gt;AddLast(track); 
<span class="lineNum">    5255 </span>            :       //seed = new AliTPCseed;  
<span class="lineNum">    5256 </span><span class="lineNoCov">          0 :       nout3++;</span>
<span class="lineNum">    5257 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    5258 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5259 </span>            :   
<span class="lineNum">    5260 </span><span class="lineNoCov">          0 :   if (fDebug&gt;3){</span>
<span class="lineNum">    5261 </span><span class="lineNoCov">          0 :     Info(&quot;MakeSeeds5Dist&quot;,&quot;\nSeeding statiistic:\t%d\t%d\t%d\t%d\t%d\t%d\t%d&quot;,nin0,nin1,nin2,nin,nout1,nout2,nout3);</span>
<span class="lineNum">    5262 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5263 </span><span class="lineNoCov">          0 :   if (seed) MarkSeedFree(seed);</span>
<span class="lineNum">    5264 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5265 </span>            : 
<a name="5266"><span class="lineNum">    5266 </span>            : </a>
<span class="lineNum">    5267 </span>            : //_____________________________________________________________________________
<span class="lineNum">    5268 </span>            : void AliTPCtracker::MakeSeeds2(TObjArray * arr, Int_t sec, Int_t i1, Int_t i2, Float_t */*cuts[4]*/,
<span class="lineNum">    5269 </span>            :                                  Float_t deltay, Bool_t /*bconstrain*/) {
<span class="lineNum">    5270 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    5271 </span>            :   // This function creates track seeds - without vertex constraint
<span class="lineNum">    5272 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    5273 </span>            :   // cuts[0]   - fP4 cut        - not applied
<span class="lineNum">    5274 </span>            :   // cuts[1]   - tan(phi)  cut
<span class="lineNum">    5275 </span>            :   // cuts[2]   - zvertex cut    - not applied 
<span class="lineNum">    5276 </span>            :   // cuts[3]   - fP3 cut
<span class="lineNum">    5277 </span>            :   const double kRoadZ = 1.2, kRoadY = 1.2;
<span class="lineNum">    5278 </span>            : 
<span class="lineNum">    5279 </span>            :   Int_t nin0=0;
<span class="lineNum">    5280 </span>            :   Int_t nin1=0;
<span class="lineNum">    5281 </span>            :   Int_t nin2=0;
<span class="lineNum">    5282 </span>            :   Int_t nin3=0;
<span class="lineNum">    5283 </span>            :   //  Int_t nin4=0;
<span class="lineNum">    5284 </span>            :   //Int_t nin5=0;
<span class="lineNum">    5285 </span>            : 
<span class="lineNum">    5286 </span>            :   
<span class="lineNum">    5287 </span>            : 
<span class="lineNum">    5288 </span><span class="lineNoCov">          0 :   Double_t alpha=fOuterSec-&gt;GetAlpha(), shift=fOuterSec-&gt;GetAlphaShift();</span>
<span class="lineNum">    5289 </span>            :   //  Double_t cs=cos(alpha), sn=sin(alpha);
<span class="lineNum">    5290 </span><span class="lineNoCov">          0 :   Int_t row0 = (i1+i2)/2;</span>
<span class="lineNum">    5291 </span><span class="lineNoCov">          0 :   Int_t drow = (i1-i2)/2;</span>
<span class="lineNum">    5292 </span><span class="lineNoCov">          0 :   const AliTPCtrackerRow&amp; kr0=fSectors[sec][row0];</span>
<span class="lineNum">    5293 </span>            :   AliTPCtrackerRow * kr=0;
<span class="lineNum">    5294 </span>            : 
<span class="lineNum">    5295 </span><span class="lineNoCov">          0 :   AliTPCpolyTrack polytrack;</span>
<span class="lineNum">    5296 </span><span class="lineNoCov">          0 :   Int_t nclusters=fSectors[sec][row0];</span>
<span class="lineNum">    5297 </span><span class="lineNoCov">          0 :   AliTPCseed * seed = new( NextFreeSeed() ) AliTPCseed;</span>
<span class="lineNum">    5298 </span><span class="lineNoCov">          0 :   seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    5299 </span>            : 
<span class="lineNum">    5300 </span>            :   Int_t sumused=0;
<span class="lineNum">    5301 </span>            :   Int_t cused=0;
<span class="lineNum">    5302 </span>            :   Int_t cnused=0;
<span class="lineNum">    5303 </span><span class="lineNoCov">          0 :   for (Int_t is=0; is &lt; nclusters; is++) {  //LOOP over clusters</span>
<span class="lineNum">    5304 </span>            :     Int_t nfound =0;
<span class="lineNum">    5305 </span>            :     Int_t nfoundable =0;
<span class="lineNum">    5306 </span><span class="lineNoCov">          0 :     for (Int_t iter =1; iter&lt;2; iter++){   //iterations</span>
<span class="lineNum">    5307 </span><span class="lineNoCov">          0 :       const AliTPCtrackerRow&amp; krm=fSectors[sec][row0-iter];</span>
<span class="lineNum">    5308 </span><span class="lineNoCov">          0 :       const AliTPCtrackerRow&amp; krp=fSectors[sec][row0+iter];      </span>
<span class="lineNum">    5309 </span><span class="lineNoCov">          0 :       const AliTPCclusterMI * cl= kr0[is];</span>
<span class="lineNum">    5310 </span><span class="lineNoCov">          0 :       if (cl-&gt;IsDisabled()) {</span>
<span class="lineNum">    5311 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5312 </span>            :       }
<span class="lineNum">    5313 </span>            : 
<span class="lineNum">    5314 </span><span class="lineNoCov">          0 :       if (cl-&gt;IsUsed(10)) {</span>
<span class="lineNum">    5315 </span><span class="lineNoCov">          0 :         cused++;</span>
<span class="lineNum">    5316 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    5317 </span>            :       else{
<span class="lineNum">    5318 </span><span class="lineNoCov">          0 :         cnused++;</span>
<span class="lineNum">    5319 </span>            :       }
<span class="lineNum">    5320 </span><span class="lineNoCov">          0 :       Double_t x = kr0.GetX();</span>
<span class="lineNum">    5321 </span>            :       // Initialization of the polytrack
<span class="lineNum">    5322 </span>            :       nfound =0;
<span class="lineNum">    5323 </span>            :       nfoundable =0;
<span class="lineNum">    5324 </span><span class="lineNoCov">          0 :       polytrack.Reset();</span>
<span class="lineNum">    5325 </span>            :       //
<span class="lineNum">    5326 </span><span class="lineNoCov">          0 :       Double_t y0= cl-&gt;GetY();</span>
<span class="lineNum">    5327 </span><span class="lineNoCov">          0 :       Double_t z0= cl-&gt;GetZ();</span>
<span class="lineNum">    5328 </span>            :       Float_t erry = 0;
<span class="lineNum">    5329 </span>            :       Float_t errz = 0;
<span class="lineNum">    5330 </span>            :       
<span class="lineNum">    5331 </span><span class="lineNoCov">          0 :       Double_t ymax = fSectors-&gt;GetMaxY(row0)-kr0.GetDeadZone()-1.5;</span>
<span class="lineNum">    5332 </span><span class="lineNoCov">          0 :       if (deltay&gt;0 &amp;&amp; TMath::Abs(ymax-TMath::Abs(y0))&gt; deltay ) continue;  // seed only at the edge</span>
<span class="lineNum">    5333 </span>            :       
<span class="lineNum">    5334 </span><span class="lineNoCov">          0 :       erry = (0.5)*cl-&gt;GetSigmaY2()/TMath::Sqrt(cl-&gt;GetQ())*6;        </span>
<span class="lineNum">    5335 </span><span class="lineNoCov">          0 :       errz = (0.5)*cl-&gt;GetSigmaZ2()/TMath::Sqrt(cl-&gt;GetQ())*6;      </span>
<span class="lineNum">    5336 </span><span class="lineNoCov">          0 :       polytrack.AddPoint(x,y0,z0,erry, errz);</span>
<span class="lineNum">    5337 </span>            : 
<span class="lineNum">    5338 </span>            :       sumused=0;
<span class="lineNum">    5339 </span><span class="lineNoCov">          0 :       if (cl-&gt;IsUsed(10)) sumused++;</span>
<span class="lineNum">    5340 </span>            : 
<span class="lineNum">    5341 </span>            : 
<span class="lineNum">    5342 </span><span class="lineNoCov">          0 :       Float_t roady = (5*TMath::Sqrt(cl-&gt;GetSigmaY2()+0.2)+1.)*iter;</span>
<span class="lineNum">    5343 </span><span class="lineNoCov">          0 :       Float_t roadz = (5*TMath::Sqrt(cl-&gt;GetSigmaZ2()+0.2)+1.)*iter;</span>
<span class="lineNum">    5344 </span>            :       //
<span class="lineNum">    5345 </span><span class="lineNoCov">          0 :       x = krm.GetX();</span>
<span class="lineNum">    5346 </span><span class="lineNoCov">          0 :       AliTPCclusterMI * cl1 = krm.FindNearest(y0,z0,roady+fClExtraRoadY,roadz+fClExtraRoadZ);</span>
<span class="lineNum">    5347 </span><span class="lineNoCov">          0 :       if (cl1 &amp;&amp; TMath::Abs(ymax-TMath::Abs(y0))) {</span>
<span class="lineNum">    5348 </span><span class="lineNoCov">          0 :         erry = (0.5)*cl1-&gt;GetSigmaY2()/TMath::Sqrt(cl1-&gt;GetQ())*3;            </span>
<span class="lineNum">    5349 </span><span class="lineNoCov">          0 :         errz = (0.5)*cl1-&gt;GetSigmaZ2()/TMath::Sqrt(cl1-&gt;GetQ())*3;</span>
<span class="lineNum">    5350 </span><span class="lineNoCov">          0 :         if (cl1-&gt;IsUsed(10))  sumused++;</span>
<span class="lineNum">    5351 </span><span class="lineNoCov">          0 :         polytrack.AddPoint(x,cl1-&gt;GetY(),cl1-&gt;GetZ(),erry,errz);</span>
<span class="lineNum">    5352 </span>            :       }
<span class="lineNum">    5353 </span>            :       //
<span class="lineNum">    5354 </span><span class="lineNoCov">          0 :       x = krp.GetX();</span>
<span class="lineNum">    5355 </span><span class="lineNoCov">          0 :       AliTPCclusterMI * cl2 = krp.FindNearest(y0,z0,roady+fClExtraRoadY,roadz+fClExtraRoadZ);</span>
<span class="lineNum">    5356 </span><span class="lineNoCov">          0 :       if (cl2) {</span>
<span class="lineNum">    5357 </span><span class="lineNoCov">          0 :         erry = (0.5)*cl2-&gt;GetSigmaY2()/TMath::Sqrt(cl2-&gt;GetQ())*3;            </span>
<span class="lineNum">    5358 </span><span class="lineNoCov">          0 :         errz = (0.5)*cl2-&gt;GetSigmaZ2()/TMath::Sqrt(cl2-&gt;GetQ())*3;</span>
<span class="lineNum">    5359 </span><span class="lineNoCov">          0 :         if (cl2-&gt;IsUsed(10)) sumused++;       </span>
<span class="lineNum">    5360 </span><span class="lineNoCov">          0 :         polytrack.AddPoint(x,cl2-&gt;GetY(),cl2-&gt;GetZ(),erry,errz);</span>
<span class="lineNum">    5361 </span>            :       }
<span class="lineNum">    5362 </span>            :       //
<span class="lineNum">    5363 </span><span class="lineNoCov">          0 :       if (sumused&gt;0) continue;</span>
<span class="lineNum">    5364 </span><span class="lineNoCov">          0 :       nin0++;</span>
<span class="lineNum">    5365 </span><span class="lineNoCov">          0 :       polytrack.UpdateParameters();</span>
<span class="lineNum">    5366 </span>            :       // follow polytrack
<span class="lineNum">    5367 </span>            :       //
<span class="lineNum">    5368 </span><span class="lineNoCov">          0 :       Double_t yn,zn;</span>
<span class="lineNum">    5369 </span><span class="lineNoCov">          0 :       nfoundable = polytrack.GetN();</span>
<span class="lineNum">    5370 </span>            :       nfound     = nfoundable; 
<span class="lineNum">    5371 </span>            :       //
<span class="lineNum">    5372 </span><span class="lineNoCov">          0 :       for (Int_t ddrow = iter+1; ddrow&lt;drow;ddrow++){</span>
<span class="lineNum">    5373 </span><span class="lineNoCov">          0 :         Float_t maxdist = 0.8*(1.+3./(ddrow));</span>
<span class="lineNum">    5374 </span><span class="lineNoCov">          0 :         for (Int_t delta = -1;delta&lt;=1;delta+=2){</span>
<span class="lineNum">    5375 </span><span class="lineNoCov">          0 :           Int_t row = row0+ddrow*delta;</span>
<span class="lineNum">    5376 </span><span class="lineNoCov">          0 :           kr = &amp;(fSectors[sec][row]);</span>
<span class="lineNum">    5377 </span><span class="lineNoCov">          0 :           Double_t xn = kr-&gt;GetX();</span>
<span class="lineNum">    5378 </span><span class="lineNoCov">          0 :           Double_t ymax1 = fSectors-&gt;GetMaxY(row)-kr-&gt;GetDeadZone()-1.5;</span>
<span class="lineNum">    5379 </span><span class="lineNoCov">          0 :           polytrack.GetFitPoint(xn,yn,zn);</span>
<span class="lineNum">    5380 </span><span class="lineNoCov">          0 :           if (TMath::Abs(yn)&gt;ymax1) continue;</span>
<span class="lineNum">    5381 </span><span class="lineNoCov">          0 :           nfoundable++;</span>
<span class="lineNum">    5382 </span><span class="lineNoCov">          0 :           AliTPCclusterMI * cln = kr-&gt;FindNearest(yn,zn,kRoadY+fClExtraRoadY,kRoadZ+fClExtraRoadZ);</span>
<span class="lineNum">    5383 </span><span class="lineNoCov">          0 :           if (cln) {</span>
<span class="lineNum">    5384 </span><span class="lineNoCov">          0 :             Float_t dist =  TMath::Sqrt(  (yn-cln-&gt;GetY())*(yn-cln-&gt;GetY())+(zn-cln-&gt;GetZ())*(zn-cln-&gt;GetZ()));</span>
<span class="lineNum">    5385 </span><span class="lineNoCov">          0 :             if (dist&lt;maxdist){</span>
<span class="lineNum">    5386 </span>            :               /*
<span class="lineNum">    5387 </span>            :               erry = (dist+0.3)*cln-&gt;GetSigmaY2()/TMath::Sqrt(cln-&gt;GetQ())*(1.+1./(ddrow));           
<span class="lineNum">    5388 </span>            :               errz = (dist+0.3)*cln-&gt;GetSigmaZ2()/TMath::Sqrt(cln-&gt;GetQ())*(1.+1./(ddrow));
<span class="lineNum">    5389 </span>            :               if (cln-&gt;IsUsed(10)) {
<span class="lineNum">    5390 </span>            :                 //      printf(&quot;used\n&quot;);
<span class="lineNum">    5391 </span>            :                 sumused++;
<span class="lineNum">    5392 </span>            :                 erry*=2;
<span class="lineNum">    5393 </span>            :                 errz*=2;
<span class="lineNum">    5394 </span>            :               }
<span class="lineNum">    5395 </span>            :               */
<span class="lineNum">    5396 </span>            :               erry=0.1;
<span class="lineNum">    5397 </span>            :               errz=0.1;
<span class="lineNum">    5398 </span><span class="lineNoCov">          0 :               polytrack.AddPoint(xn,cln-&gt;GetY(),cln-&gt;GetZ(),erry, errz);</span>
<span class="lineNum">    5399 </span><span class="lineNoCov">          0 :               nfound++;</span>
<span class="lineNum">    5400 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    5401 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    5402 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5403 </span><span class="lineNoCov">          0 :         if ( (sumused&gt;3) || (sumused&gt;0.5*nfound) || (nfound&lt;0.6*nfoundable))  break;     </span>
<span class="lineNum">    5404 </span><span class="lineNoCov">          0 :         polytrack.UpdateParameters();</span>
<span class="lineNum">    5405 </span><span class="lineNoCov">          0 :       }           </span>
<span class="lineNum">    5406 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    5407 </span><span class="lineNoCov">          0 :     if ( (sumused&gt;3) || (sumused&gt;0.5*nfound))  {</span>
<span class="lineNum">    5408 </span>            :       //printf(&quot;sumused   %d\n&quot;,sumused);
<span class="lineNum">    5409 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    5410 </span>            :     }
<span class="lineNum">    5411 </span><span class="lineNoCov">          0 :     nin1++;</span>
<span class="lineNum">    5412 </span><span class="lineNoCov">          0 :     Double_t dy,dz;</span>
<span class="lineNum">    5413 </span><span class="lineNoCov">          0 :     polytrack.GetFitDerivation(kr0.GetX(),dy,dz);</span>
<span class="lineNum">    5414 </span><span class="lineNoCov">          0 :     AliTPCpolyTrack track2;</span>
<span class="lineNum">    5415 </span>            :     
<span class="lineNum">    5416 </span><span class="lineNoCov">          0 :     polytrack.Refit(track2,0.5+TMath::Abs(dy)*0.3,0.4+TMath::Abs(dz)*0.3);</span>
<span class="lineNum">    5417 </span><span class="lineNoCov">          0 :     if (track2.GetN()&lt;0.5*nfoundable) continue;</span>
<span class="lineNum">    5418 </span><span class="lineNoCov">          0 :     nin2++;</span>
<span class="lineNum">    5419 </span>            : 
<span class="lineNum">    5420 </span><span class="lineNoCov">          0 :     if ((nfound&gt;0.6*nfoundable) &amp;&amp;( nfoundable&gt;0.4*(i1-i2))) {</span>
<span class="lineNum">    5421 </span>            :       //
<span class="lineNum">    5422 </span>            :       // test seed with and without constrain
<span class="lineNum">    5423 </span><span class="lineNoCov">          0 :       for (Int_t constrain=0; constrain&lt;=0;constrain++){</span>
<span class="lineNum">    5424 </span>            :         // add polytrack candidate
<span class="lineNum">    5425 </span>            : 
<span class="lineNum">    5426 </span><span class="lineNoCov">          0 :         Double_t x[5], c[15];</span>
<span class="lineNum">    5427 </span><span class="lineNoCov">          0 :         Double_t x1,x2,x3,y1,y2,y3,z1,z2,z3;</span>
<span class="lineNum">    5428 </span><span class="lineNoCov">          0 :         track2.GetBoundaries(x3,x1);    </span>
<span class="lineNum">    5429 </span><span class="lineNoCov">          0 :         x2 = (x1+x3)/2.;</span>
<span class="lineNum">    5430 </span><span class="lineNoCov">          0 :         track2.GetFitPoint(x1,y1,z1);</span>
<span class="lineNum">    5431 </span><span class="lineNoCov">          0 :         track2.GetFitPoint(x2,y2,z2);</span>
<span class="lineNum">    5432 </span><span class="lineNoCov">          0 :         track2.GetFitPoint(x3,y3,z3);</span>
<span class="lineNum">    5433 </span>            :         //
<span class="lineNum">    5434 </span>            :         //is track pointing to the vertex ?
<span class="lineNum">    5435 </span><span class="lineNoCov">          0 :         Double_t x0,y0,z0;</span>
<span class="lineNum">    5436 </span>            :         x0=0;
<span class="lineNum">    5437 </span><span class="lineNoCov">          0 :         polytrack.GetFitPoint(x0,y0,z0);</span>
<span class="lineNum">    5438 </span>            : 
<span class="lineNum">    5439 </span><span class="lineNoCov">          0 :         if (constrain) {</span>
<span class="lineNum">    5440 </span><span class="lineNoCov">          0 :           x2 = x3;</span>
<span class="lineNum">    5441 </span><span class="lineNoCov">          0 :           y2 = y3;</span>
<span class="lineNum">    5442 </span><span class="lineNoCov">          0 :           z2 = z3;</span>
<span class="lineNum">    5443 </span>            :           
<span class="lineNum">    5444 </span><span class="lineNoCov">          0 :           x3 = 0;</span>
<span class="lineNum">    5445 </span><span class="lineNoCov">          0 :           y3 = 0;</span>
<span class="lineNum">    5446 </span><span class="lineNoCov">          0 :           z3 = 0;</span>
<span class="lineNum">    5447 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5448 </span><span class="lineNoCov">          0 :         x[0]=y1;</span>
<span class="lineNum">    5449 </span><span class="lineNoCov">          0 :         x[1]=z1;</span>
<span class="lineNum">    5450 </span><span class="lineNoCov">          0 :         x[4]=F1(x1,y1,x2,y2,x3,y3);</span>
<span class="lineNum">    5451 </span>            :                 
<span class="lineNum">    5452 </span>            :         //      if (TMath::Abs(x[4]) &gt;= cuts[0]) continue;  //
<span class="lineNum">    5453 </span><span class="lineNoCov">          0 :         x[2]=F2(x1,y1,x2,y2,x3,y3);</span>
<span class="lineNum">    5454 </span>            :         
<span class="lineNum">    5455 </span>            :         //if (TMath::Abs(x[4]*x1-x[2]) &gt;= cuts[1]) continue;
<span class="lineNum">    5456 </span>            :         //x[3]=F3(x1,y1,x2,y2,z1,z2);
<span class="lineNum">    5457 </span><span class="lineNoCov">          0 :         x[3]=F3n(x1,y1,x3,y3,z1,z3,x[4]);</span>
<span class="lineNum">    5458 </span>            :         //if (TMath::Abs(x[3]) &gt; cuts[3]) continue;
<span class="lineNum">    5459 </span>            : 
<span class="lineNum">    5460 </span>            :         
<span class="lineNum">    5461 </span>            :         Double_t sy =0.1, sz =0.1;
<span class="lineNum">    5462 </span>            :         Double_t sy1=0.02, sz1=0.02;
<span class="lineNum">    5463 </span>            :         Double_t sy2=0.02, sz2=0.02;
<span class="lineNum">    5464 </span>            :         Double_t sy3=0.02;
<span class="lineNum">    5465 </span>            : 
<span class="lineNum">    5466 </span><span class="lineNoCov">          0 :         if (constrain){</span>
<span class="lineNum">    5467 </span><span class="lineNoCov">          0 :           sy3=25000*x[4]*x[4]+0.1, sy=0.1, sz=0.1;</span>
<span class="lineNum">    5468 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5469 </span>            :         
<span class="lineNum">    5470 </span><span class="lineNoCov">          0 :         Double_t f40=(F1(x1,y1+sy,x2,y2,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    5471 </span><span class="lineNoCov">          0 :         Double_t f42=(F1(x1,y1,x2,y2+sy,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    5472 </span><span class="lineNoCov">          0 :         Double_t f43=(F1(x1,y1,x2,y2,x3,y3+sy)-x[4])/sy;</span>
<span class="lineNum">    5473 </span><span class="lineNoCov">          0 :         Double_t f20=(F2(x1,y1+sy,x2,y2,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    5474 </span><span class="lineNoCov">          0 :         Double_t f22=(F2(x1,y1,x2,y2+sy,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    5475 </span><span class="lineNoCov">          0 :         Double_t f23=(F2(x1,y1,x2,y2,x3,y3+sy)-x[2])/sy;</span>
<span class="lineNum">    5476 </span>            : 
<span class="lineNum">    5477 </span><span class="lineNoCov">          0 :         Double_t f30=(F3(x1,y1+sy,x3,y3,z1,z3)-x[3])/sy;</span>
<span class="lineNum">    5478 </span><span class="lineNoCov">          0 :         Double_t f31=(F3(x1,y1,x3,y3,z1+sz,z3)-x[3])/sz;</span>
<span class="lineNum">    5479 </span><span class="lineNoCov">          0 :         Double_t f32=(F3(x1,y1,x3,y3+sy,z1,z3)-x[3])/sy;</span>
<span class="lineNum">    5480 </span><span class="lineNoCov">          0 :         Double_t f34=(F3(x1,y1,x3,y3,z1,z3+sz)-x[3])/sz;</span>
<span class="lineNum">    5481 </span>            : 
<span class="lineNum">    5482 </span>            :         
<span class="lineNum">    5483 </span><span class="lineNoCov">          0 :         c[0]=sy1;</span>
<span class="lineNum">    5484 </span><span class="lineNoCov">          0 :         c[1]=0.;       c[2]=sz1;</span>
<span class="lineNum">    5485 </span><span class="lineNoCov">          0 :         c[3]=f20*sy1;  c[4]=0.;       c[5]=f20*sy1*f20+f22*sy2*f22+f23*sy3*f23;</span>
<span class="lineNum">    5486 </span><span class="lineNoCov">          0 :         c[6]=f30*sy1;  c[7]=f31*sz1;  c[8]=f30*sy1*f20+f32*sy2*f22;</span>
<span class="lineNum">    5487 </span><span class="lineNoCov">          0 :         c[9]=f30*sy1*f30+f31*sz1*f31+f32*sy2*f32+f34*sz2*f34;</span>
<span class="lineNum">    5488 </span><span class="lineNoCov">          0 :         c[10]=f40*sy1; c[11]=0.; c[12]=f40*sy1*f20+f42*sy2*f22+f43*sy3*f23;</span>
<span class="lineNum">    5489 </span><span class="lineNoCov">          0 :         c[13]=f30*sy1*f40+f32*sy2*f42;</span>
<span class="lineNum">    5490 </span><span class="lineNoCov">          0 :         c[14]=f40*sy1*f40+f42*sy2*f42+f43*sy3*f43;</span>
<span class="lineNum">    5491 </span>            :         
<span class="lineNum">    5492 </span>            :         //Int_t row1 = fSectors-&gt;GetRowNumber(x1);
<span class="lineNum">    5493 </span><span class="lineNoCov">          0 :         Int_t row1 = GetRowNumber(x1);</span>
<span class="lineNum">    5494 </span>            : 
<span class="lineNum">    5495 </span>            :         UInt_t index=0;
<span class="lineNum">    5496 </span>            :         //kr0.GetIndex(is);
<span class="lineNum">    5497 </span><span class="lineNoCov">          0 :         if (seed) {MarkSeedFree( seed ); seed = 0;}</span>
<span class="lineNum">    5498 </span><span class="lineNoCov">          0 :         AliTPCseed *track = seed = new( NextFreeSeed() ) AliTPCseed(x1,sec*alpha+shift,x,c,index);</span>
<span class="lineNum">    5499 </span><span class="lineNoCov">          0 :         seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    5500 </span><span class="lineNoCov">          0 :         track-&gt;SetIsSeeding(kTRUE);</span>
<span class="lineNum">    5501 </span><span class="lineNoCov">          0 :         Int_t rc=FollowProlongation(*track, i2);        </span>
<span class="lineNum">    5502 </span><span class="lineNoCov">          0 :         if (constrain) track-&gt;SetBConstrain(1);</span>
<span class="lineNum">    5503 </span>            :         else
<span class="lineNum">    5504 </span><span class="lineNoCov">          0 :           track-&gt;SetBConstrain(0);</span>
<span class="lineNum">    5505 </span><span class="lineNoCov">          0 :         track-&gt;SetLastPoint(row1+fInnerSec-&gt;GetNRows());  // first cluster in track position</span>
<span class="lineNum">    5506 </span><span class="lineNoCov">          0 :         track-&gt;SetFirstPoint(track-&gt;GetLastPoint());</span>
<span class="lineNum">    5507 </span>            : 
<span class="lineNum">    5508 </span><span class="lineNoCov">          0 :         if (rc==0 || track-&gt;GetNumberOfClusters()&lt;(i1-i2)*0.5 || </span>
<span class="lineNum">    5509 </span><span class="lineNoCov">          0 :             track-&gt;GetNumberOfClusters() &lt; track-&gt;GetNFoundable()*0.6 || </span>
<span class="lineNum">    5510 </span><span class="lineNoCov">          0 :             track-&gt;GetNShared()&gt;0.4*track-&gt;GetNumberOfClusters()) {</span>
<span class="lineNum">    5511 </span><span class="lineNoCov">          0 :           MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    5512 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5513 </span>            :         else {
<span class="lineNum">    5514 </span><span class="lineNoCov">          0 :           arr-&gt;AddLast(track); // track IS seed, don't free seed</span>
<span class="lineNum">    5515 </span><span class="lineNoCov">          0 :           seed = new( NextFreeSeed() ) AliTPCseed;</span>
<span class="lineNum">    5516 </span><span class="lineNoCov">          0 :           seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    5517 </span>            :         }
<span class="lineNum">    5518 </span><span class="lineNoCov">          0 :         nin3++;</span>
<span class="lineNum">    5519 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    5520 </span><span class="lineNoCov">          0 :     }  // if accepted seed</span>
<span class="lineNum">    5521 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5522 </span><span class="lineNoCov">          0 :   if (fDebug&gt;3){</span>
<span class="lineNum">    5523 </span><span class="lineNoCov">          0 :     Info(&quot;MakeSeeds2&quot;,&quot;\nSeeding statiistic:\t%d\t%d\t%d\t%d&quot;,nin0,nin1,nin2,nin3);</span>
<span class="lineNum">    5524 </span>            :   }
<span class="lineNum">    5525 </span><span class="lineNoCov">          0 :   if (seed) MarkSeedFree( seed );</span>
<span class="lineNum">    5526 </span><span class="lineNoCov">          0 : }</span>
<a name="5527"><span class="lineNum">    5527 </span>            : </a>
<span class="lineNum">    5528 </span>            : //_____________________________________________________________________________
<span class="lineNum">    5529 </span>            : void AliTPCtracker::MakeSeeds2Dist(TObjArray * arr, Int_t sec, Int_t i1, Int_t i2, Float_t */*cuts[4]*/,
<span class="lineNum">    5530 </span>            :                                  Float_t deltay, Bool_t /*bconstrain*/) {
<span class="lineNum">    5531 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    5532 </span>            :   // This function creates track seeds, accounting for distortions - without vertex constraint
<span class="lineNum">    5533 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    5534 </span>            :   // cuts[0]   - fP4 cut        - not applied
<span class="lineNum">    5535 </span>            :   // cuts[1]   - tan(phi)  cut
<span class="lineNum">    5536 </span>            :   // cuts[2]   - zvertex cut    - not applied 
<span class="lineNum">    5537 </span>            :   // cuts[3]   - fP3 cut
<span class="lineNum">    5538 </span>            :   const double kRoadZ = 1.2, kRoadY = 1.2;
<span class="lineNum">    5539 </span>            : 
<span class="lineNum">    5540 </span>            :   Int_t nin0=0;
<span class="lineNum">    5541 </span>            :   Int_t nin1=0;
<span class="lineNum">    5542 </span>            :   Int_t nin2=0;
<span class="lineNum">    5543 </span>            :   Int_t nin3=0;
<span class="lineNum">    5544 </span>            :   //  Int_t nin4=0;
<span class="lineNum">    5545 </span>            :   //Int_t nin5=0;
<span class="lineNum">    5546 </span>            : 
<span class="lineNum">    5547 </span><span class="lineNoCov">          0 :   AliFatal(&quot;This method is still not fully aware of distortions, should not be used&quot;);</span>
<span class="lineNum">    5548 </span><span class="lineNoCov">          0 :   Double_t alpha=fOuterSec-&gt;GetAlpha(), shift=fOuterSec-&gt;GetAlphaShift();</span>
<span class="lineNum">    5549 </span>            :   //  Double_t cs=cos(alpha), sn=sin(alpha);
<span class="lineNum">    5550 </span><span class="lineNoCov">          0 :   Int_t row0 = (i1+i2)/2;</span>
<span class="lineNum">    5551 </span><span class="lineNoCov">          0 :   Int_t drow = (i1-i2)/2;</span>
<span class="lineNum">    5552 </span><span class="lineNoCov">          0 :   const AliTPCtrackerRow&amp; kr0=fSectors[sec][row0];</span>
<span class="lineNum">    5553 </span>            :   AliTPCtrackerRow * kr=0;
<span class="lineNum">    5554 </span>            : 
<span class="lineNum">    5555 </span><span class="lineNoCov">          0 :   AliTPCpolyTrack polytrack;</span>
<span class="lineNum">    5556 </span><span class="lineNoCov">          0 :   Int_t nclusters=fSectors[sec][row0];</span>
<span class="lineNum">    5557 </span><span class="lineNoCov">          0 :   AliTPCseed * seed = new( NextFreeSeed() ) AliTPCseed;</span>
<span class="lineNum">    5558 </span><span class="lineNoCov">          0 :   seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    5559 </span>            : 
<span class="lineNum">    5560 </span>            :   Int_t sumused=0;
<span class="lineNum">    5561 </span>            :   Int_t cused=0;
<span class="lineNum">    5562 </span>            :   Int_t cnused=0;
<span class="lineNum">    5563 </span>            :   Int_t rowMax = -1;
<span class="lineNum">    5564 </span>            :   //
<span class="lineNum">    5565 </span><span class="lineNoCov">          0 :   for (Int_t is=0; is &lt; nclusters; is++) {  //LOOP over clusters</span>
<span class="lineNum">    5566 </span>            :     Int_t nfound =0;
<span class="lineNum">    5567 </span>            :     Int_t nfoundable =0;
<span class="lineNum">    5568 </span><span class="lineNoCov">          0 :     for (Int_t iter =1; iter&lt;2; iter++){   //iterations</span>
<span class="lineNum">    5569 </span><span class="lineNoCov">          0 :       const AliTPCtrackerRow&amp; krm=fSectors[sec][row0-iter];</span>
<span class="lineNum">    5570 </span><span class="lineNoCov">          0 :       const AliTPCtrackerRow&amp; krp=fSectors[sec][row0+iter];      </span>
<span class="lineNum">    5571 </span><span class="lineNoCov">          0 :       const AliTPCclusterMI * cl= kr0[is];</span>
<span class="lineNum">    5572 </span><span class="lineNoCov">          0 :       if (cl-&gt;IsDisabled()) {</span>
<span class="lineNum">    5573 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5574 </span>            :       }
<span class="lineNum">    5575 </span>            : 
<span class="lineNum">    5576 </span><span class="lineNoCov">          0 :       if (cl-&gt;IsUsed(10)) {</span>
<span class="lineNum">    5577 </span><span class="lineNoCov">          0 :         cused++;</span>
<span class="lineNum">    5578 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    5579 </span>            :       else{
<span class="lineNum">    5580 </span><span class="lineNoCov">          0 :         cnused++;</span>
<span class="lineNum">    5581 </span>            :       }
<span class="lineNum">    5582 </span>            :       
<span class="lineNum">    5583 </span><span class="lineNoCov">          0 :       Double_t x = cl-&gt;GetX(), xDist = x - kr0.GetX(); // approximate X distortion in proximity of cl</span>
<span class="lineNum">    5584 </span>            :       // Initialization of the polytrack
<span class="lineNum">    5585 </span>            :       nfound =0;
<span class="lineNum">    5586 </span>            :       nfoundable =0;
<span class="lineNum">    5587 </span><span class="lineNoCov">          0 :       polytrack.Reset();</span>
<span class="lineNum">    5588 </span>            :       //
<span class="lineNum">    5589 </span><span class="lineNoCov">          0 :       Double_t y0= cl-&gt;GetY();</span>
<span class="lineNum">    5590 </span><span class="lineNoCov">          0 :       Double_t z0= cl-&gt;GetZ();</span>
<span class="lineNum">    5591 </span>            :       Float_t erry = 0;
<span class="lineNum">    5592 </span>            :       Float_t errz = 0;
<span class="lineNum">    5593 </span>            :       
<span class="lineNum">    5594 </span><span class="lineNoCov">          0 :       Double_t ymax = fSectors-&gt;GetMaxY(row0)-kr0.GetDeadZone()-1.5; // RS: watch dead zones</span>
<span class="lineNum">    5595 </span><span class="lineNoCov">          0 :       if (deltay&gt;0 &amp;&amp; TMath::Abs(ymax-TMath::Abs(y0))&gt; deltay ) continue;  // seed only at the edge</span>
<span class="lineNum">    5596 </span>            :       
<span class="lineNum">    5597 </span><span class="lineNoCov">          0 :       erry = (0.5)*cl-&gt;GetSigmaY2()/TMath::Sqrt(cl-&gt;GetQ())*6;        </span>
<span class="lineNum">    5598 </span><span class="lineNoCov">          0 :       errz = (0.5)*cl-&gt;GetSigmaZ2()/TMath::Sqrt(cl-&gt;GetQ())*6;      </span>
<span class="lineNum">    5599 </span><span class="lineNoCov">          0 :       polytrack.AddPoint(x,y0,z0,erry, errz);</span>
<span class="lineNum">    5600 </span>            :       rowMax = row0;      
<span class="lineNum">    5601 </span>            :       sumused=0;
<span class="lineNum">    5602 </span><span class="lineNoCov">          0 :       if (cl-&gt;IsUsed(10)) sumused++;</span>
<span class="lineNum">    5603 </span>            : 
<span class="lineNum">    5604 </span>            : 
<span class="lineNum">    5605 </span><span class="lineNoCov">          0 :       Float_t roady = (5*TMath::Sqrt(cl-&gt;GetSigmaY2()+0.2)+1.)*iter;</span>
<span class="lineNum">    5606 </span><span class="lineNoCov">          0 :       Float_t roadz = (5*TMath::Sqrt(cl-&gt;GetSigmaZ2()+0.2)+1.)*iter;</span>
<span class="lineNum">    5607 </span>            :       //
<span class="lineNum">    5608 </span><span class="lineNoCov">          0 :       x = krm.GetX() + xDist; // RS: assume distortion at krm is similar to that at kr</span>
<span class="lineNum">    5609 </span><span class="lineNoCov">          0 :       AliTPCclusterMI * cl1 = krm.FindNearest(y0,z0,roady+fClExtraRoadY,roadz+fClExtraRoadZ);</span>
<span class="lineNum">    5610 </span><span class="lineNoCov">          0 :       if (cl1 &amp;&amp; TMath::Abs(ymax-TMath::Abs(y0))) {</span>
<span class="lineNum">    5611 </span><span class="lineNoCov">          0 :         erry = (0.5)*cl1-&gt;GetSigmaY2()/TMath::Sqrt(cl1-&gt;GetQ())*3;            </span>
<span class="lineNum">    5612 </span><span class="lineNoCov">          0 :         errz = (0.5)*cl1-&gt;GetSigmaZ2()/TMath::Sqrt(cl1-&gt;GetQ())*3;</span>
<span class="lineNum">    5613 </span><span class="lineNoCov">          0 :         if (cl1-&gt;IsUsed(10))  sumused++;</span>
<span class="lineNum">    5614 </span>            :         //RS: use real cluster X instead of approximately distorted
<span class="lineNum">    5615 </span><span class="lineNoCov">          0 :         polytrack.AddPoint(cl1-&gt;GetX(),cl1-&gt;GetY(),cl1-&gt;GetZ(),erry,errz); </span>
<span class="lineNum">    5616 </span>            :       }
<span class="lineNum">    5617 </span>            :       //
<span class="lineNum">    5618 </span><span class="lineNoCov">          0 :       x = krp.GetX() + xDist; // RS: assume distortion at krp is similar to that at kr</span>
<span class="lineNum">    5619 </span><span class="lineNoCov">          0 :       AliTPCclusterMI * cl2 = krp.FindNearest(y0,z0,roady+fClExtraRoadY,roadz+fClExtraRoadZ);</span>
<span class="lineNum">    5620 </span><span class="lineNoCov">          0 :       if (cl2) {</span>
<span class="lineNum">    5621 </span><span class="lineNoCov">          0 :         erry = (0.5)*cl2-&gt;GetSigmaY2()/TMath::Sqrt(cl2-&gt;GetQ())*3;            </span>
<span class="lineNum">    5622 </span><span class="lineNoCov">          0 :         errz = (0.5)*cl2-&gt;GetSigmaZ2()/TMath::Sqrt(cl2-&gt;GetQ())*3;</span>
<span class="lineNum">    5623 </span><span class="lineNoCov">          0 :         if (cl2-&gt;IsUsed(10)) sumused++;       </span>
<span class="lineNum">    5624 </span>            :         //RS: use real cluster X instead of approximately distorted
<span class="lineNum">    5625 </span><span class="lineNoCov">          0 :         polytrack.AddPoint(cl2-&gt;GetX(),cl2-&gt;GetY(),cl2-&gt;GetZ(),erry,errz); </span>
<span class="lineNum">    5626 </span>            :         rowMax = row0+iter;
<span class="lineNum">    5627 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    5628 </span>            :       //
<span class="lineNum">    5629 </span><span class="lineNoCov">          0 :       if (sumused&gt;0) continue;</span>
<span class="lineNum">    5630 </span><span class="lineNoCov">          0 :       nin0++;</span>
<span class="lineNum">    5631 </span><span class="lineNoCov">          0 :       polytrack.UpdateParameters();</span>
<span class="lineNum">    5632 </span>            :       // follow polytrack
<span class="lineNum">    5633 </span>            :       //
<span class="lineNum">    5634 </span><span class="lineNoCov">          0 :       Double_t yn,zn;</span>
<span class="lineNum">    5635 </span><span class="lineNoCov">          0 :       nfoundable = polytrack.GetN();</span>
<span class="lineNum">    5636 </span>            :       nfound     = nfoundable; 
<span class="lineNum">    5637 </span>            :       //
<span class="lineNum">    5638 </span><span class="lineNoCov">          0 :       for (Int_t ddrow = iter+1; ddrow&lt;drow;ddrow++){</span>
<span class="lineNum">    5639 </span><span class="lineNoCov">          0 :         Float_t maxdist = 0.8*(1.+3./(ddrow));</span>
<span class="lineNum">    5640 </span><span class="lineNoCov">          0 :         for (Int_t delta = -1;delta&lt;=1;delta+=2){</span>
<span class="lineNum">    5641 </span><span class="lineNoCov">          0 :           Int_t row = row0+ddrow*delta;</span>
<span class="lineNum">    5642 </span><span class="lineNoCov">          0 :           kr = &amp;(fSectors[sec][row]);</span>
<span class="lineNum">    5643 </span><span class="lineNoCov">          0 :           Double_t xn = kr-&gt;GetX(); //RS: use row X as a first guess about distorted cluster x</span>
<span class="lineNum">    5644 </span><span class="lineNoCov">          0 :           Double_t ymax1 = fSectors-&gt;GetMaxY(row)-kr-&gt;GetDeadZone()-1.5; // RS: watch dead zones</span>
<span class="lineNum">    5645 </span><span class="lineNoCov">          0 :           polytrack.GetFitPoint(xn,yn,zn);</span>
<span class="lineNum">    5646 </span><span class="lineNoCov">          0 :           double dxn = GetDistortionX(xn, yn, zn, sec, row);</span>
<span class="lineNum">    5647 </span><span class="lineNoCov">          0 :           if (TMath::Abs(dxn)&gt;0.1) {    //RS: account for distortion</span>
<span class="lineNum">    5648 </span><span class="lineNoCov">          0 :             xn += dxn;  </span>
<span class="lineNum">    5649 </span><span class="lineNoCov">          0 :             polytrack.GetFitPoint(xn,yn,zn);    </span>
<span class="lineNum">    5650 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    5651 </span>            :           //
<span class="lineNum">    5652 </span><span class="lineNoCov">          0 :           if (TMath::Abs(yn)&gt;ymax1) continue; // RS:? watch dead zones</span>
<span class="lineNum">    5653 </span><span class="lineNoCov">          0 :           nfoundable++;</span>
<span class="lineNum">    5654 </span><span class="lineNoCov">          0 :           AliTPCclusterMI * cln = kr-&gt;FindNearest(yn,zn,kRoadY+fClExtraRoadY,kRoadZ+fClExtraRoadZ);</span>
<span class="lineNum">    5655 </span><span class="lineNoCov">          0 :           if (cln) {</span>
<span class="lineNum">    5656 </span><span class="lineNoCov">          0 :             Float_t dist =  TMath::Sqrt(  (yn-cln-&gt;GetY())*(yn-cln-&gt;GetY())+(zn-cln-&gt;GetZ())*(zn-cln-&gt;GetZ()));</span>
<span class="lineNum">    5657 </span><span class="lineNoCov">          0 :             if (dist&lt;maxdist){</span>
<span class="lineNum">    5658 </span>            :               /*
<span class="lineNum">    5659 </span>            :               erry = (dist+0.3)*cln-&gt;GetSigmaY2()/TMath::Sqrt(cln-&gt;GetQ())*(1.+1./(ddrow));           
<span class="lineNum">    5660 </span>            :               errz = (dist+0.3)*cln-&gt;GetSigmaZ2()/TMath::Sqrt(cln-&gt;GetQ())*(1.+1./(ddrow));
<span class="lineNum">    5661 </span>            :               if (cln-&gt;IsUsed(10)) {
<span class="lineNum">    5662 </span>            :                 //      printf(&quot;used\n&quot;);
<span class="lineNum">    5663 </span>            :                 sumused++;
<span class="lineNum">    5664 </span>            :                 erry*=2;
<span class="lineNum">    5665 </span>            :                 errz*=2;
<span class="lineNum">    5666 </span>            :               }
<span class="lineNum">    5667 </span>            :               */
<span class="lineNum">    5668 </span>            :               erry=0.1;
<span class="lineNum">    5669 </span>            :               errz=0.1;
<span class="lineNum">    5670 </span><span class="lineNoCov">          0 :               polytrack.AddPoint(xn,cln-&gt;GetY(),cln-&gt;GetZ(),erry, errz);</span>
<span class="lineNum">    5671 </span><span class="lineNoCov">          0 :               if (row&gt;rowMax) rowMax = row;</span>
<span class="lineNum">    5672 </span><span class="lineNoCov">          0 :               nfound++;</span>
<span class="lineNum">    5673 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    5674 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    5675 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5676 </span><span class="lineNoCov">          0 :         if ( (sumused&gt;3) || (sumused&gt;0.5*nfound) || (nfound&lt;0.6*nfoundable))  break;     </span>
<span class="lineNum">    5677 </span><span class="lineNoCov">          0 :         polytrack.UpdateParameters();</span>
<span class="lineNum">    5678 </span><span class="lineNoCov">          0 :       }           </span>
<span class="lineNum">    5679 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    5680 </span><span class="lineNoCov">          0 :     if ( (sumused&gt;3) || (sumused&gt;0.5*nfound))  {</span>
<span class="lineNum">    5681 </span>            :       //printf(&quot;sumused   %d\n&quot;,sumused);
<span class="lineNum">    5682 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    5683 </span>            :     }
<span class="lineNum">    5684 </span><span class="lineNoCov">          0 :     nin1++;</span>
<span class="lineNum">    5685 </span><span class="lineNoCov">          0 :     Double_t dy,dz;</span>
<span class="lineNum">    5686 </span><span class="lineNoCov">          0 :     polytrack.GetFitDerivation(kr0.GetX(),dy,dz); // RS: Note: derivative is at ideal row X</span>
<span class="lineNum">    5687 </span><span class="lineNoCov">          0 :     AliTPCpolyTrack track2;</span>
<span class="lineNum">    5688 </span>            :     
<span class="lineNum">    5689 </span><span class="lineNoCov">          0 :     polytrack.Refit(track2,0.5+TMath::Abs(dy)*0.3,0.4+TMath::Abs(dz)*0.3);</span>
<span class="lineNum">    5690 </span><span class="lineNoCov">          0 :     if (track2.GetN()&lt;0.5*nfoundable) continue;</span>
<span class="lineNum">    5691 </span><span class="lineNoCov">          0 :     nin2++;</span>
<span class="lineNum">    5692 </span>            : 
<span class="lineNum">    5693 </span><span class="lineNoCov">          0 :     if ((nfound&gt;0.6*nfoundable) &amp;&amp;( nfoundable&gt;0.4*(i1-i2))) {</span>
<span class="lineNum">    5694 </span>            :       //
<span class="lineNum">    5695 </span>            :       // test seed with and without constrain
<span class="lineNum">    5696 </span><span class="lineNoCov">          0 :       for (Int_t constrain=0; constrain&lt;=0;constrain++){</span>
<span class="lineNum">    5697 </span>            :         // add polytrack candidate
<span class="lineNum">    5698 </span>            : 
<span class="lineNum">    5699 </span><span class="lineNoCov">          0 :         Double_t x[5], c[15];</span>
<span class="lineNum">    5700 </span><span class="lineNoCov">          0 :         Double_t x1,x2,x3,y1,y2,y3,z1,z2,z3;</span>
<span class="lineNum">    5701 </span><span class="lineNoCov">          0 :         track2.GetBoundaries(x3,x1);    </span>
<span class="lineNum">    5702 </span><span class="lineNoCov">          0 :         x2 = (x1+x3)/2.;</span>
<span class="lineNum">    5703 </span><span class="lineNoCov">          0 :         track2.GetFitPoint(x1,y1,z1);</span>
<span class="lineNum">    5704 </span><span class="lineNoCov">          0 :         track2.GetFitPoint(x2,y2,z2);</span>
<span class="lineNum">    5705 </span><span class="lineNoCov">          0 :         track2.GetFitPoint(x3,y3,z3);</span>
<span class="lineNum">    5706 </span>            :         //
<span class="lineNum">    5707 </span>            :         //is track pointing to the vertex ?
<span class="lineNum">    5708 </span><span class="lineNoCov">          0 :         Double_t x0,y0,z0;</span>
<span class="lineNum">    5709 </span>            :         x0=0;
<span class="lineNum">    5710 </span><span class="lineNoCov">          0 :         polytrack.GetFitPoint(x0,y0,z0);</span>
<span class="lineNum">    5711 </span>            : 
<span class="lineNum">    5712 </span><span class="lineNoCov">          0 :         if (constrain) {</span>
<span class="lineNum">    5713 </span><span class="lineNoCov">          0 :           x2 = x3;</span>
<span class="lineNum">    5714 </span><span class="lineNoCov">          0 :           y2 = y3;</span>
<span class="lineNum">    5715 </span><span class="lineNoCov">          0 :           z2 = z3;</span>
<span class="lineNum">    5716 </span>            :           
<span class="lineNum">    5717 </span><span class="lineNoCov">          0 :           x3 = 0;</span>
<span class="lineNum">    5718 </span><span class="lineNoCov">          0 :           y3 = 0;</span>
<span class="lineNum">    5719 </span><span class="lineNoCov">          0 :           z3 = 0;</span>
<span class="lineNum">    5720 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5721 </span><span class="lineNoCov">          0 :         x[0]=y1;</span>
<span class="lineNum">    5722 </span><span class="lineNoCov">          0 :         x[1]=z1;</span>
<span class="lineNum">    5723 </span><span class="lineNoCov">          0 :         x[4]=F1(x1,y1,x2,y2,x3,y3);</span>
<span class="lineNum">    5724 </span>            :                 
<span class="lineNum">    5725 </span>            :         //      if (TMath::Abs(x[4]) &gt;= cuts[0]) continue;  //
<span class="lineNum">    5726 </span><span class="lineNoCov">          0 :         x[2]=F2(x1,y1,x2,y2,x3,y3);</span>
<span class="lineNum">    5727 </span>            :         
<span class="lineNum">    5728 </span>            :         //if (TMath::Abs(x[4]*x1-x[2]) &gt;= cuts[1]) continue;
<span class="lineNum">    5729 </span>            :         //x[3]=F3(x1,y1,x2,y2,z1,z2);
<span class="lineNum">    5730 </span><span class="lineNoCov">          0 :         x[3]=F3n(x1,y1,x3,y3,z1,z3,x[4]);</span>
<span class="lineNum">    5731 </span>            :         //if (TMath::Abs(x[3]) &gt; cuts[3]) continue;
<span class="lineNum">    5732 </span>            : 
<span class="lineNum">    5733 </span>            :         
<span class="lineNum">    5734 </span>            :         Double_t sy =0.1, sz =0.1;
<span class="lineNum">    5735 </span>            :         Double_t sy1=0.02, sz1=0.02;
<span class="lineNum">    5736 </span>            :         Double_t sy2=0.02, sz2=0.02;
<span class="lineNum">    5737 </span>            :         Double_t sy3=0.02;
<span class="lineNum">    5738 </span>            : 
<span class="lineNum">    5739 </span><span class="lineNoCov">          0 :         if (constrain){</span>
<span class="lineNum">    5740 </span><span class="lineNoCov">          0 :           sy3=25000*x[4]*x[4]+0.1, sy=0.1, sz=0.1;</span>
<span class="lineNum">    5741 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5742 </span>            :         
<span class="lineNum">    5743 </span><span class="lineNoCov">          0 :         Double_t f40=(F1(x1,y1+sy,x2,y2,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    5744 </span><span class="lineNoCov">          0 :         Double_t f42=(F1(x1,y1,x2,y2+sy,x3,y3)-x[4])/sy;</span>
<span class="lineNum">    5745 </span><span class="lineNoCov">          0 :         Double_t f43=(F1(x1,y1,x2,y2,x3,y3+sy)-x[4])/sy;</span>
<span class="lineNum">    5746 </span><span class="lineNoCov">          0 :         Double_t f20=(F2(x1,y1+sy,x2,y2,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    5747 </span><span class="lineNoCov">          0 :         Double_t f22=(F2(x1,y1,x2,y2+sy,x3,y3)-x[2])/sy;</span>
<span class="lineNum">    5748 </span><span class="lineNoCov">          0 :         Double_t f23=(F2(x1,y1,x2,y2,x3,y3+sy)-x[2])/sy;</span>
<span class="lineNum">    5749 </span>            : 
<span class="lineNum">    5750 </span><span class="lineNoCov">          0 :         Double_t f30=(F3(x1,y1+sy,x3,y3,z1,z3)-x[3])/sy;</span>
<span class="lineNum">    5751 </span><span class="lineNoCov">          0 :         Double_t f31=(F3(x1,y1,x3,y3,z1+sz,z3)-x[3])/sz;</span>
<span class="lineNum">    5752 </span><span class="lineNoCov">          0 :         Double_t f32=(F3(x1,y1,x3,y3+sy,z1,z3)-x[3])/sy;</span>
<span class="lineNum">    5753 </span><span class="lineNoCov">          0 :         Double_t f34=(F3(x1,y1,x3,y3,z1,z3+sz)-x[3])/sz;</span>
<span class="lineNum">    5754 </span>            : 
<span class="lineNum">    5755 </span>            :         
<span class="lineNum">    5756 </span><span class="lineNoCov">          0 :         c[0]=sy1;</span>
<span class="lineNum">    5757 </span><span class="lineNoCov">          0 :         c[1]=0.;       c[2]=sz1;</span>
<span class="lineNum">    5758 </span><span class="lineNoCov">          0 :         c[3]=f20*sy1;  c[4]=0.;       c[5]=f20*sy1*f20+f22*sy2*f22+f23*sy3*f23;</span>
<span class="lineNum">    5759 </span><span class="lineNoCov">          0 :         c[6]=f30*sy1;  c[7]=f31*sz1;  c[8]=f30*sy1*f20+f32*sy2*f22;</span>
<span class="lineNum">    5760 </span><span class="lineNoCov">          0 :         c[9]=f30*sy1*f30+f31*sz1*f31+f32*sy2*f32+f34*sz2*f34;</span>
<span class="lineNum">    5761 </span><span class="lineNoCov">          0 :         c[10]=f40*sy1; c[11]=0.; c[12]=f40*sy1*f20+f42*sy2*f22+f43*sy3*f23;</span>
<span class="lineNum">    5762 </span><span class="lineNoCov">          0 :         c[13]=f30*sy1*f40+f32*sy2*f42;</span>
<span class="lineNum">    5763 </span><span class="lineNoCov">          0 :         c[14]=f40*sy1*f40+f42*sy2*f42+f43*sy3*f43;</span>
<span class="lineNum">    5764 </span>            :         
<span class="lineNum">    5765 </span>            :         //Int_t row1 = GetRowNumber(x1); // RS: this is now substituted by rowMax
<span class="lineNum">    5766 </span>            : 
<span class="lineNum">    5767 </span>            :         UInt_t index=0;
<span class="lineNum">    5768 </span>            :         //kr0.GetIndex(is);
<span class="lineNum">    5769 </span><span class="lineNoCov">          0 :         if (seed) {MarkSeedFree( seed ); seed = 0;}</span>
<span class="lineNum">    5770 </span><span class="lineNoCov">          0 :         AliTPCseed *track = seed = new( NextFreeSeed() ) AliTPCseed(x1,sec*alpha+shift,x,c,index);</span>
<span class="lineNum">    5771 </span><span class="lineNoCov">          0 :         seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    5772 </span><span class="lineNoCov">          0 :         seed-&gt;SetRow(rowMax); //RS: memorise row of x1</span>
<span class="lineNum">    5773 </span><span class="lineNoCov">          0 :         track-&gt;SetIsSeeding(kTRUE);</span>
<span class="lineNum">    5774 </span><span class="lineNoCov">          0 :         Int_t rc=FollowProlongation(*track, i2);        </span>
<span class="lineNum">    5775 </span><span class="lineNoCov">          0 :         if (constrain) track-&gt;SetBConstrain(1);</span>
<span class="lineNum">    5776 </span>            :         else
<span class="lineNum">    5777 </span><span class="lineNoCov">          0 :           track-&gt;SetBConstrain(0);</span>
<span class="lineNum">    5778 </span><span class="lineNoCov">          0 :         track-&gt;SetLastPoint(rowMax); //row1+fInnerSec-&gt;GetNRows());  // first cluster in track position</span>
<span class="lineNum">    5779 </span><span class="lineNoCov">          0 :         track-&gt;SetFirstPoint(track-&gt;GetLastPoint());</span>
<span class="lineNum">    5780 </span>            : 
<span class="lineNum">    5781 </span><span class="lineNoCov">          0 :         if (rc==0 || track-&gt;GetNumberOfClusters()&lt;(i1-i2)*0.5 || </span>
<span class="lineNum">    5782 </span><span class="lineNoCov">          0 :             track-&gt;GetNumberOfClusters() &lt; track-&gt;GetNFoundable()*0.6 || </span>
<span class="lineNum">    5783 </span><span class="lineNoCov">          0 :             track-&gt;GetNShared()&gt;0.4*track-&gt;GetNumberOfClusters()) {</span>
<span class="lineNum">    5784 </span><span class="lineNoCov">          0 :           MarkSeedFree( seed ); seed = 0;</span>
<span class="lineNum">    5785 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5786 </span>            :         else {
<span class="lineNum">    5787 </span><span class="lineNoCov">          0 :           arr-&gt;AddLast(track); // track IS seed, don't free seed</span>
<span class="lineNum">    5788 </span><span class="lineNoCov">          0 :           seed = new( NextFreeSeed() ) AliTPCseed;</span>
<span class="lineNum">    5789 </span><span class="lineNoCov">          0 :           seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    5790 </span>            :         }
<span class="lineNum">    5791 </span><span class="lineNoCov">          0 :         nin3++;</span>
<span class="lineNum">    5792 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    5793 </span><span class="lineNoCov">          0 :     }  // if accepted seed</span>
<span class="lineNum">    5794 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5795 </span><span class="lineNoCov">          0 :   if (fDebug&gt;3){</span>
<span class="lineNum">    5796 </span><span class="lineNoCov">          0 :     Info(&quot;MakeSeeds2&quot;,&quot;\nSeeding statiistic:\t%d\t%d\t%d\t%d&quot;,nin0,nin1,nin2,nin3);</span>
<span class="lineNum">    5797 </span>            :   }
<span class="lineNum">    5798 </span><span class="lineNoCov">          0 :   if (seed) MarkSeedFree( seed );</span>
<span class="lineNum">    5799 </span><span class="lineNoCov">          0 : }</span>
<a name="5800"><span class="lineNum">    5800 </span>            : </a>
<span class="lineNum">    5801 </span>            : 
<span class="lineNum">    5802 </span>            : AliTPCseed *AliTPCtracker::MakeSeed(AliTPCseed *const track, Float_t r0, Float_t r1, Float_t r2)
<span class="lineNum">    5803 </span>            : {
<span class="lineNum">    5804 </span>            :   //
<span class="lineNum">    5805 </span>            :   //
<span class="lineNum">    5806 </span>            :   //reseed using track points
<span class="lineNum">    5807 </span><span class="lineCov">        172 :   Int_t p0 = int(r0*track-&gt;GetNumberOfClusters());     // point 0 </span>
<span class="lineNum">    5808 </span><span class="lineCov">         86 :   Int_t p1 = int(r1*track-&gt;GetNumberOfClusters());</span>
<span class="lineNum">    5809 </span><span class="lineCov">         86 :   Int_t p2 = int(r2*track-&gt;GetNumberOfClusters());   // last point</span>
<span class="lineNum">    5810 </span>            :   Int_t pp2=0;
<span class="lineNum">    5811 </span><span class="lineCov">         86 :   Double_t  x0[3],x1[3],x2[3];</span>
<span class="lineNum">    5812 </span><span class="lineCov">        688 :   for (Int_t i=0;i&lt;3;i++){</span>
<span class="lineNum">    5813 </span><span class="lineCov">        258 :     x0[i]=-1;</span>
<span class="lineNum">    5814 </span><span class="lineCov">        258 :     x1[i]=-1;</span>
<span class="lineNum">    5815 </span><span class="lineCov">        258 :     x2[i]=-1;</span>
<span class="lineNum">    5816 </span>            :   }
<span class="lineNum">    5817 </span>            : 
<span class="lineNum">    5818 </span>            :   // find track position at given ratio of the length
<span class="lineNum">    5819 </span>            :   Int_t  sec0=0, sec1=0, sec2=0;
<span class="lineNum">    5820 </span>            :   Int_t index=-1;
<span class="lineNum">    5821 </span>            :   Int_t clindex;
<span class="lineNum">    5822 </span><span class="lineCov">      27520 :   for (Int_t i=0;i&lt;kMaxRow;i++){</span>
<span class="lineNum">    5823 </span><span class="lineCov">      13674 :     if (track-&gt;GetClusterIndex2(i)&gt;=0){</span>
<span class="lineNum">    5824 </span><span class="lineCov">       2068 :       index++;</span>
<span class="lineNum">    5825 </span><span class="lineCov">       2068 :       const AliTPCTrackerPoints::Point *trpoint =track-&gt;GetTrackPoint(i);</span>
<span class="lineNum">    5826 </span><span class="lineCov">       3756 :       if ( (index&lt;p0) || x0[0]&lt;0 ){</span>
<span class="lineNum">    5827 </span><span class="lineCov">        380 :         if (trpoint-&gt;GetX()&gt;1){</span>
<span class="lineNum">    5828 </span><span class="lineCov">        380 :           clindex = track-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    5829 </span><span class="lineCov">        380 :           if (clindex &gt;= 0){ </span>
<span class="lineNum">    5830 </span><span class="lineCov">        380 :             x0[0] = trpoint-&gt;GetX();</span>
<span class="lineNum">    5831 </span><span class="lineCov">        380 :             x0[1] = trpoint-&gt;GetY();</span>
<span class="lineNum">    5832 </span><span class="lineCov">        380 :             x0[2] = trpoint-&gt;GetZ();</span>
<span class="lineNum">    5833 </span><span class="lineCov">        380 :             sec0  = ((clindex&amp;0xff000000)&gt;&gt;24)%18;</span>
<span class="lineNum">    5834 </span><span class="lineCov">        380 :           }</span>
<span class="lineNum">    5835 </span>            :         }
<span class="lineNum">    5836 </span>            :       }
<span class="lineNum">    5837 </span>            : 
<span class="lineNum">    5838 </span><span class="lineCov">       3084 :       if ( (index&lt;p1) &amp;&amp;(trpoint-&gt;GetX()&gt;1)){</span>
<span class="lineNum">    5839 </span><span class="lineCov">       1016 :         clindex = track-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    5840 </span><span class="lineCov">       1016 :         if (clindex &gt;= 0){</span>
<span class="lineNum">    5841 </span><span class="lineCov">       1016 :           x1[0] = trpoint-&gt;GetX();</span>
<span class="lineNum">    5842 </span><span class="lineCov">       1016 :           x1[1] = trpoint-&gt;GetY();</span>
<span class="lineNum">    5843 </span><span class="lineCov">       1016 :           x1[2] = trpoint-&gt;GetZ();</span>
<span class="lineNum">    5844 </span><span class="lineCov">       1016 :           sec1  = ((clindex&amp;0xff000000)&gt;&gt;24)%18;</span>
<span class="lineNum">    5845 </span><span class="lineCov">       1016 :         }</span>
<span class="lineNum">    5846 </span>            :       }
<span class="lineNum">    5847 </span><span class="lineCov">       3912 :       if ( (index&lt;p2) &amp;&amp;(trpoint-&gt;GetX()&gt;1)){</span>
<span class="lineNum">    5848 </span><span class="lineCov">       1844 :         clindex = track-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    5849 </span><span class="lineCov">       1844 :         if (clindex &gt;= 0){</span>
<span class="lineNum">    5850 </span><span class="lineCov">       1844 :           x2[0] = trpoint-&gt;GetX();</span>
<span class="lineNum">    5851 </span><span class="lineCov">       1844 :           x2[1] = trpoint-&gt;GetY();</span>
<span class="lineNum">    5852 </span><span class="lineCov">       1844 :           x2[2] = trpoint-&gt;GetZ(); </span>
<span class="lineNum">    5853 </span><span class="lineCov">       1844 :           sec2  = ((clindex&amp;0xff000000)&gt;&gt;24)%18;</span>
<span class="lineNum">    5854 </span>            :           pp2 = i;
<span class="lineNum">    5855 </span><span class="lineCov">       1844 :         }</span>
<span class="lineNum">    5856 </span>            :       }
<span class="lineNum">    5857 </span><span class="lineCov">       2068 :     }</span>
<span class="lineNum">    5858 </span>            :   }
<span class="lineNum">    5859 </span>            :   
<span class="lineNum">    5860 </span>            :   Double_t alpha, cs,sn, xx2,yy2;
<span class="lineNum">    5861 </span>            :   //
<span class="lineNum">    5862 </span><span class="lineCov">         86 :   alpha = (sec1-sec2)*fSectors-&gt;GetAlpha();</span>
<span class="lineNum">    5863 </span><span class="lineCov">         86 :   cs = TMath::Cos(alpha);</span>
<span class="lineNum">    5864 </span><span class="lineCov">         86 :   sn = TMath::Sin(alpha); </span>
<span class="lineNum">    5865 </span><span class="lineCov">         86 :   xx2= x1[0]*cs-x1[1]*sn;</span>
<span class="lineNum">    5866 </span><span class="lineCov">         86 :   yy2= x1[0]*sn+x1[1]*cs;</span>
<span class="lineNum">    5867 </span><span class="lineCov">         86 :   x1[0] = xx2;</span>
<span class="lineNum">    5868 </span><span class="lineCov">         86 :   x1[1] = yy2;</span>
<span class="lineNum">    5869 </span>            :   //
<span class="lineNum">    5870 </span><span class="lineCov">         86 :   alpha = (sec0-sec2)*fSectors-&gt;GetAlpha();</span>
<span class="lineNum">    5871 </span><span class="lineCov">         86 :   cs = TMath::Cos(alpha);</span>
<span class="lineNum">    5872 </span><span class="lineCov">         86 :   sn = TMath::Sin(alpha); </span>
<span class="lineNum">    5873 </span><span class="lineCov">         86 :   xx2= x0[0]*cs-x0[1]*sn;</span>
<span class="lineNum">    5874 </span><span class="lineCov">         86 :   yy2= x0[0]*sn+x0[1]*cs;</span>
<span class="lineNum">    5875 </span><span class="lineCov">         86 :   x0[0] = xx2;</span>
<span class="lineNum">    5876 </span><span class="lineCov">         86 :   x0[1] = yy2;</span>
<span class="lineNum">    5877 </span>            :   //
<span class="lineNum">    5878 </span>            :   //
<span class="lineNum">    5879 </span>            :   //
<span class="lineNum">    5880 </span><span class="lineCov">         86 :   Double_t x[5],c[15];</span>
<span class="lineNum">    5881 </span>            :   //
<span class="lineNum">    5882 </span><span class="lineCov">         86 :   x[0]=x2[1];</span>
<span class="lineNum">    5883 </span><span class="lineCov">         86 :   x[1]=x2[2];</span>
<span class="lineNum">    5884 </span><span class="lineCov">         86 :   x[4]=F1(x2[0],x2[1],x1[0],x1[1],x0[0],x0[1]);</span>
<span class="lineNum">    5885 </span>            :   //  if (x[4]&gt;1) return 0;
<span class="lineNum">    5886 </span><span class="lineCov">         86 :   x[2]=F2(x2[0],x2[1],x1[0],x1[1],x0[0],x0[1]);</span>
<span class="lineNum">    5887 </span><span class="lineCov">         86 :   x[3]=F3n(x2[0],x2[1],x0[0],x0[1],x2[2],x0[2],x[4]);</span>
<span class="lineNum">    5888 </span>            :   //if (TMath::Abs(x[3]) &gt; 2.2)  return 0;
<span class="lineNum">    5889 </span>            :   //if (TMath::Abs(x[2]) &gt; 1.99) return 0;
<span class="lineNum">    5890 </span>            :   //  
<span class="lineNum">    5891 </span>            :   Double_t sy =0.1,  sz =0.1;
<span class="lineNum">    5892 </span>            :   //
<span class="lineNum">    5893 </span><span class="lineCov">         86 :   Double_t sy1=0.02+track-&gt;GetSigmaY2(), sz1=0.02+track-&gt;GetSigmaZ2();</span>
<span class="lineNum">    5894 </span><span class="lineCov">         86 :   Double_t sy2=0.01+track-&gt;GetSigmaY2(), sz2=0.01+track-&gt;GetSigmaZ2();</span>
<span class="lineNum">    5895 </span><span class="lineCov">         86 :   Double_t sy3=0.01+track-&gt;GetSigmaY2();</span>
<span class="lineNum">    5896 </span>            :   //
<span class="lineNum">    5897 </span><span class="lineCov">         86 :   Double_t f40=(F1(x2[0],x2[1]+sy,x1[0],x1[1],x0[0],x0[1])-x[4])/sy;</span>
<span class="lineNum">    5898 </span><span class="lineCov">         86 :   Double_t f42=(F1(x2[0],x2[1],x1[0],x1[1]+sy,x0[0],x0[1])-x[4])/sy;</span>
<span class="lineNum">    5899 </span><span class="lineCov">         86 :   Double_t f43=(F1(x2[0],x2[1],x1[0],x1[1],x0[0],x0[1]+sy)-x[4])/sy;</span>
<span class="lineNum">    5900 </span><span class="lineCov">         86 :   Double_t f20=(F2(x2[0],x2[1]+sy,x1[0],x1[1],x0[0],x0[1])-x[2])/sy;</span>
<span class="lineNum">    5901 </span><span class="lineCov">         86 :   Double_t f22=(F2(x2[0],x2[1],x1[0],x1[1]+sy,x0[0],x0[1])-x[2])/sy;</span>
<span class="lineNum">    5902 </span><span class="lineCov">         86 :   Double_t f23=(F2(x2[0],x2[1],x1[0],x1[1],x0[0],x0[1]+sy)-x[2])/sy;</span>
<span class="lineNum">    5903 </span>            :   //
<span class="lineNum">    5904 </span><span class="lineCov">         86 :   Double_t f30=(F3(x2[0],x2[1]+sy,x0[0],x0[1],x2[2],x0[2])-x[3])/sy;</span>
<span class="lineNum">    5905 </span><span class="lineCov">         86 :   Double_t f31=(F3(x2[0],x2[1],x0[0],x0[1],x2[2]+sz,x0[2])-x[3])/sz;</span>
<span class="lineNum">    5906 </span><span class="lineCov">         86 :   Double_t f32=(F3(x2[0],x2[1],x0[0],x0[1]+sy,x2[2],x0[2])-x[3])/sy;</span>
<span class="lineNum">    5907 </span><span class="lineCov">         86 :   Double_t f34=(F3(x2[0],x2[1],x0[0],x0[1],x2[2],x0[2]+sz)-x[3])/sz;</span>
<span class="lineNum">    5908 </span>            :   
<span class="lineNum">    5909 </span>            :   
<span class="lineNum">    5910 </span><span class="lineCov">         86 :   c[0]=sy1;</span>
<span class="lineNum">    5911 </span><span class="lineCov">         86 :   c[1]=0.;       c[2]=sz1;</span>
<span class="lineNum">    5912 </span><span class="lineCov">         86 :   c[3]=f20*sy1;  c[4]=0.;       c[5]=f20*sy1*f20+f22*sy2*f22+f23*sy3*f23;</span>
<span class="lineNum">    5913 </span><span class="lineCov">         86 :   c[6]=f30*sy1;  c[7]=f31*sz1;  c[8]=f30*sy1*f20+f32*sy2*f22;</span>
<span class="lineNum">    5914 </span><span class="lineCov">         86 :   c[9]=f30*sy1*f30+f31*sz1*f31+f32*sy2*f32+f34*sz2*f34;</span>
<span class="lineNum">    5915 </span><span class="lineCov">         86 :   c[10]=f40*sy1; c[11]=0.; c[12]=f40*sy1*f20+f42*sy2*f22+f43*sy3*f23;</span>
<span class="lineNum">    5916 </span><span class="lineCov">         86 :   c[13]=f30*sy1*f40+f32*sy2*f42;</span>
<span class="lineNum">    5917 </span><span class="lineCov">         86 :   c[14]=f40*sy1*f40+f42*sy2*f42+f43*sy3*f43;</span>
<span class="lineNum">    5918 </span>            :   
<span class="lineNum">    5919 </span>            :   //  Int_t row1 = fSectors-&gt;GetRowNumber(x2[0]);
<span class="lineNum">    5920 </span><span class="lineCov">         86 :   AliTPCseed *seed = new( NextFreeSeed() )  AliTPCseed(x2[0], sec2*fSectors-&gt;GetAlpha()+fSectors-&gt;GetAlphaShift(), x, c, 0);</span>
<span class="lineNum">    5921 </span><span class="lineCov">         86 :   seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    5922 </span><span class="lineCov">         86 :   seed-&gt;SetRow(pp2); //RS: memorise current row</span>
<span class="lineNum">    5923 </span>            :   //  Double_t y0,z0,y1,z1, y2,z2;
<span class="lineNum">    5924 </span>            :   //seed-&gt;GetProlongation(x0[0],y0,z0);
<span class="lineNum">    5925 </span>            :   // seed-&gt;GetProlongation(x1[0],y1,z1);
<span class="lineNum">    5926 </span>            :   //seed-&gt;GetProlongation(x2[0],y2,z2);
<span class="lineNum">    5927 </span>            :   //  seed =0;
<span class="lineNum">    5928 </span><span class="lineCov">         86 :   seed-&gt;SetLastPoint(pp2);</span>
<span class="lineNum">    5929 </span><span class="lineCov">         86 :   seed-&gt;SetFirstPoint(pp2);</span>
<span class="lineNum">    5930 </span>            :   
<span class="lineNum">    5931 </span>            : 
<span class="lineNum">    5932 </span><span class="lineCov">         86 :   return seed;</span>
<span class="lineNum">    5933 </span><span class="lineCov">         86 : }</span>
<a name="5934"><span class="lineNum">    5934 </span>            : </a>
<span class="lineNum">    5935 </span>            : 
<span class="lineNum">    5936 </span>            : AliTPCseed *AliTPCtracker::ReSeed(const AliTPCseed *track, Float_t r0, Float_t r1, Float_t r2)
<span class="lineNum">    5937 </span>            : {
<span class="lineNum">    5938 </span>            :   //
<span class="lineNum">    5939 </span>            :   //
<span class="lineNum">    5940 </span>            :   //reseed using founded clusters 
<span class="lineNum">    5941 </span>            :   //
<span class="lineNum">    5942 </span>            :   // Find the number of clusters
<span class="lineNum">    5943 </span>            :   Int_t nclusters = 0;
<span class="lineNum">    5944 </span><span class="lineNoCov">          0 :   for (Int_t irow=0;irow&lt;kMaxRow;irow++){</span>
<span class="lineNum">    5945 </span><span class="lineNoCov">          0 :     if (track-&gt;GetClusterIndex(irow)&gt;0) nclusters++;</span>
<span class="lineNum">    5946 </span>            :   }
<span class="lineNum">    5947 </span>            :   //
<span class="lineNum">    5948 </span><span class="lineNoCov">          0 :   Int_t ipos[3];</span>
<span class="lineNum">    5949 </span><span class="lineNoCov">          0 :   ipos[0] = TMath::Max(int(r0*nclusters),0);             // point 0 cluster</span>
<span class="lineNum">    5950 </span><span class="lineNoCov">          0 :   ipos[1] = TMath::Min(int(r1*nclusters),nclusters-1);   // </span>
<span class="lineNum">    5951 </span><span class="lineNoCov">          0 :   ipos[2] = TMath::Min(int(r2*nclusters),nclusters-1);   // last point</span>
<span class="lineNum">    5952 </span>            :   //
<span class="lineNum">    5953 </span>            :   //
<span class="lineNum">    5954 </span><span class="lineNoCov">          0 :   Double_t  xyz[3][3]={{0}};</span>
<span class="lineNum">    5955 </span><span class="lineNoCov">          0 :   Int_t     row[3]={0},sec[3]={0,0,0};</span>
<span class="lineNum">    5956 </span>            :   //
<span class="lineNum">    5957 </span>            :   // find track row position at given ratio of the length
<span class="lineNum">    5958 </span>            :   Int_t index=-1;
<span class="lineNum">    5959 </span><span class="lineNoCov">          0 :   for (Int_t irow=0;irow&lt;kMaxRow;irow++){    </span>
<span class="lineNum">    5960 </span><span class="lineNoCov">          0 :     if (track-&gt;GetClusterIndex2(irow)&lt;0) continue;</span>
<span class="lineNum">    5961 </span><span class="lineNoCov">          0 :     index++;</span>
<span class="lineNum">    5962 </span><span class="lineNoCov">          0 :     for (Int_t ipoint=0;ipoint&lt;3;ipoint++){</span>
<span class="lineNum">    5963 </span><span class="lineNoCov">          0 :       if (index&lt;=ipos[ipoint]) row[ipoint] = irow;</span>
<span class="lineNum">    5964 </span>            :     }        
<span class="lineNum">    5965 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5966 </span>            :   //
<span class="lineNum">    5967 </span>            :   //Get cluster and sector position
<span class="lineNum">    5968 </span><span class="lineNoCov">          0 :   for (Int_t ipoint=0;ipoint&lt;3;ipoint++){</span>
<span class="lineNum">    5969 </span><span class="lineNoCov">          0 :     Int_t clindex = track-&gt;GetClusterIndex2(row[ipoint]);    </span>
<span class="lineNum">    5970 </span><span class="lineNoCov">          0 :     AliTPCclusterMI * cl = clindex&lt;0 ? 0:GetClusterMI(clindex);</span>
<span class="lineNum">    5971 </span><span class="lineNoCov">          0 :     if (cl==0) {</span>
<span class="lineNum">    5972 </span>            :       //Error(&quot;Bug\n&quot;);
<span class="lineNum">    5973 </span>            :       //      AliTPCclusterMI * cl = GetClusterMI(clindex);
<span class="lineNum">    5974 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">    5975 </span>            :     }
<span class="lineNum">    5976 </span><span class="lineNoCov">          0 :     sec[ipoint]     = ((clindex&amp;0xff000000)&gt;&gt;24)%18;</span>
<span class="lineNum">    5977 </span><span class="lineNoCov">          0 :     xyz[ipoint][0]  = GetXrow(row[ipoint]);</span>
<span class="lineNum">    5978 </span><span class="lineNoCov">          0 :     xyz[ipoint][1]  = cl-&gt;GetY();</span>
<span class="lineNum">    5979 </span><span class="lineNoCov">          0 :     xyz[ipoint][2]  = cl-&gt;GetZ();</span>
<span class="lineNum">    5980 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5981 </span>            :   //
<span class="lineNum">    5982 </span>            :   //
<span class="lineNum">    5983 </span>            :   // Calculate seed state vector and covariance matrix
<span class="lineNum">    5984 </span>            : 
<span class="lineNum">    5985 </span>            :   Double_t alpha, cs,sn, xx2,yy2;
<span class="lineNum">    5986 </span>            :   //
<span class="lineNum">    5987 </span><span class="lineNoCov">          0 :   alpha = (sec[1]-sec[2])*fSectors-&gt;GetAlpha();</span>
<span class="lineNum">    5988 </span><span class="lineNoCov">          0 :   cs = TMath::Cos(alpha);</span>
<span class="lineNum">    5989 </span><span class="lineNoCov">          0 :   sn = TMath::Sin(alpha); </span>
<span class="lineNum">    5990 </span><span class="lineNoCov">          0 :   xx2= xyz[1][0]*cs-xyz[1][1]*sn;</span>
<span class="lineNum">    5991 </span><span class="lineNoCov">          0 :   yy2= xyz[1][0]*sn+xyz[1][1]*cs;</span>
<span class="lineNum">    5992 </span><span class="lineNoCov">          0 :   xyz[1][0] = xx2;</span>
<span class="lineNum">    5993 </span><span class="lineNoCov">          0 :   xyz[1][1] = yy2;</span>
<span class="lineNum">    5994 </span>            :   //
<span class="lineNum">    5995 </span><span class="lineNoCov">          0 :   alpha = (sec[0]-sec[2])*fSectors-&gt;GetAlpha();</span>
<span class="lineNum">    5996 </span><span class="lineNoCov">          0 :   cs = TMath::Cos(alpha);</span>
<span class="lineNum">    5997 </span><span class="lineNoCov">          0 :   sn = TMath::Sin(alpha); </span>
<span class="lineNum">    5998 </span><span class="lineNoCov">          0 :   xx2= xyz[0][0]*cs-xyz[0][1]*sn;</span>
<span class="lineNum">    5999 </span><span class="lineNoCov">          0 :   yy2= xyz[0][0]*sn+xyz[0][1]*cs;</span>
<span class="lineNum">    6000 </span><span class="lineNoCov">          0 :   xyz[0][0] = xx2;</span>
<span class="lineNum">    6001 </span><span class="lineNoCov">          0 :   xyz[0][1] = yy2;</span>
<span class="lineNum">    6002 </span>            :   //
<span class="lineNum">    6003 </span>            :   //
<span class="lineNum">    6004 </span>            :   //
<span class="lineNum">    6005 </span><span class="lineNoCov">          0 :   Double_t x[5],c[15];</span>
<span class="lineNum">    6006 </span>            :   //
<span class="lineNum">    6007 </span><span class="lineNoCov">          0 :   x[0]=xyz[2][1];</span>
<span class="lineNum">    6008 </span><span class="lineNoCov">          0 :   x[1]=xyz[2][2];</span>
<span class="lineNum">    6009 </span><span class="lineNoCov">          0 :   x[4]=F1(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1]);</span>
<span class="lineNum">    6010 </span><span class="lineNoCov">          0 :   x[2]=F2(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1]);</span>
<span class="lineNum">    6011 </span><span class="lineNoCov">          0 :   x[3]=F3n(xyz[2][0],xyz[2][1],xyz[0][0],xyz[0][1],xyz[2][2],xyz[0][2],x[4]);</span>
<span class="lineNum">    6012 </span>            :   //  
<span class="lineNum">    6013 </span>            :   Double_t sy =0.1,  sz =0.1;
<span class="lineNum">    6014 </span>            :   //
<span class="lineNum">    6015 </span>            :   Double_t sy1=0.2, sz1=0.2;
<span class="lineNum">    6016 </span>            :   Double_t sy2=0.2, sz2=0.2;
<span class="lineNum">    6017 </span>            :   Double_t sy3=0.2;
<span class="lineNum">    6018 </span>            :   //
<span class="lineNum">    6019 </span><span class="lineNoCov">          0 :   Double_t f40=(F1(xyz[2][0],xyz[2][1]+sy,xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1])-x[4])/sy;</span>
<span class="lineNum">    6020 </span><span class="lineNoCov">          0 :   Double_t f42=(F1(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1]+sy,xyz[0][0],xyz[0][1])-x[4])/sy;</span>
<span class="lineNum">    6021 </span><span class="lineNoCov">          0 :   Double_t f43=(F1(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1]+sy)-x[4])/sy;</span>
<span class="lineNum">    6022 </span><span class="lineNoCov">          0 :   Double_t f20=(F2(xyz[2][0],xyz[2][1]+sy,xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1])-x[2])/sy;</span>
<span class="lineNum">    6023 </span><span class="lineNoCov">          0 :   Double_t f22=(F2(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1]+sy,xyz[0][0],xyz[0][1])-x[2])/sy;</span>
<span class="lineNum">    6024 </span><span class="lineNoCov">          0 :   Double_t f23=(F2(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1]+sy)-x[2])/sy;</span>
<span class="lineNum">    6025 </span>            :   //
<span class="lineNum">    6026 </span><span class="lineNoCov">          0 :   Double_t f30=(F3(xyz[2][0],xyz[2][1]+sy,xyz[0][0],xyz[0][1],xyz[2][2],xyz[0][2])-x[3])/sy;</span>
<span class="lineNum">    6027 </span><span class="lineNoCov">          0 :   Double_t f31=(F3(xyz[2][0],xyz[2][1],xyz[0][0],xyz[0][1],xyz[2][2]+sz,xyz[0][2])-x[3])/sz;</span>
<span class="lineNum">    6028 </span><span class="lineNoCov">          0 :   Double_t f32=(F3(xyz[2][0],xyz[2][1],xyz[0][0],xyz[0][1]+sy,xyz[2][2],xyz[0][2])-x[3])/sy;</span>
<span class="lineNum">    6029 </span><span class="lineNoCov">          0 :   Double_t f34=(F3(xyz[2][0],xyz[2][1],xyz[0][0],xyz[0][1],xyz[2][2],xyz[0][2]+sz)-x[3])/sz;</span>
<span class="lineNum">    6030 </span>            :   
<span class="lineNum">    6031 </span>            :   
<span class="lineNum">    6032 </span><span class="lineNoCov">          0 :   c[0]=sy1;</span>
<span class="lineNum">    6033 </span><span class="lineNoCov">          0 :   c[1]=0.;       c[2]=sz1;</span>
<span class="lineNum">    6034 </span><span class="lineNoCov">          0 :   c[3]=f20*sy1;  c[4]=0.;       c[5]=f20*sy1*f20+f22*sy2*f22+f23*sy3*f23;</span>
<span class="lineNum">    6035 </span><span class="lineNoCov">          0 :   c[6]=f30*sy1;  c[7]=f31*sz1;  c[8]=f30*sy1*f20+f32*sy2*f22;</span>
<span class="lineNum">    6036 </span><span class="lineNoCov">          0 :   c[9]=f30*sy1*f30+f31*sz1*f31+f32*sy2*f32+f34*sz2*f34;</span>
<span class="lineNum">    6037 </span><span class="lineNoCov">          0 :   c[10]=f40*sy1; c[11]=0.; c[12]=f40*sy1*f20+f42*sy2*f22+f43*sy3*f23;</span>
<span class="lineNum">    6038 </span><span class="lineNoCov">          0 :   c[13]=f30*sy1*f40+f32*sy2*f42;</span>
<span class="lineNum">    6039 </span><span class="lineNoCov">          0 :   c[14]=f40*sy1*f40+f42*sy2*f42+f43*sy3*f43;</span>
<span class="lineNum">    6040 </span>            :   
<span class="lineNum">    6041 </span>            :   //  Int_t row1 = fSectors-&gt;GetRowNumber(xyz[2][0]);
<span class="lineNum">    6042 </span><span class="lineNoCov">          0 :   AliTPCseed *seed=new( NextFreeSeed() ) AliTPCseed(xyz[2][0], sec[2]*fSectors-&gt;GetAlpha()+fSectors-&gt;GetAlphaShift(), x, c, 0);</span>
<span class="lineNum">    6043 </span><span class="lineNoCov">          0 :   seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    6044 </span><span class="lineNoCov">          0 :   seed-&gt;SetRow(row[2]); //RS: memorise row</span>
<span class="lineNum">    6045 </span><span class="lineNoCov">          0 :   seed-&gt;SetLastPoint(row[2]);</span>
<span class="lineNum">    6046 </span><span class="lineNoCov">          0 :   seed-&gt;SetFirstPoint(row[2]);  </span>
<span class="lineNum">    6047 </span>            :   return seed;
<span class="lineNum">    6048 </span><span class="lineNoCov">          0 : }</span>
<a name="6049"><span class="lineNum">    6049 </span>            : </a>
<span class="lineNum">    6050 </span>            : 
<span class="lineNum">    6051 </span>            : AliTPCseed *AliTPCtracker::ReSeed(AliTPCseed *track,Int_t r0, Bool_t forward)
<span class="lineNum">    6052 </span>            : {
<span class="lineNum">    6053 </span>            :   //
<span class="lineNum">    6054 </span>            :   //
<span class="lineNum">    6055 </span>            :   //reseed using founded clusters 
<span class="lineNum">    6056 </span>            :   //
<span class="lineNum">    6057 </span><span class="lineCov">         52 :   Double_t  xyz[3][3];</span>
<span class="lineNum">    6058 </span><span class="lineCov">         52 :   Int_t     row[3]={0,0,0};</span>
<span class="lineNum">    6059 </span><span class="lineCov">         52 :   Int_t     sec[3]={0,0,0};</span>
<span class="lineNum">    6060 </span>            :   //
<span class="lineNum">    6061 </span>            :   // forward direction
<span class="lineNum">    6062 </span><span class="lineCov">         52 :   if (forward){</span>
<span class="lineNum">    6063 </span><span class="lineCov">        112 :     for (Int_t irow=r0;irow&lt;kMaxRow;irow++){</span>
<span class="lineNum">    6064 </span><span class="lineCov">         56 :       if (track-&gt;GetClusterIndex(irow)&gt;0){</span>
<span class="lineNum">    6065 </span><span class="lineCov">         52 :         row[0] = irow;</span>
<span class="lineNum">    6066 </span><span class="lineCov">         52 :         break;</span>
<span class="lineNum">    6067 </span>            :       }
<span class="lineNum">    6068 </span>            :     }
<span class="lineNum">    6069 </span><span class="lineCov">        384 :     for (Int_t irow=kMaxRow;irow&gt;r0;irow--){</span>
<span class="lineNum">    6070 </span><span class="lineCov">        192 :       if (track-&gt;GetClusterIndex(irow)&gt;0){</span>
<span class="lineNum">    6071 </span><span class="lineCov">         52 :         row[2] = irow;</span>
<span class="lineNum">    6072 </span><span class="lineCov">         52 :         break;</span>
<span class="lineNum">    6073 </span>            :       }
<span class="lineNum">    6074 </span>            :     }
<span class="lineNum">    6075 </span><span class="lineCov">        104 :     for (Int_t irow=row[2]-15;irow&gt;row[0];irow--){</span>
<span class="lineNum">    6076 </span><span class="lineCov">         52 :       if (track-&gt;GetClusterIndex(irow)&gt;0){</span>
<span class="lineNum">    6077 </span><span class="lineCov">         52 :         row[1] = irow;</span>
<span class="lineNum">    6078 </span><span class="lineCov">         52 :         break;</span>
<span class="lineNum">    6079 </span>            :       }
<span class="lineNum">    6080 </span>            :     }
<span class="lineNum">    6081 </span>            :     //
<span class="lineNum">    6082 </span><span class="lineCov">         52 :   }</span>
<span class="lineNum">    6083 </span><span class="lineCov">         52 :   if (!forward){</span>
<span class="lineNum">    6084 </span><span class="lineNoCov">          0 :     for (Int_t irow=0;irow&lt;r0;irow++){</span>
<span class="lineNum">    6085 </span><span class="lineNoCov">          0 :       if (track-&gt;GetClusterIndex(irow)&gt;0){</span>
<span class="lineNum">    6086 </span><span class="lineNoCov">          0 :         row[0] = irow;</span>
<span class="lineNum">    6087 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    6088 </span>            :       }
<span class="lineNum">    6089 </span>            :     }
<span class="lineNum">    6090 </span><span class="lineNoCov">          0 :     for (Int_t irow=r0;irow&gt;0;irow--){</span>
<span class="lineNum">    6091 </span><span class="lineNoCov">          0 :       if (track-&gt;GetClusterIndex(irow)&gt;0){</span>
<span class="lineNum">    6092 </span><span class="lineNoCov">          0 :         row[2] = irow;</span>
<span class="lineNum">    6093 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    6094 </span>            :       }
<span class="lineNum">    6095 </span>            :     }    
<span class="lineNum">    6096 </span><span class="lineNoCov">          0 :     for (Int_t irow=row[2]-15;irow&gt;row[0];irow--){</span>
<span class="lineNum">    6097 </span><span class="lineNoCov">          0 :       if (track-&gt;GetClusterIndex(irow)&gt;0){</span>
<span class="lineNum">    6098 </span><span class="lineNoCov">          0 :         row[1] = irow;</span>
<span class="lineNum">    6099 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    6100 </span>            :       }
<span class="lineNum">    6101 </span>            :     } 
<span class="lineNum">    6102 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    6103 </span>            :   //
<span class="lineNum">    6104 </span><span class="lineCov">         52 :   if ((row[2]-row[0])&lt;20) return 0;</span>
<span class="lineNum">    6105 </span><span class="lineCov">         52 :   if (row[1]==0) return 0;</span>
<span class="lineNum">    6106 </span>            :   //
<span class="lineNum">    6107 </span>            :   //
<span class="lineNum">    6108 </span>            :   //Get cluster and sector position
<span class="lineNum">    6109 </span><span class="lineCov">        468 :   for (Int_t ipoint=0;ipoint&lt;3;ipoint++){</span>
<span class="lineNum">    6110 </span><span class="lineCov">        156 :     Int_t clindex = track-&gt;GetClusterIndex2(row[ipoint]);</span>
<span class="lineNum">    6111 </span><span class="lineCov">        468 :     AliTPCclusterMI * cl = clindex&lt;0 ? 0:GetClusterMI(clindex);</span>
<span class="lineNum">    6112 </span><span class="lineCov">        156 :     if (cl==0) {</span>
<span class="lineNum">    6113 </span>            :       //Error(&quot;Bug\n&quot;);
<span class="lineNum">    6114 </span>            :       //      AliTPCclusterMI * cl = GetClusterMI(clindex);
<span class="lineNum">    6115 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">    6116 </span>            :     }
<span class="lineNum">    6117 </span><span class="lineCov">        156 :     sec[ipoint]     = ((clindex&amp;0xff000000)&gt;&gt;24)%18;</span>
<span class="lineNum">    6118 </span><span class="lineCov">        156 :     xyz[ipoint][0]  = GetXrow(row[ipoint]);</span>
<span class="lineNum">    6119 </span><span class="lineCov">        156 :     const AliTPCTrackerPoints::Point * point = track-&gt;GetTrackPoint(row[ipoint]);    </span>
<span class="lineNum">    6120 </span><span class="lineCov">        156 :     if (point&amp;&amp;ipoint&lt;2){</span>
<span class="lineNum">    6121 </span>            :       //
<span class="lineNum">    6122 </span><span class="lineCov">        104 :        xyz[ipoint][1]  = point-&gt;GetY();</span>
<span class="lineNum">    6123 </span><span class="lineCov">        104 :        xyz[ipoint][2]  = point-&gt;GetZ();</span>
<span class="lineNum">    6124 </span><span class="lineCov">        104 :     }</span>
<span class="lineNum">    6125 </span>            :     else{
<span class="lineNum">    6126 </span><span class="lineCov">         52 :       xyz[ipoint][1]  = cl-&gt;GetY();</span>
<span class="lineNum">    6127 </span><span class="lineCov">         52 :       xyz[ipoint][2]  = cl-&gt;GetZ();</span>
<span class="lineNum">    6128 </span>            :     }
<span class="lineNum">    6129 </span><span class="lineCov">        156 :   }</span>
<span class="lineNum">    6130 </span>            :   //
<span class="lineNum">    6131 </span>            :   //
<span class="lineNum">    6132 </span>            :   //
<span class="lineNum">    6133 </span>            :   //
<span class="lineNum">    6134 </span>            :   // Calculate seed state vector and covariance matrix
<span class="lineNum">    6135 </span>            : 
<span class="lineNum">    6136 </span>            :   Double_t alpha, cs,sn, xx2,yy2;
<span class="lineNum">    6137 </span>            :   //
<span class="lineNum">    6138 </span><span class="lineCov">         52 :   alpha = (sec[1]-sec[2])*fSectors-&gt;GetAlpha();</span>
<span class="lineNum">    6139 </span><span class="lineCov">         52 :   cs = TMath::Cos(alpha);</span>
<span class="lineNum">    6140 </span><span class="lineCov">         52 :   sn = TMath::Sin(alpha); </span>
<span class="lineNum">    6141 </span><span class="lineCov">         52 :   xx2= xyz[1][0]*cs-xyz[1][1]*sn;</span>
<span class="lineNum">    6142 </span><span class="lineCov">         52 :   yy2= xyz[1][0]*sn+xyz[1][1]*cs;</span>
<span class="lineNum">    6143 </span><span class="lineCov">         52 :   xyz[1][0] = xx2;</span>
<span class="lineNum">    6144 </span><span class="lineCov">         52 :   xyz[1][1] = yy2;</span>
<span class="lineNum">    6145 </span>            :   //
<span class="lineNum">    6146 </span><span class="lineCov">         52 :   alpha = (sec[0]-sec[2])*fSectors-&gt;GetAlpha();</span>
<span class="lineNum">    6147 </span><span class="lineCov">         52 :   cs = TMath::Cos(alpha);</span>
<span class="lineNum">    6148 </span><span class="lineCov">         52 :   sn = TMath::Sin(alpha); </span>
<span class="lineNum">    6149 </span><span class="lineCov">         52 :   xx2= xyz[0][0]*cs-xyz[0][1]*sn;</span>
<span class="lineNum">    6150 </span><span class="lineCov">         52 :   yy2= xyz[0][0]*sn+xyz[0][1]*cs;</span>
<span class="lineNum">    6151 </span><span class="lineCov">         52 :   xyz[0][0] = xx2;</span>
<span class="lineNum">    6152 </span><span class="lineCov">         52 :   xyz[0][1] = yy2;</span>
<span class="lineNum">    6153 </span>            :   //
<span class="lineNum">    6154 </span>            :   //
<span class="lineNum">    6155 </span>            :   //
<span class="lineNum">    6156 </span><span class="lineCov">         52 :   Double_t x[5],c[15];</span>
<span class="lineNum">    6157 </span>            :   //
<span class="lineNum">    6158 </span><span class="lineCov">         52 :   x[0]=xyz[2][1];</span>
<span class="lineNum">    6159 </span><span class="lineCov">         52 :   x[1]=xyz[2][2];</span>
<span class="lineNum">    6160 </span><span class="lineCov">         52 :   x[4]=F1(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1]);</span>
<span class="lineNum">    6161 </span><span class="lineCov">         52 :   x[2]=F2(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1]);</span>
<span class="lineNum">    6162 </span><span class="lineCov">         52 :   x[3]=F3n(xyz[2][0],xyz[2][1],xyz[0][0],xyz[0][1],xyz[2][2],xyz[0][2],x[4]);</span>
<span class="lineNum">    6163 </span>            :   //  
<span class="lineNum">    6164 </span>            :   Double_t sy =0.1,  sz =0.1;
<span class="lineNum">    6165 </span>            :   //
<span class="lineNum">    6166 </span>            :   Double_t sy1=0.2, sz1=0.2;
<span class="lineNum">    6167 </span>            :   Double_t sy2=0.2, sz2=0.2;
<span class="lineNum">    6168 </span>            :   Double_t sy3=0.2;
<span class="lineNum">    6169 </span>            :   //
<span class="lineNum">    6170 </span><span class="lineCov">         52 :   Double_t f40=(F1(xyz[2][0],xyz[2][1]+sy,xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1])-x[4])/sy;</span>
<span class="lineNum">    6171 </span><span class="lineCov">         52 :   Double_t f42=(F1(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1]+sy,xyz[0][0],xyz[0][1])-x[4])/sy;</span>
<span class="lineNum">    6172 </span><span class="lineCov">         52 :   Double_t f43=(F1(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1]+sy)-x[4])/sy;</span>
<span class="lineNum">    6173 </span><span class="lineCov">         52 :   Double_t f20=(F2(xyz[2][0],xyz[2][1]+sy,xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1])-x[2])/sy;</span>
<span class="lineNum">    6174 </span><span class="lineCov">         52 :   Double_t f22=(F2(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1]+sy,xyz[0][0],xyz[0][1])-x[2])/sy;</span>
<span class="lineNum">    6175 </span><span class="lineCov">         52 :   Double_t f23=(F2(xyz[2][0],xyz[2][1],xyz[1][0],xyz[1][1],xyz[0][0],xyz[0][1]+sy)-x[2])/sy;</span>
<span class="lineNum">    6176 </span>            :   //
<span class="lineNum">    6177 </span><span class="lineCov">         52 :   Double_t f30=(F3(xyz[2][0],xyz[2][1]+sy,xyz[0][0],xyz[0][1],xyz[2][2],xyz[0][2])-x[3])/sy;</span>
<span class="lineNum">    6178 </span><span class="lineCov">         52 :   Double_t f31=(F3(xyz[2][0],xyz[2][1],xyz[0][0],xyz[0][1],xyz[2][2]+sz,xyz[0][2])-x[3])/sz;</span>
<span class="lineNum">    6179 </span><span class="lineCov">         52 :   Double_t f32=(F3(xyz[2][0],xyz[2][1],xyz[0][0],xyz[0][1]+sy,xyz[2][2],xyz[0][2])-x[3])/sy;</span>
<span class="lineNum">    6180 </span><span class="lineCov">         52 :   Double_t f34=(F3(xyz[2][0],xyz[2][1],xyz[0][0],xyz[0][1],xyz[2][2],xyz[0][2]+sz)-x[3])/sz;</span>
<span class="lineNum">    6181 </span>            :   
<span class="lineNum">    6182 </span>            :   
<span class="lineNum">    6183 </span><span class="lineCov">         52 :   c[0]=sy1;</span>
<span class="lineNum">    6184 </span><span class="lineCov">         52 :   c[1]=0.;       c[2]=sz1;</span>
<span class="lineNum">    6185 </span><span class="lineCov">         52 :   c[3]=f20*sy1;  c[4]=0.;       c[5]=f20*sy1*f20+f22*sy2*f22+f23*sy3*f23;</span>
<span class="lineNum">    6186 </span><span class="lineCov">         52 :   c[6]=f30*sy1;  c[7]=f31*sz1;  c[8]=f30*sy1*f20+f32*sy2*f22;</span>
<span class="lineNum">    6187 </span><span class="lineCov">         52 :   c[9]=f30*sy1*f30+f31*sz1*f31+f32*sy2*f32+f34*sz2*f34;</span>
<span class="lineNum">    6188 </span><span class="lineCov">         52 :   c[10]=f40*sy1; c[11]=0.; c[12]=f40*sy1*f20+f42*sy2*f22+f43*sy3*f23;</span>
<span class="lineNum">    6189 </span><span class="lineCov">         52 :   c[13]=f30*sy1*f40+f32*sy2*f42;</span>
<span class="lineNum">    6190 </span><span class="lineCov">         52 :   c[14]=f40*sy1*f40+f42*sy2*f42+f43*sy3*f43;</span>
<span class="lineNum">    6191 </span>            :   
<span class="lineNum">    6192 </span>            :   //  Int_t row1 = fSectors-&gt;GetRowNumber(xyz[2][0]);
<span class="lineNum">    6193 </span><span class="lineCov">         52 :   AliTPCseed *seed=new( NextFreeSeed() )  AliTPCseed(xyz[2][0], sec[2]*fSectors-&gt;GetAlpha()+fSectors-&gt;GetAlphaShift(), x, c, 0);</span>
<span class="lineNum">    6194 </span><span class="lineCov">         52 :   seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    6195 </span><span class="lineCov">         52 :   seed-&gt;SetRow(row[2]); //RS: memorise row</span>
<span class="lineNum">    6196 </span><span class="lineCov">         52 :   seed-&gt;SetLastPoint(row[2]);</span>
<span class="lineNum">    6197 </span><span class="lineCov">         52 :   seed-&gt;SetFirstPoint(row[2]);  </span>
<span class="lineNum">    6198 </span><span class="lineCov">       6100 :   for (Int_t i=row[0];i&lt;row[2];i++){</span>
<span class="lineNum">    6199 </span><span class="lineCov">       2998 :     seed-&gt;SetClusterIndex(i, track-&gt;GetClusterIndex(i));</span>
<span class="lineNum">    6200 </span>            :   }
<span class="lineNum">    6201 </span>            : 
<span class="lineNum">    6202 </span>            :   return seed;
<span class="lineNum">    6203 </span><span class="lineCov">        104 : }</span>
<span class="lineNum">    6204 </span>            : 
<a name="6205"><span class="lineNum">    6205 </span>            : </a>
<span class="lineNum">    6206 </span>            : 
<span class="lineNum">    6207 </span>            : void  AliTPCtracker::FindMultiMC(const TObjArray * array, AliESDEvent */*esd*/, Int_t iter)
<span class="lineNum">    6208 </span>            : {
<span class="lineNum">    6209 </span>            :   //
<span class="lineNum">    6210 </span>            :   //  find multi tracks - THIS FUNCTION IS ONLY FOR DEBUG PURPOSES
<span class="lineNum">    6211 </span>            :   //                      USES MC LABELS
<span class="lineNum">    6212 </span>            :   //  Use AliTPCReconstructor::StreamLevel()&amp; kStreamFindMultiMC if you want to tune parameters - cuts
<span class="lineNum">    6213 </span>            :   //
<span class="lineNum">    6214 </span>            :   //  Two reasons to have multiple find tracks
<span class="lineNum">    6215 </span>            :   //  1. Curling tracks can be find more than once
<span class="lineNum">    6216 </span>            :   //  2. Splitted tracks 
<span class="lineNum">    6217 </span>            :   //     a.) Multiple seeding to increase tracking efficiency - (~ 100% reached)        
<span class="lineNum">    6218 </span>            :   //     b.) Edge effect on the sector boundaries
<span class="lineNum">    6219 </span>            :   //
<span class="lineNum">    6220 </span>            :   //
<span class="lineNum">    6221 </span>            :   //  Algorithm done in 2 phases - because of CPU consumption
<span class="lineNum">    6222 </span>            :   //  it is n^2 algorithm - for lead-lead 20000x20000 combination are investigated                           
<span class="lineNum">    6223 </span>            :   //
<span class="lineNum">    6224 </span>            :   //  Algorihm for curling tracks sign:
<span class="lineNum">    6225 </span>            :   //    1 phase -makes a very rough fast cuts to minimize combinatorics
<span class="lineNum">    6226 </span>            :   //                 a.) opposite sign
<span class="lineNum">    6227 </span>            :   //                 b.) one of the tracks - not pointing to the primary vertex - 
<span class="lineNum">    6228 </span>            :   //                 c.) delta tan(theta)
<span class="lineNum">    6229 </span>            :   //                 d.) delta phi
<span class="lineNum">    6230 </span>            :   //    2 phase - calculates DCA between tracks  - time consument
<span class="lineNum">    6231 </span>            : 
<span class="lineNum">    6232 </span>            :   //
<span class="lineNum">    6233 </span>            :   //    fast cuts 
<span class="lineNum">    6234 </span>            :   //
<span class="lineNum">    6235 </span>            :   //    General cuts    - for splitted tracks and for curling tracks
<span class="lineNum">    6236 </span>            :   //
<span class="lineNum">    6237 </span>            :   const Float_t kMaxdPhi      = 0.2;  // maximal distance in phi
<span class="lineNum">    6238 </span>            :   //
<span class="lineNum">    6239 </span>            :   //    Curling tracks cuts
<span class="lineNum">    6240 </span>            :   //
<span class="lineNum">    6241 </span>            :   //
<span class="lineNum">    6242 </span>            :   //
<span class="lineNum">    6243 </span>            :   //
<span class="lineNum">    6244 </span><span class="lineNoCov">          0 :   Int_t nentries = array-&gt;GetEntriesFast();  </span>
<span class="lineNum">    6245 </span><span class="lineNoCov">          0 :   if (!fHelixPool) fHelixPool = new TClonesArray(&quot;AliHelix&quot;,nentries+50);</span>
<span class="lineNum">    6246 </span><span class="lineNoCov">          0 :   fHelixPool-&gt;Clear();</span>
<span class="lineNum">    6247 </span><span class="lineNoCov">          0 :   TClonesArray&amp; helixes = *fHelixPool;</span>
<span class="lineNum">    6248 </span><span class="lineNoCov">          0 :   Float_t  xm[nentries];</span>
<span class="lineNum">    6249 </span><span class="lineNoCov">          0 :   Float_t  dz0[nentries];</span>
<span class="lineNum">    6250 </span><span class="lineNoCov">          0 :   Float_t  dz1[nentries];</span>
<span class="lineNum">    6251 </span>            :   //
<span class="lineNum">    6252 </span>            :   //
<span class="lineNum">    6253 </span><span class="lineNoCov">          0 :   TStopwatch timer;</span>
<span class="lineNum">    6254 </span><span class="lineNoCov">          0 :   timer.Start();</span>
<span class="lineNum">    6255 </span>            :   //
<span class="lineNum">    6256 </span>            :   // Find track COG in x direction - point with best defined parameters
<span class="lineNum">    6257 </span>            :   //
<span class="lineNum">    6258 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;nentries;i++){</span>
<span class="lineNum">    6259 </span><span class="lineNoCov">          0 :     AliTPCseed* track = (AliTPCseed*)array-&gt;At(i);    </span>
<span class="lineNum">    6260 </span><span class="lineNoCov">          0 :     if (!track) continue;</span>
<span class="lineNum">    6261 </span><span class="lineNoCov">          0 :     track-&gt;SetCircular(0);</span>
<span class="lineNum">    6262 </span><span class="lineNoCov">          0 :     new (helixes[i]) AliHelix(*track);</span>
<span class="lineNum">    6263 </span>            :     Int_t ncl=0;
<span class="lineNum">    6264 </span><span class="lineNoCov">          0 :     xm[i]=0;</span>
<span class="lineNum">    6265 </span><span class="lineNoCov">          0 :     Float_t dz[2];</span>
<span class="lineNum">    6266 </span><span class="lineNoCov">          0 :     track-&gt;GetDZ(GetX(),GetY(),GetZ(),GetBz(),dz);</span>
<span class="lineNum">    6267 </span><span class="lineNoCov">          0 :     dz0[i]=dz[0];</span>
<span class="lineNum">    6268 </span><span class="lineNoCov">          0 :     dz1[i]=dz[1];</span>
<span class="lineNum">    6269 </span><span class="lineNoCov">          0 :     for (Int_t icl=0; icl&lt;kMaxRow; icl++){</span>
<span class="lineNum">    6270 </span><span class="lineNoCov">          0 :       int tpcindex= track-&gt;GetClusterIndex2(icl);</span>
<span class="lineNum">    6271 </span><span class="lineNoCov">          0 :       const AliTPCclusterMI * cl = (tpcindex&lt;0) ? 0:GetClusterMI(tpcindex);</span>
<span class="lineNum">    6272 </span>            :       //RS      AliTPCclusterMI * cl =  track-&gt;GetClusterPointer(icl);
<span class="lineNum">    6273 </span><span class="lineNoCov">          0 :       if (cl) {</span>
<span class="lineNum">    6274 </span><span class="lineNoCov">          0 :         xm[i]+=cl-&gt;GetX();</span>
<span class="lineNum">    6275 </span><span class="lineNoCov">          0 :         ncl++;</span>
<span class="lineNum">    6276 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    6277 </span>            :     }
<span class="lineNum">    6278 </span><span class="lineNoCov">          0 :     if (ncl&gt;0) xm[i]/=Float_t(ncl);</span>
<span class="lineNum">    6279 </span><span class="lineNoCov">          0 :   }  </span>
<span class="lineNum">    6280 </span>            :   //
<span class="lineNum">    6281 </span><span class="lineNoCov">          0 :   for (Int_t i0=0;i0&lt;nentries;i0++){</span>
<span class="lineNum">    6282 </span><span class="lineNoCov">          0 :     AliTPCseed * track0 = (AliTPCseed*)array-&gt;At(i0);</span>
<span class="lineNum">    6283 </span><span class="lineNoCov">          0 :     if (!track0) continue;    </span>
<span class="lineNum">    6284 </span><span class="lineNoCov">          0 :     AliHelix* hlxi0 = (AliHelix*)helixes[i0];</span>
<span class="lineNum">    6285 </span><span class="lineNoCov">          0 :     Float_t xc0 = hlxi0-&gt;GetHelix(6);</span>
<span class="lineNum">    6286 </span><span class="lineNoCov">          0 :     Float_t yc0 = hlxi0-&gt;GetHelix(7);</span>
<span class="lineNum">    6287 </span><span class="lineNoCov">          0 :     Float_t r0  = hlxi0-&gt;GetHelix(8);</span>
<span class="lineNum">    6288 </span><span class="lineNoCov">          0 :     Float_t rc0 = TMath::Sqrt(xc0*xc0+yc0*yc0);</span>
<span class="lineNum">    6289 </span><span class="lineNoCov">          0 :     Float_t fi0 = TMath::ATan2(yc0,xc0);</span>
<span class="lineNum">    6290 </span>            :     
<span class="lineNum">    6291 </span><span class="lineNoCov">          0 :     for (Int_t i1=i0+1;i1&lt;nentries;i1++){</span>
<span class="lineNum">    6292 </span><span class="lineNoCov">          0 :       AliTPCseed * track1 = (AliTPCseed*)array-&gt;At(i1);</span>
<span class="lineNum">    6293 </span><span class="lineNoCov">          0 :       if (!track1) continue;      </span>
<span class="lineNum">    6294 </span><span class="lineNoCov">          0 :       Int_t lab0=track0-&gt;GetLabel();</span>
<span class="lineNum">    6295 </span><span class="lineNoCov">          0 :       Int_t lab1=track1-&gt;GetLabel();</span>
<span class="lineNum">    6296 </span><span class="lineNoCov">          0 :       if (TMath::Abs(lab0)!=TMath::Abs(lab1)) continue;</span>
<span class="lineNum">    6297 </span>            :       //
<span class="lineNum">    6298 </span><span class="lineNoCov">          0 :       AliHelix* hlxi1 = (AliHelix*)helixes[i1];</span>
<span class="lineNum">    6299 </span><span class="lineNoCov">          0 :       Float_t xc1 = hlxi1-&gt;GetHelix(6);</span>
<span class="lineNum">    6300 </span><span class="lineNoCov">          0 :       Float_t yc1 = hlxi1-&gt;GetHelix(7);</span>
<span class="lineNum">    6301 </span><span class="lineNoCov">          0 :       Float_t r1  = hlxi1-&gt;GetHelix(8);</span>
<span class="lineNum">    6302 </span><span class="lineNoCov">          0 :       Float_t rc1 = TMath::Sqrt(xc1*xc1+yc1*yc1);</span>
<span class="lineNum">    6303 </span><span class="lineNoCov">          0 :       Float_t fi1 = TMath::ATan2(yc1,xc1);</span>
<span class="lineNum">    6304 </span>            :       //
<span class="lineNum">    6305 </span><span class="lineNoCov">          0 :       Float_t dfi = fi0-fi1;</span>
<span class="lineNum">    6306 </span>            :       //
<span class="lineNum">    6307 </span>            :       //
<span class="lineNum">    6308 </span><span class="lineNoCov">          0 :       if (dfi&gt;1.5*TMath::Pi())  dfi-=TMath::Pi();  // take care about edge effect </span>
<span class="lineNum">    6309 </span><span class="lineNoCov">          0 :       if (dfi&lt;-1.5*TMath::Pi()) dfi+=TMath::Pi();  // </span>
<span class="lineNum">    6310 </span><span class="lineNoCov">          0 :       if (TMath::Abs(dfi)&gt;kMaxdPhi&amp;&amp;hlxi0-&gt;GetHelix(4)*hlxi1-&gt;GetHelix(4)&lt;0){</span>
<span class="lineNum">    6311 </span>            :         //
<span class="lineNum">    6312 </span>            :         // if short tracks with undefined sign 
<span class="lineNum">    6313 </span><span class="lineNoCov">          0 :         fi1 =  -TMath::ATan2(yc1,-xc1);</span>
<span class="lineNum">    6314 </span><span class="lineNoCov">          0 :         dfi = fi0-fi1;</span>
<span class="lineNum">    6315 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    6316 </span><span class="lineNoCov">          0 :       Float_t dtheta = TMath::Abs(track0-&gt;GetTgl()-track1-&gt;GetTgl())&lt;TMath::Abs(track0-&gt;GetTgl()+track1-&gt;GetTgl())? track0-&gt;GetTgl()-track1-&gt;GetTgl():track0-&gt;GetTgl()+track1-&gt;GetTgl();</span>
<span class="lineNum">    6317 </span>            :       
<span class="lineNum">    6318 </span>            :       //
<span class="lineNum">    6319 </span>            :       // debug stream to tune &quot;fast cuts&quot; 
<span class="lineNum">    6320 </span>            :       //
<span class="lineNum">    6321 </span><span class="lineNoCov">          0 :       Double_t dist[3];   // distance at X </span>
<span class="lineNum">    6322 </span><span class="lineNoCov">          0 :       Double_t mdist[3]={0,0,0};  // mean distance X+-40cm</span>
<span class="lineNum">    6323 </span><span class="lineNoCov">          0 :       track0-&gt;GetDistance(track1,0.5*(xm[i0]+xm[i1])-40.,dist,AliTracker::GetBz());</span>
<span class="lineNum">    6324 </span><span class="lineNoCov">          0 :       for (Int_t i=0;i&lt;3;i++) mdist[i]+=TMath::Abs(dist[i]);</span>
<span class="lineNum">    6325 </span><span class="lineNoCov">          0 :       track0-&gt;GetDistance(track1,0.5*(xm[i0]+xm[i1])+40.,dist,AliTracker::GetBz());</span>
<span class="lineNum">    6326 </span><span class="lineNoCov">          0 :       for (Int_t i=0;i&lt;3;i++) mdist[i]+=TMath::Abs(dist[i]);</span>
<span class="lineNum">    6327 </span><span class="lineNoCov">          0 :       track0-&gt;GetDistance(track1,0.5*(xm[i0]+xm[i1]),dist,AliTracker::GetBz());</span>
<span class="lineNum">    6328 </span><span class="lineNoCov">          0 :       for (Int_t i=0;i&lt;3;i++) mdist[i]+=TMath::Abs(dist[i]);</span>
<span class="lineNum">    6329 </span><span class="lineNoCov">          0 :       for (Int_t i=0;i&lt;3;i++) mdist[i]*=0.33333;</span>
<span class="lineNum">    6330 </span>            :       
<span class="lineNum">    6331 </span><span class="lineNoCov">          0 :       Float_t sum =0;</span>
<span class="lineNum">    6332 </span><span class="lineNoCov">          0 :       Float_t sums=0;</span>
<span class="lineNum">    6333 </span><span class="lineNoCov">          0 :       for (Int_t icl=0; icl&lt;kMaxRow; icl++){</span>
<span class="lineNum">    6334 </span><span class="lineNoCov">          0 :         Int_t tpcindex0 = track0-&gt;GetClusterIndex2(icl);</span>
<span class="lineNum">    6335 </span><span class="lineNoCov">          0 :         Int_t tpcindex1 = track1-&gt;GetClusterIndex2(icl);</span>
<span class="lineNum">    6336 </span>            :         //RS AliTPCclusterMI * cl0 =  track0-&gt;GetClusterPointer(icl);
<span class="lineNum">    6337 </span>            :         //RS AliTPCclusterMI * cl1 =  track1-&gt;GetClusterPointer(icl);
<span class="lineNum">    6338 </span>            :         //RS if (cl0&amp;&amp;cl1) {
<span class="lineNum">    6339 </span><span class="lineNoCov">          0 :         if (tpcindex0&gt;=0 &amp;&amp; tpcindex1&gt;=0) {</span>
<span class="lineNum">    6340 </span><span class="lineNoCov">          0 :           sum++;</span>
<span class="lineNum">    6341 </span><span class="lineNoCov">          0 :           if (tpcindex0==tpcindex1) sums++; //RS if (cl0==cl1) sums++;</span>
<span class="lineNum">    6342 </span>            :         }
<span class="lineNum">    6343 </span>            :       }
<span class="lineNum">    6344 </span>            :       //
<span class="lineNum">    6345 </span><span class="lineNoCov">          0 :       if ((AliTPCReconstructor::StreamLevel()&amp;kStreamFindMultiMC)&gt;0) {  // flag: stream MC infomation about the multiple find track (ONLY for MC data)</span>
<span class="lineNum">    6346 </span><span class="lineNoCov">          0 :       TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    6347 </span><span class="lineNoCov">          0 :       cstream&lt;&lt;&quot;Multi&quot;&lt;&lt;</span>
<span class="lineNum">    6348 </span><span class="lineNoCov">          0 :         &quot;iter=&quot;&lt;&lt;iter&lt;&lt;</span>
<span class="lineNum">    6349 </span><span class="lineNoCov">          0 :         &quot;lab0=&quot;&lt;&lt;lab0&lt;&lt;</span>
<span class="lineNum">    6350 </span><span class="lineNoCov">          0 :         &quot;lab1=&quot;&lt;&lt;lab1&lt;&lt;   </span>
<span class="lineNum">    6351 </span><span class="lineNoCov">          0 :         &quot;Tr0.=&quot;&lt;&lt;track0&lt;&lt;       // seed0</span>
<span class="lineNum">    6352 </span><span class="lineNoCov">          0 :         &quot;Tr1.=&quot;&lt;&lt;track1&lt;&lt;       // seed1</span>
<span class="lineNum">    6353 </span><span class="lineNoCov">          0 :         &quot;h0.=&quot;&lt;&lt;hlxi0&lt;&lt;</span>
<span class="lineNum">    6354 </span><span class="lineNoCov">          0 :         &quot;h1.=&quot;&lt;&lt;hlxi1&lt;&lt;</span>
<span class="lineNum">    6355 </span>            :         //
<span class="lineNum">    6356 </span><span class="lineNoCov">          0 :         &quot;sum=&quot;&lt;&lt;sum&lt;&lt;           //the sum of rows with cl in both</span>
<span class="lineNum">    6357 </span><span class="lineNoCov">          0 :         &quot;sums=&quot;&lt;&lt;sums&lt;&lt;         //the sum of shared clusters</span>
<span class="lineNum">    6358 </span><span class="lineNoCov">          0 :         &quot;xm0=&quot;&lt;&lt;xm[i0]&lt;&lt;        // the center of track</span>
<span class="lineNum">    6359 </span><span class="lineNoCov">          0 :         &quot;xm1=&quot;&lt;&lt;xm[i1]&lt;&lt;        // the x center of track</span>
<span class="lineNum">    6360 </span>            :         // General cut variables                   
<span class="lineNum">    6361 </span><span class="lineNoCov">          0 :         &quot;dfi=&quot;&lt;&lt;dfi&lt;&lt;           // distance in fi angle</span>
<span class="lineNum">    6362 </span><span class="lineNoCov">          0 :         &quot;dtheta=&quot;&lt;&lt;dtheta&lt;&lt;     // distance int theta angle</span>
<span class="lineNum">    6363 </span>            :         //
<span class="lineNum">    6364 </span><span class="lineNoCov">          0 :         &quot;dz00=&quot;&lt;&lt;dz0[i0]&lt;&lt;</span>
<span class="lineNum">    6365 </span><span class="lineNoCov">          0 :         &quot;dz01=&quot;&lt;&lt;dz0[i1]&lt;&lt;</span>
<span class="lineNum">    6366 </span><span class="lineNoCov">          0 :         &quot;dz10=&quot;&lt;&lt;dz1[i1]&lt;&lt;</span>
<span class="lineNum">    6367 </span><span class="lineNoCov">          0 :         &quot;dz11=&quot;&lt;&lt;dz1[i1]&lt;&lt;</span>
<span class="lineNum">    6368 </span><span class="lineNoCov">          0 :         &quot;dist0=&quot;&lt;&lt;dist[0]&lt;&lt;     //distance x</span>
<span class="lineNum">    6369 </span><span class="lineNoCov">          0 :         &quot;dist1=&quot;&lt;&lt;dist[1]&lt;&lt;     //distance y</span>
<span class="lineNum">    6370 </span><span class="lineNoCov">          0 :         &quot;dist2=&quot;&lt;&lt;dist[2]&lt;&lt;     //distance z</span>
<span class="lineNum">    6371 </span><span class="lineNoCov">          0 :         &quot;mdist0=&quot;&lt;&lt;mdist[0]&lt;&lt;   //distance x</span>
<span class="lineNum">    6372 </span><span class="lineNoCov">          0 :         &quot;mdist1=&quot;&lt;&lt;mdist[1]&lt;&lt;   //distance y</span>
<span class="lineNum">    6373 </span><span class="lineNoCov">          0 :         &quot;mdist2=&quot;&lt;&lt;mdist[2]&lt;&lt;   //distance z</span>
<span class="lineNum">    6374 </span>            :         //
<span class="lineNum">    6375 </span><span class="lineNoCov">          0 :         &quot;r0=&quot;&lt;&lt;r0&lt;&lt;</span>
<span class="lineNum">    6376 </span><span class="lineNoCov">          0 :         &quot;rc0=&quot;&lt;&lt;rc0&lt;&lt;</span>
<span class="lineNum">    6377 </span><span class="lineNoCov">          0 :         &quot;fi0=&quot;&lt;&lt;fi0&lt;&lt;</span>
<span class="lineNum">    6378 </span><span class="lineNoCov">          0 :         &quot;fi1=&quot;&lt;&lt;fi1&lt;&lt;</span>
<span class="lineNum">    6379 </span><span class="lineNoCov">          0 :         &quot;r1=&quot;&lt;&lt;r1&lt;&lt;</span>
<span class="lineNum">    6380 </span><span class="lineNoCov">          0 :         &quot;rc1=&quot;&lt;&lt;rc1&lt;&lt;</span>
<span class="lineNum">    6381 </span>            :         &quot;\n&quot;;
<span class="lineNum">    6382 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    6383 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    6384 </span><span class="lineNoCov">          0 :   }    </span>
<span class="lineNum">    6385 </span><span class="lineNoCov">          0 :   if (fHelixPool) fHelixPool-&gt;Clear();</span>
<span class="lineNum">    6386 </span>            :   //  delete [] helixes; // RS moved to stack
<span class="lineNum">    6387 </span>            :   //  delete [] xm;
<span class="lineNum">    6388 </span>            :   //  delete [] dz0;
<span class="lineNum">    6389 </span>            :   //  delete [] dz1;
<span class="lineNum">    6390 </span><span class="lineNoCov">          0 :   if (AliTPCReconstructor::StreamLevel()&gt;0) {</span>
<span class="lineNum">    6391 </span><span class="lineNoCov">          0 :     AliInfo(&quot;Time for curling tracks removal DEBUGGING MC&quot;);</span>
<span class="lineNum">    6392 </span><span class="lineNoCov">          0 :     timer.Print();</span>
<span class="lineNum">    6393 </span>            :   }
<span class="lineNum">    6394 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    6395 </span>            : 
<a name="6396"><span class="lineNum">    6396 </span>            : </a>
<span class="lineNum">    6397 </span>            : 
<span class="lineNum">    6398 </span>            : void  AliTPCtracker::FindSplitted(TObjArray * array, AliESDEvent */*esd*/, Int_t /*iter*/){
<span class="lineNum">    6399 </span>            :   //
<span class="lineNum">    6400 </span>            :   // Find Splitted tracks and remove the one with worst quality  
<span class="lineNum">    6401 </span>            :   // Corresponding debug streamer to tune selections - &quot;Splitted2&quot;
<span class="lineNum">    6402 </span>            :   // Algorithm:
<span class="lineNum">    6403 </span>            :   // 0. Sort tracks according quality
<span class="lineNum">    6404 </span>            :   // 1. Propagate the tracks to the reference radius
<span class="lineNum">    6405 </span>            :   // 2. Double_t loop to select close tracks (only to speed up process)
<span class="lineNum">    6406 </span>            :   // 3. Calculate cluster overlap ratio - and remove the track if bigger than a threshold
<span class="lineNum">    6407 </span>            :   // 4. Delete temporary parameters
<span class="lineNum">    6408 </span>            :   // 
<span class="lineNum">    6409 </span><span class="lineCov">         48 :   const Double_t xref=GetXrow(63);  // reference radius -IROC/OROC boundary</span>
<span class="lineNum">    6410 </span>            :   //    rough cuts
<span class="lineNum">    6411 </span>            :   const Double_t kCutP1=10;       // delta Z cut 10 cm 
<span class="lineNum">    6412 </span>            :   const Double_t kCutP2=0.15;     // delta snp(fi) cut 0.15 
<span class="lineNum">    6413 </span>            :   const Double_t kCutP3=0.15;     // delta tgl(theta) cut 0.15
<span class="lineNum">    6414 </span>            :   const Double_t kCutAlpha=0.15;  // delta alpha cut
<span class="lineNum">    6415 </span>            :   Int_t firstpoint = 0;
<span class="lineNum">    6416 </span>            :   Int_t lastpoint = kMaxRow;
<span class="lineNum">    6417 </span>            :   //
<span class="lineNum">    6418 </span><span class="lineCov">         24 :   Int_t nentries = array-&gt;GetEntriesFast();  </span>
<span class="lineNum">    6419 </span><span class="lineCov">         28 :   if (!fETPPool) fETPPool = new TClonesArray(&quot;AliExternalTrackParam&quot;,nentries+50);</span>
<span class="lineNum">    6420 </span><span class="lineCov">         22 :   else fETPPool-&gt;Clear();</span>
<span class="lineNum">    6421 </span><span class="lineCov">         24 :   TClonesArray &amp;params = *fETPPool;</span>
<span class="lineNum">    6422 </span>            :   //
<span class="lineNum">    6423 </span>            :   //
<span class="lineNum">    6424 </span><span class="lineCov">         24 :   TStopwatch timer;</span>
<span class="lineNum">    6425 </span><span class="lineCov">         24 :   timer.Start();</span>
<span class="lineNum">    6426 </span>            :   //
<span class="lineNum">    6427 </span>            :   //0.  Sort tracks according quality
<span class="lineNum">    6428 </span>            :   //1.  Propagate the ext. param to reference radius
<span class="lineNum">    6429 </span><span class="lineCov">         24 :   Int_t nseed = array-&gt;GetEntriesFast();  </span>
<span class="lineNum">    6430 </span><span class="lineCov">         24 :   if (nseed&lt;=0) return;</span>
<span class="lineNum">    6431 </span><span class="lineCov">         24 :   Float_t quality[nseed];</span>
<span class="lineNum">    6432 </span><span class="lineCov">         24 :   Int_t   indexes[nseed];</span>
<span class="lineNum">    6433 </span><span class="lineCov">       1108 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    6434 </span><span class="lineCov">        530 :     AliTPCseed *pt=(AliTPCseed*)array-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    6435 </span><span class="lineCov">        530 :     if (!pt){</span>
<span class="lineNum">    6436 </span><span class="lineCov">        124 :       quality[i]=-1;</span>
<span class="lineNum">    6437 </span><span class="lineCov">        124 :       continue;</span>
<span class="lineNum">    6438 </span>            :     }
<span class="lineNum">    6439 </span><span class="lineCov">        406 :     pt-&gt;UpdatePoints();    //select first last max dens points</span>
<span class="lineNum">    6440 </span><span class="lineCov">        406 :     Float_t * points = pt-&gt;GetPoints();</span>
<span class="lineNum">    6441 </span><span class="lineCov">        406 :     if (points[3]&lt;0.8) quality[i] =-1;</span>
<span class="lineNum">    6442 </span><span class="lineCov">        812 :     quality[i] = (points[2]-points[0])+pt-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    6443 </span>            :     //prefer high momenta tracks if overlaps
<span class="lineNum">    6444 </span><span class="lineCov">        812 :     quality[i] *= TMath::Sqrt(TMath::Abs(pt-&gt;Pt())+0.5);</span>
<span class="lineNum">    6445 </span><span class="lineCov">       1218 :     AliExternalTrackParam* parI = new (params[i]) AliExternalTrackParam(*pt);</span>
<span class="lineNum">    6446 </span>            :     // params[i]=(*pt);
<span class="lineNum">    6447 </span><span class="lineCov">        406 :     AliTracker::PropagateTrackParamOnlyToBxByBz(parI,xref,5.,kTRUE);</span>
<span class="lineNum">    6448 </span>            :     //    AliTracker::PropagateTrackToBxByBz(parI,xref,pt-&gt;GetMass(),1.,kTRUE); //RS What is the point of 2nd propagation
<span class="lineNum">    6449 </span><span class="lineCov">        406 :   }</span>
<span class="lineNum">    6450 </span><span class="lineCov">         24 :   TMath::Sort(nseed,quality,indexes);</span>
<span class="lineNum">    6451 </span>            :   //
<span class="lineNum">    6452 </span>            :   // 3. Loop over pair of tracks
<span class="lineNum">    6453 </span>            :   //
<span class="lineNum">    6454 </span><span class="lineCov">       1108 :   for (Int_t i0=0; i0&lt;nseed; i0++) {</span>
<span class="lineNum">    6455 </span><span class="lineCov">        530 :     Int_t index0=indexes[i0];</span>
<span class="lineNum">    6456 </span><span class="lineCov">        654 :     if (!(array-&gt;UncheckedAt(index0))) continue;</span>
<span class="lineNum">    6457 </span><span class="lineCov">        406 :     AliTPCseed *s1 = (AliTPCseed*)array-&gt;UncheckedAt(index0);  </span>
<span class="lineNum">    6458 </span><span class="lineCov">        406 :     if (!s1-&gt;IsActive()) continue;</span>
<span class="lineNum">    6459 </span><span class="lineCov">        812 :     AliExternalTrackParam &amp;par0=*(AliExternalTrackParam*)params[index0];</span>
<span class="lineNum">    6460 </span><span class="lineCov">      12324 :     for (Int_t i1=i0+1; i1&lt;nseed; i1++) {</span>
<span class="lineNum">    6461 </span><span class="lineCov">       5756 :       Int_t index1=indexes[i1];</span>
<span class="lineNum">    6462 </span><span class="lineCov">       7922 :       if (!(array-&gt;UncheckedAt(index1))) continue;</span>
<span class="lineNum">    6463 </span><span class="lineCov">       3590 :       AliTPCseed *s2 = (AliTPCseed*)array-&gt;UncheckedAt(index1);  </span>
<span class="lineNum">    6464 </span><span class="lineCov">       3590 :       if (!s2-&gt;IsActive()) continue;</span>
<span class="lineNum">    6465 </span><span class="lineCov">       3590 :       if (s2-&gt;GetKinkIndexes()[0]!=0)</span>
<span class="lineNum">    6466 </span><span class="lineCov">        186 :         if (s2-&gt;GetKinkIndexes()[0] == -s1-&gt;GetKinkIndexes()[0]) continue;</span>
<span class="lineNum">    6467 </span><span class="lineCov">       7156 :       AliExternalTrackParam &amp;par1=*(AliExternalTrackParam*)params[index1];</span>
<span class="lineNum">    6468 </span><span class="lineCov">      12378 :       if (TMath::Abs(par0.GetParameter()[3]-par1.GetParameter()[3])&gt;kCutP3) continue;</span>
<span class="lineNum">    6469 </span><span class="lineCov">       6930 :       if (TMath::Abs(par0.GetParameter()[1]-par1.GetParameter()[1])&gt;kCutP1) continue;</span>
<span class="lineNum">    6470 </span><span class="lineCov">       2788 :       if (TMath::Abs(par0.GetParameter()[2]-par1.GetParameter()[2])&gt;kCutP2) continue;</span>
<span class="lineNum">    6471 </span><span class="lineCov">       1308 :       Double_t dAlpha= TMath::Abs(par0.GetAlpha()-par1.GetAlpha());</span>
<span class="lineNum">    6472 </span><span class="lineCov">        508 :       if (dAlpha&gt;TMath::Pi()) dAlpha-=TMath::Pi();</span>
<span class="lineNum">    6473 </span><span class="lineCov">        804 :       if (TMath::Abs(dAlpha)&gt;kCutAlpha) continue;</span>
<span class="lineNum">    6474 </span>            :       //
<span class="lineNum">    6475 </span><span class="lineCov">         68 :       Int_t sumShared=0;</span>
<span class="lineNum">    6476 </span><span class="lineCov">         68 :       Int_t nall0=0;</span>
<span class="lineNum">    6477 </span><span class="lineCov">         68 :       Int_t nall1=0;</span>
<span class="lineNum">    6478 </span><span class="lineCov">         68 :       Int_t firstShared=lastpoint, lastShared=firstpoint;</span>
<span class="lineNum">    6479 </span><span class="lineCov">         68 :       Int_t firstRow=lastpoint, lastRow=firstpoint;</span>
<span class="lineNum">    6480 </span>            :       //
<span class="lineNum">    6481 </span>            :       // for (Int_t i=firstpoint;i&lt;lastpoint;i++){
<span class="lineNum">    6482 </span>            :       //        if (s1-&gt;GetClusterIndex2(i)&gt;0) nall0++;
<span class="lineNum">    6483 </span>            :       //        if (s2-&gt;GetClusterIndex2(i)&gt;0) nall1++;
<span class="lineNum">    6484 </span>            :       //        if  (s1-&gt;GetClusterIndex2(i)&gt;0 &amp;&amp; s2-&gt;GetClusterIndex2(i)&gt;0) {
<span class="lineNum">    6485 </span>            :       //          if (i&lt;firstRow) firstRow=i;
<span class="lineNum">    6486 </span>            :       //          if (i&gt;lastRow)  lastRow=i;
<span class="lineNum">    6487 </span>            :       //        }
<span class="lineNum">    6488 </span>            :       //        if ( (s1-&gt;GetClusterIndex2(i))==(s2-&gt;GetClusterIndex2(i)) &amp;&amp; s1-&gt;GetClusterIndex2(i)&gt;0) {
<span class="lineNum">    6489 </span>            :       //          if (i&lt;firstShared) firstShared=i;
<span class="lineNum">    6490 </span>            :       //          if (i&gt;lastShared)  lastShared=i;
<span class="lineNum">    6491 </span>            :       //          sumShared++;
<span class="lineNum">    6492 </span>            :       //        }
<span class="lineNum">    6493 </span>            :       // }
<span class="lineNum">    6494 </span>            :       //
<span class="lineNum">    6495 </span>            :       // RS: faster version + fix(?)  &quot;&gt;&quot; -&gt; &quot;&gt;=&quot;
<span class="lineNum">    6496 </span><span class="lineCov">      21760 :       for (Int_t i=firstpoint;i&lt;lastpoint;i++){</span>
<span class="lineNum">    6497 </span><span class="lineCov">      10812 :         int ind1=s1-&gt;GetClusterIndex2(i),ind2=s2-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    6498 </span><span class="lineCov">      20246 :         if (ind1&gt;=0) nall0++; // RS: &quot;&gt;&quot; -&gt; &quot;&gt;=&quot;</span>
<span class="lineNum">    6499 </span><span class="lineCov">      18092 :         if (ind2&gt;=0) nall1++;</span>
<span class="lineNum">    6500 </span><span class="lineCov">      10812 :         if  (ind1&gt;=0 &amp;&amp; ind2&gt;=0) {</span>
<span class="lineNum">    6501 </span><span class="lineCov">       6762 :           if (i&lt;firstRow) firstRow=i;</span>
<span class="lineNum">    6502 </span><span class="lineCov">      13344 :           if (i&gt;lastRow)  lastRow=i;</span>
<span class="lineNum">    6503 </span>            :         }
<span class="lineNum">    6504 </span><span class="lineCov">      10812 :         if ( (ind1==ind2) &amp;&amp; ind1&gt;=0) {</span>
<span class="lineNum">    6505 </span><span class="lineCov">        354 :           if (i&lt;firstShared) firstShared=i;</span>
<span class="lineNum">    6506 </span><span class="lineCov">        664 :           if (i&gt;lastShared)  lastShared=i;</span>
<span class="lineNum">    6507 </span><span class="lineCov">        338 :           sumShared++;</span>
<span class="lineNum">    6508 </span><span class="lineCov">        338 :         }</span>
<span class="lineNum">    6509 </span>            :       }
<span class="lineNum">    6510 </span>            : 
<span class="lineNum">    6511 </span><span class="lineCov">         68 :       Double_t ratio0 = Float_t(sumShared)/Float_t(TMath::Min(nall0+1,nall1+1));</span>
<span class="lineNum">    6512 </span><span class="lineCov">         68 :       Double_t ratio1 = Float_t(sumShared)/Float_t(TMath::Max(nall0+1,nall1+1));</span>
<span class="lineNum">    6513 </span>            :       
<span class="lineNum">    6514 </span><span class="lineCov">         68 :       if ((AliTPCReconstructor::StreamLevel()&amp;kStreamSplitted2)&gt;0){ // flag:stream information about discarded TPC tracks pair algorithm </span>
<span class="lineNum">    6515 </span><span class="lineNoCov">          0 :         TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    6516 </span><span class="lineNoCov">          0 :         Int_t n0=s1-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    6517 </span><span class="lineNoCov">          0 :         Int_t n1=s2-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    6518 </span><span class="lineNoCov">          0 :         Int_t n0F=s1-&gt;GetNFoundable();</span>
<span class="lineNum">    6519 </span><span class="lineNoCov">          0 :         Int_t n1F=s2-&gt;GetNFoundable();</span>
<span class="lineNum">    6520 </span><span class="lineNoCov">          0 :         Int_t lab0=s1-&gt;GetLabel();</span>
<span class="lineNum">    6521 </span><span class="lineNoCov">          0 :         Int_t lab1=s2-&gt;GetLabel();</span>
<span class="lineNum">    6522 </span>            : 
<span class="lineNum">    6523 </span><span class="lineNoCov">          0 :         cstream&lt;&lt;&quot;Splitted2&quot;&lt;&lt;    // flag:stream information about discarded TPC tracks pair algorithm </span>
<span class="lineNum">    6524 </span><span class="lineNoCov">          0 :           &quot;iter=&quot;&lt;&lt;fIteration&lt;&lt;</span>
<span class="lineNum">    6525 </span><span class="lineNoCov">          0 :           &quot;lab0=&quot;&lt;&lt;lab0&lt;&lt;        // MC label if exist</span>
<span class="lineNum">    6526 </span><span class="lineNoCov">          0 :           &quot;lab1=&quot;&lt;&lt;lab1&lt;&lt;        // MC label if exist</span>
<span class="lineNum">    6527 </span><span class="lineNoCov">          0 :           &quot;index0=&quot;&lt;&lt;index0&lt;&lt;</span>
<span class="lineNum">    6528 </span><span class="lineNoCov">          0 :           &quot;index1=&quot;&lt;&lt;index1&lt;&lt;</span>
<span class="lineNum">    6529 </span><span class="lineNoCov">          0 :           &quot;ratio0=&quot;&lt;&lt;ratio0&lt;&lt;      // shared ratio</span>
<span class="lineNum">    6530 </span><span class="lineNoCov">          0 :           &quot;ratio1=&quot;&lt;&lt;ratio1&lt;&lt;      // shared ratio</span>
<span class="lineNum">    6531 </span><span class="lineNoCov">          0 :           &quot;p0.=&quot;&lt;&lt;&amp;par0&lt;&lt;        // track parameters</span>
<span class="lineNum">    6532 </span><span class="lineNoCov">          0 :           &quot;p1.=&quot;&lt;&lt;&amp;par1&lt;&lt;</span>
<span class="lineNum">    6533 </span><span class="lineNoCov">          0 :           &quot;s0.=&quot;&lt;&lt;s1&lt;&lt;           // full seed</span>
<span class="lineNum">    6534 </span><span class="lineNoCov">          0 :           &quot;s1.=&quot;&lt;&lt;s2&lt;&lt;</span>
<span class="lineNum">    6535 </span><span class="lineNoCov">          0 :           &quot;n0=&quot;&lt;&lt;n0&lt;&lt;     // number of clusters track 0</span>
<span class="lineNum">    6536 </span><span class="lineNoCov">          0 :           &quot;n1=&quot;&lt;&lt;n1&lt;&lt;     // number of clusters track 1</span>
<span class="lineNum">    6537 </span><span class="lineNoCov">          0 :           &quot;nall0=&quot;&lt;&lt;nall0&lt;&lt;     // number of clusters track 0</span>
<span class="lineNum">    6538 </span><span class="lineNoCov">          0 :           &quot;nall1=&quot;&lt;&lt;nall1&lt;&lt;     // number of clusters track 1</span>
<span class="lineNum">    6539 </span><span class="lineNoCov">          0 :           &quot;n0F=&quot;&lt;&lt;n0F&lt;&lt;   // number of findable</span>
<span class="lineNum">    6540 </span><span class="lineNoCov">          0 :           &quot;n1F=&quot;&lt;&lt;n1F&lt;&lt;   // number of findable</span>
<span class="lineNum">    6541 </span><span class="lineNoCov">          0 :           &quot;shared=&quot;&lt;&lt;sumShared&lt;&lt;    // number of shared clusters</span>
<span class="lineNum">    6542 </span><span class="lineNoCov">          0 :           &quot;firstS=&quot;&lt;&lt;firstShared&lt;&lt;  // first and the last shared row</span>
<span class="lineNum">    6543 </span><span class="lineNoCov">          0 :           &quot;lastS=&quot;&lt;&lt;lastShared&lt;&lt;</span>
<span class="lineNum">    6544 </span><span class="lineNoCov">          0 :           &quot;firstRow=&quot;&lt;&lt;firstRow&lt;&lt;   // first and the last row with cluster</span>
<span class="lineNum">    6545 </span><span class="lineNoCov">          0 :           &quot;lastRow=&quot;&lt;&lt;lastRow&lt;&lt;     //</span>
<span class="lineNum">    6546 </span>            :           &quot;\n&quot;;
<span class="lineNum">    6547 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    6548 </span>            :       //
<span class="lineNum">    6549 </span>            :       // remove track with lower quality
<span class="lineNum">    6550 </span>            :       //
<span class="lineNum">    6551 </span><span class="lineCov">        204 :       if (ratio0&gt;AliTPCReconstructor::GetRecoParam()-&gt;GetCutSharedClusters(0) ||</span>
<span class="lineNum">    6552 </span><span class="lineCov">        136 :           ratio1&gt;AliTPCReconstructor::GetRecoParam()-&gt;GetCutSharedClusters(1)){</span>
<span class="lineNum">    6553 </span>            :         //
<span class="lineNum">    6554 </span>            :         //
<span class="lineNum">    6555 </span>            :         //
<span class="lineNum">    6556 </span><span class="lineNoCov">          0 :         MarkSeedFree( array-&gt;RemoveAt(index1) );</span>
<span class="lineNum">    6557 </span>            :       }
<span class="lineNum">    6558 </span><span class="lineCov">       5824 :     }</span>
<span class="lineNum">    6559 </span><span class="lineCov">        936 :   }</span>
<span class="lineNum">    6560 </span>            :   //
<span class="lineNum">    6561 </span>            :   // 4. Delete temporary array
<span class="lineNum">    6562 </span>            :   //
<span class="lineNum">    6563 </span><span class="lineCov">         48 :   if (fETPPool) fETPPool-&gt;Clear();</span>
<span class="lineNum">    6564 </span>            :   // delete [] params; // RS moved to stack
<span class="lineNum">    6565 </span>            :   //  delete [] quality;
<span class="lineNum">    6566 </span>            :   //  delete [] indexes;
<span class="lineNum">    6567 </span>            : 
<span class="lineNum">    6568 </span><span class="lineCov">         48 : }</span>
<span class="lineNum">    6569 </span>            : 
<a name="6570"><span class="lineNum">    6570 </span>            : </a>
<span class="lineNum">    6571 </span>            : 
<span class="lineNum">    6572 </span>            : void  AliTPCtracker::FindCurling(const TObjArray * array, AliESDEvent */*esd*/, Int_t iter)
<span class="lineNum">    6573 </span>            : {
<span class="lineNum">    6574 </span>            :   //
<span class="lineNum">    6575 </span>            :   //  find Curling tracks
<span class="lineNum">    6576 </span>            :   //  Use AliTPCReconstructor::StreamLevel()&amp;kStreamFindCurling if you want to tune parameters - cuts
<span class="lineNum">    6577 </span>            :   //
<span class="lineNum">    6578 </span>            :   //
<span class="lineNum">    6579 </span>            :   //  Algorithm done in 2 phases - because of CPU consumption
<span class="lineNum">    6580 </span>            :   //  it is n^2 algorithm - for lead-lead 20000x20000 combination are investigated                           
<span class="lineNum">    6581 </span>            :   //  see detal in MC part what can be used to cut
<span class="lineNum">    6582 </span>            :   //
<span class="lineNum">    6583 </span>            :   //    
<span class="lineNum">    6584 </span>            :   //
<span class="lineNum">    6585 </span>            :   const Float_t kMaxC         = 400;  // maximal curvature to of the track
<span class="lineNum">    6586 </span>            :   const Float_t kMaxdTheta    = 0.15;  // maximal distance in theta
<span class="lineNum">    6587 </span>            :   const Float_t kMaxdPhi      = 0.15;  // maximal distance in phi
<span class="lineNum">    6588 </span>            :   const Float_t kPtRatio      = 0.3; // ratio between pt
<span class="lineNum">    6589 </span>            :   const Float_t kMinDCAR      = 2.;   // distance to the primary vertex in r - see cpipe cut      
<span class="lineNum">    6590 </span>            : 
<span class="lineNum">    6591 </span>            :   //
<span class="lineNum">    6592 </span>            :   //    Curling tracks cuts
<span class="lineNum">    6593 </span>            :   //
<span class="lineNum">    6594 </span>            :   //
<span class="lineNum">    6595 </span>            :   const Float_t kMaxDeltaRMax = 40;   // distance in outer radius
<span class="lineNum">    6596 </span>            :   const Float_t kMaxDeltaRMin = 5.;   // distance in lower radius - see cpipe cut
<span class="lineNum">    6597 </span>            :   const Float_t kMinAngle     = 2.9;  // angle between tracks
<span class="lineNum">    6598 </span>            :   const Float_t kMaxDist      = 5;    // biggest distance 
<span class="lineNum">    6599 </span>            :   //
<span class="lineNum">    6600 </span>            :   // The cuts can be tuned using the &quot;MC information stored in Multi tree ==&gt; see FindMultiMC
<span class="lineNum">    6601 </span>            :   /* 
<span class="lineNum">    6602 </span>            :      Fast cuts:
<span class="lineNum">    6603 </span>            :      TCut csign(&quot;csign&quot;,&quot;Tr0.fP[4]*Tr1.fP[4]&lt;0&quot;); //opposite sign
<span class="lineNum">    6604 </span>            :      TCut cmax(&quot;cmax&quot;,&quot;abs(Tr0.GetC())&gt;1/400&quot;);
<span class="lineNum">    6605 </span>            :      TCut cda(&quot;cda&quot;,&quot;sqrt(dtheta^2+dfi^2)&lt;0.15&quot;);
<span class="lineNum">    6606 </span>            :      TCut ccratio(&quot;ccratio&quot;,&quot;abs((Tr0.fP[4]+Tr1.fP[4])/(abs(Tr0.fP[4])+abs(Tr1.fP[4])))&lt;0.3&quot;);
<span class="lineNum">    6607 </span>            :      TCut cpipe(&quot;cpipe&quot;, &quot;min(abs(r0-rc0),abs(r1-rc1))&gt;5&quot;);    
<span class="lineNum">    6608 </span>            :      //
<span class="lineNum">    6609 </span>            :      TCut cdrmax(&quot;cdrmax&quot;,&quot;abs(abs(rc0+r0)-abs(rc1+r1))&lt;40&quot;)
<span class="lineNum">    6610 </span>            :      TCut cdrmin(&quot;cdrmin&quot;,&quot;abs(abs(rc0+r0)-abs(rc1+r1))&lt;10&quot;)
<span class="lineNum">    6611 </span>            :      //
<span class="lineNum">    6612 </span>            :      Multi-&gt;Draw(&quot;dfi&quot;,&quot;iter==0&quot;+csign+cmax+cda+ccratio); ~94% of curling tracks fulfill 
<span class="lineNum">    6613 </span>            :      Multi-&gt;Draw(&quot;min(abs(r0-rc0),abs(r1-rc1))&quot;,&quot;iter==0&amp;&amp;abs(lab1)==abs(lab0)&quot;+csign+cmax+cda+ccratio+cpipe+cdrmin+cdrmax); //80%
<span class="lineNum">    6614 </span>            :      //
<span class="lineNum">    6615 </span>            :      Curling2-&gt;Draw(&quot;dfi&quot;,&quot;iter==0&amp;&amp;abs(lab0)==abs(lab1)&quot;+csign+cmax+cdtheta+cdfi+ccratio)
<span class="lineNum">    6616 </span>            : 
<span class="lineNum">    6617 </span>            :   */
<span class="lineNum">    6618 </span>            :   //  
<span class="lineNum">    6619 </span>            :   //
<span class="lineNum">    6620 </span>            :   //
<span class="lineNum">    6621 </span><span class="lineNoCov">          0 :   Int_t nentries = array-&gt;GetEntriesFast();</span>
<span class="lineNum">    6622 </span><span class="lineNoCov">          0 :   if (!fHelixPool) fHelixPool = new TClonesArray(&quot;AliHelix&quot;,nentries+100);</span>
<span class="lineNum">    6623 </span><span class="lineNoCov">          0 :   fHelixPool-&gt;Clear();</span>
<span class="lineNum">    6624 </span><span class="lineNoCov">          0 :   TClonesArray&amp; helixes = *fHelixPool;</span>
<span class="lineNum">    6625 </span>            : 
<span class="lineNum">    6626 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;nentries;i++){</span>
<span class="lineNum">    6627 </span><span class="lineNoCov">          0 :     AliTPCseed* track = (AliTPCseed*)array-&gt;At(i);    </span>
<span class="lineNum">    6628 </span><span class="lineNoCov">          0 :     if (!track) continue;</span>
<span class="lineNum">    6629 </span><span class="lineNoCov">          0 :     track-&gt;SetCircular(0);</span>
<span class="lineNum">    6630 </span><span class="lineNoCov">          0 :     new (helixes[i]) AliHelix(*track);</span>
<span class="lineNum">    6631 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    6632 </span>            :   //
<span class="lineNum">    6633 </span>            :   //
<span class="lineNum">    6634 </span><span class="lineNoCov">          0 :   TStopwatch timer;</span>
<span class="lineNum">    6635 </span><span class="lineNoCov">          0 :   timer.Start();</span>
<span class="lineNum">    6636 </span><span class="lineNoCov">          0 :   Double_t phase[2][2]={{0,0},{0,0}},radius[2]={0,0};</span>
<span class="lineNum">    6637 </span>            : 
<span class="lineNum">    6638 </span>            :   //
<span class="lineNum">    6639 </span>            :   // Find tracks
<span class="lineNum">    6640 </span>            :   //
<span class="lineNum">    6641 </span>            :   //
<span class="lineNum">    6642 </span><span class="lineNoCov">          0 :   for (Int_t i0=0;i0&lt;nentries;i0++){</span>
<span class="lineNum">    6643 </span><span class="lineNoCov">          0 :     AliTPCseed * track0 = (AliTPCseed*)array-&gt;At(i0);</span>
<span class="lineNum">    6644 </span><span class="lineNoCov">          0 :     if (!track0) continue;    </span>
<span class="lineNum">    6645 </span><span class="lineNoCov">          0 :     if (TMath::Abs(track0-&gt;GetC())&lt;1/kMaxC) continue;</span>
<span class="lineNum">    6646 </span><span class="lineNoCov">          0 :     AliHelix* hlxi0 = (AliHelix*)helixes[i0];</span>
<span class="lineNum">    6647 </span><span class="lineNoCov">          0 :     Float_t xc0 = hlxi0-&gt;GetHelix(6);</span>
<span class="lineNum">    6648 </span><span class="lineNoCov">          0 :     Float_t yc0 = hlxi0-&gt;GetHelix(7);</span>
<span class="lineNum">    6649 </span><span class="lineNoCov">          0 :     Float_t r0  = hlxi0-&gt;GetHelix(8);</span>
<span class="lineNum">    6650 </span><span class="lineNoCov">          0 :     Float_t rc0 = TMath::Sqrt(xc0*xc0+yc0*yc0);</span>
<span class="lineNum">    6651 </span><span class="lineNoCov">          0 :     Float_t fi0 = TMath::ATan2(yc0,xc0);</span>
<span class="lineNum">    6652 </span>            :     
<span class="lineNum">    6653 </span><span class="lineNoCov">          0 :     for (Int_t i1=i0+1;i1&lt;nentries;i1++){</span>
<span class="lineNum">    6654 </span><span class="lineNoCov">          0 :       AliTPCseed * track1 = (AliTPCseed*)array-&gt;At(i1);</span>
<span class="lineNum">    6655 </span><span class="lineNoCov">          0 :       if (!track1) continue;      </span>
<span class="lineNum">    6656 </span><span class="lineNoCov">          0 :       if (TMath::Abs(track1-&gt;GetC())&lt;1/kMaxC) continue;    </span>
<span class="lineNum">    6657 </span><span class="lineNoCov">          0 :       AliHelix* hlxi1 = (AliHelix*)helixes[i1];</span>
<span class="lineNum">    6658 </span><span class="lineNoCov">          0 :       Float_t xc1 = hlxi1-&gt;GetHelix(6);</span>
<span class="lineNum">    6659 </span><span class="lineNoCov">          0 :       Float_t yc1 = hlxi1-&gt;GetHelix(7);</span>
<span class="lineNum">    6660 </span><span class="lineNoCov">          0 :       Float_t r1  = hlxi1-&gt;GetHelix(8);</span>
<span class="lineNum">    6661 </span><span class="lineNoCov">          0 :       Float_t rc1 = TMath::Sqrt(xc1*xc1+yc1*yc1);</span>
<span class="lineNum">    6662 </span><span class="lineNoCov">          0 :       Float_t fi1 = TMath::ATan2(yc1,xc1);</span>
<span class="lineNum">    6663 </span>            :       //
<span class="lineNum">    6664 </span><span class="lineNoCov">          0 :       Float_t dfi = fi0-fi1;</span>
<span class="lineNum">    6665 </span>            :       //
<span class="lineNum">    6666 </span>            :       //
<span class="lineNum">    6667 </span><span class="lineNoCov">          0 :       if (dfi&gt;1.5*TMath::Pi())  dfi-=TMath::Pi();  // take care about edge effect </span>
<span class="lineNum">    6668 </span><span class="lineNoCov">          0 :       if (dfi&lt;-1.5*TMath::Pi()) dfi+=TMath::Pi();  // </span>
<span class="lineNum">    6669 </span><span class="lineNoCov">          0 :       Float_t dtheta = TMath::Abs(track0-&gt;GetTgl()-track1-&gt;GetTgl())&lt;TMath::Abs(track0-&gt;GetTgl()+track1-&gt;GetTgl())? track0-&gt;GetTgl()-track1-&gt;GetTgl():track0-&gt;GetTgl()+track1-&gt;GetTgl();</span>
<span class="lineNum">    6670 </span>            :       //
<span class="lineNum">    6671 </span>            :       //
<span class="lineNum">    6672 </span>            :       // FIRST fast cuts
<span class="lineNum">    6673 </span><span class="lineNoCov">          0 :       if (track0-&gt;GetBConstrain()&amp;&amp;track1-&gt;GetBConstrain())  continue;  // not constrained</span>
<span class="lineNum">    6674 </span><span class="lineNoCov">          0 :       if (track1-&gt;GetSigned1Pt()*track0-&gt;GetSigned1Pt()&gt;0)   continue; // not the same sign</span>
<span class="lineNum">    6675 </span><span class="lineNoCov">          0 :       if ( TMath::Abs(track1-&gt;GetTgl()+track0-&gt;GetTgl())&gt;kMaxdTheta) continue; //distance in the Theta</span>
<span class="lineNum">    6676 </span><span class="lineNoCov">          0 :       if ( TMath::Abs(dfi)&gt;kMaxdPhi) continue;  //distance in phi</span>
<span class="lineNum">    6677 </span><span class="lineNoCov">          0 :       if ( TMath::Sqrt(dfi*dfi+dtheta*dtheta)&gt;kMaxdPhi) continue; //common angular offset</span>
<span class="lineNum">    6678 </span>            :       //
<span class="lineNum">    6679 </span><span class="lineNoCov">          0 :       Float_t pt0 = track0-&gt;GetSignedPt();</span>
<span class="lineNum">    6680 </span><span class="lineNoCov">          0 :       Float_t pt1 = track1-&gt;GetSignedPt();</span>
<span class="lineNum">    6681 </span><span class="lineNoCov">          0 :       if ((TMath::Abs(pt0+pt1)/(TMath::Abs(pt0)+TMath::Abs(pt1)))&gt;kPtRatio) continue;      </span>
<span class="lineNum">    6682 </span><span class="lineNoCov">          0 :       if ((iter==1) &amp;&amp; TMath::Abs(TMath::Abs(rc0+r0)-TMath::Abs(rc1+r1))&gt;kMaxDeltaRMax) continue;</span>
<span class="lineNum">    6683 </span><span class="lineNoCov">          0 :       if ((iter!=1) &amp;&amp;TMath::Abs(TMath::Abs(rc0-r0)-TMath::Abs(rc1-r1))&gt;kMaxDeltaRMin) continue;</span>
<span class="lineNum">    6684 </span><span class="lineNoCov">          0 :       if (TMath::Min(TMath::Abs(rc0-r0),TMath::Abs(rc1-r1))&lt;kMinDCAR) continue;</span>
<span class="lineNum">    6685 </span>            :       //
<span class="lineNum">    6686 </span>            :       //
<span class="lineNum">    6687 </span>            :       // Now find closest approach
<span class="lineNum">    6688 </span>            :       //
<span class="lineNum">    6689 </span>            :       //
<span class="lineNum">    6690 </span>            :       //
<span class="lineNum">    6691 </span><span class="lineNoCov">          0 :       Int_t npoints = hlxi0-&gt;GetRPHIintersections(*hlxi1, phase, radius,10);</span>
<span class="lineNum">    6692 </span><span class="lineNoCov">          0 :       if (npoints==0) continue;</span>
<span class="lineNum">    6693 </span><span class="lineNoCov">          0 :       hlxi0-&gt;GetClosestPhases(*hlxi1, phase);</span>
<span class="lineNum">    6694 </span>            :       //
<span class="lineNum">    6695 </span><span class="lineNoCov">          0 :       Double_t xyz0[3];</span>
<span class="lineNum">    6696 </span><span class="lineNoCov">          0 :       Double_t xyz1[3];</span>
<span class="lineNum">    6697 </span><span class="lineNoCov">          0 :       Double_t hangles[3];</span>
<span class="lineNum">    6698 </span><span class="lineNoCov">          0 :       hlxi0-&gt;Evaluate(phase[0][0],xyz0);</span>
<span class="lineNum">    6699 </span><span class="lineNoCov">          0 :       hlxi1-&gt;Evaluate(phase[0][1],xyz1);</span>
<span class="lineNum">    6700 </span>            : 
<span class="lineNum">    6701 </span><span class="lineNoCov">          0 :       hlxi0-&gt;GetAngle(phase[0][0],*hlxi1,phase[0][1],hangles);</span>
<span class="lineNum">    6702 </span><span class="lineNoCov">          0 :       Double_t deltah[2],deltabest;</span>
<span class="lineNum">    6703 </span><span class="lineNoCov">          0 :       if (TMath::Abs(hangles[2])&lt;kMinAngle) continue;</span>
<span class="lineNum">    6704 </span>            : 
<span class="lineNum">    6705 </span><span class="lineNoCov">          0 :       if (npoints&gt;0){</span>
<span class="lineNum">    6706 </span>            :         Int_t ibest=0;
<span class="lineNum">    6707 </span><span class="lineNoCov">          0 :         hlxi0-&gt;ParabolicDCA(*hlxi1,phase[0][0],phase[0][1],radius[0],deltah[0],2);</span>
<span class="lineNum">    6708 </span><span class="lineNoCov">          0 :         if (npoints==2){</span>
<span class="lineNum">    6709 </span><span class="lineNoCov">          0 :           hlxi0-&gt;ParabolicDCA(*hlxi1,phase[1][0],phase[1][1],radius[1],deltah[1],2);</span>
<span class="lineNum">    6710 </span><span class="lineNoCov">          0 :           if (deltah[1]&lt;deltah[0]) ibest=1;</span>
<span class="lineNum">    6711 </span>            :         }
<span class="lineNum">    6712 </span><span class="lineNoCov">          0 :         deltabest  = TMath::Sqrt(deltah[ibest]);</span>
<span class="lineNum">    6713 </span><span class="lineNoCov">          0 :         hlxi0-&gt;Evaluate(phase[ibest][0],xyz0);</span>
<span class="lineNum">    6714 </span><span class="lineNoCov">          0 :         hlxi1-&gt;Evaluate(phase[ibest][1],xyz1);</span>
<span class="lineNum">    6715 </span><span class="lineNoCov">          0 :         hlxi0-&gt;GetAngle(phase[ibest][0],*hlxi1,phase[ibest][1],hangles);</span>
<span class="lineNum">    6716 </span><span class="lineNoCov">          0 :         Double_t radiusbest = TMath::Sqrt(radius[ibest]);</span>
<span class="lineNum">    6717 </span>            :         //
<span class="lineNum">    6718 </span><span class="lineNoCov">          0 :         if (deltabest&gt;kMaxDist) continue;</span>
<span class="lineNum">    6719 </span>            :         //      if (mindcar+mindcaz&lt;40 &amp;&amp; (TMath::Abs(hangles[2])&lt;kMinAngle ||deltabest&gt;3)) continue;
<span class="lineNum">    6720 </span>            :         Bool_t sign =kFALSE;
<span class="lineNum">    6721 </span><span class="lineNoCov">          0 :         if (hangles[2]&gt;kMinAngle) sign =kTRUE;</span>
<span class="lineNum">    6722 </span>            :         //
<span class="lineNum">    6723 </span><span class="lineNoCov">          0 :         if (sign){</span>
<span class="lineNum">    6724 </span>            :           //      circular[i0] = kTRUE;
<span class="lineNum">    6725 </span>            :           //      circular[i1] = kTRUE;
<span class="lineNum">    6726 </span><span class="lineNoCov">          0 :           if (track0-&gt;OneOverPt()&lt;track1-&gt;OneOverPt()){</span>
<span class="lineNum">    6727 </span><span class="lineNoCov">          0 :             track0-&gt;SetCircular(track0-&gt;GetCircular()+1);</span>
<span class="lineNum">    6728 </span><span class="lineNoCov">          0 :             track1-&gt;SetCircular(track1-&gt;GetCircular()+2);</span>
<span class="lineNum">    6729 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    6730 </span>            :           else{
<span class="lineNum">    6731 </span><span class="lineNoCov">          0 :             track1-&gt;SetCircular(track1-&gt;GetCircular()+1);</span>
<span class="lineNum">    6732 </span><span class="lineNoCov">          0 :             track0-&gt;SetCircular(track0-&gt;GetCircular()+2);</span>
<span class="lineNum">    6733 </span>            :           }
<span class="lineNum">    6734 </span>            :         }               
<span class="lineNum">    6735 </span><span class="lineNoCov">          0 :         if ((AliTPCReconstructor::StreamLevel()&amp;kStreamFindCurling)&gt;0){  // flag: stream track infroamtion if the FindCurling tracks method        </span>
<span class="lineNum">    6736 </span>            :           //
<span class="lineNum">    6737 </span>            :           //debug stream to tune &quot;fine&quot; cuts    
<span class="lineNum">    6738 </span><span class="lineNoCov">          0 :           Int_t lab0=track0-&gt;GetLabel();</span>
<span class="lineNum">    6739 </span><span class="lineNoCov">          0 :           Int_t lab1=track1-&gt;GetLabel();</span>
<span class="lineNum">    6740 </span><span class="lineNoCov">          0 :           TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    6741 </span><span class="lineNoCov">          0 :           cstream&lt;&lt;&quot;Curling2&quot;&lt;&lt;</span>
<span class="lineNum">    6742 </span><span class="lineNoCov">          0 :             &quot;iter=&quot;&lt;&lt;iter&lt;&lt;</span>
<span class="lineNum">    6743 </span><span class="lineNoCov">          0 :             &quot;lab0=&quot;&lt;&lt;lab0&lt;&lt;</span>
<span class="lineNum">    6744 </span><span class="lineNoCov">          0 :             &quot;lab1=&quot;&lt;&lt;lab1&lt;&lt;   </span>
<span class="lineNum">    6745 </span><span class="lineNoCov">          0 :             &quot;Tr0.=&quot;&lt;&lt;track0&lt;&lt;</span>
<span class="lineNum">    6746 </span><span class="lineNoCov">          0 :             &quot;Tr1.=&quot;&lt;&lt;track1&lt;&lt;</span>
<span class="lineNum">    6747 </span>            :             //
<span class="lineNum">    6748 </span><span class="lineNoCov">          0 :             &quot;r0=&quot;&lt;&lt;r0&lt;&lt;</span>
<span class="lineNum">    6749 </span><span class="lineNoCov">          0 :             &quot;rc0=&quot;&lt;&lt;rc0&lt;&lt;</span>
<span class="lineNum">    6750 </span><span class="lineNoCov">          0 :             &quot;fi0=&quot;&lt;&lt;fi0&lt;&lt;</span>
<span class="lineNum">    6751 </span><span class="lineNoCov">          0 :             &quot;r1=&quot;&lt;&lt;r1&lt;&lt;</span>
<span class="lineNum">    6752 </span><span class="lineNoCov">          0 :             &quot;rc1=&quot;&lt;&lt;rc1&lt;&lt;</span>
<span class="lineNum">    6753 </span><span class="lineNoCov">          0 :             &quot;fi1=&quot;&lt;&lt;fi1&lt;&lt;</span>
<span class="lineNum">    6754 </span><span class="lineNoCov">          0 :             &quot;dfi=&quot;&lt;&lt;dfi&lt;&lt;</span>
<span class="lineNum">    6755 </span><span class="lineNoCov">          0 :             &quot;dtheta=&quot;&lt;&lt;dtheta&lt;&lt;</span>
<span class="lineNum">    6756 </span>            :             //
<span class="lineNum">    6757 </span><span class="lineNoCov">          0 :             &quot;npoints=&quot;&lt;&lt;npoints&lt;&lt;                      </span>
<span class="lineNum">    6758 </span><span class="lineNoCov">          0 :             &quot;hangles0=&quot;&lt;&lt;hangles[0]&lt;&lt;</span>
<span class="lineNum">    6759 </span><span class="lineNoCov">          0 :             &quot;hangles1=&quot;&lt;&lt;hangles[1]&lt;&lt;</span>
<span class="lineNum">    6760 </span><span class="lineNoCov">          0 :             &quot;hangles2=&quot;&lt;&lt;hangles[2]&lt;&lt;                    </span>
<span class="lineNum">    6761 </span><span class="lineNoCov">          0 :             &quot;xyz0=&quot;&lt;&lt;xyz0[2]&lt;&lt;</span>
<span class="lineNum">    6762 </span><span class="lineNoCov">          0 :             &quot;xyzz1=&quot;&lt;&lt;xyz1[2]&lt;&lt;</span>
<span class="lineNum">    6763 </span><span class="lineNoCov">          0 :             &quot;radius=&quot;&lt;&lt;radiusbest&lt;&lt;</span>
<span class="lineNum">    6764 </span><span class="lineNoCov">          0 :             &quot;deltabest=&quot;&lt;&lt;deltabest&lt;&lt; </span>
<span class="lineNum">    6765 </span><span class="lineNoCov">          0 :             &quot;phase0=&quot;&lt;&lt;phase[ibest][0]&lt;&lt;</span>
<span class="lineNum">    6766 </span><span class="lineNoCov">          0 :             &quot;phase1=&quot;&lt;&lt;phase[ibest][1]&lt;&lt;</span>
<span class="lineNum">    6767 </span>            :             &quot;\n&quot;;               
<span class="lineNum">    6768 </span>            : 
<span class="lineNum">    6769 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    6770 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    6771 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    6772 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    6773 </span><span class="lineNoCov">          0 :   if (fHelixPool) fHelixPool-&gt;Clear();</span>
<span class="lineNum">    6774 </span>            :   //  delete [] helixes; //RS moved to stack
<span class="lineNum">    6775 </span><span class="lineNoCov">          0 :   if (AliTPCReconstructor::StreamLevel()&gt;1) {</span>
<span class="lineNum">    6776 </span><span class="lineNoCov">          0 :     AliInfo(&quot;Time for curling tracks removal&quot;);</span>
<span class="lineNum">    6777 </span><span class="lineNoCov">          0 :     timer.Print();</span>
<span class="lineNum">    6778 </span>            :   }
<span class="lineNum">    6779 </span><span class="lineNoCov">          0 : }</span>
<a name="6780"><span class="lineNum">    6780 </span>            : </a>
<span class="lineNum">    6781 </span>            : 
<span class="lineNum">    6782 </span>            : void  AliTPCtracker::FindKinks(TObjArray * array, AliESDEvent *esd)
<span class="lineNum">    6783 </span>            : {
<span class="lineNum">    6784 </span>            :   //
<span class="lineNum">    6785 </span>            :   //  find kinks
<span class="lineNum">    6786 </span>            :   //
<span class="lineNum">    6787 </span>            :   //
<span class="lineNum">    6788 </span>            :   // RS something is wrong in this routine: not all seeds are assigned to daughters and mothers array, but they all are queried
<span class="lineNum">    6789 </span>            :   // to check later
<span class="lineNum">    6790 </span>            : 
<span class="lineNum">    6791 </span><span class="lineCov">         16 :   TObjArray kinks(10000);</span>
<span class="lineNum">    6792 </span><span class="lineCov">          8 :   Int_t nentries = array-&gt;GetEntriesFast();</span>
<span class="lineNum">    6793 </span><span class="lineCov">          8 :   Char_t   sign[nentries];</span>
<span class="lineNum">    6794 </span><span class="lineCov">          8 :   UChar_t  nclusters[nentries];</span>
<span class="lineNum">    6795 </span><span class="lineCov">          8 :   Float_t  alpha[nentries];</span>
<span class="lineNum">    6796 </span><span class="lineCov">          8 :   UChar_t  usage[nentries];</span>
<span class="lineNum">    6797 </span><span class="lineCov">          8 :   Float_t  zm[nentries];</span>
<span class="lineNum">    6798 </span><span class="lineCov">          8 :   Float_t  z0[nentries]; </span>
<span class="lineNum">    6799 </span><span class="lineCov">          8 :   Float_t  fim[nentries];</span>
<span class="lineNum">    6800 </span><span class="lineCov">          8 :   Bool_t   shared[nentries];</span>
<span class="lineNum">    6801 </span><span class="lineCov">          8 :   Bool_t   circular[nentries];</span>
<span class="lineNum">    6802 </span><span class="lineCov">          8 :   Float_t dca[nentries];</span>
<span class="lineNum">    6803 </span><span class="lineCov">         16 :   AliKink  *kink         = new AliKink();</span>
<span class="lineNum">    6804 </span>            :   //
<span class="lineNum">    6805 </span><span class="lineCov">         14 :   if (!fHelixPool) fHelixPool = new TClonesArray(&quot;AliHelix&quot;,nentries+100);</span>
<span class="lineNum">    6806 </span><span class="lineCov">          8 :   fHelixPool-&gt;Clear();</span>
<span class="lineNum">    6807 </span><span class="lineCov">          8 :   TClonesArray&amp; helixes = *fHelixPool;</span>
<span class="lineNum">    6808 </span>            : 
<span class="lineNum">    6809 </span>            :   //const AliESDVertex * primvertex = esd-&gt;GetVertex();
<span class="lineNum">    6810 </span>            :   //
<span class="lineNum">    6811 </span>            :   //  nentries = array-&gt;GetEntriesFast();
<span class="lineNum">    6812 </span>            :   //
<span class="lineNum">    6813 </span>            :   
<span class="lineNum">    6814 </span>            :   //
<span class="lineNum">    6815 </span>            :   //
<span class="lineNum">    6816 </span><span class="lineCov">        552 :   for (Int_t i=0;i&lt;nentries;i++){</span>
<span class="lineNum">    6817 </span><span class="lineCov">        268 :     sign[i]=0;</span>
<span class="lineNum">    6818 </span><span class="lineCov">        268 :     usage[i]=0;</span>
<span class="lineNum">    6819 </span><span class="lineCov">        536 :     AliTPCseed* track = (AliTPCseed*)array-&gt;At(i);    </span>
<span class="lineNum">    6820 </span><span class="lineCov">        388 :     if (!track) continue;</span>
<span class="lineNum">    6821 </span><span class="lineCov">        148 :     track-&gt;SetCircular(0);</span>
<span class="lineNum">    6822 </span><span class="lineCov">        148 :     shared[i] = kFALSE;</span>
<span class="lineNum">    6823 </span><span class="lineCov">        148 :     track-&gt;UpdatePoints();</span>
<span class="lineNum">    6824 </span><span class="lineCov">        296 :     if (( track-&gt;GetPoints()[2]- track-&gt;GetPoints()[0])&gt;5 &amp;&amp; track-&gt;GetPoints()[3]&gt;0.8){</span>
<span class="lineNum">    6825 </span>            :     }
<span class="lineNum">    6826 </span><span class="lineCov">        296 :     nclusters[i]=track-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    6827 </span><span class="lineCov">        296 :     alpha[i] = track-&gt;GetAlpha();</span>
<span class="lineNum">    6828 </span><span class="lineCov">        444 :     AliHelix* hlxi = new (helixes[i]) AliHelix(*track);</span>
<span class="lineNum">    6829 </span><span class="lineCov">        148 :     Double_t xyz[3];</span>
<span class="lineNum">    6830 </span><span class="lineCov">        148 :     hlxi-&gt;Evaluate(0,xyz);</span>
<span class="lineNum">    6831 </span><span class="lineCov">        296 :     sign[i] = (track-&gt;GetC()&gt;0) ? -1:1;</span>
<span class="lineNum">    6832 </span><span class="lineCov">        148 :     Double_t x,y,z;</span>
<span class="lineNum">    6833 </span>            :     x=160;
<span class="lineNum">    6834 </span><span class="lineCov">        296 :     if (track-&gt;GetProlongation(x,y,z)){</span>
<span class="lineNum">    6835 </span><span class="lineCov">        122 :       zm[i]  = z;</span>
<span class="lineNum">    6836 </span><span class="lineCov">        122 :       fim[i] = alpha[i]+TMath::ATan2(y,x);</span>
<span class="lineNum">    6837 </span><span class="lineCov">        122 :     }</span>
<span class="lineNum">    6838 </span>            :     else{
<span class="lineNum">    6839 </span><span class="lineCov">         52 :       zm[i]  = track-&gt;GetZ();</span>
<span class="lineNum">    6840 </span><span class="lineCov">         26 :       fim[i] = alpha[i];</span>
<span class="lineNum">    6841 </span>            :     }   
<span class="lineNum">    6842 </span><span class="lineCov">        148 :     z0[i]=1000;</span>
<span class="lineNum">    6843 </span><span class="lineCov">        148 :     circular[i]= kFALSE;</span>
<span class="lineNum">    6844 </span><span class="lineCov">        434 :     if (track-&gt;GetProlongation(0,y,z))  z0[i] = z;</span>
<span class="lineNum">    6845 </span><span class="lineCov">        296 :     dca[i] = track-&gt;GetD(0,0);    </span>
<span class="lineNum">    6846 </span><span class="lineCov">        148 :   }</span>
<span class="lineNum">    6847 </span>            :   //
<span class="lineNum">    6848 </span>            :   //
<span class="lineNum">    6849 </span><span class="lineCov">          8 :   TStopwatch timer;</span>
<span class="lineNum">    6850 </span><span class="lineCov">          8 :   timer.Start();</span>
<span class="lineNum">    6851 </span>            :   Int_t ncandidates =0;
<span class="lineNum">    6852 </span>            :   Int_t nall =0;
<span class="lineNum">    6853 </span>            :   Int_t ntracks=0; 
<span class="lineNum">    6854 </span><span class="lineCov">          8 :   Double_t phase[2][2]={{0,0},{0,0}},radius[2]={0,0};</span>
<span class="lineNum">    6855 </span>            : 
<span class="lineNum">    6856 </span>            :   //
<span class="lineNum">    6857 </span>            :   // Find circling track
<span class="lineNum">    6858 </span>            :   //
<span class="lineNum">    6859 </span><span class="lineCov">        552 :   for (Int_t i0=0;i0&lt;nentries;i0++){</span>
<span class="lineNum">    6860 </span><span class="lineCov">        536 :     AliTPCseed * track0 = (AliTPCseed*)array-&gt;At(i0);</span>
<span class="lineNum">    6861 </span><span class="lineCov">        388 :     if (!track0) continue;    </span>
<span class="lineNum">    6862 </span><span class="lineCov">        310 :     if (track0-&gt;GetNumberOfClusters()&lt;40) continue;</span>
<span class="lineNum">    6863 </span><span class="lineCov">        370 :     if (TMath::Abs(1./track0-&gt;GetC())&gt;200) continue;</span>
<span class="lineNum">    6864 </span><span class="lineCov">         64 :     AliHelix* hlxi0 = (AliHelix*)helixes[i0];</span>
<span class="lineNum">    6865 </span>            :     //
<span class="lineNum">    6866 </span><span class="lineCov">        632 :     for (Int_t i1=i0+1;i1&lt;nentries;i1++){</span>
<span class="lineNum">    6867 </span><span class="lineCov">        568 :       AliTPCseed * track1 = (AliTPCseed*)array-&gt;At(i1);</span>
<span class="lineNum">    6868 </span><span class="lineCov">        328 :       if (!track1) continue;</span>
<span class="lineNum">    6869 </span><span class="lineCov">        576 :       if (track1-&gt;GetNumberOfClusters()&lt;40)                  continue;</span>
<span class="lineNum">    6870 </span><span class="lineCov">        442 :       if ( TMath::Abs(track1-&gt;GetTgl()+track0-&gt;GetTgl())&gt;0.1) continue;</span>
<span class="lineNum">    6871 </span><span class="lineCov">        134 :       if (track0-&gt;GetBConstrain()&amp;&amp;track1-&gt;GetBConstrain()) continue;</span>
<span class="lineNum">    6872 </span><span class="lineCov">        268 :       if (TMath::Abs(1./track1-&gt;GetC())&gt;200) continue;</span>
<span class="lineNum">    6873 </span><span class="lineCov">        462 :       if (track1-&gt;GetSigned1Pt()*track0-&gt;GetSigned1Pt()&gt;0)      continue;</span>
<span class="lineNum">    6874 </span><span class="lineCov">        250 :       if (track1-&gt;GetTgl()*track0-&gt;GetTgl()&gt;0)      continue;</span>
<span class="lineNum">    6875 </span><span class="lineCov">        138 :       if (TMath::Max(TMath::Abs(1./track0-&gt;GetC()),TMath::Abs(1./track1-&gt;GetC()))&gt;190) continue;</span>
<span class="lineNum">    6876 </span><span class="lineCov">         46 :       if (track0-&gt;GetBConstrain()&amp;&amp;track1-&gt;OneOverPt()&lt;track0-&gt;OneOverPt()) continue; //returning - lower momenta</span>
<span class="lineNum">    6877 </span><span class="lineCov">         46 :       if (track1-&gt;GetBConstrain()&amp;&amp;track0-&gt;OneOverPt()&lt;track1-&gt;OneOverPt()) continue; //returning - lower momenta</span>
<span class="lineNum">    6878 </span>            :       //
<span class="lineNum">    6879 </span><span class="lineCov">         46 :       Float_t mindcar = TMath::Min(TMath::Abs(dca[i0]),TMath::Abs(dca[i1]));</span>
<span class="lineNum">    6880 </span><span class="lineCov">         46 :       if (mindcar&lt;5)   continue;</span>
<span class="lineNum">    6881 </span><span class="lineCov">         46 :       Float_t mindcaz = TMath::Min(TMath::Abs(z0[i0]-GetZ()),TMath::Abs(z0[i1]-GetZ()));</span>
<span class="lineNum">    6882 </span><span class="lineCov">         60 :       if (mindcaz&lt;5) continue;</span>
<span class="lineNum">    6883 </span><span class="lineCov">         32 :       if (mindcar+mindcaz&lt;20) continue;</span>
<span class="lineNum">    6884 </span>            :       //
<span class="lineNum">    6885 </span><span class="lineCov">         64 :       AliHelix* hlxi1 = (AliHelix*)helixes[i1];</span>
<span class="lineNum">    6886 </span>            :       //
<span class="lineNum">    6887 </span><span class="lineCov">         32 :       Float_t xc0 = hlxi0-&gt;GetHelix(6);</span>
<span class="lineNum">    6888 </span><span class="lineCov">         32 :       Float_t yc0 = hlxi0-&gt;GetHelix(7);</span>
<span class="lineNum">    6889 </span><span class="lineCov">         32 :       Float_t r0  = hlxi0-&gt;GetHelix(8);</span>
<span class="lineNum">    6890 </span><span class="lineCov">         32 :       Float_t xc1 = hlxi1-&gt;GetHelix(6);</span>
<span class="lineNum">    6891 </span><span class="lineCov">         32 :       Float_t yc1 = hlxi1-&gt;GetHelix(7);</span>
<span class="lineNum">    6892 </span><span class="lineCov">         32 :       Float_t r1  = hlxi1-&gt;GetHelix(8);</span>
<span class="lineNum">    6893 </span>            :         
<span class="lineNum">    6894 </span><span class="lineCov">         32 :       Float_t rmean = (r0+r1)*0.5;</span>
<span class="lineNum">    6895 </span><span class="lineCov">         32 :       Float_t delta =TMath::Sqrt((xc1-xc0)*(xc1-xc0)+(yc1-yc0)*(yc1-yc0));</span>
<span class="lineNum">    6896 </span>            :       //if (delta&gt;30) continue;
<span class="lineNum">    6897 </span><span class="lineCov">         50 :       if (delta&gt;rmean*0.25) continue;</span>
<span class="lineNum">    6898 </span><span class="lineCov">         14 :       if (TMath::Abs(r0-r1)/rmean&gt;0.3) continue; </span>
<span class="lineNum">    6899 </span>            :       //
<span class="lineNum">    6900 </span><span class="lineCov">         28 :       Int_t npoints = hlxi0-&gt;GetRPHIintersections(*hlxi1, phase, radius,10);</span>
<span class="lineNum">    6901 </span><span class="lineCov">         14 :       if (npoints==0) continue;</span>
<span class="lineNum">    6902 </span><span class="lineCov">         14 :       hlxi0-&gt;GetClosestPhases(*hlxi1, phase);</span>
<span class="lineNum">    6903 </span>            :       //
<span class="lineNum">    6904 </span><span class="lineCov">         14 :       Double_t xyz0[3];</span>
<span class="lineNum">    6905 </span><span class="lineCov">         14 :       Double_t xyz1[3];</span>
<span class="lineNum">    6906 </span><span class="lineCov">         14 :       Double_t hangles[3];</span>
<span class="lineNum">    6907 </span><span class="lineCov">         14 :       hlxi0-&gt;Evaluate(phase[0][0],xyz0);</span>
<span class="lineNum">    6908 </span><span class="lineCov">         14 :       hlxi1-&gt;Evaluate(phase[0][1],xyz1);</span>
<span class="lineNum">    6909 </span>            : 
<span class="lineNum">    6910 </span><span class="lineCov">         14 :       hlxi0-&gt;GetAngle(phase[0][0],*hlxi1,phase[0][1],hangles);</span>
<span class="lineNum">    6911 </span><span class="lineCov">         14 :       Double_t deltah[2],deltabest;</span>
<span class="lineNum">    6912 </span><span class="lineCov">         14 :       if (hangles[2]&lt;2.8) continue;</span>
<span class="lineNum">    6913 </span><span class="lineCov">         14 :       if (npoints&gt;0){</span>
<span class="lineNum">    6914 </span>            :         Int_t ibest=0;
<span class="lineNum">    6915 </span><span class="lineCov">         14 :         hlxi0-&gt;ParabolicDCA(*hlxi1,phase[0][0],phase[0][1],radius[0],deltah[0],2);</span>
<span class="lineNum">    6916 </span><span class="lineCov">         14 :         if (npoints==2){</span>
<span class="lineNum">    6917 </span><span class="lineCov">         12 :           hlxi0-&gt;ParabolicDCA(*hlxi1,phase[1][0],phase[1][1],radius[1],deltah[1],2);</span>
<span class="lineNum">    6918 </span><span class="lineCov">         22 :           if (deltah[1]&lt;deltah[0]) ibest=1;</span>
<span class="lineNum">    6919 </span>            :         }
<span class="lineNum">    6920 </span><span class="lineCov">         14 :         deltabest  = TMath::Sqrt(deltah[ibest]);</span>
<span class="lineNum">    6921 </span><span class="lineCov">         14 :         hlxi0-&gt;Evaluate(phase[ibest][0],xyz0);</span>
<span class="lineNum">    6922 </span><span class="lineCov">         14 :         hlxi1-&gt;Evaluate(phase[ibest][1],xyz1);</span>
<span class="lineNum">    6923 </span><span class="lineCov">         14 :         hlxi0-&gt;GetAngle(phase[ibest][0],*hlxi1,phase[ibest][1],hangles);</span>
<span class="lineNum">    6924 </span><span class="lineCov">         14 :         Double_t radiusbest = TMath::Sqrt(radius[ibest]);</span>
<span class="lineNum">    6925 </span>            :         //
<span class="lineNum">    6926 </span><span class="lineCov">         14 :         if (deltabest&gt;6) continue;</span>
<span class="lineNum">    6927 </span><span class="lineCov">         32 :         if (mindcar+mindcaz&lt;40 &amp;&amp; (hangles[2]&lt;3.12||deltabest&gt;3)) continue;</span>
<span class="lineNum">    6928 </span>            :         Bool_t lsign =kFALSE;
<span class="lineNum">    6929 </span><span class="lineCov">         16 :         if (hangles[2]&gt;3.06) lsign =kTRUE;</span>
<span class="lineNum">    6930 </span>            :         //
<span class="lineNum">    6931 </span><span class="lineCov">          8 :         if (lsign){</span>
<span class="lineNum">    6932 </span><span class="lineCov">          8 :           circular[i0] = kTRUE;</span>
<span class="lineNum">    6933 </span><span class="lineCov">          8 :           circular[i1] = kTRUE;</span>
<span class="lineNum">    6934 </span><span class="lineCov">         24 :           if (track0-&gt;OneOverPt()&lt;track1-&gt;OneOverPt()){</span>
<span class="lineNum">    6935 </span><span class="lineCov">          2 :             track0-&gt;SetCircular(track0-&gt;GetCircular()+1);</span>
<span class="lineNum">    6936 </span><span class="lineCov">          2 :             track1-&gt;SetCircular(track1-&gt;GetCircular()+2);</span>
<span class="lineNum">    6937 </span><span class="lineCov">          2 :           }</span>
<span class="lineNum">    6938 </span>            :           else{
<span class="lineNum">    6939 </span><span class="lineCov">          6 :             track1-&gt;SetCircular(track1-&gt;GetCircular()+1);</span>
<span class="lineNum">    6940 </span><span class="lineCov">          6 :             track0-&gt;SetCircular(track0-&gt;GetCircular()+2);</span>
<span class="lineNum">    6941 </span>            :           }
<span class="lineNum">    6942 </span>            :         }               
<span class="lineNum">    6943 </span><span class="lineCov">         16 :         if (lsign&amp;&amp;((AliTPCReconstructor::StreamLevel()&amp;kStreamFindCurling)&gt;0)){   </span>
<span class="lineNum">    6944 </span>            :           //debug stream          
<span class="lineNum">    6945 </span><span class="lineNoCov">          0 :           Int_t lab0=track0-&gt;GetLabel();</span>
<span class="lineNum">    6946 </span><span class="lineNoCov">          0 :           Int_t lab1=track1-&gt;GetLabel();</span>
<span class="lineNum">    6947 </span><span class="lineNoCov">          0 :           TTreeSRedirector &amp;cstream = *fDebugStreamer;</span>
<span class="lineNum">    6948 </span><span class="lineNoCov">          0 :           cstream&lt;&lt;&quot;Curling&quot;&lt;&lt;</span>
<span class="lineNum">    6949 </span><span class="lineNoCov">          0 :             &quot;lab0=&quot;&lt;&lt;lab0&lt;&lt;</span>
<span class="lineNum">    6950 </span><span class="lineNoCov">          0 :             &quot;lab1=&quot;&lt;&lt;lab1&lt;&lt;   </span>
<span class="lineNum">    6951 </span><span class="lineNoCov">          0 :             &quot;Tr0.=&quot;&lt;&lt;track0&lt;&lt;</span>
<span class="lineNum">    6952 </span><span class="lineNoCov">          0 :             &quot;Tr1.=&quot;&lt;&lt;track1&lt;&lt;        </span>
<span class="lineNum">    6953 </span><span class="lineNoCov">          0 :             &quot;dca0=&quot;&lt;&lt;dca[i0]&lt;&lt;</span>
<span class="lineNum">    6954 </span><span class="lineNoCov">          0 :             &quot;dca1=&quot;&lt;&lt;dca[i1]&lt;&lt;</span>
<span class="lineNum">    6955 </span><span class="lineNoCov">          0 :             &quot;mindcar=&quot;&lt;&lt;mindcar&lt;&lt;</span>
<span class="lineNum">    6956 </span><span class="lineNoCov">          0 :             &quot;mindcaz=&quot;&lt;&lt;mindcaz&lt;&lt;</span>
<span class="lineNum">    6957 </span><span class="lineNoCov">          0 :             &quot;delta=&quot;&lt;&lt;delta&lt;&lt;</span>
<span class="lineNum">    6958 </span><span class="lineNoCov">          0 :             &quot;rmean=&quot;&lt;&lt;rmean&lt;&lt;</span>
<span class="lineNum">    6959 </span><span class="lineNoCov">          0 :             &quot;npoints=&quot;&lt;&lt;npoints&lt;&lt;                      </span>
<span class="lineNum">    6960 </span><span class="lineNoCov">          0 :             &quot;hangles0=&quot;&lt;&lt;hangles[0]&lt;&lt;</span>
<span class="lineNum">    6961 </span><span class="lineNoCov">          0 :             &quot;hangles2=&quot;&lt;&lt;hangles[2]&lt;&lt;                    </span>
<span class="lineNum">    6962 </span><span class="lineNoCov">          0 :             &quot;xyz0=&quot;&lt;&lt;xyz0[2]&lt;&lt;</span>
<span class="lineNum">    6963 </span><span class="lineNoCov">          0 :             &quot;xyzz1=&quot;&lt;&lt;xyz1[2]&lt;&lt;</span>
<span class="lineNum">    6964 </span><span class="lineNoCov">          0 :             &quot;z0=&quot;&lt;&lt;z0[i0]&lt;&lt;</span>
<span class="lineNum">    6965 </span><span class="lineNoCov">          0 :             &quot;z1=&quot;&lt;&lt;z0[i1]&lt;&lt;</span>
<span class="lineNum">    6966 </span><span class="lineNoCov">          0 :             &quot;radius=&quot;&lt;&lt;radiusbest&lt;&lt;</span>
<span class="lineNum">    6967 </span><span class="lineNoCov">          0 :             &quot;deltabest=&quot;&lt;&lt;deltabest&lt;&lt; </span>
<span class="lineNum">    6968 </span><span class="lineNoCov">          0 :             &quot;phase0=&quot;&lt;&lt;phase[ibest][0]&lt;&lt;</span>
<span class="lineNum">    6969 </span><span class="lineNoCov">          0 :             &quot;phase1=&quot;&lt;&lt;phase[ibest][1]&lt;&lt;</span>
<span class="lineNum">    6970 </span>            :             &quot;\n&quot;;               
<span class="lineNum">    6971 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    6972 </span><span class="lineCov">         22 :       }</span>
<span class="lineNum">    6973 </span><span class="lineCov">        160 :     }</span>
<span class="lineNum">    6974 </span><span class="lineCov">         32 :   }</span>
<span class="lineNum">    6975 </span>            :   //
<span class="lineNum">    6976 </span>            :   //  Finf kinks loop
<span class="lineNum">    6977 </span>            :   // 
<span class="lineNum">    6978 </span>            :   //
<span class="lineNum">    6979 </span><span class="lineCov">        552 :   for (Int_t i =0;i&lt;nentries;i++){</span>
<span class="lineNum">    6980 </span><span class="lineCov">        268 :     if (sign[i]==0) continue;</span>
<span class="lineNum">    6981 </span><span class="lineCov">        296 :     AliTPCseed * track0 = (AliTPCseed*)array-&gt;At(i);</span>
<span class="lineNum">    6982 </span><span class="lineCov">        148 :     if (track0==0) {</span>
<span class="lineNum">    6983 </span><span class="lineNoCov">          0 :       AliInfo(&quot;seed==0&quot;);</span>
<span class="lineNum">    6984 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    6985 </span>            :     }
<span class="lineNum">    6986 </span><span class="lineCov">        148 :     ntracks++;</span>
<span class="lineNum">    6987 </span>            :     //
<span class="lineNum">    6988 </span>            :     Double_t cradius0 = 40*40;
<span class="lineNum">    6989 </span>            :     Double_t cradius1 = 270*270;
<span class="lineNum">    6990 </span>            :     Double_t cdist1=8.;
<span class="lineNum">    6991 </span>            :     Double_t cdist2=8.;
<span class="lineNum">    6992 </span>            :     Double_t cdist3=0.55; 
<span class="lineNum">    6993 </span><span class="lineCov">        296 :     AliHelix* hlxi = (AliHelix*)helixes[i];</span>
<span class="lineNum">    6994 </span><span class="lineCov">       5720 :     for (Int_t j =i+1;j&lt;nentries;j++){</span>
<span class="lineNum">    6995 </span><span class="lineCov">       2712 :       nall++;</span>
<span class="lineNum">    6996 </span><span class="lineCov">       2712 :       if (sign[j]*sign[i]&lt;1) continue;</span>
<span class="lineNum">    6997 </span><span class="lineCov">        722 :       int ncltot = nclusters[i];</span>
<span class="lineNum">    6998 </span><span class="lineCov">        722 :       ncltot += nclusters[j];</span>
<span class="lineNum">    6999 </span><span class="lineCov">       1124 :       if ( ncltot&gt;200) continue;</span>
<span class="lineNum">    7000 </span><span class="lineCov">        340 :       if ( ncltot&lt;80) continue;</span>
<span class="lineNum">    7001 </span><span class="lineCov">        386 :       if ( TMath::Abs(zm[i]-zm[j])&gt;60.) continue;</span>
<span class="lineNum">    7002 </span><span class="lineCov">        534 :       if ( TMath::Abs(fim[i]-fim[j])&gt;0.6 &amp;&amp; TMath::Abs(fim[i]-fim[j])&lt;5.7 ) continue;</span>
<span class="lineNum">    7003 </span>            :       //AliTPCseed * track1 = (AliTPCseed*)array-&gt;At(j);  Double_t phase[2][2],radius[2];    
<span class="lineNum">    7004 </span><span class="lineCov">        108 :       AliHelix* hlxj = (AliHelix*)helixes[j];</span>
<span class="lineNum">    7005 </span><span class="lineCov">         54 :       Int_t npoints = hlxi-&gt;GetRPHIintersections(*hlxj, phase, radius,20);</span>
<span class="lineNum">    7006 </span><span class="lineCov">         54 :       if (npoints&lt;1) continue;</span>
<span class="lineNum">    7007 </span>            :       // cuts on radius      
<span class="lineNum">    7008 </span><span class="lineCov">        108 :       if (npoints==1){</span>
<span class="lineNum">    7009 </span><span class="lineCov">        114 :         if (radius[0]&lt;cradius0||radius[0]&gt;cradius1) continue;</span>
<span class="lineNum">    7010 </span>            :       }
<span class="lineNum">    7011 </span>            :       else{
<span class="lineNum">    7012 </span><span class="lineCov">         70 :         if ( (radius[0]&lt;cradius0||radius[0]&gt;cradius1) &amp;&amp; (radius[1]&lt;cradius0||radius[1]&gt;cradius1) ) continue;</span>
<span class="lineNum">    7013 </span>            :       }
<span class="lineNum">    7014 </span>            :       //      
<span class="lineNum">    7015 </span><span class="lineCov">         20 :       Double_t delta1=10000,delta2=10000;</span>
<span class="lineNum">    7016 </span>            :       // cuts on the intersection radius
<span class="lineNum">    7017 </span><span class="lineCov">         20 :       hlxi-&gt;LinearDCA(*hlxj,phase[0][0],phase[0][1],radius[0],delta1);</span>
<span class="lineNum">    7018 </span><span class="lineCov">         20 :       if (radius[0]&lt;20&amp;&amp;delta1&lt;1) continue; //intersection at vertex</span>
<span class="lineNum">    7019 </span><span class="lineCov">         20 :       if (radius[0]&lt;10&amp;&amp;delta1&lt;3) continue; //intersection at vertex</span>
<span class="lineNum">    7020 </span><span class="lineCov">         20 :       if (npoints==2){ </span>
<span class="lineNum">    7021 </span><span class="lineCov">         16 :         hlxi-&gt;LinearDCA(*hlxj,phase[1][0],phase[1][1],radius[1],delta2);</span>
<span class="lineNum">    7022 </span><span class="lineCov">         16 :         if (radius[1]&lt;20&amp;&amp;delta2&lt;1) continue;  //intersection at vertex</span>
<span class="lineNum">    7023 </span><span class="lineCov">         16 :         if (radius[1]&lt;10&amp;&amp;delta2&lt;3) continue;  //intersection at vertex   </span>
<span class="lineNum">    7024 </span>            :       }
<span class="lineNum">    7025 </span>            :       //
<span class="lineNum">    7026 </span><span class="lineCov">         20 :       Double_t distance1 = TMath::Min(delta1,delta2);</span>
<span class="lineNum">    7027 </span><span class="lineCov">         30 :       if (distance1&gt;cdist1) continue;  // cut on DCA linear approximation</span>
<span class="lineNum">    7028 </span>            :       //
<span class="lineNum">    7029 </span><span class="lineCov">         10 :       npoints = hlxi-&gt;GetRPHIintersections(*hlxj, phase, radius,20);</span>
<span class="lineNum">    7030 </span><span class="lineCov">         10 :       hlxi-&gt;ParabolicDCA(*hlxj,phase[0][0],phase[0][1],radius[0],delta1);</span>
<span class="lineNum">    7031 </span><span class="lineCov">         10 :       if (radius[0]&lt;20&amp;&amp;delta1&lt;1) continue; //intersection at vertex</span>
<span class="lineNum">    7032 </span><span class="lineCov">         10 :       if (radius[0]&lt;10&amp;&amp;delta1&lt;3) continue; //intersection at vertex</span>
<span class="lineNum">    7033 </span>            :       //
<span class="lineNum">    7034 </span><span class="lineCov">         10 :       if (npoints==2){ </span>
<span class="lineNum">    7035 </span><span class="lineCov">          8 :         hlxi-&gt;ParabolicDCA(*hlxj,phase[1][0],phase[1][1],radius[1],delta2);  </span>
<span class="lineNum">    7036 </span><span class="lineCov">          8 :         if (radius[1]&lt;20&amp;&amp;delta2&lt;1) continue;  //intersection at vertex</span>
<span class="lineNum">    7037 </span><span class="lineCov">          8 :         if (radius[1]&lt;10&amp;&amp;delta2&lt;3) continue;  //intersection at vertex   </span>
<span class="lineNum">    7038 </span>            :       }            
<span class="lineNum">    7039 </span><span class="lineCov">         10 :       distance1 = TMath::Min(delta1,delta2);</span>
<span class="lineNum">    7040 </span>            :       Float_t rkink =0;
<span class="lineNum">    7041 </span><span class="lineCov">         10 :       if (delta1&lt;delta2){</span>
<span class="lineNum">    7042 </span><span class="lineCov">          8 :         rkink = TMath::Sqrt(radius[0]);</span>
<span class="lineNum">    7043 </span><span class="lineCov">          8 :       }</span>
<span class="lineNum">    7044 </span>            :       else{
<span class="lineNum">    7045 </span><span class="lineCov">          2 :         rkink = TMath::Sqrt(radius[1]);</span>
<span class="lineNum">    7046 </span>            :       }
<span class="lineNum">    7047 </span><span class="lineCov">         10 :       if (distance1&gt;cdist2) continue;</span>
<span class="lineNum">    7048 </span>            :       //
<span class="lineNum">    7049 </span>            :       //
<span class="lineNum">    7050 </span><span class="lineCov">         20 :       AliTPCseed * track1 = (AliTPCseed*)array-&gt;At(j);</span>
<span class="lineNum">    7051 </span>            :       //
<span class="lineNum">    7052 </span>            :       //
<span class="lineNum">    7053 </span><span class="lineCov">         10 :       Int_t row0 = GetRowNumber(rkink); </span>
<span class="lineNum">    7054 </span><span class="lineCov">         12 :       if (row0&lt;10)  continue;</span>
<span class="lineNum">    7055 </span><span class="lineCov">          8 :       if (row0&gt;150) continue;</span>
<span class="lineNum">    7056 </span>            :       //
<span class="lineNum">    7057 </span>            :       //
<span class="lineNum">    7058 </span>            :       Float_t dens00=-1,dens01=-1;
<span class="lineNum">    7059 </span>            :       Float_t dens10=-1,dens11=-1;
<span class="lineNum">    7060 </span>            :       //
<span class="lineNum">    7061 </span><span class="lineCov">          8 :       Int_t found,foundable;//,ishared;</span>
<span class="lineNum">    7062 </span>            :       //RS Seed don't keep their cluster pointers, cache cluster usage stat. for fast evaluation
<span class="lineNum">    7063 </span>            :       // FillSeedClusterStatCache(track0); // RS: Use this slow method only if sharing stat. is needed and used
<span class="lineNum">    7064 </span>            :       //
<span class="lineNum">    7065 </span>            :       //GetCachedSeedClusterStatistic(0,row0-5, found, foundable,ishared,kFALSE); // RS make sure FillSeedClusterStatCache is called
<span class="lineNum">    7066 </span>            :       //RS track0-&gt;GetClusterStatistic(0,row0-5, found, foundable,ishared,kFALSE);
<span class="lineNum">    7067 </span><span class="lineCov">          8 :       track0-&gt;GetClusterStatistic(0,row0-5, found, foundable);</span>
<span class="lineNum">    7068 </span><span class="lineCov">         16 :       if (foundable&gt;5) dens00 = Float_t(found)/Float_t(foundable);</span>
<span class="lineNum">    7069 </span>            :       //
<span class="lineNum">    7070 </span>            :       //GetCachedSeedClusterStatistic(row0+5,155, found, foundable,ishared,kFALSE); // RS make sure FillSeedClusterStatCache is called
<span class="lineNum">    7071 </span>            :       //RS track0-&gt;GetClusterStatistic(row0+5,155, found, foundable,ishared,kFALSE);
<span class="lineNum">    7072 </span><span class="lineCov">          8 :       track0-&gt;GetClusterStatistic(row0+5,155, found, foundable);</span>
<span class="lineNum">    7073 </span><span class="lineCov">         16 :       if (foundable&gt;5) dens01 = Float_t(found)/Float_t(foundable);</span>
<span class="lineNum">    7074 </span>            :       //
<span class="lineNum">    7075 </span>            :       //
<span class="lineNum">    7076 </span>            :       //RS Seed don't keep their cluster pointers, cache cluster usage stat. for fast evaluation
<span class="lineNum">    7077 </span>            :       // FillSeedClusterStatCache(track1); // RS: Use this slow method only if sharing stat. is needed and used
<span class="lineNum">    7078 </span>            :       //
<span class="lineNum">    7079 </span>            :       //GetCachedSeedClusterStatistic(0,row0-5, found, foundable,ishared,kFALSE); // RS make sure FillSeedClusterStatCache is called
<span class="lineNum">    7080 </span>            :       //RS track1-&gt;GetClusterStatistic(0,row0-5, found, foundable,ishared,kFALSE);
<span class="lineNum">    7081 </span><span class="lineCov">          8 :       track1-&gt;GetClusterStatistic(0,row0-5, found, foundable);</span>
<span class="lineNum">    7082 </span><span class="lineCov">         16 :       if (foundable&gt;10) dens10 = Float_t(found)/Float_t(foundable);</span>
<span class="lineNum">    7083 </span>            :       //
<span class="lineNum">    7084 </span>            :       //GetCachedSeedClusterStatistic(row0+5,155, found, foundable,ishared,kFALSE); // RS make sure FillSeedClusterStatCache is called
<span class="lineNum">    7085 </span>            :       //RS track1-&gt;GetClusterStatistic(row0+5,155, found, foundable,ishared,kFALSE);
<span class="lineNum">    7086 </span><span class="lineCov">          8 :       track1-&gt;GetClusterStatistic(row0+5,155, found, foundable);</span>
<span class="lineNum">    7087 </span><span class="lineCov">         16 :       if (foundable&gt;10) dens11 = Float_t(found)/Float_t(foundable);</span>
<span class="lineNum">    7088 </span>            :       //
<span class="lineNum">    7089 </span><span class="lineCov">          8 :       if (dens00&lt;dens10 &amp;&amp; dens01&lt;dens11) continue;</span>
<span class="lineNum">    7090 </span><span class="lineCov">         18 :       if (dens00&gt;dens10 &amp;&amp; dens01&gt;dens11) continue;</span>
<span class="lineNum">    7091 </span><span class="lineCov">          6 :       if (TMath::Max(dens00,dens10)&lt;0.1)  continue;</span>
<span class="lineNum">    7092 </span><span class="lineCov">          6 :       if (TMath::Max(dens01,dens11)&lt;0.3)  continue;</span>
<span class="lineNum">    7093 </span>            :       //
<span class="lineNum">    7094 </span><span class="lineCov">          6 :       if (TMath::Min(dens00,dens10)&gt;0.6)  continue;</span>
<span class="lineNum">    7095 </span><span class="lineCov">          8 :       if (TMath::Min(dens01,dens11)&gt;0.6)  continue;</span>
<span class="lineNum">    7096 </span>            : 
<span class="lineNum">    7097 </span>            :       //
<span class="lineNum">    7098 </span>            :       AliTPCseed * ktrack0, *ktrack1;
<span class="lineNum">    7099 </span><span class="lineCov">          4 :       if (dens00&gt;dens10){</span>
<span class="lineNum">    7100 </span>            :         ktrack0 = track0;
<span class="lineNum">    7101 </span>            :         ktrack1 = track1;
<span class="lineNum">    7102 </span><span class="lineCov">          4 :       }</span>
<span class="lineNum">    7103 </span>            :       else{
<span class="lineNum">    7104 </span>            :         ktrack0 = track1;
<span class="lineNum">    7105 </span>            :         ktrack1 = track0;
<span class="lineNum">    7106 </span>            :       }
<span class="lineNum">    7107 </span><span class="lineCov">          8 :       if (TMath::Abs(ktrack0-&gt;GetC())&gt;5) continue; // cut on the curvature for mother particle</span>
<span class="lineNum">    7108 </span><span class="lineCov">          4 :       AliExternalTrackParam paramm(*ktrack0);</span>
<span class="lineNum">    7109 </span><span class="lineCov">          4 :       AliExternalTrackParam paramd(*ktrack1);</span>
<span class="lineNum">    7110 </span><span class="lineCov">         20 :       if (row0&gt;60&amp;&amp;ktrack1-&gt;GetReference().GetX()&gt;90.)new (&amp;paramd) AliExternalTrackParam(ktrack1-&gt;GetReference()); </span>
<span class="lineNum">    7111 </span>            :       //
<span class="lineNum">    7112 </span>            :       //
<span class="lineNum">    7113 </span><span class="lineCov">          4 :       kink-&gt;SetMother(paramm);</span>
<span class="lineNum">    7114 </span><span class="lineCov">          4 :       kink-&gt;SetDaughter(paramd);</span>
<span class="lineNum">    7115 </span><span class="lineCov">          4 :       kink-&gt;Update();</span>
<span class="lineNum">    7116 </span>            : 
<span class="lineNum">    7117 </span><span class="lineCov">          4 :       Float_t x[3] = { static_cast&lt;Float_t&gt;(kink-&gt;GetPosition()[0]),static_cast&lt;Float_t&gt;(kink-&gt;GetPosition()[1]),static_cast&lt;Float_t&gt;(kink-&gt;GetPosition()[2])};</span>
<span class="lineNum">    7118 </span><span class="lineCov">          4 :       Int_t index[4];</span>
<span class="lineNum">    7119 </span><span class="lineCov">          4 :       fkParam-&gt;Transform0to1(x,index);</span>
<span class="lineNum">    7120 </span><span class="lineCov">          4 :       fkParam-&gt;Transform1to2(x,index);</span>
<span class="lineNum">    7121 </span><span class="lineCov">          4 :       row0 = GetRowNumber(x[0]); </span>
<span class="lineNum">    7122 </span>            : 
<span class="lineNum">    7123 </span><span class="lineCov">          4 :       if (kink-&gt;GetR()&lt;100) continue;</span>
<span class="lineNum">    7124 </span><span class="lineCov">          4 :       if (kink-&gt;GetR()&gt;240) continue;</span>
<span class="lineNum">    7125 </span><span class="lineCov">          8 :       if (kink-&gt;GetPosition()[2]/kink-&gt;GetR()&gt;AliTPCReconstructor::GetCtgRange()) continue;  //out of fiducial volume</span>
<span class="lineNum">    7126 </span><span class="lineCov">          4 :       if (kink-&gt;GetDistance()&gt;cdist3) continue;</span>
<span class="lineNum">    7127 </span><span class="lineCov">          4 :       Float_t dird = kink-&gt;GetDaughterP()[0]*kink-&gt;GetPosition()[0]+kink-&gt;GetDaughterP()[1]*kink-&gt;GetPosition()[1];  // rough direction estimate</span>
<span class="lineNum">    7128 </span><span class="lineCov">          4 :       if (dird&lt;0) continue;</span>
<span class="lineNum">    7129 </span>            : 
<span class="lineNum">    7130 </span><span class="lineCov">          4 :       Float_t dirm = kink-&gt;GetMotherP()[0]*kink-&gt;GetPosition()[0]+kink-&gt;GetMotherP()[1]*kink-&gt;GetPosition()[1];  // rough direction estimate</span>
<span class="lineNum">    7131 </span><span class="lineCov">          4 :       if (dirm&lt;0) continue;</span>
<span class="lineNum">    7132 </span><span class="lineCov">          4 :       Float_t mpt = TMath::Sqrt(kink-&gt;GetMotherP()[0]*kink-&gt;GetMotherP()[0]+kink-&gt;GetMotherP()[1]*kink-&gt;GetMotherP()[1]);</span>
<span class="lineNum">    7133 </span><span class="lineCov">          4 :       if (mpt&lt;0.2) continue;</span>
<span class="lineNum">    7134 </span>            : 
<span class="lineNum">    7135 </span><span class="lineCov">          4 :       if (mpt&lt;1){</span>
<span class="lineNum">    7136 </span>            :         //for high momenta momentum not defined well in first iteration
<span class="lineNum">    7137 </span><span class="lineCov">          8 :         Double_t qt   =  TMath::Sin(kink-&gt;GetAngle(2))*ktrack1-&gt;GetP();</span>
<span class="lineNum">    7138 </span><span class="lineCov">          4 :         if (qt&gt;0.35) continue; </span>
<span class="lineNum">    7139 </span><span class="lineCov">          4 :       }</span>
<span class="lineNum">    7140 </span>            :       
<span class="lineNum">    7141 </span><span class="lineCov">          8 :       kink-&gt;SetLabel(CookLabel(ktrack0,0.4,0,row0),0);</span>
<span class="lineNum">    7142 </span><span class="lineCov">          8 :       kink-&gt;SetLabel(CookLabel(ktrack1,0.4,row0,kMaxRow),1);</span>
<span class="lineNum">    7143 </span><span class="lineCov">          4 :       if (dens00&gt;dens10){</span>
<span class="lineNum">    7144 </span><span class="lineCov">          4 :         kink-&gt;SetTPCDensity(dens00,0,0);</span>
<span class="lineNum">    7145 </span><span class="lineCov">          4 :         kink-&gt;SetTPCDensity(dens01,0,1);</span>
<span class="lineNum">    7146 </span><span class="lineCov">          4 :         kink-&gt;SetTPCDensity(dens10,1,0);</span>
<span class="lineNum">    7147 </span><span class="lineCov">          4 :         kink-&gt;SetTPCDensity(dens11,1,1);</span>
<span class="lineNum">    7148 </span><span class="lineCov">          4 :         kink-&gt;SetIndex(i,0);</span>
<span class="lineNum">    7149 </span><span class="lineCov">          4 :         kink-&gt;SetIndex(j,1);</span>
<span class="lineNum">    7150 </span><span class="lineCov">          4 :       }</span>
<span class="lineNum">    7151 </span>            :       else{
<span class="lineNum">    7152 </span><span class="lineNoCov">          0 :         kink-&gt;SetTPCDensity(dens10,0,0);</span>
<span class="lineNum">    7153 </span><span class="lineNoCov">          0 :         kink-&gt;SetTPCDensity(dens11,0,1);</span>
<span class="lineNum">    7154 </span><span class="lineNoCov">          0 :         kink-&gt;SetTPCDensity(dens00,1,0);</span>
<span class="lineNum">    7155 </span><span class="lineNoCov">          0 :         kink-&gt;SetTPCDensity(dens01,1,1);</span>
<span class="lineNum">    7156 </span><span class="lineNoCov">          0 :         kink-&gt;SetIndex(j,0);</span>
<span class="lineNum">    7157 </span><span class="lineNoCov">          0 :         kink-&gt;SetIndex(i,1);</span>
<span class="lineNum">    7158 </span>            :       }
<span class="lineNum">    7159 </span>            : 
<span class="lineNum">    7160 </span><span class="lineCov">          4 :       if (mpt&lt;1||kink-&gt;GetAngle(2)&gt;0.1){</span>
<span class="lineNum">    7161 </span>            :         //      angle and densities  not defined yet
<span class="lineNum">    7162 </span><span class="lineCov">          8 :         if (kink-&gt;GetTPCDensityFactor()&lt;0.8) continue;</span>
<span class="lineNum">    7163 </span><span class="lineCov">          8 :         if ((2-kink-&gt;GetTPCDensityFactor())*kink-&gt;GetDistance() &gt;0.25) continue;</span>
<span class="lineNum">    7164 </span><span class="lineCov">          8 :         if (kink-&gt;GetAngle(2)*ktrack0-&gt;GetP()&lt;0.003) continue; //too small angle</span>
<span class="lineNum">    7165 </span><span class="lineCov">          4 :         if (kink-&gt;GetAngle(2)&gt;0.2&amp;&amp;kink-&gt;GetTPCDensityFactor()&lt;1.15) continue;</span>
<span class="lineNum">    7166 </span><span class="lineCov">          4 :         if (kink-&gt;GetAngle(2)&gt;0.2&amp;&amp;kink-&gt;GetTPCDensity(0,1)&gt;0.05) continue;</span>
<span class="lineNum">    7167 </span>            : 
<span class="lineNum">    7168 </span><span class="lineCov">          8 :         Float_t criticalangle = track0-&gt;GetSigmaSnp2()+track0-&gt;GetSigmaTgl2();</span>
<span class="lineNum">    7169 </span><span class="lineCov">          8 :         criticalangle+= track1-&gt;GetSigmaSnp2()+track1-&gt;GetSigmaTgl2();</span>
<span class="lineNum">    7170 </span><span class="lineCov">          4 :         criticalangle= 3*TMath::Sqrt(criticalangle);</span>
<span class="lineNum">    7171 </span><span class="lineCov">          6 :         if (criticalangle&gt;0.02) criticalangle=0.02;</span>
<span class="lineNum">    7172 </span><span class="lineCov">          8 :         if (kink-&gt;GetAngle(2)&lt;criticalangle) continue;</span>
<span class="lineNum">    7173 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    7174 </span>            :       //
<span class="lineNum">    7175 </span><span class="lineNoCov">          0 :       Int_t drow = Int_t(2.+0.5/(0.05+kink-&gt;GetAngle(2)));  // overlap region defined</span>
<span class="lineNum">    7176 </span>            :       Float_t shapesum =0;
<span class="lineNum">    7177 </span>            :       Float_t sum = 0;
<span class="lineNum">    7178 </span><span class="lineNoCov">          0 :       for ( Int_t row = row0-drow; row&lt;row0+drow;row++){</span>
<span class="lineNum">    7179 </span><span class="lineNoCov">          0 :         if (row&lt;0) continue;</span>
<span class="lineNum">    7180 </span><span class="lineNoCov">          0 :         if (row&gt;155) continue;</span>
<span class="lineNum">    7181 </span>            :         //RS if (ktrack0-&gt;GetClusterPointer(row)) {
<span class="lineNum">    7182 </span><span class="lineNoCov">          0 :         if (ktrack0-&gt;GetClusterIndex2(row)&gt;=0) {</span>
<span class="lineNum">    7183 </span><span class="lineNoCov">          0 :           const AliTPCTrackerPoints::Point *point = ktrack0-&gt;GetTrackPoint(row);</span>
<span class="lineNum">    7184 </span><span class="lineNoCov">          0 :           shapesum+=point-&gt;GetSigmaY()+point-&gt;GetSigmaZ();</span>
<span class="lineNum">    7185 </span><span class="lineNoCov">          0 :           sum++;</span>
<span class="lineNum">    7186 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    7187 </span>            :         //RS if (ktrack1-&gt;GetClusterPointer(row)){
<span class="lineNum">    7188 </span><span class="lineNoCov">          0 :         if (ktrack1-&gt;GetClusterIndex2(row)&gt;=0) {</span>
<span class="lineNum">    7189 </span><span class="lineNoCov">          0 :           const AliTPCTrackerPoints::Point *point =ktrack1-&gt;GetTrackPoint(row);</span>
<span class="lineNum">    7190 </span><span class="lineNoCov">          0 :           shapesum+=point-&gt;GetSigmaY()+point-&gt;GetSigmaZ();</span>
<span class="lineNum">    7191 </span><span class="lineNoCov">          0 :           sum++;</span>
<span class="lineNum">    7192 </span><span class="lineNoCov">          0 :         }       </span>
<span class="lineNum">    7193 </span>            :       }
<span class="lineNum">    7194 </span><span class="lineNoCov">          0 :       if (sum&lt;4){</span>
<span class="lineNum">    7195 </span><span class="lineNoCov">          0 :         kink-&gt;SetShapeFactor(-1.);</span>
<span class="lineNum">    7196 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    7197 </span>            :       else{
<span class="lineNum">    7198 </span><span class="lineNoCov">          0 :         kink-&gt;SetShapeFactor(shapesum/sum);</span>
<span class="lineNum">    7199 </span>            :       }      
<span class="lineNum">    7200 </span>            :       //      esd-&gt;AddKink(kink);
<span class="lineNum">    7201 </span>            :       //
<span class="lineNum">    7202 </span>            :       //      kink-&gt;SetMother(paramm);
<span class="lineNum">    7203 </span>            :       //kink-&gt;SetDaughter(paramd);
<span class="lineNum">    7204 </span>            :       
<span class="lineNum">    7205 </span><span class="lineNoCov">          0 :       Double_t chi2P2 = paramm.GetParameter()[2]-paramd.GetParameter()[2];</span>
<span class="lineNum">    7206 </span><span class="lineNoCov">          0 :       chi2P2*=chi2P2;</span>
<span class="lineNum">    7207 </span><span class="lineNoCov">          0 :       chi2P2/=paramm.GetCovariance()[5]+paramd.GetCovariance()[5];</span>
<span class="lineNum">    7208 </span><span class="lineNoCov">          0 :       Double_t chi2P3 = paramm.GetParameter()[3]-paramd.GetParameter()[3];</span>
<span class="lineNum">    7209 </span><span class="lineNoCov">          0 :       chi2P3*=chi2P3;</span>
<span class="lineNum">    7210 </span><span class="lineNoCov">          0 :       chi2P3/=paramm.GetCovariance()[9]+paramd.GetCovariance()[9];</span>
<span class="lineNum">    7211 </span>            :       //
<span class="lineNum">    7212 </span><span class="lineNoCov">          0 :       if ((AliTPCReconstructor::StreamLevel()&amp;kStreamFindKinks)&gt;0) {   // flag: stream track infroamtion in the FindKinks method</span>
<span class="lineNum">    7213 </span><span class="lineNoCov">          0 :         (*fDebugStreamer)&lt;&lt;&quot;kinkLpt&quot;&lt;&lt;</span>
<span class="lineNum">    7214 </span><span class="lineNoCov">          0 :           &quot;chi2P2=&quot;&lt;&lt;chi2P2&lt;&lt;</span>
<span class="lineNum">    7215 </span><span class="lineNoCov">          0 :           &quot;chi2P3=&quot;&lt;&lt;chi2P3&lt;&lt;</span>
<span class="lineNum">    7216 </span><span class="lineNoCov">          0 :           &quot;p0.=&quot;&lt;&lt;&amp;paramm&lt;&lt;</span>
<span class="lineNum">    7217 </span><span class="lineNoCov">          0 :           &quot;p1.=&quot;&lt;&lt;&amp;paramd&lt;&lt;</span>
<span class="lineNum">    7218 </span><span class="lineNoCov">          0 :           &quot;k.=&quot;&lt;&lt;kink&lt;&lt;</span>
<span class="lineNum">    7219 </span>            :           &quot;\n&quot;;
<span class="lineNum">    7220 </span>            :       }
<span class="lineNum">    7221 </span><span class="lineNoCov">          0 :       if ( chi2P2+chi2P3&lt;AliTPCReconstructor::GetRecoParam()-&gt;GetKinkAngleCutChi2(0)){</span>
<span class="lineNum">    7222 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    7223 </span>            :       }
<span class="lineNum">    7224 </span>            :       //
<span class="lineNum">    7225 </span><span class="lineNoCov">          0 :       kinks.AddLast(kink);</span>
<span class="lineNum">    7226 </span><span class="lineNoCov">          0 :       kink = new AliKink;</span>
<span class="lineNum">    7227 </span><span class="lineNoCov">          0 :       ncandidates++;</span>
<span class="lineNum">    7228 </span><span class="lineCov">         32 :     }</span>
<span class="lineNum">    7229 </span><span class="lineCov">        148 :   }</span>
<span class="lineNum">    7230 </span>            :   //
<span class="lineNum">    7231 </span>            :   // sort the kinks according quality - and refit them towards vertex
<span class="lineNum">    7232 </span>            :   //
<span class="lineNum">    7233 </span><span class="lineCov">          8 :   Int_t       nkinks    = kinks.GetEntriesFast();</span>
<span class="lineNum">    7234 </span><span class="lineCov">          8 :   Float_t    quality[nkinks];</span>
<span class="lineNum">    7235 </span><span class="lineCov">          8 :   Int_t      indexes[nkinks];</span>
<span class="lineNum">    7236 </span><span class="lineCov">          8 :   AliTPCseed *mothers[nkinks];</span>
<span class="lineNum">    7237 </span><span class="lineCov">          8 :   AliTPCseed *daughters[nkinks];</span>
<span class="lineNum">    7238 </span><span class="lineCov">          8 :   memset(mothers,0,nkinks*sizeof(AliTPCseed*));</span>
<span class="lineNum">    7239 </span><span class="lineCov">          8 :   memset(daughters,0,nkinks*sizeof(AliTPCseed*));</span>
<span class="lineNum">    7240 </span>            :   //
<span class="lineNum">    7241 </span>            :   //
<span class="lineNum">    7242 </span><span class="lineCov">         16 :   for (Int_t i=0;i&lt;nkinks;i++){</span>
<span class="lineNum">    7243 </span><span class="lineNoCov">          0 :     quality[i] =100000;</span>
<span class="lineNum">    7244 </span><span class="lineNoCov">          0 :     AliKink *kinkl = (AliKink*)kinks.At(i);</span>
<span class="lineNum">    7245 </span>            :     //
<span class="lineNum">    7246 </span>            :     // refit kinks towards vertex
<span class="lineNum">    7247 </span>            :     // 
<span class="lineNum">    7248 </span><span class="lineNoCov">          0 :     Int_t index0 = kinkl-&gt;GetIndex(0);</span>
<span class="lineNum">    7249 </span><span class="lineNoCov">          0 :     Int_t index1 = kinkl-&gt;GetIndex(1);</span>
<span class="lineNum">    7250 </span><span class="lineNoCov">          0 :     AliTPCseed * ktrack0 = (AliTPCseed*)array-&gt;At(index0);</span>
<span class="lineNum">    7251 </span><span class="lineNoCov">          0 :     AliTPCseed * ktrack1 = (AliTPCseed*)array-&gt;At(index1);</span>
<span class="lineNum">    7252 </span>            :     //
<span class="lineNum">    7253 </span><span class="lineNoCov">          0 :     Int_t sumn=ktrack0-&gt;GetNumberOfClusters()+ktrack1-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    7254 </span>            :     //
<span class="lineNum">    7255 </span>            :     // Refit Kink under if too small angle
<span class="lineNum">    7256 </span>            :     //
<span class="lineNum">    7257 </span><span class="lineNoCov">          0 :     if (kinkl-&gt;GetAngle(2)&lt;0.05){</span>
<span class="lineNum">    7258 </span>            :       //
<span class="lineNum">    7259 </span>            :       // RS: if possible, remove kink before reseeding
<span class="lineNum">    7260 </span><span class="lineNoCov">          0 :       if (kinkl-&gt;GetDistance()&gt;0.5 || kinkl-&gt;GetR()&lt;110 || kinkl-&gt;GetR()&gt;240) {</span>
<span class="lineNum">    7261 </span><span class="lineNoCov">          0 :         delete kinks.RemoveAt(i);</span>
<span class="lineNum">    7262 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    7263 </span>            :       }
<span class="lineNum">    7264 </span>            :       //
<span class="lineNum">    7265 </span><span class="lineNoCov">          0 :       kinkl-&gt;SetTPCRow0(GetRowNumber(kinkl-&gt;GetR()));</span>
<span class="lineNum">    7266 </span><span class="lineNoCov">          0 :       Int_t row0 = kinkl-&gt;GetTPCRow0();</span>
<span class="lineNum">    7267 </span><span class="lineNoCov">          0 :       Int_t drow = Int_t(2.+0.5/(0.05+kinkl-&gt;GetAngle(2)));</span>
<span class="lineNum">    7268 </span>            :       //
<span class="lineNum">    7269 </span><span class="lineNoCov">          0 :       Int_t last  = row0-drow;</span>
<span class="lineNum">    7270 </span><span class="lineNoCov">          0 :       if (last&lt;40) last=40;</span>
<span class="lineNum">    7271 </span><span class="lineNoCov">          0 :       if (last&lt;ktrack0-&gt;GetFirstPoint()+25) last = ktrack0-&gt;GetFirstPoint()+25;</span>
<span class="lineNum">    7272 </span><span class="lineNoCov">          0 :       AliTPCseed* seed0 = ReSeed(ktrack0,last,kFALSE);</span>
<span class="lineNum">    7273 </span>            :       //
<span class="lineNum">    7274 </span><span class="lineNoCov">          0 :       Int_t first = row0+drow;</span>
<span class="lineNum">    7275 </span><span class="lineNoCov">          0 :       if (first&gt;130) first=130;</span>
<span class="lineNum">    7276 </span><span class="lineNoCov">          0 :       if (first&gt;ktrack1-&gt;GetLastPoint()-25) first = TMath::Max(ktrack1-&gt;GetLastPoint()-25,30);</span>
<span class="lineNum">    7277 </span><span class="lineNoCov">          0 :       AliTPCseed* seed1 = ReSeed(ktrack1,first,kTRUE);</span>
<span class="lineNum">    7278 </span>            :       //
<span class="lineNum">    7279 </span><span class="lineNoCov">          0 :       if (seed0 &amp;&amp; seed1) {</span>
<span class="lineNum">    7280 </span><span class="lineNoCov">          0 :         kinkl-&gt;SetStatus(1,8);</span>
<span class="lineNum">    7281 </span><span class="lineNoCov">          0 :         if (RefitKink(*seed0,*seed1,*kinkl)) kinkl-&gt;SetStatus(1,9);</span>
<span class="lineNum">    7282 </span><span class="lineNoCov">          0 :         row0 = GetRowNumber(kinkl-&gt;GetR());</span>
<span class="lineNum">    7283 </span><span class="lineNoCov">          0 :         sumn = seed0-&gt;GetNumberOfClusters()+seed1-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    7284 </span><span class="lineNoCov">          0 :         mothers[i]   = seed0;</span>
<span class="lineNum">    7285 </span><span class="lineNoCov">          0 :         daughters[i] = seed1;</span>
<span class="lineNum">    7286 </span>            :       }
<span class="lineNum">    7287 </span>            :       else {
<span class="lineNum">    7288 </span><span class="lineNoCov">          0 :         delete kinks.RemoveAt(i);</span>
<span class="lineNum">    7289 </span><span class="lineNoCov">          0 :         if (seed0) MarkSeedFree( seed0 );</span>
<span class="lineNum">    7290 </span><span class="lineNoCov">          0 :         if (seed1) MarkSeedFree( seed1 );</span>
<span class="lineNum">    7291 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    7292 </span>            :       }
<span class="lineNum">    7293 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    7294 </span>            :     //
<span class="lineNum">    7295 </span><span class="lineNoCov">          0 :     if (kinkl) quality[i] = 160*((0.1+kinkl-&gt;GetDistance())*(2.-kinkl-&gt;GetTPCDensityFactor()))/(sumn+40.);  //the longest -clossest will win</span>
<span class="lineNum">    7296 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    7297 </span><span class="lineCov">          8 :   TMath::Sort(nkinks,quality,indexes,kFALSE);</span>
<span class="lineNum">    7298 </span>            :   //
<span class="lineNum">    7299 </span>            :   //remove double find kinks
<span class="lineNum">    7300 </span>            :   //
<span class="lineNum">    7301 </span><span class="lineCov">         16 :   for (Int_t ikink0=1;ikink0&lt;nkinks;ikink0++){</span>
<span class="lineNum">    7302 </span><span class="lineNoCov">          0 :     AliKink * kink0 = (AliKink*) kinks.At(indexes[ikink0]);</span>
<span class="lineNum">    7303 </span><span class="lineNoCov">          0 :     if (!kink0) continue;</span>
<span class="lineNum">    7304 </span>            :     //
<span class="lineNum">    7305 </span><span class="lineNoCov">          0 :     for (Int_t ikink1=0;ikink1&lt;ikink0;ikink1++){ </span>
<span class="lineNum">    7306 </span><span class="lineNoCov">          0 :       kink0 = (AliKink*) kinks.At(indexes[ikink0]);</span>
<span class="lineNum">    7307 </span><span class="lineNoCov">          0 :       if (!kink0) continue;</span>
<span class="lineNum">    7308 </span><span class="lineNoCov">          0 :       AliKink * kink1 = (AliKink*) kinks.At(indexes[ikink1]);</span>
<span class="lineNum">    7309 </span><span class="lineNoCov">          0 :       if (!kink1) continue;</span>
<span class="lineNum">    7310 </span>            :       // if not close kink continue
<span class="lineNum">    7311 </span><span class="lineNoCov">          0 :       if (TMath::Abs(kink1-&gt;GetPosition()[2]-kink0-&gt;GetPosition()[2])&gt;10) continue;</span>
<span class="lineNum">    7312 </span><span class="lineNoCov">          0 :       if (TMath::Abs(kink1-&gt;GetPosition()[1]-kink0-&gt;GetPosition()[1])&gt;10) continue;</span>
<span class="lineNum">    7313 </span><span class="lineNoCov">          0 :       if (TMath::Abs(kink1-&gt;GetPosition()[0]-kink0-&gt;GetPosition()[0])&gt;10) continue;</span>
<span class="lineNum">    7314 </span>            :       //
<span class="lineNum">    7315 </span><span class="lineNoCov">          0 :       AliTPCseed &amp;mother0   =  mothers[indexes[ikink0]]   ? *mothers[indexes[ikink0]]   : *((AliTPCseed*)array-&gt;At(kink0-&gt;GetIndex(0)));</span>
<span class="lineNum">    7316 </span><span class="lineNoCov">          0 :       AliTPCseed &amp;daughter0 =  daughters[indexes[ikink0]] ? *daughters[indexes[ikink0]] : *((AliTPCseed*)array-&gt;At(kink0-&gt;GetIndex(1)));</span>
<span class="lineNum">    7317 </span><span class="lineNoCov">          0 :       AliTPCseed &amp;mother1   =  mothers[indexes[ikink1]]   ? *mothers[indexes[ikink1]]   : *((AliTPCseed*)array-&gt;At(kink1-&gt;GetIndex(0)));</span>
<span class="lineNum">    7318 </span><span class="lineNoCov">          0 :       AliTPCseed &amp;daughter1 =  daughters[indexes[ikink1]] ? *daughters[indexes[ikink1]] : *((AliTPCseed*)array-&gt;At(kink1-&gt;GetIndex(1)));</span>
<span class="lineNum">    7319 </span>            : 
<span class="lineNum">    7320 </span><span class="lineNoCov">          0 :       Int_t row0 = (kink0-&gt;GetTPCRow0()+kink1-&gt;GetTPCRow0())/2;</span>
<span class="lineNum">    7321 </span>            :       //
<span class="lineNum">    7322 </span>            :       Int_t same  = 0;
<span class="lineNum">    7323 </span>            :       Int_t both  = 0;
<span class="lineNum">    7324 </span>            :       Int_t samem = 0;
<span class="lineNum">    7325 </span>            :       Int_t bothm = 0;
<span class="lineNum">    7326 </span>            :       Int_t samed = 0;
<span class="lineNum">    7327 </span>            :       Int_t bothd = 0;
<span class="lineNum">    7328 </span>            :       //
<span class="lineNum">    7329 </span><span class="lineNoCov">          0 :       for (Int_t i=0;i&lt;row0;i++){</span>
<span class="lineNum">    7330 </span><span class="lineNoCov">          0 :         if (mother0.GetClusterIndex(i)&gt;0 &amp;&amp; mother1.GetClusterIndex(i)&gt;0){</span>
<span class="lineNum">    7331 </span><span class="lineNoCov">          0 :           both++;</span>
<span class="lineNum">    7332 </span><span class="lineNoCov">          0 :           bothm++;</span>
<span class="lineNum">    7333 </span><span class="lineNoCov">          0 :           if (mother0.GetClusterIndex(i)==mother1.GetClusterIndex(i)){</span>
<span class="lineNum">    7334 </span><span class="lineNoCov">          0 :             same++;</span>
<span class="lineNum">    7335 </span><span class="lineNoCov">          0 :             samem++;</span>
<span class="lineNum">    7336 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    7337 </span>            :         }
<span class="lineNum">    7338 </span>            :       }
<span class="lineNum">    7339 </span>            : 
<span class="lineNum">    7340 </span><span class="lineNoCov">          0 :       for (Int_t i=row0;i&lt;158;i++){</span>
<span class="lineNum">    7341 </span>            :         //if (daughter0.GetClusterIndex(i)&gt;0 &amp;&amp; daughter0.GetClusterIndex(i)&gt;0){ // RS: Bug? 
<span class="lineNum">    7342 </span><span class="lineNoCov">          0 :         if (daughter0.GetClusterIndex(i)&gt;0 &amp;&amp; daughter1.GetClusterIndex(i)&gt;0){</span>
<span class="lineNum">    7343 </span><span class="lineNoCov">          0 :           both++;</span>
<span class="lineNum">    7344 </span><span class="lineNoCov">          0 :           bothd++;</span>
<span class="lineNum">    7345 </span><span class="lineNoCov">          0 :           if (mother0.GetClusterIndex(i)==mother1.GetClusterIndex(i)){</span>
<span class="lineNum">    7346 </span><span class="lineNoCov">          0 :             same++;</span>
<span class="lineNum">    7347 </span><span class="lineNoCov">          0 :             samed++;</span>
<span class="lineNum">    7348 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    7349 </span>            :         }
<span class="lineNum">    7350 </span>            :       }
<span class="lineNum">    7351 </span><span class="lineNoCov">          0 :       Float_t ratio = Float_t(same+1)/Float_t(both+1);</span>
<span class="lineNum">    7352 </span><span class="lineNoCov">          0 :       Float_t ratiom = Float_t(samem+1)/Float_t(bothm+1);</span>
<span class="lineNum">    7353 </span><span class="lineNoCov">          0 :       Float_t ratiod = Float_t(samed+1)/Float_t(bothd+1);</span>
<span class="lineNum">    7354 </span><span class="lineNoCov">          0 :       if (ratio&gt;0.3 &amp;&amp; ratiom&gt;0.5 &amp;&amp;ratiod&gt;0.5) {</span>
<span class="lineNum">    7355 </span><span class="lineNoCov">          0 :         Int_t sum0 = mother0.GetNumberOfClusters()+daughter0.GetNumberOfClusters();</span>
<span class="lineNum">    7356 </span><span class="lineNoCov">          0 :         Int_t sum1 = mother1.GetNumberOfClusters()+daughter1.GetNumberOfClusters();</span>
<span class="lineNum">    7357 </span><span class="lineNoCov">          0 :         if (sum1&gt;sum0){</span>
<span class="lineNum">    7358 </span><span class="lineNoCov">          0 :           shared[kink0-&gt;GetIndex(0)]= kTRUE;</span>
<span class="lineNum">    7359 </span><span class="lineNoCov">          0 :           shared[kink0-&gt;GetIndex(1)]= kTRUE;   </span>
<span class="lineNum">    7360 </span><span class="lineNoCov">          0 :           delete kinks.RemoveAt(indexes[ikink0]);</span>
<span class="lineNum">    7361 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    7362 </span>            :         }
<span class="lineNum">    7363 </span>            :         else{
<span class="lineNum">    7364 </span><span class="lineNoCov">          0 :           shared[kink1-&gt;GetIndex(0)]= kTRUE;</span>
<span class="lineNum">    7365 </span><span class="lineNoCov">          0 :           shared[kink1-&gt;GetIndex(1)]= kTRUE;   </span>
<span class="lineNum">    7366 </span><span class="lineNoCov">          0 :           delete kinks.RemoveAt(indexes[ikink1]);</span>
<span class="lineNum">    7367 </span>            :         }
<span class="lineNum">    7368 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    7369 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    7370 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    7371 </span>            : 
<span class="lineNum">    7372 </span>            : 
<span class="lineNum">    7373 </span><span class="lineCov">         16 :   for (Int_t i=0;i&lt;nkinks;i++){</span>
<span class="lineNum">    7374 </span><span class="lineNoCov">          0 :     AliKink * kinkl = (AliKink*) kinks.At(indexes[i]);</span>
<span class="lineNum">    7375 </span><span class="lineNoCov">          0 :     if (!kinkl) continue;</span>
<span class="lineNum">    7376 </span><span class="lineNoCov">          0 :     kinkl-&gt;SetTPCRow0(GetRowNumber(kinkl-&gt;GetR()));</span>
<span class="lineNum">    7377 </span><span class="lineNoCov">          0 :     Int_t index0 = kinkl-&gt;GetIndex(0);</span>
<span class="lineNum">    7378 </span><span class="lineNoCov">          0 :     Int_t index1 = kinkl-&gt;GetIndex(1);</span>
<span class="lineNum">    7379 </span><span class="lineNoCov">          0 :     if (circular[index0]||(circular[index1]&amp;&amp;kinkl-&gt;GetDistance()&gt;0.2)) continue;</span>
<span class="lineNum">    7380 </span><span class="lineNoCov">          0 :     kinkl-&gt;SetMultiple(usage[index0],0);</span>
<span class="lineNum">    7381 </span><span class="lineNoCov">          0 :     kinkl-&gt;SetMultiple(usage[index1],1);</span>
<span class="lineNum">    7382 </span><span class="lineNoCov">          0 :     if (kinkl-&gt;GetMultiple()[0]+kinkl-&gt;GetMultiple()[1]&gt;2) continue;</span>
<span class="lineNum">    7383 </span><span class="lineNoCov">          0 :     if (kinkl-&gt;GetMultiple()[0]+kinkl-&gt;GetMultiple()[1]&gt;0 &amp;&amp; quality[indexes[i]]&gt;0.2) continue;</span>
<span class="lineNum">    7384 </span><span class="lineNoCov">          0 :     if (kinkl-&gt;GetMultiple()[0]+kinkl-&gt;GetMultiple()[1]&gt;0 &amp;&amp; kinkl-&gt;GetDistance()&gt;0.2) continue;</span>
<span class="lineNum">    7385 </span><span class="lineNoCov">          0 :     if (circular[index0]||(circular[index1]&amp;&amp;kinkl-&gt;GetDistance()&gt;0.1)) continue;</span>
<span class="lineNum">    7386 </span>            : 
<span class="lineNum">    7387 </span><span class="lineNoCov">          0 :     AliTPCseed * ktrack0 = (AliTPCseed*)array-&gt;At(index0);</span>
<span class="lineNum">    7388 </span><span class="lineNoCov">          0 :     AliTPCseed * ktrack1 = (AliTPCseed*)array-&gt;At(index1);</span>
<span class="lineNum">    7389 </span><span class="lineNoCov">          0 :     if (!ktrack0 || !ktrack1) continue;</span>
<span class="lineNum">    7390 </span><span class="lineNoCov">          0 :     Int_t index = esd-&gt;AddKink(kinkl);</span>
<span class="lineNum">    7391 </span>            :     //
<span class="lineNum">    7392 </span>            :     //
<span class="lineNum">    7393 </span><span class="lineNoCov">          0 :     if ( ktrack0-&gt;GetKinkIndex(0)==0 &amp;&amp; ktrack1-&gt;GetKinkIndex(0)==0) {  //best kink</span>
<span class="lineNum">    7394 </span><span class="lineNoCov">          0 :       if ( (mothers[indexes[i]]) &amp;&amp; daughters[indexes[i]] &amp;&amp; </span>
<span class="lineNum">    7395 </span><span class="lineNoCov">          0 :            mothers[indexes[i]]-&gt;GetNumberOfClusters()&gt;20 &amp;&amp;  // where they reseeded?</span>
<span class="lineNum">    7396 </span><span class="lineNoCov">          0 :            daughters[indexes[i]]-&gt;GetNumberOfClusters()&gt;20 &amp;&amp; </span>
<span class="lineNum">    7397 </span><span class="lineNoCov">          0 :           (mothers[indexes[i]]-&gt;GetNumberOfClusters()+daughters[indexes[i]]-&gt;GetNumberOfClusters())&gt;100){</span>
<span class="lineNum">    7398 </span><span class="lineNoCov">          0 :         *ktrack0 = *mothers[indexes[i]];</span>
<span class="lineNum">    7399 </span><span class="lineNoCov">          0 :         *ktrack1 = *daughters[indexes[i]];</span>
<span class="lineNum">    7400 </span>            :       }
<span class="lineNum">    7401 </span>            :     }
<span class="lineNum">    7402 </span>            :     //
<span class="lineNum">    7403 </span><span class="lineNoCov">          0 :     ktrack0-&gt;SetKinkIndex(usage[index0],-(index+1));</span>
<span class="lineNum">    7404 </span><span class="lineNoCov">          0 :     ktrack1-&gt;SetKinkIndex(usage[index1], (index+1));</span>
<span class="lineNum">    7405 </span><span class="lineNoCov">          0 :     usage[index0]++;</span>
<span class="lineNum">    7406 </span><span class="lineNoCov">          0 :     usage[index1]++;</span>
<span class="lineNum">    7407 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    7408 </span>            :   //
<span class="lineNum">    7409 </span>            :   // Remove tracks corresponding to shared kink's
<span class="lineNum">    7410 </span>            :   //
<span class="lineNum">    7411 </span><span class="lineCov">        552 :   for (Int_t i=0;i&lt;nentries;i++){</span>
<span class="lineNum">    7412 </span><span class="lineCov">        536 :     AliTPCseed * track0 = (AliTPCseed*)array-&gt;At(i);</span>
<span class="lineNum">    7413 </span><span class="lineCov">        388 :     if (!track0) continue;</span>
<span class="lineNum">    7414 </span><span class="lineCov">        296 :     if (track0-&gt;GetKinkIndex(0)!=0) continue;</span>
<span class="lineNum">    7415 </span><span class="lineCov">        148 :     if (shared[i]) MarkSeedFree( array-&gt;RemoveAt(i) );</span>
<span class="lineNum">    7416 </span><span class="lineCov">        148 :   }</span>
<span class="lineNum">    7417 </span>            : 
<span class="lineNum">    7418 </span>            :   //
<span class="lineNum">    7419 </span>            :   //
<span class="lineNum">    7420 </span><span class="lineCov">          8 :   RemoveUsed2(array,0.5,0.4,30);</span>
<span class="lineNum">    7421 </span><span class="lineCov">          8 :   UnsignClusters();</span>
<span class="lineNum">    7422 </span><span class="lineCov">        552 :   for (Int_t i=0;i&lt;nentries;i++){</span>
<span class="lineNum">    7423 </span><span class="lineCov">        536 :     AliTPCseed * track0 = (AliTPCseed*)array-&gt;At(i);</span>
<span class="lineNum">    7424 </span><span class="lineCov">        402 :     if (!track0) continue;</span>
<span class="lineNum">    7425 </span><span class="lineCov">        134 :     track0-&gt;CookdEdx(0.02,0.6);</span>
<span class="lineNum">    7426 </span><span class="lineCov">        134 :     track0-&gt;CookPID();</span>
<span class="lineNum">    7427 </span><span class="lineCov">        134 :   }</span>
<span class="lineNum">    7428 </span>            :   //
<span class="lineNum">    7429 </span>            :   // RS use stack allocation instead of the heap
<span class="lineNum">    7430 </span><span class="lineCov">         16 :   AliTPCseed mother,daughter;</span>
<span class="lineNum">    7431 </span><span class="lineCov">          8 :   AliKink kinkl;</span>
<span class="lineNum">    7432 </span>            :   //
<span class="lineNum">    7433 </span><span class="lineCov">        552 :   for (Int_t i=0;i&lt;nentries;i++){</span>
<span class="lineNum">    7434 </span><span class="lineCov">        536 :     AliTPCseed * track0 = (AliTPCseed*)array-&gt;At(i);</span>
<span class="lineNum">    7435 </span><span class="lineCov">        400 :     if (!track0) continue;</span>
<span class="lineNum">    7436 </span><span class="lineCov">        352 :     if (track0-&gt;Pt()&lt;1.4) continue;</span>
<span class="lineNum">    7437 </span>            :     //remove double high momenta tracks - overlapped with kink candidates
<span class="lineNum">    7438 </span>            :     Int_t ishared=0;
<span class="lineNum">    7439 </span>            :     Int_t all   =0;
<span class="lineNum">    7440 </span><span class="lineCov">      17220 :     for (Int_t icl=track0-&gt;GetFirstPoint();icl&lt;track0-&gt;GetLastPoint(); icl++){</span>
<span class="lineNum">    7441 </span><span class="lineCov">       8554 :       Int_t tpcindex = track0-&gt;GetClusterIndex2(icl);</span>
<span class="lineNum">    7442 </span><span class="lineCov">       9448 :       if (tpcindex&lt;0) continue;</span>
<span class="lineNum">    7443 </span><span class="lineCov">       7660 :       AliTPCclusterMI *cl = GetClusterMI(tpcindex);</span>
<span class="lineNum">    7444 </span><span class="lineCov">       7660 :       all++;</span>
<span class="lineNum">    7445 </span><span class="lineCov">       7946 :       if (cl-&gt;IsUsed(10)) ishared++;</span>
<span class="lineNum">    7446 </span><span class="lineCov">       7660 :     }</span>
<span class="lineNum">    7447 </span><span class="lineCov">         56 :     if (Float_t(ishared+1)/Float_t(all+1)&gt;0.5) {  </span>
<span class="lineNum">    7448 </span><span class="lineCov">          4 :       MarkSeedFree( array-&gt;RemoveAt(i) );</span>
<span class="lineNum">    7449 </span><span class="lineCov">          2 :       continue;</span>
<span class="lineNum">    7450 </span>            :     }
<span class="lineNum">    7451 </span>            :     //
<span class="lineNum">    7452 </span><span class="lineCov">        110 :     if (track0-&gt;GetKinkIndex(0)!=0) continue;</span>
<span class="lineNum">    7453 </span><span class="lineCov">        104 :     if (track0-&gt;GetNumberOfClusters()&lt;80) continue;</span>
<span class="lineNum">    7454 </span>            : 
<span class="lineNum">    7455 </span>            :     // AliTPCseed *pmother = new AliTPCseed(); // RS use stack allocation
<span class="lineNum">    7456 </span>            :     // AliTPCseed *pdaughter = new AliTPCseed();
<span class="lineNum">    7457 </span>            :     // AliKink *pkink = new AliKink;
<span class="lineNum">    7458 </span>            :     //
<span class="lineNum">    7459 </span><span class="lineCov">        104 :     if (CheckKinkPoint(track0,mother,daughter, kinkl)){</span>
<span class="lineNum">    7460 </span><span class="lineCov">         44 :       if (mother.GetNumberOfClusters()&lt;30||daughter.GetNumberOfClusters()&lt;20) {</span>
<span class="lineNum">    7461 </span>            :         //      delete pmother; // RS used stack allocation
<span class="lineNum">    7462 </span>            :         //      delete pdaughter;
<span class="lineNum">    7463 </span>            :         //      delete pkink;
<span class="lineNum">    7464 </span><span class="lineCov">          4 :         continue;  //too short tracks</span>
<span class="lineNum">    7465 </span>            :       }
<span class="lineNum">    7466 </span><span class="lineCov">         16 :       if (mother.Pt()&lt;1.4) {</span>
<span class="lineNum">    7467 </span>            :         //      delete pmother; // RS used stack allocation
<span class="lineNum">    7468 </span>            :         //      delete pdaughter;
<span class="lineNum">    7469 </span>            :         //      delete pkink;
<span class="lineNum">    7470 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    7471 </span>            :       }
<span class="lineNum">    7472 </span><span class="lineCov">          8 :       Int_t row0= kinkl.GetTPCRow0();</span>
<span class="lineNum">    7473 </span><span class="lineCov">         18 :       if (kinkl.GetDistance()&gt;0.5 || kinkl.GetR()&lt;110. || kinkl.GetR()&gt;240.) {</span>
<span class="lineNum">    7474 </span>            :         //      delete pmother; // RS used stack allocation
<span class="lineNum">    7475 </span>            :         //      delete pdaughter;
<span class="lineNum">    7476 </span>            :         //      delete pkink;
<span class="lineNum">    7477 </span><span class="lineCov">          4 :         continue;</span>
<span class="lineNum">    7478 </span>            :       }
<span class="lineNum">    7479 </span>            :       //
<span class="lineNum">    7480 </span><span class="lineCov">          4 :       Int_t index = esd-&gt;AddKink(&amp;kinkl);      </span>
<span class="lineNum">    7481 </span><span class="lineCov">          4 :       mother.SetKinkIndex(0,-(index+1));</span>
<span class="lineNum">    7482 </span><span class="lineCov">          4 :       daughter.SetKinkIndex(0,index+1);</span>
<span class="lineNum">    7483 </span><span class="lineCov">          8 :       if (mother.GetNumberOfClusters()&gt;50) {</span>
<span class="lineNum">    7484 </span><span class="lineCov">          8 :         MarkSeedFree( array-&gt;RemoveAt(i) );</span>
<span class="lineNum">    7485 </span><span class="lineCov">         12 :         AliTPCseed* mtc = new( NextFreeSeed() ) AliTPCseed(mother);</span>
<span class="lineNum">    7486 </span><span class="lineCov">          4 :         mtc-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    7487 </span><span class="lineCov">          4 :         array-&gt;AddAt(mtc,i);</span>
<span class="lineNum">    7488 </span><span class="lineCov">          4 :       }</span>
<span class="lineNum">    7489 </span>            :       else{
<span class="lineNum">    7490 </span><span class="lineNoCov">          0 :         AliTPCseed* mtc = new( NextFreeSeed() ) AliTPCseed(mother);</span>
<span class="lineNum">    7491 </span><span class="lineNoCov">          0 :         mtc-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    7492 </span><span class="lineNoCov">          0 :         array-&gt;AddLast(mtc);</span>
<span class="lineNum">    7493 </span>            :       }
<span class="lineNum">    7494 </span><span class="lineCov">         12 :       AliTPCseed* dtc = new( NextFreeSeed() ) AliTPCseed(daughter);</span>
<span class="lineNum">    7495 </span><span class="lineCov">          4 :       dtc-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    7496 </span><span class="lineCov">          4 :       array-&gt;AddLast(dtc);      </span>
<span class="lineNum">    7497 </span><span class="lineCov">        732 :       for (Int_t icl=0;icl&lt;row0;icl++) {</span>
<span class="lineNum">    7498 </span><span class="lineCov">        362 :         Int_t tpcindex= mother.GetClusterIndex2(icl);</span>
<span class="lineNum">    7499 </span><span class="lineCov">        420 :         if (tpcindex&lt;0) continue;</span>
<span class="lineNum">    7500 </span><span class="lineCov">        304 :         AliTPCclusterMI *cl = GetClusterMI(tpcindex);</span>
<span class="lineNum">    7501 </span><span class="lineCov">        608 :         if (cl) cl-&gt;Use(20);</span>
<span class="lineNum">    7502 </span><span class="lineCov">        304 :       }</span>
<span class="lineNum">    7503 </span>            :       //
<span class="lineNum">    7504 </span><span class="lineCov">        548 :       for (Int_t icl=row0;icl&lt;158;icl++) {</span>
<span class="lineNum">    7505 </span><span class="lineCov">        270 :         Int_t tpcindex= mother.GetClusterIndex2(icl);</span>
<span class="lineNum">    7506 </span><span class="lineCov">        404 :         if (tpcindex&lt;0) continue;</span>
<span class="lineNum">    7507 </span><span class="lineCov">        136 :         AliTPCclusterMI *cl = GetClusterMI(tpcindex);</span>
<span class="lineNum">    7508 </span><span class="lineCov">        272 :         if (cl) cl-&gt;Use(20);</span>
<span class="lineNum">    7509 </span><span class="lineCov">        136 :       }</span>
<span class="lineNum">    7510 </span>            :       //
<span class="lineNum">    7511 </span><span class="lineCov">          4 :     }</span>
<span class="lineNum">    7512 </span>            :     //delete pmother; // RS used stack allocation
<span class="lineNum">    7513 </span>            :     //delete pdaughter;
<span class="lineNum">    7514 </span>            :     //delete pkink;
<span class="lineNum">    7515 </span><span class="lineCov">         44 :   }</span>
<span class="lineNum">    7516 </span>            : 
<span class="lineNum">    7517 </span><span class="lineCov">         16 :   for (int i=nkinks;i--;) {</span>
<span class="lineNum">    7518 </span><span class="lineNoCov">          0 :     if (mothers[i]) MarkSeedFree( mothers[i] );</span>
<span class="lineNum">    7519 </span><span class="lineNoCov">          0 :     if (daughters[i]) MarkSeedFree( daughters[i] );</span>
<span class="lineNum">    7520 </span>            :   }
<span class="lineNum">    7521 </span>            :   //  delete [] daughters;
<span class="lineNum">    7522 </span>            :   //  delete [] mothers;
<span class="lineNum">    7523 </span>            :   //
<span class="lineNum">    7524 </span>            :   // RS: most of heap array are converted to stack arrays
<span class="lineNum">    7525 </span>            :   //  delete [] dca;
<span class="lineNum">    7526 </span>            :   //  delete []circular;
<span class="lineNum">    7527 </span>            :   //  delete []shared;
<span class="lineNum">    7528 </span>            :   //  delete []quality;
<span class="lineNum">    7529 </span>            :   //  delete []indexes;
<span class="lineNum">    7530 </span>            :   //
<span class="lineNum">    7531 </span><span class="lineCov">         16 :   delete kink;</span>
<span class="lineNum">    7532 </span>            :   //  delete[]fim;
<span class="lineNum">    7533 </span>            :   //  delete[] zm;
<span class="lineNum">    7534 </span>            :   //  delete[] z0;
<span class="lineNum">    7535 </span>            :   //  delete [] usage;
<span class="lineNum">    7536 </span>            :   //  delete[] alpha;
<span class="lineNum">    7537 </span>            :   //  delete[] nclusters;
<span class="lineNum">    7538 </span>            :   //  delete[] sign;
<span class="lineNum">    7539 </span>            :   // delete[] helixes;
<span class="lineNum">    7540 </span><span class="lineCov">         16 :   if (fHelixPool) fHelixPool-&gt;Clear();</span>
<span class="lineNum">    7541 </span><span class="lineCov">          8 :   kinks.Delete();</span>
<span class="lineNum">    7542 </span>            :   //delete kinks;
<span class="lineNum">    7543 </span>            : 
<span class="lineNum">    7544 </span><span class="lineCov">         32 :   AliInfo(Form(&quot;Ncandidates=\t%d\t%d\t%d\t%d\n&quot;,esd-&gt;GetNumberOfKinks(),ncandidates,ntracks,nall));</span>
<span class="lineNum">    7545 </span><span class="lineCov">          8 :   timer.Print();</span>
<a name="7546"><span class="lineNum">    7546 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">    7547 </span>            : 
<span class="lineNum">    7548 </span>            : Int_t AliTPCtracker::RefitKink(AliTPCseed &amp;mother, AliTPCseed &amp;daughter, const AliESDkink &amp;knk)
<span class="lineNum">    7549 </span>            : {
<span class="lineNum">    7550 </span>            :   //
<span class="lineNum">    7551 </span>            :   // refit kink towards to the vertex
<span class="lineNum">    7552 </span>            :   //
<span class="lineNum">    7553 </span>            :   //
<span class="lineNum">    7554 </span><span class="lineNoCov">          0 :   AliKink &amp;kink=(AliKink &amp;)knk;</span>
<span class="lineNum">    7555 </span>            : 
<span class="lineNum">    7556 </span><span class="lineNoCov">          0 :   Int_t row0 = GetRowNumber(kink.GetR());</span>
<span class="lineNum">    7557 </span><span class="lineNoCov">          0 :   FollowProlongation(mother,0);</span>
<span class="lineNum">    7558 </span><span class="lineNoCov">          0 :   mother.Reset(kFALSE);</span>
<span class="lineNum">    7559 </span>            :   //
<span class="lineNum">    7560 </span><span class="lineNoCov">          0 :   FollowProlongation(daughter,row0);</span>
<span class="lineNum">    7561 </span><span class="lineNoCov">          0 :   daughter.Reset(kFALSE);</span>
<span class="lineNum">    7562 </span><span class="lineNoCov">          0 :   FollowBackProlongation(daughter,158);</span>
<span class="lineNum">    7563 </span><span class="lineNoCov">          0 :   daughter.Reset(kFALSE);</span>
<span class="lineNum">    7564 </span><span class="lineNoCov">          0 :   Int_t first = TMath::Max(row0-20,30); </span>
<span class="lineNum">    7565 </span><span class="lineNoCov">          0 :   Int_t last  = TMath::Min(row0+20,140);</span>
<span class="lineNum">    7566 </span>            :   //
<span class="lineNum">    7567 </span>            :   const Int_t kNdiv =5;
<span class="lineNum">    7568 </span><span class="lineNoCov">          0 :   AliTPCseed  param0[kNdiv];  // parameters along the track</span>
<span class="lineNum">    7569 </span><span class="lineNoCov">          0 :   AliTPCseed  param1[kNdiv];  // parameters along the track</span>
<span class="lineNum">    7570 </span><span class="lineNoCov">          0 :   AliKink     kinks[kNdiv];   // corresponding kink parameters</span>
<span class="lineNum">    7571 </span>            :   //
<span class="lineNum">    7572 </span><span class="lineNoCov">          0 :   Int_t rows[kNdiv];</span>
<span class="lineNum">    7573 </span><span class="lineNoCov">          0 :   for (Int_t irow=0; irow&lt;kNdiv;irow++){</span>
<span class="lineNum">    7574 </span><span class="lineNoCov">          0 :     rows[irow] = first +((last-first)*irow)/(kNdiv-1);</span>
<span class="lineNum">    7575 </span>            :   }
<span class="lineNum">    7576 </span>            :   // store parameters along the track
<span class="lineNum">    7577 </span>            :   //
<span class="lineNum">    7578 </span><span class="lineNoCov">          0 :   for (Int_t irow=0;irow&lt;kNdiv;irow++){</span>
<span class="lineNum">    7579 </span><span class="lineNoCov">          0 :     FollowBackProlongation(mother, rows[irow]);</span>
<span class="lineNum">    7580 </span><span class="lineNoCov">          0 :     FollowProlongation(daughter,rows[kNdiv-1-irow]);       </span>
<span class="lineNum">    7581 </span><span class="lineNoCov">          0 :     param0[irow] = mother;</span>
<span class="lineNum">    7582 </span><span class="lineNoCov">          0 :     param1[kNdiv-1-irow] = daughter;</span>
<span class="lineNum">    7583 </span>            :   }
<span class="lineNum">    7584 </span>            :   //
<span class="lineNum">    7585 </span>            :   // define kinks 
<span class="lineNum">    7586 </span><span class="lineNoCov">          0 :   for (Int_t irow=0; irow&lt;kNdiv-1;irow++){</span>
<span class="lineNum">    7587 </span><span class="lineNoCov">          0 :     if (param0[irow].GetNumberOfClusters()&lt;kNdiv||param1[irow].GetNumberOfClusters()&lt;kNdiv) continue;</span>
<span class="lineNum">    7588 </span><span class="lineNoCov">          0 :     kinks[irow].SetMother(param0[irow]);</span>
<span class="lineNum">    7589 </span><span class="lineNoCov">          0 :     kinks[irow].SetDaughter(param1[irow]);</span>
<span class="lineNum">    7590 </span><span class="lineNoCov">          0 :     kinks[irow].Update();</span>
<span class="lineNum">    7591 </span>            :   }
<span class="lineNum">    7592 </span>            :   //
<span class="lineNum">    7593 </span>            :   // choose kink with best &quot;quality&quot;
<span class="lineNum">    7594 </span>            :   Int_t index =-1;
<span class="lineNum">    7595 </span>            :   Double_t mindist = 10000;
<span class="lineNum">    7596 </span><span class="lineNoCov">          0 :   for (Int_t irow=0;irow&lt;kNdiv;irow++){</span>
<span class="lineNum">    7597 </span><span class="lineNoCov">          0 :     if (param0[irow].GetNumberOfClusters()&lt;20||param1[irow].GetNumberOfClusters()&lt;20) continue;</span>
<span class="lineNum">    7598 </span><span class="lineNoCov">          0 :     if (TMath::Abs(kinks[irow].GetR())&gt;240.) continue;</span>
<span class="lineNum">    7599 </span><span class="lineNoCov">          0 :     if (TMath::Abs(kinks[irow].GetR())&lt;100.) continue;</span>
<span class="lineNum">    7600 </span>            :     //
<span class="lineNum">    7601 </span><span class="lineNoCov">          0 :     Float_t normdist = TMath::Abs(param0[irow].GetX()-kinks[irow].GetR())*(0.1+kink.GetDistance());</span>
<span class="lineNum">    7602 </span><span class="lineNoCov">          0 :     normdist/= (param0[irow].GetNumberOfClusters()+param1[irow].GetNumberOfClusters()+40.);</span>
<span class="lineNum">    7603 </span><span class="lineNoCov">          0 :     if (normdist &lt; mindist){</span>
<span class="lineNum">    7604 </span>            :       mindist = normdist;
<span class="lineNum">    7605 </span>            :       index = irow;
<span class="lineNum">    7606 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    7607 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    7608 </span>            :   //
<span class="lineNum">    7609 </span><span class="lineNoCov">          0 :   if (index==-1) return 0;</span>
<span class="lineNum">    7610 </span>            :   //
<span class="lineNum">    7611 </span>            :   //
<span class="lineNum">    7612 </span><span class="lineNoCov">          0 :   param0[index].Reset(kTRUE);</span>
<span class="lineNum">    7613 </span><span class="lineNoCov">          0 :   FollowProlongation(param0[index],0);</span>
<span class="lineNum">    7614 </span>            :   //
<span class="lineNum">    7615 </span><span class="lineNoCov">          0 :   mother = param0[index];</span>
<span class="lineNum">    7616 </span><span class="lineNoCov">          0 :   daughter = param1[index];  // daughter in vertex</span>
<span class="lineNum">    7617 </span>            :   //
<span class="lineNum">    7618 </span><span class="lineNoCov">          0 :   kink.SetMother(mother);</span>
<span class="lineNum">    7619 </span><span class="lineNoCov">          0 :   kink.SetDaughter(daughter);</span>
<span class="lineNum">    7620 </span><span class="lineNoCov">          0 :   kink.Update();</span>
<span class="lineNum">    7621 </span><span class="lineNoCov">          0 :   kink.SetTPCRow0(GetRowNumber(kink.GetR()));</span>
<span class="lineNum">    7622 </span><span class="lineNoCov">          0 :   kink.SetTPCncls(param0[index].GetNumberOfClusters(),0);</span>
<span class="lineNum">    7623 </span><span class="lineNoCov">          0 :   kink.SetTPCncls(param1[index].GetNumberOfClusters(),1);</span>
<span class="lineNum">    7624 </span><span class="lineNoCov">          0 :   kink.SetLabel(CookLabel(&amp;mother,0.4, 0,kink.GetTPCRow0()),0);</span>
<span class="lineNum">    7625 </span><span class="lineNoCov">          0 :   kink.SetLabel(CookLabel(&amp;daughter,0.4, kink.GetTPCRow0(),kMaxRow),1);</span>
<span class="lineNum">    7626 </span><span class="lineNoCov">          0 :   mother.SetLabel(kink.GetLabel(0));</span>
<span class="lineNum">    7627 </span><span class="lineNoCov">          0 :   daughter.SetLabel(kink.GetLabel(1));</span>
<span class="lineNum">    7628 </span>            : 
<span class="lineNum">    7629 </span><span class="lineNoCov">          0 :   return 1;</span>
<span class="lineNum">    7630 </span><span class="lineNoCov">          0 : }</span>
<a name="7631"><span class="lineNum">    7631 </span>            : </a>
<span class="lineNum">    7632 </span>            : 
<span class="lineNum">    7633 </span>            : void AliTPCtracker::UpdateKinkQualityM(AliTPCseed * seed){
<span class="lineNum">    7634 </span>            :   //
<span class="lineNum">    7635 </span>            :   // update Kink quality information for mother after back propagation
<span class="lineNum">    7636 </span>            :   //
<span class="lineNum">    7637 </span><span class="lineCov">          8 :   if (seed-&gt;GetKinkIndex(0)&gt;=0) return; </span>
<span class="lineNum">    7638 </span><span class="lineCov">         16 :   for (Int_t ikink=0;ikink&lt;3;ikink++){</span>
<span class="lineNum">    7639 </span><span class="lineCov">          8 :     Int_t index = seed-&gt;GetKinkIndex(ikink);</span>
<span class="lineNum">    7640 </span><span class="lineCov">         12 :     if (index&gt;=0) break;</span>
<span class="lineNum">    7641 </span><span class="lineCov">          4 :     index = TMath::Abs(index)-1;</span>
<span class="lineNum">    7642 </span><span class="lineCov">          4 :     AliESDkink * kink = fEvent-&gt;GetKink(index);</span>
<span class="lineNum">    7643 </span><span class="lineCov">          4 :     kink-&gt;SetTPCDensity(-1,0,0);</span>
<span class="lineNum">    7644 </span><span class="lineCov">          4 :     kink-&gt;SetTPCDensity(1,0,1);</span>
<span class="lineNum">    7645 </span>            :     //
<span class="lineNum">    7646 </span><span class="lineCov">          4 :     Int_t row0 = kink-&gt;GetTPCRow0() - 2 - Int_t( 0.5/ (0.05+kink-&gt;GetAngle(2)));</span>
<span class="lineNum">    7647 </span><span class="lineCov">          4 :     if (row0&lt;15) row0=15;</span>
<span class="lineNum">    7648 </span>            :     //
<span class="lineNum">    7649 </span><span class="lineCov">          4 :     Int_t row1 = kink-&gt;GetTPCRow0() + 2 +  Int_t( 0.5/ (0.05+kink-&gt;GetAngle(2)));</span>
<span class="lineNum">    7650 </span><span class="lineCov">          4 :     if (row1&gt;145) row1=145;</span>
<span class="lineNum">    7651 </span>            :     //
<span class="lineNum">    7652 </span><span class="lineCov">          4 :     Int_t found,foundable;//,shared;</span>
<span class="lineNum">    7653 </span>            :     //GetSeedClusterStatistic(seed,0,row0, found, foundable,shared,kFALSE); //RS: seeds don't keep their clusters
<span class="lineNum">    7654 </span>            :     //RS seed-&gt;GetClusterStatistic(0,row0, found, foundable,shared,kFALSE);
<span class="lineNum">    7655 </span><span class="lineCov">          4 :     seed-&gt;GetClusterStatistic(0,row0, found, foundable);</span>
<span class="lineNum">    7656 </span><span class="lineCov">          8 :     if (foundable&gt;5)   kink-&gt;SetTPCDensity(Float_t(found)/Float_t(foundable),0,0);</span>
<span class="lineNum">    7657 </span>            :     //
<span class="lineNum">    7658 </span>            :     //GetSeedClusterStatistic(seed,row1,155, found, foundable,shared,kFALSE); //RS: seeds don't keep their clusters
<span class="lineNum">    7659 </span>            :     //RS seed-&gt;GetClusterStatistic(row1,155, found, foundable,shared,kFALSE);
<span class="lineNum">    7660 </span><span class="lineCov">          4 :     seed-&gt;GetClusterStatistic(row1,155, found, foundable);</span>
<span class="lineNum">    7661 </span><span class="lineCov">          8 :     if (foundable&gt;5)   kink-&gt;SetTPCDensity(Float_t(found)/Float_t(foundable),0,1);</span>
<span class="lineNum">    7662 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">    7663 </span>            :     
<a name="7664"><span class="lineNum">    7664 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">    7665 </span>            : 
<span class="lineNum">    7666 </span>            : void AliTPCtracker::UpdateKinkQualityD(AliTPCseed * seed){
<span class="lineNum">    7667 </span>            :   //
<span class="lineNum">    7668 </span>            :   // update Kink quality information for daughter after refit
<span class="lineNum">    7669 </span>            :   //
<span class="lineNum">    7670 </span><span class="lineCov">          8 :   if (seed-&gt;GetKinkIndex(0)&lt;=0) return; </span>
<span class="lineNum">    7671 </span><span class="lineCov">         16 :   for (Int_t ikink=0;ikink&lt;3;ikink++){</span>
<span class="lineNum">    7672 </span><span class="lineCov">          8 :     Int_t index = seed-&gt;GetKinkIndex(ikink);</span>
<span class="lineNum">    7673 </span><span class="lineCov">         12 :     if (index&lt;=0) break;</span>
<span class="lineNum">    7674 </span><span class="lineCov">          4 :     index = TMath::Abs(index)-1;</span>
<span class="lineNum">    7675 </span><span class="lineCov">          4 :     AliESDkink * kink = fEvent-&gt;GetKink(index);</span>
<span class="lineNum">    7676 </span><span class="lineCov">          4 :     kink-&gt;SetTPCDensity(-1,1,0);</span>
<span class="lineNum">    7677 </span><span class="lineCov">          4 :     kink-&gt;SetTPCDensity(-1,1,1);</span>
<span class="lineNum">    7678 </span>            :     //
<span class="lineNum">    7679 </span><span class="lineCov">          4 :     Int_t row0 = kink-&gt;GetTPCRow0() -2 - Int_t( 0.5/ (0.05+kink-&gt;GetAngle(2)));</span>
<span class="lineNum">    7680 </span><span class="lineCov">          4 :     if (row0&lt;15) row0=15;</span>
<span class="lineNum">    7681 </span>            :     //
<span class="lineNum">    7682 </span><span class="lineCov">          4 :     Int_t row1 = kink-&gt;GetTPCRow0() +2 +  Int_t( 0.5/ (0.05+kink-&gt;GetAngle(2)));</span>
<span class="lineNum">    7683 </span><span class="lineCov">          4 :     if (row1&gt;145) row1=145;</span>
<span class="lineNum">    7684 </span>            :     //
<span class="lineNum">    7685 </span><span class="lineCov">          4 :     Int_t found,foundable;//,shared;</span>
<span class="lineNum">    7686 </span>            :     //GetSeedClusterStatistic(0,row0, found, foundable,shared,kFALS); //RS: seeds don't keep their clusters
<span class="lineNum">    7687 </span>            :     //seed-&gt;GetClusterStatistic(0,row0, found, foundable,shared,kFALSE);
<span class="lineNum">    7688 </span><span class="lineCov">          4 :     seed-&gt;GetClusterStatistic(0,row0, found, foundable);</span>
<span class="lineNum">    7689 </span><span class="lineCov">          8 :     if (foundable&gt;5)   kink-&gt;SetTPCDensity(Float_t(found)/Float_t(foundable),1,0);</span>
<span class="lineNum">    7690 </span>            :     //
<span class="lineNum">    7691 </span>            :     //GetSeedClusterStatistic(row1,155, found, foundable,shared,kFALSE); //RS: seeds don't keep their clusters
<span class="lineNum">    7692 </span>            :     // seed-&gt;GetClusterStatistic(row1,155, found, foundable,shared,kFALSE);
<span class="lineNum">    7693 </span><span class="lineCov">          4 :     seed-&gt;GetClusterStatistic(row1,155, found, foundable);</span>
<span class="lineNum">    7694 </span><span class="lineCov">          8 :     if (foundable&gt;5)   kink-&gt;SetTPCDensity(Float_t(found)/Float_t(foundable),1,1);</span>
<span class="lineNum">    7695 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">    7696 </span>            :     
<span class="lineNum">    7697 </span><span class="lineCov">          4 : }</span>
<a name="7698"><span class="lineNum">    7698 </span>            : </a>
<span class="lineNum">    7699 </span>            : 
<span class="lineNum">    7700 </span>            : Int_t  AliTPCtracker::CheckKinkPoint(AliTPCseed*seed,AliTPCseed &amp;mother, AliTPCseed &amp;daughter, const AliESDkink &amp;knk)
<span class="lineNum">    7701 </span>            : {
<span class="lineNum">    7702 </span>            :   //
<span class="lineNum">    7703 </span>            :   // check kink point for given track
<span class="lineNum">    7704 </span>            :   // if return value=0 kink point not found
<span class="lineNum">    7705 </span>            :   // otherwise seed0 correspond to mother particle
<span class="lineNum">    7706 </span>            :   //           seed1 correspond to daughter particle
<span class="lineNum">    7707 </span>            :   //           kink  parameter of kink point
<span class="lineNum">    7708 </span><span class="lineCov">        104 :   AliKink &amp;kink=(AliKink &amp;)knk;</span>
<span class="lineNum">    7709 </span>            : 
<span class="lineNum">    7710 </span><span class="lineCov">         52 :   Int_t middlerow = (seed-&gt;GetFirstPoint()+seed-&gt;GetLastPoint())/2;</span>
<span class="lineNum">    7711 </span><span class="lineCov">         52 :   Int_t first = seed-&gt;GetFirstPoint(); </span>
<span class="lineNum">    7712 </span><span class="lineCov">         52 :   Int_t last  = seed-&gt;GetLastPoint();</span>
<span class="lineNum">    7713 </span><span class="lineCov">         52 :   if (last-first&lt;20) return 0;          // shortest length - 2*30 = 60 pad-rows</span>
<span class="lineNum">    7714 </span>            : 
<span class="lineNum">    7715 </span>            :   
<span class="lineNum">    7716 </span><span class="lineCov">         52 :   AliTPCseed *seed1 = ReSeed(seed,middlerow+20, kTRUE);  //middle of chamber</span>
<span class="lineNum">    7717 </span><span class="lineCov">         52 :   if (!seed1) return 0;</span>
<span class="lineNum">    7718 </span><span class="lineCov">         52 :   FollowProlongation(*seed1,seed-&gt;GetLastPoint()-20);</span>
<span class="lineNum">    7719 </span><span class="lineCov">         52 :   seed1-&gt;Reset(kTRUE);</span>
<span class="lineNum">    7720 </span><span class="lineCov">         52 :   FollowProlongation(*seed1,158);</span>
<span class="lineNum">    7721 </span><span class="lineCov">         52 :   seed1-&gt;Reset(kTRUE);  </span>
<span class="lineNum">    7722 </span><span class="lineCov">         52 :   last = seed1-&gt;GetLastPoint();</span>
<span class="lineNum">    7723 </span>            :   //
<span class="lineNum">    7724 </span><span class="lineCov">         52 :   AliTPCseed *seed0 = new( NextFreeSeed() ) AliTPCseed(*seed);</span>
<span class="lineNum">    7725 </span><span class="lineCov">         52 :   seed0-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    7726 </span><span class="lineCov">         52 :   seed0-&gt;Reset(kFALSE);</span>
<span class="lineNum">    7727 </span><span class="lineCov">         52 :   seed0-&gt;Reset();</span>
<span class="lineNum">    7728 </span>            :   //
<span class="lineNum">    7729 </span><span class="lineCov">       2132 :   AliTPCseed  param0[20];  // parameters along the track</span>
<span class="lineNum">    7730 </span><span class="lineCov">       2132 :   AliTPCseed  param1[20];  // parameters along the track</span>
<span class="lineNum">    7731 </span><span class="lineCov">       2132 :   AliKink     kinks[20];   // corresponding kink parameters</span>
<span class="lineNum">    7732 </span><span class="lineCov">         52 :   Int_t rows[20];</span>
<span class="lineNum">    7733 </span><span class="lineCov">       2184 :   for (Int_t irow=0; irow&lt;20;irow++){</span>
<span class="lineNum">    7734 </span><span class="lineCov">       1040 :     rows[irow] = first +((last-first)*irow)/19;</span>
<span class="lineNum">    7735 </span>            :   }
<span class="lineNum">    7736 </span>            :   // store parameters along the track
<span class="lineNum">    7737 </span>            :   //
<span class="lineNum">    7738 </span><span class="lineCov">       2184 :   for (Int_t irow=0;irow&lt;20;irow++){</span>
<span class="lineNum">    7739 </span><span class="lineCov">       1040 :     FollowBackProlongation(*seed0, rows[irow]);</span>
<span class="lineNum">    7740 </span><span class="lineCov">       1040 :     FollowProlongation(*seed1,rows[19-irow]);       </span>
<span class="lineNum">    7741 </span><span class="lineCov">       1040 :     param0[irow] = *seed0;</span>
<span class="lineNum">    7742 </span><span class="lineCov">       1040 :     param1[19-irow] = *seed1;</span>
<span class="lineNum">    7743 </span>            :   }
<span class="lineNum">    7744 </span>            :   //
<span class="lineNum">    7745 </span>            :   // define kinks 
<span class="lineNum">    7746 </span><span class="lineCov">       2080 :   for (Int_t irow=0; irow&lt;19;irow++){</span>
<span class="lineNum">    7747 </span><span class="lineCov">        988 :     kinks[irow].SetMother(param0[irow]);</span>
<span class="lineNum">    7748 </span><span class="lineCov">        988 :     kinks[irow].SetDaughter(param1[irow]);</span>
<span class="lineNum">    7749 </span><span class="lineCov">        988 :     kinks[irow].Update();</span>
<span class="lineNum">    7750 </span>            :   }
<span class="lineNum">    7751 </span>            :   //
<span class="lineNum">    7752 </span>            :   // choose kink with biggest change of angle
<span class="lineNum">    7753 </span>            :   Int_t index =-1;
<span class="lineNum">    7754 </span>            :   Double_t maxchange= 0;
<span class="lineNum">    7755 </span><span class="lineCov">       1976 :   for (Int_t irow=1;irow&lt;19;irow++){</span>
<span class="lineNum">    7756 </span><span class="lineCov">        936 :     if (TMath::Abs(kinks[irow].GetR())&gt;240.) continue;</span>
<span class="lineNum">    7757 </span><span class="lineCov">        906 :     if (TMath::Abs(kinks[irow].GetR())&lt;110.) continue;</span>
<span class="lineNum">    7758 </span><span class="lineCov">       1412 :     Float_t quality = TMath::Abs(kinks[irow].GetAngle(2))/(3.+TMath::Abs(kinks[irow].GetR()-param0[irow].GetX()));</span>
<span class="lineNum">    7759 </span><span class="lineCov">        706 :     if ( quality &gt; maxchange){</span>
<span class="lineNum">    7760 </span>            :       maxchange = quality;
<span class="lineNum">    7761 </span>            :       index = irow;
<span class="lineNum">    7762 </span>            :       //
<span class="lineNum">    7763 </span><span class="lineCov">        258 :     }</span>
<span class="lineNum">    7764 </span><span class="lineCov">        706 :   }</span>
<span class="lineNum">    7765 </span><span class="lineCov">         52 :   MarkSeedFree( seed0 );</span>
<span class="lineNum">    7766 </span><span class="lineCov">         52 :   MarkSeedFree( seed1 );</span>
<span class="lineNum">    7767 </span><span class="lineCov">         52 :   if (index&lt;0) return 0;</span>
<span class="lineNum">    7768 </span>            :   //
<span class="lineNum">    7769 </span><span class="lineCov">         52 :   Int_t row0    = GetRowNumber(kinks[index].GetR());   //row 0 estimate</span>
<span class="lineNum">    7770 </span><span class="lineCov">        156 :   seed0 = new( NextFreeSeed() ) AliTPCseed(param0[index]);</span>
<span class="lineNum">    7771 </span><span class="lineCov">         52 :   seed0-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    7772 </span><span class="lineCov">        156 :   seed1 = new( NextFreeSeed() ) AliTPCseed(param1[index]);</span>
<span class="lineNum">    7773 </span><span class="lineCov">         52 :   seed1-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    7774 </span><span class="lineCov">         52 :   seed0-&gt;Reset(kFALSE);</span>
<span class="lineNum">    7775 </span><span class="lineCov">         52 :   seed1-&gt;Reset(kFALSE);</span>
<span class="lineNum">    7776 </span><span class="lineCov">         52 :   seed0-&gt;ResetCovariance(10.);</span>
<span class="lineNum">    7777 </span><span class="lineCov">         52 :   seed1-&gt;ResetCovariance(10.);</span>
<span class="lineNum">    7778 </span><span class="lineCov">         52 :   FollowProlongation(*seed0,0);</span>
<span class="lineNum">    7779 </span><span class="lineCov">         52 :   FollowBackProlongation(*seed1,158);</span>
<span class="lineNum">    7780 </span><span class="lineCov">         52 :   mother = *seed0; // backup mother at position 0</span>
<span class="lineNum">    7781 </span><span class="lineCov">         52 :   seed0-&gt;Reset(kFALSE);  </span>
<span class="lineNum">    7782 </span><span class="lineCov">         52 :   seed1-&gt;Reset(kFALSE);</span>
<span class="lineNum">    7783 </span><span class="lineCov">         52 :   seed0-&gt;ResetCovariance(10.);</span>
<span class="lineNum">    7784 </span><span class="lineCov">         52 :   seed1-&gt;ResetCovariance(10.);</span>
<span class="lineNum">    7785 </span>            :   //
<span class="lineNum">    7786 </span><span class="lineCov">         52 :   first = TMath::Max(row0-20,0);</span>
<span class="lineNum">    7787 </span><span class="lineCov">         52 :   last  = TMath::Min(row0+20,158);</span>
<span class="lineNum">    7788 </span>            :   //
<span class="lineNum">    7789 </span><span class="lineCov">       2184 :   for (Int_t irow=0; irow&lt;20;irow++){</span>
<span class="lineNum">    7790 </span><span class="lineCov">       1040 :     rows[irow] = first +((last-first)*irow)/19;</span>
<span class="lineNum">    7791 </span>            :   }
<span class="lineNum">    7792 </span>            :   // store parameters along the track
<span class="lineNum">    7793 </span>            :   //
<span class="lineNum">    7794 </span><span class="lineCov">       2184 :   for (Int_t irow=0;irow&lt;20;irow++){</span>
<span class="lineNum">    7795 </span><span class="lineCov">       1040 :     FollowBackProlongation(*seed0, rows[irow]);</span>
<span class="lineNum">    7796 </span><span class="lineCov">       1040 :     FollowProlongation(*seed1,rows[19-irow]);       </span>
<span class="lineNum">    7797 </span><span class="lineCov">       1040 :     param0[irow] = *seed0;</span>
<span class="lineNum">    7798 </span><span class="lineCov">       1040 :     param1[19-irow] = *seed1;</span>
<span class="lineNum">    7799 </span>            :   }
<span class="lineNum">    7800 </span>            :   //
<span class="lineNum">    7801 </span>            :   // define kinks 
<span class="lineNum">    7802 </span><span class="lineCov">       2080 :   for (Int_t irow=0; irow&lt;19;irow++){</span>
<span class="lineNum">    7803 </span><span class="lineCov">        988 :     kinks[irow].SetMother(param0[irow]);</span>
<span class="lineNum">    7804 </span><span class="lineCov">        988 :     kinks[irow].SetDaughter(param1[irow]);</span>
<span class="lineNum">    7805 </span>            :     //    param0[irow].Dump();
<span class="lineNum">    7806 </span>            :     //param1[irow].Dump();
<span class="lineNum">    7807 </span><span class="lineCov">        988 :     kinks[irow].Update();</span>
<span class="lineNum">    7808 </span>            :   }
<span class="lineNum">    7809 </span>            :   //
<span class="lineNum">    7810 </span>            :   // choose kink with biggest change of angle
<span class="lineNum">    7811 </span>            :   index =-1;
<span class="lineNum">    7812 </span>            :   maxchange= 0;
<span class="lineNum">    7813 </span><span class="lineCov">       2184 :   for (Int_t irow=0;irow&lt;20;irow++){</span>
<span class="lineNum">    7814 </span><span class="lineCov">       1040 :     if (TMath::Abs(kinks[irow].GetR())&gt;250.) continue;</span>
<span class="lineNum">    7815 </span><span class="lineCov">       1012 :     if (TMath::Abs(kinks[irow].GetR())&lt;90.) continue;</span>
<span class="lineNum">    7816 </span><span class="lineCov">       1748 :     Float_t quality = TMath::Abs(kinks[irow].GetAngle(2))/(3.+TMath::Abs(kinks[irow].GetR()-param0[irow].GetX()));</span>
<span class="lineNum">    7817 </span><span class="lineCov">        874 :     if ( quality &gt; maxchange){</span>
<span class="lineNum">    7818 </span>            :       maxchange = quality;
<span class="lineNum">    7819 </span>            :       index = irow;
<span class="lineNum">    7820 </span>            :       //
<span class="lineNum">    7821 </span><span class="lineCov">        266 :     }</span>
<span class="lineNum">    7822 </span><span class="lineCov">        874 :   }</span>
<span class="lineNum">    7823 </span>            :   //
<span class="lineNum">    7824 </span>            :   //
<span class="lineNum">    7825 </span><span class="lineCov">        208 :   if (index==-1 || param0[index].GetNumberOfClusters()+param1[index].GetNumberOfClusters()&lt;100){</span>
<span class="lineNum">    7826 </span><span class="lineNoCov">          0 :     MarkSeedFree( seed0 );</span>
<span class="lineNum">    7827 </span><span class="lineNoCov">          0 :     MarkSeedFree( seed1 );</span>
<span class="lineNum">    7828 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">    7829 </span>            :   }
<span class="lineNum">    7830 </span>            : 
<span class="lineNum">    7831 </span>            :   //  Float_t anglesigma = TMath::Sqrt(param0[index].fC22+param0[index].fC33+param1[index].fC22+param1[index].fC33);
<span class="lineNum">    7832 </span>            :   
<span class="lineNum">    7833 </span><span class="lineCov">         52 :   kink.SetMother(param0[index]);</span>
<span class="lineNum">    7834 </span><span class="lineCov">         52 :   kink.SetDaughter(param1[index]);</span>
<span class="lineNum">    7835 </span><span class="lineCov">         52 :   kink.Update();</span>
<span class="lineNum">    7836 </span>            : 
<span class="lineNum">    7837 </span><span class="lineCov">        156 :   Double_t chi2P2 = param0[index].GetParameter()[2]-param1[index].GetParameter()[2];</span>
<span class="lineNum">    7838 </span><span class="lineCov">         52 :   chi2P2*=chi2P2;</span>
<span class="lineNum">    7839 </span><span class="lineCov">         52 :   chi2P2/=param0[index].GetCovariance()[5]+param1[index].GetCovariance()[5];</span>
<span class="lineNum">    7840 </span><span class="lineCov">        156 :   Double_t chi2P3 = param0[index].GetParameter()[3]-param1[index].GetParameter()[3];</span>
<span class="lineNum">    7841 </span><span class="lineCov">         52 :   chi2P3*=chi2P3;</span>
<span class="lineNum">    7842 </span><span class="lineCov">         52 :   chi2P3/=param0[index].GetCovariance()[9]+param1[index].GetCovariance()[9];</span>
<span class="lineNum">    7843 </span>            :   //
<span class="lineNum">    7844 </span><span class="lineCov">         52 :   if (AliTPCReconstructor::StreamLevel()&amp;kStreamFindKinks) { // flag: stream track infroamtion in the FindKinks method</span>
<span class="lineNum">    7845 </span><span class="lineNoCov">          0 :     (*fDebugStreamer)&lt;&lt;&quot;kinkHpt&quot;&lt;&lt;</span>
<span class="lineNum">    7846 </span><span class="lineNoCov">          0 :       &quot;chi2P2=&quot;&lt;&lt;chi2P2&lt;&lt;</span>
<span class="lineNum">    7847 </span><span class="lineNoCov">          0 :       &quot;chi2P3=&quot;&lt;&lt;chi2P3&lt;&lt;</span>
<span class="lineNum">    7848 </span><span class="lineNoCov">          0 :       &quot;p0.=&quot;&lt;&lt;&amp;param0[index]&lt;&lt;</span>
<span class="lineNum">    7849 </span><span class="lineNoCov">          0 :       &quot;p1.=&quot;&lt;&lt;&amp;param1[index]&lt;&lt;</span>
<span class="lineNum">    7850 </span><span class="lineNoCov">          0 :       &quot;k.=&quot;&lt;&lt;&amp;kink&lt;&lt;</span>
<span class="lineNum">    7851 </span>            :       &quot;\n&quot;;
<span class="lineNum">    7852 </span>            :   }
<span class="lineNum">    7853 </span><span class="lineCov">        104 :   if ( chi2P2+chi2P3&lt;AliTPCReconstructor::GetRecoParam()-&gt;GetKinkAngleCutChi2(0)){</span>
<span class="lineNum">    7854 </span><span class="lineCov">         40 :     MarkSeedFree( seed0 );</span>
<span class="lineNum">    7855 </span><span class="lineCov">         40 :     MarkSeedFree( seed1 );</span>
<span class="lineNum">    7856 </span><span class="lineCov">         40 :     return 0; </span>
<span class="lineNum">    7857 </span>            :   }
<span class="lineNum">    7858 </span>            : 
<span class="lineNum">    7859 </span>            : 
<span class="lineNum">    7860 </span><span class="lineCov">         12 :   row0    = GetRowNumber(kink.GetR());   </span>
<span class="lineNum">    7861 </span><span class="lineCov">         12 :   kink.SetTPCRow0(row0);</span>
<span class="lineNum">    7862 </span><span class="lineCov">         24 :   kink.SetLabel(CookLabel(seed0,0.5,0,row0),0);</span>
<span class="lineNum">    7863 </span><span class="lineCov">         24 :   kink.SetLabel(CookLabel(seed1,0.5,row0,158),1);</span>
<span class="lineNum">    7864 </span><span class="lineCov">         12 :   kink.SetIndex(-10,0);</span>
<span class="lineNum">    7865 </span><span class="lineCov">         36 :   kink.SetIndex(int(param0[index].GetNumberOfClusters()+param1[index].GetNumberOfClusters()),1);</span>
<span class="lineNum">    7866 </span><span class="lineCov">         24 :   kink.SetTPCncls(param0[index].GetNumberOfClusters(),0);</span>
<span class="lineNum">    7867 </span><span class="lineCov">         24 :   kink.SetTPCncls(param1[index].GetNumberOfClusters(),1);</span>
<span class="lineNum">    7868 </span>            :   //
<span class="lineNum">    7869 </span>            :   //
<span class="lineNum">    7870 </span>            :   //  new (&amp;mother) AliTPCseed(param0[index]);
<span class="lineNum">    7871 </span><span class="lineCov">         12 :   daughter = param1[index];</span>
<span class="lineNum">    7872 </span><span class="lineCov">         12 :   daughter.SetLabel(kink.GetLabel(1));  </span>
<span class="lineNum">    7873 </span><span class="lineCov">         12 :   param0[index].Reset(kTRUE);</span>
<span class="lineNum">    7874 </span><span class="lineCov">         12 :   FollowProlongation(param0[index],0);    </span>
<span class="lineNum">    7875 </span><span class="lineCov">         12 :   mother = param0[index];</span>
<span class="lineNum">    7876 </span><span class="lineCov">         12 :   mother.SetLabel(kink.GetLabel(0));</span>
<span class="lineNum">    7877 </span><span class="lineCov">         24 :   if ( chi2P2+chi2P3&lt;AliTPCReconstructor::GetRecoParam()-&gt;GetKinkAngleCutChi2(1)){</span>
<span class="lineNum">    7878 </span><span class="lineNoCov">          0 :     mother=*seed;</span>
<span class="lineNum">    7879 </span>            :   }
<span class="lineNum">    7880 </span><span class="lineCov">         12 :   MarkSeedFree( seed0 );</span>
<span class="lineNum">    7881 </span><span class="lineCov">         12 :   MarkSeedFree( seed1 );</span>
<span class="lineNum">    7882 </span>            :   //
<span class="lineNum">    7883 </span><span class="lineCov">         12 :   return 1;</span>
<span class="lineNum">    7884 </span><span class="lineCov">       3432 : }</span>
<span class="lineNum">    7885 </span>            : 
<span class="lineNum">    7886 </span>            : 
<a name="7887"><span class="lineNum">    7887 </span>            : </a>
<span class="lineNum">    7888 </span>            : 
<span class="lineNum">    7889 </span>            : AliTPCseed*  AliTPCtracker::ReSeed(AliTPCseed *t)
<span class="lineNum">    7890 </span>            : {
<span class="lineNum">    7891 </span>            :   //
<span class="lineNum">    7892 </span>            :   // reseed - refit -  track
<span class="lineNum">    7893 </span>            :   //
<span class="lineNum">    7894 </span>            :   Int_t first = 0;
<span class="lineNum">    7895 </span>            :   //  Int_t last  = fSectors-&gt;GetNRows()-1;
<span class="lineNum">    7896 </span>            :   //
<span class="lineNum">    7897 </span><span class="lineNoCov">          0 :   if (fSectors == fOuterSec){</span>
<span class="lineNum">    7898 </span><span class="lineNoCov">          0 :     first = TMath::Max(first, t-&gt;GetFirstPoint()-fInnerSec-&gt;GetNRows());</span>
<span class="lineNum">    7899 </span>            :     //last  = 
<span class="lineNum">    7900 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    7901 </span>            :   else
<span class="lineNum">    7902 </span><span class="lineNoCov">          0 :     first = t-&gt;GetFirstPoint();</span>
<span class="lineNum">    7903 </span>            :   //
<span class="lineNum">    7904 </span><span class="lineNoCov">          0 :   AliTPCseed * seed = MakeSeed(t,0.1,0.5,0.9);</span>
<span class="lineNum">    7905 </span><span class="lineNoCov">          0 :   FollowBackProlongation(*t,fSectors-&gt;GetNRows()-1);</span>
<span class="lineNum">    7906 </span><span class="lineNoCov">          0 :   t-&gt;Reset(kFALSE);</span>
<span class="lineNum">    7907 </span><span class="lineNoCov">          0 :   FollowProlongation(*t,first);</span>
<span class="lineNum">    7908 </span><span class="lineNoCov">          0 :   return seed;</span>
<span class="lineNum">    7909 </span>            : }
<span class="lineNum">    7910 </span>            : 
<span class="lineNum">    7911 </span>            : 
<span class="lineNum">    7912 </span>            : 
<span class="lineNum">    7913 </span>            : 
<span class="lineNum">    7914 </span>            : 
<span class="lineNum">    7915 </span>            : 
<a name="7916"><span class="lineNum">    7916 </span>            : </a>
<span class="lineNum">    7917 </span>            : //_____________________________________________________________________________
<span class="lineNum">    7918 </span>            : Int_t AliTPCtracker::ReadSeeds(const TFile *inp) {
<span class="lineNum">    7919 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    7920 </span>            :   // This function reades track seeds.
<span class="lineNum">    7921 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    7922 </span><span class="lineNoCov">          0 :   TDirectory *savedir=gDirectory; </span>
<span class="lineNum">    7923 </span>            : 
<span class="lineNum">    7924 </span>            :   TFile *in=(TFile*)inp;
<span class="lineNum">    7925 </span><span class="lineNoCov">          0 :   if (!in-&gt;IsOpen()) {</span>
<span class="lineNum">    7926 </span><span class="lineNoCov">          0 :      cerr&lt;&lt;&quot;AliTPCtracker::ReadSeeds(): input file is not open !\n&quot;;</span>
<span class="lineNum">    7927 </span><span class="lineNoCov">          0 :      return 1;</span>
<span class="lineNum">    7928 </span>            :   }
<span class="lineNum">    7929 </span>            : 
<span class="lineNum">    7930 </span><span class="lineNoCov">          0 :   in-&gt;cd();</span>
<span class="lineNum">    7931 </span><span class="lineNoCov">          0 :   TTree *seedTree=(TTree*)in-&gt;Get(&quot;Seeds&quot;);</span>
<span class="lineNum">    7932 </span><span class="lineNoCov">          0 :   if (!seedTree) {</span>
<span class="lineNum">    7933 </span><span class="lineNoCov">          0 :      cerr&lt;&lt;&quot;AliTPCtracker::ReadSeeds(): &quot;;</span>
<span class="lineNum">    7934 </span><span class="lineNoCov">          0 :      cerr&lt;&lt;&quot;can't get a tree with track seeds !\n&quot;;</span>
<span class="lineNum">    7935 </span><span class="lineNoCov">          0 :      return 2;</span>
<span class="lineNum">    7936 </span>            :   }
<span class="lineNum">    7937 </span><span class="lineNoCov">          0 :   AliTPCtrack *seed=new AliTPCtrack; </span>
<span class="lineNum">    7938 </span><span class="lineNoCov">          0 :   seedTree-&gt;SetBranchAddress(&quot;tracks&quot;,&amp;seed);</span>
<span class="lineNum">    7939 </span>            :   
<span class="lineNum">    7940 </span><span class="lineNoCov">          0 :   if (fSeeds==0) fSeeds=new TObjArray(15000);</span>
<span class="lineNum">    7941 </span>            : 
<span class="lineNum">    7942 </span><span class="lineNoCov">          0 :   Int_t n=(Int_t)seedTree-&gt;GetEntries();</span>
<span class="lineNum">    7943 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;n; i++) {</span>
<span class="lineNum">    7944 </span><span class="lineNoCov">          0 :      seedTree-&gt;GetEvent(i);</span>
<span class="lineNum">    7945 </span><span class="lineNoCov">          0 :      AliTPCseed* sdc = new( NextFreeSeed() ) AliTPCseed(*seed/*,seed-&gt;GetAlpha()*/);</span>
<span class="lineNum">    7946 </span><span class="lineNoCov">          0 :      sdc-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    7947 </span><span class="lineNoCov">          0 :      fSeeds-&gt;AddLast(sdc);</span>
<span class="lineNum">    7948 </span>            :   }
<span class="lineNum">    7949 </span>            :   
<span class="lineNum">    7950 </span><span class="lineNoCov">          0 :   delete seed; // RS: this seed is not from the pool, delete it !!!</span>
<span class="lineNum">    7951 </span><span class="lineNoCov">          0 :   delete seedTree; </span>
<span class="lineNum">    7952 </span><span class="lineNoCov">          0 :   savedir-&gt;cd();</span>
<span class="lineNum">    7953 </span>            :   return 0;
<a name="7954"><span class="lineNum">    7954 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    7955 </span>            : 
<span class="lineNum">    7956 </span>            : Int_t AliTPCtracker::Clusters2TracksHLT (AliESDEvent *const esd, const AliESDEvent *hltEvent)
<span class="lineNum">    7957 </span>            : {
<span class="lineNum">    7958 </span>            :   //
<span class="lineNum">    7959 </span>            :   // clusters to tracks
<span class="lineNum">    7960 </span><span class="lineCov">         22 :   if (fSeeds) DeleteSeeds();</span>
<span class="lineNum">    7961 </span><span class="lineCov">          2 :   else ResetSeedsPool();</span>
<span class="lineNum">    7962 </span><span class="lineCov">          8 :   fEvent = esd; </span>
<span class="lineNum">    7963 </span><span class="lineCov">          8 :   fEventHLT = hltEvent;</span>
<span class="lineNum">    7964 </span><span class="lineCov">          8 :   fAccountDistortions = AliTPCReconstructor::GetRecoParam()-&gt;GetAccountDistortions();</span>
<span class="lineNum">    7965 </span><span class="lineCov">          8 :   if (AliTPCReconstructor::GetRecoParam()-&gt;GetUseOulierClusterFilter()) FilterOutlierClusters();  </span>
<span class="lineNum">    7966 </span><span class="lineCov">          8 :   AliTPCTransform *transform = AliTPCcalibDB::Instance()-&gt;GetTransform() ;  </span>
<span class="lineNum">    7967 </span><span class="lineCov">          8 :   transform-&gt;SetCurrentRecoParam((AliTPCRecoParam*)AliTPCReconstructor::GetRecoParam());</span>
<span class="lineNum">    7968 </span><span class="lineCov">          8 :   transform-&gt;SetCurrentTimeStamp( GetTimeStamp());</span>
<span class="lineNum">    7969 </span><span class="lineCov">          8 :   transform-&gt;SetCurrentRun( GetRunNumber());</span>
<span class="lineNum">    7970 </span>            : 
<span class="lineNum">    7971 </span>            :   //transform-&gt;SetCurrentTimeStamp( esd-&gt;GetTimeStamp());
<span class="lineNum">    7972 </span>            :   //transform-&gt;SetCurrentRun(esd-&gt;GetRunNumber());
<span class="lineNum">    7973 </span>            :   //
<span class="lineNum">    7974 </span><span class="lineCov">          8 :   if (AliTPCReconstructor::GetExtendedRoads()){</span>
<span class="lineNum">    7975 </span><span class="lineNoCov">          0 :     fClExtraRoadY = AliTPCReconstructor::GetExtendedRoads()[0];</span>
<span class="lineNum">    7976 </span><span class="lineNoCov">          0 :     fClExtraRoadZ = AliTPCReconstructor::GetExtendedRoads()[1];</span>
<span class="lineNum">    7977 </span><span class="lineNoCov">          0 :     AliInfoF(&quot;Additional errors for roads: Y:%f Z:%f&quot;,fClExtraRoadY,fClExtraRoadZ);</span>
<span class="lineNum">    7978 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    7979 </span><span class="lineCov">         24 :   const Double_t *errCluster = (AliTPCReconstructor::GetSystematicErrorCluster()) ?  </span>
<span class="lineNum">    7980 </span><span class="lineNoCov">          0 :     AliTPCReconstructor::GetSystematicErrorCluster() : </span>
<span class="lineNum">    7981 </span><span class="lineCov">          8 :     AliTPCReconstructor::GetRecoParam()-&gt;GetSystematicErrorCluster();</span>
<span class="lineNum">    7982 </span>            :   //
<span class="lineNum">    7983 </span><span class="lineCov">          8 :   fExtraClErrY2 = errCluster[0]*errCluster[0];</span>
<span class="lineNum">    7984 </span><span class="lineCov">          8 :   fExtraClErrZ2 = errCluster[1]*errCluster[1];</span>
<span class="lineNum">    7985 </span><span class="lineCov">          8 :   fExtraClErrYZ2 = fExtraClErrY2 + fExtraClErrZ2;</span>
<span class="lineNum">    7986 </span><span class="lineCov">         40 :   AliInfoF(&quot;Additional errors for clusters: Y:%f Z:%f&quot;,errCluster[0],errCluster[1]);</span>
<span class="lineNum">    7987 </span>            :   //
<span class="lineNum">    7988 </span><span class="lineCov">          8 :   if (AliTPCReconstructor::GetPrimaryDCACut()) {</span>
<span class="lineNum">    7989 </span><span class="lineNoCov">          0 :     fPrimaryDCAYCut = AliTPCReconstructor::GetPrimaryDCACut()[0];</span>
<span class="lineNum">    7990 </span><span class="lineNoCov">          0 :     fPrimaryDCAZCut = AliTPCReconstructor::GetPrimaryDCACut()[1];</span>
<span class="lineNum">    7991 </span><span class="lineNoCov">          0 :     fDisableSecondaries = kTRUE;</span>
<span class="lineNum">    7992 </span><span class="lineNoCov">          0 :     AliInfoF(&quot;Only primaries will be tracked with DCAY=%f and DCAZ=%f cuts&quot;,fPrimaryDCAYCut,fPrimaryDCAZCut);</span>
<span class="lineNum">    7993 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    7994 </span>            :   //
<span class="lineNum">    7995 </span><span class="lineCov">          8 :   Clusters2Tracks();</span>
<span class="lineNum">    7996 </span><span class="lineCov">          8 :   fEventHLT = 0;</span>
<span class="lineNum">    7997 </span><span class="lineCov">          8 :   if (!fSeeds) return 1;</span>
<span class="lineNum">    7998 </span><span class="lineCov">          8 :   FillESD(fSeeds);</span>
<span class="lineNum">    7999 </span><span class="lineCov">          8 :   if ((AliTPCReconstructor::StreamLevel()&amp;kStreamClDump)&gt;0)  DumpClusters(0,fSeeds);</span>
<span class="lineNum">    8000 </span><span class="lineCov">          8 :   return 0;</span>
<span class="lineNum">    8001 </span>            :   //
<a name="8002"><span class="lineNum">    8002 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">    8003 </span>            : 
<span class="lineNum">    8004 </span>            : Int_t AliTPCtracker::Clusters2Tracks(AliESDEvent *const esd)
<span class="lineNum">    8005 </span>            : {
<span class="lineNum">    8006 </span>            :   //
<span class="lineNum">    8007 </span>            :   // clusters to tracks
<span class="lineNum">    8008 </span><span class="lineNoCov">          0 :   return Clusters2TracksHLT( esd, 0);</span>
<span class="lineNum">    8009 </span>            : }
<a name="8010"><span class="lineNum">    8010 </span>            : </a>
<span class="lineNum">    8011 </span>            : //_____________________________________________________________________________
<span class="lineNum">    8012 </span>            : Int_t AliTPCtracker::Clusters2Tracks() {
<span class="lineNum">    8013 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    8014 </span>            :   // This is a track finder.
<span class="lineNum">    8015 </span>            :   //-----------------------------------------------------------------
<span class="lineNum">    8016 </span><span class="lineCov">         16 :   TDirectory *savedir=gDirectory; </span>
<span class="lineNum">    8017 </span><span class="lineCov">          8 :   TStopwatch timer;</span>
<span class="lineNum">    8018 </span>            : 
<span class="lineNum">    8019 </span><span class="lineCov">          8 :   fIteration = 0;</span>
<span class="lineNum">    8020 </span><span class="lineCov">         16 :   fSeeds = Tracking();</span>
<span class="lineNum">    8021 </span>            : 
<span class="lineNum">    8022 </span><span class="lineCov">          8 :   if (fDebug&gt;0){</span>
<span class="lineNum">    8023 </span><span class="lineNoCov">          0 :     Info(&quot;Clusters2Tracks&quot;,&quot;Time for tracking: \t&quot;);timer.Print();timer.Start();</span>
<span class="lineNum">    8024 </span>            :   }
<span class="lineNum">    8025 </span>            :   //activate again some tracks
<span class="lineNum">    8026 </span><span class="lineCov">        864 :   for (Int_t i=0; i&lt;fSeeds-&gt;GetEntriesFast(); i++) {</span>
<span class="lineNum">    8027 </span><span class="lineCov">        280 :     AliTPCseed *pt=(AliTPCseed*)fSeeds-&gt;UncheckedAt(i), &amp;t=*pt;    </span>
<span class="lineNum">    8028 </span><span class="lineCov">        280 :     if (!pt) continue;    </span>
<span class="lineNum">    8029 </span><span class="lineCov">        280 :     Int_t nc=t.GetNumberOfClusters();</span>
<span class="lineNum">    8030 </span><span class="lineCov">        280 :     if (nc&lt;20) {</span>
<span class="lineNum">    8031 </span><span class="lineNoCov">          0 :       MarkSeedFree( fSeeds-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8032 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    8033 </span>            :     } 
<span class="lineNum">    8034 </span><span class="lineCov">        280 :     CookLabel(pt,0.1);</span>
<span class="lineNum">    8035 </span><span class="lineCov">        280 :     if (pt-&gt;GetRemoval()==10) {</span>
<span class="lineNum">    8036 </span><span class="lineCov">         12 :       if (pt-&gt;GetDensityFirst(20)&gt;0.8 || pt-&gt;GetDensityFirst(30)&gt;0.8 || pt-&gt;GetDensityFirst(40)&gt;0.7)</span>
<span class="lineNum">    8037 </span><span class="lineCov">          6 :         pt-&gt;Desactivate(10);  // make track again active  // MvL: should be 0 ?</span>
<span class="lineNum">    8038 </span>            :       else{
<span class="lineNum">    8039 </span><span class="lineNoCov">          0 :         pt-&gt;Desactivate(20);         </span>
<span class="lineNum">    8040 </span><span class="lineNoCov">          0 :         MarkSeedFree( fSeeds-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8041 </span>            :       }
<span class="lineNum">    8042 </span>            :     } 
<span class="lineNum">    8043 </span><span class="lineCov">        280 :   }</span>
<span class="lineNum">    8044 </span>            :   //
<span class="lineNum">    8045 </span><span class="lineCov">          8 :   RemoveUsed2(fSeeds,0.85,0.85,0);</span>
<span class="lineNum">    8046 </span><span class="lineCov">         24 :   if (AliTPCReconstructor::GetRecoParam()-&gt;GetDoKinks()) FindKinks(fSeeds,fEvent);</span>
<span class="lineNum">    8047 </span>            :   //FindCurling(fSeeds, fEvent,0);  
<span class="lineNum">    8048 </span><span class="lineCov">          8 :   if (AliTPCReconstructor::StreamLevel()&amp;kStreamFindMultiMC)  FindMultiMC(fSeeds, fEvent,-1); // find multi found tracks</span>
<span class="lineNum">    8049 </span><span class="lineCov">          8 :   RemoveUsed2(fSeeds,0.5,0.4,20);</span>
<span class="lineNum">    8050 </span><span class="lineCov">          8 :   FindSplitted(fSeeds, fEvent,0); // find multi found tracks</span>
<span class="lineNum">    8051 </span><span class="lineCov">          8 :   if (AliTPCReconstructor::StreamLevel()&amp;kStreamFindMultiMC)  FindMultiMC(fSeeds, fEvent,0); // find multi found tracks</span>
<span class="lineNum">    8052 </span>            : 
<span class="lineNum">    8053 </span>            :  //  //
<span class="lineNum">    8054 </span>            : //   // refit short tracks
<span class="lineNum">    8055 </span>            : //   //
<span class="lineNum">    8056 </span><span class="lineCov">          8 :   Int_t nseed=fSeeds-&gt;GetEntriesFast();</span>
<span class="lineNum">    8057 </span>            :   //
<span class="lineNum">    8058 </span>            :   Int_t found = 0;
<span class="lineNum">    8059 </span><span class="lineCov">        532 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    8060 </span><span class="lineCov">        258 :     AliTPCseed *pt=(AliTPCseed*)fSeeds-&gt;UncheckedAt(i), &amp;t=*pt;    </span>
<span class="lineNum">    8061 </span><span class="lineCov">        380 :     if (!pt) continue;    </span>
<span class="lineNum">    8062 </span><span class="lineCov">        136 :     Int_t nc=t.GetNumberOfClusters();</span>
<span class="lineNum">    8063 </span><span class="lineCov">        136 :     if (nc&lt;15) {</span>
<span class="lineNum">    8064 </span><span class="lineNoCov">          0 :       MarkSeedFree( fSeeds-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8065 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    8066 </span>            :     }
<span class="lineNum">    8067 </span><span class="lineCov">        136 :     CookLabel(pt,0.1); //For comparison only</span>
<span class="lineNum">    8068 </span>            :     //if ((pt-&gt;IsActive() || (pt-&gt;fRemoval==10) )&amp;&amp; nc&gt;50 &amp;&amp;pt-&gt;GetNumberOfClusters()&gt;0.4*pt-&gt;fNFoundable){
<span class="lineNum">    8069 </span><span class="lineCov">        136 :     if ((pt-&gt;IsActive() || (pt-&gt;GetRemoval()==10) )){</span>
<span class="lineNum">    8070 </span><span class="lineCov">        136 :       found++;      </span>
<span class="lineNum">    8071 </span><span class="lineCov">        136 :       if (fDebug&gt;0) cerr&lt;&lt;found&lt;&lt;'\r';      </span>
<span class="lineNum">    8072 </span><span class="lineCov">        136 :       pt-&gt;SetLab2(i);</span>
<span class="lineNum">    8073 </span><span class="lineCov">        136 :     }</span>
<span class="lineNum">    8074 </span>            :     else
<span class="lineNum">    8075 </span><span class="lineNoCov">          0 :       MarkSeedFree( fSeeds-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8076 </span><span class="lineCov">        136 :   }</span>
<span class="lineNum">    8077 </span>            : 
<span class="lineNum">    8078 </span>            :   
<span class="lineNum">    8079 </span>            :   //RemoveOverlap(fSeeds,0.99,7,kTRUE);  
<span class="lineNum">    8080 </span><span class="lineCov">          8 :   SignShared(fSeeds);  </span>
<span class="lineNum">    8081 </span>            :   //RemoveUsed(fSeeds,0.9,0.9,6);
<span class="lineNum">    8082 </span>            :   // 
<span class="lineNum">    8083 </span><span class="lineCov">          8 :   nseed=fSeeds-&gt;GetEntriesFast();</span>
<span class="lineNum">    8084 </span>            :   found = 0;
<span class="lineNum">    8085 </span><span class="lineCov">        288 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    8086 </span><span class="lineCov">        136 :     AliTPCseed *pt=(AliTPCseed*)fSeeds-&gt;UncheckedAt(i), &amp;t=*pt;    </span>
<span class="lineNum">    8087 </span><span class="lineCov">        136 :     if (!pt) continue;    </span>
<span class="lineNum">    8088 </span><span class="lineCov">        136 :     Int_t nc=t.GetNumberOfClusters();</span>
<span class="lineNum">    8089 </span><span class="lineCov">        136 :     if (nc&lt;15) {</span>
<span class="lineNum">    8090 </span><span class="lineNoCov">          0 :       MarkSeedFree( fSeeds-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8091 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    8092 </span>            :     }
<span class="lineNum">    8093 </span><span class="lineCov">        136 :     t.SetUniqueID(i);</span>
<span class="lineNum">    8094 </span><span class="lineCov">        136 :     t.CookdEdx(0.02,0.6);</span>
<span class="lineNum">    8095 </span>            :     //    CheckKinkPoint(&amp;t,0.05);
<span class="lineNum">    8096 </span>            :     //if ((pt-&gt;IsActive() || (pt-&gt;fRemoval==10) )&amp;&amp; nc&gt;50 &amp;&amp;pt-&gt;GetNumberOfClusters()&gt;0.4*pt-&gt;fNFoundable){
<span class="lineNum">    8097 </span><span class="lineCov">        136 :     if ((pt-&gt;IsActive() || (pt-&gt;GetRemoval()==10) )){</span>
<span class="lineNum">    8098 </span><span class="lineCov">        136 :       found++;</span>
<span class="lineNum">    8099 </span><span class="lineCov">        136 :       if (fDebug&gt;0){</span>
<span class="lineNum">    8100 </span><span class="lineNoCov">          0 :         cerr&lt;&lt;found&lt;&lt;'\r';      </span>
<span class="lineNum">    8101 </span>            :       }
<span class="lineNum">    8102 </span><span class="lineCov">        136 :       pt-&gt;SetLab2(i);</span>
<span class="lineNum">    8103 </span><span class="lineCov">        136 :     }</span>
<span class="lineNum">    8104 </span>            :     else
<span class="lineNum">    8105 </span><span class="lineNoCov">          0 :       MarkSeedFree( fSeeds-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8106 </span>            :     //AliTPCseed * seed1 = ReSeed(pt,0.05,0.5,1);
<span class="lineNum">    8107 </span>            :     //if (seed1){
<span class="lineNum">    8108 </span>            :     //  FollowProlongation(*seed1,0);
<span class="lineNum">    8109 </span>            :     //  Int_t n = seed1-&gt;GetNumberOfClusters();
<span class="lineNum">    8110 </span>            :     //  printf(&quot;fP4\t%f\t%f\n&quot;,seed1-&gt;GetC(),pt-&gt;GetC());
<span class="lineNum">    8111 </span>            :     //  printf(&quot;fN\t%d\t%d\n&quot;, seed1-&gt;GetNumberOfClusters(),pt-&gt;GetNumberOfClusters());
<span class="lineNum">    8112 </span>            :     //
<span class="lineNum">    8113 </span>            :     //}
<span class="lineNum">    8114 </span>            :     //AliTPCseed * seed2 = ReSeed(pt,0.95,0.5,0.05);
<span class="lineNum">    8115 </span>            :     
<span class="lineNum">    8116 </span><span class="lineCov">        136 :   }</span>
<span class="lineNum">    8117 </span>            : 
<span class="lineNum">    8118 </span><span class="lineCov">          8 :   SortTracks(fSeeds, 1);</span>
<span class="lineNum">    8119 </span>            :   
<span class="lineNum">    8120 </span>            :   /*    
<span class="lineNum">    8121 </span>            :   fIteration = 1;
<span class="lineNum">    8122 </span>            :   PrepareForBackProlongation(fSeeds,5.);
<span class="lineNum">    8123 </span>            :   PropagateBack(fSeeds);
<span class="lineNum">    8124 </span>            :   printf(&quot;Time for back propagation: \t&quot;);timer.Print();timer.Start();
<span class="lineNum">    8125 </span>            :   
<span class="lineNum">    8126 </span>            :   fIteration = 2;
<span class="lineNum">    8127 </span>            :   
<span class="lineNum">    8128 </span>            :   PrepareForProlongation(fSeeds,5.);
<span class="lineNum">    8129 </span>            :   PropagateForard2(fSeeds);
<span class="lineNum">    8130 </span>            :    
<span class="lineNum">    8131 </span>            :   printf(&quot;Time for FORWARD propagation: \t&quot;);timer.Print();timer.Start();
<span class="lineNum">    8132 </span>            :   // RemoveUsed(fSeeds,0.7,0.7,6);
<span class="lineNum">    8133 </span>            :   //RemoveOverlap(fSeeds,0.9,7,kTRUE);
<span class="lineNum">    8134 </span>            :    
<span class="lineNum">    8135 </span>            :   nseed=fSeeds-&gt;GetEntriesFast();
<span class="lineNum">    8136 </span>            :   found = 0;
<span class="lineNum">    8137 </span>            :   for (Int_t i=0; i&lt;nseed; i++) {
<span class="lineNum">    8138 </span>            :     AliTPCseed *pt=(AliTPCseed*)fSeeds-&gt;UncheckedAt(i), &amp;t=*pt;    
<span class="lineNum">    8139 </span>            :     if (!pt) continue;    
<span class="lineNum">    8140 </span>            :     Int_t nc=t.GetNumberOfClusters();
<span class="lineNum">    8141 </span>            :     if (nc&lt;15) {
<span class="lineNum">    8142 </span>            :       MarkSeedFree( fSeeds-&gt;RemoveAt(i) );
<span class="lineNum">    8143 </span>            :       continue;
<span class="lineNum">    8144 </span>            :     }
<span class="lineNum">    8145 </span>            :     t.CookdEdx(0.02,0.6);
<span class="lineNum">    8146 </span>            :     //    CookLabel(pt,0.1); //For comparison only
<span class="lineNum">    8147 </span>            :     //if ((pt-&gt;IsActive() || (pt-&gt;fRemoval==10) )&amp;&amp; nc&gt;50 &amp;&amp;pt-&gt;GetNumberOfClusters()&gt;0.4*pt-&gt;fNFoundable){
<span class="lineNum">    8148 </span>            :     if ((pt-&gt;IsActive() || (pt-&gt;fRemoval==10) )){
<span class="lineNum">    8149 </span>            :       cerr&lt;&lt;found++&lt;&lt;'\r';      
<span class="lineNum">    8150 </span>            :     }
<span class="lineNum">    8151 </span>            :     else
<span class="lineNum">    8152 </span>            :       MarkSeedFree( fSeeds-&gt;RemoveAt(i) );
<span class="lineNum">    8153 </span>            :     pt-&gt;fLab2 = i;
<span class="lineNum">    8154 </span>            :   }
<span class="lineNum">    8155 </span>            :   */
<span class="lineNum">    8156 </span>            :  
<span class="lineNum">    8157 </span>            :   //  fNTracks = found;
<span class="lineNum">    8158 </span><span class="lineCov">          8 :   if (fDebug&gt;0){</span>
<span class="lineNum">    8159 </span><span class="lineNoCov">          0 :     Info(&quot;Clusters2Tracks&quot;,&quot;Time for overlap removal, track writing and dedx cooking: \t&quot;); timer.Print();timer.Start();</span>
<span class="lineNum">    8160 </span>            :   }
<span class="lineNum">    8161 </span>            :   //
<span class="lineNum">    8162 </span>            :   //  cerr&lt;&lt;&quot;Number of found tracks : &quot;&lt;&lt;&quot;\t&quot;&lt;&lt;found&lt;&lt;endl;  
<span class="lineNum">    8163 </span><span class="lineCov">          8 :   Info(&quot;Clusters2Tracks&quot;,&quot;Number of found tracks %d&quot;,found);  </span>
<span class="lineNum">    8164 </span><span class="lineCov">          8 :   savedir-&gt;cd();</span>
<span class="lineNum">    8165 </span>            :   //  UnloadClusters();
<span class="lineNum">    8166 </span>            :   //  
<span class="lineNum">    8167 </span>            :   return 0;
<a name="8168"><span class="lineNum">    8168 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">    8169 </span>            : 
<span class="lineNum">    8170 </span>            : void AliTPCtracker::Tracking(TObjArray * arr)
<span class="lineNum">    8171 </span>            : {
<span class="lineNum">    8172 </span>            :   //
<span class="lineNum">    8173 </span>            :   // tracking of the seeds
<span class="lineNum">    8174 </span>            :   //
<span class="lineNum">    8175 </span><span class="lineCov">       1392 :   fSectors = fOuterSec;</span>
<span class="lineNum">    8176 </span><span class="lineCov">        696 :   ParallelTracking(arr,150,63);</span>
<span class="lineNum">    8177 </span><span class="lineCov">        696 :   fSectors = fOuterSec;</span>
<span class="lineNum">    8178 </span><span class="lineCov">        696 :   ParallelTracking(arr,63,0);</span>
<span class="lineNum">    8179 </span>            : 
<a name="8180"><span class="lineNum">    8180 </span><span class="lineCov">        696 : }</span></a>
<span class="lineNum">    8181 </span>            : 
<span class="lineNum">    8182 </span>            : TObjArray * AliTPCtracker::Tracking(Int_t seedtype, Int_t i1, Int_t i2, Float_t cuts[4], Float_t dy, Int_t dsec)
<span class="lineNum">    8183 </span>            : {
<span class="lineNum">    8184 </span>            :   //
<span class="lineNum">    8185 </span>            :   //
<span class="lineNum">    8186 </span>            :   //tracking routine
<span class="lineNum">    8187 </span><span class="lineCov">       1398 :   static TObjArray arrTracks;</span>
<span class="lineNum">    8188 </span>            :   TObjArray * arr = &amp;arrTracks;
<span class="lineNum">    8189 </span>            :   // 
<span class="lineNum">    8190 </span>            :   //  AliInfoF(&quot;&gt;&gt; %d | s:%d i1:%d i2:%d dy:%f dsec:%d&quot;,arr-&gt;GetEntriesFast(),seedtype,i1,i2,dy,dsec); // RSTMP
<span class="lineNum">    8191 </span>            : 
<span class="lineNum">    8192 </span>            : 
<span class="lineNum">    8193 </span><span class="lineCov">        696 :   fSectors = fOuterSec;</span>
<span class="lineNum">    8194 </span><span class="lineCov">        696 :   TStopwatch timer;</span>
<span class="lineNum">    8195 </span><span class="lineCov">        696 :   timer.Start();</span>
<span class="lineNum">    8196 </span><span class="lineCov">      26448 :   for (Int_t sec=0;sec&lt;fkNOS;sec++){</span>
<span class="lineNum">    8197 </span><span class="lineCov">      25056 :     if (fAccountDistortions) {</span>
<span class="lineNum">    8198 </span><span class="lineCov">      12528 :       if (seedtype==3) MakeSeeds3Dist(arr,sec,i1,i2,cuts,dy, dsec);                  </span>
<span class="lineNum">    8199 </span><span class="lineNoCov">          0 :       if (seedtype==4) MakeSeeds5Dist(arr,sec,i1,i2,cuts,dy);    </span>
<span class="lineNum">    8200 </span><span class="lineNoCov">          0 :       if (seedtype==2) MakeSeeds2Dist(arr,sec,i1,i2,cuts,dy); //RS</span>
<span class="lineNum">    8201 </span>            :     }
<span class="lineNum">    8202 </span>            :     else {
<span class="lineNum">    8203 </span><span class="lineCov">      18720 :       if (seedtype==3) MakeSeeds3(arr,sec,i1,i2,cuts,dy, dsec);              </span>
<span class="lineNum">    8204 </span><span class="lineCov">      18864 :       if (seedtype==4) MakeSeeds5(arr,sec,i1,i2,cuts,dy);    </span>
<span class="lineNum">    8205 </span><span class="lineCov">      12528 :       if (seedtype==2) MakeSeeds2(arr,sec,i1,i2,cuts,dy); //RS</span>
<span class="lineNum">    8206 </span>            :     }
<span class="lineNum">    8207 </span>            :     //
<span class="lineNum">    8208 </span>            :   }
<span class="lineNum">    8209 </span><span class="lineCov">        696 :   if (fDebug&gt;0){</span>
<span class="lineNum">    8210 </span><span class="lineNoCov">          0 :     Info(&quot;Tracking&quot;,&quot;\nSeeding - %d\t%d\t%d\t%d\n&quot;,seedtype,i1,i2,arr-&gt;GetEntriesFast());</span>
<span class="lineNum">    8211 </span><span class="lineNoCov">          0 :     timer.Print();</span>
<span class="lineNum">    8212 </span><span class="lineNoCov">          0 :     timer.Start();</span>
<span class="lineNum">    8213 </span>            :   }
<span class="lineNum">    8214 </span><span class="lineCov">        696 :   Tracking(arr);  </span>
<span class="lineNum">    8215 </span><span class="lineCov">        696 :   if (fDebug&gt;0){</span>
<span class="lineNum">    8216 </span><span class="lineNoCov">          0 :     timer.Print();</span>
<span class="lineNum">    8217 </span>            :   }
<span class="lineNum">    8218 </span>            :   //  AliInfoF(&quot;&lt;&lt; %d | s:%d i1:%d i2:%d dy:%f dsec:%d&quot;,arr-&gt;GetEntriesFast(),seedtype,i1,i2,dy,dsec); // RSTMP
<span class="lineNum">    8219 </span>            :   return arr;
<a name="8220"><span class="lineNum">    8220 </span><span class="lineCov">        696 : }</span></a>
<span class="lineNum">    8221 </span>            : 
<span class="lineNum">    8222 </span>            : TObjArray * AliTPCtracker::Tracking()
<span class="lineNum">    8223 </span>            : {
<span class="lineNum">    8224 </span>            :   // tracking
<span class="lineNum">    8225 </span>            :   //
<span class="lineNum">    8226 </span><span class="lineCov">         16 :   if (AliTPCReconstructor::GetRecoParam()-&gt;GetSpecialSeeding()) return TrackingSpecial();</span>
<span class="lineNum">    8227 </span><span class="lineCov">          8 :   TStopwatch timer;</span>
<span class="lineNum">    8228 </span><span class="lineCov">          8 :   timer.Start();</span>
<span class="lineNum">    8229 </span><span class="lineCov">          8 :   Int_t nup=fOuterSec-&gt;GetNRows()+fInnerSec-&gt;GetNRows();</span>
<span class="lineNum">    8230 </span>            : 
<span class="lineNum">    8231 </span><span class="lineCov">          8 :   TObjArray * seeds = fSeeds;</span>
<span class="lineNum">    8232 </span><span class="lineCov">         14 :   if (!seeds) seeds = new TObjArray;</span>
<span class="lineNum">    8233 </span><span class="lineCov">          6 :   else seeds-&gt;Clear();</span>
<span class="lineNum">    8234 </span><span class="lineCov">          8 :   TObjArray * arr=0;</span>
<span class="lineNum">    8235 </span><span class="lineCov">         16 :   Int_t fLastSeedRowSec=AliTPCReconstructor::GetRecoParam()-&gt;GetLastSeedRowSec();</span>
<span class="lineNum">    8236 </span><span class="lineCov">         16 :   Int_t gapPrim = AliTPCReconstructor::GetRecoParam()-&gt;GetSeedGapPrim();</span>
<span class="lineNum">    8237 </span><span class="lineCov">         16 :   Int_t gapSec = AliTPCReconstructor::GetRecoParam()-&gt;GetSeedGapSec();</span>
<span class="lineNum">    8238 </span>            :   
<span class="lineNum">    8239 </span>            :   Int_t gap =20;
<span class="lineNum">    8240 </span><span class="lineCov">          8 :   Float_t cuts[4];</span>
<span class="lineNum">    8241 </span><span class="lineCov">          8 :   cuts[0] = 0.002;</span>
<span class="lineNum">    8242 </span><span class="lineCov">          8 :   cuts[1] = 1.5;</span>
<span class="lineNum">    8243 </span><span class="lineCov">          8 :   cuts[2] = 3.;</span>
<span class="lineNum">    8244 </span><span class="lineCov">          8 :   cuts[3] = 3.;</span>
<span class="lineNum">    8245 </span>            :   Float_t fnumber  = 3.0;
<span class="lineNum">    8246 </span>            :   Float_t fdensity = 3.0;
<span class="lineNum">    8247 </span>            : 
<span class="lineNum">    8248 </span>            :   // make HLT seeds
<span class="lineNum">    8249 </span><span class="lineCov">         16 :   if (AliTPCReconstructor::GetRecoParam()-&gt;GetUseHLTPreSeeding()) {</span>
<span class="lineNum">    8250 </span><span class="lineNoCov">          0 :     arr = MakeSeedsHLT( fEventHLT );</span>
<span class="lineNum">    8251 </span><span class="lineNoCov">          0 :     if( arr ){</span>
<span class="lineNum">    8252 </span><span class="lineNoCov">          0 :       SumTracks(seeds,arr);     </span>
<span class="lineNum">    8253 </span><span class="lineNoCov">          0 :       delete arr;</span>
<span class="lineNum">    8254 </span><span class="lineNoCov">          0 :       arr=0;</span>
<span class="lineNum">    8255 </span>            :       //cout&lt;&lt;&quot;HLT tracks left after sorting: &quot;&lt;&lt;seeds-&gt;GetEntriesFast()&lt;&lt;endl;
<span class="lineNum">    8256 </span>            :       //SignClusters(seeds,fnumber,fdensity);    
<span class="lineNum">    8257 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    8258 </span>            :   }
<span class="lineNum">    8259 </span>            :   
<span class="lineNum">    8260 </span>            :   //  
<span class="lineNum">    8261 </span>            :   //find primaries  
<span class="lineNum">    8262 </span><span class="lineCov">          8 :   cuts[0]=0.0066;</span>
<span class="lineNum">    8263 </span><span class="lineCov">         64 :   for (Int_t delta = 0; delta&lt;18; delta+=gapPrim){</span>
<span class="lineNum">    8264 </span>            :     //
<span class="lineNum">    8265 </span><span class="lineCov">         24 :     cuts[0]=0.0070;</span>
<span class="lineNum">    8266 </span><span class="lineCov">         24 :     cuts[1] = 1.5;</span>
<span class="lineNum">    8267 </span><span class="lineCov">         48 :     arr = Tracking(3,nup-1-delta,nup-1-delta-gap,cuts,-1,1);</span>
<span class="lineNum">    8268 </span><span class="lineCov">         24 :     SumTracks(seeds,arr);   </span>
<span class="lineNum">    8269 </span><span class="lineCov">         24 :     SignClusters(seeds,fnumber,fdensity); </span>
<span class="lineNum">    8270 </span>            :     //
<span class="lineNum">    8271 </span><span class="lineCov">        144 :     for (Int_t i=2;i&lt;6;i+=2){</span>
<span class="lineNum">    8272 </span>            :       // seed high pt tracks
<span class="lineNum">    8273 </span><span class="lineCov">         48 :       cuts[0]=0.0022;</span>
<span class="lineNum">    8274 </span><span class="lineCov">         48 :       cuts[1]=0.3;</span>
<span class="lineNum">    8275 </span><span class="lineCov">         96 :       arr = Tracking(3,nup-i-delta,nup-i-delta-gap,cuts,-1,0);</span>
<span class="lineNum">    8276 </span><span class="lineCov">         48 :       SumTracks(seeds,arr);   </span>
<span class="lineNum">    8277 </span><span class="lineCov">         48 :       SignClusters(seeds,fnumber,fdensity);        </span>
<span class="lineNum">    8278 </span>            :     }
<span class="lineNum">    8279 </span>            :   }
<span class="lineNum">    8280 </span>            :   fnumber  = 4;
<span class="lineNum">    8281 </span>            :   fdensity = 4.;
<span class="lineNum">    8282 </span>            :   //  RemoveUsed(seeds,0.9,0.9,1);
<span class="lineNum">    8283 </span>            :   //  UnsignClusters();
<span class="lineNum">    8284 </span>            :   //  SignClusters(seeds,fnumber,fdensity);    
<span class="lineNum">    8285 </span>            : 
<span class="lineNum">    8286 </span>            :   //find primaries  
<span class="lineNum">    8287 </span><span class="lineCov">          8 :   cuts[0]=0.0077;</span>
<span class="lineNum">    8288 </span><span class="lineCov">        288 :   for (Int_t delta = 20; delta&lt;120; delta+=gapPrim){</span>
<span class="lineNum">    8289 </span>            :     //
<span class="lineNum">    8290 </span>            :     // seed high pt tracks
<span class="lineNum">    8291 </span><span class="lineCov">        136 :     cuts[0]=0.0060;</span>
<span class="lineNum">    8292 </span><span class="lineCov">        136 :     cuts[1]=0.3;</span>
<span class="lineNum">    8293 </span><span class="lineCov">        136 :     cuts[2]=6.;</span>
<span class="lineNum">    8294 </span><span class="lineCov">        272 :     arr = Tracking(3,nup-delta,nup-delta-gap,cuts,-1);</span>
<span class="lineNum">    8295 </span><span class="lineCov">        136 :     SumTracks(seeds,arr);   </span>
<span class="lineNum">    8296 </span><span class="lineCov">        136 :     SignClusters(seeds,fnumber,fdensity);            </span>
<span class="lineNum">    8297 </span>            : 
<span class="lineNum">    8298 </span><span class="lineCov">        136 :     cuts[0]=0.003;</span>
<span class="lineNum">    8299 </span><span class="lineCov">        136 :     cuts[1]=0.3;</span>
<span class="lineNum">    8300 </span><span class="lineCov">        136 :     cuts[2]=6.;</span>
<span class="lineNum">    8301 </span><span class="lineCov">        272 :     arr = Tracking(3,nup-delta-5,nup-delta-5-gap,cuts,-1);</span>
<span class="lineNum">    8302 </span><span class="lineCov">        136 :     SumTracks(seeds,arr);   </span>
<span class="lineNum">    8303 </span><span class="lineCov">        136 :     SignClusters(seeds,fnumber,fdensity);            </span>
<span class="lineNum">    8304 </span>            :   }
<span class="lineNum">    8305 </span>            : 
<span class="lineNum">    8306 </span><span class="lineCov">          8 :   cuts[0] = 0.01;</span>
<span class="lineNum">    8307 </span><span class="lineCov">          8 :   cuts[1] = 2.0;</span>
<span class="lineNum">    8308 </span><span class="lineCov">          8 :   cuts[2] = 3.;</span>
<span class="lineNum">    8309 </span><span class="lineCov">          8 :   cuts[3] = 2.0;</span>
<span class="lineNum">    8310 </span>            :   fnumber  = 2.;
<span class="lineNum">    8311 </span>            :   fdensity = 2.;
<span class="lineNum">    8312 </span>            :   
<span class="lineNum">    8313 </span><span class="lineCov">          8 :   if (fDebug&gt;0){</span>
<span class="lineNum">    8314 </span><span class="lineNoCov">          0 :     Info(&quot;Tracking()&quot;,&quot;\n\nPrimary seeding\t%d\n\n&quot;,seeds-&gt;GetEntriesFast());</span>
<span class="lineNum">    8315 </span><span class="lineNoCov">          0 :     timer.Print();</span>
<span class="lineNum">    8316 </span><span class="lineNoCov">          0 :     timer.Start();</span>
<span class="lineNum">    8317 </span>            :   }
<span class="lineNum">    8318 </span>            :   //  RemoveUsed(seeds,0.75,0.75,1);
<span class="lineNum">    8319 </span>            :   //UnsignClusters();
<span class="lineNum">    8320 </span>            :   //SignClusters(seeds,fnumber,fdensity);
<span class="lineNum">    8321 </span>            :   
<span class="lineNum">    8322 </span><span class="lineCov">          8 :   if (fDisableSecondaries) return seeds;</span>
<span class="lineNum">    8323 </span>            : 
<span class="lineNum">    8324 </span>            :   // find secondaries
<span class="lineNum">    8325 </span>            : 
<span class="lineNum">    8326 </span><span class="lineCov">          8 :   cuts[0] = 0.3;</span>
<span class="lineNum">    8327 </span><span class="lineCov">          8 :   cuts[1] = 1.5;</span>
<span class="lineNum">    8328 </span><span class="lineCov">          8 :   cuts[2] = 3.;</span>
<span class="lineNum">    8329 </span><span class="lineCov">          8 :   cuts[3] = 1.5;</span>
<span class="lineNum">    8330 </span>            : 
<span class="lineNum">    8331 </span><span class="lineCov">         16 :   arr = Tracking(4,nup-1,nup-1-gap,cuts,-1);</span>
<span class="lineNum">    8332 </span><span class="lineCov">          8 :   SumTracks(seeds,arr);   </span>
<span class="lineNum">    8333 </span><span class="lineCov">          8 :   SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8334 </span>            :   //
<span class="lineNum">    8335 </span><span class="lineCov">         16 :   arr = Tracking(4,nup-2,nup-2-gap,cuts,-1);</span>
<span class="lineNum">    8336 </span><span class="lineCov">          8 :   SumTracks(seeds,arr);   </span>
<span class="lineNum">    8337 </span><span class="lineCov">          8 :   SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8338 </span>            :   //
<span class="lineNum">    8339 </span><span class="lineCov">         16 :   arr = Tracking(4,nup-3,nup-3-gap,cuts,-1);</span>
<span class="lineNum">    8340 </span><span class="lineCov">          8 :   SumTracks(seeds,arr);   </span>
<span class="lineNum">    8341 </span><span class="lineCov">          8 :   SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8342 </span>            :   //
<span class="lineNum">    8343 </span><span class="lineCov">         16 :   arr = Tracking(4,nup-5,nup-5-gap,cuts,-1);</span>
<span class="lineNum">    8344 </span><span class="lineCov">          8 :   SumTracks(seeds,arr);   </span>
<span class="lineNum">    8345 </span><span class="lineCov">          8 :   SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8346 </span>            :   //
<span class="lineNum">    8347 </span><span class="lineCov">         16 :   arr = Tracking(4,nup-7,nup-7-gap,cuts,-1);</span>
<span class="lineNum">    8348 </span><span class="lineCov">          8 :   SumTracks(seeds,arr);   </span>
<span class="lineNum">    8349 </span><span class="lineCov">          8 :   SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8350 </span>            :   //
<span class="lineNum">    8351 </span>            :   //
<span class="lineNum">    8352 </span><span class="lineCov">         16 :   arr = Tracking(4,nup-9,nup-9-gap,cuts,-1);</span>
<span class="lineNum">    8353 </span><span class="lineCov">          8 :   SumTracks(seeds,arr);   </span>
<span class="lineNum">    8354 </span><span class="lineCov">          8 :   SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8355 </span>            :   //
<span class="lineNum">    8356 </span>            : 
<span class="lineNum">    8357 </span>            : 
<span class="lineNum">    8358 </span><span class="lineCov">         80 :   for (Int_t delta = 9; delta&lt;30; delta+=gapSec){</span>
<span class="lineNum">    8359 </span>            :     //
<span class="lineNum">    8360 </span><span class="lineCov">         32 :     cuts[0] = 0.3;</span>
<span class="lineNum">    8361 </span><span class="lineCov">         32 :     cuts[1] = 1.5;</span>
<span class="lineNum">    8362 </span><span class="lineCov">         32 :     cuts[2] = 3.;</span>
<span class="lineNum">    8363 </span><span class="lineCov">         32 :     cuts[3] = 1.5;</span>
<span class="lineNum">    8364 </span><span class="lineCov">         64 :     arr = Tracking(4,nup-1-delta,nup-1-delta-gap,cuts,-1);</span>
<span class="lineNum">    8365 </span><span class="lineCov">         32 :     SumTracks(seeds,arr);   </span>
<span class="lineNum">    8366 </span><span class="lineCov">         32 :     SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8367 </span>            :     //
<span class="lineNum">    8368 </span><span class="lineCov">         64 :     arr = Tracking(4,nup-3-delta,nup-5-delta-gap,cuts,4);</span>
<span class="lineNum">    8369 </span><span class="lineCov">         32 :     SumTracks(seeds,arr);   </span>
<span class="lineNum">    8370 </span><span class="lineCov">         32 :     SignClusters(seeds,fnumber,fdensity); </span>
<span class="lineNum">    8371 </span>            :     //
<span class="lineNum">    8372 </span>            :   } 
<span class="lineNum">    8373 </span>            :   fnumber  = 1;
<span class="lineNum">    8374 </span>            :   fdensity = 1;
<span class="lineNum">    8375 </span>            :   //
<span class="lineNum">    8376 </span>            :   // change cuts
<span class="lineNum">    8377 </span>            :   fnumber  = 2.;
<span class="lineNum">    8378 </span>            :   fdensity = 2.;
<span class="lineNum">    8379 </span><span class="lineCov">          8 :   cuts[0]=0.0080;</span>
<span class="lineNum">    8380 </span>            : 
<span class="lineNum">    8381 </span>            : 
<span class="lineNum">    8382 </span>            :   // find secondaries
<span class="lineNum">    8383 </span><span class="lineCov">        256 :   for (Int_t delta = 30; delta&lt;fLastSeedRowSec; delta+=gapSec){</span>
<span class="lineNum">    8384 </span>            :     //
<span class="lineNum">    8385 </span><span class="lineCov">        120 :     cuts[0] = 0.3;</span>
<span class="lineNum">    8386 </span><span class="lineCov">        120 :     cuts[1] = 3.5;</span>
<span class="lineNum">    8387 </span><span class="lineCov">        120 :     cuts[2] = 3.;</span>
<span class="lineNum">    8388 </span><span class="lineCov">        120 :     cuts[3] = 3.5;</span>
<span class="lineNum">    8389 </span><span class="lineCov">        240 :     arr = Tracking(4,nup-1-delta,nup-1-delta-gap,cuts,-1);</span>
<span class="lineNum">    8390 </span><span class="lineCov">        120 :     SumTracks(seeds,arr);   </span>
<span class="lineNum">    8391 </span><span class="lineCov">        120 :     SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8392 </span>            :     //
<span class="lineNum">    8393 </span><span class="lineCov">        240 :     arr = Tracking(4,nup-5-delta,nup-5-delta-gap,cuts,5 );</span>
<span class="lineNum">    8394 </span><span class="lineCov">        120 :     SumTracks(seeds,arr);   </span>
<span class="lineNum">    8395 </span><span class="lineCov">        120 :     SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8396 </span>            :   }
<span class="lineNum">    8397 </span>            :  
<span class="lineNum">    8398 </span><span class="lineCov">          8 :   if (fDebug&gt;0){</span>
<span class="lineNum">    8399 </span><span class="lineNoCov">          0 :     Info(&quot;Tracking()&quot;,&quot;\n\nSecondary seeding\t%d\n\n&quot;,seeds-&gt;GetEntriesFast());</span>
<span class="lineNum">    8400 </span><span class="lineNoCov">          0 :     timer.Print();</span>
<span class="lineNum">    8401 </span><span class="lineNoCov">          0 :     timer.Start();</span>
<span class="lineNum">    8402 </span>            :   }
<span class="lineNum">    8403 </span>            : 
<span class="lineNum">    8404 </span><span class="lineCov">          8 :   return seeds;</span>
<span class="lineNum">    8405 </span>            :   //
<span class="lineNum">    8406 </span>            :       
<span class="lineNum">    8407 </span><span class="lineCov">         16 : }</span>
<a name="8408"><span class="lineNum">    8408 </span>            : </a>
<span class="lineNum">    8409 </span>            : 
<span class="lineNum">    8410 </span>            : TObjArray * AliTPCtracker::TrackingSpecial()
<span class="lineNum">    8411 </span>            : {
<span class="lineNum">    8412 </span>            :   //
<span class="lineNum">    8413 </span>            :   // seeding adjusted for laser and cosmic tests - short tracks with big inclination angle
<span class="lineNum">    8414 </span>            :   // no primary vertex seeding tried
<span class="lineNum">    8415 </span>            :   //
<span class="lineNum">    8416 </span><span class="lineNoCov">          0 :   TStopwatch timer;</span>
<span class="lineNum">    8417 </span><span class="lineNoCov">          0 :   timer.Start();</span>
<span class="lineNum">    8418 </span><span class="lineNoCov">          0 :   Int_t nup=fOuterSec-&gt;GetNRows()+fInnerSec-&gt;GetNRows();</span>
<span class="lineNum">    8419 </span>            : 
<span class="lineNum">    8420 </span><span class="lineNoCov">          0 :   TObjArray * seeds = fSeeds;</span>
<span class="lineNum">    8421 </span><span class="lineNoCov">          0 :   if (!seeds) seeds = new TObjArray;</span>
<span class="lineNum">    8422 </span><span class="lineNoCov">          0 :   else seeds-&gt;Clear();</span>
<span class="lineNum">    8423 </span><span class="lineNoCov">          0 :   TObjArray * arr=0;</span>
<span class="lineNum">    8424 </span>            :   
<span class="lineNum">    8425 </span>            :   Int_t   gap  = 15;
<span class="lineNum">    8426 </span><span class="lineNoCov">          0 :   Float_t cuts[4];</span>
<span class="lineNum">    8427 </span>            :   Float_t fnumber  = 3.0;
<span class="lineNum">    8428 </span>            :   Float_t fdensity = 3.0;
<span class="lineNum">    8429 </span>            :   
<span class="lineNum">    8430 </span>            :   // find secondaries
<span class="lineNum">    8431 </span><span class="lineNoCov">          0 :   cuts[0] = AliTPCReconstructor::GetRecoParam()-&gt;GetMaxC();   // max curvature</span>
<span class="lineNum">    8432 </span><span class="lineNoCov">          0 :   cuts[1] = 3.5;    // max tan(phi) angle for seeding</span>
<span class="lineNum">    8433 </span><span class="lineNoCov">          0 :   cuts[2] = 3.;     // not used (cut on z primary vertex)     </span>
<span class="lineNum">    8434 </span><span class="lineNoCov">          0 :   cuts[3] = 3.5;    // max tan(theta) angle for seeding</span>
<span class="lineNum">    8435 </span>            : 
<span class="lineNum">    8436 </span><span class="lineNoCov">          0 :   for (Int_t delta = 0; nup-delta-gap-1&gt;0; delta+=3){</span>
<span class="lineNum">    8437 </span>            :     //
<span class="lineNum">    8438 </span><span class="lineNoCov">          0 :     arr = Tracking(4,nup-1-delta,nup-1-delta-gap,cuts,-1);</span>
<span class="lineNum">    8439 </span><span class="lineNoCov">          0 :     SumTracks(seeds,arr);   </span>
<span class="lineNum">    8440 </span><span class="lineNoCov">          0 :     SignClusters(seeds,fnumber,fdensity);   </span>
<span class="lineNum">    8441 </span>            :   } 
<span class="lineNum">    8442 </span>            :  
<span class="lineNum">    8443 </span><span class="lineNoCov">          0 :   if (fDebug&gt;0){</span>
<span class="lineNum">    8444 </span><span class="lineNoCov">          0 :     Info(&quot;Tracking()&quot;,&quot;\n\nSecondary seeding\t%d\n\n&quot;,seeds-&gt;GetEntriesFast());</span>
<span class="lineNum">    8445 </span><span class="lineNoCov">          0 :     timer.Print();</span>
<span class="lineNum">    8446 </span><span class="lineNoCov">          0 :     timer.Start();</span>
<span class="lineNum">    8447 </span>            :   }
<span class="lineNum">    8448 </span>            : 
<span class="lineNum">    8449 </span>            :   return seeds;
<span class="lineNum">    8450 </span>            :   //
<span class="lineNum">    8451 </span>            :       
<span class="lineNum">    8452 </span><span class="lineNoCov">          0 : }</span>
<a name="8453"><span class="lineNum">    8453 </span>            : </a>
<span class="lineNum">    8454 </span>            : 
<span class="lineNum">    8455 </span>            : void AliTPCtracker::SumTracks(TObjArray *arr1,TObjArray *&amp;arr2)
<span class="lineNum">    8456 </span>            : {
<span class="lineNum">    8457 </span>            :   //
<span class="lineNum">    8458 </span>            :   //sum tracks to common container
<span class="lineNum">    8459 </span>            :   //remove suspicious tracks
<span class="lineNum">    8460 </span>            :   // RS: Attention: supplied tracks come in the static array, don't delete them
<span class="lineNum">    8461 </span><span class="lineCov">       1392 :   Int_t nseed = arr2-&gt;GetEntriesFast();</span>
<span class="lineNum">    8462 </span><span class="lineCov">       1988 :   for (Int_t i=0;i&lt;nseed;i++){</span>
<span class="lineNum">    8463 </span><span class="lineCov">        298 :     AliTPCseed *pt=(AliTPCseed*)arr2-&gt;UncheckedAt(i);    </span>
<span class="lineNum">    8464 </span><span class="lineCov">        298 :     if (pt){</span>
<span class="lineNum">    8465 </span>            :       //
<span class="lineNum">    8466 </span>            :       // remove tracks with too big curvature
<span class="lineNum">    8467 </span>            :       //
<span class="lineNum">    8468 </span><span class="lineCov">        298 :       if (TMath::Abs(pt-&gt;GetC())&gt;AliTPCReconstructor::GetRecoParam()-&gt;GetMaxC()){</span>
<span class="lineNum">    8469 </span><span class="lineNoCov">          0 :         MarkSeedFree( arr2-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8470 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    8471 </span>            :       }
<span class="lineNum">    8472 </span>            :        // REMOVE VERY SHORT  TRACKS
<span class="lineNum">    8473 </span><span class="lineCov">        298 :       if (pt-&gt;GetNumberOfClusters()&lt;20){ </span>
<span class="lineNum">    8474 </span><span class="lineCov">         18 :         MarkSeedFree( arr2-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8475 </span><span class="lineCov">         18 :         continue;</span>
<span class="lineNum">    8476 </span>            :       }// patch 28 fev06
<span class="lineNum">    8477 </span>            :       // NORMAL ACTIVE TRACK
<span class="lineNum">    8478 </span><span class="lineCov">        280 :       if (pt-&gt;IsActive()){</span>
<span class="lineNum">    8479 </span><span class="lineCov">        274 :         arr1-&gt;AddLast(arr2-&gt;RemoveAt(i));</span>
<span class="lineNum">    8480 </span><span class="lineCov">        274 :         continue;</span>
<span class="lineNum">    8481 </span>            :       }
<span class="lineNum">    8482 </span>            :       //remove not usable tracks
<span class="lineNum">    8483 </span><span class="lineCov">          6 :       if (pt-&gt;GetRemoval()!=10){</span>
<span class="lineNum">    8484 </span><span class="lineNoCov">          0 :         MarkSeedFree( arr2-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8485 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    8486 </span>            :       }
<span class="lineNum">    8487 </span>            :      
<span class="lineNum">    8488 </span>            :       // ENABLE ONLY ENOUGH GOOD STOPPED TRACKS
<span class="lineNum">    8489 </span><span class="lineCov">          6 :       if (pt-&gt;GetDensityFirst(20)&gt;0.8 || pt-&gt;GetDensityFirst(30)&gt;0.8 || pt-&gt;GetDensityFirst(40)&gt;0.7)</span>
<span class="lineNum">    8490 </span><span class="lineCov">          6 :         arr1-&gt;AddLast(arr2-&gt;RemoveAt(i));</span>
<span class="lineNum">    8491 </span>            :       else{      
<span class="lineNum">    8492 </span><span class="lineNoCov">          0 :         MarkSeedFree( arr2-&gt;RemoveAt(i) );</span>
<span class="lineNum">    8493 </span>            :       }
<span class="lineNum">    8494 </span>            :     }
<span class="lineNum">    8495 </span><span class="lineCov">          6 :   }</span>
<span class="lineNum">    8496 </span>            :   // delete arr2;  arr2 = 0; // RS: this is static array, don't delete it
<span class="lineNum">    8497 </span><span class="lineCov">        696 : }</span>
<span class="lineNum">    8498 </span>            : 
<a name="8499"><span class="lineNum">    8499 </span>            : </a>
<span class="lineNum">    8500 </span>            : 
<span class="lineNum">    8501 </span>            : void  AliTPCtracker::ParallelTracking(TObjArray *const arr, Int_t rfirst, Int_t rlast)
<span class="lineNum">    8502 </span>            : {
<span class="lineNum">    8503 </span>            :   //
<span class="lineNum">    8504 </span>            :   // try to track in parralel
<span class="lineNum">    8505 </span>            : 
<span class="lineNum">    8506 </span><span class="lineCov">       2784 :   Int_t nseed=arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    8507 </span>            :   //prepare seeds for tracking
<span class="lineNum">    8508 </span><span class="lineCov">       3976 :   for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    8509 </span><span class="lineCov">        596 :     AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i), &amp;t=*pt; </span>
<span class="lineNum">    8510 </span><span class="lineCov">        596 :     if (!pt) continue;</span>
<span class="lineNum">    8511 </span><span class="lineCov">        612 :     if (!t.IsActive()) continue;</span>
<span class="lineNum">    8512 </span>            :     // follow prolongation to the first layer
<span class="lineNum">    8513 </span><span class="lineCov">       1160 :     if ( (fSectors ==fInnerSec) || (t.GetFirstPoint()-fkParam-&gt;GetNRowLow()&gt;rfirst+1) )  </span>
<span class="lineNum">    8514 </span><span class="lineNoCov">          0 :       FollowProlongation(t, rfirst+1);</span>
<span class="lineNum">    8515 </span><span class="lineCov">        580 :   }</span>
<span class="lineNum">    8516 </span>            : 
<span class="lineNum">    8517 </span>            : 
<span class="lineNum">    8518 </span>            :   //
<span class="lineNum">    8519 </span><span class="lineCov">     214368 :   for (Int_t nr=rfirst; nr&gt;=rlast; nr--){ </span>
<span class="lineNum">    8520 </span><span class="lineCov">     105792 :     if (nr&lt;fInnerSec-&gt;GetNRows()) </span>
<span class="lineNum">    8521 </span><span class="lineCov">      43848 :       fSectors = fInnerSec;</span>
<span class="lineNum">    8522 </span>            :     else
<span class="lineNum">    8523 </span><span class="lineCov">      61944 :       fSectors = fOuterSec;</span>
<span class="lineNum">    8524 </span>            :     // make indexes with the cluster tracks for given       
<span class="lineNum">    8525 </span>            : 
<span class="lineNum">    8526 </span>            :     // find nearest cluster
<span class="lineNum">    8527 </span><span class="lineCov">     302176 :     for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    8528 </span><span class="lineCov">      45296 :       AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i), &amp;t=*pt;       </span>
<span class="lineNum">    8529 </span><span class="lineCov">      45296 :       if (!pt) continue;</span>
<span class="lineNum">    8530 </span><span class="lineCov">      45594 :       if (nr==80) pt-&gt;UpdateReference();</span>
<span class="lineNum">    8531 </span><span class="lineCov">      46952 :       if (!pt-&gt;IsActive()) continue;</span>
<span class="lineNum">    8532 </span>            :       //      if ( (fSectors ==fOuterSec) &amp;&amp; (pt-&gt;fFirstPoint-fkParam-&gt;GetNRowLow())&lt;nr) continue;
<span class="lineNum">    8533 </span><span class="lineCov">      43640 :       if (pt-&gt;GetRelativeSector()&gt;17) {</span>
<span class="lineNum">    8534 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    8535 </span>            :       }
<span class="lineNum">    8536 </span><span class="lineCov">      43640 :       UpdateClusters(t,nr);</span>
<span class="lineNum">    8537 </span><span class="lineCov">      43640 :     }</span>
<span class="lineNum">    8538 </span>            :     // prolonagate to the nearest cluster - if founded
<span class="lineNum">    8539 </span><span class="lineCov">     302176 :     for (Int_t i=0; i&lt;nseed; i++) {</span>
<span class="lineNum">    8540 </span><span class="lineCov">      45296 :       AliTPCseed *pt=(AliTPCseed*)arr-&gt;UncheckedAt(i); </span>
<span class="lineNum">    8541 </span><span class="lineCov">      45296 :       if (!pt) continue;</span>
<span class="lineNum">    8542 </span><span class="lineCov">      46952 :       if (!pt-&gt;IsActive()) continue; </span>
<span class="lineNum">    8543 </span>            :       // if ((fSectors ==fOuterSec) &amp;&amp; (pt-&gt;fFirstPoint-fkParam-&gt;GetNRowLow())&lt;nr) continue;
<span class="lineNum">    8544 </span><span class="lineCov">      43640 :       if (pt-&gt;GetRelativeSector()&gt;17) {</span>
<span class="lineNum">    8545 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    8546 </span>            :       }
<span class="lineNum">    8547 </span><span class="lineCov">      43640 :       FollowToNextCluster(*pt,nr);</span>
<span class="lineNum">    8548 </span><span class="lineCov">      43640 :     }</span>
<span class="lineNum">    8549 </span>            :   }    
<a name="8550"><span class="lineNum">    8550 </span><span class="lineCov">       1392 : }</span></a>
<span class="lineNum">    8551 </span>            : 
<span class="lineNum">    8552 </span>            : void AliTPCtracker::PrepareForBackProlongation(const TObjArray *const arr,Float_t fac) const
<span class="lineNum">    8553 </span>            : {
<span class="lineNum">    8554 </span>            :   //
<span class="lineNum">    8555 </span>            :   //
<span class="lineNum">    8556 </span>            :   // if we use TPC track itself we have to &quot;update&quot; covariance
<span class="lineNum">    8557 </span>            :   //
<span class="lineNum">    8558 </span><span class="lineNoCov">          0 :   Int_t nseed= arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    8559 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;nseed;i++){</span>
<span class="lineNum">    8560 </span><span class="lineNoCov">          0 :     AliTPCseed *pt = (AliTPCseed*)arr-&gt;UncheckedAt(i);</span>
<span class="lineNum">    8561 </span><span class="lineNoCov">          0 :     if (pt) {</span>
<span class="lineNum">    8562 </span><span class="lineNoCov">          0 :       pt-&gt;Modify(fac);</span>
<span class="lineNum">    8563 </span>            :       //
<span class="lineNum">    8564 </span>            :       //rotate to current local system at first accepted  point    
<span class="lineNum">    8565 </span><span class="lineNoCov">          0 :       Int_t index  = pt-&gt;GetClusterIndex2(pt-&gt;GetFirstPoint()); </span>
<span class="lineNum">    8566 </span><span class="lineNoCov">          0 :       Int_t sec    = (index&amp;0xff000000)&gt;&gt;24;</span>
<span class="lineNum">    8567 </span><span class="lineNoCov">          0 :       sec = sec%18;</span>
<span class="lineNum">    8568 </span><span class="lineNoCov">          0 :       Float_t angle1 = fInnerSec-&gt;GetAlpha()*sec+fInnerSec-&gt;GetAlphaShift();</span>
<span class="lineNum">    8569 </span><span class="lineNoCov">          0 :       if (angle1&gt;TMath::Pi()) </span>
<span class="lineNum">    8570 </span><span class="lineNoCov">          0 :         angle1-=2.*TMath::Pi();</span>
<span class="lineNum">    8571 </span><span class="lineNoCov">          0 :       Float_t angle2 = pt-&gt;GetAlpha();</span>
<span class="lineNum">    8572 </span>            :       
<span class="lineNum">    8573 </span><span class="lineNoCov">          0 :       if (TMath::Abs(angle1-angle2)&gt;0.001){</span>
<span class="lineNum">    8574 </span><span class="lineNoCov">          0 :         if (!pt-&gt;Rotate(angle1-angle2)) return;</span>
<span class="lineNum">    8575 </span>            :         //angle2 = pt-&gt;GetAlpha();
<span class="lineNum">    8576 </span>            :         //pt-&gt;fRelativeSector = pt-&gt;GetAlpha()/fInnerSec-&gt;GetAlpha();
<span class="lineNum">    8577 </span>            :         //if (pt-&gt;GetAlpha()&lt;0) 
<span class="lineNum">    8578 </span>            :         //  pt-&gt;fRelativeSector+=18;
<span class="lineNum">    8579 </span>            :         //sec = pt-&gt;fRelativeSector;
<span class="lineNum">    8580 </span>            :       }
<span class="lineNum">    8581 </span>            :         
<span class="lineNum">    8582 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    8583 </span>            :     
<span class="lineNum">    8584 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    8585 </span>            : 
<a name="8586"><span class="lineNum">    8586 </span>            : </a>
<span class="lineNum">    8587 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8588 </span>            : void AliTPCtracker::PrepareForProlongation(TObjArray *const arr, Float_t fac) const
<span class="lineNum">    8589 </span>            : {
<span class="lineNum">    8590 </span>            :   //
<span class="lineNum">    8591 </span>            :   //
<span class="lineNum">    8592 </span>            :   // if we use TPC track itself we have to &quot;update&quot; covariance
<span class="lineNum">    8593 </span>            :   //
<span class="lineNum">    8594 </span><span class="lineNoCov">          0 :   Int_t nseed= arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    8595 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;nseed;i++){</span>
<span class="lineNum">    8596 </span><span class="lineNoCov">          0 :     AliTPCseed *pt = (AliTPCseed*)arr-&gt;UncheckedAt(i);</span>
<span class="lineNum">    8597 </span><span class="lineNoCov">          0 :     if (pt) {</span>
<span class="lineNum">    8598 </span><span class="lineNoCov">          0 :       pt-&gt;Modify(fac);</span>
<span class="lineNum">    8599 </span><span class="lineNoCov">          0 :       pt-&gt;SetFirstPoint(pt-&gt;GetLastPoint()); </span>
<span class="lineNum">    8600 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    8601 </span>            :     
<span class="lineNum">    8602 </span>            :   }
<span class="lineNum">    8603 </span>            : 
<span class="lineNum">    8604 </span>            : 
<a name="8605"><span class="lineNum">    8605 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    8606 </span>            : 
<span class="lineNum">    8607 </span>            : Int_t AliTPCtracker::PropagateBack(const TObjArray *const arr)
<span class="lineNum">    8608 </span>            : {
<span class="lineNum">    8609 </span>            :   //
<span class="lineNum">    8610 </span>            :   // make back propagation
<span class="lineNum">    8611 </span>            :   //
<span class="lineNum">    8612 </span><span class="lineCov">         16 :   Int_t nseed= arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    8613 </span><span class="lineCov">        288 :   for (Int_t i=0;i&lt;nseed;i++){</span>
<span class="lineNum">    8614 </span><span class="lineCov">        136 :     AliTPCseed *pt = (AliTPCseed*)arr-&gt;UncheckedAt(i);</span>
<span class="lineNum">    8615 </span><span class="lineCov">        272 :     if (pt&amp;&amp; pt-&gt;GetKinkIndex(0)&lt;=0) { </span>
<span class="lineNum">    8616 </span>            :       //AliTPCseed *pt2 = new AliTPCseed(*pt);
<span class="lineNum">    8617 </span><span class="lineCov">        132 :       fSectors = fInnerSec;</span>
<span class="lineNum">    8618 </span>            :       //FollowBackProlongation(*pt,fInnerSec-&gt;GetNRows()-1);
<span class="lineNum">    8619 </span>            :       //fSectors = fOuterSec;
<span class="lineNum">    8620 </span><span class="lineCov">        132 :       FollowBackProlongation(*pt,fInnerSec-&gt;GetNRows()+fOuterSec-&gt;GetNRows()-1,1);     </span>
<span class="lineNum">    8621 </span>            :       //if (pt-&gt;GetNumberOfClusters()&lt;(pt-&gt;fEsd-&gt;GetTPCclusters(0)) ){
<span class="lineNum">    8622 </span>            :       //        Error(&quot;PropagateBack&quot;,&quot;Not prolonged track %d&quot;,pt-&gt;GetLabel());
<span class="lineNum">    8623 </span>            :       //        FollowBackProlongation(*pt2,fInnerSec-&gt;GetNRows()+fOuterSec-&gt;GetNRows()-1);
<span class="lineNum">    8624 </span>            :       //}
<span class="lineNum">    8625 </span><span class="lineCov">        132 :     }</span>
<span class="lineNum">    8626 </span><span class="lineCov">        272 :     if (pt&amp;&amp; pt-&gt;GetKinkIndex(0)&gt;0) {</span>
<span class="lineNum">    8627 </span><span class="lineCov">          4 :       AliESDkink * kink = fEvent-&gt;GetKink(pt-&gt;GetKinkIndex(0)-1);</span>
<span class="lineNum">    8628 </span><span class="lineCov">          4 :       pt-&gt;SetFirstPoint(kink-&gt;GetTPCRow0());</span>
<span class="lineNum">    8629 </span><span class="lineCov">          4 :       fSectors = fInnerSec;</span>
<span class="lineNum">    8630 </span><span class="lineCov">          4 :       FollowBackProlongation(*pt,fInnerSec-&gt;GetNRows()+fOuterSec-&gt;GetNRows()-1,1);  </span>
<span class="lineNum">    8631 </span><span class="lineCov">          4 :     }</span>
<span class="lineNum">    8632 </span><span class="lineCov">        136 :     CookLabel(pt,0.3);</span>
<span class="lineNum">    8633 </span>            :   }
<span class="lineNum">    8634 </span><span class="lineCov">          8 :   return 0;</span>
<span class="lineNum">    8635 </span>            : }
<a name="8636"><span class="lineNum">    8636 </span>            : </a>
<span class="lineNum">    8637 </span>            : 
<span class="lineNum">    8638 </span>            : Int_t AliTPCtracker::PropagateForward2(const TObjArray *const arr)
<span class="lineNum">    8639 </span>            : {
<span class="lineNum">    8640 </span>            :   //
<span class="lineNum">    8641 </span>            :   // make forward propagation
<span class="lineNum">    8642 </span>            :   //
<span class="lineNum">    8643 </span><span class="lineCov">         16 :   Int_t nseed= arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    8644 </span>            :   //
<span class="lineNum">    8645 </span><span class="lineCov">        288 :   for (Int_t i=0;i&lt;nseed;i++){</span>
<span class="lineNum">    8646 </span><span class="lineCov">        136 :     AliTPCseed *pt = (AliTPCseed*)arr-&gt;UncheckedAt(i);</span>
<span class="lineNum">    8647 </span><span class="lineCov">        136 :     if (pt) { </span>
<span class="lineNum">    8648 </span><span class="lineCov">        136 :       FollowProlongation(*pt,0,1,1);</span>
<span class="lineNum">    8649 </span><span class="lineCov">        136 :       CookLabel(pt,0.3);</span>
<span class="lineNum">    8650 </span><span class="lineCov">        136 :     }</span>
<span class="lineNum">    8651 </span>            :     
<span class="lineNum">    8652 </span>            :   }
<span class="lineNum">    8653 </span><span class="lineCov">          8 :  return 0;</span>
<span class="lineNum">    8654 </span>            : }
<a name="8655"><span class="lineNum">    8655 </span>            : </a>
<span class="lineNum">    8656 </span>            : 
<span class="lineNum">    8657 </span>            : Int_t AliTPCtracker::PropagateForward()
<span class="lineNum">    8658 </span>            : {
<span class="lineNum">    8659 </span>            :   //
<span class="lineNum">    8660 </span>            :   // propagate track forward
<span class="lineNum">    8661 </span>            :   //UnsignClusters();
<span class="lineNum">    8662 </span><span class="lineNoCov">          0 :   Int_t nseed = fSeeds-&gt;GetEntriesFast();</span>
<span class="lineNum">    8663 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;nseed;i++){</span>
<span class="lineNum">    8664 </span><span class="lineNoCov">          0 :     AliTPCseed *pt = (AliTPCseed*)fSeeds-&gt;UncheckedAt(i);</span>
<span class="lineNum">    8665 </span><span class="lineNoCov">          0 :     if (pt){</span>
<span class="lineNum">    8666 </span>            :       AliTPCseed &amp;t = *pt;
<span class="lineNum">    8667 </span><span class="lineNoCov">          0 :       Double_t alpha=t.GetAlpha() - fSectors-&gt;GetAlphaShift();</span>
<span class="lineNum">    8668 </span><span class="lineNoCov">          0 :       if (alpha &gt; 2.*TMath::Pi()) alpha -= 2.*TMath::Pi();  </span>
<span class="lineNum">    8669 </span><span class="lineNoCov">          0 :       if (alpha &lt; 0.            ) alpha += 2.*TMath::Pi();  </span>
<span class="lineNum">    8670 </span><span class="lineNoCov">          0 :       t.SetRelativeSector(Int_t(alpha/fSectors-&gt;GetAlpha()+0.0001)%fN);</span>
<span class="lineNum">    8671 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    8672 </span>            :   }
<span class="lineNum">    8673 </span>            :   
<span class="lineNum">    8674 </span><span class="lineNoCov">          0 :   fSectors = fOuterSec;</span>
<span class="lineNum">    8675 </span><span class="lineNoCov">          0 :   ParallelTracking(fSeeds,fOuterSec-&gt;GetNRows()+fInnerSec-&gt;GetNRows()-1,fInnerSec-&gt;GetNRows());</span>
<span class="lineNum">    8676 </span><span class="lineNoCov">          0 :   fSectors = fInnerSec;</span>
<span class="lineNum">    8677 </span><span class="lineNoCov">          0 :   ParallelTracking(fSeeds,fInnerSec-&gt;GetNRows()-1,0);</span>
<span class="lineNum">    8678 </span><span class="lineNoCov">          0 :   return 1;</span>
<span class="lineNum">    8679 </span>            : }
<span class="lineNum">    8680 </span>            : 
<span class="lineNum">    8681 </span>            : 
<span class="lineNum">    8682 </span>            : 
<span class="lineNum">    8683 </span>            : 
<a name="8684"><span class="lineNum">    8684 </span>            : </a>
<span class="lineNum">    8685 </span>            : 
<span class="lineNum">    8686 </span>            : Int_t AliTPCtracker::PropagateBack(AliTPCseed *const pt, Int_t row0, Int_t row1)
<span class="lineNum">    8687 </span>            : {
<span class="lineNum">    8688 </span>            :   //
<span class="lineNum">    8689 </span>            :   // make back propagation, in between row0 and row1
<span class="lineNum">    8690 </span>            :   //
<span class="lineNum">    8691 </span>            :   
<span class="lineNum">    8692 </span><span class="lineNoCov">          0 :   if (pt) { </span>
<span class="lineNum">    8693 </span><span class="lineNoCov">          0 :     fSectors = fInnerSec;</span>
<span class="lineNum">    8694 </span>            :     Int_t  r1;
<span class="lineNum">    8695 </span>            :     //
<span class="lineNum">    8696 </span><span class="lineNoCov">          0 :     if (row1&lt;fSectors-&gt;GetNRows()) </span>
<span class="lineNum">    8697 </span><span class="lineNoCov">          0 :       r1 = row1;</span>
<span class="lineNum">    8698 </span>            :     else 
<span class="lineNum">    8699 </span><span class="lineNoCov">          0 :       r1 = fSectors-&gt;GetNRows()-1;</span>
<span class="lineNum">    8700 </span>            : 
<span class="lineNum">    8701 </span><span class="lineNoCov">          0 :     if (row0&lt;fSectors-&gt;GetNRows()&amp;&amp; r1&gt;0 )</span>
<span class="lineNum">    8702 </span><span class="lineNoCov">          0 :       FollowBackProlongation(*pt,r1);</span>
<span class="lineNum">    8703 </span><span class="lineNoCov">          0 :     if (row1&lt;=fSectors-&gt;GetNRows())</span>
<span class="lineNum">    8704 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">    8705 </span>            :     //
<span class="lineNum">    8706 </span><span class="lineNoCov">          0 :     r1 = row1 - fSectors-&gt;GetNRows();</span>
<span class="lineNum">    8707 </span><span class="lineNoCov">          0 :     if (r1&lt;=0) return 0;</span>
<span class="lineNum">    8708 </span><span class="lineNoCov">          0 :     if (r1&gt;=fOuterSec-&gt;GetNRows()) return 0;</span>
<span class="lineNum">    8709 </span><span class="lineNoCov">          0 :     fSectors = fOuterSec;</span>
<span class="lineNum">    8710 </span><span class="lineNoCov">          0 :     return FollowBackProlongation(*pt,r1);</span>
<span class="lineNum">    8711 </span>            :   }        
<span class="lineNum">    8712 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">    8713 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8714 </span>            : 
<span class="lineNum">    8715 </span>            : 
<a name="8716"><span class="lineNum">    8716 </span>            : </a>
<span class="lineNum">    8717 </span>            : 
<span class="lineNum">    8718 </span>            : void  AliTPCtracker::GetShape(AliTPCseed * seed, Int_t row)
<span class="lineNum">    8719 </span>            : {
<span class="lineNum">    8720 </span>            :   // gets cluster shape
<span class="lineNum">    8721 </span>            :   // 
<span class="lineNum">    8722 </span><span class="lineCov">     210964 :   AliTPCClusterParam * clparam = AliTPCcalibDB::Instance()-&gt;GetClusterParam();</span>
<span class="lineNum">    8723 </span><span class="lineCov">     105482 :   Float_t zdrift = TMath::Abs((fkParam-&gt;GetZLength(0)-TMath::Abs(seed-&gt;GetZ())));</span>
<span class="lineNum">    8724 </span><span class="lineCov">     274784 :   Int_t type = (seed-&gt;GetSector() &lt; fkParam-&gt;GetNSector()/2) ? 0: (row&gt;126) ? 1:2;</span>
<span class="lineNum">    8725 </span><span class="lineCov">     105482 :   Double_t angulary  = seed-&gt;GetSnp();</span>
<span class="lineNum">    8726 </span>            : 
<span class="lineNum">    8727 </span><span class="lineCov">     105482 :   if (TMath::Abs(angulary)&gt;AliTPCReconstructor::GetMaxSnpTracker()) {</span>
<span class="lineNum">    8728 </span><span class="lineCov">       2812 :     angulary = TMath::Sign(AliTPCReconstructor::GetMaxSnpTracker(),angulary);</span>
<span class="lineNum">    8729 </span><span class="lineCov">       2812 :   }</span>
<span class="lineNum">    8730 </span>            : 
<span class="lineNum">    8731 </span><span class="lineCov">     105482 :   angulary = angulary*angulary/((1.-angulary)*(1.+angulary));</span>
<span class="lineNum">    8732 </span><span class="lineCov">     105482 :   Double_t angularz  = seed-&gt;GetTgl()*seed-&gt;GetTgl()*(1.+angulary);</span>
<span class="lineNum">    8733 </span>            :   
<span class="lineNum">    8734 </span><span class="lineCov">     105482 :   Double_t sigmay =  clparam-&gt;GetRMS0(0,type,zdrift,TMath::Sqrt(TMath::Abs(angulary)));</span>
<span class="lineNum">    8735 </span><span class="lineCov">     105482 :   Double_t sigmaz =  clparam-&gt;GetRMS0(1,type,zdrift,TMath::Sqrt(TMath::Abs(angularz)));</span>
<span class="lineNum">    8736 </span><span class="lineCov">     105482 :   seed-&gt;SetCurrentSigmaY2(sigmay*sigmay);</span>
<span class="lineNum">    8737 </span><span class="lineCov">     105482 :   seed-&gt;SetCurrentSigmaZ2(sigmaz*sigmaz);</span>
<span class="lineNum">    8738 </span>            :   // Float_t sd2 = TMath::Abs((fkParam-&gt;GetZLength(0)-TMath::Abs(seed-&gt;GetZ())))*fkParam-&gt;GetDiffL()*fkParam-&gt;GetDiffL();
<span class="lineNum">    8739 </span>            : //   //  Float_t padlength =  fkParam-&gt;GetPadPitchLength(seed-&gt;fSector);
<span class="lineNum">    8740 </span>            : //   Float_t padlength =  GetPadPitchLength(row);
<span class="lineNum">    8741 </span>            : //   //
<span class="lineNum">    8742 </span>            : //   Float_t sresy = (seed-&gt;GetSector() &lt; fkParam-&gt;GetNSector()/2) ? 0.2 :0.3;
<span class="lineNum">    8743 </span>            : //   seed-&gt;SetCurrentSigmaY2(sd2+padlength*padlength*angulary/12.+sresy*sresy);  
<span class="lineNum">    8744 </span>            : //   //
<span class="lineNum">    8745 </span>            : //   Float_t sresz = fkParam-&gt;GetZSigma();
<span class="lineNum">    8746 </span>            : //   seed-&gt;SetCurrentSigmaZ2(sd2+padlength*padlength*angularz*angularz*(1+angulary)/12.+sresz*sresz);
<span class="lineNum">    8747 </span>            :   /*
<span class="lineNum">    8748 </span>            :   Float_t wy = GetSigmaY(seed);
<span class="lineNum">    8749 </span>            :   Float_t wz = GetSigmaZ(seed);
<span class="lineNum">    8750 </span>            :   wy*=wy;
<span class="lineNum">    8751 </span>            :   wz*=wz;
<span class="lineNum">    8752 </span>            :   if (TMath::Abs(wy/seed-&gt;fCurrentSigmaY2-1)&gt;0.0001 || TMath::Abs(wz/seed-&gt;fCurrentSigmaZ2-1)&gt;0.0001 ){
<span class="lineNum">    8753 </span>            :     printf(&quot;problem\n&quot;);
<span class="lineNum">    8754 </span>            :   }
<span class="lineNum">    8755 </span>            :   */
<span class="lineNum">    8756 </span><span class="lineCov">     105482 : }</span>
<span class="lineNum">    8757 </span>            : 
<span class="lineNum">    8758 </span>            : 
<a name="8759"><span class="lineNum">    8759 </span>            : </a>
<span class="lineNum">    8760 </span>            : //__________________________________________________________________________
<span class="lineNum">    8761 </span>            : void AliTPCtracker::CookLabel(AliKalmanTrack *tk, Float_t wrong) const {
<span class="lineNum">    8762 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    8763 </span>            :   //This function &quot;cooks&quot; a track label. If label&lt;0, this track is fake.
<span class="lineNum">    8764 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    8765 </span>            :   //  AliTPCseed * t = dynamic_cast&lt;AliTPCseed*&gt;(tk);
<span class="lineNum">    8766 </span>            :   //  if(!t){
<span class="lineNum">    8767 </span>            :   //  printf(&quot;%s:%d wrong type \n&quot;,(char*)__FILE__,__LINE__);
<span class="lineNum">    8768 </span>            :   //  return;
<span class="lineNum">    8769 </span>            :   //  }
<span class="lineNum">    8770 </span><span class="lineCov">       1916 :   AliTPCseed * t = (AliTPCseed*)tk; // RS avoid slow dynamic cast</span>
<span class="lineNum">    8771 </span>            : 
<span class="lineNum">    8772 </span><span class="lineCov">        958 :   Int_t noc=t-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    8773 </span><span class="lineCov">        958 :   if (noc&lt;10){</span>
<span class="lineNum">    8774 </span>            :     //printf(&quot;\nnot founded prolongation\n\n\n&quot;);
<span class="lineNum">    8775 </span>            :     //t-&gt;Dump();
<span class="lineNum">    8776 </span><span class="lineCov">          2 :     return ;</span>
<span class="lineNum">    8777 </span>            :   }
<span class="lineNum">    8778 </span><span class="lineCov">        956 :   Int_t lb[kMaxRow];</span>
<span class="lineNum">    8779 </span><span class="lineCov">        956 :   Int_t mx[kMaxRow];</span>
<span class="lineNum">    8780 </span><span class="lineCov">        956 :   AliTPCclusterMI *clusters[kMaxRow];</span>
<span class="lineNum">    8781 </span>            :   //
<span class="lineNum">    8782 </span><span class="lineCov">     305920 :   for (Int_t i=0;i&lt;kMaxRow;i++) {</span>
<span class="lineNum">    8783 </span><span class="lineCov">     152004 :     clusters[i]=0;</span>
<span class="lineNum">    8784 </span><span class="lineCov">     152004 :     lb[i]=mx[i]=0;</span>
<span class="lineNum">    8785 </span>            :   }
<span class="lineNum">    8786 </span>            : 
<span class="lineNum">    8787 </span>            :   Int_t i;
<span class="lineNum">    8788 </span>            :   Int_t current=0;
<span class="lineNum">    8789 </span><span class="lineCov">     439790 :   for (i=0; i&lt;kMaxRow &amp;&amp; current&lt;noc; i++) {</span>
<span class="lineNum">    8790 </span>            :      
<span class="lineNum">    8791 </span><span class="lineCov">     145912 :      Int_t index=t-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    8792 </span><span class="lineCov">     174182 :      if (index&lt;=0) continue; </span>
<span class="lineNum">    8793 </span><span class="lineCov">     121040 :      if (index&amp;0x8000) continue;</span>
<span class="lineNum">    8794 </span>            :      //     
<span class="lineNum">    8795 </span><span class="lineCov">     114244 :      clusters[current++]=GetClusterMI(index);</span>
<span class="lineNum">    8796 </span>            :      // if (t-&gt;GetClusterPointer(i)){
<span class="lineNum">    8797 </span>            :      //   clusters[current]=t-&gt;GetClusterPointer(i);     
<span class="lineNum">    8798 </span>            :      //   current++;
<span class="lineNum">    8799 </span>            :      // }
<span class="lineNum">    8800 </span><span class="lineCov">     114244 :   }</span>
<span class="lineNum">    8801 </span>            :   noc = current;
<span class="lineNum">    8802 </span>            : 
<span class="lineNum">    8803 </span>            :   Int_t lab=123456789;
<span class="lineNum">    8804 </span><span class="lineCov">     230400 :   for (i=0; i&lt;noc; i++) {</span>
<span class="lineNum">    8805 </span><span class="lineCov">     114244 :     AliTPCclusterMI *c=clusters[i];</span>
<span class="lineNum">    8806 </span><span class="lineCov">     114244 :     if (!c) continue;</span>
<span class="lineNum">    8807 </span><span class="lineCov">     114244 :     lab=TMath::Abs(c-&gt;GetLabel(0));</span>
<span class="lineNum">    8808 </span>            :     Int_t j;
<span class="lineNum">    8809 </span><span class="lineCov">     401895 :     for (j=0; j&lt;noc; j++) if (lb[j]==lab || mx[j]==0) break;</span>
<span class="lineNum">    8810 </span><span class="lineCov">     114244 :     lb[j]=lab;</span>
<span class="lineNum">    8811 </span><span class="lineCov">     114244 :     (mx[j])++;</span>
<span class="lineNum">    8812 </span><span class="lineCov">     114244 :   }</span>
<span class="lineNum">    8813 </span>            : 
<span class="lineNum">    8814 </span>            :   Int_t max=0;
<span class="lineNum">    8815 </span><span class="lineCov">     345662 :   for (i=0; i&lt;noc; i++) if (mx[i]&gt;max) {max=mx[i]; lab=lb[i];}</span>
<span class="lineNum">    8816 </span>            :     
<span class="lineNum">    8817 </span><span class="lineCov">     230400 :   for (i=0; i&lt;noc; i++) {</span>
<span class="lineNum">    8818 </span><span class="lineCov">     114244 :     AliTPCclusterMI *c=clusters[i]; </span>
<span class="lineNum">    8819 </span><span class="lineCov">     114244 :     if (!c) continue;</span>
<span class="lineNum">    8820 </span><span class="lineCov">     167618 :     if (TMath::Abs(c-&gt;GetLabel(1)) == lab ||</span>
<span class="lineNum">    8821 </span><span class="lineCov">     114287 :         TMath::Abs(c-&gt;GetLabel(2)) == lab ) max++;</span>
<span class="lineNum">    8822 </span><span class="lineCov">     114244 :   }</span>
<span class="lineNum">    8823 </span><span class="lineCov">        956 :   if (noc&lt;=0) { lab=-1; return;}</span>
<span class="lineNum">    8824 </span><span class="lineCov">        967 :   if ((1.- Float_t(max)/(noc)) &gt; wrong) lab=-lab;</span>
<span class="lineNum">    8825 </span>            : 
<span class="lineNum">    8826 </span>            :   else {
<span class="lineNum">    8827 </span><span class="lineCov">        945 :      Int_t tail=Int_t(0.10*noc);</span>
<span class="lineNum">    8828 </span>            :      max=0;
<span class="lineNum">    8829 </span>            :      Int_t ind=0;
<span class="lineNum">    8830 </span><span class="lineCov">      35499 :      for (i=1; i&lt;kMaxRow&amp;&amp;ind&lt;tail; i++) {</span>
<span class="lineNum">    8831 </span>            :        //       AliTPCclusterMI *c=clusters[noc-i];
<span class="lineNum">    8832 </span><span class="lineCov">      10888 :        AliTPCclusterMI *c=clusters[i];</span>
<span class="lineNum">    8833 </span><span class="lineCov">      10888 :        if (!c) continue;</span>
<span class="lineNum">    8834 </span><span class="lineCov">      11218 :        if (lab == TMath::Abs(c-&gt;GetLabel(0)) ||</span>
<span class="lineNum">    8835 </span><span class="lineCov">        566 :            lab == TMath::Abs(c-&gt;GetLabel(1)) ||</span>
<span class="lineNum">    8836 </span><span class="lineCov">      10888 :            lab == TMath::Abs(c-&gt;GetLabel(2))) max++;</span>
<span class="lineNum">    8837 </span><span class="lineCov">      10888 :        ind++;</span>
<span class="lineNum">    8838 </span><span class="lineCov">      10888 :      }</span>
<span class="lineNum">    8839 </span><span class="lineCov">        955 :      if (max &lt; Int_t(0.5*tail)) lab=-lab;</span>
<span class="lineNum">    8840 </span>            :   }
<span class="lineNum">    8841 </span>            : 
<span class="lineNum">    8842 </span><span class="lineCov">        956 :   t-&gt;SetLabel(lab);</span>
<span class="lineNum">    8843 </span>            : 
<span class="lineNum">    8844 </span>            :   //  delete[] lb;
<span class="lineNum">    8845 </span>            :   //delete[] mx;
<span class="lineNum">    8846 </span>            :   //delete[] clusters;
<span class="lineNum">    8847 </span><span class="lineCov">       2870 : }</span>
<span class="lineNum">    8848 </span>            : 
<a name="8849"><span class="lineNum">    8849 </span>            : </a>
<span class="lineNum">    8850 </span>            : //__________________________________________________________________________
<span class="lineNum">    8851 </span>            : Int_t AliTPCtracker::CookLabel(AliTPCseed *const t, Float_t wrong,Int_t first, Int_t last) const {
<span class="lineNum">    8852 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    8853 </span>            :   //This function &quot;cooks&quot; a track label. If label&lt;0, this track is fake.
<span class="lineNum">    8854 </span>            :   //--------------------------------------------------------------------
<span class="lineNum">    8855 </span><span class="lineCov">         64 :   Int_t noc=t-&gt;GetNumberOfClusters();</span>
<span class="lineNum">    8856 </span><span class="lineCov">         32 :   if (noc&lt;10){</span>
<span class="lineNum">    8857 </span>            :     //printf(&quot;\nnot founded prolongation\n\n\n&quot;);
<span class="lineNum">    8858 </span>            :     //t-&gt;Dump();
<span class="lineNum">    8859 </span><span class="lineNoCov">          0 :     return -1;</span>
<span class="lineNum">    8860 </span>            :   }
<span class="lineNum">    8861 </span><span class="lineCov">         32 :   Int_t lb[kMaxRow];</span>
<span class="lineNum">    8862 </span><span class="lineCov">         32 :   Int_t mx[kMaxRow];</span>
<span class="lineNum">    8863 </span><span class="lineCov">         32 :   AliTPCclusterMI *clusters[kMaxRow];</span>
<span class="lineNum">    8864 </span>            :   //
<span class="lineNum">    8865 </span><span class="lineCov">      10240 :   for (Int_t i=0;i&lt;kMaxRow;i++) {</span>
<span class="lineNum">    8866 </span><span class="lineCov">       5088 :     clusters[i]=0;</span>
<span class="lineNum">    8867 </span><span class="lineCov">       5088 :     lb[i]=mx[i]=0;</span>
<span class="lineNum">    8868 </span>            :   }
<span class="lineNum">    8869 </span>            : 
<span class="lineNum">    8870 </span>            :   Int_t i;
<span class="lineNum">    8871 </span>            :   Int_t current=0;
<span class="lineNum">    8872 </span><span class="lineCov">      15236 :   for (i=0; i&lt;kMaxRow &amp;&amp; current&lt;noc; i++) {</span>
<span class="lineNum">    8873 </span><span class="lineCov">       5054 :     if (i&lt;first) continue;</span>
<span class="lineNum">    8874 </span><span class="lineCov">       3740 :     if (i&gt;last)  continue;</span>
<span class="lineNum">    8875 </span><span class="lineCov">       2544 :      Int_t index=t-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    8876 </span><span class="lineCov">       3122 :      if (index&lt;=0) continue; </span>
<span class="lineNum">    8877 </span><span class="lineCov">       2110 :      if (index&amp;0x8000) continue;</span>
<span class="lineNum">    8878 </span>            :      //     
<span class="lineNum">    8879 </span><span class="lineCov">       1822 :      clusters[current++]=GetClusterMI(index);</span>
<span class="lineNum">    8880 </span>            :      // if (t-&gt;GetClusterPointer(i)){
<span class="lineNum">    8881 </span>            :      //   clusters[current]=t-&gt;GetClusterPointer(i);     
<span class="lineNum">    8882 </span>            :      //   current++;
<span class="lineNum">    8883 </span>            :      // }
<span class="lineNum">    8884 </span><span class="lineCov">       1822 :   }</span>
<span class="lineNum">    8885 </span>            :   noc = current;
<span class="lineNum">    8886 </span>            :   //if (noc&lt;5) return -1;
<span class="lineNum">    8887 </span>            :   Int_t lab=123456789;
<span class="lineNum">    8888 </span><span class="lineCov">       3708 :   for (i=0; i&lt;noc; i++) {</span>
<span class="lineNum">    8889 </span><span class="lineCov">       1822 :     AliTPCclusterMI *c=clusters[i];</span>
<span class="lineNum">    8890 </span><span class="lineCov">       1822 :     if (!c) continue;</span>
<span class="lineNum">    8891 </span><span class="lineCov">       1822 :     lab=TMath::Abs(c-&gt;GetLabel(0));</span>
<span class="lineNum">    8892 </span>            :     Int_t j;
<span class="lineNum">    8893 </span><span class="lineCov">       6387 :     for (j=0; j&lt;noc; j++) if (lb[j]==lab || mx[j]==0) break;</span>
<span class="lineNum">    8894 </span><span class="lineCov">       1822 :     lb[j]=lab;</span>
<span class="lineNum">    8895 </span><span class="lineCov">       1822 :     (mx[j])++;</span>
<span class="lineNum">    8896 </span><span class="lineCov">       1822 :   }</span>
<span class="lineNum">    8897 </span>            : 
<span class="lineNum">    8898 </span>            :   Int_t max=0;
<span class="lineNum">    8899 </span><span class="lineCov">       5565 :   for (i=0; i&lt;noc; i++) if (mx[i]&gt;max) {max=mx[i]; lab=lb[i];}</span>
<span class="lineNum">    8900 </span>            :     
<span class="lineNum">    8901 </span><span class="lineCov">       3708 :   for (i=0; i&lt;noc; i++) {</span>
<span class="lineNum">    8902 </span><span class="lineCov">       1822 :     AliTPCclusterMI *c=clusters[i]; </span>
<span class="lineNum">    8903 </span><span class="lineCov">       1822 :     if (!c) continue;</span>
<span class="lineNum">    8904 </span><span class="lineCov">       2688 :     if (TMath::Abs(c-&gt;GetLabel(1)) == lab ||</span>
<span class="lineNum">    8905 </span><span class="lineCov">       1822 :         TMath::Abs(c-&gt;GetLabel(2)) == lab ) max++;</span>
<span class="lineNum">    8906 </span><span class="lineCov">       1822 :   }</span>
<span class="lineNum">    8907 </span><span class="lineCov">         32 :   if (noc&lt;=0) { lab=-1; return -1;}</span>
<span class="lineNum">    8908 </span><span class="lineCov">         32 :   if ((1.- Float_t(max)/(noc)) &gt; wrong) lab=-lab;</span>
<span class="lineNum">    8909 </span>            : 
<span class="lineNum">    8910 </span>            :   else {
<span class="lineNum">    8911 </span><span class="lineCov">         32 :      Int_t tail=Int_t(0.10*noc);</span>
<span class="lineNum">    8912 </span>            :      max=0;
<span class="lineNum">    8913 </span>            :      Int_t ind=0;
<span class="lineNum">    8914 </span><span class="lineCov">        600 :      for (i=1; i&lt;kMaxRow&amp;&amp;ind&lt;tail; i++) {</span>
<span class="lineNum">    8915 </span>            :        //       AliTPCclusterMI *c=clusters[noc-i];
<span class="lineNum">    8916 </span><span class="lineCov">        168 :        AliTPCclusterMI *c=clusters[i];</span>
<span class="lineNum">    8917 </span><span class="lineCov">        168 :        if (!c) continue;</span>
<span class="lineNum">    8918 </span><span class="lineCov">        178 :        if (lab == TMath::Abs(c-&gt;GetLabel(0)) ||</span>
<span class="lineNum">    8919 </span><span class="lineCov">         15 :            lab == TMath::Abs(c-&gt;GetLabel(1)) ||</span>
<span class="lineNum">    8920 </span><span class="lineCov">        168 :            lab == TMath::Abs(c-&gt;GetLabel(2))) max++;</span>
<span class="lineNum">    8921 </span><span class="lineCov">        168 :        ind++;</span>
<span class="lineNum">    8922 </span><span class="lineCov">        168 :      }</span>
<span class="lineNum">    8923 </span><span class="lineCov">         33 :      if (max &lt; Int_t(0.5*tail)) lab=-lab;</span>
<span class="lineNum">    8924 </span>            :   }
<span class="lineNum">    8925 </span>            : 
<span class="lineNum">    8926 </span>            :   //  t-&gt;SetLabel(lab);
<span class="lineNum">    8927 </span><span class="lineCov">         32 :   return lab;</span>
<span class="lineNum">    8928 </span>            :   //  delete[] lb;
<span class="lineNum">    8929 </span>            :   //delete[] mx;
<span class="lineNum">    8930 </span>            :   //delete[] clusters;
<span class="lineNum">    8931 </span><span class="lineCov">         64 : }</span>
<a name="8932"><span class="lineNum">    8932 </span>            : </a>
<span class="lineNum">    8933 </span>            : 
<span class="lineNum">    8934 </span>            : Int_t  AliTPCtracker::GetRowNumber(Double_t x[3]) const 
<span class="lineNum">    8935 </span>            : {
<span class="lineNum">    8936 </span>            :   //return pad row number for given x vector
<span class="lineNum">    8937 </span><span class="lineNoCov">          0 :   Float_t phi = TMath::ATan2(x[1],x[0]);</span>
<span class="lineNum">    8938 </span><span class="lineNoCov">          0 :   if(phi&lt;0) phi=2.*TMath::Pi()+phi;</span>
<span class="lineNum">    8939 </span>            :   //  Get the local angle in the sector philoc
<span class="lineNum">    8940 </span>            :   const Float_t kRaddeg = 180/3.14159265358979312;
<span class="lineNum">    8941 </span><span class="lineNoCov">          0 :   Float_t phiangle   = (Int_t (phi*kRaddeg/20.) + 0.5)*20./kRaddeg;</span>
<span class="lineNum">    8942 </span><span class="lineNoCov">          0 :   Double_t localx    = x[0]*TMath::Cos(phiangle)-x[1]*TMath::Sin(phiangle);</span>
<span class="lineNum">    8943 </span><span class="lineNoCov">          0 :   return GetRowNumber(localx);</span>
<span class="lineNum">    8944 </span>            : }
<span class="lineNum">    8945 </span>            : 
<a name="8946"><span class="lineNum">    8946 </span>            : </a>
<span class="lineNum">    8947 </span>            : 
<span class="lineNum">    8948 </span>            : void AliTPCtracker::MakeESDBitmaps(AliTPCseed *t, AliESDtrack *esd)
<span class="lineNum">    8949 </span>            : {
<span class="lineNum">    8950 </span>            :   //-----------------------------------------------------------------------
<span class="lineNum">    8951 </span>            :   // Fill the cluster and sharing bitmaps of the track
<span class="lineNum">    8952 </span>            :   //-----------------------------------------------------------------------
<span class="lineNum">    8953 </span>            : 
<span class="lineNum">    8954 </span>            :   Int_t firstpoint = 0;
<span class="lineNum">    8955 </span>            :   Int_t lastpoint = kMaxRow;
<span class="lineNum">    8956 </span>            :   //  AliTPCclusterMI    *cluster;
<span class="lineNum">    8957 </span>            :   
<span class="lineNum">    8958 </span>            :   Int_t nclsf = 0;
<span class="lineNum">    8959 </span><span class="lineCov">        544 :   TBits clusterMap(kMaxRow);</span>
<span class="lineNum">    8960 </span><span class="lineCov">        272 :   TBits sharedMap(kMaxRow);</span>
<span class="lineNum">    8961 </span><span class="lineCov">        272 :   TBits fitMap(kMaxRow);</span>
<span class="lineNum">    8962 </span><span class="lineCov">      87040 :   for (int iter=firstpoint; iter&lt;lastpoint; iter++) {</span>
<span class="lineNum">    8963 </span>            :     // Change to cluster pointers to see if we have a cluster at given padrow
<span class="lineNum">    8964 </span><span class="lineCov">      43248 :     Int_t tpcindex= t-&gt;GetClusterIndex2(iter);</span>
<span class="lineNum">    8965 </span><span class="lineCov">      43248 :     if (tpcindex&gt;=0) {</span>
<span class="lineNum">    8966 </span><span class="lineCov">      33420 :       clusterMap.SetBitNumber(iter, kTRUE);</span>
<span class="lineNum">    8967 </span><span class="lineCov">      67416 :       if (t-&gt;IsShared(iter)) sharedMap.SetBitNumber(iter,kTRUE); // RS shared flag moved to seed</span>
<span class="lineNum">    8968 </span>            :       //
<span class="lineNum">    8969 </span><span class="lineCov">      33420 :       if ( (tpcindex&amp;0x8000) == 0)  {</span>
<span class="lineNum">    8970 </span><span class="lineCov">      32534 :         fitMap.SetBitNumber(iter, kTRUE);</span>
<span class="lineNum">    8971 </span><span class="lineCov">      32534 :         nclsf++;</span>
<span class="lineNum">    8972 </span><span class="lineCov">      32534 :       }</span>
<span class="lineNum">    8973 </span>            :     }
<span class="lineNum">    8974 </span>            :     // if (t-&gt;GetClusterIndex(iter) &gt;= 0 &amp;&amp; (t-&gt;GetClusterIndex(iter) &amp; 0x8000) == 0) {
<span class="lineNum">    8975 </span>            :     //   fitMap.SetBitNumber(iter, kTRUE);
<span class="lineNum">    8976 </span>            :     //   nclsf++;
<span class="lineNum">    8977 </span>            :     // }
<span class="lineNum">    8978 </span>            :   }
<span class="lineNum">    8979 </span><span class="lineCov">        272 :   esd-&gt;SetTPCClusterMap(clusterMap);</span>
<span class="lineNum">    8980 </span><span class="lineCov">        272 :   esd-&gt;SetTPCSharedMap(sharedMap);</span>
<span class="lineNum">    8981 </span><span class="lineCov">        272 :   esd-&gt;SetTPCFitMap(fitMap);</span>
<span class="lineNum">    8982 </span><span class="lineCov">        544 :   if (nclsf != t-&gt;GetNumberOfClusters())</span>
<span class="lineNum">    8983 </span><span class="lineCov">        670 :     AliDebug(3,Form(&quot;Inconsistency between ncls %d and indices %d (found %d)&quot;,t-&gt;GetNumberOfClusters(),nclsf,esd-&gt;GetTPCClusterMap().CountBits()));</span>
<a name="8984"><span class="lineNum">    8984 </span><span class="lineCov">        272 : }</span></a>
<span class="lineNum">    8985 </span>            : 
<span class="lineNum">    8986 </span>            : Bool_t AliTPCtracker::IsFindable(AliTPCseed &amp; track){
<span class="lineNum">    8987 </span>            :   //
<span class="lineNum">    8988 </span>            :   // return flag if there is findable cluster at given position
<span class="lineNum">    8989 </span>            :   //
<span class="lineNum">    8990 </span>            :   Float_t kDeltaZ=10;
<span class="lineNum">    8991 </span><span class="lineCov">     161444 :   Float_t z = track.GetZ();</span>
<span class="lineNum">    8992 </span>            :   
<span class="lineNum">    8993 </span><span class="lineCov">     161432 :   if (TMath::Abs(z)&lt;(AliTPCReconstructor::GetCtgRange()*track.GetX()+kDeltaZ) &amp;&amp; </span>
<span class="lineNum">    8994 </span><span class="lineCov">      80722 :       TMath::Abs(z)&lt;fkParam-&gt;GetZLength(0) &amp;&amp; </span>
<span class="lineNum">    8995 </span><span class="lineCov">      80710 :       (TMath::Abs(track.GetSnp())&lt;AliTPCReconstructor::GetMaxSnpTracker()))</span>
<span class="lineNum">    8996 </span><span class="lineCov">      80640 :     return kTRUE;</span>
<span class="lineNum">    8997 </span><span class="lineCov">         82 :   return kFALSE;      </span>
<span class="lineNum">    8998 </span><span class="lineCov">      80722 : }</span>
<a name="8999"><span class="lineNum">    8999 </span>            : </a>
<span class="lineNum">    9000 </span>            : 
<span class="lineNum">    9001 </span>            : void AliTPCtracker::AddCovariance(AliTPCseed * seed){
<span class="lineNum">    9002 </span>            :   //
<span class="lineNum">    9003 </span>            :   // Adding systematic error estimate to the covariance matrix
<span class="lineNum">    9004 </span>            :   //                !!!! the systematic error for element 4 is in 1/GeV 
<span class="lineNum">    9005 </span>            :   // 03.03.2012     MI changed in respect to the previous versions
<span class="lineNum">    9006 </span>            :   // in case systemtic errors defiend statically no correlation added (needed for CPass0)
<span class="lineNum">    9007 </span><span class="lineCov">       2712 :   const Double_t *param = (AliTPCReconstructor::GetSystematicError()!=NULL) ? AliTPCReconstructor::GetSystematicError():AliTPCReconstructor::GetRecoParam()-&gt;GetSystematicError();</span>
<span class="lineNum">    9008 </span>            :   //
<span class="lineNum">    9009 </span>            :   // use only the diagonal part if not specified otherwise
<span class="lineNum">    9010 </span><span class="lineCov">       1356 :   if (!AliTPCReconstructor::GetRecoParam()-&gt;GetUseSystematicCorrelation() || AliTPCReconstructor::GetSystematicError()) return AddCovarianceAdd(seed);</span>
<span class="lineNum">    9011 </span>            :   //
<span class="lineNum">    9012 </span><span class="lineCov">        678 :   Double_t *covarS= (Double_t*)seed-&gt;GetCovariance();</span>
<span class="lineNum">    9013 </span><span class="lineCov">        678 :   Double_t factor[5]={1,1,1,1,1};</span>
<span class="lineNum">    9014 </span><span class="lineCov">        678 :   factor[0]= TMath::Sqrt(TMath::Abs((covarS[0] + param[0]*param[0])/covarS[0]));</span>
<span class="lineNum">    9015 </span><span class="lineCov">        678 :   factor[1]= TMath::Sqrt(TMath::Abs((covarS[2] + param[1]*param[1])/covarS[2]));</span>
<span class="lineNum">    9016 </span><span class="lineCov">        678 :   factor[2]= TMath::Sqrt(TMath::Abs((covarS[5] + param[2]*param[2])/covarS[5]));</span>
<span class="lineNum">    9017 </span><span class="lineCov">        678 :   factor[3]= TMath::Sqrt(TMath::Abs((covarS[9] + param[3]*param[3])/covarS[9]));</span>
<span class="lineNum">    9018 </span><span class="lineCov">        678 :   factor[4]= TMath::Sqrt(TMath::Abs((covarS[14] +param[4]*param[4])/covarS[14]));</span>
<span class="lineNum">    9019 </span>            :   //
<span class="lineNum">    9020 </span><span class="lineCov">        678 :   factor[0]=factor[2];</span>
<span class="lineNum">    9021 </span><span class="lineCov">        678 :   factor[4]=factor[2];</span>
<span class="lineNum">    9022 </span>            :   // 0
<span class="lineNum">    9023 </span>            :   // 1    2
<span class="lineNum">    9024 </span>            :   // 3    4    5
<span class="lineNum">    9025 </span>            :   // 6    7    8    9 
<span class="lineNum">    9026 </span>            :   // 10   11   12   13   14
<span class="lineNum">    9027 </span><span class="lineCov">       8136 :   for (Int_t i=0; i&lt;5; i++){</span>
<span class="lineNum">    9028 </span><span class="lineCov">      27120 :     for (Int_t j=i; j&lt;5; j++){</span>
<span class="lineNum">    9029 </span><span class="lineCov">      10170 :       Int_t index=seed-&gt;GetIndex(i,j);</span>
<span class="lineNum">    9030 </span><span class="lineCov">      10170 :       covarS[index]*=factor[i]*factor[j];</span>
<span class="lineNum">    9031 </span>            :     }
<span class="lineNum">    9032 </span>            :   }
<span class="lineNum">    9033 </span><span class="lineCov">       1356 : }</span>
<a name="9034"><span class="lineNum">    9034 </span>            : </a>
<span class="lineNum">    9035 </span>            : 
<span class="lineNum">    9036 </span>            : void AliTPCtracker::AddCovarianceAdd(AliTPCseed * seed){
<span class="lineNum">    9037 </span>            :   //
<span class="lineNum">    9038 </span>            :   // Adding systematic error - as additive factor without correlation
<span class="lineNum">    9039 </span>            :   //
<span class="lineNum">    9040 </span>            :   //                !!!! the systematic error for element 4 is in 1/GeV 
<span class="lineNum">    9041 </span>            :   // 03.03.2012     MI changed in respect to the previous versions
<span class="lineNum">    9042 </span>            : 
<span class="lineNum">    9043 </span><span class="lineNoCov">          0 :   const Double_t *param = (AliTPCReconstructor::GetSystematicError()!=NULL) ? AliTPCReconstructor::GetSystematicError():AliTPCReconstructor::GetRecoParam()-&gt;GetSystematicError();</span>
<span class="lineNum">    9044 </span><span class="lineNoCov">          0 :   Double_t *covarIn= (Double_t*)seed-&gt;GetCovariance();</span>
<span class="lineNum">    9045 </span><span class="lineNoCov">          0 :   Double_t covar[15];</span>
<span class="lineNum">    9046 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;15;i++) covar[i]=0;</span>
<span class="lineNum">    9047 </span>            :   // 0
<span class="lineNum">    9048 </span>            :   // 1    2
<span class="lineNum">    9049 </span>            :   // 3    4    5
<span class="lineNum">    9050 </span>            :   // 6    7    8    9 
<span class="lineNum">    9051 </span>            :   // 10   11   12   13   14
<span class="lineNum">    9052 </span><span class="lineNoCov">          0 :   covar[0] = param[0]*param[0];</span>
<span class="lineNum">    9053 </span><span class="lineNoCov">          0 :   covar[2] = param[1]*param[1];</span>
<span class="lineNum">    9054 </span><span class="lineNoCov">          0 :   covar[5] = param[2]*param[2];</span>
<span class="lineNum">    9055 </span><span class="lineNoCov">          0 :   covar[9] = param[3]*param[3];</span>
<span class="lineNum">    9056 </span><span class="lineNoCov">          0 :   covar[14]= param[4]*param[4];</span>
<span class="lineNum">    9057 </span>            :   //
<span class="lineNum">    9058 </span><span class="lineNoCov">          0 :   covar[1]=TMath::Sqrt((covar[0]*covar[2]))*covarIn[1]/TMath::Sqrt((covarIn[0]*covarIn[2]));</span>
<span class="lineNum">    9059 </span>            :   //
<span class="lineNum">    9060 </span><span class="lineNoCov">          0 :   covar[3]=TMath::Sqrt((covar[0]*covar[5]))*covarIn[3]/TMath::Sqrt((covarIn[0]*covarIn[5]));</span>
<span class="lineNum">    9061 </span><span class="lineNoCov">          0 :   covar[4]=TMath::Sqrt((covar[2]*covar[5]))*covarIn[4]/TMath::Sqrt((covarIn[2]*covarIn[5]));</span>
<span class="lineNum">    9062 </span>            :   //
<span class="lineNum">    9063 </span><span class="lineNoCov">          0 :   covar[6]=TMath::Sqrt((covar[0]*covar[9]))*covarIn[6]/TMath::Sqrt((covarIn[0]*covarIn[9]));</span>
<span class="lineNum">    9064 </span><span class="lineNoCov">          0 :   covar[7]=TMath::Sqrt((covar[2]*covar[9]))*covarIn[7]/TMath::Sqrt((covarIn[2]*covarIn[9]));</span>
<span class="lineNum">    9065 </span><span class="lineNoCov">          0 :   covar[8]=TMath::Sqrt((covar[5]*covar[9]))*covarIn[8]/TMath::Sqrt((covarIn[5]*covarIn[9]));</span>
<span class="lineNum">    9066 </span>            :   //
<span class="lineNum">    9067 </span><span class="lineNoCov">          0 :   covar[10]=TMath::Sqrt((covar[0]*covar[14]))*covarIn[10]/TMath::Sqrt((covarIn[0]*covarIn[14]));</span>
<span class="lineNum">    9068 </span><span class="lineNoCov">          0 :   covar[11]=TMath::Sqrt((covar[2]*covar[14]))*covarIn[11]/TMath::Sqrt((covarIn[2]*covarIn[14]));</span>
<span class="lineNum">    9069 </span><span class="lineNoCov">          0 :   covar[12]=TMath::Sqrt((covar[5]*covar[14]))*covarIn[12]/TMath::Sqrt((covarIn[5]*covarIn[14]));</span>
<span class="lineNum">    9070 </span><span class="lineNoCov">          0 :   covar[13]=TMath::Sqrt((covar[9]*covar[14]))*covarIn[13]/TMath::Sqrt((covarIn[9]*covarIn[14]));</span>
<span class="lineNum">    9071 </span>            :   //
<span class="lineNum">    9072 </span><span class="lineNoCov">          0 :   seed-&gt;AddCovariance(covar);</span>
<span class="lineNum">    9073 </span><span class="lineNoCov">          0 : }</span>
<a name="9074"><span class="lineNum">    9074 </span>            : </a>
<span class="lineNum">    9075 </span>            : //_____________________________________________________________________________
<span class="lineNum">    9076 </span>            : Bool_t  AliTPCtracker::IsTPCHVDipEvent(AliESDEvent const *esdEvent)
<span class="lineNum">    9077 </span>            : {
<span class="lineNum">    9078 </span>            :   //
<span class="lineNum">    9079 </span>            :   // check events affected by TPC HV dip
<span class="lineNum">    9080 </span>            :   //
<span class="lineNum">    9081 </span><span class="lineCov">         16 :   if(!esdEvent) return kFALSE;</span>
<span class="lineNum">    9082 </span>            : 
<span class="lineNum">    9083 </span>            :   // Init TPC OCDB
<span class="lineNum">    9084 </span><span class="lineCov">          8 :   AliTPCcalibDB *db=AliTPCcalibDB::Instance();</span>
<span class="lineNum">    9085 </span><span class="lineCov">          8 :   if(!db) return kFALSE;</span>
<span class="lineNum">    9086 </span><span class="lineCov">          8 :   db-&gt;SetRun(esdEvent-&gt;GetRunNumber());</span>
<span class="lineNum">    9087 </span>            : 
<span class="lineNum">    9088 </span>            :   // maximum allowed voltage before an event is identified as a dip event
<span class="lineNum">    9089 </span>            :   // and scanning period
<span class="lineNum">    9090 </span><span class="lineCov">          8 :   const Double_t kTPCHVdip          = db-&gt;GetParameters()-&gt;GetMaxDipVoltage(); </span>
<span class="lineNum">    9091 </span><span class="lineCov">          8 :   const Double_t dipEventScanPeriod = db-&gt;GetParameters()-&gt;GetVoltageDipScanPeriod();</span>
<span class="lineNum">    9092 </span><span class="lineCov">          8 :   const Double_t tevSec             = esdEvent-&gt;GetTimeStamp();</span>
<span class="lineNum">    9093 </span>            :   
<span class="lineNum">    9094 </span><span class="lineCov">       1176 :   for(Int_t sector=0; sector&lt;72; sector++)</span>
<span class="lineNum">    9095 </span>            :   {
<span class="lineNum">    9096 </span>            :     // don't use excluded chambers, since the state is not defined at all
<span class="lineNum">    9097 </span><span class="lineCov">        576 :     if (!db-&gt;GetChamberHVStatus(sector)) continue;</span>
<span class="lineNum">    9098 </span>            :     
<span class="lineNum">    9099 </span>            :     // get hv sensor of the chamber
<span class="lineNum">    9100 </span><span class="lineCov">        576 :     AliDCSSensor *sensor = db-&gt;GetChamberHVSensor(sector);</span>
<span class="lineNum">    9101 </span><span class="lineCov">       1152 :     if (!sensor) continue;</span>
<span class="lineNum">    9102 </span><span class="lineNoCov">          0 :     TGraph *grSensor=sensor-&gt;GetGraph();</span>
<span class="lineNum">    9103 </span><span class="lineNoCov">          0 :     if (!grSensor) continue;</span>
<span class="lineNum">    9104 </span><span class="lineNoCov">          0 :     if (grSensor-&gt;GetN()&lt;1) continue;</span>
<span class="lineNum">    9105 </span>            :     
<span class="lineNum">    9106 </span>            :     // get median
<span class="lineNum">    9107 </span><span class="lineNoCov">          0 :     const Double_t median = db-&gt;GetChamberHighVoltageMedian(sector);</span>
<span class="lineNum">    9108 </span><span class="lineNoCov">          0 :     if(median &lt; 1.) continue;</span>
<span class="lineNum">    9109 </span>            :     
<span class="lineNum">    9110 </span><span class="lineNoCov">          0 :     for (Int_t ipoint=0; ipoint&lt;grSensor-&gt;GetN()-1; ++ipoint){</span>
<span class="lineNum">    9111 </span><span class="lineNoCov">          0 :       Double_t nextTime=grSensor-&gt;GetX()[ipoint+1]*3600+sensor-&gt;GetStartTime();</span>
<span class="lineNum">    9112 </span><span class="lineNoCov">          0 :       if (tevSec-dipEventScanPeriod&gt;nextTime) continue;</span>
<span class="lineNum">    9113 </span><span class="lineNoCov">          0 :       const Float_t deltaV=TMath::Abs(grSensor-&gt;GetY()[ipoint]-median);</span>
<span class="lineNum">    9114 </span><span class="lineNoCov">          0 :       if (deltaV&gt;kTPCHVdip) {</span>
<span class="lineNum">    9115 </span><span class="lineNoCov">          0 :         AliDebug(3,Form(&quot;HV dip detected in ROC '%02d' with dV '%.2f' at time stamp '%.0f'&quot;,sector,deltaV,tevSec));</span>
<span class="lineNum">    9116 </span><span class="lineNoCov">          0 :         return kTRUE;</span>
<span class="lineNum">    9117 </span>            :       }
<span class="lineNum">    9118 </span><span class="lineNoCov">          0 :       if (nextTime&gt;tevSec+dipEventScanPeriod) break;</span>
<span class="lineNum">    9119 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    9120 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9121 </span>            :   
<span class="lineNum">    9122 </span><span class="lineCov">          8 :   return kFALSE;</span>
<span class="lineNum">    9123 </span><span class="lineCov">          8 : }</span>
<a name="9124"><span class="lineNum">    9124 </span>            : </a>
<span class="lineNum">    9125 </span>            : //________________________________________
<span class="lineNum">    9126 </span>            : void AliTPCtracker::MarkSeedFree(TObject *sd) 
<span class="lineNum">    9127 </span>            : {
<span class="lineNum">    9128 </span>            :   // account that this seed is &quot;deleted&quot; 
<span class="lineNum">    9129 </span>            :   //  AliTPCseed* seed = dynamic_cast&lt;AliTPCseed*&gt;(sd);
<span class="lineNum">    9130 </span>            :   //  if (!seed) {
<span class="lineNum">    9131 </span>            :   //    AliError(Form(&quot;Freeing of non-AliTPCseed %p from the pool is requested&quot;,sd)); 
<span class="lineNum">    9132 </span>            :   //    return;
<span class="lineNum">    9133 </span>            :   //  }
<span class="lineNum">    9134 </span><span class="lineCov">      26940 :   AliTPCseed* seed = (AliTPCseed*)sd;</span>
<span class="lineNum">    9135 </span><span class="lineCov">      13470 :   int id = seed-&gt;GetPoolID();</span>
<span class="lineNum">    9136 </span><span class="lineCov">      13470 :   if (id&lt;0) {</span>
<span class="lineNum">    9137 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Freeing of seed %p NOT from the pool is requested&quot;,sd)); </span>
<span class="lineNum">    9138 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    9139 </span>            :   }
<span class="lineNum">    9140 </span>            :   //  AliInfo(Form(&quot;%d %p&quot;,id, seed));
<span class="lineNum">    9141 </span><span class="lineCov">      13470 :   fSeedsPool-&gt;RemoveAt(id);</span>
<span class="lineNum">    9142 </span><span class="lineCov">      13470 :   if (fFreeSeedsID.GetSize()&lt;=fNFreeSeeds) fFreeSeedsID.Set( 2*fNFreeSeeds + 100 );</span>
<span class="lineNum">    9143 </span><span class="lineCov">      13470 :   fFreeSeedsID.GetArray()[fNFreeSeeds++] = id;</span>
<span class="lineNum">    9144 </span><span class="lineCov">      26940 : }</span>
<a name="9145"><span class="lineNum">    9145 </span>            : </a>
<span class="lineNum">    9146 </span>            : //________________________________________
<span class="lineNum">    9147 </span>            : TObject *&amp;AliTPCtracker::NextFreeSeed()
<span class="lineNum">    9148 </span>            : {
<span class="lineNum">    9149 </span>            :   // return next free slot where the seed can be created
<span class="lineNum">    9150 </span><span class="lineCov">      55504 :   fLastSeedID = fNFreeSeeds ? fFreeSeedsID.GetArray()[--fNFreeSeeds] : fSeedsPool-&gt;GetEntriesFast();</span>
<span class="lineNum">    9151 </span>            :   //  AliInfo(Form(&quot;%d&quot;,fLastSeedID));
<span class="lineNum">    9152 </span><span class="lineCov">      13876 :   return (*fSeedsPool)[ fLastSeedID ];</span>
<span class="lineNum">    9153 </span>            :   //
<span class="lineNum">    9154 </span>            : }
<a name="9155"><span class="lineNum">    9155 </span>            : </a>
<span class="lineNum">    9156 </span>            : //________________________________________
<span class="lineNum">    9157 </span>            : void AliTPCtracker::ResetSeedsPool()
<span class="lineNum">    9158 </span>            : {
<span class="lineNum">    9159 </span>            :   // mark all seeds in the pool as unused
<span class="lineNum">    9160 </span><span class="lineCov">         48 :   AliInfo(Form(&quot;CurrentSize: %d, BookedUpTo: %d, free: %d&quot;,fSeedsPool-&gt;GetSize(),fSeedsPool-&gt;GetEntriesFast(),fNFreeSeeds));</span>
<span class="lineNum">    9161 </span><span class="lineCov">         24 :   fNFreeSeeds = 0;</span>
<span class="lineNum">    9162 </span><span class="lineCov">         24 :   fSeedsPool-&gt;Clear(); // RS: nominally the seeds may allocate memory...</span>
<span class="lineNum">    9163 </span>            :   
<a name="9164"><span class="lineNum">    9164 </span><span class="lineCov">         24 : }</span></a>
<span class="lineNum">    9165 </span>            : 
<span class="lineNum">    9166 </span>            : Int_t  AliTPCtracker::PropagateToRowHLT(AliTPCseed *pt, int nrow)
<span class="lineNum">    9167 </span>            : {
<span class="lineNum">    9168 </span>            :   AliTPCseed &amp;t=*pt;
<span class="lineNum">    9169 </span><span class="lineNoCov">          0 :   Double_t x= GetXrow(nrow);</span>
<span class="lineNum">    9170 </span><span class="lineNoCov">          0 :   Double_t  ymax= GetMaxY(nrow);</span>
<span class="lineNum">    9171 </span>            :   Int_t rotate = 0;
<span class="lineNum">    9172 </span>            :   Int_t nRotations=0;
<span class="lineNum">    9173 </span>            :   int ret = 1;
<span class="lineNum">    9174 </span><span class="lineNoCov">          0 :   do{</span>
<span class="lineNum">    9175 </span>            :     rotate = 0;
<span class="lineNum">    9176 </span><span class="lineNoCov">          0 :     if (!t.PropagateTo(x) ){</span>
<span class="lineNum">    9177 </span>            :       //cout&lt;&lt;&quot;can't propagate to row &quot;&lt;&lt;nrow&lt;&lt;&quot;, x=&quot;&lt;&lt;t.GetX()&lt;&lt;&quot; -&gt; &quot;&lt;&lt;x&lt;&lt;endl; 
<span class="lineNum">    9178 </span>            :       //t.Print();
<span class="lineNum">    9179 </span>            :       ret = 0;
<span class="lineNum">    9180 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    9181 </span>            :     }
<span class="lineNum">    9182 </span><span class="lineNoCov">          0 :     t.SetRow(nrow);</span>
<span class="lineNum">    9183 </span><span class="lineNoCov">          0 :     Double_t y = t.GetY();</span>
<span class="lineNum">    9184 </span>            :     double yEdgeDist = y;
<span class="lineNum">    9185 </span><span class="lineNoCov">          0 :     if  (fAccountDistortions) yEdgeDist -= GetYSectEdgeDist(t.GetRelativeSector(),nrow,y,t.GetZ());</span>
<span class="lineNum">    9186 </span><span class="lineNoCov">          0 :     if( y&gt;0 &amp;&amp; yEdgeDist&gt;ymax) {</span>
<span class="lineNum">    9187 </span><span class="lineNoCov">          0 :       if( rotate!=-1 ) rotate=1;</span>
<span class="lineNum">    9188 </span><span class="lineNoCov">          0 :     } else if  (y&lt;0 &amp;&amp; yEdgeDist&lt;-ymax) { </span>
<span class="lineNum">    9189 </span><span class="lineNoCov">          0 :       if( rotate!=1 ) rotate = -1;</span>
<span class="lineNum">    9190 </span>            :     }
<span class="lineNum">    9191 </span><span class="lineNoCov">          0 :     if( rotate==0 ) break;</span>
<span class="lineNum">    9192 </span>            :     //cout&lt;&lt;&quot;rotate at row &quot;&lt;&lt;nrow&lt;&lt;&quot;: &quot;&lt;&lt;rotate&lt;&lt;endl;
<span class="lineNum">    9193 </span><span class="lineNoCov">          0 :     if (!t.Rotate( rotate==1 ?fSectors-&gt;GetAlpha() :-fSectors-&gt;GetAlpha())) {</span>
<span class="lineNum">    9194 </span>            :       //cout&lt;&lt;&quot;can't rotate &quot;&lt;&lt;endl; 
<span class="lineNum">    9195 </span>            :       ret=0;
<span class="lineNum">    9196 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    9197 </span>            :     }
<span class="lineNum">    9198 </span><span class="lineNoCov">          0 :     nRotations+= rotate;</span>
<span class="lineNum">    9199 </span><span class="lineNoCov">          0 :   }while(rotate!=0);</span>
<span class="lineNum">    9200 </span><span class="lineNoCov">          0 :   if( nRotations!=0 ){</span>
<span class="lineNum">    9201 </span><span class="lineNoCov">          0 :     int newSec= t.GetRelativeSector()+nRotations;</span>
<span class="lineNum">    9202 </span><span class="lineNoCov">          0 :     if( newSec&gt;=fN ) newSec-=fN;</span>
<span class="lineNum">    9203 </span><span class="lineNoCov">          0 :     else if( newSec&lt;0 ) newSec +=fN; </span>
<span class="lineNum">    9204 </span>            :     //cout&lt;&lt;&quot;rotate at row &quot;&lt;&lt;nrow&lt;&lt;&quot;: &quot;&lt;&lt;nRotations&lt;&lt;&quot; times &quot;&lt;&lt;&quot; sec &quot;
<span class="lineNum">    9205 </span>            :     //&lt;&lt; t.GetRelativeSector()&lt;&lt;&quot; -&gt; &quot;&lt;&lt;newSec&lt;&lt;endl;
<span class="lineNum">    9206 </span><span class="lineNoCov">          0 :     t.SetRelativeSector(newSec);</span>
<span class="lineNum">    9207 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9208 </span><span class="lineNoCov">          0 :   return ret;</span>
<a name="9209"><span class="lineNum">    9209 </span>            : }</a>
<span class="lineNum">    9210 </span>            : 
<span class="lineNum">    9211 </span>            : void  AliTPCtracker::TrackFollowingHLT(TObjArray *const arr )
<span class="lineNum">    9212 </span>            : {
<span class="lineNum">    9213 </span>            :   //
<span class="lineNum">    9214 </span>            :   // try to track in parralel
<span class="lineNum">    9215 </span>            : 
<span class="lineNum">    9216 </span><span class="lineNoCov">          0 :   AliFatal(&quot;RS: This method is not yet aware of cluster pointers no present in the in-memory tracks&quot;);</span>
<span class="lineNum">    9217 </span>            : 
<span class="lineNum">    9218 </span><span class="lineNoCov">          0 :   Int_t nRows=fOuterSec-&gt;GetNRows()+fInnerSec-&gt;GetNRows();</span>
<span class="lineNum">    9219 </span><span class="lineNoCov">          0 :   fSectors=fInnerSec;</span>
<span class="lineNum">    9220 </span>            : 
<span class="lineNum">    9221 </span><span class="lineNoCov">          0 :   Int_t nseed=arr-&gt;GetEntriesFast();</span>
<span class="lineNum">    9222 </span>            :   //cout&lt;&lt;&quot;Parallel tracking My..&quot;&lt;&lt;endl;
<span class="lineNum">    9223 </span><span class="lineNoCov">          0 :   double shapeY2[kMaxRow], shapeZ2[kMaxRow];</span>
<span class="lineNum">    9224 </span><span class="lineNoCov">          0 :   Int_t clusterIndex[kMaxRow];</span>
<span class="lineNum">    9225 </span>            :  
<span class="lineNum">    9226 </span><span class="lineNoCov">          0 :   for (Int_t iSeed=0; iSeed&lt;nseed; iSeed++) {</span>
<span class="lineNum">    9227 </span>            :     //if( iSeed!=1 ) continue;
<span class="lineNum">    9228 </span><span class="lineNoCov">          0 :     AliTPCseed *pt=(AliTPCseed*) (arr-&gt;UncheckedAt(iSeed));</span>
<span class="lineNum">    9229 </span><span class="lineNoCov">          0 :     if (!pt) continue;</span>
<span class="lineNum">    9230 </span>            :     AliTPCseed &amp;t=*pt;    
<span class="lineNum">    9231 </span>            :     
<span class="lineNum">    9232 </span>            :     //cout &lt;&lt;&quot;Pt &quot;&lt;&lt;t.GetSigned1Pt()&lt;&lt;endl;
<span class="lineNum">    9233 </span>            :     
<span class="lineNum">    9234 </span>            :     // t.Print();
<span class="lineNum">    9235 </span>            :     
<span class="lineNum">    9236 </span><span class="lineNoCov">          0 :     for( int iter=0; iter&lt;3; iter++ ){</span>
<span class="lineNum">    9237 </span>            :             
<span class="lineNum">    9238 </span><span class="lineNoCov">          0 :       t.Reset();</span>
<span class="lineNum">    9239 </span><span class="lineNoCov">          0 :       t.SetLastPoint(0);  // first cluster in track position</span>
<span class="lineNum">    9240 </span><span class="lineNoCov">          0 :       t.SetFirstPoint(nRows-1);</span>
<span class="lineNum">    9241 </span><span class="lineNoCov">          0 :       t.ResetCovariance(.1);</span>
<span class="lineNum">    9242 </span><span class="lineNoCov">          0 :       t.SetNumberOfClusters(0);</span>
<span class="lineNum">    9243 </span><span class="lineNoCov">          0 :       for( int i=0; i&lt;nRows; i++ ){</span>
<span class="lineNum">    9244 </span><span class="lineNoCov">          0 :         shapeY2[i]=1.;</span>
<span class="lineNum">    9245 </span><span class="lineNoCov">          0 :         shapeZ2[i]=1.;</span>
<span class="lineNum">    9246 </span><span class="lineNoCov">          0 :         clusterIndex[i]=-1;</span>
<span class="lineNum">    9247 </span><span class="lineNoCov">          0 :         t.SetClusterIndex2(i,-1); </span>
<span class="lineNum">    9248 </span><span class="lineNoCov">          0 :         t.SetClusterIndex(i,-1); </span>
<span class="lineNum">    9249 </span>            :       }
<span class="lineNum">    9250 </span>            : 
<span class="lineNum">    9251 </span>            :      // pick up the clusters
<span class="lineNum">    9252 </span>            :       
<span class="lineNum">    9253 </span>            :       Double_t roady = 20.;
<span class="lineNum">    9254 </span>            :       Double_t roadz = 20.;
<span class="lineNum">    9255 </span>            :       double roadr = 5;
<span class="lineNum">    9256 </span>            : 
<span class="lineNum">    9257 </span><span class="lineNoCov">          0 :       AliTPCseed t0(t);</span>
<span class="lineNum">    9258 </span><span class="lineNoCov">          0 :       t0.Reset();</span>
<span class="lineNum">    9259 </span>            :       int nClusters = 0;      
<span class="lineNum">    9260 </span>            :       {
<span class="lineNum">    9261 </span><span class="lineNoCov">          0 :         t0.SetRelativeSector(t.GetRelativeSector());</span>
<span class="lineNum">    9262 </span><span class="lineNoCov">          0 :         t0.SetLastPoint(0);  // first cluster in track position</span>
<span class="lineNum">    9263 </span><span class="lineNoCov">          0 :         t0.SetFirstPoint(kMaxRow);</span>
<span class="lineNum">    9264 </span><span class="lineNoCov">          0 :         for (Int_t nr=0; nr&lt;nRows; nr++){ </span>
<span class="lineNum">    9265 </span><span class="lineNoCov">          0 :           if( nr&lt;fInnerSec-&gt;GetNRows() ) fSectors=fInnerSec;</span>
<span class="lineNum">    9266 </span><span class="lineNoCov">          0 :           else fSectors=fOuterSec;</span>
<span class="lineNum">    9267 </span>            : 
<span class="lineNum">    9268 </span><span class="lineNoCov">          0 :           if( !PropagateToRowHLT(&amp;t0, nr ) ){ break; }</span>
<span class="lineNum">    9269 </span><span class="lineNoCov">          0 :           if (TMath::Abs(t0.GetSnp())&gt;AliTPCReconstructor::GetMaxSnpTracker()){</span>
<span class="lineNum">    9270 </span>            :             //cout&lt;&lt;&quot;Snp is too big: &quot;&lt;&lt;t0.GetSnp()&lt;&lt;endl; 
<span class="lineNum">    9271 </span>            :             continue;
<span class="lineNum">    9272 </span>            :           }
<span class="lineNum">    9273 </span><span class="lineNoCov">          0 :           if (!IsActive(t0.GetRelativeSector(),nr)) {</span>
<span class="lineNum">    9274 </span>            :             continue;
<span class="lineNum">    9275 </span>            :           }
<span class="lineNum">    9276 </span>            :           
<span class="lineNum">    9277 </span><span class="lineNoCov">          0 :           if( iter==0 ){</span>
<span class="lineNum">    9278 </span><span class="lineNoCov">          0 :             GetShape(&amp;t0,nr); </span>
<span class="lineNum">    9279 </span><span class="lineNoCov">          0 :             shapeY2[nr]=t0.GetCurrentSigmaY2();</span>
<span class="lineNum">    9280 </span><span class="lineNoCov">          0 :             shapeZ2[nr]=t0.GetCurrentSigmaZ2();</span>
<span class="lineNum">    9281 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    9282 </span>            : 
<span class="lineNum">    9283 </span><span class="lineNoCov">          0 :           AliTPCtrackerRow &amp;krow=GetRow(t0.GetRelativeSector(),nr);</span>
<span class="lineNum">    9284 </span><span class="lineNoCov">          0 :           if( !krow ) continue; </span>
<span class="lineNum">    9285 </span>            : 
<span class="lineNum">    9286 </span><span class="lineNoCov">          0 :           t.SetClusterIndex2(nr,-3); // foundable</span>
<span class="lineNum">    9287 </span><span class="lineNoCov">          0 :           t.SetClusterIndex(nr,-3); </span>
<span class="lineNum">    9288 </span>            : 
<span class="lineNum">    9289 </span>            :           AliTPCclusterMI *cl=0;
<span class="lineNum">    9290 </span><span class="lineNoCov">          0 :           UInt_t uindex = 0;</span>
<span class="lineNum">    9291 </span><span class="lineNoCov">          0 :           cl = krow.FindNearest2(t0.GetY(),t0.GetZ(),roady+fClExtraRoadY,roadz+fClExtraRoadZ,uindex); </span>
<span class="lineNum">    9292 </span><span class="lineNoCov">          0 :           if (!cl ) continue;</span>
<span class="lineNum">    9293 </span><span class="lineNoCov">          0 :           double dy = cl-&gt;GetY()-t0.GetY();</span>
<span class="lineNum">    9294 </span><span class="lineNoCov">          0 :           double dz = cl-&gt;GetZ()-t0.GetZ();</span>
<span class="lineNum">    9295 </span><span class="lineNoCov">          0 :           double dr = sqrt(dy*dy+dz*dz);</span>
<span class="lineNum">    9296 </span><span class="lineNoCov">          0 :           if( dr&gt;roadr ){ </span>
<span class="lineNum">    9297 </span>            :             //cout&lt;&lt;&quot;row &quot;&lt;&lt;nr&lt;&lt;&quot;, best cluster r= &quot;&lt;&lt;dr&lt;&lt;&quot; y,z = &quot;&lt;&lt;dy&lt;&lt;&quot; &quot;&lt;&lt;dz&lt;&lt;endl;
<span class="lineNum">    9298 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    9299 </span>            :           }
<span class="lineNum">    9300 </span>            :           //cout&lt;&lt;&quot;row &quot;&lt;&lt;nr&lt;&lt;&quot;, found cluster r= &quot;&lt;&lt;dr&lt;&lt;&quot; y,z = &quot;&lt;&lt;dy&lt;&lt;&quot; &quot;&lt;&lt;dz&lt;&lt;endl;
<span class="lineNum">    9301 </span>            : 
<span class="lineNum">    9302 </span><span class="lineNoCov">          0 :           t0.SetClusterPointer(nr, cl);   </span>
<span class="lineNum">    9303 </span><span class="lineNoCov">          0 :           clusterIndex[nr] = krow.GetIndex(uindex);       </span>
<span class="lineNum">    9304 </span><span class="lineNoCov">          0 :           if( t0.GetFirstPoint()&gt;nr ) t0.SetFirstPoint(nr);</span>
<span class="lineNum">    9305 </span><span class="lineNoCov">          0 :           t0.SetLastPoint(nr);</span>
<span class="lineNum">    9306 </span><span class="lineNoCov">          0 :           nClusters++;</span>
<span class="lineNum">    9307 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    9308 </span>            :       }
<span class="lineNum">    9309 </span>            : 
<span class="lineNum">    9310 </span><span class="lineNoCov">          0 :       if( nClusters &lt;3 ){</span>
<span class="lineNum">    9311 </span>            :         //cout&lt;&lt;&quot;NOT ENOUGTH CLUSTERS: &quot;&lt;&lt;nClusters&lt;&lt;endl;
<span class="lineNum">    9312 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    9313 </span>            :       }
<span class="lineNum">    9314 </span><span class="lineNoCov">          0 :       Int_t basePoints[3] = {t0.GetFirstPoint(),t0.GetFirstPoint(),t0.GetLastPoint()};</span>
<span class="lineNum">    9315 </span>            : 
<span class="lineNum">    9316 </span>            :       // find midpoint
<span class="lineNum">    9317 </span>            :       {
<span class="lineNum">    9318 </span><span class="lineNoCov">          0 :         Int_t midRow = (t0.GetLastPoint()-t0.GetFirstPoint())/2;</span>
<span class="lineNum">    9319 </span>            :         int dist=200;
<span class="lineNum">    9320 </span><span class="lineNoCov">          0 :         for( int nr=t0.GetFirstPoint()+1; nr&lt; t0.GetLastPoint(); nr++){</span>
<span class="lineNum">    9321 </span>            :           //if (t0.GetClusterIndex2(nr)&lt;0) continue;
<span class="lineNum">    9322 </span><span class="lineNoCov">          0 :           if( !t0.GetClusterPointer(nr) ) continue;       </span>
<span class="lineNum">    9323 </span><span class="lineNoCov">          0 :           int d = TMath::Abs(nr-midRow);</span>
<span class="lineNum">    9324 </span><span class="lineNoCov">          0 :           if( d &lt; dist ){</span>
<span class="lineNum">    9325 </span>            :             dist = d;
<span class="lineNum">    9326 </span><span class="lineNoCov">          0 :             basePoints[1] = nr;</span>
<span class="lineNum">    9327 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    9328 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    9329 </span>            :       }
<span class="lineNum">    9330 </span>            : 
<span class="lineNum">    9331 </span>            :       // first fit 3 base points
<span class="lineNum">    9332 </span>            :       if( 1||iter&lt;2 ){
<span class="lineNum">    9333 </span>            :         //cout&lt;&lt;&quot;Fit3: &quot;&lt;&lt;endl;
<span class="lineNum">    9334 </span><span class="lineNoCov">          0 :         for( int icl=0; icl&lt;3; icl++){</span>
<span class="lineNum">    9335 </span><span class="lineNoCov">          0 :           int nr = basePoints[icl];</span>
<span class="lineNum">    9336 </span>            :           int lr=nr;
<span class="lineNum">    9337 </span><span class="lineNoCov">          0 :           if( nr&gt;=fInnerSec-&gt;GetNRows()){ </span>
<span class="lineNum">    9338 </span><span class="lineNoCov">          0 :             lr = nr - fInnerSec-&gt;GetNRows();</span>
<span class="lineNum">    9339 </span><span class="lineNoCov">          0 :             fSectors=fOuterSec;</span>
<span class="lineNum">    9340 </span><span class="lineNoCov">          0 :           } else fSectors=fInnerSec;</span>
<span class="lineNum">    9341 </span>            :           
<span class="lineNum">    9342 </span><span class="lineNoCov">          0 :           AliTPCclusterMI *cl=t0.GetClusterPointer(nr);</span>
<span class="lineNum">    9343 </span><span class="lineNoCov">          0 :           if(!cl){</span>
<span class="lineNum">    9344 </span>            :             //cout&lt;&lt;&quot;WRONG!!!!&quot;&lt;&lt;endl; 
<span class="lineNum">    9345 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    9346 </span>            :           }
<span class="lineNum">    9347 </span><span class="lineNoCov">          0 :           int iSec = cl-&gt;GetDetector() %fkNIS;</span>
<span class="lineNum">    9348 </span><span class="lineNoCov">          0 :           int rotate = iSec - t.GetRelativeSector();    </span>
<span class="lineNum">    9349 </span><span class="lineNoCov">          0 :           if( rotate!=0 ){</span>
<span class="lineNum">    9350 </span>            :             //cout&lt;&lt;&quot;Rotate at row&quot;&lt;&lt;nr&lt;&lt;&quot; to &quot;&lt;&lt;rotate&lt;&lt;&quot; sectors&quot;&lt;&lt;endl;
<span class="lineNum">    9351 </span><span class="lineNoCov">          0 :             if (!t.Rotate( rotate*fSectors-&gt;GetAlpha()) ) {</span>
<span class="lineNum">    9352 </span>            :               //cout&lt;&lt;&quot;can't rotate &quot;&lt;&lt;endl; 
<span class="lineNum">    9353 </span><span class="lineNoCov">          0 :               break;</span>
<span class="lineNum">    9354 </span>            :             }
<span class="lineNum">    9355 </span><span class="lineNoCov">          0 :             t.SetRelativeSector(iSec);</span>
<span class="lineNum">    9356 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    9357 </span><span class="lineNoCov">          0 :           Double_t x= cl-&gt;GetX();</span>
<span class="lineNum">    9358 </span><span class="lineNoCov">          0 :           if (!t.PropagateTo(x)){</span>
<span class="lineNum">    9359 </span>            :             //cout&lt;&lt;&quot;can't propagate to x=&quot;&lt;&lt;x&lt;&lt;endl; 
<span class="lineNum">    9360 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9361 </span>            :           }    
<span class="lineNum">    9362 </span><span class="lineNoCov">          0 :           t.SetRow(nr); // RS: memorise row</span>
<span class="lineNum">    9363 </span><span class="lineNoCov">          0 :           if (TMath::Abs(t.GetSnp())&gt;AliTPCReconstructor::GetMaxSnpTracker()){</span>
<span class="lineNum">    9364 </span>            :             //cout&lt;&lt;&quot;Snp is too big: &quot;&lt;&lt;t.GetSnp()&lt;&lt;endl; 
<span class="lineNum">    9365 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9366 </span>            :           }
<span class="lineNum">    9367 </span>            :           //cout&lt;&lt;&quot;fit3 : row &quot;&lt;&lt;nr&lt;&lt;&quot; ind = &quot;&lt;&lt;clusterIndex[nr]&lt;&lt;endl;
<span class="lineNum">    9368 </span>            :           
<span class="lineNum">    9369 </span><span class="lineNoCov">          0 :           t.SetCurrentClusterIndex1(clusterIndex[nr]);</span>
<span class="lineNum">    9370 </span><span class="lineNoCov">          0 :           t.SetCurrentCluster(cl);</span>
<span class="lineNum">    9371 </span><span class="lineNoCov">          0 :           t.SetRow(lr); </span>
<span class="lineNum">    9372 </span>            :           
<span class="lineNum">    9373 </span><span class="lineNoCov">          0 :           t.SetErrorY2(shapeY2[nr]);</span>
<span class="lineNum">    9374 </span><span class="lineNoCov">          0 :           t.SetErrorZ2(shapeZ2[nr]);</span>
<span class="lineNum">    9375 </span><span class="lineNoCov">          0 :           if( icl==0 ){</span>
<span class="lineNum">    9376 </span><span class="lineNoCov">          0 :             double cov[15];</span>
<span class="lineNum">    9377 </span><span class="lineNoCov">          0 :             for( int j=0; j&lt;15; j++ ) cov[j]=0;</span>
<span class="lineNum">    9378 </span><span class="lineNoCov">          0 :             cov[0]=10;</span>
<span class="lineNum">    9379 </span><span class="lineNoCov">          0 :             cov[2]=10;</span>
<span class="lineNum">    9380 </span><span class="lineNoCov">          0 :             cov[5]=.5;</span>
<span class="lineNum">    9381 </span><span class="lineNoCov">          0 :             cov[9]=.5;</span>
<span class="lineNum">    9382 </span><span class="lineNoCov">          0 :             cov[14]=1.;</span>
<span class="lineNum">    9383 </span><span class="lineNoCov">          0 :             t.AliExternalTrackParam::AddCovariance(cov);</span>
<span class="lineNum">    9384 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    9385 </span><span class="lineNoCov">          0 :           if( !UpdateTrack(&amp;t,0) ){</span>
<span class="lineNum">    9386 </span>            :             //cout&lt;&lt;&quot;Can not update&quot;&lt;&lt;endl;
<span class="lineNum">    9387 </span>            :             //t.Print();
<span class="lineNum">    9388 </span><span class="lineNoCov">          0 :             t.SetClusterIndex2(nr,-1); </span>
<span class="lineNum">    9389 </span><span class="lineNoCov">          0 :             t.SetClusterIndex(nr,-1); </span>
<span class="lineNum">    9390 </span><span class="lineNoCov">          0 :             t.SetClusterPointer(nr,0); </span>
<span class="lineNum">    9391 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9392 </span>            :           }             
<span class="lineNum">    9393 </span>            :           //t.SetClusterPointer(nr, cl);
<span class="lineNum">    9394 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    9395 </span>            :         
<span class="lineNum">    9396 </span>            :         //t.SetLastPoint(t0.GetLastPoint());
<span class="lineNum">    9397 </span>            :         //t.SetFirstPoint(t0.GetFirstPoint());
<span class="lineNum">    9398 </span>            : 
<span class="lineNum">    9399 </span>            :         //cout&lt;&lt;&quot;Fit: &quot;&lt;&lt;endl;
<span class="lineNum">    9400 </span><span class="lineNoCov">          0 :         for (Int_t nr=t0.GetLastPoint(); nr&gt;=t0.GetFirstPoint(); nr-- ){</span>
<span class="lineNum">    9401 </span>            :           int lr=nr;
<span class="lineNum">    9402 </span><span class="lineNoCov">          0 :           if( nr&gt;=fInnerSec-&gt;GetNRows()){ </span>
<span class="lineNum">    9403 </span><span class="lineNoCov">          0 :             lr = nr - fInnerSec-&gt;GetNRows();</span>
<span class="lineNum">    9404 </span><span class="lineNoCov">          0 :             fSectors=fOuterSec;</span>
<span class="lineNum">    9405 </span><span class="lineNoCov">          0 :           } else fSectors=fInnerSec;</span>
<span class="lineNum">    9406 </span>            :           
<span class="lineNum">    9407 </span>            :           if(1|| iter&lt;2 ){
<span class="lineNum">    9408 </span><span class="lineNoCov">          0 :             if( nr == basePoints[0] ) continue;</span>
<span class="lineNum">    9409 </span><span class="lineNoCov">          0 :             if( nr == basePoints[1] ) continue;</span>
<span class="lineNum">    9410 </span><span class="lineNoCov">          0 :             if( nr == basePoints[2] ) continue;</span>
<span class="lineNum">    9411 </span>            :           }
<span class="lineNum">    9412 </span><span class="lineNoCov">          0 :           AliTPCclusterMI *cl=t0.GetClusterPointer(nr);</span>
<span class="lineNum">    9413 </span><span class="lineNoCov">          0 :           if(!cl) continue;</span>
<span class="lineNum">    9414 </span>            :           
<span class="lineNum">    9415 </span><span class="lineNoCov">          0 :           int iSec = cl-&gt;GetDetector() %fkNIS;</span>
<span class="lineNum">    9416 </span><span class="lineNoCov">          0 :           int rotate = iSec - t.GetRelativeSector();    </span>
<span class="lineNum">    9417 </span><span class="lineNoCov">          0 :           if( rotate!=0 ){</span>
<span class="lineNum">    9418 </span>            :             //cout&lt;&lt;&quot;Rotate at row&quot;&lt;&lt;nr&lt;&lt;&quot; to &quot;&lt;&lt;rotate&lt;&lt;&quot; sectors&quot;&lt;&lt;endl;
<span class="lineNum">    9419 </span><span class="lineNoCov">          0 :             if (!t.Rotate( rotate*fSectors-&gt;GetAlpha()) ) {</span>
<span class="lineNum">    9420 </span>            :               //cout&lt;&lt;&quot;can't rotate &quot;&lt;&lt;endl; 
<span class="lineNum">    9421 </span><span class="lineNoCov">          0 :               break;</span>
<span class="lineNum">    9422 </span>            :             }
<span class="lineNum">    9423 </span><span class="lineNoCov">          0 :             t.SetRelativeSector(iSec);</span>
<span class="lineNum">    9424 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    9425 </span><span class="lineNoCov">          0 :           Double_t x= cl-&gt;GetX();</span>
<span class="lineNum">    9426 </span><span class="lineNoCov">          0 :           if (!t.PropagateTo(x)){</span>
<span class="lineNum">    9427 </span>            :             //cout&lt;&lt;&quot;can't propagate to x=&quot;&lt;&lt;x&lt;&lt;endl; 
<span class="lineNum">    9428 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9429 </span>            :           }    
<span class="lineNum">    9430 </span><span class="lineNoCov">          0 :           if (TMath::Abs(t.GetSnp())&gt;AliTPCReconstructor::GetMaxSnpTracker()){</span>
<span class="lineNum">    9431 </span>            :             //cout&lt;&lt;&quot;Snp is too big: &quot;&lt;&lt;t.GetSnp()&lt;&lt;endl; 
<span class="lineNum">    9432 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9433 </span>            :           }     
<span class="lineNum">    9434 </span><span class="lineNoCov">          0 :           t.SetRow(nr); //RS: memorise row</span>
<span class="lineNum">    9435 </span>            :           //cout&lt;&lt;&quot;fit: row &quot;&lt;&lt;nr&lt;&lt;&quot; ind = &quot;&lt;&lt;clusterIndex[nr]&lt;&lt;endl;
<span class="lineNum">    9436 </span>            : 
<span class="lineNum">    9437 </span><span class="lineNoCov">          0 :           t.SetCurrentClusterIndex1(clusterIndex[nr]);</span>
<span class="lineNum">    9438 </span><span class="lineNoCov">          0 :           t.SetCurrentCluster(cl);</span>
<span class="lineNum">    9439 </span><span class="lineNoCov">          0 :           t.SetRow(lr); </span>
<span class="lineNum">    9440 </span><span class="lineNoCov">          0 :           t.SetErrorY2(shapeY2[nr]);</span>
<span class="lineNum">    9441 </span><span class="lineNoCov">          0 :           t.SetErrorZ2(shapeZ2[nr]);</span>
<span class="lineNum">    9442 </span>            :           
<span class="lineNum">    9443 </span><span class="lineNoCov">          0 :           if( !UpdateTrack(&amp;t,0) ){</span>
<span class="lineNum">    9444 </span>            :             //cout&lt;&lt;&quot;Can not update&quot;&lt;&lt;endl;
<span class="lineNum">    9445 </span>            :             //t.Print();
<span class="lineNum">    9446 </span><span class="lineNoCov">          0 :             t.SetClusterIndex2(nr,-1); </span>
<span class="lineNum">    9447 </span><span class="lineNoCov">          0 :             t.SetClusterIndex(nr,-1); </span>
<span class="lineNum">    9448 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9449 </span>            :           }             
<span class="lineNum">    9450 </span>            :           //t.SetClusterPointer(nr, cl);
<span class="lineNum">    9451 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    9452 </span>            :       }
<span class="lineNum">    9453 </span>            :       //cout&lt;&lt;&quot;After iter &quot;&lt;&lt;iter&lt;&lt;&quot;: N clusters=&quot;&lt;&lt;t.GetNumberOfClusters()&lt;&lt;&quot; : &quot;&lt;&lt;nClusters&lt;&lt;endl;
<span class="lineNum">    9454 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    9455 </span>            : 
<span class="lineNum">    9456 </span>            :     //cout&lt;&lt;&quot;fitted track&quot;&lt;&lt;iSeed&lt;&lt;endl;
<span class="lineNum">    9457 </span>            :     //t.Print();
<span class="lineNum">    9458 </span>            :     //cout&lt;&lt;&quot;Statistics: &quot;&lt;&lt;endl;    
<span class="lineNum">    9459 </span><span class="lineNoCov">          0 :     Int_t foundable,found,shared;</span>
<span class="lineNum">    9460 </span>            :     //t.GetClusterStatistic(0,nRows, found, foundable, shared, kTRUE);
<span class="lineNum">    9461 </span><span class="lineNoCov">          0 :     t.GetClusterStatistic(0,nRows, found, foundable); //RS shared info is not used, use faster method</span>
<span class="lineNum">    9462 </span><span class="lineNoCov">          0 :     t.SetNFoundable(foundable);</span>
<span class="lineNum">    9463 </span>            :     //cout&lt;&lt;&quot;found &quot;&lt;&lt;found&lt;&lt;&quot; foundable &quot;&lt;&lt;foundable&lt;&lt;&quot; shared &quot;&lt;&lt;shared&lt;&lt;endl;
<span class="lineNum">    9464 </span>            :     
<span class="lineNum">    9465 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9466 </span><span class="lineNoCov">          0 : }</span>
<a name="9467"><span class="lineNum">    9467 </span>            : </a>
<span class="lineNum">    9468 </span>            : 
<span class="lineNum">    9469 </span>            : TObjArray * AliTPCtracker::MakeSeedsHLT(const AliESDEvent *hltEvent)
<span class="lineNum">    9470 </span>            : {
<span class="lineNum">    9471 </span>            :   // tracking
<span class="lineNum">    9472 </span>            :   //  
<span class="lineNum">    9473 </span><span class="lineNoCov">          0 :   AliFatal(&quot;RS: This method is not yet aware of cluster pointers no present in the in-memory tracks&quot;);</span>
<span class="lineNum">    9474 </span><span class="lineNoCov">          0 :   if( !hltEvent ) return 0;  </span>
<span class="lineNum">    9475 </span>            :  
<span class="lineNum">    9476 </span>            : 
<span class="lineNum">    9477 </span><span class="lineNoCov">          0 :   Int_t nentr=hltEvent-&gt;GetNumberOfTracks();</span>
<span class="lineNum">    9478 </span>            :  
<span class="lineNum">    9479 </span><span class="lineNoCov">          0 :   AliInfo(Form(&quot;Using %d HLT tracks for seeding&quot;,nentr));</span>
<span class="lineNum">    9480 </span>            :  
<span class="lineNum">    9481 </span><span class="lineNoCov">          0 :   TObjArray * seeds = new TObjArray(nentr);</span>
<span class="lineNum">    9482 </span>            : 
<span class="lineNum">    9483 </span><span class="lineNoCov">          0 :   Int_t nup=fOuterSec-&gt;GetNRows()+fInnerSec-&gt;GetNRows();</span>
<span class="lineNum">    9484 </span>            :   Int_t index = 0;
<span class="lineNum">    9485 </span>            :   
<span class="lineNum">    9486 </span><span class="lineNoCov">          0 :   Int_t nTr=hltEvent-&gt;GetNumberOfTracks();      </span>
<span class="lineNum">    9487 </span>            :     
<span class="lineNum">    9488 </span><span class="lineNoCov">          0 :   for( int itr=0; itr&lt;nTr; itr++ ){</span>
<span class="lineNum">    9489 </span>            :     //if( itr!=97 ) continue;
<span class="lineNum">    9490 </span><span class="lineNoCov">          0 :     const AliExternalTrackParam *param = hltEvent-&gt;GetTrack(itr)-&gt;GetTPCInnerParam();</span>
<span class="lineNum">    9491 </span><span class="lineNoCov">          0 :     if( !param ) continue;</span>
<span class="lineNum">    9492 </span>            :     //if( TMath::Abs(esdTr-&gt;GetSigned1Pt())&gt;1 ) continue;
<span class="lineNum">    9493 </span>            :     //if( TMath::Abs(esdTr-&gt;GetTgl())&gt;1. ) continue;
<span class="lineNum">    9494 </span><span class="lineNoCov">          0 :     AliTPCtrack tr;    </span>
<span class="lineNum">    9495 </span><span class="lineNoCov">          0 :     tr.Set(param-&gt;GetX(),param-&gt;GetAlpha(),param-&gt;GetParameter(),param-&gt;GetCovariance());</span>
<span class="lineNum">    9496 </span><span class="lineNoCov">          0 :     tr.SetNumberOfClusters(0);</span>
<span class="lineNum">    9497 </span><span class="lineNoCov">          0 :     AliTPCseed * seed = new( NextFreeSeed() ) AliTPCseed(tr);</span>
<span class="lineNum">    9498 </span>            : 
<span class="lineNum">    9499 </span><span class="lineNoCov">          0 :     Double_t alpha=seed-&gt;GetAlpha();// - fSectors-&gt;GetAlphaShift();</span>
<span class="lineNum">    9500 </span><span class="lineNoCov">          0 :     if (alpha &gt; 2.*TMath::Pi()) alpha -= 2.*TMath::Pi();</span>
<span class="lineNum">    9501 </span><span class="lineNoCov">          0 :     if (alpha &lt; 0.            ) alpha += 2.*TMath::Pi();</span>
<span class="lineNum">    9502 </span>            :     //
<span class="lineNum">    9503 </span><span class="lineNoCov">          0 :     seed-&gt;SetRelativeSector(Int_t(alpha/fSectors-&gt;GetAlpha()+0.0001)%fN);</span>
<span class="lineNum">    9504 </span><span class="lineNoCov">          0 :     Double_t alphaSec = fSectors-&gt;GetAlpha() * seed-&gt;GetRelativeSector() + fSectors-&gt;GetAlphaShift();</span>
<span class="lineNum">    9505 </span>            :  
<span class="lineNum">    9506 </span><span class="lineNoCov">          0 :     if (alphaSec &gt;= TMath::Pi()) alphaSec -= 2.*TMath::Pi();</span>
<span class="lineNum">    9507 </span><span class="lineNoCov">          0 :     if (alphaSec &lt; -TMath::Pi()) alphaSec += 2.*TMath::Pi();</span>
<span class="lineNum">    9508 </span>            : 
<span class="lineNum">    9509 </span><span class="lineNoCov">          0 :     seed-&gt;Rotate(alphaSec - alpha);</span>
<span class="lineNum">    9510 </span>            :     
<span class="lineNum">    9511 </span><span class="lineNoCov">          0 :     seed-&gt;SetPoolID(fLastSeedID);</span>
<span class="lineNum">    9512 </span><span class="lineNoCov">          0 :     seed-&gt;SetIsSeeding(kTRUE);</span>
<span class="lineNum">    9513 </span><span class="lineNoCov">          0 :     seed-&gt;SetSeed1(nup-1);</span>
<span class="lineNum">    9514 </span><span class="lineNoCov">          0 :     seed-&gt;SetSeed2(nup-2);</span>
<span class="lineNum">    9515 </span><span class="lineNoCov">          0 :     seed-&gt;SetSeedType(0);</span>
<span class="lineNum">    9516 </span><span class="lineNoCov">          0 :     seed-&gt;SetFirstPoint(-1);</span>
<span class="lineNum">    9517 </span><span class="lineNoCov">          0 :     seed-&gt;SetLastPoint(-1);</span>
<span class="lineNum">    9518 </span><span class="lineNoCov">          0 :     seeds-&gt;AddLast(seed); // note, track is seed, don't free the seed</span>
<span class="lineNum">    9519 </span><span class="lineNoCov">          0 :     index++;</span>
<span class="lineNum">    9520 </span>            :     //if( index&gt;3 ) break;
<span class="lineNum">    9521 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9522 </span>            :  
<span class="lineNum">    9523 </span>            : 
<span class="lineNum">    9524 </span><span class="lineNoCov">          0 :   fSectors = fOuterSec;</span>
<span class="lineNum">    9525 </span>            :   
<span class="lineNum">    9526 </span><span class="lineNoCov">          0 :   TrackFollowingHLT(seeds );</span>
<span class="lineNum">    9527 </span>            : 
<span class="lineNum">    9528 </span><span class="lineNoCov">          0 :   nTr = seeds-&gt;GetEntriesFast();</span>
<span class="lineNum">    9529 </span><span class="lineNoCov">          0 :   for( int itr=0; itr&lt;nTr; itr++ ){</span>
<span class="lineNum">    9530 </span><span class="lineNoCov">          0 :     AliTPCseed * seed = (AliTPCseed*) seeds-&gt;UncheckedAt(itr);</span>
<span class="lineNum">    9531 </span><span class="lineNoCov">          0 :     if( !seed ) continue;</span>
<span class="lineNum">    9532 </span>            :     //FollowBackProlongation(*seed,0);
<span class="lineNum">    9533 </span>            :     // cout&lt;&lt;seed-&gt;GetNumberOfClusters()&lt;&lt;endl;
<span class="lineNum">    9534 </span><span class="lineNoCov">          0 :     Int_t foundable,found;//,shared;</span>
<span class="lineNum">    9535 </span>            :     //    seed-&gt;GetClusterStatistic(0,nup, found, foundable, shared, kTRUE); //RS shared info is not used, use faster method
<span class="lineNum">    9536 </span><span class="lineNoCov">          0 :     seed-&gt;GetClusterStatistic(0,nup, found, foundable);</span>
<span class="lineNum">    9537 </span><span class="lineNoCov">          0 :     seed-&gt;SetNFoundable(foundable);</span>
<span class="lineNum">    9538 </span>            :     //cout&lt;&lt;&quot;found &quot;&lt;&lt;found&lt;&lt;&quot; foundable &quot;&lt;&lt;foundable&lt;&lt;&quot; shared &quot;&lt;&lt;shared&lt;&lt;endl;
<span class="lineNum">    9539 </span>            :     //if ((found&lt;0.55*foundable)  || shared&gt;0.5*found ){// || (seed-&gt;GetSigmaY2()+seed-&gt;GetSigmaZ2())&gt;0.5){
<span class="lineNum">    9540 </span>            :     //MarkSeedFree(seeds-&gt;RemoveAt(itr)); 
<span class="lineNum">    9541 </span>            :     //continue;
<span class="lineNum">    9542 </span>            :     //}
<span class="lineNum">    9543 </span><span class="lineNoCov">          0 :     if (seed-&gt;GetNumberOfClusters()&lt;30 || </span>
<span class="lineNum">    9544 </span><span class="lineNoCov">          0 :         seed-&gt;GetNumberOfClusters() &lt; seed-&gt;GetNFoundable()*0.6 || </span>
<span class="lineNum">    9545 </span><span class="lineNoCov">          0 :         seed-&gt;GetNShared()&gt;0.4*seed-&gt;GetNumberOfClusters() ) {</span>
<span class="lineNum">    9546 </span><span class="lineNoCov">          0 :       MarkSeedFree(seeds-&gt;RemoveAt(itr)); </span>
<span class="lineNum">    9547 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    9548 </span>            :     }      
<span class="lineNum">    9549 </span>            : 
<span class="lineNum">    9550 </span><span class="lineNoCov">          0 :     for( int ir=0; ir&lt;nup; ir++){</span>
<span class="lineNum">    9551 </span><span class="lineNoCov">          0 :       AliTPCclusterMI *c = seed-&gt;GetClusterPointer(ir);      </span>
<span class="lineNum">    9552 </span><span class="lineNoCov">          0 :       if( c ) c-&gt;Use(10);</span>
<span class="lineNum">    9553 </span>            :     }
<span class="lineNum">    9554 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9555 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;\n\nHLT tracks left: &quot;&lt;&lt;seeds-&gt;GetEntries()&lt;&lt;&quot; out of &quot;&lt;&lt;hltEvent-&gt;GetNumberOfTracks()&lt;&lt;endl&lt;&lt;endl;</span>
<span class="lineNum">    9556 </span>            :   return seeds;    
<a name="9557"><span class="lineNum">    9557 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    9558 </span>            : 
<span class="lineNum">    9559 </span>            : void AliTPCtracker::FillClusterOccupancyInfo()
<span class="lineNum">    9560 </span>            : {
<span class="lineNum">    9561 </span>            :   //fill the cluster occupancy info into the ESD friend
<span class="lineNum">    9562 </span><span class="lineCov">         16 :   AliESDfriend* esdFriend = static_cast&lt;AliESDfriend*&gt;(fEvent-&gt;FindListObject(&quot;AliESDfriend&quot;));</span>
<span class="lineNum">    9563 </span><span class="lineCov">          8 :   if (!esdFriend) return;</span>
<span class="lineNum">    9564 </span>            : 
<span class="lineNum">    9565 </span><span class="lineCov">        304 :   for (Int_t isector=0; isector&lt;18; isector++){</span>
<span class="lineNum">    9566 </span><span class="lineCov">        144 :     AliTPCtrackerSector &amp;iroc = fInnerSec[isector];</span>
<span class="lineNum">    9567 </span><span class="lineCov">        144 :     AliTPCtrackerSector &amp;oroc = fOuterSec[isector];</span>
<span class="lineNum">    9568 </span>            :     //all clusters
<span class="lineNum">    9569 </span><span class="lineCov">        144 :     esdFriend-&gt;SetNclustersTPC(isector,   iroc.GetNClInSector(0));</span>
<span class="lineNum">    9570 </span><span class="lineCov">        144 :     esdFriend-&gt;SetNclustersTPC(isector+18,iroc.GetNClInSector(1));</span>
<span class="lineNum">    9571 </span><span class="lineCov">        144 :     esdFriend-&gt;SetNclustersTPC(isector+36,oroc.GetNClInSector(0));</span>
<span class="lineNum">    9572 </span><span class="lineCov">        144 :     esdFriend-&gt;SetNclustersTPC(isector+54,oroc.GetNClInSector(1));</span>
<span class="lineNum">    9573 </span>            :     //clusters used in tracking
<span class="lineNum">    9574 </span><span class="lineCov">        144 :     esdFriend-&gt;SetNclustersTPCused(isector,    iroc.GetNClUsedInSector(0));</span>
<span class="lineNum">    9575 </span><span class="lineCov">        144 :     esdFriend-&gt;SetNclustersTPCused(isector+18, iroc.GetNClUsedInSector(1));</span>
<span class="lineNum">    9576 </span><span class="lineCov">        144 :     esdFriend-&gt;SetNclustersTPCused(isector+36, oroc.GetNClUsedInSector(0));</span>
<span class="lineNum">    9577 </span><span class="lineCov">        144 :     esdFriend-&gt;SetNclustersTPCused(isector+54, oroc.GetNClUsedInSector(1));</span>
<span class="lineNum">    9578 </span>            :   }
<a name="9579"><span class="lineNum">    9579 </span><span class="lineCov">         16 : }</span></a>
<span class="lineNum">    9580 </span>            : 
<span class="lineNum">    9581 </span>            : void AliTPCtracker::FillSeedClusterStatCache(const AliTPCseed* seed)
<span class="lineNum">    9582 </span>            : {
<span class="lineNum">    9583 </span>            :   //RS fill cache for seed's cluster statistics evaluation buffer
<span class="lineNum">    9584 </span><span class="lineNoCov">          0 :   for (int i=kMaxRow;i--;) {</span>
<span class="lineNum">    9585 </span><span class="lineNoCov">          0 :     Int_t index = seed-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    9586 </span><span class="lineNoCov">          0 :     fClStatFoundable[i] = (index!=-1);</span>
<span class="lineNum">    9587 </span><span class="lineNoCov">          0 :     fClStatFound[i] = fClStatShared[i] = kFALSE;</span>
<span class="lineNum">    9588 </span><span class="lineNoCov">          0 :     if (index&lt;0 || (index&amp;0x8000)) continue;</span>
<span class="lineNum">    9589 </span><span class="lineNoCov">          0 :     const AliTPCclusterMI* cl = GetClusterMI(index);</span>
<span class="lineNum">    9590 </span><span class="lineNoCov">          0 :     if (cl-&gt;IsUsed(10)) fClStatShared[i] = kTRUE;</span>
<span class="lineNum">    9591 </span><span class="lineNoCov">          0 :   }</span>
<a name="9592"><span class="lineNum">    9592 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    9593 </span>            : 
<span class="lineNum">    9594 </span>            : void AliTPCtracker::GetCachedSeedClusterStatistic(Int_t first, Int_t last, Int_t &amp;found, Int_t &amp;foundable, Int_t &amp;shared, Bool_t plus2) const
<span class="lineNum">    9595 </span>            : {
<span class="lineNum">    9596 </span>            :   //RS calculation of cached seed statistics
<span class="lineNum">    9597 </span><span class="lineNoCov">          0 :   found       = 0;</span>
<span class="lineNum">    9598 </span><span class="lineNoCov">          0 :   foundable   = 0;</span>
<span class="lineNum">    9599 </span><span class="lineNoCov">          0 :   shared      = 0;</span>
<span class="lineNum">    9600 </span>            :   //
<span class="lineNum">    9601 </span><span class="lineNoCov">          0 :   for (Int_t i=first;i&lt;last; i++){</span>
<span class="lineNum">    9602 </span><span class="lineNoCov">          0 :     if (fClStatFoundable[i]) foundable++;</span>
<span class="lineNum">    9603 </span>            :     else continue;
<span class="lineNum">    9604 </span>            :     //
<span class="lineNum">    9605 </span><span class="lineNoCov">          0 :     if (fClStatFound[i]) found++;</span>
<span class="lineNum">    9606 </span>            :     else continue;
<span class="lineNum">    9607 </span>            :     //
<span class="lineNum">    9608 </span><span class="lineNoCov">          0 :     if (fClStatShared[i]) {</span>
<span class="lineNum">    9609 </span><span class="lineNoCov">          0 :       shared++;</span>
<span class="lineNum">    9610 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    9611 </span>            :     }
<span class="lineNum">    9612 </span><span class="lineNoCov">          0 :     if (!plus2) continue; //take also neighborhoud</span>
<span class="lineNum">    9613 </span>            :     //
<span class="lineNum">    9614 </span><span class="lineNoCov">          0 :     if ( i&gt;0 &amp;&amp; fClStatShared[i-1]) {</span>
<span class="lineNum">    9615 </span><span class="lineNoCov">          0 :       shared++;</span>
<span class="lineNum">    9616 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    9617 </span>            :     }
<span class="lineNum">    9618 </span><span class="lineNoCov">          0 :     if ( i&lt;(kMaxRow-1) &amp;&amp; fClStatShared[i+1]) {</span>
<span class="lineNum">    9619 </span><span class="lineNoCov">          0 :       shared++;</span>
<span class="lineNum">    9620 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">    9621 </span>            :     }    
<span class="lineNum">    9622 </span>            :   }
<a name="9623"><span class="lineNum">    9623 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    9624 </span>            : 
<span class="lineNum">    9625 </span>            : void AliTPCtracker::GetSeedClusterStatistic(const AliTPCseed* seed, Int_t first, Int_t last, Int_t &amp;found, Int_t &amp;foundable, Int_t &amp;shared, Bool_t plus2) const
<span class="lineNum">    9626 </span>            : {
<span class="lineNum">    9627 </span>            :   // RS: get cluster stat. on given region, faster for small regions than cachin the whole seed stat.
<span class="lineNum">    9628 </span>            :   //
<span class="lineNum">    9629 </span><span class="lineCov">       1064 :   found       = 0;</span>
<span class="lineNum">    9630 </span><span class="lineCov">       1064 :   foundable   = 0;</span>
<span class="lineNum">    9631 </span><span class="lineCov">       1064 :   shared      =0;</span>
<span class="lineNum">    9632 </span><span class="lineCov">     196160 :   for (Int_t i=first;i&lt;last; i++){</span>
<span class="lineNum">    9633 </span><span class="lineCov">      97016 :     Int_t index = seed-&gt;GetClusterIndex2(i);</span>
<span class="lineNum">    9634 </span><span class="lineCov">     189308 :     if (index!=-1) foundable++;</span>
<span class="lineNum">    9635 </span><span class="lineCov">     110646 :     if (index&amp;0x8000) continue;</span>
<span class="lineNum">    9636 </span><span class="lineCov">     166772 :     if (index&gt;=0) found++;</span>
<span class="lineNum">    9637 </span><span class="lineNoCov">          0 :     else continue;</span>
<span class="lineNum">    9638 </span><span class="lineCov">      83386 :     const AliTPCclusterMI* cl = GetClusterMI(index);</span>
<span class="lineNum">    9639 </span><span class="lineCov">      83386 :     if (cl-&gt;IsUsed(10)) {</span>
<span class="lineNum">    9640 </span><span class="lineCov">      13178 :       shared++;</span>
<span class="lineNum">    9641 </span><span class="lineCov">      13178 :       continue;</span>
<span class="lineNum">    9642 </span>            :     }
<span class="lineNum">    9643 </span><span class="lineCov">     138350 :     if (!plus2) continue; //take also neighborhoud</span>
<span class="lineNum">    9644 </span>            :     //
<span class="lineNum">    9645 </span><span class="lineCov">       2066 :     if (i&gt;0) {</span>
<span class="lineNum">    9646 </span><span class="lineCov">       2066 :       index = seed-&gt;GetClusterIndex2(i-1);</span>
<span class="lineNum">    9647 </span><span class="lineCov">       5944 :       cl = index&lt;0 ? 0:GetClusterMI(index);</span>
<span class="lineNum">    9648 </span><span class="lineCov">       3878 :       if (cl &amp;&amp; cl-&gt;IsUsed(10)) {</span>
<span class="lineNum">    9649 </span><span class="lineNoCov">          0 :         shared++;</span>
<span class="lineNum">    9650 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    9651 </span>            :       }
<span class="lineNum">    9652 </span>            :     }
<span class="lineNum">    9653 </span><span class="lineCov">       2066 :     if (i&lt;(kMaxRow-1)) {</span>
<span class="lineNum">    9654 </span><span class="lineCov">       2066 :       index = seed-&gt;GetClusterIndex2(i+1);</span>
<span class="lineNum">    9655 </span><span class="lineCov">       5938 :       cl = index&lt;0 ? 0:GetClusterMI(index);      </span>
<span class="lineNum">    9656 </span><span class="lineCov">       3872 :       if (cl &amp;&amp; cl-&gt;IsUsed(10)) {</span>
<span class="lineNum">    9657 </span><span class="lineNoCov">          0 :         shared++;</span>
<span class="lineNum">    9658 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    9659 </span>            :       }
<span class="lineNum">    9660 </span>            :     }
<span class="lineNum">    9661 </span>            :     
<span class="lineNum">    9662 </span><span class="lineCov">       2066 :   }</span>
<a name="9663"><span class="lineNum">    9663 </span><span class="lineCov">       1064 : }</span></a>
<span class="lineNum">    9664 </span>            : 
<span class="lineNum">    9665 </span>            : Bool_t AliTPCtracker::DistortX(const AliTPCseed* seed, double&amp; x, int row)
<span class="lineNum">    9666 </span>            : {
<span class="lineNum">    9667 </span>            :   // distort X by the distorion at track location on given row
<span class="lineNum">    9668 </span>            :   //
<span class="lineNum">    9669 </span>            :   //RS:? think to unset fAccountDistortions if no maps are used
<span class="lineNum">    9670 </span><span class="lineNoCov">          0 :   if (!AliTPCReconstructor::GetRecoParam()-&gt;GetUseCorrectionMap()) return kTRUE;</span>
<span class="lineNum">    9671 </span><span class="lineNoCov">          0 :   double xyz[3]; </span>
<span class="lineNum">    9672 </span>            :   int rowInp = row;//RS
<span class="lineNum">    9673 </span><span class="lineNoCov">          0 :   if (!seed-&gt;GetYZAt(x,AliTracker::GetBz(),&amp;xyz[1])) return kFALSE; //RS:? Think to cache fBz?</span>
<span class="lineNum">    9674 </span><span class="lineNoCov">          0 :   xyz[0] = x;</span>
<span class="lineNum">    9675 </span><span class="lineNoCov">          0 :   int roc = seed-&gt;GetRelativeSector();</span>
<span class="lineNum">    9676 </span><span class="lineNoCov">          0 :   if (seed-&gt;GetZ()&lt;0) roc += 18;</span>
<span class="lineNum">    9677 </span><span class="lineNoCov">          0 :   if (row&gt;62) {</span>
<span class="lineNum">    9678 </span><span class="lineNoCov">          0 :     roc += 36;</span>
<span class="lineNum">    9679 </span><span class="lineNoCov">          0 :     row -= 63;</span>
<span class="lineNum">    9680 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9681 </span><span class="lineNoCov">          0 :   AliTPCcalibDB * calibDB = AliTPCcalibDB::Instance();</span>
<span class="lineNum">    9682 </span><span class="lineNoCov">          0 :   AliTPCTransform *transform = calibDB-&gt;GetTransform();</span>
<span class="lineNum">    9683 </span><span class="lineNoCov">          0 :   if (!transform) AliFatal(&quot;Tranformations not in calibDB&quot;);</span>
<span class="lineNum">    9684 </span><span class="lineNoCov">          0 :   x += transform-&gt;GetCorrMapComponent(roc,row,xyz,0);</span>
<span class="lineNum">    9685 </span>            :   return kTRUE;
<a name="9686"><span class="lineNum">    9686 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    9687 </span>            : 
<span class="lineNum">    9688 </span>            : Double_t AliTPCtracker::GetDistortionX(double x, double y, double z, int sec, int row)
<span class="lineNum">    9689 </span>            : {
<span class="lineNum">    9690 </span>            :   // get X distortion at location on given row
<span class="lineNum">    9691 </span>            :   //
<span class="lineNum">    9692 </span><span class="lineNoCov">          0 :   if (!AliTPCReconstructor::GetRecoParam()-&gt;GetUseCorrectionMap()) return 0;</span>
<span class="lineNum">    9693 </span><span class="lineNoCov">          0 :   double xyz[3] = {x,y,z}; </span>
<span class="lineNum">    9694 </span>            :   int rowInp = row;
<span class="lineNum">    9695 </span>            :   int secInp = sec;
<span class="lineNum">    9696 </span><span class="lineNoCov">          0 :   if (z&lt;0) sec += 18;</span>
<span class="lineNum">    9697 </span><span class="lineNoCov">          0 :   if (row&gt;62) {</span>
<span class="lineNum">    9698 </span><span class="lineNoCov">          0 :     sec += 36;</span>
<span class="lineNum">    9699 </span><span class="lineNoCov">          0 :     row -= 63;</span>
<span class="lineNum">    9700 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9701 </span><span class="lineNoCov">          0 :   AliTPCcalibDB * calibDB = AliTPCcalibDB::Instance();</span>
<span class="lineNum">    9702 </span><span class="lineNoCov">          0 :   AliTPCTransform *transform = calibDB-&gt;GetTransform() ;</span>
<span class="lineNum">    9703 </span><span class="lineNoCov">          0 :   if (!transform) AliFatal(&quot;Tranformations not in calibDB&quot;);</span>
<span class="lineNum">    9704 </span><span class="lineNoCov">          0 :   return transform-&gt;GetCorrMapComponent(sec,row,xyz,0);</span>
<a name="9705"><span class="lineNum">    9705 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    9706 </span>            : 
<span class="lineNum">    9707 </span>            : Double_t AliTPCtracker::GetYSectEdgeDist(int sec, int row, double y, double z) 
<span class="lineNum">    9708 </span>            : {
<span class="lineNum">    9709 </span>            :   // get the signed  shift for maxY of the sector/row accounting for distortion
<span class="lineNum">    9710 </span>            :   // Slow way, to speed up
<span class="lineNum">    9711 </span><span class="lineNoCov">          0 :   if (!AliTPCReconstructor::GetRecoParam()-&gt;GetUseCorrectionMap()) return 0;</span>
<span class="lineNum">    9712 </span><span class="lineNoCov">          0 :   double ymax = 0.9*GetMaxY(row); // evaluate distortions at 5% of pad lenght from the edge</span>
<span class="lineNum">    9713 </span><span class="lineNoCov">          0 :   if (y&lt;0) ymax = -ymax;</span>
<span class="lineNum">    9714 </span><span class="lineNoCov">          0 :   double xyz[3] = {GetXrow(row),ymax,z}; </span>
<span class="lineNum">    9715 </span><span class="lineNoCov">          0 :   if (z&lt;0) sec += 18;</span>
<span class="lineNum">    9716 </span><span class="lineNoCov">          0 :   if (row&gt;62) {</span>
<span class="lineNum">    9717 </span><span class="lineNoCov">          0 :     sec += 36;</span>
<span class="lineNum">    9718 </span><span class="lineNoCov">          0 :     row -= 63;</span>
<span class="lineNum">    9719 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9720 </span><span class="lineNoCov">          0 :   AliTPCcalibDB * calibDB = AliTPCcalibDB::Instance();</span>
<span class="lineNum">    9721 </span><span class="lineNoCov">          0 :   AliTPCTransform *transform = calibDB-&gt;GetTransform();</span>
<span class="lineNum">    9722 </span><span class="lineNoCov">          0 :   if (!transform) AliFatal(&quot;Tranformations not in calibDB&quot;);</span>
<span class="lineNum">    9723 </span>            :   // change of distance from the edge due to the X shift 
<span class="lineNum">    9724 </span><span class="lineNoCov">          0 :   double dxtg = transform-&gt;GetCorrMapComponent(sec,row,xyz,0)*AliTPCTransform::GetMaxY2X();</span>
<span class="lineNum">    9725 </span><span class="lineNoCov">          0 :   double dy = transform-&gt;GetCorrMapComponent(sec,row,xyz,1);</span>
<span class="lineNum">    9726 </span><span class="lineNoCov">          0 :   return dy + (y&gt;0?dxtg:-dxtg);</span>
<span class="lineNum">    9727 </span>            :   //
<a name="9728"><span class="lineNum">    9728 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    9729 </span>            : 
<span class="lineNum">    9730 </span>            : Int_t AliTPCtracker::GetTrackSector(double alpha)
<span class="lineNum">    9731 </span>            : {
<span class="lineNum">    9732 </span>            :   //convert alpha to sector
<span class="lineNum">    9733 </span><span class="lineNoCov">          0 :   if (alpha&lt;0) alpha += TMath::Pi()*2;</span>
<span class="lineNum">    9734 </span><span class="lineNoCov">          0 :   int sec = alpha/(TMath::Pi()/9);</span>
<span class="lineNum">    9735 </span><span class="lineNoCov">          0 :   return sec;</span>
<a name="9736"><span class="lineNum">    9736 </span>            : }</a>
<span class="lineNum">    9737 </span>            : 
<span class="lineNum">    9738 </span>            : void AliTPCtracker::CleanESDFriendsObjects(AliESDEvent* esd)
<span class="lineNum">    9739 </span>            : {
<span class="lineNum">    9740 </span>            :   // RS: remove seeds stored in friend's calib object contained w/o changing its ownership
<span class="lineNum">    9741 </span>            :   //
<span class="lineNum">    9742 </span><span class="lineCov">         16 :   AliInfo(&quot;Removing own seeds from friend tracks&quot;);</span>
<span class="lineNum">    9743 </span><span class="lineCov">          8 :   AliESDfriend* esdF = esd-&gt;FindFriend();</span>
<span class="lineNum">    9744 </span><span class="lineCov">          8 :   int ntr = esd-&gt;GetNumberOfTracks();</span>
<span class="lineNum">    9745 </span><span class="lineCov">        158 :   for (int itr=ntr;itr--;) {</span>
<span class="lineNum">    9746 </span><span class="lineCov">        142 :     AliESDtrack* trc = esd-&gt;GetTrack(itr);</span>
<span class="lineNum">    9747 </span><span class="lineCov">        142 :     AliESDfriendTrack* trcF = (AliESDfriendTrack*)trc-&gt;GetFriendTrack();</span>
<span class="lineNum">    9748 </span><span class="lineCov">        142 :     if (!trcF) continue;</span>
<span class="lineNum">    9749 </span><span class="lineCov">        142 :     AliTPCseed* seed = (AliTPCseed*)trcF-&gt;GetTPCseed();</span>
<span class="lineNum">    9750 </span><span class="lineCov">        142 :     if (seed) {</span>
<span class="lineNum">    9751 </span><span class="lineCov">         63 :       trcF-&gt;RemoveCalibObject((TObject*)seed);</span>
<span class="lineNum">    9752 </span><span class="lineCov">         63 :       seed-&gt;SetClusterOwner(kFALSE);</span>
<span class="lineNum">    9753 </span><span class="lineCov">         63 :       seed-&gt;SetClustersArrayTMP(0);</span>
<span class="lineNum">    9754 </span><span class="lineCov">         63 :     }</span>
<span class="lineNum">    9755 </span><span class="lineCov">        142 :   }</span>
<span class="lineNum">    9756 </span>            :   //
<span class="lineNum">    9757 </span><span class="lineCov">          8 : }</span>
<a name="9758"><span class="lineNum">    9758 </span>            : </a>
<span class="lineNum">    9759 </span>            : //__________________________________________________________________
<span class="lineNum">    9760 </span>            : void AliTPCtracker::CleanESDTracksObjects(TObjArray* trcList)
<span class="lineNum">    9761 </span>            : {
<span class="lineNum">    9762 </span>            :   // RS: remove seeds stored in friend's calib object contained w/o changing its ownership
<span class="lineNum">    9763 </span>            :   //
<span class="lineNum">    9764 </span><span class="lineCov">          8 :   int ntr = trcList-&gt;GetEntriesFast();</span>
<span class="lineNum">    9765 </span><span class="lineCov">         28 :   for (int itr=0;itr&lt;ntr;itr++) {</span>
<span class="lineNum">    9766 </span><span class="lineCov">         10 :     TObject *obj = trcList-&gt;At(itr);</span>
<span class="lineNum">    9767 </span><span class="lineCov">         30 :     AliESDfriendTrack* trcF =  (obj-&gt;IsA()==AliESDtrack::Class()) ? </span>
<span class="lineNum">    9768 </span><span class="lineCov">         10 :       (AliESDfriendTrack*)((AliESDtrack*)obj)-&gt;GetFriendTrack() : (AliESDfriendTrack*)obj;</span>
<span class="lineNum">    9769 </span><span class="lineCov">         10 :     if (!trcF) continue;</span>
<span class="lineNum">    9770 </span><span class="lineCov">         10 :     AliTPCseed* seed = (AliTPCseed*)trcF-&gt;GetTPCseed();</span>
<span class="lineNum">    9771 </span><span class="lineCov">         10 :     if (seed) {</span>
<span class="lineNum">    9772 </span><span class="lineCov">          5 :       trcF-&gt;RemoveCalibObject((TObject*)seed);</span>
<span class="lineNum">    9773 </span><span class="lineCov">          5 :       seed-&gt;SetClusterOwner(kFALSE);</span>
<span class="lineNum">    9774 </span><span class="lineCov">          5 :       seed-&gt;SetClustersArrayTMP(0);</span>
<span class="lineNum">    9775 </span><span class="lineCov">          5 :     }</span>
<span class="lineNum">    9776 </span><span class="lineCov">         10 :   }</span>
<span class="lineNum">    9777 </span>            :   //
<span class="lineNum">    9778 </span><span class="lineCov">          4 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
