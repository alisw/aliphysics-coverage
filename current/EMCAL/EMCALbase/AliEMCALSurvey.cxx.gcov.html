<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - EMCAL/EMCALbase/AliEMCALSurvey.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">EMCAL/EMCALbase</a> - AliEMCALSurvey.cxx<span style="font-size: 80%;"> (source / <a href="AliEMCALSurvey.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">322</td>
            <td class="headerCovTableEntryLo">0.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">13</td>
            <td class="headerCovTableEntryLo">7.7 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : /* $Id: $ */
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : // Objects of this class read txt file with survey data
<span class="lineNum">      19 </span>            : // and convert the data into AliAlignObjParams of alignable EMCAL volumes.
<span class="lineNum">      20 </span>            : // AliEMCALSurvey inherits TObject only to use AliLog &quot;functions&quot;.
<span class="lineNum">      21 </span>            : //
<span class="lineNum">      22 </span>            : // Dummy functions originally written before EMCAL installation and
<span class="lineNum">      23 </span>            : // survey are kept for backward compatibility, but now they are not
<span class="lineNum">      24 </span>            : // used.
<span class="lineNum">      25 </span>            : //
<span class="lineNum">      26 </span>            : // Surveyed points on the EMCAL support rails were used with the CATIA
<span class="lineNum">      27 </span>            : // 3D graphics program to determine the positions of the bottom
<span class="lineNum">      28 </span>            : // corners of the active area for each supermodule.  These numbers are
<span class="lineNum">      29 </span>            : // read in from file and converted to position of the center and roll, 
<span class="lineNum">      30 </span>            : // pitch, yaw angles of each installed SM.
<span class="lineNum">      31 </span>            : //
<span class="lineNum">      32 </span>            : // J.L. Klay - Cal Poly
<span class="lineNum">      33 </span>            : // Adapted for DCAL by M.L. Wang CCNU &amp; Subatech Oct-19-2012
<span class="lineNum">      34 </span>            : // 21-May-2010
<span class="lineNum">      35 </span>            : //
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #include &lt;fstream&gt;
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : #include &lt;TClonesArray.h&gt;
<span class="lineNum">      40 </span>            : #include &lt;TGeoManager.h&gt;
<span class="lineNum">      41 </span>            : #include &lt;TString.h&gt;
<span class="lineNum">      42 </span>            : #include &lt;TMath.h&gt;
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : #include &quot;AliSurveyObj.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;AliSurveyPoint.h&quot;
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : #include &quot;AliAlignObjParams.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;AliEMCALGeometry.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;AliEMCALSurvey.h&quot;
<a name="50"><span class="lineNum">      50 </span>            : #include &quot;AliLog.h&quot;</a>
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span><span class="lineCov">         42 : ClassImp(AliEMCALSurvey)</span>
<a name="53"><span class="lineNum">      53 </span>            : </a>
<span class="lineNum">      54 </span>            : //____________________________________________________________________________
<span class="lineNum">      55 </span><span class="lineNoCov">          0 : AliEMCALSurvey::AliEMCALSurvey()</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :  : fNSuperModule(0),</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :    fSuperModuleData(0),</span>
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :    fDataType(kSurvey)</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      60 </span>            :   //Default constructor.
<span class="lineNum">      61 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            : namespace {
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            :   //Coordinates for each SM described in survey reports
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            :   struct AliEMCALSuperModuleCoords {
<span class="lineNum">      68 </span>            :     Double_t fX1; //x coordinate of the center of supermodule
<span class="lineNum">      69 </span>            :     Double_t fY1; //y coordinate of the center of supermodule
<span class="lineNum">      70 </span>            :     Double_t fZ1; //z coordinate of the center of supermodule
<span class="lineNum">      71 </span>            :     Double_t fPsi;   //yaw (psi) of supermodule
<span class="lineNum">      72 </span>            :     Double_t fTheta; //pitch (theta) of supermodule
<span class="lineNum">      73 </span>            :     Double_t fPhi;  //roll angle (phi) of supermodule
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            :   };
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : }
<a name="78"><span class="lineNum">      78 </span>            : </a>
<span class="lineNum">      79 </span>            : //____________________________________________________________________________
<span class="lineNum">      80 </span><span class="lineNoCov">          0 : AliEMCALSurvey::AliEMCALSurvey(const TString &amp;txtFileName,const SurveyDataType_t type)</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :   : fNSuperModule(0),</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :     fSuperModuleData(0),</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :     fDataType(type)</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      85 </span>            :   //Get the geometry object and then attempt to
<span class="lineNum">      86 </span>            :   //read survey data from a file, depending on which
<span class="lineNum">      87 </span>            :   //method (kSurvey or kDummy) is selected.
<span class="lineNum">      88 </span>            :   
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :   const AliEMCALGeometry *geom = AliEMCALGeometry::GetInstance();</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :   if (!geom) {</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :     AliError(&quot;Cannot obtain AliEMCALGeometry instance.&quot;);</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">      93 </span>            :   }
<span class="lineNum">      94 </span>            :   
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :   fNSuperModule = geom-&gt;GetNumberOfSuperModules();</span>
<span class="lineNum">      96 </span>            :   
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :   if(fDataType == kSurvey) {</span>
<span class="lineNum">      98 </span>            :     
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :     AliSurveyObj *s1 = new AliSurveyObj();</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     s1-&gt;FillFromLocalFile(txtFileName);</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     TObjArray* points = s1-&gt;GetData();</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :     InitSuperModuleData(points);</span>
<span class="lineNum">     103 </span>            :     
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">     105 </span>            :     
<span class="lineNum">     106 </span>            :     //Use a dummy file that stores x,y,z of the center of each SM
<span class="lineNum">     107 </span>            :     //useful for testing...
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :     std::ifstream inputFile(txtFileName.Data());</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :     if (!inputFile) {</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :       AliError((&quot;Cannot open the survey file &quot; + txtFileName).Data());</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     112 </span>            :     }
<span class="lineNum">     113 </span>            :     
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :     Int_t dummyInt = 0;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     Double_t *xReal     = new Double_t[fNSuperModule];</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     Double_t *yReal     = new Double_t[fNSuperModule];</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :     Double_t *zReal     = new Double_t[fNSuperModule];</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     Double_t *psiReal   = new Double_t[fNSuperModule];</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :     Double_t *thetaReal = new Double_t[fNSuperModule];</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :     Double_t *phiReal   = new Double_t[fNSuperModule];</span>
<span class="lineNum">     121 </span>            :     //init the arrays
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :     memset(xReal,     0,sizeof(Int_t)*fNSuperModule);</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :     memset(yReal,     0,sizeof(Int_t)*fNSuperModule);</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     memset(zReal,     0,sizeof(Int_t)*fNSuperModule);</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     memset(psiReal,   0,sizeof(Int_t)*fNSuperModule);</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     memset(thetaReal, 0,sizeof(Int_t)*fNSuperModule);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :     memset(phiReal,   0,sizeof(Int_t)*fNSuperModule);</span>
<span class="lineNum">     128 </span>            :     
<span class="lineNum">     129 </span>            :     
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :     for (Int_t i = 0; i &lt; fNSuperModule; ++i) {</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :       if (!inputFile) {</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :         AliError(&quot;Error while reading input file.&quot;);</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :         delete [] xReal;</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :         delete [] yReal;</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :         delete [] zReal;</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :         delete [] psiReal;</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         delete [] thetaReal;</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :         delete [] phiReal;</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     140 </span>            :       }
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :       inputFile&gt;&gt;dummyInt&gt;&gt;xReal[i]&gt;&gt;yReal[i]&gt;&gt;zReal[i]&gt;&gt;psiReal[i]&gt;&gt;thetaReal[i]&gt;&gt;phiReal[i];</span>
<span class="lineNum">     142 </span>            :     }
<span class="lineNum">     143 </span>            :     
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :     InitSuperModuleData(xReal, yReal, zReal, psiReal, thetaReal, phiReal);</span>
<span class="lineNum">     145 </span>            :     
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :     delete [] xReal;</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     delete [] yReal;</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :     delete [] zReal;</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     delete [] psiReal;</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :     delete [] thetaReal;</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :     delete [] phiReal;</span>
<span class="lineNum">     152 </span>            :     
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   } //kDummy way of doing it</span>
<span class="lineNum">     154 </span>            :   
<span class="lineNum">     155 </span><span class="lineNoCov">          0 : }</span>
<a name="156"><span class="lineNum">     156 </span>            : </a>
<span class="lineNum">     157 </span>            : //____________________________________________________________________________
<span class="lineNum">     158 </span>            : AliEMCALSurvey::~AliEMCALSurvey()
<span class="lineNum">     159 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     160 </span>            :   //destructor
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   delete [] fSuperModuleData;</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 : }</span>
<a name="163"><span class="lineNum">     163 </span>            : </a>
<span class="lineNum">     164 </span>            : //____________________________________________________________________________
<span class="lineNum">     165 </span>            : void AliEMCALSurvey::CreateAliAlignObjParams(TClonesArray &amp;array)
<span class="lineNum">     166 </span>            : {
<span class="lineNum">     167 </span>            :   //Create AliAlignObjParams.
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :   const AliEMCALGeometry * geom = AliEMCALGeometry::GetInstance();</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :   if (!geom) {</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :     AliError(&quot;Cannot obtain AliEMCALGeometry instance.&quot;);</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     172 </span>            :   }
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :   if (!gGeoManager) {</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     AliWarning(&quot;Cannot create local transformations for supermodules - gGeoManager does not exist.&quot;);</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     AliInfo(&quot;Null shifts and rotations will be created instead.&quot;);</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     return CreateNullObjects(array, geom);</span>
<span class="lineNum">     178 </span>            :   }
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   Int_t arrayInd = array.GetEntries(), iIndex = 0;</span>
<span class="lineNum">     181 </span>            :   AliGeomManager::ELayerID iLayer = AliGeomManager::kInvalidLayer;
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   UShort_t volid = AliGeomManager::LayerToVolUID(iLayer,iIndex);</span>
<span class="lineNum">     183 </span>            :   AliAlignObjParams* myobj = 0x0;
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   TString SMName;</span>
<span class="lineNum">     186 </span>            :   Int_t tmpType = -1;
<span class="lineNum">     187 </span>            :   Int_t SMOrder = 0;
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :   for (Int_t smodnum = 0; smodnum &lt; geom-&gt;GetNumberOfSuperModules(); ++smodnum) {</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     if(geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_Standard )      SMName = &quot;FullSupermodule&quot;;</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :     else if(geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_Half )     SMName = &quot;HalfSupermodule&quot;;</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :     else if(geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_3rd )      SMName = &quot;OneThrdSupermodule&quot;;</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :     else if( geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kDCAL_Standard ) SMName = &quot;DCALSupermodule&quot;;</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :     else if( geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kDCAL_Ext )      SMName = &quot;DCALExtensionSM&quot;;</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :     else AliError(&quot;Unkown SM Type!!&quot;);</span>
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :     if(geom-&gt;GetSMType(smodnum) == tmpType) {</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :       SMOrder++;</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :       tmpType = geom-&gt;GetSMType(smodnum);</span>
<span class="lineNum">     201 </span>            :       SMOrder = 1;
<span class="lineNum">     202 </span>            :     }
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :     TString smodName(TString::Format(&quot;EMCAL/%s%d&quot;, SMName.Data(), SMOrder));</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :     AliEMCALSuperModuleDelta t(GetSuperModuleTransformation(smodnum));</span>
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span>            :     ///////////////////////////////
<span class="lineNum">     208 </span>            :     // JLK 13-July-2010
<span class="lineNum">     209 </span>            :     //
<span class="lineNum">     210 </span>            :     // VERY IMPORTANT!!!!
<span class="lineNum">     211 </span>            :     //
<span class="lineNum">     212 </span>            :     // All numbers were calculated in ALICE global c.s., which means
<span class="lineNum">     213 </span>            :     // that the last argument in the creation of AliAlignObjParams
<span class="lineNum">     214 </span>            :     // MUST BE set to true
<span class="lineNum">     215 </span>            :     //////////////////////////////
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :     new(array[arrayInd])</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :       AliAlignObjParams(</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :                         smodName.Data(), volid, </span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :                         t.fXShift, t.fYShift, t.fZShift, </span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                         -t.fPsi, -t.fTheta, -t.fPhi, </span>
<span class="lineNum">     221 </span>            :                         true
<span class="lineNum">     222 </span>            :                         );
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :     ++arrayInd;</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :     myobj = (AliAlignObjParams*)array.UncheckedAt(smodnum);</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :     printf(&quot;==== AliAlignObjParams for SM %d ====\n&quot;,smodnum);</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :     myobj-&gt;Print(&quot;&quot;);</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span><span class="lineNoCov">          0 : }</span>
<a name="231"><span class="lineNum">     231 </span>            : </a>
<span class="lineNum">     232 </span>            : //____________________________________________________________________________
<span class="lineNum">     233 </span>            : void AliEMCALSurvey::CreateNullObjects(TClonesArray &amp;array, const AliEMCALGeometry *geom)const
<span class="lineNum">     234 </span>            : {
<span class="lineNum">     235 </span>            :   //Create null shifts and rotations.
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :   Int_t arrayInd = array.GetEntries(), iIndex = 0;</span>
<span class="lineNum">     237 </span>            :   AliGeomManager::ELayerID iLayer = AliGeomManager::kInvalidLayer;
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :   UShort_t volid = AliGeomManager::LayerToVolUID(iLayer,iIndex);</span>
<span class="lineNum">     239 </span>            : 
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :   TString SMName;</span>
<span class="lineNum">     241 </span>            :   Int_t tmpType = -1;
<span class="lineNum">     242 </span>            :   Int_t SMOrder = 0;
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :   for (Int_t smodnum = 0; smodnum &lt; geom-&gt;GetNumberOfSuperModules(); ++smodnum) {</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :     if(geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_Standard )      SMName = &quot;FullSupermodule&quot;;</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :     else if(geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_Half )     SMName = &quot;HalfSupermodule&quot;;</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     else if(geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_3rd )      SMName = &quot;OneThrdSupermodule&quot;;</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :     else if( geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kDCAL_Standard ) SMName = &quot;DCALSupermodule&quot;;</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :     else if( geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kDCAL_Ext )      SMName = &quot;DCALExtensionSM&quot;;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :     else AliError(&quot;Unkown SM Type!!&quot;);</span>
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :     if(geom-&gt;GetSMType(smodnum) == tmpType) {</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :       SMOrder++;</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :       tmpType = geom-&gt;GetSMType(smodnum);</span>
<span class="lineNum">     256 </span>            :       SMOrder = 1;
<span class="lineNum">     257 </span>            :     }
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :     TString smodName(TString::Format(&quot;EMCAL/%s%d&quot;, SMName.Data(), SMOrder));</span>
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :     new(array[arrayInd]) AliAlignObjParams(smodName.Data(), volid, 0., 0., 0., 0., 0., 0., true);</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     ++arrayInd;</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 : }</span>
<a name="264"><span class="lineNum">     264 </span>            : </a>
<span class="lineNum">     265 </span>            : //____________________________________________________________________________
<span class="lineNum">     266 </span>            : AliEMCALSurvey::AliEMCALSuperModuleDelta AliEMCALSurvey::GetSuperModuleTransformation(Int_t supModIndex)const
<span class="lineNum">     267 </span>            : {
<span class="lineNum">     268 </span>            :   //Supermodule transformation.
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :   AliEMCALSuperModuleDelta t = {0., 0., 0., 0., 0., 0.};</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :   if (!fSuperModuleData)</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     return t;</span>
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :   return fSuperModuleData[supModIndex];</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 : }</span>
<a name="275"><span class="lineNum">     275 </span>            : </a>
<span class="lineNum">     276 </span>            : //____________________________________________________________________________
<span class="lineNum">     277 </span>            : void AliEMCALSurvey::InitSuperModuleData(const TObjArray *svypts)
<span class="lineNum">     278 </span>            : {
<span class="lineNum">     279 </span>            :   //This method uses the data points from the EMCAL survey and CATIA program to
<span class="lineNum">     280 </span>            :   //create the alignment matrices.  Only valid for (installed)
<span class="lineNum">     281 </span>            :   //SM, others will have null objects
<span class="lineNum">     282 </span>            :   
<span class="lineNum">     283 </span>            :   /*--------------------------------------
<span class="lineNum">     284 </span>            :    The bottom edges of the strip modules
<span class="lineNum">     285 </span>            :    define the active area of the EMCAL, but
<span class="lineNum">     286 </span>            :    in software we have a box to hold them which
<span class="lineNum">     287 </span>            :    is longer than that.  We need to convert
<span class="lineNum">     288 </span>            :    info about the position of the corners of the
<span class="lineNum">     289 </span>            :    bottom of the active area to the center of
<span class="lineNum">     290 </span>            :    the software box that contains the strip
<span class="lineNum">     291 </span>            :    modules.
<span class="lineNum">     292 </span>            :    
<span class="lineNum">     293 </span>            :    View from beam axis up to EMCAL
<span class="lineNum">     294 </span>            :    Ai                Ci
<span class="lineNum">     295 </span>            :    
<span class="lineNum">     296 </span>            :    0,1         0,0 1,0          1,1
<span class="lineNum">     297 </span>            :    xxxxxxxxxxxxxxxxxxx xxxxxxxxxxxxxxxxxxxx
<span class="lineNum">     298 </span>            :    x   x             x x              x   x
<span class="lineNum">     299 </span>            :    x   x    % *      x x      * %     x   x
<span class="lineNum">     300 </span>            :    x   x             x x              x   x
<span class="lineNum">     301 </span>            :    xxxxxxxxxxxxxxxxxxx xxxxxxxxxxxxxxxxxxxx
<span class="lineNum">     302 </span>            :    1,1         1,0 0,0          0,1
<span class="lineNum">     303 </span>            :    &lt;--&gt; = added length                 &lt;--&gt; = added length
<span class="lineNum">     304 </span>            :    
<span class="lineNum">     305 </span>            :    * represents the center of the active area
<span class="lineNum">     306 </span>            :    % represents the center of the full box (with added length)
<span class="lineNum">     307 </span>            :    
<span class="lineNum">     308 </span>            :    View from side of topmost SM
<span class="lineNum">     309 </span>            :    
<span class="lineNum">     310 </span>            :    Ai                Ci
<span class="lineNum">     311 </span>            :    
<span class="lineNum">     312 </span>            :    0,1         0,0 1,0          1,1
<span class="lineNum">     313 </span>            :    xxxxxxxxxxxxxxxxxxx xxxxxxxxxxxxxxxxxxxx
<span class="lineNum">     314 </span>            :    x   x    % *      x x      % *     x   x
<span class="lineNum">     315 </span>            :    xxxxxxxxxxxxxxxxxxx xxxxxxxxxxxxxxxxxxxx
<span class="lineNum">     316 </span>            :    1,1         1,0 0,0          0,1
<span class="lineNum">     317 </span>            :    &lt;--&gt; = added length                 &lt;--&gt; = added length
<span class="lineNum">     318 </span>            :    
<span class="lineNum">     319 </span>            :    * represents the center of the active area
<span class="lineNum">     320 </span>            :    % represents the center of the full box (with added length)
<span class="lineNum">     321 </span>            :    
<span class="lineNum">     322 </span>            :    -------------------------------------*/
<span class="lineNum">     323 </span>            :   
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :   AliEMCALGeometry *geom = AliEMCALGeometry::GetInstance();</span>
<span class="lineNum">     325 </span>            :   //Center of supermodules
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   Float_t pars[] = {geom-&gt;GetSuperModulesPar(0),geom-&gt;GetSuperModulesPar(1),geom-&gt;GetSuperModulesPar(2)};</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :   Double_t rpos = (geom-&gt;GetEnvelop(0) + geom-&gt;GetEnvelop(1))/2.;</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :   Float_t fInnerEdge = geom-&gt;GetDCALInnerEdge();</span>
<span class="lineNum">     329 </span>            :   Double_t phi=0, phiRad=0, xpos=0, ypos=0, zpos=0;
<span class="lineNum">     330 </span>            :   
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :   AliEMCALSuperModuleCoords *idealSM = new AliEMCALSuperModuleCoords[fNSuperModule];</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :   for (Int_t smodnum = 0; smodnum &lt; geom-&gt;GetNumberOfSuperModules(); ++smodnum) {</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     AliEMCALSuperModuleCoords &amp;smc = idealSM[smodnum];</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     phiRad = geom-&gt;GetPhiCenterOfSMSec(smodnum); //comes in radians</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     phi = phiRad*180./TMath::Pi(); //need degrees for AliAlignObjParams</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     xpos = rpos * TMath::Cos(phiRad);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :     ypos = rpos * TMath::Sin(phiRad);</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :     zpos = pars[2];</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     if(  geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_Half </span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :       || geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_3rd </span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       || geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kDCAL_Ext ) {</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :       xpos += (pars[1]/2. * TMath::Sin(phiRad));</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :       ypos -= (pars[1]/2. * TMath::Cos(phiRad));</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :     } else if( geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kDCAL_Standard) {</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :         zpos = pars[2] + fInnerEdge/2.;</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     smc.fX1 = xpos;</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :     smc.fY1 = ypos;</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     smc.fPhi = phi; //degrees</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     smc.fTheta = 0.; //degrees</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :     smc.fPsi = 0.; //degrees</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :     if(smodnum%2==0) {</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :       smc.fZ1 = zpos;</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :       smc.fZ1 = -zpos;</span>
<span class="lineNum">     357 </span>            :     }
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :     printf(&quot;&lt;SM %d&gt; IDEAL x,y,z positions: %.2f,%.2f,%.2f, IDEAL phi,theta,psi angles: %.2f,%.2f,%.2f\n&quot;,smodnum,smc.fX1,smc.fY1,smc.fZ1,smc.fPhi,smc.fTheta,smc.fPsi);</span>
<span class="lineNum">     359 </span>            :     
<span class="lineNum">     360 </span>            :   }
<span class="lineNum">     361 </span>            :   
<span class="lineNum">     362 </span>            :   //Real coordinates of center and rotation angles need to be computed
<span class="lineNum">     363 </span>            :   //from the survey/CATIA points
<span class="lineNum">     364 </span>            :   const Int_t buffersize = 255;
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :   char substr[buffersize];</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   AliEMCALSuperModuleCoords *realSM = new AliEMCALSuperModuleCoords[fNSuperModule];</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :   for (Int_t smodnum = 0; smodnum &lt; geom-&gt;GetNumberOfSuperModules(); ++smodnum) {</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     AliEMCALSuperModuleCoords &amp;smc = realSM[smodnum];</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     Double_t zLength = pars[2]*2.; //length of SM in z from software</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :     Double_t halfHeight = pars[0]; //half the height of the SM in y direction</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :     Double_t halfWidth = pars[1];</span>
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :     printf(&quot;AliEMCALGeometry says zlength = %.2f, halfheight = %.2f, halfwidth = %.2f\n&quot;,zLength,halfHeight,halfWidth);</span>
<span class="lineNum">     374 </span>            :     
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     snprintf(substr,buffersize,&quot;4096%d&quot;,smodnum);</span>
<span class="lineNum">     376 </span>            :     //retrieve components of four face points and determine average position of center
<span class="lineNum">     377 </span>            :     //in x,y,z
<span class="lineNum">     378 </span>            :     
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :     std::vector&lt;Double_t&gt; xval;</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     std::vector&lt;Double_t&gt; yval;</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :     std::vector&lt;Double_t&gt; zval;</span>
<span class="lineNum">     382 </span>            :     
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :     for(Int_t i = 0; i &lt; svypts-&gt;GetEntries(); i++) {</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :       AliSurveyPoint* pt = (AliSurveyPoint*)svypts-&gt;At(i);</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :       TString ptname = pt-&gt;GetPointName();</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :       if(ptname.Contains(substr)) {</span>
<span class="lineNum">     387 </span>            :         //Note: order of values is 00, 01, 10, 11
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :         xval.push_back(pt-&gt;GetX()*100.); //convert m to cm</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :         yval.push_back(pt-&gt;GetY()*100.); </span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :         zval.push_back(pt-&gt;GetZ()*100.); </span>
<span class="lineNum">     391 </span>            :       }
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     393 </span>            :     
<span class="lineNum">     394 </span>            :     //compute center of active area of each SM on bottome face from survey points
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     Double_t activeX = ((xval[0] + (xval[2] - xval[0])/2.)        //x00 and x10</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                         +(xval[1] + (xval[3] - xval[1])/2.) ) /2.; //x01 and x11</span>
<span class="lineNum">     397 </span>            :     
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :         Double_t activeY = ((yval[0] + (yval[2] - yval[0])/2.)</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :                         +(yval[1] + (yval[3] - yval[1])/2.) ) /2.;</span>
<span class="lineNum">     400 </span>            :         
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :         Double_t activeZ = ((zval[0] + (zval[2] - zval[0])/2.)</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :                         +(zval[1] + (zval[3] - zval[1])/2.) ) /2.;</span>
<span class="lineNum">     403 </span>            :     
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     printf(&quot;Bottom Center of active area of SM %s: %.2f, %.2f, %.2f\n&quot;,substr,activeX,activeY,activeZ);</span>
<span class="lineNum">     405 </span>            :     
<span class="lineNum">     406 </span>            :     //compute angles for each SM
<span class="lineNum">     407 </span>            :     //rotation about each axis
<span class="lineNum">     408 </span>            :     //phi = angle in x-y plane
<span class="lineNum">     409 </span>            :     
<span class="lineNum">     410 </span>            :     Double_t realphi = 0.;
<span class="lineNum">     411 </span>            :     //Note: this is phi wrt y axis.  To get phi wrt to x, add pi/2
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :     if(smodnum%2 == 0) {</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :       realphi = (TMath::ATan((yval[2] - yval[0])/(xval[2] - xval[0])) </span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :                  +TMath::ATan((yval[3] - yval[1])/(xval[3] - xval[1])) )/2.;</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :       realphi = (TMath::ATan((yval[0] - yval[2])/(xval[0] - xval[2]))</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                  +TMath::ATan((yval[1] - yval[3])/(xval[1] - xval[3])) )/2.;</span>
<span class="lineNum">     418 </span>            :     }
<span class="lineNum">     419 </span>            :     
<span class="lineNum">     420 </span>            :     //NOTE: Psi angle is always zero because the two z values being
<span class="lineNum">     421 </span>            :     //subtracted are exactly the same, but just in case that could change...
<span class="lineNum">     422 </span>            :     //psi = angle in x-z plane
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :     Double_t realpsi = (TMath::ATan((zval[0] - zval[2])/(xval[2] - xval[0]))</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :                         +TMath::ATan((zval[1] - zval[3])/(xval[3] - xval[1])) )/2.;</span>
<span class="lineNum">     425 </span>            :     
<span class="lineNum">     426 </span>            :     //theta = angle in y-z plane
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :     Double_t realtheta = TMath::Pi()/2. </span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :     + (TMath::ATan((zval[2] - zval[3])/(yval[3] - yval[2]))</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :        +TMath::ATan((zval[0] - zval[1])/(yval[1] - yval[0])) )/2.;</span>
<span class="lineNum">     430 </span>            :         
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :     printf(&quot;Old edge of %s 01: %.2f, %.2f, %.2f\n&quot;,substr,xval[1],yval[1],zval[1]);</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :     printf(&quot;Old edge of %s 11: %.2f, %.2f, %.2f\n&quot;,substr,xval[3],yval[3],zval[3]);</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :     printf(&quot;Real theta angle (degrees) = %.2f\n&quot;,realtheta*TMath::RadToDeg());</span>
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span>            :     //Now calculate the center of the box in z with length added to the 01
<span class="lineNum">     436 </span>            :     //and 11 corners, corrected by the theta angle
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :     Double_t activeLength = TMath::Abs(((zval[1] - zval[0]) + (zval[3] - zval[2]))/2.);</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :     printf(&quot;ACTIVE LENGTH = %.2f\n&quot;,activeLength);</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :     if(smodnum%2 == 0) {</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :       yval[1] += (zLength - activeLength)*sin(realtheta);</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :       yval[3] += (zLength - activeLength)*sin(realtheta);</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :       zval[1] += (zLength - activeLength)*cos(realtheta);</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :       zval[3] += (zLength - activeLength)*cos(realtheta);</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :       yval[1] -= (zLength - activeLength)*sin(realtheta);</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :       yval[3] -= (zLength - activeLength)*sin(realtheta);</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :       zval[1] -= (zLength - activeLength)*cos(realtheta);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :       zval[3] -= (zLength - activeLength)*cos(realtheta);</span>
<span class="lineNum">     449 </span>            :     }
<span class="lineNum">     450 </span>            :     
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :     printf(&quot;New extended edge of %s 01: %.2f, %.2f, %.2f\n&quot;,substr,xval[1],yval[1],zval[1]);            </span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :     printf(&quot;New extended edge of %s 11: %.2f, %.2f, %.2f\n&quot;,substr,xval[3],yval[3],zval[3]);</span>
<span class="lineNum">     453 </span>            :     
<span class="lineNum">     454 </span>            :     //Compute the center of the bottom of the box in x,y,z
<span class="lineNum">     455 </span>            :     Double_t realX = activeX;    
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :     Double_t realY = ((yval[0] + (yval[2] - yval[0])/2.)</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :                       +(yval[1] + (yval[3] - yval[1])/2.) ) /2.;    </span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :     Double_t realZ = ((zval[0] + (zval[2] - zval[0])/2.)</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :                       +(zval[1] + (zval[3] - zval[1])/2.) ) /2.;</span>
<span class="lineNum">     460 </span>            :     
<span class="lineNum">     461 </span>            :     
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :     printf(&quot;Bottom Center of SM %s Box: %.2f, %.2f, %.2f\n&quot;,substr,realX,realY,realZ);</span>
<span class="lineNum">     463 </span>            :     
<span class="lineNum">     464 </span>            :     //correct the SM centers so that we have the center of the box in
<span class="lineNum">     465 </span>            :     //x,y using the phi,theta angles                   
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :     realX += halfHeight*TMath::Cos(TMath::Pi()/2+realphi);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     realY += halfHeight*(TMath::Sin(TMath::Pi()/2+realphi) + TMath::Sin(realtheta));</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     realZ += halfHeight*TMath::Cos(TMath::Pi()/2-realtheta);</span>
<span class="lineNum">     469 </span>            :     
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     printf(&quot;Rotation angles of SM %s (phi,psi,theta) in degrees: %.4f, %.4f, %.4f\n&quot;,substr,realphi*TMath::RadToDeg(),realpsi*TMath::RadToDeg(),realtheta*TMath::RadToDeg());</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :     printf(&quot;Middle of SM %s: %.2f, %.2f, %.2f\n\n&quot;,substr,realX,realY,realZ);</span>
<span class="lineNum">     472 </span>            :     
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     smc.fX1 = realX;</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     smc.fY1 = realY;</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :     smc.fZ1 = realZ;</span>
<span class="lineNum">     476 </span>            :     
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :     smc.fPhi = 90. + realphi*TMath::RadToDeg();</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     smc.fTheta = 0. + realtheta*TMath::RadToDeg();</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :     smc.fPsi = 0. + realpsi*TMath::RadToDeg();</span>
<span class="lineNum">     480 </span>            :     
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :   }//loop over supermodules</span>
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span>            :   //Now take average values for A and C side SMs (0&amp;1,2&amp;3) and set
<span class="lineNum">     484 </span>            :   //their values to be equal to that average
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :   for (Int_t i = 0; i &lt; fNSuperModule; i++) {</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :     if(i%2==0) {</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :       AliEMCALSuperModuleCoords &amp;realA = realSM[i];</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :       AliEMCALSuperModuleCoords &amp;realC = realSM[i+1];</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :       Double_t avgx = (realA.fX1 + realC.fX1)/2.;</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :       Double_t avgy = (realA.fY1 + realC.fY1)/2.;</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :       Double_t avgphi = (realA.fPhi + realC.fPhi)/2.;</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :       Double_t avgtheta = (realA.fTheta + realC.fTheta)/2.;</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :       Double_t avgpsi = (realA.fPsi + realC.fPsi)/2.;</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :       printf(&quot;AVERAGE VALUES: %.2f,%.2f,%.2f,%.2f,%.2f\n&quot;,avgx,avgy,avgphi,avgtheta,avgpsi);</span>
<span class="lineNum">     495 </span>            :       
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :       realA.fX1 = avgx;         realC.fX1 = avgx;</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :       realA.fY1 = avgy;         realC.fY1 = avgy;</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :       realA.fPhi = avgphi;      realC.fPhi = avgphi;</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :       realA.fTheta = avgtheta;  realC.fTheta = avgtheta;</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :       realA.fPsi = avgpsi;      realC.fPhi = avgphi;</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     502 </span>            :   }
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :   fSuperModuleData = new AliEMCALSuperModuleDelta[fNSuperModule];</span>
<span class="lineNum">     505 </span>            :   
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :   for (Int_t i = 0; i &lt; fNSuperModule; ++i) {</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :     const AliEMCALSuperModuleCoords &amp;real = realSM[i];</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :     const AliEMCALSuperModuleCoords &amp;ideal = idealSM[i];</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :     AliEMCALSuperModuleDelta &amp;t = fSuperModuleData[i];</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :     t.fXShift = real.fX1 - ideal.fX1;</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     t.fYShift = real.fY1 - ideal.fY1;</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :     t.fZShift = real.fZ1 - ideal.fZ1;</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :     t.fPhi = real.fPhi - ideal.fPhi;</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     t.fTheta = real.fTheta - ideal.fTheta;</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     t.fPsi = real.fPsi - ideal.fPsi;</span>
<span class="lineNum">     516 </span>            : 
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :     printf(&quot;===================== SM %d =======================\n&quot;,i);</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     printf(&quot;real x (%.2f) - ideal x (%.2f) = shift in x (%.2f)\n&quot;,real.fX1,ideal.fX1,t.fXShift);</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     printf(&quot;real y (%.2f) - ideal y (%.2f) = shift in y (%.2f)\n&quot;,real.fY1,ideal.fY1,t.fYShift);</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     printf(&quot;real z (%.2f) - ideal z (%.2f) = shift in z (%.2f)\n&quot;,real.fZ1,ideal.fZ1,t.fZShift);</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :     printf(&quot;real theta (%.2f) - ideal theta (%.2f) = shift in theta %.2f\n&quot;,real.fTheta,ideal.fTheta,t.fTheta);</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     printf(&quot;real psi (%.2f) - ideal psi (%.2f) = shift in psi %.2f\n&quot;,real.fPsi,ideal.fPsi,t.fPsi);</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :     printf(&quot;real phi (%.2f) - ideal phi (%.2f) = shift in phi %.2f\n&quot;,real.fPhi,ideal.fPhi,t.fPhi);</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :     printf(&quot;===================================================\n&quot;);    </span>
<span class="lineNum">     525 </span>            :   }
<span class="lineNum">     526 </span>            :   
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :   delete [] realSM;</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :   delete [] idealSM;</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     530 </span>            : 
<a name="531"><span class="lineNum">     531 </span>            : </a>
<span class="lineNum">     532 </span>            : //____________________________________________________________________________
<span class="lineNum">     533 </span>            : void AliEMCALSurvey::InitSuperModuleData(const Double_t *xReal, const Double_t *yReal, 
<span class="lineNum">     534 </span>            :                                          const Double_t *zReal, const Double_t *psiReal,
<span class="lineNum">     535 </span>            :                                          const Double_t *thetaReal, const Double_t *phiReal)
<span class="lineNum">     536 </span>            : {
<span class="lineNum">     537 </span>            :   ///////////////////////////////////////
<span class="lineNum">     538 </span>            :   //Dummy method just takes the inputted values and applies them
<span class="lineNum">     539 </span>            :   //
<span class="lineNum">     540 </span>            :   //Useful for testing small changes
<span class="lineNum">     541 </span>            :   //////////////////////////////////////
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :   AliEMCALGeometry *geom = AliEMCALGeometry::GetInstance();</span>
<span class="lineNum">     543 </span>            :   //Center of supermodules
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :   Float_t pars[] = {geom-&gt;GetSuperModulesPar(0),geom-&gt;GetSuperModulesPar(1),geom-&gt;GetSuperModulesPar(2)};</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :   Double_t rpos = (geom-&gt;GetEnvelop(0) + geom-&gt;GetEnvelop(1))/2.;</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :   Float_t fInnerEdge = geom-&gt;GetDCALInnerEdge();</span>
<span class="lineNum">     547 </span>            :   Double_t phi=0, phiRad=0, xpos=0, ypos=0, zpos=0;
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :   zpos = pars[2];</span>
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :   AliEMCALSuperModuleCoords *idealSM = new AliEMCALSuperModuleCoords[fNSuperModule];</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :   for (Int_t smodnum = 0; smodnum &lt; geom-&gt;GetNumberOfSuperModules(); ++smodnum) {</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :     AliEMCALSuperModuleCoords &amp;smc = idealSM[smodnum];</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :     phiRad = geom-&gt;GetPhiCenterOfSMSec(smodnum); //comes in radians</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :     phi = phiRad*180./TMath::Pi(); //need degrees for AliAlignObjParams</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :     xpos = rpos * TMath::Cos(phiRad);</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :     ypos = rpos * TMath::Sin(phiRad);</span>
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :     if(  geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_Half</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :       || geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kEMCAL_3rd</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :       || geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kDCAL_Ext ) {</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :       xpos += (pars[1]/2. * TMath::Sin(phiRad));</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :       ypos -= (pars[1]/2. * TMath::Cos(phiRad));</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :     } else if( geom-&gt;GetSMType(smodnum) == AliEMCALGeometry::kDCAL_Standard) {</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :         zpos = pars[2] + fInnerEdge/2.;</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :     smc.fX1 = xpos;</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :     smc.fY1 = ypos;</span>
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :     smc.fPhi = phi; //degrees</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :     smc.fTheta = 0.; //degrees</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :     smc.fPsi = 0.; //degrees</span>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :     if(smodnum%2==0) {</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :       smc.fZ1 = zpos;</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :       smc.fZ1 = -zpos;</span>
<span class="lineNum">     579 </span>            :     }
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span>            :   }
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :   AliEMCALSuperModuleCoords *realSM = new AliEMCALSuperModuleCoords[fNSuperModule];</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :   for (Int_t smodnum = 0; smodnum &lt; geom-&gt;GetNumberOfSuperModules(); ++smodnum) {</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :     AliEMCALSuperModuleCoords &amp;smc = realSM[smodnum];</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :     smc.fX1    = xReal[smodnum];  </span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :     smc.fY1    = yReal[smodnum];  </span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :     smc.fZ1    = zReal[smodnum];  </span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :     smc.fTheta = thetaReal[smodnum];</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :     smc.fPsi   = psiReal[smodnum];</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :     smc.fPhi   = phiReal[smodnum];</span>
<span class="lineNum">     592 </span>            :   }
<span class="lineNum">     593 </span>            :   
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :   fSuperModuleData = new AliEMCALSuperModuleDelta[fNSuperModule];</span>
<span class="lineNum">     595 </span>            :   
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :   for (Int_t i = 0; i &lt; fNSuperModule; ++i) {</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :     const AliEMCALSuperModuleCoords &amp;real = realSM[i];</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :     const AliEMCALSuperModuleCoords &amp;ideal = idealSM[i];</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :     AliEMCALSuperModuleDelta &amp;t = fSuperModuleData[i];</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :     t.fTheta = real.fTheta - ideal.fTheta;</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :     t.fPsi = 0.;</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :     t.fPhi = real.fPhi - ideal.fPhi;</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :     t.fXShift = real.fX1 - ideal.fX1;</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :     t.fYShift = real.fY1 - ideal.fY1;</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :     t.fZShift = real.fZ1 - ideal.fZ1;</span>
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     printf(&quot;===================== SM %d =======================\n&quot;,i);</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :     printf(&quot;real x (%.2f) - ideal x (%.2f) = shift in x (%.2f)\n&quot;,real.fX1,ideal.fX1,t.fXShift);</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :     printf(&quot;real y (%.2f) - ideal y (%.2f) = shift in y (%.2f)\n&quot;,real.fY1,ideal.fY1,t.fYShift);</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     printf(&quot;real z (%.2f) - ideal z (%.2f) = shift in z (%.2f)\n&quot;,real.fZ1,ideal.fZ1,t.fZShift);</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :     printf(&quot;real theta (%.2f) - ideal theta (%.2f) = shift in theta %.2f\n&quot;,real.fTheta,ideal.fTheta,t.fTheta);</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     printf(&quot;real psi (%.2f) - ideal psi (%.2f) = shift in psi %.2f\n&quot;,real.fPsi,ideal.fPsi,t.fPsi);</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :     printf(&quot;real phi (%.2f) - ideal phi (%.2f) = shift in phi %.2f\n&quot;,real.fPhi,ideal.fPhi,t.fPhi);</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :     printf(&quot;===================================================\n&quot;);    </span>
<span class="lineNum">     615 </span>            :   }
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :   delete [] realSM;</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :   delete [] idealSM;</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     620 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
