<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - T0/T0rec/AliT0Reconstructor.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">T0/T0rec</a> - AliT0Reconstructor.cxx<span style="font-size: 80%;"> (source / <a href="AliT0Reconstructor.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">458</td>
            <td class="headerCovTableEntry">547</td>
            <td class="headerCovTableEntryMed">83.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">12</td>
            <td class="headerCovTableEntry">12</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : /* $Id$ */
<span class="lineNum">      17 </span>            : /*********************************************************************
<span class="lineNum">      18 </span>            :  *  T0 reconstruction and filling ESD
<span class="lineNum">      19 </span>            :  *  - reconstruct mean time (interation time) 
<span class="lineNum">      20 </span>            :  *  - vertex position
<span class="lineNum">      21 </span>            :  *  -  multiplicity
<span class="lineNum">      22 </span>            :  ********************************************************************/
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #include &lt;AliESDEvent.h&gt;
<span class="lineNum">      25 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;AliT0RecPoint.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;AliRawReader.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;AliT0RawReader.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;AliT0digit.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;AliT0Reconstructor.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;AliT0Parameters.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;AliT0Calibrator.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;AliESDfriend.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;AliESDTZERO.h&quot;
<span class="lineNum">      35 </span>            : //#include &quot;AliESDTZEROfriend.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;AliCDBEntry.h&quot; 
<span class="lineNum">      38 </span>            : #include &quot;AliCDBManager.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;AliCTPTimeParams.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;AliLHCClockPhase.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;AliT0CalibSeasonTimeShift.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;AliESDRun.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;AliGRPObject.h&quot;
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : #include &lt;TArrayI.h&gt;
<span class="lineNum">      46 </span>            : #include &lt;TGraph.h&gt;
<span class="lineNum">      47 </span>            : #include &lt;TMath.h&gt;
<span class="lineNum">      48 </span>            : #include &lt;Riostream.h&gt;
<a name="49"><span class="lineNum">      49 </span>            : #include &lt;TBits.h&gt;</a>
<span class="lineNum">      50 </span>            : 
<a name="51"><span class="lineNum">      51 </span><span class="lineCov">         20 : ClassImp(AliT0Reconstructor)</span></a>
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span><span class="lineCov">          2 :   AliT0Reconstructor:: AliT0Reconstructor(): AliReconstructor(),</span>
<span class="lineNum">      54 </span><span class="lineCov">          2 :                                              fdZonA(0),</span>
<span class="lineNum">      55 </span><span class="lineCov">          2 :                                              fdZonC(0),</span>
<span class="lineNum">      56 </span><span class="lineCov">          2 :                                              fZposition(0),</span>
<span class="lineNum">      57 </span><span class="lineCov">          2 :                                              fParam(NULL),</span>
<span class="lineNum">      58 </span><span class="lineCov">          2 :                                              fAmpLEDrec(),</span>
<span class="lineNum">      59 </span><span class="lineCov">          2 :                                              fQTC(0),</span>
<span class="lineNum">      60 </span><span class="lineCov">          2 :                                              fAmpLED(0),</span>
<span class="lineNum">      61 </span><span class="lineCov">          2 :                                              fCalib(),</span>
<span class="lineNum">      62 </span><span class="lineCov">          2 :                                              fLatencyHPTDC(9000),</span>
<span class="lineNum">      63 </span><span class="lineCov">          2 :                                              fLatencyL1(0),</span>
<span class="lineNum">      64 </span><span class="lineCov">          2 :                                              fLatencyL1A(0),</span>
<span class="lineNum">      65 </span><span class="lineCov">          2 :                                              fLatencyL1C(0),</span>
<span class="lineNum">      66 </span><span class="lineCov">          2 :                                              fGRPdelays(0),</span>
<span class="lineNum">      67 </span><span class="lineCov">          2 :                                              fTimeMeanShift(0x0),</span>
<span class="lineNum">      68 </span><span class="lineCov">          2 :                                              fTimeSigmaShift(0x0),</span>
<span class="lineNum">      69 </span><span class="lineCov">          2 :                                              fESDTZERO(NULL),</span>
<span class="lineNum">      70 </span><span class="lineCov">          2 :                                              fESDTZEROfriend(NULL),</span>
<span class="lineNum">      71 </span><span class="lineCov">          2 :                                              fIsCDFfromGRP(kFALSE), </span>
<span class="lineNum">      72 </span><span class="lineCov">          2 :                                              fMeanOrA(0),</span>
<span class="lineNum">      73 </span><span class="lineCov">          2 :                                              fMeanOrC(0),</span>
<span class="lineNum">      74 </span><span class="lineCov">          2 :                                              fMeanTVDC(0),</span>
<span class="lineNum">      75 </span><span class="lineCov">          2 :                                              fLHCperiod(kFALSE)</span>
<span class="lineNum">      76 </span><span class="lineCov">         10 : {</span>
<span class="lineNum">      77 </span><span class="lineCov">        100 :   for (Int_t i=0; i&lt;24; i++)  { fTime0vertex[i] =0; fQT1mean[i]=0;}</span>
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            :   //constructor
<span class="lineNum">      80 </span><span class="lineCov">          8 :   AliCDBEntry *entry = AliCDBManager::Instance()-&gt;Get(&quot;GRP/CTP/CTPtiming&quot;);</span>
<span class="lineNum">      81 </span><span class="lineCov">          2 :   if (!entry) AliFatal(&quot;CTP timing parameters are not found in OCDB !&quot;);</span>
<span class="lineNum">      82 </span><span class="lineCov">          2 :   AliCTPTimeParams *ctpParams = (AliCTPTimeParams*)entry-&gt;GetObject();</span>
<span class="lineNum">      83 </span><span class="lineCov">          2 :   Float_t l1Delay = (Float_t)ctpParams-&gt;GetDelayL1L0()*25.0;</span>
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineCov">          8 :   AliCDBEntry *entry1 = AliCDBManager::Instance()-&gt;Get(&quot;GRP/CTP/TimeAlign&quot;);</span>
<span class="lineNum">      86 </span><span class="lineCov">          2 :   if (!entry1) AliFatal(&quot;CTP time-alignment is not found in OCDB !&quot;);</span>
<span class="lineNum">      87 </span><span class="lineCov">          2 :   AliCTPTimeParams *ctpTimeAlign = (AliCTPTimeParams*)entry1-&gt;GetObject();</span>
<span class="lineNum">      88 </span><span class="lineCov">          2 :   l1Delay += ((Float_t)ctpTimeAlign-&gt;GetDelayL1L0()*25.0);</span>
<span class="lineNum">      89 </span>            :  
<span class="lineNum">      90 </span><span class="lineCov">          8 :   AliCDBEntry *entry4 = AliCDBManager::Instance()-&gt;Get(&quot;GRP/Calib/LHCClockPhase&quot;);</span>
<span class="lineNum">      91 </span><span class="lineCov">          2 :   if (!entry4) AliFatal(&quot;LHC clock-phase shift is not found in OCDB !&quot;);</span>
<span class="lineNum">      92 </span><span class="lineCov">          2 :   AliLHCClockPhase *phase = (AliLHCClockPhase*)entry4-&gt;GetObject();</span>
<span class="lineNum">      93 </span>            :   
<span class="lineNum">      94 </span><span class="lineCov">          4 :   fGRPdelays = l1Delay - phase-&gt;GetMeanPhase();</span>
<span class="lineNum">      95 </span>            :   
<span class="lineNum">      96 </span><span class="lineCov">          8 :   AliCDBEntry *entry5 = AliCDBManager::Instance()-&gt;Get(&quot;T0/Calib/TimeAdjust&quot;);</span>
<span class="lineNum">      97 </span><span class="lineCov">          2 :   if (entry5) {</span>
<span class="lineNum">      98 </span><span class="lineCov">          2 :     AliT0CalibSeasonTimeShift *timeshift = (AliT0CalibSeasonTimeShift*)entry5-&gt;GetObject();</span>
<span class="lineNum">      99 </span><span class="lineCov">          2 :     fTimeMeanShift = timeshift-&gt;GetT0Means();</span>
<span class="lineNum">     100 </span><span class="lineCov">          2 :     fTimeSigmaShift  = timeshift-&gt;GetT0Sigmas();</span>
<span class="lineNum">     101 </span><span class="lineCov">          2 :   }</span>
<span class="lineNum">     102 </span>            :   else
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :     AliWarning(&quot;Time Adjust is not found in OCDB !&quot;);</span>
<span class="lineNum">     104 </span>            :   
<span class="lineNum">     105 </span><span class="lineCov">          4 :   fParam = AliT0Parameters::Instance();</span>
<span class="lineNum">     106 </span><span class="lineCov">          2 :   fParam-&gt;Init();</span>
<span class="lineNum">     107 </span>            :   
<span class="lineNum">     108 </span><span class="lineCov">        100 :   for (Int_t i=0; i&lt;24; i++){</span>
<span class="lineNum">     109 </span><span class="lineCov">         48 :     TGraph* gr = fParam -&gt;GetAmpLEDRec(i);</span>
<span class="lineNum">     110 </span><span class="lineCov">         96 :     if (gr) fAmpLEDrec.AddAtAndExpand(gr,i) ; </span>
<span class="lineNum">     111 </span><span class="lineCov">         48 :     TGraph* gr1 = fParam -&gt;GetAmpLED(i);</span>
<span class="lineNum">     112 </span><span class="lineCov">         96 :     if (gr1) fAmpLED.AddAtAndExpand(gr1,i) ; </span>
<span class="lineNum">     113 </span><span class="lineCov">         48 :     TGraph* gr2 = fParam -&gt;GetQTC(i);</span>
<span class="lineNum">     114 </span><span class="lineCov">         96 :     if (gr2) fQTC.AddAtAndExpand(gr2,i) ;       </span>
<span class="lineNum">     115 </span><span class="lineCov">         96 :     fTime0vertex[i] = fParam-&gt;GetCFD(i);</span>
<span class="lineNum">     116 </span><span class="lineCov">         96 :     fQT1mean[i] = fParam-&gt;GetQT1(i);</span>
<span class="lineNum">     117 </span><span class="lineCov">         96 :     fPedestal[i] = fParam-&gt;GetPedestalOld(i);</span>
<span class="lineNum">     118 </span><span class="lineCov">         48 :     printf(&quot; OCDB fTime0vertex %f fQT1mean %f pedestal %f \n&quot;,fTime0vertex[i], fQT1mean[i],fPedestal[i] );</span>
<span class="lineNum">     119 </span>            :   }
<span class="lineNum">     120 </span><span class="lineCov">          4 :   fMeanOrA = fParam-&gt;GetMeanOrA();</span>
<span class="lineNum">     121 </span><span class="lineCov">          4 :   fMeanOrC = fParam-&gt;GetMeanOrC();</span>
<span class="lineNum">     122 </span><span class="lineCov">          4 :   fMeanTVDC = fParam-&gt;GetMeanVertex();</span>
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span><span class="lineCov">          4 :   fLatencyL1 = fParam-&gt;GetLatencyL1();</span>
<span class="lineNum">     126 </span><span class="lineCov">          4 :   fLatencyL1A = fParam-&gt;GetLatencyL1A(); </span>
<span class="lineNum">     127 </span><span class="lineCov">          4 :   fLatencyL1C = fParam-&gt;GetLatencyL1C();</span>
<span class="lineNum">     128 </span><span class="lineCov">          4 :   fLatencyHPTDC = fParam-&gt;GetLatencyHPTDC();</span>
<span class="lineNum">     129 </span><span class="lineCov">         10 :   AliDebug(2,Form(&quot; LatencyL1 %f latencyL1A %f latencyL1C %f latencyHPTDC %f \n&quot;,fLatencyL1, fLatencyL1A, fLatencyL1C, fLatencyHPTDC));</span>
<span class="lineNum">     130 </span>            :  
<span class="lineNum">     131 </span><span class="lineCov">        100 :   for (Int_t i=0; i&lt;24; i++) {</span>
<span class="lineNum">     132 </span><span class="lineCov">         48 :      if( fTime0vertex[i] &lt; 500 || fTime0vertex[i] &gt; 60000)</span>
<span class="lineNum">     133 </span><span class="lineCov">         48 :        { fTime0vertex[i] =( 1000.*fLatencyHPTDC - 1000.*fLatencyL1 + 1000.*fGRPdelays)/24.4;</span>
<span class="lineNum">     134 </span><span class="lineCov">         48 :          fIsCDFfromGRP=kTRUE;</span>
<span class="lineNum">     135 </span><span class="lineCov">         48 :        }</span>
<span class="lineNum">     136 </span><span class="lineCov">        240 :      AliDebug(2,Form(&quot;OCDB mean CFD time %i %f \n&quot;,i, fTime0vertex[i]));</span>
<span class="lineNum">     137 </span>            :   }
<span class="lineNum">     138 </span>            :   //here real Z position
<span class="lineNum">     139 </span><span class="lineCov">          4 :   fdZonC = TMath::Abs(fParam-&gt;GetZPosition(&quot;T0/C/PMT1&quot;));</span>
<span class="lineNum">     140 </span><span class="lineCov">          4 :   fdZonA = TMath::Abs(fParam-&gt;GetZPosition(&quot;T0/A/PMT15&quot;));</span>
<span class="lineNum">     141 </span>            :   
<span class="lineNum">     142 </span><span class="lineCov">          6 :   fCalib = new AliT0Calibrator();</span>
<span class="lineNum">     143 </span><span class="lineCov">          6 :   fESDTZERO  = new AliESDTZERO();</span>
<span class="lineNum">     144 </span>            :   //LHC period
<span class="lineNum">     145 </span><span class="lineCov">          8 :    AliCDBEntry* entry6 = AliCDBManager::Instance()-&gt;Get(&quot;GRP/GRP/Data&quot;);</span>
<span class="lineNum">     146 </span><span class="lineCov">          6 :   AliGRPObject* grpData = dynamic_cast&lt;AliGRPObject*&gt;(entry6-&gt;GetObject());</span>
<span class="lineNum">     147 </span><span class="lineCov">          2 :   if (!grpData) {printf(&quot;Failed to get GRP data for run&quot;); return;}</span>
<span class="lineNum">     148 </span><span class="lineCov">          2 :   TString LHCperiod = grpData-&gt;GetLHCPeriod();</span>
<span class="lineNum">     149 </span><span class="lineCov">          4 :   if(LHCperiod.Contains(&quot;LHC15&quot;)) fLHCperiod=kTRUE;</span>
<span class="lineNum">     150 </span>            :  
<span class="lineNum">     151 </span><span class="lineCov">          6 : }</span>
<a name="152"><span class="lineNum">     152 </span>            : </a>
<span class="lineNum">     153 </span>            : //_____________________________________________________________________________
<span class="lineNum">     154 </span>            : void AliT0Reconstructor::Reconstruct(TTree*digitsTree, TTree*clustersTree) const
<span class="lineNum">     155 </span>            : {
<span class="lineNum">     156 </span>            :   // T0 digits reconstruction
<span class="lineNum">     157 </span>            :   Int_t refAmp = 0 ; /*Int_t (GetRecoParam()-&gt;GetRefAmp());*/
<span class="lineNum">     158 </span>            :   
<span class="lineNum">     159 </span><span class="lineCov">          8 :   TArrayI * timeCFD = new TArrayI(24); </span>
<span class="lineNum">     160 </span><span class="lineCov">          4 :   TArrayI * timeLED = new TArrayI(24); </span>
<span class="lineNum">     161 </span><span class="lineCov">          4 :   TArrayI * chargeQT0 = new TArrayI(24); </span>
<span class="lineNum">     162 </span><span class="lineCov">          4 :   TArrayI * chargeQT1 = new TArrayI(24); </span>
<span class="lineNum">     163 </span>            : 
<span class="lineNum">     164 </span>            :  
<span class="lineNum">     165 </span>            :   Float_t c = 29.9792458; // cm/ns
<span class="lineNum">     166 </span><span class="lineCov">          4 :   Float_t channelWidth = fParam-&gt;GetChannelWidth() ;  </span>
<span class="lineNum">     167 </span>            :   Double32_t vertex = 9999999, meanVertex = 0 ;
<span class="lineNum">     168 </span>            :   Double32_t timeDiff=999999, meanTime=999999, timeclock=999999;
<span class="lineNum">     169 </span>            :   
<span class="lineNum">     170 </span>            :   
<span class="lineNum">     171 </span><span class="lineCov">         12 :   AliDebug(1,Form(&quot;Start DIGITS reconstruction &quot;));</span>
<span class="lineNum">     172 </span>            :   
<span class="lineNum">     173 </span><span class="lineCov">          4 :   Float_t lowAmpThreshold =  GetRecoParam()-&gt;GetAmpLowThreshold();  </span>
<span class="lineNum">     174 </span><span class="lineCov">          4 :   Float_t highAmpThreshold =  GetRecoParam()-&gt;GetAmpHighThreshold(); </span>
<span class="lineNum">     175 </span><span class="lineCov">          4 :   printf(&quot;Reconstruct(TTree*digitsTree highAmpThreshold %f  lowAmpThreshold %f \n&quot;,lowAmpThreshold, highAmpThreshold);</span>
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span>            :   //shift T0A, T0C , T0AC
<span class="lineNum">     178 </span><span class="lineCov">          4 :   Float_t shiftA = GetRecoParam() -&gt; GetLow(310);  </span>
<span class="lineNum">     179 </span><span class="lineCov">          4 :   Float_t shiftC = GetRecoParam() -&gt; GetLow(311);  </span>
<span class="lineNum">     180 </span><span class="lineCov">          4 :   Float_t shiftAC = GetRecoParam() -&gt; GetLow(312);</span>
<span class="lineNum">     181 </span><span class="lineCov">         12 :   AliDebug(2, Form(&quot;Reconstruct(TTree*digitsTree shiftA %f shiftC %f shiftAC %f \n&quot;,shiftA, shiftC, shiftAC));</span>
<span class="lineNum">     182 </span>            :   
<span class="lineNum">     183 </span>            :   Double32_t besttimeA=9999999;  Double32_t besttimeA_best=0;
<span class="lineNum">     184 </span>            :   Double32_t besttimeC=9999999;  Double32_t besttimeC_best=0;
<span class="lineNum">     185 </span><span class="lineCov">          4 :   Int_t timeDelayCFD[24]; </span>
<span class="lineNum">     186 </span><span class="lineCov">          4 :   Int_t badpmt[24];</span>
<span class="lineNum">     187 </span>            :   //Bad channel
<span class="lineNum">     188 </span><span class="lineCov">        200 :   for (Int_t i=0; i&lt;24; i++) {</span>
<span class="lineNum">     189 </span><span class="lineCov">         96 :     badpmt[i] = GetRecoParam() -&gt; GetBadChannels(i);</span>
<span class="lineNum">     190 </span><span class="lineCov">         96 :     timeDelayCFD[i] =  Int_t (fParam-&gt;GetTimeDelayCFD(i));</span>
<span class="lineNum">     191 </span>            :   }
<span class="lineNum">     192 </span><span class="lineCov">          4 :   fCalib-&gt;SetEq(0);</span>
<span class="lineNum">     193 </span><span class="lineCov">          4 :   TBranch *brDigits=digitsTree-&gt;GetBranch(&quot;T0&quot;);</span>
<span class="lineNum">     194 </span><span class="lineCov">          8 :   AliT0digit *fDigits = new AliT0digit() ;</span>
<span class="lineNum">     195 </span><span class="lineCov">          4 :   if (brDigits) {</span>
<span class="lineNum">     196 </span><span class="lineCov">          4 :     brDigits-&gt;SetAddress(&amp;fDigits);</span>
<span class="lineNum">     197 </span>            :   }else{
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;EXEC Branch T0 digits not found&quot;));</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     200 </span>            :   }
<span class="lineNum">     201 </span>            :   
<span class="lineNum">     202 </span><span class="lineCov">          4 :   digitsTree-&gt;GetEvent(0);</span>
<span class="lineNum">     203 </span><span class="lineCov">          4 :   digitsTree-&gt;GetEntry(0);</span>
<span class="lineNum">     204 </span><span class="lineCov">          4 :   brDigits-&gt;GetEntry(0);</span>
<span class="lineNum">     205 </span><span class="lineCov">          4 :   fDigits-&gt;GetTimeCFD(*timeCFD);</span>
<span class="lineNum">     206 </span><span class="lineCov">          4 :   fDigits-&gt;GetTimeLED(*timeLED);</span>
<span class="lineNum">     207 </span><span class="lineCov">          4 :   fDigits-&gt;GetQT0(*chargeQT0);</span>
<span class="lineNum">     208 </span><span class="lineCov">          4 :   fDigits-&gt;GetQT1(*chargeQT1);</span>
<span class="lineNum">     209 </span><span class="lineCov">          4 :   Int_t onlineMean =  fDigits-&gt;MeanTime();</span>
<span class="lineNum">     210 </span>            :   
<span class="lineNum">     211 </span><span class="lineCov">          4 :   Bool_t tr[5];</span>
<span class="lineNum">     212 </span><span class="lineCov">         48 :   for (Int_t i=0; i&lt;5; i++) tr[i]=false; </span>
<span class="lineNum">     213 </span>            :   
<span class="lineNum">     214 </span>            :   
<span class="lineNum">     215 </span><span class="lineCov">          4 :   AliT0RecPoint frecpoints;</span>
<span class="lineNum">     216 </span><span class="lineCov">          4 :   AliT0RecPoint * pfrecpoints = &amp;frecpoints;</span>
<span class="lineNum">     217 </span><span class="lineCov">          4 :   clustersTree-&gt;Branch( &quot;T0&quot;, &quot;AliT0RecPoint&quot; ,&amp;pfrecpoints);</span>
<span class="lineNum">     218 </span>            :   
<span class="lineNum">     219 </span><span class="lineCov">          4 :   Float_t time[24], adc[24], adcmip[24];</span>
<span class="lineNum">     220 </span><span class="lineCov">        200 :   for (Int_t ipmt=0; ipmt&lt;24; ipmt++) {</span>
<span class="lineNum">     221 </span><span class="lineCov">        192 :     if(timeCFD-&gt;At(ipmt)&gt;0 ) {</span>
<span class="lineNum">     222 </span><span class="lineCov">         12 :       Float_t timefull = 0.001*( timeCFD-&gt;At(ipmt) - 511 - timeDelayCFD[ipmt])  * channelWidth;</span>
<span class="lineNum">     223 </span><span class="lineCov">          6 :       frecpoints.SetTimeFull(ipmt, 0 ,timefull) ;</span>
<span class="lineNum">     224 </span><span class="lineCov">         18 :       if(( chargeQT1-&gt;At(ipmt) - chargeQT0-&gt;At(ipmt))&gt;0)  </span>
<span class="lineNum">     225 </span><span class="lineCov">         18 :         adc[ipmt] = chargeQT1-&gt;At(ipmt) - chargeQT0-&gt;At(ipmt);</span>
<span class="lineNum">     226 </span>            :       else
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :         adc[ipmt] = 0; </span>
<span class="lineNum">     228 </span>            :       // no walk correction for 2015 data
<span class="lineNum">     229 </span><span class="lineCov">          6 :       if(!fLHCperiod)      </span>
<span class="lineNum">     230 </span><span class="lineCov">         18 :       time[ipmt] = fCalib-&gt; WalkCorrection(refAmp, ipmt, Int_t(adc[ipmt]),  timeCFD-&gt;At(ipmt)) ;</span>
<span class="lineNum">     231 </span>            :       else
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :         time[ipmt] = timeCFD-&gt;At(ipmt) -  timeDelayCFD[ipmt];</span>
<span class="lineNum">     233 </span><span class="lineCov">          6 :       time[ipmt] =   time[ipmt] - 511;   </span>
<span class="lineNum">     234 </span><span class="lineCov">         18 :       Double_t sl = Double_t(timeLED-&gt;At (ipmt) - timeCFD-&gt;At(ipmt));</span>
<span class="lineNum">     235 </span>            :       //    time[ipmt] = fCalib-&gt; WalkCorrection( refAmp,ipmt, Int_t(sl),  timeCFD-&gt;At(ipmt) ) ;
<span class="lineNum">     236 </span><span class="lineCov">         30 :     AliDebug(5,Form(&quot; ipmt %i QTC  %i , time in chann %i (led-cfd) %i &quot;,</span>
<span class="lineNum">     237 </span>            :                     ipmt, Int_t(adc[ipmt]) ,Int_t(time[ipmt]),Int_t( sl)));
<span class="lineNum">     238 </span>            :       
<span class="lineNum">     239 </span>            :       Double_t ampMip = 0;
<span class="lineNum">     240 </span><span class="lineCov">         12 :       TGraph* ampGraph = (TGraph*)fAmpLED.At(ipmt);</span>
<span class="lineNum">     241 </span><span class="lineCov">         18 :       if (ampGraph) ampMip = ampGraph-&gt;Eval(sl);</span>
<span class="lineNum">     242 </span>            :       Double_t qtMip = 0;
<span class="lineNum">     243 </span><span class="lineCov">         12 :       TGraph* qtGraph = (TGraph*)fQTC.At(ipmt);</span>
<span class="lineNum">     244 </span><span class="lineCov">         18 :       if (qtGraph) qtMip = qtGraph-&gt;Eval(adc[ipmt]);</span>
<span class="lineNum">     245 </span><span class="lineCov">         30 :       AliDebug(5,Form(&quot;  Amlitude in MIPS LED %f ,  QTC %f in channels %f\n &quot;,ampMip,qtMip, adc[ipmt]));</span>
<span class="lineNum">     246 </span><span class="lineCov">          6 :        frecpoints.SetTime(ipmt, Float_t(time[ipmt]) );</span>
<span class="lineNum">     247 </span><span class="lineCov">          6 :       frecpoints.SetAmpLED(ipmt, Float_t( ampMip)); </span>
<span class="lineNum">     248 </span><span class="lineCov">          6 :       frecpoints.SetAmp(ipmt, Float_t(qtMip));</span>
<span class="lineNum">     249 </span><span class="lineCov">          6 :       adcmip[ipmt]=qtMip;</span>
<span class="lineNum">     250 </span>            :       
<span class="lineNum">     251 </span><span class="lineCov">          6 :     }</span>
<span class="lineNum">     252 </span>            :     else {
<span class="lineNum">     253 </span><span class="lineCov">         90 :       time[ipmt] = -99999;</span>
<span class="lineNum">     254 </span><span class="lineCov">         90 :       adc[ipmt] = 0;</span>
<span class="lineNum">     255 </span><span class="lineCov">         90 :       adcmip[ipmt] = 0;</span>
<span class="lineNum">     256 </span>            :       
<span class="lineNum">     257 </span>            :     }
<span class="lineNum">     258 </span>            :   }
<span class="lineNum">     259 </span>            :   Int_t npmtsC=0;
<span class="lineNum">     260 </span><span class="lineCov">        104 :   for (Int_t ipmt=0; ipmt&lt;12; ipmt++){</span>
<span class="lineNum">     261 </span><span class="lineCov">         97 :     if(time[ipmt] !=0  &amp;&amp; time[ipmt] != -99999</span>
<span class="lineNum">     262 </span><span class="lineCov">         50 :        &amp;&amp;  adcmip[ipmt]&gt;lowAmpThreshold &amp;&amp; adcmip[ipmt]&lt;highAmpThreshold )</span>
<span class="lineNum">     263 </span>            :       {
<span class="lineNum">     264 </span><span class="lineCov">          2 :         if(time[ipmt]&lt;besttimeC) besttimeC=time[ipmt]; //timeC</span>
<span class="lineNum">     265 </span>            :         //      if(TMath::Abs(time[ipmt])&lt;TMath::Abs(besttimeC_best)) 
<span class="lineNum">     266 </span>            :         //        besttimeC_best=time[ipmt]; //timeC
<span class="lineNum">     267 </span><span class="lineCov">          1 :         besttimeC_best += time[ipmt];  //sum of timeC </span>
<span class="lineNum">     268 </span><span class="lineCov">          1 :         npmtsC++;</span>
<span class="lineNum">     269 </span><span class="lineCov">          1 :       }</span>
<span class="lineNum">     270 </span>            :   }
<span class="lineNum">     271 </span>            :   Int_t npmtsA=0;
<span class="lineNum">     272 </span><span class="lineCov">        104 :   for ( Int_t ipmt=12; ipmt&lt;24; ipmt++)</span>
<span class="lineNum">     273 </span>            :     {
<span class="lineNum">     274 </span><span class="lineCov">         99 :       if(time[ipmt] != 0 &amp;&amp; time[ipmt] != -99999</span>
<span class="lineNum">     275 </span><span class="lineCov">         56 :          &amp;&amp; adcmip[ipmt]&gt;lowAmpThreshold &amp;&amp; adcmip[ipmt]&lt;highAmpThreshold)</span>
<span class="lineNum">     276 </span>            :         {
<span class="lineNum">     277 </span><span class="lineCov">          5 :           if(time[ipmt]&lt;besttimeA) besttimeA=time[ipmt]; </span>
<span class="lineNum">     278 </span>            :           //      if(TMath::Abs(time[ipmt] ) &lt; TMath::Abs(besttimeA_best)) 
<span class="lineNum">     279 </span>            :           //    besttimeA_best=time[ipmt]; //timeA
<span class="lineNum">     280 </span><span class="lineCov">          3 :           besttimeA_best += time[ipmt];  //sum of timeA </span>
<span class="lineNum">     281 </span><span class="lineCov">          3 :           npmtsA++;</span>
<span class="lineNum">     282 </span><span class="lineCov">          3 :         }</span>
<span class="lineNum">     283 </span>            :     }
<span class="lineNum">     284 </span><span class="lineCov">          5 :   if (npmtsC&gt;0) besttimeC_best = besttimeC_best/npmtsC;</span>
<span class="lineNum">     285 </span><span class="lineCov">          6 :   if (npmtsA&gt;0) besttimeA_best = besttimeA_best/npmtsA;</span>
<span class="lineNum">     286 </span>            :   
<span class="lineNum">     287 </span><span class="lineCov">          4 :   if( besttimeA &lt; 999999 &amp;&amp; besttimeA!=0) {</span>
<span class="lineNum">     288 </span><span class="lineCov">          2 :     frecpoints.SetTimeBestA((besttimeA_best * channelWidth  - fdZonA/c)  );</span>
<span class="lineNum">     289 </span><span class="lineCov">          2 :     frecpoints.SetTime1stA((besttimeA * channelWidth  - fdZonA/c - shiftA) );</span>
<span class="lineNum">     290 </span><span class="lineCov">          2 :     tr[1]=true;</span>
<span class="lineNum">     291 </span><span class="lineCov">          2 :   }</span>
<span class="lineNum">     292 </span>            :   
<span class="lineNum">     293 </span><span class="lineCov">          4 :   if( besttimeC &lt; 999999 &amp;&amp; besttimeC!=0) {</span>
<span class="lineNum">     294 </span><span class="lineCov">          1 :     frecpoints.SetTimeBestC((besttimeC_best * channelWidth  - fdZonC/c) );</span>
<span class="lineNum">     295 </span><span class="lineCov">          1 :     frecpoints.SetTime1stC((besttimeC * channelWidth  - fdZonC/c - shiftC) );</span>
<span class="lineNum">     296 </span><span class="lineCov">          1 :     tr[2]=true;</span>
<span class="lineNum">     297 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     298 </span>            :   
<span class="lineNum">     299 </span><span class="lineCov">         20 :   AliDebug(5,Form(&quot;1stimeA %f , besttimeA %f 1sttimeC %f besttimeC %f &quot;,</span>
<span class="lineNum">     300 </span>            :                   besttimeA, besttimeA_best,
<span class="lineNum">     301 </span>            :                   besttimeC, besttimeC_best) );
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span><span class="lineCov">          4 :   if(besttimeA &lt;999999 &amp;&amp; besttimeC &lt; 999999 ){</span>
<span class="lineNum">     304 </span>            :     //    timeDiff = (besttimeC - besttimeA)*channelWidth;
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     timeDiff = (besttimeA - besttimeC)*channelWidth;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     meanTime = channelWidth * (besttimeA_best + besttimeC_best)/2. ; </span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :     timeclock = channelWidth * (besttimeA + besttimeC)/2. - shiftAC ;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :     vertex = meanVertex - 0.001* c*(timeDiff)/2.;// + (fdZonA - fdZonC)/2;</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :     tr[0]=true; </span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     311 </span><span class="lineCov">          4 :   frecpoints.SetVertex(vertex);</span>
<span class="lineNum">     312 </span><span class="lineCov">          4 :   frecpoints.SetMeanTime(meanTime );</span>
<span class="lineNum">     313 </span><span class="lineCov">          4 :   frecpoints.SetT0clock(timeclock );</span>
<span class="lineNum">     314 </span><span class="lineCov">          4 :   frecpoints.SetT0Trig(tr);</span>
<span class="lineNum">     315 </span>            :   
<span class="lineNum">     316 </span><span class="lineCov">         20 :  AliDebug(5,Form(&quot;fRecPoints:::  1stimeA %f , besttimeA %f 1sttimeC %f besttimeC %f vertex %f&quot;,</span>
<span class="lineNum">     317 </span>            :                   frecpoints.Get1stTimeA(),  frecpoints.GetBestTimeA(),
<span class="lineNum">     318 </span>            :                   frecpoints.Get1stTimeC(),  frecpoints.GetBestTimeC(), 
<span class="lineNum">     319 </span>            :                   vertex ) );
<span class="lineNum">     320 </span>            :   
<span class="lineNum">     321 </span><span class="lineCov">         20 :   AliDebug(5,Form(&quot;T0 triggers %d %d %d %d %d&quot;,tr[0],tr[1],tr[2],tr[3],tr[4]));</span>
<span class="lineNum">     322 </span>            :   
<span class="lineNum">     323 </span>            :   //online mean
<span class="lineNum">     324 </span><span class="lineCov">          4 :   frecpoints.SetOnlineMean(Int_t(onlineMean));</span>
<span class="lineNum">     325 </span><span class="lineCov">         20 :   AliDebug(10,Form(&quot;  timeDiff %f #channel,  meanTime %f #channel, vertex %f cm online mean %i timeclock %f ps&quot;,timeDiff, meanTime,vertex, Int_t(onlineMean), timeclock));</span>
<span class="lineNum">     326 </span>            :   
<span class="lineNum">     327 </span><span class="lineCov">          4 :   clustersTree-&gt;Fill();</span>
<span class="lineNum">     328 </span>            :   
<span class="lineNum">     329 </span><span class="lineCov">          8 :   delete timeCFD;</span>
<span class="lineNum">     330 </span><span class="lineCov">          8 :   delete timeLED;</span>
<span class="lineNum">     331 </span><span class="lineCov">          8 :   delete chargeQT0; </span>
<span class="lineNum">     332 </span><span class="lineCov">          8 :   delete chargeQT1; </span>
<span class="lineNum">     333 </span><span class="lineCov">          8 : }</span>
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span>            : 
<a name="336"><span class="lineNum">     336 </span>            : //_______________________________________________________________________</a>
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span>            : void AliT0Reconstructor::Reconstruct(AliRawReader* rawReader, TTree*recTree) const
<span class="lineNum">     339 </span>            : {
<span class="lineNum">     340 </span>            :   // T0 raw -&gt;
<span class="lineNum">     341 </span>            :   //
<span class="lineNum">     342 </span><span class="lineCov">          8 :   Float_t meanOrA=0, meanOrC=0, meanTVDC=0, meanQT1[24]={0};</span>
<span class="lineNum">     343 </span><span class="lineCov">          8 :   if (fMeanOrA==0)  meanOrA = fTime0vertex[0] + 587;</span>
<span class="lineNum">     344 </span>            :   else 
<span class="lineNum">     345 </span>            :     meanOrA=fMeanOrA;
<span class="lineNum">     346 </span><span class="lineCov">          8 :   if (fMeanOrC==0) meanOrC = fTime0vertex[0] + 678;</span>
<span class="lineNum">     347 </span>            :   else 
<span class="lineNum">     348 </span>            :     meanOrC=fMeanOrC;
<span class="lineNum">     349 </span><span class="lineCov">          8 :   if(  fMeanTVDC==0)  meanTVDC = fTime0vertex[0] + 2564;</span>
<span class="lineNum">     350 </span>            :   else 
<span class="lineNum">     351 </span>            :     meanTVDC=fMeanTVDC;
<span class="lineNum">     352 </span><span class="lineCov">        200 :   for (int i=0; i&lt;24; i++) {</span>
<span class="lineNum">     353 </span><span class="lineCov">        192 :     if (fQT1mean[i]==0)  meanQT1[i]= fTime0vertex[0] + 2564;</span>
<span class="lineNum">     354 </span>            :     else 
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :       meanQT1[i]=fQT1mean[i];</span>
<span class="lineNum">     356 </span>            :   } 
<span class="lineNum">     357 </span>            :  // old or new QTC: 0 old ; &gt;0 new
<span class="lineNum">     358 </span><span class="lineCov">          4 :   Int_t oldORnew = GetRecoParam()-&gt;GetLow(205);</span>
<span class="lineNum">     359 </span><span class="lineCov">          4 :   Int_t timeDelayCFD[24]; </span>
<span class="lineNum">     360 </span><span class="lineCov">          4 :   Int_t corridor = GetRecoParam() -&gt; GetCorridor();  </span>
<span class="lineNum">     361 </span><span class="lineCov">          8 :   if(fIsCDFfromGRP) corridor *=5;</span>
<span class="lineNum">     362 </span><span class="lineCov">          4 :   Int_t badpmt[24];</span>
<span class="lineNum">     363 </span>            :   //Bad channel
<span class="lineNum">     364 </span><span class="lineCov">        200 :   for (Int_t i=0; i&lt;24; i++) {</span>
<span class="lineNum">     365 </span><span class="lineCov">         96 :     badpmt[i] = GetRecoParam() -&gt; GetBadChannels(i);</span>
<span class="lineNum">     366 </span><span class="lineCov">         96 :     timeDelayCFD[i] =  Int_t (fParam-&gt;GetTimeDelayCFD(i));</span>
<span class="lineNum">     367 </span>            :   }
<span class="lineNum">     368 </span><span class="lineCov">          4 :   Int_t equalize = GetRecoParam() -&gt; GetEq();</span>
<span class="lineNum">     369 </span><span class="lineCov">          4 :   fCalib-&gt;SetEq(equalize);</span>
<span class="lineNum">     370 </span><span class="lineCov">          4 :   Int_t low[500], high[500];</span>
<span class="lineNum">     371 </span>            :   Float_t timefull=-99999;;
<span class="lineNum">     372 </span>            :   Float_t tvdc  = -99999; Float_t ora = -99999; Float_t orc = -99999;
<span class="lineNum">     373 </span>            :   
<span class="lineNum">     374 </span><span class="lineCov">          4 :   Int_t timeCFD[24], timeLED[24], chargeQT0[24], chargeQT1[24];</span>
<span class="lineNum">     375 </span><span class="lineCov">          4 :   Float_t time2zero[24]; </span>
<span class="lineNum">     376 </span>            :   Double32_t timeDiff, meanTime, timeclock;
<span class="lineNum">     377 </span>            :   timeDiff =  meanTime = timeclock = 9999999;
<span class="lineNum">     378 </span>            :   Float_t c = 29.9792458; // cm/ns
<span class="lineNum">     379 </span>            :   Double32_t vertex = 9999999;
<span class="lineNum">     380 </span><span class="lineCov">          4 :   Int_t amplitude[26], amplitudeNew[26];</span>
<span class="lineNum">     381 </span>            :   Int_t onlineMean=0;
<span class="lineNum">     382 </span>            :   Float_t meanVertex = 0;
<span class="lineNum">     383 </span><span class="lineCov">        200 :    for (Int_t i0=0; i0&lt;24; i0++) {</span>
<span class="lineNum">     384 </span><span class="lineCov">         96 :     low[i0] = Int_t(fTime0vertex[i0]) - corridor;</span>
<span class="lineNum">     385 </span><span class="lineCov">         96 :     high[i0] = Int_t(fTime0vertex[i0]) + corridor;</span>
<span class="lineNum">     386 </span><span class="lineCov">         96 :     time2zero[i0] = 99999;</span>
<span class="lineNum">     387 </span>            :    }
<span class="lineNum">     388 </span>            :   
<span class="lineNum">     389 </span><span class="lineCov">          4 :   Int_t alldata[250][5];   // container for readed raw </span>
<span class="lineNum">     390 </span><span class="lineCov">       2008 :   for (Int_t i0=0; i0&lt;250; i0++)</span>
<span class="lineNum">     391 </span><span class="lineCov">      12000 :     for (Int_t j0=0; j0&lt;5; j0++)  alldata[i0][j0]=0; </span>
<span class="lineNum">     392 </span>            :   
<span class="lineNum">     393 </span><span class="lineCov">          4 :   Float_t lowAmpThreshold =  GetRecoParam()-&gt;GetAmpLowThreshold();  </span>
<span class="lineNum">     394 </span><span class="lineCov">          4 :   Float_t highAmpThreshold =  GetRecoParam()-&gt;GetAmpHighThreshold();</span>
<span class="lineNum">     395 </span>            :   
<span class="lineNum">     396 </span>            :   Double32_t besttimeA=9999999;  Double32_t besttimeA_best=0;
<span class="lineNum">     397 </span>            :   Double32_t besttimeC=9999999;  Double32_t besttimeC_best=0;
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span><span class="lineCov">          4 :   Float_t channelWidth = fParam-&gt;GetChannelWidth() ;  </span>
<span class="lineNum">     400 </span>            :   
<span class="lineNum">     401 </span><span class="lineCov">          4 :   AliT0RecPoint frecpoints;</span>
<span class="lineNum">     402 </span><span class="lineCov">          4 :   AliT0RecPoint * pfrecpoints = &amp;frecpoints;</span>
<span class="lineNum">     403 </span>            :   
<span class="lineNum">     404 </span><span class="lineCov">          4 :   recTree-&gt;Branch( &quot;T0&quot;, &quot;AliT0RecPoint&quot; ,&amp;pfrecpoints);</span>
<span class="lineNum">     405 </span>            :   
<span class="lineNum">     406 </span><span class="lineCov">         20 :   AliDebug(10,&quot; before read data &quot;);</span>
<span class="lineNum">     407 </span><span class="lineCov">          4 :   AliT0RawReader myrawreader(rawReader);</span>
<span class="lineNum">     408 </span>            :   
<span class="lineNum">     409 </span><span class="lineCov">          4 :   UInt_t type =rawReader-&gt;GetType();</span>
<span class="lineNum">     410 </span>            :   
<span class="lineNum">     411 </span><span class="lineCov">          8 :   if (!myrawreader.Next())</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :     AliDebug(1,Form(&quot; no raw data found!!&quot;));</span>
<span class="lineNum">     413 </span>            :   else
<span class="lineNum">     414 </span>            :     {  
<span class="lineNum">     415 </span><span class="lineCov">        200 :       for (Int_t i=0; i&lt;24; i++)</span>
<span class="lineNum">     416 </span>            :         {
<span class="lineNum">     417 </span><span class="lineCov">         96 :           timeCFD[i]=0; timeLED[i]=0;</span>
<span class="lineNum">     418 </span>            :         }
<span class="lineNum">     419 </span>            :       
<span class="lineNum">     420 </span><span class="lineCov">          4 :       if(type == 7  ) {  //only physics </span>
<span class="lineNum">     421 </span><span class="lineCov">       1816 :         for (Int_t i=0; i&lt;226; i++) {</span>
<span class="lineNum">     422 </span><span class="lineCov">      10848 :           for (Int_t iHit=0; iHit&lt;5; iHit++) {</span>
<span class="lineNum">     423 </span><span class="lineCov">       4520 :             alldata[i][iHit] = myrawreader.GetData(i,iHit);</span>
<span class="lineNum">     424 </span>            :           }
<span class="lineNum">     425 </span>            :         }
<span class="lineNum">     426 </span>            :         
<span class="lineNum">     427 </span><span class="lineCov">          8 :         Int_t fBCID=Int_t (rawReader-&gt;GetBCID());</span>
<span class="lineNum">     428 </span><span class="lineCov">          4 :         Int_t trmbunch= myrawreader.GetTRMBunchID();</span>
<span class="lineNum">     429 </span><span class="lineCov">         20 :         AliDebug(10,Form(&quot; CDH BC ID %i, TRM BC ID %i \n&quot;, fBCID, trmbunch ));</span>
<span class="lineNum">     430 </span><span class="lineCov">          4 :         if( (trmbunch-fBCID)!=37  ) {</span>
<span class="lineNum">     431 </span><span class="lineCov">         32 :           AliDebug(0,Form(&quot;wrong :::: CDH BC ID %i, TRM BC ID %i \n&quot;, fBCID, trmbunch ));</span>
<span class="lineNum">     432 </span>            :           //      type = -1;
<span class="lineNum">     433 </span>            :         }
<span class="lineNum">     434 </span><span class="lineCov">        104 :         for (Int_t in=0; in&lt;12; in++)  </span>
<span class="lineNum">     435 </span>            :           {
<span class="lineNum">     436 </span><span class="lineCov">        624 :             for (Int_t iHit=0; iHit&lt;5; iHit++) {</span>
<span class="lineNum">     437 </span><span class="lineCov">        240 :                 if(alldata[in+1][iHit] &gt; low[in] &amp;&amp; </span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                    alldata[in+1][iHit] &lt; high[in])</span>
<span class="lineNum">     439 </span>            :                   {
<span class="lineNum">     440 </span>            :                     //              printf(&quot; ::Reconstruct :: readed i %i hit %i cfd %i \n&quot;,
<span class="lineNum">     441 </span>            :                     //                 in+1,iHit, alldata[in+1][iHit] ); 
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :                     timeCFD[in] = alldata[in+1][iHit] ; </span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">     444 </span>            :                   }
<span class="lineNum">     445 </span>            :                 
<span class="lineNum">     446 </span>            :               }
<span class="lineNum">     447 </span><span class="lineCov">        624 :             for (Int_t iHit=0; iHit&lt;5; iHit++) {</span>
<span class="lineNum">     448 </span><span class="lineCov">        240 :                 if(alldata[in+1+56][iHit] &gt; low[in+12] &amp;&amp; </span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :                    alldata[in+1+56][iHit] &lt; high[in+12])</span>
<span class="lineNum">     450 </span>            :                   {
<span class="lineNum">     451 </span>            :                     //              printf(&quot; ::Reconstruct :: readed i %i hit %i cfd %i \n&quot;,
<span class="lineNum">     452 </span>            :                     //             in+12,iHit, alldata[in+1+56][iHit] ); 
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                     timeCFD[in+12] = alldata[in+56+1][iHit] ;</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">     455 </span>            :                   }
<span class="lineNum">     456 </span>            :             }       
<span class="lineNum">     457 </span>            :           }
<span class="lineNum">     458 </span><span class="lineCov">          4 :         ReadNewQTC(alldata, amplitudeNew);</span>
<span class="lineNum">     459 </span><span class="lineCov">          4 :         ReadOldQTC(alldata, amplitude);</span>
<span class="lineNum">     460 </span><span class="lineCov">          4 :         onlineMean = alldata[49][0];</span>
<span class="lineNum">     461 </span>            :         
<span class="lineNum">     462 </span><span class="lineCov">          4 :         Double32_t time[24],  adcmip[24], ampnewmip[24];</span>
<span class="lineNum">     463 </span><span class="lineCov">          4 :         Int_t adc[24];</span>
<span class="lineNum">     464 </span><span class="lineCov">        200 :         for (Int_t ipmt=0; ipmt&lt;24; ipmt++) {</span>
<span class="lineNum">     465 </span><span class="lineCov">         96 :           if(timeCFD[ipmt] &gt;  0 &amp;&amp; amplitude[ipmt]&gt;0 ){</span>
<span class="lineNum">     466 </span>            :            //for simulated data
<span class="lineNum">     467 </span>            :              //for physics  data
<span class="lineNum">     468 </span>            :             //     adc[ipmt] = fAmplitude[ipmt];
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :            Int_t refAmp = Int_t (fTime0vertex[ipmt]);</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :            adc[ipmt]=amplitude[ipmt];</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :            time[ipmt] = fCalib-&gt; WalkCorrection( refAmp, ipmt, adc[ipmt], timeCFD[ipmt] ) ;</span>
<span class="lineNum">     472 </span>            :            Double32_t qtMip = 0;
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :            TGraph * qtGraph = (TGraph*)fQTC.At(ipmt);</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :            if (qtGraph) {</span>
<span class="lineNum">     475 </span>            :              // if(oldORnew)
<span class="lineNum">     476 </span>            :              // qtMip = qtGraph-&gt;Eval(Float_t (adc[ipmt]) ) ;
<span class="lineNum">     477 </span>            :              // else 
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :              qtMip = qtGraph-&gt;Eval(Float_t (adc[ipmt]) - fPedestal[ipmt] );</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :            }</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :            if( equalize  ==0 ) </span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :              frecpoints.SetTime(ipmt, Float_t(time[ipmt]) );</span>
<span class="lineNum">     482 </span>            :            else 
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :              frecpoints.SetTime(ipmt, Float_t(time[ipmt] + fTime0vertex[ipmt]) );</span>
<span class="lineNum">     484 </span>            :            // frecpoints.SetTime(ipmt, Float_t(time[ipmt] ) );
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :            if(qtMip&lt;0) qtMip=0;</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :            frecpoints.SetAmp(ipmt,  qtMip); </span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :            adcmip[ipmt]=qtMip;</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :            ampnewmip[ipmt]=Double32_t(amplitudeNew[ipmt]);</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :            frecpoints.SetAmpLED(ipmt,ampnewmip[ipmt] ); //new amplitude </span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">     491 </span>            :           else {
<span class="lineNum">     492 </span><span class="lineCov">         96 :             time[ipmt] = -9999;</span>
<span class="lineNum">     493 </span><span class="lineCov">         96 :             adc[ipmt] = 0;</span>
<span class="lineNum">     494 </span><span class="lineCov">         96 :             adcmip[ipmt] = 0;</span>
<span class="lineNum">     495 </span>            :           }
<span class="lineNum">     496 </span>            :         }
<span class="lineNum">     497 </span>            :         Int_t npmtsC=0;
<span class="lineNum">     498 </span><span class="lineCov">        104 :         for (Int_t ipmt=0; ipmt&lt;12; ipmt++){</span>
<span class="lineNum">     499 </span><span class="lineCov">         96 :           if(time[ipmt] !=0 &amp;&amp;  time[ipmt] &gt; -9000 </span>
<span class="lineNum">     500 </span>            :              /*&amp;&amp; badpmt[ipmt]==0 */
<span class="lineNum">     501 </span><span class="lineCov">         48 :             &amp;&amp;  adcmip[ipmt]&gt;lowAmpThreshold )</span>
<span class="lineNum">     502 </span>            :             {
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :               if(time[ipmt]&lt;besttimeC) besttimeC=time[ipmt]; //timeC</span>
<span class="lineNum">     504 </span>            :               //             if(TMath::Abs(time[ipmt])&lt;TMath::Abs(besttimeC_best)) 
<span class="lineNum">     505 </span>            :               //               besttimeC_best=time[ipmt]; //timeC            
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :               besttimeC_best += time[ipmt];  //sum of timeA </span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :               npmtsC++;</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     509 </span>            :         }
<span class="lineNum">     510 </span>            :         Int_t npmtsA=0;
<span class="lineNum">     511 </span><span class="lineCov">        104 :         for ( Int_t ipmt=12; ipmt&lt;24; ipmt++)</span>
<span class="lineNum">     512 </span>            :           {
<span class="lineNum">     513 </span><span class="lineCov">         96 :             if(time[ipmt] != 0 &amp;&amp;  time[ipmt] &gt; -9000 </span>
<span class="lineNum">     514 </span>            :                /* &amp;&amp; badpmt[ipmt]==0*/ 
<span class="lineNum">     515 </span><span class="lineCov">         48 :                &amp;&amp; adcmip[ipmt]&gt;lowAmpThreshold )</span>
<span class="lineNum">     516 </span>            :               {
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :                 if(time[ipmt]&lt;besttimeA) besttimeA=time[ipmt]; </span>
<span class="lineNum">     518 </span>            :                 // if(TMath::Abs(time[ipmt] ) &lt; TMath::Abs(besttimeA_best)) 
<span class="lineNum">     519 </span>            :                 //       besttimeA_best=time[ipmt]; //timeA
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                 besttimeA_best += time[ipmt];  //sum of timeA </span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                 npmtsA++;</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :               }</span>
<span class="lineNum">     523 </span>            :          }
<span class="lineNum">     524 </span><span class="lineCov">          4 :         if (npmtsC&gt;0) besttimeC_best = besttimeC_best/npmtsC;</span>
<span class="lineNum">     525 </span><span class="lineCov">          4 :         if (npmtsA&gt;0) besttimeA_best = besttimeA_best/npmtsA;</span>
<span class="lineNum">     526 </span>            :         
<span class="lineNum">     527 </span><span class="lineCov">          4 :         if(besttimeA &lt; 999999 &amp;&amp; besttimeA!=0 ) {</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :           if( equalize  ==0 ) </span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :             frecpoints.SetTime1stA((besttimeA * channelWidth)- 1000.*fLatencyHPTDC + 1000.*fLatencyL1A - 1000.*fGRPdelays - fTimeMeanShift[1] ); </span>
<span class="lineNum">     530 </span>            :           else
<span class="lineNum">     531 </span>            :             {
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :               frecpoints.SetTimeBestA((besttimeA_best * channelWidth )); </span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :               frecpoints.SetTime1stA((besttimeA * channelWidth - fTimeMeanShift[1])); </span>
<span class="lineNum">     534 </span>            :             }
<span class="lineNum">     535 </span>            :        }
<span class="lineNum">     536 </span><span class="lineCov">          4 :         if( besttimeC &lt; 999999 &amp;&amp; besttimeC!=0) {</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :           if( equalize  ==0 ) </span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :             frecpoints.SetTime1stC((besttimeC * channelWidth)- 1000.*fLatencyHPTDC +1000.*fLatencyL1C - 1000.*fGRPdelays - fTimeMeanShift[2]);</span>
<span class="lineNum">     539 </span>            :           else
<span class="lineNum">     540 </span>            :             {
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :               frecpoints.SetTimeBestC((besttimeC_best * channelWidth ));</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :               frecpoints.SetTime1stC((besttimeC * channelWidth - fTimeMeanShift[2]));</span>
<span class="lineNum">     543 </span>            :             }
<span class="lineNum">     544 </span>            :         }
<span class="lineNum">     545 </span><span class="lineCov">         20 :         AliDebug(5,Form(&quot;1stimeA %f , besttimeA %f 1sttimeC %f besttimeC %f &quot;,</span>
<span class="lineNum">     546 </span>            :                         besttimeA, besttimeA_best,
<span class="lineNum">     547 </span>            :                        besttimeC, besttimeC_best) );
<span class="lineNum">     548 </span><span class="lineCov">         20 :         AliDebug(5,Form(&quot;fRecPoints:::  1stimeA %f , besttimeA %f 1sttimeC %f besttimeC %f shiftA %f shiftC %f &quot;,</span>
<span class="lineNum">     549 </span>            :                         frecpoints.Get1stTimeA(),  frecpoints.GetBestTimeA(),
<span class="lineNum">     550 </span>            :                         frecpoints.Get1stTimeC(),  frecpoints.GetBestTimeC(), 
<span class="lineNum">     551 </span>            :                         fTimeMeanShift[1], fTimeMeanShift[2] ) );
<span class="lineNum">     552 </span><span class="lineCov">          4 :         if( besttimeC &lt; 999999 &amp;&amp;  besttimeA &lt; 999999) { </span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :           if(equalize  ==0 )</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :             timeclock = (channelWidth*(besttimeC + besttimeA)/2.- 1000.*fLatencyHPTDC +1000.*fLatencyL1 - 1000.*fGRPdelays - fTimeMeanShift[0]);</span>
<span class="lineNum">     555 </span>            :          else
<span class="lineNum">     556 </span>            :            {
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :              timeclock = channelWidth * Float_t( besttimeA+besttimeC)/2. - fTimeMeanShift[0];</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :              meanTime = channelWidth * Float_t(besttimeA_best + besttimeC_best )/2.;</span>
<span class="lineNum">     559 </span>            :            }
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :          timeDiff = ( besttimeA - besttimeC)* 0.001* channelWidth ;</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :          vertex =  meanVertex - c*(timeDiff)/2. ; //+ (fdZonA - fdZonC)/2; </span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :        }</span>
<span class="lineNum">     563 </span>            :        
<span class="lineNum">     564 </span><span class="lineCov">          4 :       }  //if phys event       </span>
<span class="lineNum">     565 </span><span class="lineCov">         20 :        AliDebug(1,Form(&quot;  timeDiff %f #channel,  meanTime %f #ps, TOFmean%f  vertex %f cm meanVertex %f  \n&quot;,timeDiff, meanTime,timeclock, vertex,meanVertex));</span>
<span class="lineNum">     566 </span><span class="lineCov">          4 :        frecpoints.SetT0clock(timeclock);</span>
<span class="lineNum">     567 </span><span class="lineCov">          4 :        frecpoints.SetVertex(vertex);</span>
<span class="lineNum">     568 </span><span class="lineCov">          4 :        frecpoints.SetMeanTime(meanTime);</span>
<span class="lineNum">     569 </span><span class="lineCov">          4 :        frecpoints.SetOnlineMean(Int_t(onlineMean));</span>
<span class="lineNum">     570 </span>            :       
<span class="lineNum">     571 </span>            :       // Set triggers
<span class="lineNum">     572 </span><span class="lineCov">          4 :       Bool_t tr[5];</span>
<span class="lineNum">     573 </span><span class="lineCov">          4 :        Int_t trchan[5] = {50,51,52,55,56};</span>
<span class="lineNum">     574 </span><span class="lineCov">         48 :        for (Int_t i=0; i&lt;5; i++) tr[i] = false; </span>
<span class="lineNum">     575 </span><span class="lineCov">          4 :        Int_t triggername[3];//20ns around 0</span>
<span class="lineNum">     576 </span><span class="lineCov">          4 :        triggername[0] = (TMath::Abs(meanTVDC)&lt;2147483647)?(Int_t)meanTVDC:0;</span>
<span class="lineNum">     577 </span><span class="lineCov">          4 :        triggername[1] = (TMath::Abs(meanOrA) &lt;2147483647)?(Int_t)meanOrA:0;</span>
<span class="lineNum">     578 </span><span class="lineCov">          4 :        triggername[2] = (TMath::Abs(meanOrC) &lt;2147483647)?(Int_t)meanOrC:0;</span>
<span class="lineNum">     579 </span>            :        
<span class="lineNum">     580 </span><span class="lineCov">         48 :        for (Int_t itr=0; itr&lt;5; itr++) {</span>
<span class="lineNum">     581 </span><span class="lineCov">        240 :          for (Int_t iHit=0; iHit&lt;5; iHit++) </span>
<span class="lineNum">     582 </span>            :            {
<span class="lineNum">     583 </span><span class="lineCov">        100 :              Int_t trr=trchan[itr];</span>
<span class="lineNum">     584 </span><span class="lineCov">        200 :              if(itr&lt;3 ) { </span>
<span class="lineNum">     585 </span><span class="lineCov">        160 :               if( (alldata[trr][iHit] - triggername[itr]) &gt; -800 &amp;&amp;</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :                    (alldata[trr][iHit] - triggername[itr]) &lt; 800)  tr[itr]=true;</span>
<span class="lineNum">     587 </span>            :             }
<span class="lineNum">     588 </span>            :              else 
<span class="lineNum">     589 </span><span class="lineCov">         40 :             if( alldata[trr][iHit] &gt; 0)  tr[itr]=true;</span>
<span class="lineNum">     590 </span><span class="lineCov">        500 :              AliDebug(5,Form(&quot;Reconstruct :::  T0 triggers iHit %i tvdc %d orA %d orC %d centr %d semicentral %d&quot;,iHit, tr[0],tr[1],tr[2],tr[3],tr[4]));</span>
<span class="lineNum">     591 </span>            :            }       
<span class="lineNum">     592 </span>            :       }
<span class="lineNum">     593 </span><span class="lineCov">          4 :        frecpoints.SetT0Trig(tr);  </span>
<span class="lineNum">     594 </span>            :       
<span class="lineNum">     595 </span>            :       // all times without amplitude correction 
<span class="lineNum">     596 </span>            :       Float_t timecent;
<span class="lineNum">     597 </span><span class="lineCov">         48 :       for (Int_t iHit=0; iHit&lt;5; iHit++) </span>
<span class="lineNum">     598 </span>            :         {
<span class="lineNum">     599 </span>            :           timefull = timecent = -9999; 
<span class="lineNum">     600 </span>            :           tvdc = ora = orc = -9999;
<span class="lineNum">     601 </span><span class="lineCov">         20 :           if(alldata[50][iHit]&gt;0) </span>
<span class="lineNum">     602 </span><span class="lineCov">          1 :             tvdc = (Float_t(alldata[50][iHit]) - meanTVDC) * channelWidth* 0.001; </span>
<span class="lineNum">     603 </span><span class="lineCov">         20 :           if(alldata[51][iHit]&gt;0)</span>
<span class="lineNum">     604 </span><span class="lineCov">          1 :             ora = (Float_t(alldata[51][iHit]) - meanOrA) * channelWidth* 0.001;</span>
<span class="lineNum">     605 </span><span class="lineCov">         20 :           if(alldata[52][iHit]&gt;0) </span>
<span class="lineNum">     606 </span><span class="lineCov">          3 :             orc = (Float_t(alldata[52][iHit]) - meanOrC) * channelWidth* 0.001;</span>
<span class="lineNum">     607 </span>            :           
<span class="lineNum">     608 </span><span class="lineCov">         20 :           frecpoints.SetOrC( iHit, orc);</span>
<span class="lineNum">     609 </span><span class="lineCov">         20 :           frecpoints.SetOrA( iHit, ora);</span>
<span class="lineNum">     610 </span><span class="lineCov">         20 :           frecpoints.SetTVDC( iHit, tvdc);</span>
<span class="lineNum">     611 </span><span class="lineCov">       1000 :           for (Int_t i0=0; i0&lt;24; i0++) {</span>
<span class="lineNum">     612 </span><span class="lineCov">        960 :             if (equalize  ==0 )  </span>
<span class="lineNum">     613 </span><span class="lineCov">        960 :               timecent = fTime0vertex[i0] + timeDelayCFD[i0];</span>
<span class="lineNum">     614 </span>            :             else
<span class="lineNum">     615 </span>            :               timecent = fTime0vertex[i0];
<span class="lineNum">     616 </span>            :             timefull = -9999; 
<span class="lineNum">     617 </span><span class="lineCov">        480 :             if (i0&lt;12) </span>
<span class="lineNum">     618 </span>            :             {
<span class="lineNum">     619 </span><span class="lineCov">        240 :               if(alldata[i0+1][iHit]&gt;1) {</span>
<span class="lineNum">     620 </span><span class="lineCov">          1 :                 timefull = (Float_t(alldata[i0+1][iHit]) - timecent)* channelWidth* 0.001;</span>
<span class="lineNum">     621 </span>            :                 //      if(alldata[i0+1][iHit]&gt;1) printf (&quot;Reconstruct ::: RAW pmt %i hit %i time %f readed %i\n&quot;,i0,iHit, timefull,alldata[i0+1][iHit] );
<span class="lineNum">     622 </span><span class="lineCov">          1 :               }</span>
<span class="lineNum">     623 </span>            :               else 
<span class="lineNum">     624 </span><span class="lineCov">        239 :                 if(alldata[i0+45][iHit]&gt;1) {</span>
<span class="lineNum">     625 </span><span class="lineCov">          7 :                   timefull = (Float_t(alldata[i0+45][iHit]) - timecent)* channelWidth* 0.001;</span>
<span class="lineNum">     626 </span>            :                   //      if(alldata[i0+45][iHit]&gt;1) printf (&quot;Reconstruct ::: RAW pmt %i hit %i time %f readed %i\n&quot;,i0,iHit, timefull,alldata[i0+45][iHit] );
<span class="lineNum">     627 </span><span class="lineCov">          7 :                 }</span>
<span class="lineNum">     628 </span>            :             }
<span class="lineNum">     629 </span><span class="lineCov">        480 :             frecpoints.SetTimeFull(i0, iHit,timefull) ;</span>
<span class="lineNum">     630 </span>            :           }
<span class="lineNum">     631 </span>            :         }
<span class="lineNum">     632 </span>            :       //set MPD
<span class="lineNum">     633 </span><span class="lineCov">          4 :       frecpoints.SetMultA(Float_t(amplitudeNew[24]) );</span>
<span class="lineNum">     634 </span><span class="lineCov">          4 :       frecpoints.SetMultC(Float_t(amplitudeNew[25]) );</span>
<span class="lineNum">     635 </span>            :       //      printf (&quot;Reconstruct :::  T0 MPDA %i MPDC %i&quot;, amplitude[24], amplitude[25]);
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span>            :       //FIT CFD
<span class="lineNum">     638 </span>            :       Double32_t timeFIT=0;
<span class="lineNum">     639 </span><span class="lineCov">         40 :       for (int i=0; i&lt;4; i++) {</span>
<span class="lineNum">     640 </span><span class="lineCov">        208 :         for (Int_t iHit=0; iHit&lt;5; iHit++) { </span>
<span class="lineNum">     641 </span><span class="lineCov">         80 :           if(alldata[i+211][iHit]&gt;9000 &amp;&amp; alldata[i+211][iHit]&lt;12000) {</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :             timeFIT=  Double32_t(alldata[i+211][iHit]);</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :             frecpoints.SetFITTime(i, timeFIT);</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     645 </span>            :           }
<span class="lineNum">     646 </span>            :         }
<span class="lineNum">     647 </span>            :       }
<span class="lineNum">     648 </span>            :       
<span class="lineNum">     649 </span><span class="lineCov">          4 :     } // if (else )raw data</span>
<span class="lineNum">     650 </span><span class="lineCov">          4 :   recTree-&gt;Fill();</span>
<span class="lineNum">     651 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">     652 </span>            :   
<span class="lineNum">     653 </span>            :   
<a name="654"><span class="lineNum">     654 </span>            : //____________________________________________________________</a>
<span class="lineNum">     655 </span>            :   
<span class="lineNum">     656 </span>            :   void AliT0Reconstructor::FillESD(TTree */*digitsTree*/, TTree *clustersTree, AliESDEvent *pESD) const
<span class="lineNum">     657 </span>            :   {
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span>            :   /***************************************************
<span class="lineNum">     660 </span>            :   Resonstruct digits to vertex position
<span class="lineNum">     661 </span>            :   ****************************************************/
<span class="lineNum">     662 </span>            :   
<span class="lineNum">     663 </span><span class="lineCov">         64 :   AliDebug(1,Form(&quot;Start FillESD T0&quot;));</span>
<span class="lineNum">     664 </span><span class="lineCov">         16 :   if(!pESD) {</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :     AliError(&quot;No ESD Event&quot;);</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     667 </span>            :   }
<span class="lineNum">     668 </span><span class="lineCov">         16 :   pESD -&gt;SetT0spread(fTimeSigmaShift);</span>
<span class="lineNum">     669 </span>            : 
<span class="lineNum">     670 </span><span class="lineCov">         16 :   Float_t channelWidth = fParam-&gt;GetChannelWidth() ;  </span>
<span class="lineNum">     671 </span>            :   Float_t c = 0.0299792458; // cm/ps
<span class="lineNum">     672 </span>            :   Float_t currentVertex=0, shift=0;
<span class="lineNum">     673 </span>            :   Int_t ncont=-1;
<span class="lineNum">     674 </span><span class="lineCov">         16 :   const AliESDVertex* vertex = pESD-&gt;GetPrimaryVertex();</span>
<span class="lineNum">     675 </span><span class="lineCov">         16 :   if (!vertex)        vertex = pESD-&gt;GetPrimaryVertexSPD();</span>
<span class="lineNum">     676 </span><span class="lineCov">         16 :   if (!vertex)        vertex = pESD-&gt;GetPrimaryVertexTPC();</span>
<span class="lineNum">     677 </span><span class="lineCov">         16 :   if (!vertex)        vertex = pESD-&gt;GetVertex();</span>
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineCov">         16 :   if (vertex) {</span>
<span class="lineNum">     680 </span><span class="lineCov">         48 :     AliDebug(2, Form(&quot;Got %s (%s) from ESD: %f&quot;, </span>
<span class="lineNum">     681 </span>            :                     vertex-&gt;GetName(), vertex-&gt;GetTitle(), vertex-&gt;GetZ()));
<span class="lineNum">     682 </span><span class="lineCov">         16 :     currentVertex = vertex-&gt;GetZ();</span>
<span class="lineNum">     683 </span>            :     
<span class="lineNum">     684 </span><span class="lineCov">         16 :     ncont = vertex-&gt;GetNContributors();</span>
<span class="lineNum">     685 </span><span class="lineCov">         16 :     if(ncont&gt;0 ) {</span>
<span class="lineNum">     686 </span><span class="lineCov">         16 :       shift = currentVertex/c;</span>
<span class="lineNum">     687 </span><span class="lineCov">         16 :     }</span>
<span class="lineNum">     688 </span>            :   }
<span class="lineNum">     689 </span>            :   TTree *treeR = clustersTree;
<span class="lineNum">     690 </span>            :   
<span class="lineNum">     691 </span><span class="lineCov">         16 :   AliT0RecPoint frecpoints;</span>
<span class="lineNum">     692 </span><span class="lineCov">         16 :   AliT0RecPoint * pfrecpoints = &amp;frecpoints;</span>
<span class="lineNum">     693 </span>            :   
<span class="lineNum">     694 </span><span class="lineCov">         80 :   AliDebug(1,Form(&quot;Start FillESD T0&quot;));</span>
<span class="lineNum">     695 </span><span class="lineCov">         16 :   TBranch *brRec = treeR-&gt;GetBranch(&quot;T0&quot;);</span>
<span class="lineNum">     696 </span><span class="lineCov">         16 :   if (brRec) {</span>
<span class="lineNum">     697 </span><span class="lineCov">         16 :     brRec-&gt;SetAddress(&amp;pfrecpoints);</span>
<span class="lineNum">     698 </span>            :   }else{
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;EXEC Branch T0 rec not found&quot;));</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     701 </span>            :   } 
<span class="lineNum">     702 </span>            :   
<span class="lineNum">     703 </span><span class="lineCov">         16 :   brRec-&gt;GetEntry(0);</span>
<span class="lineNum">     704 </span><span class="lineCov">         16 :   Double32_t ampnew[24], time[24], ampQTC[24], timecorr[24];  </span>
<span class="lineNum">     705 </span>            :   Double32_t* tcorr;
<span class="lineNum">     706 </span><span class="lineCov">        800 :   for(Int_t i=0; i&lt;24; i++) </span>
<span class="lineNum">     707 </span><span class="lineCov">        384 :     ampnew[i]=time[i]=ampQTC[i]=timecorr[i]=0;</span>
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span>            :   //1st time 
<span class="lineNum">     710 </span><span class="lineCov">         16 :   Double32_t timeClock[3];</span>
<span class="lineNum">     711 </span><span class="lineCov">         16 :   Double32_t zPosition = frecpoints.GetVertex();</span>
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span><span class="lineCov">         16 :   timeClock[0] = frecpoints.GetT0clock() ;</span>
<span class="lineNum">     714 </span><span class="lineCov">         16 :   timeClock[1] = frecpoints.Get1stTimeA() + shift;</span>
<span class="lineNum">     715 </span><span class="lineCov">         16 :   timeClock[2] = frecpoints.Get1stTimeC() - shift;</span>
<span class="lineNum">     716 </span>            :   //best time
<span class="lineNum">     717 </span><span class="lineCov">         16 :   Double32_t timemean[3];</span>
<span class="lineNum">     718 </span><span class="lineCov">         16 :   timemean[0] = frecpoints.GetMeanTime();</span>
<span class="lineNum">     719 </span><span class="lineCov">         16 :   timemean[1] = frecpoints.GetBestTimeA() + shift;</span>
<span class="lineNum">     720 </span><span class="lineCov">         16 :   timemean[2] = frecpoints.GetBestTimeC() - shift;</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineCov">        128 :   for(Int_t i=0; i&lt;3; i++) {</span>
<span class="lineNum">     723 </span><span class="lineCov">         48 :     fESDTZERO-&gt;SetT0TOF(i,timeClock[i]);   // interaction time (ns) </span>
<span class="lineNum">     724 </span><span class="lineCov">         48 :     fESDTZERO-&gt;SetT0TOFbest(i,timemean[i]);   // interaction time (ns) </span>
<span class="lineNum">     725 </span>            :   }
<span class="lineNum">     726 </span><span class="lineCov">        800 :   for ( Int_t i=0; i&lt;24; i++) {</span>
<span class="lineNum">     727 </span><span class="lineCov">        384 :     time[i] =  frecpoints.GetTime(i); // ps to ns</span>
<span class="lineNum">     728 </span><span class="lineCov">        396 :     if ( time[i] != 0 &amp;&amp; time[i]&gt;-9999) {</span>
<span class="lineNum">     729 </span><span class="lineCov">         12 :       ampQTC[i] = frecpoints.GetAmp(i);</span>
<span class="lineNum">     730 </span><span class="lineCov">         12 :       ampnew[i] = frecpoints.AmpLED(i);</span>
<span class="lineNum">     731 </span><span class="lineCov">         60 :       AliDebug(1,Form(&quot;T0: %i  time %f  ampold %f ampnew %f \n&quot;, i, time[i], ampQTC[i], ampnew[i]));</span>
<span class="lineNum">     732 </span>            :       }
<span class="lineNum">     733 </span>            :   }
<span class="lineNum">     734 </span>            :   //   for ( Int_t i=0; i&lt;24; i++)   
<span class="lineNum">     735 </span>            :   // printf(&quot;T0: %i  time %f  ampQTC %f ampNewQTC %f \n&quot;, i, time[i], ampQTC[i], ampnew[i]);
<span class="lineNum">     736 </span><span class="lineCov">         16 :   fESDTZERO-&gt;SetT0time(time);         // best TOF on each PMT </span>
<span class="lineNum">     737 </span><span class="lineCov">         16 :   fESDTZERO-&gt;SetT0amplitude(ampQTC);     // amplitude old QTC</span>
<span class="lineNum">     738 </span><span class="lineCov">         16 :   fESDTZERO-&gt;SetT0NewAmplitude(ampnew);     // amplitude new QTC</span>
<span class="lineNum">     739 </span>            :   
<span class="lineNum">     740 </span><span class="lineCov">         16 :   Int_t trig= frecpoints.GetT0Trig();</span>
<span class="lineNum">     741 </span><span class="lineCov">         16 :   frecpoints.PrintTriggerSignals( trig);</span>
<span class="lineNum">     742 </span>            :   //  printf(&quot; !!!!! FillESD trigger %i \n&quot;,trig);
<span class="lineNum">     743 </span><span class="lineCov">         16 :   fESDTZERO-&gt;SetT0Trig(trig);</span>
<span class="lineNum">     744 </span><span class="lineCov">         16 :   fESDTZERO-&gt;SetT0zVertex(zPosition); //vertex Z position </span>
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span><span class="lineCov">         16 :   Double32_t multA=frecpoints.GetMultA();</span>
<span class="lineNum">     747 </span><span class="lineCov">         16 :   Double32_t multC=frecpoints.GetMultC();</span>
<span class="lineNum">     748 </span><span class="lineCov">         16 :   fESDTZERO-&gt;SetMultA(multA); // for backward compatubility</span>
<span class="lineNum">     749 </span><span class="lineCov">         16 :   fESDTZERO-&gt;SetMultC(multC); // for backward compatubility</span>
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span>            : 
<span class="lineNum">     752 </span><span class="lineCov">        192 :   for (Int_t iHit =0; iHit&lt;5; iHit++ ) {</span>
<span class="lineNum">     753 </span><span class="lineCov">        400 :        AliDebug(10,Form(&quot;FillESD ::: iHit %i tvdc %f orA %f orC %f\n&quot;, iHit,</span>
<span class="lineNum">     754 </span>            :            frecpoints.GetTVDC(iHit),
<span class="lineNum">     755 </span>            :            frecpoints.GetOrA(iHit),
<span class="lineNum">     756 </span>            :                        frecpoints.GetOrC(iHit) ));
<span class="lineNum">     757 </span><span class="lineCov">         80 :     fESDTZERO-&gt;SetTVDC(iHit,frecpoints.GetTVDC(iHit));</span>
<span class="lineNum">     758 </span><span class="lineCov">         80 :     fESDTZERO-&gt;SetOrA(iHit,frecpoints.GetOrA(iHit));</span>
<span class="lineNum">     759 </span><span class="lineCov">         80 :     fESDTZERO-&gt;SetOrC(iHit,frecpoints.GetOrC(iHit));</span>
<span class="lineNum">     760 </span>            :     
<span class="lineNum">     761 </span><span class="lineCov">       4000 :     for (Int_t i0=0; i0&lt;24; i0++) </span>
<span class="lineNum">     762 </span><span class="lineCov">       1920 :         fESDTZERO-&gt;SetTimeFull(i0, iHit,frecpoints.GetTimeFull(i0,iHit));    </span>
<span class="lineNum">     763 </span>            :     //FIT CFD
<span class="lineNum">     764 </span><span class="lineCov">        800 :     for (Int_t i0=0; i0&lt;4; i0++) </span>
<span class="lineNum">     765 </span><span class="lineCov">        320 :      fESDTZERO-&gt;SetPileupTime(i0, frecpoints.GetFITTime(i0)); //// 19.05.2016</span>
<span class="lineNum">     766 </span>            :    
<span class="lineNum">     767 </span><span class="lineCov">        400 :   AliDebug(1,Form(&quot;T0: SPDshift %f Vertex %f (T0A+T0C)/2 best %f #ps T0signal %f ps OrA %f ps OrC %f ps T0trig %i\n&quot;,shift, zPosition, timemean[0], timeClock[0], timeClock[1], timeClock[2], trig));</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span>            :   //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
<span class="lineNum">     770 </span>            :   // background flags
<span class="lineNum">     771 </span><span class="lineCov">         80 :   Bool_t background = BackgroundFlag();</span>
<span class="lineNum">     772 </span><span class="lineCov">         80 :   fESDTZERO-&gt;SetBackgroundFlag(background);</span>
<span class="lineNum">     773 </span><span class="lineCov">        160 :   Bool_t pileup =  PileupFlag();</span>
<span class="lineNum">     774 </span><span class="lineCov">         80 :   fESDTZERO-&gt;SetPileupFlag(pileup);</span>
<span class="lineNum">     775 </span><span class="lineCov">         80 :   TBits pileupbits = SetPileupBits();</span>
<span class="lineNum">     776 </span><span class="lineCov">        240 :   fESDTZERO-&gt;SetPileupBits(pileupbits);</span>
<span class="lineNum">     777 </span><span class="lineCov">         80 :   TBits pileout =fESDTZERO-&gt; GetT0PileupBits();</span>
<span class="lineNum">     778 </span><span class="lineCov">         80 :   pileout.Print();</span>
<span class="lineNum">     779 </span>            : 
<span class="lineNum">     780 </span>            :   //  for (Int_t i=0; i&lt;5; i++) {
<span class="lineNum">     781 </span>            :   // fESDTZERO-&gt;SetPileupTime(i, frecpoints.GetTVDC(i) ) ;
<span class="lineNum">     782 </span>            :     //   printf(&quot;!!!!!! FillESD :: pileup %i %f %f \n&quot;, i,fESDTZERO-&gt;GetPileupTime(i), frecpoints.GetTVDC(i));
<span class="lineNum">     783 </span><span class="lineCov">         80 :   }</span>
<span class="lineNum">     784 </span><span class="lineCov">         32 :   Bool_t sat  = SatelliteFlag();</span>
<span class="lineNum">     785 </span><span class="lineCov">         16 :   fESDTZERO-&gt;SetSatelliteFlag(sat);</span>
<span class="lineNum">     786 </span>            :   
<span class="lineNum">     787 </span>            :   
<span class="lineNum">     788 </span>            :   //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
<span class="lineNum">     789 </span><span class="lineCov">         16 :   if (pESD) </span>
<span class="lineNum">     790 </span><span class="lineCov">         16 :    pESD-&gt;SetTZEROData(fESDTZERO);</span>
<span class="lineNum">     791 </span>            :  
<span class="lineNum">     792 </span>            :   
<span class="lineNum">     793 </span>            : 
<span class="lineNum">     794 </span><span class="lineCov">         48 : } // vertex in 3 sigma</span>
<span class="lineNum">     795 </span>            : 
<span class="lineNum">     796 </span>            : //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
<a name="797"><span class="lineNum">     797 </span>            :  //____________________________________________________________</a>
<span class="lineNum">     798 </span>            :   
<span class="lineNum">     799 </span>            : Bool_t AliT0Reconstructor::PileupFlag() const
<span class="lineNum">     800 </span>            : {
<span class="lineNum">     801 </span>            :   //
<span class="lineNum">     802 </span>            :   Bool_t pileup = false;
<span class="lineNum">     803 </span><span class="lineCov">        160 :   Float_t tvdc[5];</span>
<span class="lineNum">     804 </span><span class="lineCov">        960 :   for (Int_t ih=0; ih&lt;5; ih++) </span>
<span class="lineNum">     805 </span>            :     {
<span class="lineNum">     806 </span><span class="lineCov">        400 :       tvdc[ih] =  fESDTZERO-&gt;GetTVDC(ih);</span>
<span class="lineNum">     807 </span>            :       
<span class="lineNum">     808 </span><span class="lineCov">        600 :      if(  tvdc[0] !=0 &amp;&amp;  tvdc[0]&gt; -10 &amp;&amp; tvdc[0]&lt; 10 )</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :        if(ih&gt;0 &amp;&amp; tvdc[ih]&gt;20 )   pileup = true; </span>
<span class="lineNum">     810 </span><span class="lineCov">       1000 :      if( tvdc[0] &gt;20 || (tvdc[0] &lt; -20  &amp;&amp;  tvdc[0] &gt; -9000) ) pileup =true;</span>
<span class="lineNum">     811 </span>            :      //    if (pileup) printf(&quot; !!!!! pile up %i  tvdc %f \n&quot;,ih,  tvdc[ih]); 
<span class="lineNum">     812 </span>            :     }
<span class="lineNum">     813 </span>            : 
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span><span class="lineCov">        160 :   return pileup;</span>
<span class="lineNum">     816 </span>            : 
<span class="lineNum">     817 </span><span class="lineCov">         80 : }</span>
<span class="lineNum">     818 </span>            : 
<a name="819"><span class="lineNum">     819 </span>            :  //____________________________________________________________</a>
<span class="lineNum">     820 </span>            :   
<span class="lineNum">     821 </span>            : TBits AliT0Reconstructor::SetPileupBits() const
<span class="lineNum">     822 </span>            : {
<span class="lineNum">     823 </span><span class="lineCov">        160 :   TBits pileup ;</span>
<span class="lineNum">     824 </span><span class="lineCov">         80 :   Float_t tvdc[5];</span>
<span class="lineNum">     825 </span><span class="lineCov">         80 :   Int_t pos, bc[21];</span>
<span class="lineNum">     826 </span>            :   UInt_t ibc;
<span class="lineNum">     827 </span><span class="lineCov">         80 :   pileup.ResetAllBits();</span>
<span class="lineNum">     828 </span><span class="lineCov">       3520 :   for ( Int_t nbc=0; nbc&lt;21; nbc++) bc[nbc]=0;</span>
<span class="lineNum">     829 </span><span class="lineCov">        960 :   for (Int_t ih=0; ih&lt;5; ih++) </span>
<span class="lineNum">     830 </span>            :     {
<span class="lineNum">     831 </span><span class="lineCov">        400 :       tvdc[ih] =  fESDTZERO-&gt;GetTVDC(ih);</span>
<span class="lineNum">     832 </span><span class="lineCov">        610 :       if(tvdc[ih]!=0 &amp;&amp; tvdc[ih]&gt;-290 &amp;&amp;tvdc[ih]&lt;290 ) {</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :         if( tvdc[ih]&gt;0) pos = Int_t (tvdc[ih]+6)/25;</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :         if(tvdc[ih]&lt;0&amp;&amp;tvdc[ih]&gt;-290)  pos = Int_t (tvdc[ih]-6)/25;       </span>
<span class="lineNum">     835 </span>            :         //      printf(&quot;AliT0Reconstructor::PileupFlag():: hit %i tvdc %f pos %i bc %i\n&quot;,ih,tvdc[ih],pos, bc[pos+10]);
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :         bc[pos+10] = 1;</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     839 </span>            :     }
<span class="lineNum">     840 </span><span class="lineCov">       3520 :   for ( Int_t nbc=0; nbc&lt;21; nbc++) {</span>
<span class="lineNum">     841 </span><span class="lineCov">       1680 :     if(bc[10]&gt;0) {</span>
<span class="lineNum">     842 </span>            :       ibc=UInt_t(nbc);
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :       if (bc[nbc]&gt;0)  pileup.SetBitNumber(ibc,kTRUE);</span>
<span class="lineNum">     844 </span>            :     }
<span class="lineNum">     845 </span>            :   }
<span class="lineNum">     846 </span>            :   
<span class="lineNum">     847 </span>            :   //  pileup.Print();
<span class="lineNum">     848 </span>            :   return pileup;
<span class="lineNum">     849 </span><span class="lineCov">        160 :   }</span>
<a name="850"><span class="lineNum">     850 </span>            :  //____________________________________________________________</a>
<span class="lineNum">     851 </span>            :   
<span class="lineNum">     852 </span>            : Bool_t AliT0Reconstructor::BackgroundFlag() const
<span class="lineNum">     853 </span>            : {
<span class="lineNum">     854 </span>            :  
<span class="lineNum">     855 </span>            :   Bool_t background = false;
<span class="lineNum">     856 </span>            :   /*  
<span class="lineNum">     857 </span>            :       Float_t orA = fESDTZERO-&gt;GetOrA(0);
<span class="lineNum">     858 </span>            :       Float_t orC = fESDTZERO-&gt;GetOrC(0);
<span class="lineNum">     859 </span>            :       Float_t tvdc =  fESDTZERO-&gt;GetTVDC(ih);
<span class="lineNum">     860 </span>            :       
<span class="lineNum">     861 </span>            :       if ( (orA &gt; -5 &amp;&amp; orA &lt;5) &amp;&amp; (orC &gt; -5 &amp;&amp; orC &lt;5) &amp;&amp; (tvdc &lt; -5 || tvdc &gt; 5)) {
<span class="lineNum">     862 </span>            :       background = true;
<span class="lineNum">     863 </span>            :       //   printf(&quot; orA %f orC %f tvdc %f\n&quot;, orA, orC, tvdc);
<span class="lineNum">     864 </span>            :       } 
<span class="lineNum">     865 </span>            :   */ 
<span class="lineNum">     866 </span><span class="lineCov">        160 :   return background;</span>
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span>            : 
<span class="lineNum">     869 </span>            : }
<span class="lineNum">     870 </span>            : 
<span class="lineNum">     871 </span>            : 
<a name="872"><span class="lineNum">     872 </span>            :  //____________________________________________________________</a>
<span class="lineNum">     873 </span>            :   
<span class="lineNum">     874 </span>            : Bool_t  AliT0Reconstructor::SatelliteFlag() const
<span class="lineNum">     875 </span>            : {
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span><span class="lineCov">         32 :  Float_t satelliteLow = GetRecoParam() -&gt; GetLowSatelliteThreshold();</span>
<span class="lineNum">     878 </span><span class="lineCov">         16 :   Float_t satelliteHigh = GetRecoParam() -&gt; GetHighSatelliteThreshold();</span>
<span class="lineNum">     879 </span>            :   Bool_t satellite = false;
<span class="lineNum">     880 </span><span class="lineCov">        800 :   for (Int_t i0=0; i0&lt;24; i0++) {</span>
<span class="lineNum">     881 </span><span class="lineCov">        384 :     Float_t timefull =  fESDTZERO -&gt; GetTimeFull(i0,0);</span>
<span class="lineNum">     882 </span><span class="lineCov">        576 :     if( timefull &gt; satelliteLow &amp;&amp; timefull &lt; satelliteHigh)  satellite=true;</span>
<span class="lineNum">     883 </span>            :   }
<span class="lineNum">     884 </span>            :         
<span class="lineNum">     885 </span><span class="lineCov">         16 :   return satellite;</span>
<span class="lineNum">     886 </span>            : 
<a name="887"><span class="lineNum">     887 </span>            : }</a>
<span class="lineNum">     888 </span>            :  //____________________________________________________________
<span class="lineNum">     889 </span>            : void  AliT0Reconstructor::ReadNewQTC(Int_t alldata[250][5], Int_t amplitude[26]) const
<span class="lineNum">     890 </span>            : {
<span class="lineNum">     891 </span>            :   // QT00 -&gt; QT11
<span class="lineNum">     892 </span><span class="lineCov">          8 :   printf(&quot;@@ readNewQTC&quot;);</span>
<span class="lineNum">     893 </span><span class="lineCov">          4 :   Float_t a[26], b[26];</span>
<span class="lineNum">     894 </span><span class="lineCov">          4 :   Int_t qt01mean[26], qt11mean[26];</span>
<span class="lineNum">     895 </span><span class="lineCov">        216 :   for(int i=0; i&lt;26; i++) {</span>
<span class="lineNum">     896 </span><span class="lineCov">        104 :      a[i] = GetRecoParam() -&gt; GetLow(i+130);</span>
<span class="lineNum">     897 </span><span class="lineCov">        104 :      b[i] = GetRecoParam() -&gt; GetLow(i+156);</span>
<span class="lineNum">     898 </span><span class="lineCov">        104 :      if(i&lt;24) </span>
<span class="lineNum">     899 </span><span class="lineCov">         96 :        qt11mean[i] =qt01mean[i] =fTime0vertex[i] + 15500;</span>
<span class="lineNum">     900 </span>            :      else
<span class="lineNum">     901 </span><span class="lineCov">          8 :       qt11mean[i] =qt01mean[i] =fTime0vertex[0] + 15500;</span>
<span class="lineNum">     902 </span>            :  
<span class="lineNum">     903 </span><span class="lineCov">        104 :      amplitude[i]=0;</span>
<span class="lineNum">     904 </span>            :   }
<span class="lineNum">     905 </span><span class="lineCov">          4 :   Int_t diff[4];</span>
<span class="lineNum">     906 </span>            :   Int_t pmt;
<span class="lineNum">     907 </span>            :    //new QTC C side
<span class="lineNum">     908 </span><span class="lineCov">        224 :   for (Int_t ik=0; ik&lt;106; ik+=4)</span>
<span class="lineNum">     909 </span>            :     {
<span class="lineNum">     910 </span><span class="lineCov">        648 :       for(int id=0; id&lt;2; id++) diff[id] = 0;</span>
<span class="lineNum">     911 </span><span class="lineCov">        156 :       if (ik&lt;48)          pmt=ik/4;</span>
<span class="lineNum">     912 </span><span class="lineCov">        112 :       if (ik&gt;47 &amp;&amp; ik&lt;52) pmt= 24;   </span>
<span class="lineNum">     913 </span><span class="lineCov">        112 :       if (ik&gt;51 &amp;&amp; ik&lt;56) pmt= 25; </span>
<span class="lineNum">     914 </span><span class="lineCov">        160 :       if(ik&gt;55)           pmt=(ik-8)/4;</span>
<span class="lineNum">     915 </span>            : 
<span class="lineNum">     916 </span><span class="lineCov">       1404 :      for(Int_t iHt = 0; iHt&lt;5; iHt++) {</span>
<span class="lineNum">     917 </span><span class="lineCov">        540 :         if(alldata[107+ik+1][iHt] &gt; (qt01mean[pmt]-1000) &amp;&amp;</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :            alldata[107+ik+1][iHt] &lt; (qt01mean[pmt]+1000) ) {</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :           diff[0]=alldata[107+ik][iHt] - alldata[107+ik+1][iHt];</span>
<span class="lineNum">     920 </span>            :           //      printf(&quot; newQTC 00 ik %i iHt %i pmt %i  QT00 %i QT01 %i \n&quot;, ik, iHt, pmt, alldata[107+ik][iHt],  alldata[107+ik+1][iHt]);
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">     922 </span>            :         }
<span class="lineNum">     923 </span>            :       }
<span class="lineNum">     924 </span><span class="lineCov">       1404 :       for(Int_t iHt = 0; iHt&lt;5; iHt++) {</span>
<span class="lineNum">     925 </span><span class="lineCov">        540 :         if( alldata[107+ik+3][iHt] &gt; (qt11mean[pmt]-1000) &amp;&amp;</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :             alldata[107+ik+3][iHt] &lt; (qt11mean[pmt]+1000) ) {</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :           diff[1]=alldata[107+ik+2][iHt] - alldata[107+ik+3][iHt];</span>
<span class="lineNum">     928 </span>            :           //      printf(&quot; newQTC 11 ik %i iHt %i pmt %i QT10 %i QT11 %i \n&quot;, ik, iHt, pmt, alldata[107+ik+2][iHt],  alldata[107+ik+3][iHt]);
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">     930 </span>            :         }
<span class="lineNum">     931 </span>            :       }
<span class="lineNum">     932 </span><span class="lineCov">        108 :       if(diff[0] != 0)  amplitude[pmt]=diff[0];</span>
<span class="lineNum">     933 </span><span class="lineCov">        108 :       if(diff[1] != 0)  {</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :         amplitude[pmt] = a[pmt]*diff[1] + b[pmt];  </span>
<span class="lineNum">     935 </span>            :         //      if (pmt==24 || pmt==25) printf(&quot; @@@ new MPD pmt %i amp %f a %f b %f \n&quot;,pmt,  amplitude[pmt],a[pmt], b[pmt]);
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     937 </span>            :       //    if(diff[0] == 0 &amp;&amp;diff[1]==0) amplitude[pmt]=0;
<span class="lineNum">     938 </span>            :     }
<a name="939"><span class="lineNum">     939 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">     940 </span>            :  //____________________________________________________________
<span class="lineNum">     941 </span>            : void  AliT0Reconstructor::ReadOldQTC(Int_t alldata[250][5], Int_t amplitude[26] ) const
<span class="lineNum">     942 </span>            : {
<span class="lineNum">     943 </span><span class="lineCov">          8 :   Int_t  chargeQT0[26], chargeQT1[26], pedestal[26];</span>
<span class="lineNum">     944 </span><span class="lineCov">          4 :   Float_t meanQT1[26];</span>
<span class="lineNum">     945 </span><span class="lineCov">        200 :   for (int i=0; i&lt;24; i++) {</span>
<span class="lineNum">     946 </span><span class="lineCov">        192 :     if (fQT1mean[i]==0)  meanQT1[i]= fTime0vertex[0] + 2564;</span>
<span class="lineNum">     947 </span>            :     else 
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :       meanQT1[i]=fQT1mean[i];</span>
<span class="lineNum">     949 </span>            :   } 
<span class="lineNum">     950 </span><span class="lineCov">         24 :   for (int i=24; i&lt;26; i++) meanQT1[i]= fQT1mean[23];</span>
<span class="lineNum">     951 </span>            : 
<span class="lineNum">     952 </span><span class="lineCov">        216 :   for (Int_t i0=0; i0&lt;26; i0++) {</span>
<span class="lineNum">     953 </span><span class="lineCov">        104 :     amplitude[i0]=0;</span>
<span class="lineNum">     954 </span><span class="lineCov">        104 :     chargeQT1[i0]=0;</span>
<span class="lineNum">     955 </span><span class="lineCov">        104 :     chargeQT0[i0]=0;</span>
<span class="lineNum">     956 </span>            :   }
<span class="lineNum">     957 </span><span class="lineCov">          4 :   Int_t ind[26];</span>
<span class="lineNum">     958 </span><span class="lineCov">        104 :   for (int iii=0; iii&lt;12; iii++) ind[iii]=25;</span>
<span class="lineNum">     959 </span><span class="lineCov">        104 :   for (int iii=12; iii&lt;24; iii++) ind[iii]=57;</span>
<span class="lineNum">     960 </span><span class="lineCov">          4 :   ind[24]=5;</span>
<span class="lineNum">     961 </span><span class="lineCov">          4 :   ind[25]=55;</span>
<span class="lineNum">     962 </span><span class="lineCov">        200 :   for (Int_t in=0; in&lt;24;  in++)</span>
<span class="lineNum">     963 </span>            :     {
<span class="lineNum">     964 </span>            :       /*      if(in==24|| in==25)
<span class="lineNum">     965 </span>            :         printf(&quot; MPD %i %i %i data %i %i \n&quot;,
<span class="lineNum">     966 </span>            :         in, 2*in+ind[in],  ind[in], alldata[2*in+ind[in]+1][0], alldata[2*in+ind[in]][0]);*/
<span class="lineNum">     967 </span><span class="lineCov">       1248 :       for (Int_t iHit=0; iHit&lt;5; iHit++) </span>
<span class="lineNum">     968 </span>            :         {
<span class="lineNum">     969 </span><span class="lineCov">        480 :           if (alldata[2*in+ind[in]+1][iHit] &gt; meanQT1[in]-800 &amp;&amp;  </span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :               alldata[2*in+ind[in]+1][iHit] &lt; meanQT1[in]+800 ) {</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :             chargeQT1[in] = alldata[2*in+ind[in]+1][iHit];</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     973 </span>            :           }
<span class="lineNum">     974 </span>            :         }
<span class="lineNum">     975 </span><span class="lineCov">       1248 :       for (Int_t iHit=0; iHit&lt;5; iHit++) </span>
<span class="lineNum">     976 </span>            :         {
<span class="lineNum">     977 </span><span class="lineCov">        480 :           if( (alldata[2*in+ind[in]][iHit] - chargeQT1[in])&gt;fPedestal[in] &amp;&amp;</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :               chargeQT1[in]&gt;0)</span>
<span class="lineNum">     979 </span>            :             {
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :               chargeQT0[in]=alldata[2*in+ind[in]][iHit];</span>
<span class="lineNum">     981 </span>            :               //      printf(&quot; readedOld QTC Raw %i %i %i\n&quot;,  in, chargeQT0[in],chargeQT1[in]);
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :               break;</span>
<span class="lineNum">     983 </span>            :             }
<span class="lineNum">     984 </span>            :         }
<span class="lineNum">     985 </span>            :       
<span class="lineNum">     986 </span><span class="lineCov">         96 :       if( (chargeQT0[in]-chargeQT1[in])&gt;fPedestal[in]) {</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :         amplitude[in]=chargeQT0[in]-chargeQT1[in];</span>
<span class="lineNum">     988 </span>            :         //      printf(&quot; OLD amplitude PMT %i %i \n&quot;,in, amplitude[in]);
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     990 </span>            :     }
<span class="lineNum">     991 </span><span class="lineCov">          4 : }    </span>
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
