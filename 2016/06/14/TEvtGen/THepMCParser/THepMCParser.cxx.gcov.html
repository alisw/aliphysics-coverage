<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - TEvtGen/THepMCParser/THepMCParser.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">TEvtGen/THepMCParser</a> - THepMCParser.cxx<span style="font-size: 80%;"> (source / <a href="THepMCParser.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">447</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">15</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : // module identifier line...</a>
<span class="lineNum">       2 </span>            : // Author: Brian Thorsbro, 24/6-2014
<span class="lineNum">       3 </span>            : 
<span class="lineNum">       4 </span>            : #include &lt;iostream&gt;
<span class="lineNum">       5 </span>            : #include &lt;sstream&gt;
<span class="lineNum">       6 </span>            : #include &lt;string&gt;
<span class="lineNum">       7 </span>            : #include &lt;list&gt;
<span class="lineNum">       8 </span>            : #include &lt;set&gt;
<span class="lineNum">       9 </span>            : #include &lt;time.h&gt;
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #include &quot;THepMCParser.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;TObject.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;TTree.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;TClonesArray.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;TFile.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;TParticle.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;TDatabasePDG.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;HepMC/IO_GenEvent.h&quot;
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : using namespace std;
<a name="22"><span class="lineNum">      22 </span>            : </a>
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span><span class="lineNoCov">          0 : THepMCParser::THepMCParser(const char * infile) : fTree(0)</span>
<span class="lineNum">      25 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      26 </span><span class="lineNoCov">          0 :    HepMC::IO_BaseClass * events = new HepMC::IO_GenEvent(infile, std::ios::in);</span>
<span class="lineNum">      27 </span><span class="lineNoCov">          0 :    init(events);</span>
<span class="lineNum">      28 </span><span class="lineNoCov">          0 :    delete events;</span>
<a name="29"><span class="lineNum">      29 </span>            :    events = 0; // nullptr</a>
<span class="lineNum">      30 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      31 </span><span class="lineNoCov">          0 : THepMCParser::THepMCParser(HepMC::IO_BaseClass * events) : fTree(0)</span>
<span class="lineNum">      32 </span><span class="lineNoCov">          0 : {</span>
<a name="33"><span class="lineNum">      33 </span><span class="lineNoCov">          0 :    init(events);</span></a>
<span class="lineNum">      34 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      35 </span>            : void THepMCParser::init(HepMC::IO_BaseClass * events)
<span class="lineNum">      36 </span>            : {
<span class="lineNum">      37 </span>            :    int particlecount = 0;
<span class="lineNum">      38 </span><span class="lineNoCov">          0 :    fTree = new TTree(&quot;treeEPOS&quot;,&quot;Tree EPOS&quot;);</span>
<span class="lineNum">      39 </span><span class="lineNoCov">          0 :    TClonesArray * array = new TClonesArray(&quot;TParticle&quot;);</span>
<span class="lineNum">      40 </span>            :    // array-&gt;BypassStreamer();
<span class="lineNum">      41 </span><span class="lineNoCov">          0 :    fTree-&gt;Branch(&quot;Particles&quot;,&amp;array); // more flags?</span>
<span class="lineNum">      42 </span><span class="lineNoCov">          0 :    THepMCParser::HeavyIonHeader_t heavyIonHeader;</span>
<span class="lineNum">      43 </span><span class="lineNoCov">          0 :    fTree-&gt;Branch(&quot;HeavyIonInfo&quot;, &amp;heavyIonHeader, THepMCParser::fgHeavyIonHeaderBranchString);</span>
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :    THepMCParser::PdfHeader_t pdfHeader;</span>
<span class="lineNum">      45 </span><span class="lineNoCov">          0 :    fTree-&gt;Branch(&quot;PdfInfo&quot;, &amp;pdfHeader, THepMCParser::fgPdfHeaderBranchString);</span>
<span class="lineNum">      46 </span>            :    HepMC::GenEvent* evt =  0; // nullptr
<span class="lineNum">      47 </span><span class="lineNoCov">          0 :    while ((evt = events-&gt;read_next_event())) {</span>
<span class="lineNum">      48 </span><span class="lineNoCov">          0 :       string errMsg1 = ParseGenEvent2TCloneArray(evt,array);</span>
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :       string errMsg2 = ParseGenEvent2HeaderStructs(evt,heavyIonHeader,pdfHeader);</span>
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :       if (errMsg1.length() == 0 &amp;&amp; errMsg2.length() == 0) {</span>
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :          fTree-&gt;Fill();</span>
<span class="lineNum">      52 </span>            :       } else {
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :          if (errMsg1.length() != 0) cerr &lt;&lt; errMsg1 &lt;&lt; endl;</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :          if (errMsg2.length() != 0) cerr &lt;&lt; errMsg2 &lt;&lt; endl;</span>
<span class="lineNum">      55 </span>            :       }
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :       particlecount += array-&gt;Capacity();</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">      58 </span>            : //   array-&gt;Clear();
<span class="lineNum">      59 </span>            : //   delete array;
<span class="lineNum">      60 </span>            : //   array = 0; // nullptr
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :    cout &lt;&lt; &quot; parsed &quot; &lt;&lt; particlecount &lt;&lt; &quot; particles&quot; &lt;&lt; endl;</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :    if(array-&gt;Capacity() != array-&gt;GetEntries()) {</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :      cerr &lt;&lt; (&quot;Not all particles processed&quot;);</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 : }</span>
<a name="66"><span class="lineNum">      66 </span>            : </a>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : TTree * THepMCParser::GetTTree()
<span class="lineNum">      69 </span>            : {
<a name="70"><span class="lineNum">      70 </span><span class="lineNoCov">          0 :    return fTree;</span></a>
<span class="lineNum">      71 </span>            : }
<span class="lineNum">      72 </span>            : void THepMCParser::WriteTTreeToFile(const char *outfile)
<span class="lineNum">      73 </span>            : {
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :    TFile * f = new TFile(outfile, &quot;recreate&quot;);</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :    fTree-&gt;Write();</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :    delete f;</span>
<span class="lineNum">      77 </span>            :    f = 0; // nullptr
<span class="lineNum">      78 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span>            : 
<a name="81"><span class="lineNum">      81 </span>            : </a>
<span class="lineNum">      82 </span>            : // Based on a validator written by Peter Hristov, CERN
<span class="lineNum">      83 </span>            : bool THepMCParser::IsValidMotherDaughtersConsitency(bool useStdErr, bool requireSecondMotherBeforeDaughters)
<span class="lineNum">      84 </span>            : {
<span class="lineNum">      85 </span>            :    bool valid = true;
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :    TClonesArray * array = new TClonesArray(&quot;TParticle&quot;);</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :    TBranch* branch = fTree-&gt;GetBranch(&quot;Particles&quot;);</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :    branch-&gt;SetAddress(&amp;array);</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :    Int_t count = branch-&gt;GetEntries();</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :    for (Int_t idx=0; idx&lt;count; ++idx) {</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :       array-&gt;Clear();</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :       branch-&gt;GetEntry(idx); // &quot;fill&quot; the array</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :       Int_t nkeep = array-&gt;GetEntriesFast();</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :       for (Int_t i=0; i&lt;nkeep; i++) {</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :          TParticle * part = (TParticle*)array-&gt;AddrAt(i);</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :          Int_t mum1 = part-&gt;GetFirstMother();</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :          Int_t mum2 = part-&gt;GetSecondMother();</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :          Int_t fd = part-&gt;GetFirstDaughter();</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :          Int_t ld = part-&gt;GetLastDaughter();</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :          if (mum1&gt;-1 &amp;&amp; i&lt;mum1) {</span>
<span class="lineNum">     101 </span>            :             valid = false;
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :             if (useStdErr) cerr &lt;&lt; &quot;Problem: first_mother(&quot; &lt;&lt; mum1 &lt;&lt; &quot;) after daughter(&quot; &lt;&lt; i &lt;&lt; &quot;)&quot; &lt;&lt; endl;</span>
<span class="lineNum">     103 </span>            :          }
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :          if (mum2&gt;-1 &amp;&amp; i&lt;mum2 &amp;&amp; requireSecondMotherBeforeDaughters) {</span>
<span class="lineNum">     105 </span>            :             valid = false;
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :             if (useStdErr) cerr &lt;&lt; &quot;Problem: second_mother(&quot; &lt;&lt; mum2 &lt;&lt; &quot;) after daughter(&quot; &lt;&lt; i &lt;&lt; &quot;)&quot; &lt;&lt; endl;</span>
<span class="lineNum">     107 </span>            :          }
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :          if (fd &gt; ld ) {</span>
<span class="lineNum">     109 </span>            :             valid = false;
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :             if (useStdErr) cerr &lt;&lt; &quot;Problem: first_daughter(&quot; &lt;&lt; fd &lt;&lt; &quot;) &gt; last_daughter(&quot; &lt;&lt; ld &lt;&lt; &quot;)&quot; &lt;&lt; endl;</span>
<span class="lineNum">     111 </span>            :          }
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :          for (Int_t id=TMath::Max(fd,0); id&lt;=ld; id++) {</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :             TParticle * daughter = (TParticle*)array-&gt;AddrAt(id);</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :             if (daughter-&gt;GetFirstMother() != i &amp;&amp; daughter-&gt;GetSecondMother() != i) {</span>
<span class="lineNum">     115 </span>            :                valid = false;
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :                if (useStdErr) cerr &lt;&lt; &quot;Problem: mother(&quot;&lt;&lt; i &lt;&lt; &quot;) not registered as mother for either first_daughter(&quot;</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :                      &lt;&lt; daughter-&gt;GetFirstMother() &lt;&lt; &quot;) or second_daughter(&quot;</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :                      &lt;&lt; daughter-&gt;GetSecondMother() &lt;&lt; &quot;)&quot; &lt;&lt; endl;</span>
<span class="lineNum">     119 </span>            :             }
<span class="lineNum">     120 </span>            :          }
<span class="lineNum">     121 </span>            :       }
<span class="lineNum">     122 </span>            :    }
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :    delete array;</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :    array = 0;</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :    return valid;</span>
<a name="126"><span class="lineNum">     126 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span>            : bool THepMCParser::IsValidParticleInvariantMass(bool useStdErr, bool includeStatusCode2Particles)
<span class="lineNum">     129 </span>            : {
<span class="lineNum">     130 </span>            :    bool valid = true;
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :    TClonesArray *array = new TClonesArray(&quot;TParticle&quot;);</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :    TBranch* branch = fTree-&gt;GetBranch(&quot;Particles&quot;);</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :    branch-&gt;SetAddress(&amp;array);</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :    Int_t count = branch-&gt;GetEntries();</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :    for (Int_t idx=0; idx&lt;count; ++idx) {</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :       array-&gt;Clear();</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :       branch-&gt;GetEntry(idx);</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :       Int_t nkeep = array-&gt;GetEntries();</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :       for (Int_t i=0; i&lt;nkeep; i++) {</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :          TParticle * parton = (TParticle*)array-&gt;AddrAt(i);</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :          if (parton-&gt;GetStatusCode()==2 &amp;&amp; !includeStatusCode2Particles) {</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     143 </span>            :          }
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :          TLorentzVector v;</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :          parton-&gt;Momentum(v);</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :          Double_t m1 = v.M(); // invariant mass from the particle in the HepMC event</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :          TParticlePDG *dbParton = parton-&gt;GetPDG();</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :          if (!dbParton) {</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :             if (useStdErr) cerr &lt;&lt; &quot;Warning: could not look up particle with PDG Code: &quot; &lt;&lt; parton-&gt;GetPdgCode() &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     151 </span>            :          }
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :          Double_t m2 = dbParton-&gt;Mass();</span>
<span class="lineNum">     153 </span>            :          bool checkok;
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :          if (m2 == 0) {</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :             checkok = abs(m1) &lt; 0.0001; // no such thing as negative mass...</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :          } else {</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :             checkok = abs(1 - m1/m2) &lt; 0.01;</span>
<span class="lineNum">     158 </span>            :          }
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :          if (!checkok &amp;&amp; useStdErr) {</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :             cerr &lt;&lt; &quot;Problem: &quot; &lt;&lt; GetParticleName(parton) &lt;&lt; &quot; HepMC:&quot; &lt;&lt; m1 &lt;&lt; endl;</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :             cerr &lt;&lt; ListReactionChain(array,i);</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :             cerr &lt;&lt; endl;</span>
<span class="lineNum">     163 </span>            :          }
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :          if (!checkok)</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :             valid = false;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     167 </span>            :    }
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :    delete array;</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :    array = 0;</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :    return valid;</span>
<a name="171"><span class="lineNum">     171 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            : bool THepMCParser::IsValidVertexInvariantMass(bool useStdErr, bool includeStatusCode2Particles)
<span class="lineNum">     174 </span>            : {
<span class="lineNum">     175 </span>            :    bool valid = true;
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :    TClonesArray * array = new TClonesArray(&quot;TParticle&quot;);</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :    TBranch* branch = fTree-&gt;GetBranch(&quot;Particles&quot;);</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :    branch-&gt;SetAddress(&amp;array);</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :    Int_t count = branch-&gt;GetEntries();</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :    for (Int_t idx=0; idx&lt;count; ++idx) {</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :       array-&gt;Clear();</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :       branch-&gt;GetEntry(idx); // &quot;fill&quot; the array</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :       TLorentzVector v_st1;</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :       TLorentzVector v_st4;</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :       Int_t nkeep = array-&gt;GetEntriesFast();</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :       for (Int_t i=0; i&lt;nkeep; i++) {</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :          TParticle * parton = (TParticle*)array-&gt;AddrAt(i);</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :          TLorentzVector v_in;</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :          parton-&gt;Momentum(v_in);</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :          if (parton-&gt;GetStatusCode()==4) {</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :             v_st4 += v_in;</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :          } else if (parton-&gt;GetStatusCode()==1) {</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :             v_st1 += v_in;</span>
<span class="lineNum">     194 </span>            :          }
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :          if (!includeStatusCode2Particles) { // only check beam particles vs final particles</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     197 </span>            :          }
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :          Int_t fd = parton-&gt;GetFirstDaughter();</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :          Int_t ld = parton-&gt;GetLastDaughter();</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :          if (fd == -1) continue; // no daughters, continue loop</span>
<span class="lineNum">     201 </span>            :          Int_t mother2 = -1;
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :          TLorentzVector v_out;</span>
<span class="lineNum">     203 </span>            :          bool oneok = false; bool allok = true; bool agreemother2 = true;
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :          ostringstream daughterpdg;</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :          ostringstream motherpdg;</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :          for (Int_t id=TMath::Max(fd,0); id&lt;=ld; id++) {</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :             TParticle * daughter = (TParticle*)array-&gt;AddrAt(id);</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :             if (fd==id) {</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                daughter-&gt;Momentum(v_out);</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :                mother2 = daughter-&gt;GetSecondMother();</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :             } else {</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                TLorentzVector d;</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                daughter-&gt;Momentum(d);</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :                v_out += d;</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :                if (daughter-&gt;GetSecondMother() != mother2) agreemother2 = false;</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :             if (daughter-&gt;GetFirstMother() == i) {</span>
<span class="lineNum">     218 </span>            :                oneok = true;
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :             } else {</span>
<span class="lineNum">     220 </span>            :                allok = false;
<span class="lineNum">     221 </span>            :             }
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :             daughterpdg &lt;&lt; &quot; &quot; &lt;&lt; daughter-&gt;GetPdgCode();</span>
<span class="lineNum">     223 </span>            :          }
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :          motherpdg &lt;&lt; &quot; &quot; &lt;&lt; parton-&gt;GetPdgCode();</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :          if (mother2 &gt; -1 &amp;&amp; agreemother2) {</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :             TParticle * m2 = (TParticle*)array-&gt;AddrAt(mother2);</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :             TLorentzVector m2v;</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :             m2-&gt;Momentum(m2v);</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :             v_in += m2v;</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :             motherpdg &lt;&lt; &quot; &quot; &lt;&lt; m2-&gt;GetPdgCode();</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :          if (oneok &amp;&amp; allok &amp;&amp; agreemother2) {</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :             bool checkok = abs(1 - v_in.M()/v_out.M()) &lt; 0.1;</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :             if (!checkok) valid=false;</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :             if (!checkok &amp;&amp; useStdErr) {</span>
<span class="lineNum">     236 </span>            :                //             cerr &lt;&lt; &quot;Problem: &quot; &lt;&lt; i &lt;&lt; &quot;[&quot; &lt;&lt; fd &lt;&lt; &quot;,&quot; &lt;&lt; ld &lt;&lt; &quot;] PDG:&quot; &lt;&lt; motherpdg.str() &lt;&lt; &quot; -&gt;&quot; &lt;&lt; daughterpdg.str() &lt;&lt; &quot;  Inv.mass: &quot; &lt;&lt; v_in.M() &lt;&lt; &quot; -&gt; &quot; &lt;&lt; v_out.M() &lt;&lt; endl;
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                cerr &lt;&lt; ListReactionChain(array,i);</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :                cerr &lt;&lt; endl;</span>
<span class="lineNum">     239 </span>            :                //             cerr &lt;&lt; v_in.Px() &lt;&lt; &quot; &quot; &lt;&lt; v_in.Py() &lt;&lt; &quot; &quot; &lt;&lt; v_in.Pz() &lt;&lt; &quot; &quot; &lt;&lt; v_in.E() &lt;&lt; endl;
<span class="lineNum">     240 </span>            :             } else if (useStdErr) {
<span class="lineNum">     241 </span>            :                //             cerr &lt;&lt; &quot;OK: &quot; &lt;&lt; i &lt;&lt; &quot;[&quot; &lt;&lt; fd &lt;&lt; &quot;,&quot; &lt;&lt; ld &lt;&lt; &quot;] PDG:&quot; &lt;&lt; motherpdg.str() &lt;&lt; &quot; -&gt;&quot; &lt;&lt; daughterpdg.str() &lt;&lt; &quot;  Inv.mass: &quot; &lt;&lt; v_in.M() &lt;&lt; &quot; -&gt; &quot; &lt;&lt; v_out.M() &lt;&lt; endl;
<span class="lineNum">     242 </span>            :             }
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :       bool checkok = abs(1 - v_st4.M()/v_st1.M()) &lt; 0.001;</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :       if (!checkok) valid=false;</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :       if (!checkok &amp;&amp; useStdErr) {</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :          cerr &lt;&lt; &quot; BEAM PARTICLES -&gt; FINAL PARTICLES &quot; &lt;&lt; endl;</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :          cerr &lt;&lt; &quot; status 4 (&quot; &lt;&lt; v_st4.M() &lt;&lt; &quot;) -&gt; status 1 (&quot; &lt;&lt; v_st1.M() &lt;&lt; &quot;)&quot; &lt;&lt; endl &lt;&lt; endl;</span>
<span class="lineNum">     250 </span>            :       }
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :    delete array;</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :    array = 0;</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :    return valid;</span>
<a name="255"><span class="lineNum">     255 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span>            : string THepMCParser::GetParticleName(TParticle * thisPart)
<span class="lineNum">     258 </span>            : {
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :    TParticlePDG *dbPart = thisPart-&gt;GetPDG();</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :    ostringstream name;</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :    if (dbPart) {</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :       name &lt;&lt; dbPart-&gt;GetName() &lt;&lt; &quot;(&quot; &lt;&lt; dbPart-&gt;PdgCode() &lt;&lt; &quot;,&quot; &lt;&lt; dbPart-&gt;Mass() &lt;&lt; &quot;)&quot;;</span>
<span class="lineNum">     263 </span>            :    } else {
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :       name &lt;&lt; thisPart-&gt;GetPdgCode() &lt;&lt; &quot;(NoDBinfo)&quot;;</span>
<span class="lineNum">     265 </span>            :    }
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :    return name.str();</span>
<a name="267"><span class="lineNum">     267 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span>            : string THepMCParser::ListReactionChain(TClonesArray * particles, Int_t particleId)
<span class="lineNum">     270 </span>            : {
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :    ostringstream output;</span>
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :    TParticle * part = (TParticle*)particles-&gt;AddrAt(particleId);</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :    Int_t m1id = part-&gt;GetFirstMother();</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :    Int_t m2id = part-&gt;GetSecondMother();</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :    if (m1id &gt; 1) { // ignore the initial collision with beam particles</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :       ostringstream inStr;</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :       ostringstream outStr;</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :       TParticle * m1 = (TParticle*)particles-&gt;AddrAt(m1id);</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :       TLorentzVector v_in;</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :       m1-&gt;Momentum(v_in);</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :       inStr &lt;&lt; GetParticleName(m1) &lt;&lt; &quot;[&quot; &lt;&lt; v_in.M() &lt;&lt; &quot;]&quot;;</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :       if (m2id &gt; 1) {</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :          TParticle * m2 = (TParticle*)particles-&gt;AddrAt(m2id);</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :          TLorentzVector v_m2;</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :          m2-&gt;Momentum(v_m2);</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :          v_in += v_m2;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :          inStr &lt;&lt; &quot; &quot; &lt;&lt; GetParticleName(m2) &lt;&lt; &quot;[&quot; &lt;&lt; v_m2.M() &lt;&lt; &quot;]&quot;;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :       Int_t fd = m1-&gt;GetFirstDaughter();</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :       Int_t ld = m1-&gt;GetLastDaughter();</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :       TLorentzVector v_out;</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :       part-&gt;Momentum(v_out);</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :       outStr &lt;&lt; GetParticleName(part) &lt;&lt; &quot;[&quot; &lt;&lt; v_out.M() &lt;&lt; &quot;]&quot;;</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :       for (Int_t i=fd; i&lt;=ld; ++i) {</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :          if (i!=particleId) {</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :             TParticle * d = (TParticle*)particles-&gt;AddrAt(i);</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :             TLorentzVector v_d;</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :             d-&gt;Momentum(v_d);</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :             v_out += v_d;</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :             outStr &lt;&lt; &quot; &quot; &lt;&lt; GetParticleName(d) &lt;&lt; &quot;[&quot; &lt;&lt; v_d.M() &lt;&lt; &quot;]&quot;;</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">     303 </span>            :       }
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :       output &lt;&lt; &quot;Parent reaction, inv mass: &quot; &lt;&lt; v_in.M() &lt;&lt; &quot; -&gt; &quot; &lt;&lt; v_out.M() &lt;&lt; endl;</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :       output &lt;&lt; &quot; - partons: &quot; &lt;&lt; inStr.str() &lt;&lt; &quot; -&gt; &quot; &lt;&lt; outStr.str() &lt;&lt; endl;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :    Int_t fd = part-&gt;GetFirstDaughter();</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :    Int_t ld = part-&gt;GetLastDaughter();</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :    if (fd &gt; -1) {</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :       ostringstream inStr;</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :       ostringstream outStr;</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :       TLorentzVector v_in;</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :       part-&gt;Momentum(v_in);</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :       inStr &lt;&lt; GetParticleName(part) &lt;&lt; &quot;[&quot; &lt;&lt; v_in.M() &lt;&lt; &quot;]&quot;;</span>
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :       TParticle * f = (TParticle*)particles-&gt;AddrAt(fd);</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :       m2id = f-&gt;GetSecondMother();</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :       if (m2id == particleId) {</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :          m2id = f-&gt;GetFirstMother();</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :       if (m2id &gt; -1) {</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :          TParticle * m2 = (TParticle*)particles-&gt;AddrAt(m2id);</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :          TLorentzVector v_m2;</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :          m2-&gt;Momentum(v_m2);</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :          v_in += v_m2;</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :          inStr &lt;&lt; &quot; &quot; &lt;&lt; GetParticleName(m2) &lt;&lt; &quot;[&quot; &lt;&lt; v_m2.M() &lt;&lt; &quot;]&quot;;</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :       TLorentzVector v_out;</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       f-&gt;Momentum(v_out);</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :       outStr &lt;&lt; GetParticleName(f) &lt;&lt; &quot;[&quot; &lt;&lt; v_out.M() &lt;&lt; &quot;]&quot;;</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :       for (Int_t i=fd+1; i&lt;=ld; ++i) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :          TParticle * d = (TParticle*)particles-&gt;AddrAt(i);</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :          TLorentzVector v_d;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :          d-&gt;Momentum(v_d);</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :          v_out += v_d;</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :          outStr &lt;&lt; &quot; &quot; &lt;&lt; GetParticleName(d) &lt;&lt; &quot;[&quot; &lt;&lt; v_d.M() &lt;&lt; &quot;]&quot;;</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :       output &lt;&lt; &quot;Child reaction, inv mass: &quot; &lt;&lt; v_in.M() &lt;&lt; &quot; -&gt; &quot; &lt;&lt; v_out.M() &lt;&lt; endl;</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :       output &lt;&lt; &quot; - partons: &quot; &lt;&lt; inStr.str() &lt;&lt; &quot; -&gt; &quot; &lt;&lt; outStr.str() &lt;&lt; endl;</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :    } else {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       output &lt;&lt; &quot;Child reaction&quot; &lt;&lt; endl &lt;&lt; &quot; - none&quot; &lt;&lt; endl;</span>
<span class="lineNum">     342 </span>            :    }
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :    return output.str();</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 : }</span>
<a name="346"><span class="lineNum">     346 </span>            : </a>
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span>            : string THepMCParser::ParseGenEvent2TCloneArray(HepMC::GenEvent * genEvent, TClonesArray * array, string momUnit, string lenUnit, bool requireSecondMotherBeforeDaughters)
<span class="lineNum">     349 </span>            : {
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :    ostringstream errMsgStream;</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :    if (requireSecondMotherBeforeDaughters) {</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :       errMsgStream &lt;&lt;  &quot; WARNING: requireSecondMotherBeforeDaughters not fully implemented yet!\n&quot;;</span>
<span class="lineNum">     353 </span>            :    }
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :    genEvent-&gt;use_units(momUnit, lenUnit);</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :    array-&gt;Clear();</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :    map&lt;int,Int_t&gt; partonMemory; // unordered_map in c++11 - but probably not much performance gain from that: log(n) vs log(1) where constant can be high</span>
<span class="lineNum">     357 </span>            :    Bool_t beamParticlesToTheSameVertex = kTRUE; // This is false if the beam particles do not end up in the same vertex. This happens for some HepMC files produced by agile-runmc
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span>            :    
<span class="lineNum">     360 </span>            :    // Check event with HepMC's internal validation algorithm
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :    if (!genEvent-&gt;is_valid()) {</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :       errMsgStream &lt;&lt; &quot;Error with event id: &quot; &lt;&lt; genEvent-&gt;event_number() &lt;&lt; &quot;, event is not valid!\n&quot;;</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :       return errMsgStream.str();</span>
<span class="lineNum">     364 </span>            :    }
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span>            :    // Pull out the beam particles from the event
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :    const pair&lt;HepMC::GenParticle *,HepMC::GenParticle *&gt; beamparts = genEvent-&gt;beam_particles();</span>
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span>            :    // Four sanity checks:
<span class="lineNum">     370 </span>            :    // - Beam particles exists and are not the same
<span class="lineNum">     371 </span>            :    // - Both beam particles should have no production vertices, they come from the beams
<span class="lineNum">     372 </span>            :    // - Both beam particles should have defined end vertices, as they both should contribute
<span class="lineNum">     373 </span>            :    // - Both beam particles should have the exact same end vertex
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :    if (!beamparts.first || !beamparts.second || beamparts.first-&gt;barcode()==beamparts.second-&gt;barcode()) {</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :       errMsgStream &lt;&lt; &quot;Error with event id: &quot; &lt;&lt; genEvent-&gt;event_number() &lt;&lt; &quot;, beam particles doesn't exists or are the same\n&quot;;</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :       return errMsgStream.str();</span>
<span class="lineNum">     377 </span>            :    }
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :    if (beamparts.first-&gt;production_vertex() || beamparts.second-&gt;production_vertex()) {</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :       errMsgStream &lt;&lt; &quot;Error with event id: &quot; &lt;&lt; genEvent-&gt;event_number() &lt;&lt; &quot;, beam particles have production vertex/vertices...\n&quot;;</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :       return errMsgStream.str();</span>
<span class="lineNum">     381 </span>            :    }
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :    if (!beamparts.first-&gt;end_vertex() || !beamparts.second-&gt;end_vertex()) {</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :       errMsgStream &lt;&lt; &quot;Error with event id: &quot; &lt;&lt; genEvent-&gt;event_number() &lt;&lt; &quot;, beam particles have undefined end vertex/vertices...\n&quot;;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :       return errMsgStream.str();</span>
<span class="lineNum">     385 </span>            :    }
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :    if (beamparts.first-&gt;end_vertex() != beamparts.second-&gt;end_vertex()) {</span>
<span class="lineNum">     387 </span>            :      
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :       errMsgStream &lt;&lt; &quot;Warning with event id: &quot; &lt;&lt; genEvent-&gt;event_number() &lt;&lt; &quot;, beam particles do not collide in the same end vertex.\n&quot;;// This was downgraded to a warning, because I noticed in Pythia 6 HepMC (generated via agile-runmc) files the barcode of the vertex was different, but the 4-vector of the vertices was the same.</span>
<span class="lineNum">     389 </span>            :       beamParticlesToTheSameVertex = kFALSE;
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :       if (beamparts.first-&gt;end_vertex()-&gt;position() != beamparts.second-&gt;end_vertex()-&gt;position()){</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :         errMsgStream &lt;&lt; &quot;Error with event id: &quot; &lt;&lt; genEvent-&gt;event_number() &lt;&lt; &quot;, beam particles do not collide in the same end vertex and the two vertices have different four vectors.\n&quot;; </span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :         return errMsgStream.str();</span>
<span class="lineNum">     393 </span>            :       }
<span class="lineNum">     394 </span>            :    }
<span class="lineNum">     395 </span>            : 
<span class="lineNum">     396 </span>            :    // Set the array to hold the number of particles in the event
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :    Int_t nParticlesInHepMC = genEvent-&gt;particles_size(); // FIXME</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :    array-&gt;Expand(genEvent-&gt;particles_size());</span>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            :    // Create a TParticle for each beam particle
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :    new((*array)[0]) TParticle(</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :          beamparts.first-&gt;pdg_id(),</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :          beamparts.first-&gt;status(), // check if status has the same meaning</span>
<span class="lineNum">     404 </span>            :          -1, // no mother1
<span class="lineNum">     405 </span>            :          -1, // no mother2
<span class="lineNum">     406 </span>            :          -1, // first daughter not known yet
<span class="lineNum">     407 </span>            :          -1, // last daughter not known yet
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :          beamparts.first-&gt;momentum().px(),</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :          beamparts.first-&gt;momentum().py(),</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :          beamparts.first-&gt;momentum().pz(),</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :          beamparts.first-&gt;momentum().e(),</span>
<span class="lineNum">     412 </span>            :          0, // no production vertex, so zero?
<span class="lineNum">     413 </span>            :          0,
<span class="lineNum">     414 </span>            :          0,
<span class="lineNum">     415 </span>            :          0
<span class="lineNum">     416 </span>            :    );
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :    partonMemory[beamparts.first-&gt;barcode()] = 0;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :    new((*array)[1]) TParticle(</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :          beamparts.second-&gt;pdg_id(),</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :          beamparts.second-&gt;status(),</span>
<span class="lineNum">     421 </span>            :          -1, // no mother1
<span class="lineNum">     422 </span>            :          -1, // no mother2
<span class="lineNum">     423 </span>            :          -1, // first daughter not known yet
<span class="lineNum">     424 </span>            :          -1, // last daughter not known yet
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :          beamparts.second-&gt;momentum().px(),</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :          beamparts.second-&gt;momentum().py(),</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :          beamparts.second-&gt;momentum().pz(),</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :          beamparts.second-&gt;momentum().e(),</span>
<span class="lineNum">     429 </span>            :          0, // no production vertex, so zero?
<span class="lineNum">     430 </span>            :          0,
<span class="lineNum">     431 </span>            :          0,
<span class="lineNum">     432 </span>            :          0
<span class="lineNum">     433 </span>            :    );
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :    partonMemory[beamparts.second-&gt;barcode()] = 1;</span>
<span class="lineNum">     435 </span>            :    
<span class="lineNum">     436 </span>            :    Int_t arrayID = 2; // start counting IDs after the beam particles
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span>            :    // If the beam particles end
<span class="lineNum">     439 </span>            :    // in the same vertex, this has to be done only once, otherwise, it
<span class="lineNum">     440 </span>            :    // has to be done twice (else we lose the &quot;second beam part&quot;
<span class="lineNum">     441 </span>            :    // branch)
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :    for (Int_t ibeamPart =0 ; ibeamPart &lt; 2; ibeamPart++) {</span>
<span class="lineNum">     444 </span>            :      //     std::cout &lt;&lt; &quot;1&quot; &lt;&lt; std::endl;
<span class="lineNum">     445 </span>            :      
<span class="lineNum">     446 </span>            :      HepMC::GenVertex * startVertex = 0;
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :      if (ibeamPart == 0) startVertex = beamparts.first  -&gt;end_vertex();</span>
<span class="lineNum">     448 </span>            :      else                {
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :        startVertex = beamparts.second -&gt;end_vertex();</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :        if (beamParticlesToTheSameVertex) break; // both beam particles end to the same vertex: no need to do this twice.</span>
<span class="lineNum">     451 </span>            :      }
<span class="lineNum">     452 </span>            :      //     std::cout &lt;&lt; &quot;2&quot; &lt;&lt; std::endl;
<span class="lineNum">     453 </span>            :      
<span class="lineNum">     454 </span>            :      // Do first vertex as a special case for performance, since its often has the most daughters and both mothers are known
<span class="lineNum">     455 </span>            :      Int_t firstDaughter = arrayID;
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :      for (HepMC::GenVertex::particles_out_const_iterator iter = startVertex-&gt;particles_out_const_begin();</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :           iter != startVertex-&gt;particles_out_const_end();</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :           ++iter) {</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :        new((*array)[arrayID]) TParticle(</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :                                         (*iter)-&gt;pdg_id(),</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :                                         (*iter)-&gt;status(),</span>
<span class="lineNum">     462 </span>            :                                         0, // beam particle 1
<span class="lineNum">     463 </span>            :                                         1, // beam particle 2
<span class="lineNum">     464 </span>            :                                         -1, // first daughter not known yet
<span class="lineNum">     465 </span>            :                                         -1, // last daughter not known yet
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                                         (*iter)-&gt;momentum().px(),</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                                         (*iter)-&gt;momentum().py(),</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :                                         (*iter)-&gt;momentum().pz(),</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :                                         (*iter)-&gt;momentum().e(),</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :                                         beamparts.first-&gt;end_vertex()-&gt;position().x(),</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :                                         beamparts.first-&gt;end_vertex()-&gt;position().y(),</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :                                         beamparts.first-&gt;end_vertex()-&gt;position().z(),</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :                                         beamparts.first-&gt;end_vertex()-&gt;position().t()</span>
<span class="lineNum">     474 </span>            :                                         );
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :        partonMemory[(*iter)-&gt;barcode()] = arrayID;</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :        ++arrayID;</span>
<span class="lineNum">     477 </span>            :      }
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :      Int_t lastDaughter = arrayID-1;</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :      if (ibeamPart == 0){</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :        ((TParticle*)array-&gt;AddrAt(0))-&gt;SetFirstDaughter(firstDaughter); // beam particle 1</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :        ((TParticle*)array-&gt;AddrAt(0))-&gt;SetLastDaughter(lastDaughter);</span>
<span class="lineNum">     482 </span>            :        // If both beam particles end in the same vertex, we have to reference the daughters of the second beam particle here (this loop is only done once). Otherwise, we do it when ibeamPart is == 1
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :        if(beamParticlesToTheSameVertex) {</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :          ((TParticle*)array-&gt;AddrAt(1))-&gt;SetFirstDaughter(firstDaughter); // beam particle 2</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :          ((TParticle*)array-&gt;AddrAt(1))-&gt;SetLastDaughter(lastDaughter);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :        }</span>
<span class="lineNum">     487 </span>            :      } else {
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :        ((TParticle*)array-&gt;AddrAt(1))-&gt;SetFirstDaughter(firstDaughter); // beam particle 2</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :        ((TParticle*)array-&gt;AddrAt(1))-&gt;SetLastDaughter(lastDaughter);</span>
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span>            :      }
<span class="lineNum">     492 </span>            :      
<span class="lineNum">     493 </span>            :      // Then we loop over all other vertices. 
<span class="lineNum">     494 </span>            :      // Build vertex list by exploring tree and sorting such that
<span class="lineNum">     495 </span>            :      // daughters comes after mothers
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :      list&lt;HepMC::GenVertex*&gt; vertexList;</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :      set&lt;int&gt; vertexSearchSet;</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :      ExploreVertex(startVertex,vertexList,vertexSearchSet,requireSecondMotherBeforeDaughters);</span>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span>            :      // Analyze each vertex
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :      for (list&lt;HepMC::GenVertex*&gt;::iterator i = vertexList.begin(); i != vertexList.end(); ++i) {</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :        HepMC::GenVertex * vertex = (*i);</span>
<span class="lineNum">     503 </span>            :        //       std::cout &lt;&lt; &quot;Vertex: &quot; &lt;&lt; vertex-&gt;barcode() &lt;&lt; std::endl;
<span class="lineNum">     504 </span>            :        
<span class="lineNum">     505 </span>            :        //      std::cout &lt;&lt; &quot;Processing vertex: &quot; &lt;&lt; vertex-&gt;barcode() &lt;&lt; std::endl;
<span class="lineNum">     506 </span>            :       
<span class="lineNum">     507 </span>            :        // first establish mother-daughter relations (look at particles incoming in the vertex)
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :        HepMC::GenVertex::particles_in_const_iterator iterInParticles = vertex-&gt;particles_in_const_begin();</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :        if (iterInParticles == vertex-&gt;particles_in_const_end()) {</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :          return &quot;Particle without a mother, and its not a beam particle!\n&quot;;</span>
<span class="lineNum">     511 </span>            :        }
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :        int motherA = partonMemory[(*iterInParticles)-&gt;barcode()];</span>
<span class="lineNum">     513 </span>            :        //      std::cout &lt;&lt; &quot;MotherA: &quot;  &lt;&lt; (*iterInParticles)-&gt;barcode() &lt;&lt; &quot;, &quot; &lt;&lt; motherA &lt;&lt; std::endl;
<span class="lineNum">     514 </span>            :       
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :        if (((TParticle*)array-&gt;AddrAt(motherA))-&gt;GetFirstDaughter() &gt; -1 &amp;&amp; motherA &gt; 1) { // FIXME Temp hack: if motherA &lt;2 it means it was not in the array (0 is the beam particle)</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :          errMsgStream &lt;&lt; Form(&quot;Trying to assign new daughters to a particle that already has daughters defined! (motherA, barcode = %d, event = %d)\n&quot;,(*iterInParticles)-&gt;barcode(), genEvent-&gt;event_number());</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :          return errMsgStream.str();</span>
<span class="lineNum">     518 </span>            :          ((TParticle*)array-&gt;AddrAt(motherA))-&gt;Print();
<span class="lineNum">     519 </span>            :        }
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :        ++iterInParticles;</span>
<span class="lineNum">     521 </span>            :        int motherB = -1;
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :        if (iterInParticles != vertex-&gt;particles_in_const_end()) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :          motherB = partonMemory[(*iterInParticles)-&gt;barcode()];</span>
<span class="lineNum">     524 </span>            :          //         std::cout &lt;&lt; &quot;MotherB: &quot;  &lt;&lt; (*iterInParticles)-&gt;barcode() &lt;&lt; std::endl;
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :          if (((TParticle*)array-&gt;AddrAt(motherB))-&gt;GetFirstDaughter() &gt; -1 &amp;&amp; motherB &gt; 1) { // FIXME Temp hack: if motherB &lt; 2 it means it was not in the array (0 is the beam particle)</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :            errMsgStream &lt;&lt; Form(&quot;Trying to assign new daughters to a particle that already has daughters defined! (motherB, barcode = %d, event = %d)\n&quot;,(*iterInParticles)-&gt;barcode(), genEvent-&gt;event_number());</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :            return errMsgStream.str();</span>
<span class="lineNum">     528 </span>            :          }
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :          ++iterInParticles;</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :          if (iterInParticles != vertex-&gt;particles_in_const_end() &amp;&amp; (*iterInParticles)-&gt;pdg_id() != 93) { // If it's a string it could have many partons attached.. In that case, we ignore mother-daughter relationships</span>
<span class="lineNum">     531 </span>            :            //           std::cout &lt;&lt; &quot;Daughters&quot; &lt;&lt; std::endl;
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :            errMsgStream &lt;&lt; Form (&quot;Particle with more than two mothers! (Vertex Barcode: %d, PDG: %d)\n&quot;, (*iterInParticles)-&gt;barcode(), (*iterInParticles)-&gt;pdg_id()) ;</span>
<span class="lineNum">     533 </span>            :            //           return Form (&quot;Particle with more than two mothers! (Vertex Barcode: %d, PDG: %d)&quot;, (*iterInParticles)-&gt;barcode(), (*iterInParticles)-&gt;pdg_id()) ;
<span class="lineNum">     534 </span>            :             
<span class="lineNum">     535 </span>            :          }
<span class="lineNum">     536 </span>            :        }
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :        if (motherB &gt; -1 &amp;&amp; motherB &lt; motherA) {</span>
<span class="lineNum">     538 </span>            :          int swap = motherA; motherA = motherB; motherB = swap;
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :        }</span>
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span>            :        // add the particles to the array, important that they are add in succession with respect to arrayID
<span class="lineNum">     542 </span>            :        
<span class="lineNum">     543 </span>            :        firstDaughter = arrayID;
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :        for (HepMC::GenVertex::particles_in_const_iterator iterOutParticles = vertex-&gt;particles_out_const_begin();</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :             iterOutParticles != vertex-&gt;particles_out_const_end();</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :             ++iterOutParticles) {</span>
<span class="lineNum">     547 </span>            :          //        std::cout &lt;&lt; &quot;Adding daughter: &quot; &lt;&lt; (*iterOutParticles)-&gt;barcode() &lt;&lt; std::endl;
<span class="lineNum">     548 </span>            :         
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :          new((*array)[arrayID]) TParticle(</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :                                           (*iterOutParticles)-&gt;pdg_id(),</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :                                           (*iterOutParticles)-&gt;status(),</span>
<span class="lineNum">     552 </span>            :                                           motherA, // mother 1
<span class="lineNum">     553 </span>            :                                           motherB, // mother 2
<span class="lineNum">     554 </span>            :                                           -1, // first daughter, if applicable, not known yet
<span class="lineNum">     555 </span>            :                                           -1, // last daughter, if applicable, not known yet
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                                           (*iterOutParticles)-&gt;momentum().px(),</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :                                           (*iterOutParticles)-&gt;momentum().py(),</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :                                           (*iterOutParticles)-&gt;momentum().pz(),</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :                                           (*iterOutParticles)-&gt;momentum().e(),</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :                                           vertex-&gt;position().x(),</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :                                           vertex-&gt;position().y(),</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :                                           vertex-&gt;position().z(),</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :                                           vertex-&gt;position().t()</span>
<span class="lineNum">     564 </span>            :                                           );
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :          partonMemory[(*iterOutParticles)-&gt;barcode()] = arrayID;</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :          ++arrayID;</span>
<span class="lineNum">     567 </span>            :        }
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :        lastDaughter = arrayID-1;</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :        if (lastDaughter &lt; firstDaughter) {</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :          return &quot;Vertex with no out particles, should not be possible!&quot;;</span>
<span class="lineNum">     571 </span>            :        }
<span class="lineNum">     572 </span>            :        // update mother with daughter interval
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :        ((TParticle*)array-&gt;AddrAt(motherA))-&gt;SetFirstDaughter(firstDaughter);</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :        ((TParticle*)array-&gt;AddrAt(motherA))-&gt;SetLastDaughter(lastDaughter);</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :        if (motherB &gt; -1) {</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :          ((TParticle*)array-&gt;AddrAt(motherB))-&gt;SetFirstDaughter(firstDaughter);</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :          ((TParticle*)array-&gt;AddrAt(motherB))-&gt;SetLastDaughter(lastDaughter);</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :        }</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :      }</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span>            :    // Printf(&quot;Particles in event: %d, added: %d, entries: %d/%d&quot;, nParticlesInHepMC, arrayID, array-&gt;GetEntries(), array-&gt;GetEntriesFast());
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :    std::cout &lt;&lt; errMsgStream.str() &lt;&lt; std::endl;</span>
<span class="lineNum">     584 </span>            :    
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :    return &quot;&quot;;</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 : }</span>
<a name="587"><span class="lineNum">     587 </span>            : </a>
<span class="lineNum">     588 </span>            : 
<span class="lineNum">     589 </span>            : void THepMCParser::ExploreVertex(HepMC::GenVertex * vertex, list&lt;HepMC::GenVertex*&gt; &amp; vertexList, set&lt;int&gt; &amp; vertexSearchSet, bool requireSecondMotherBeforeDaughters)
<span class="lineNum">     590 </span>            : {
<span class="lineNum">     591 </span>            :    // Prepare vertex list, and sort vertices so that mothers come before daughters (if required)
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span>            :    // Loop over all particles exiting from our start vertex 
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :    for (HepMC::GenVertex::particles_out_const_iterator partOut = vertex-&gt;particles_out_const_begin();</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :          partOut != vertex-&gt;particles_out_const_end();</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :          ++partOut) {</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :       HepMC::GenVertex * testVertex = (*partOut)-&gt;end_vertex();</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :       if (testVertex) {</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :          bool foundVertex = vertexSearchSet.find((*partOut)-&gt;end_vertex()-&gt;barcode()) != vertexSearchSet.end(); // If this is true, the vertex was already found</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :          if (requireSecondMotherBeforeDaughters) {</span>
<span class="lineNum">     601 </span>            :             // redo this algorithem to move subtree instead of node....
<span class="lineNum">     602 </span>            :             // its not completely error proof in its current implementation even though the error is extremely rare
<span class="lineNum">     603 </span>            : 
<span class="lineNum">     604 </span>            :             // Loop over all already found vertices if the vertex was already found, and remove the previous instance
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :             if (foundVertex) for (list&lt;HepMC::GenVertex*&gt;::iterator ivert = vertexList.begin(); ivert != vertexList.end(); ++ivert) {</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :                if ((*ivert)-&gt;barcode() == testVertex-&gt;barcode()) {</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :                   vertexList.erase(ivert);</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :                   cout &lt;&lt; &quot; it happened, the vertex parsing order had to be changed &quot; &lt;&lt; endl;</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :                   break;</span>
<span class="lineNum">     610 </span>            :                }
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :             } else {</span>
<span class="lineNum">     612 </span>            :               //otherwise, just add it to the list
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :                vertexSearchSet.insert((*partOut)-&gt;end_vertex()-&gt;barcode());</span>
<span class="lineNum">     614 </span>            :             }
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :             vertexList.push_back(testVertex);</span>
<span class="lineNum">     616 </span>            :             // Follow daughter recursively
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :             if (!foundVertex) ExploreVertex(testVertex,vertexList,vertexSearchSet,requireSecondMotherBeforeDaughters);</span>
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span>            :          } else {
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :             if (!foundVertex) {</span>
<span class="lineNum">     621 </span>            :               // If we don't care about having all mothers first, we just add it to list and set if not already found
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :                vertexSearchSet.insert((*partOut)-&gt;end_vertex()-&gt;barcode());</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :                vertexList.push_back(testVertex);</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :                ExploreVertex(testVertex,vertexList,vertexSearchSet,requireSecondMotherBeforeDaughters);</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     626 </span>            :          }
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span>            : 
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span>            : const char * THepMCParser::fgHeavyIonHeaderBranchString = &quot;Ncoll_hard/I:Npart_proj:Npart_targ:Ncoll:spectator_neutrons:spectator_protons:N_Nwounded_collisions:Nwounded_N_collisions:Nwounded_Nwounded_collisions:impact_parameter/F:event_plane_angle:eccentricity:sigma_inel_NN&quot;;
<a name="634"><span class="lineNum">     634 </span>            : const char * THepMCParser::fgPdfHeaderBranchString = &quot;id1/I:id2:pdf_id1:pdf_id2:x1/D:x2:scalePDF:pdf1:pdf2&quot;;</a>
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span>            : string THepMCParser::ParseGenEvent2HeaderStructs(HepMC::GenEvent * genEvent, HeavyIonHeader_t &amp; heavyIonHeader, PdfHeader_t &amp; pdfHeader, bool fillZeroOnMissingHeavyIon, bool fillZeroOnMissingPdf)
<span class="lineNum">     637 </span>            : {
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :    HepMC::HeavyIon * heavyIon = genEvent-&gt;heavy_ion();</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :    HepMC::PdfInfo * pdfInfo = genEvent-&gt;pdf_info();</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :    if ((!heavyIon &amp;&amp; !fillZeroOnMissingHeavyIon) || (!pdfInfo &amp;&amp; !fillZeroOnMissingPdf)) {</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :       return &quot;HeavyIonInfo and/or PdfInfo not defined for this event, did you read it with IO_GenEvent?&quot;;</span>
<span class="lineNum">     642 </span>            :    }
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :    if (heavyIon) {</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :       heavyIonHeader.Ncoll_hard = heavyIon-&gt;Ncoll_hard();</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :       heavyIonHeader.Npart_proj = heavyIon-&gt;Npart_proj();</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :       heavyIonHeader.Npart_targ = heavyIon-&gt;Npart_targ();</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :       heavyIonHeader.Ncoll = heavyIon-&gt;Ncoll();</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :       heavyIonHeader.spectator_neutrons = heavyIon-&gt;spectator_neutrons();</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :       heavyIonHeader.spectator_protons = heavyIon-&gt;spectator_protons();</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :       heavyIonHeader.N_Nwounded_collisions = heavyIon-&gt;N_Nwounded_collisions();</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :       heavyIonHeader.Nwounded_N_collisions = heavyIon-&gt;Nwounded_N_collisions();</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :       heavyIonHeader.Nwounded_Nwounded_collisions = heavyIon-&gt;Nwounded_Nwounded_collisions();</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :       heavyIonHeader.impact_parameter = heavyIon-&gt;impact_parameter();</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :       heavyIonHeader.event_plane_angle = heavyIon-&gt;event_plane_angle();</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :       heavyIonHeader.eccentricity = heavyIon-&gt;eccentricity();</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :       heavyIonHeader.sigma_inel_NN = heavyIon-&gt;sigma_inel_NN();</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :    } else {</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :       heavyIonHeader.Ncoll_hard = 0;</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :       heavyIonHeader.Npart_proj = 0;</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :       heavyIonHeader.Npart_targ = 0;</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :       heavyIonHeader.Ncoll = 0;</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :       heavyIonHeader.spectator_neutrons = 0;</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :       heavyIonHeader.spectator_protons = 0;</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :       heavyIonHeader.N_Nwounded_collisions = 0;</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :       heavyIonHeader.Nwounded_N_collisions = 0;</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :       heavyIonHeader.Nwounded_Nwounded_collisions = 0;</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :       heavyIonHeader.impact_parameter = 0.0;</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :       heavyIonHeader.event_plane_angle = 0.0;</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :       heavyIonHeader.eccentricity = 0.0;</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :       heavyIonHeader.sigma_inel_NN = 0.0;</span>
<span class="lineNum">     671 </span>            :    }
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :    if (pdfInfo) {</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :       pdfHeader.id1 = pdfInfo-&gt;id1();</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :       pdfHeader.id2 = pdfInfo-&gt;id2();</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :       pdfHeader.pdf_id1 = pdfInfo-&gt;pdf_id1();</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :       pdfHeader.pdf_id2 = pdfInfo-&gt;pdf_id2();</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :       pdfHeader.x1 = pdfInfo-&gt;x1();</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :       pdfHeader.x2 = pdfInfo-&gt;x2();</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :       pdfHeader.scalePDF = pdfInfo-&gt;scalePDF();</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :       pdfHeader.pdf1 = pdfInfo-&gt;pdf1();</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :       pdfHeader.pdf2 = pdfInfo-&gt;pdf2();</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :    } else {</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :       pdfHeader.id1 = 0;</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :       pdfHeader.id2 = 0;</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :       pdfHeader.pdf_id1 = 0;</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :       pdfHeader.pdf_id2 = 0;</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :       pdfHeader.x1 = 0.0;</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :       pdfHeader.x2 = 0.0;</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :       pdfHeader.scalePDF = 0.0;</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :       pdfHeader.pdf1 = 0.0;</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :       pdfHeader.pdf2 = 0.0;</span>
<span class="lineNum">     692 </span>            :    }
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :    return &quot;&quot;;</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     695 </span>            : 
<span class="lineNum">     696 </span>            : 
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span>            : 
<span class="lineNum">     701 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
