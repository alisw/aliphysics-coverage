<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - HMPID/HMPIDbase/AliHMPIDPreprocessor.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">HMPID/HMPIDbase</a> - AliHMPIDPreprocessor.cxx<span style="font-size: 80%;"> (source / <a href="AliHMPIDPreprocessor.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">247</td>
            <td class="headerCovTableEntryLo">0.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">8</td>
            <td class="headerCovTableEntryLo">12.5 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : #include &quot;AliHMPIDPreprocessor.h&quot; //header no includes</a>
<span class="lineNum">       2 </span>            : #include &quot;AliHMPIDDigit.h&quot;        //ProcPed()
<span class="lineNum">       3 </span>            : #include &quot;AliHMPIDRawStream.h&quot;    //ProcPed()
<span class="lineNum">       4 </span>            : #include &lt;Riostream.h&gt;            //ProcPed()  
<span class="lineNum">       5 </span>            : #include &lt;AliLog.h&gt;               //all
<span class="lineNum">       6 </span>            : #include &lt;AliCDBMetaData.h&gt;       //ProcPed(), ProcDcs()
<span class="lineNum">       7 </span>            : #include &lt;AliDCSValue.h&gt;          //ProcDcs()
<span class="lineNum">       8 </span>            : #include &lt;TObjString.h&gt;           //ProcDcs(), ProcPed()
<span class="lineNum">       9 </span>            : #include &lt;TTimeStamp.h&gt;           //Initialize()
<span class="lineNum">      10 </span>            : #include &lt;TF1.h&gt;                  //Process()
<span class="lineNum">      11 </span>            : #include &lt;TF2.h&gt;                  //Process()
<span class="lineNum">      12 </span>            : #include &lt;TString.h&gt;
<span class="lineNum">      13 </span>            : #include &lt;TGraph.h&gt;               //Process()
<span class="lineNum">      14 </span>            : #include &lt;TMatrix.h&gt;              //ProcPed()
<span class="lineNum">      15 </span>            : #include &lt;TList.h&gt;                //ProcPed()
<span class="lineNum">      16 </span>            : #include &lt;TSystem.h&gt;              //ProcPed()
<span class="lineNum">      17 </span>            : //.
<span class="lineNum">      18 </span>            : // HMPID Preprocessor base class
<span class="lineNum">      19 </span>            : //.
<span class="lineNum">      20 </span>            : //.
<span class="lineNum">      21 </span>            : //.
<span class="lineNum">      22 </span>            : using std::hex;
<a name="23"><span class="lineNum">      23 </span>            : using std::ifstream;</a>
<span class="lineNum">      24 </span>            : using std::dec;
<span class="lineNum">      25 </span><span class="lineCov">         16 : ClassImp(AliHMPIDPreprocessor)</span>
<a name="26"><span class="lineNum">      26 </span>            : </a>
<span class="lineNum">      27 </span>            : //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
<span class="lineNum">      28 </span>            : void AliHMPIDPreprocessor::Initialize(Int_t run, UInt_t startTime,UInt_t endTime)
<span class="lineNum">      29 </span>            : {
<span class="lineNum">      30 </span>            : // Initialize the parameter coming from AliPreprocessor
<span class="lineNum">      31 </span>            : //  run -&gt; run number
<span class="lineNum">      32 </span>            : // startTime -&gt; starting time 
<span class="lineNum">      33 </span>            : // endTime   -&gt; ending time
<span class="lineNum">      34 </span><span class="lineNoCov">          0 :   AliPreprocessor::Initialize(run, startTime, endTime);</span>
<span class="lineNum">      35 </span>            :   
<span class="lineNum">      36 </span><span class="lineNoCov">          0 :   AliInfo(Form(&quot;HMPID started for Run %d \n\tStartTime %s \n\t  EndTime %s&quot;, run,TTimeStamp(startTime).AsString(),TTimeStamp(endTime).AsString()));</span>
<span class="lineNum">      37 </span>            : 
<a name="38"><span class="lineNum">      38 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      39 </span>            : //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
<span class="lineNum">      40 </span>            : UInt_t AliHMPIDPreprocessor::Process(TMap* pMap)
<span class="lineNum">      41 </span>            : {
<span class="lineNum">      42 </span>            : // Process all information from DCS and DAQ
<span class="lineNum">      43 </span>            : // Arguments: pMap- map of DCS aliases
<span class="lineNum">      44 </span>            : // Returns: 0 on success or 1 on error (opposite to Store!)
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span><span class="lineNoCov">          0 :   TString runType = GetRunType();</span>
<span class="lineNum">      47 </span><span class="lineNoCov">          0 :   Log(Form(&quot; AliHMPIDPreprocessor: RunType is %s&quot;,runType.Data()));</span>
<span class="lineNum">      48 </span>            :   Bool_t statusNoise=kFALSE, statusDcs=kFALSE;
<span class="lineNum">      49 </span>            : // start to check event type and procedures
<span class="lineNum">      50 </span>            :   
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :   Log(&quot;HMPID - Process in Preprocessor started&quot;);</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   if(! pMap) {</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :     Log(&quot;HMPID - ERROR - Not map of DCS aliases for HMPID - &quot;);             return kTRUE;   // error in the DCS mapped aliases</span>
<span class="lineNum">      54 </span>            :   }   
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :   if (runType == &quot;CALIBRATION&quot;){</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :     if (!ProcPed()){</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :         Log(&quot;HMPID - ERROR - Pedestal processing failed!!&quot;);                return kTRUE;   // error in pedestal processing</span>
<span class="lineNum">      58 </span>            :     } else {
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :         Log(&quot;HMPID - Pedestal processing successful!!&quot;);                    return kFALSE;  // ok for pedestals</span>
<span class="lineNum">      60 </span>            :     }
<span class="lineNum">      61 </span>            :   }//CALIBRATION
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :   else if ( runType==&quot;STANDALONE&quot; || runType==&quot;PHYSICS&quot;){   </span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :    statusDcs=ProcDcs(pMap);</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :    statusNoise=ProcNoiseMap();</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :    if(!statusDcs || !statusNoise) { Log(Form(&quot;HMPID - ERROR - Noise Map(%d) and/or DCS(%d) processing failed!! (0=OK, 1=FAILED)&quot;,statusNoise,statusDcs)); return kTRUE; }  // error in Noise Map or DCS processing</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :    else                           { Log(&quot;HMPID - Noise Map and DCS processing successful!!&quot;);  return kFALSE;}  // ok</span>
<span class="lineNum">      67 </span>            :   }//STANDALONE or PHYSICS run
<span class="lineNum">      68 </span>            :    else {
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :     Log(&quot;HMPID - Nothing to do with preprocessor for HMPID, bye!&quot;);         return kFALSE;  // ok - nothing done</span>
<span class="lineNum">      70 </span>            :   }
<a name="71"><span class="lineNum">      71 </span><span class="lineNoCov">          0 : }//Process()</span></a>
<span class="lineNum">      72 </span>            : //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
<span class="lineNum">      73 </span>            : Bool_t AliHMPIDPreprocessor::ProcNoiseMap()
<span class="lineNum">      74 </span>            : {
<span class="lineNum">      75 </span>            :   //
<span class="lineNum">      76 </span>            :   // Goal: Process the Noise Map created by the HMP Physics DA to mask 
<span class="lineNum">      77 </span>            :   // noisy channels from reconstruction and follow changes in accepatnce
<span class="lineNum">      78 </span>            :   // eg. DDL turn on/off after PEDESTAL run and between PHYSICS runs.
<span class="lineNum">      79 </span>            :   // Returns kFALSE on success
<span class="lineNum">      80 </span>            :  
<span class="lineNum">      81 </span>            :   Bool_t stProcNoise=kFALSE;
<span class="lineNum">      82 </span>            :   TFile  *fNoiseFile;
<span class="lineNum">      83 </span>            :   TH2F   *hNoiseMap = 0x0;
<span class="lineNum">      84 </span>            :   
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :   TList *pNoiseSource=GetFileSources(kDAQ,&quot;HmpPhysicsDaNoiseMap.root&quot;); //get list of DAQ source names containing id &quot;HmpPhysicsDaNoiseMap&quot; --&gt; defined in HMPIDphysda.cxx</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :   if(!pNoiseSource) {Log(Form(&quot;ERROR: Retrieval of sources for noise map: HmpPhysicsDaNoiseMap.root is failed!&quot;)); return stProcNoise;}</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :   if(!(TObjString*)pNoiseSource-&gt;At(0)) {Log(Form(&quot;ERROR: empty list received from DAQ Source!&quot;)); return stProcNoise;}</span>
<span class="lineNum">      88 </span>            :     
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :   TString noiseFile = GetFile(kDAQ,Form(&quot;HmpPhysicsDaNoiseMap.root&quot;),((TObjString*)pNoiseSource-&gt;At(0))-&gt;GetName());</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :   if(noiseFile.Length()==0) {Log(Form(&quot;ERROR retrieving noise map file: HmpPhysicsDaNoiseMap.root&quot;)); return stProcNoise;}</span>
<span class="lineNum">      91 </span>            :   
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :   fNoiseFile = TFile::Open(noiseFile.Data(),&quot;read&quot;);</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :   if(!fNoiseFile) {Log(Form(&quot;ERROR cannot open NoiseFile: %s!&quot;,noiseFile.Data())); return stProcNoise;}</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :   hNoiseMap = (TH2F*) fNoiseFile-&gt;Get(&quot;hHmpNoiseMaps&quot;);</span>
<span class="lineNum">      95 </span>            :   
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :   AliCDBMetaData metaDataHisto;</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :   metaDataHisto.SetBeamPeriod(0);</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   metaDataHisto.SetResponsible(&quot;AliHMPIDPreprocessor&quot;); </span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :   metaDataHisto.SetComment(&quot;AliHMPIDPreprocessor stores the Noise Map object as Reference Data.&quot;);</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   AliInfo(&quot;Storing Reference Data&quot;);</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :   stProcNoise = Store(&quot;Calib&quot;,&quot;NoiseMap&quot;,hNoiseMap,&amp;metaDataHisto,0,kTRUE);</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :   if(!stProcNoise) {</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :     Log(&quot;HMPID - failure to store Noise Map data results in OCDB&quot;);   </span>
<span class="lineNum">     104 </span>            :   }
<span class="lineNum">     105 </span>            :   return stProcNoise;
<a name="106"><span class="lineNum">     106 </span><span class="lineNoCov">          0 : }//ProcNoiseMap</span></a>
<span class="lineNum">     107 </span>            : //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
<span class="lineNum">     108 </span>            : Bool_t AliHMPIDPreprocessor::ProcDcs(TMap* pMap)
<span class="lineNum">     109 </span>            : {
<span class="lineNum">     110 </span>            : // Process: 1 (old). inlet and outlet C6F14 temperature, stores TObjArray of 21 TF1, where TF1 is Nmean=f(t), one per radiator
<span class="lineNum">     111 </span>            : // Process: 1. inlet and outlet C6F14 temperature, stores TObjArray of 42 TF1, where TF1 are Tin and Tout per radiator
<span class="lineNum">     112 </span>            : //             + one function for the mean energy photon (in total 43).
<span class="lineNum">     113 </span>            : //          2. CH4 pressure and HV                 stores TObjArray of 7 TF1 where TF1 is thr=f(t), one per chamber
<span class="lineNum">     114 </span>            : // Arguments: pDcsMap - map of structure &quot;alias name&quot; - TObjArray of AliDCSValue
<span class="lineNum">     115 </span>            : // Assume that: HV is the same during the run for a given chamber, different chambers might have different HV
<span class="lineNum">     116 </span>            : //              P=f(t), different for different chambers
<span class="lineNum">     117 </span>            : // Returns: kTRUE on success  
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span>            :   Bool_t stDcsStore=kFALSE;
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span>            : // Qthr=f(HV,P) [V,mBar]  logA0=k*HV+b is taken from p. 64 TDR plot 2.59 for PC32 
<span class="lineNum">     122 </span>            : //                           A0=f(P) is taken from DiMauro mail
<span class="lineNum">     123 </span>            : // Qthr is estimated as 3*A0
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :   TF2 thr(&quot;RthrCH4&quot;  ,&quot;3*10^(3.01e-3*x-4.72)+170745848*exp(-y*0.0162012)&quot;             ,2000,3000,900,1200); </span>
<span class="lineNum">     126 </span>            :   
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :   TObjArray arNmean(43);       arNmean.SetOwner(kTRUE);     //42 Tin and Tout one per radiator + 1 for ePhotMean</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :   TObjArray arQthre(42);       arQthre.SetOwner(kTRUE);     //42 Qthre=f(time) one per sector</span>
<span class="lineNum">     129 </span>            :   
<span class="lineNum">     130 </span>            :   AliDCSValue *pVal; Int_t cnt=0;
<span class="lineNum">     131 </span>            :   
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :   Double_t xP,yP;</span>
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span>            : //  TF1 **pTin  = new TF1*[21];
<span class="lineNum">     135 </span>            : //  TF1 **pTout = new TF1*[21];
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :   TF1  *pTin[21];</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :   TF1 *pTout[21];</span>
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span>            : // evaluate Environment Pressure
<span class="lineNum">     140 </span>            :   
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   TObjArray *pPenv=(TObjArray*)pMap-&gt;GetValue(&quot;HMP_DET/HMP_ENV/HMP_ENV_PENV.actual.value&quot;);</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :   if(!pPenv) {</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :     AliWarning(&quot; No Data Points from HMP_ENV_PENV.actual.value!&quot;);</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     145 </span>            :   } else {
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :     Log(Form(&quot; Environment Pressure data              ---&gt; %3i entries&quot;,pPenv-&gt;GetEntries()));</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     if(pPenv-&gt;GetEntries()) {</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :       TIter nextPenv(pPenv);</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :       TGraph *pGrPenv=new TGraph; cnt=0;</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :       while((pVal=(AliDCSValue*)nextPenv())) pGrPenv-&gt;SetPoint(cnt++,pVal-&gt;GetTimeStamp(),pVal-&gt;GetFloat());        //P env</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :       if( cnt==1) {</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :         pGrPenv-&gt;GetPoint(0,xP,yP);</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :         new TF1(&quot;Penv&quot;,Form(&quot;%f&quot;,yP),fStartTime,fEndTime);</span>
<span class="lineNum">     154 </span>            :       } else {
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :         pGrPenv-&gt;Fit(new TF1(&quot;Penv&quot;,&quot;1000+x*[0]&quot;,fStartTime,fEndTime),&quot;Q&quot;);</span>
<span class="lineNum">     156 </span>            :       }
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :       delete pGrPenv;</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :     } else {AliWarning(&quot; No Data Points from HMP_ENV_PENV.actual.value!&quot;);return kFALSE;}</span>
<span class="lineNum">     159 </span>            :   }  
<span class="lineNum">     160 </span>            : // evaluate Pressure
<span class="lineNum">     161 </span>            :   
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   for(Int_t iCh=0;iCh&lt;7;iCh++){                   </span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :     TObjArray *pP =(TObjArray*)pMap-&gt;GetValue(Form(&quot;HMP_DET/HMP_MP%i/HMP_MP%i_GAS/HMP_MP%i_GAS_PMWPC.actual.value&quot;,iCh,iCh,iCh));</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :     if(!pP) {</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot; No Data Points from HMP_MP%1i_GAS_PMWPC.actual.value!&quot;,iCh));</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     167 </span>            :     } else {
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :         Log(Form(&quot; Pressure for module %i data             ---&gt; %3i entries&quot;,iCh,pP-&gt;GetEntries()));</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :       if(pP-&gt;GetEntries()) {</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :         TIter nextP(pP);    </span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :         TGraph *pGrP=new TGraph; cnt=0; </span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :         while((pVal=(AliDCSValue*)nextP())) pGrP-&gt;SetPoint(cnt++,pVal-&gt;GetTimeStamp(),pVal-&gt;GetFloat());            //P</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :         if( cnt==1) {</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :           pGrP-&gt;GetPoint(0,xP,yP);</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :           new TF1(Form(&quot;P%i&quot;,iCh),Form(&quot;%f&quot;,yP),fStartTime,fEndTime);</span>
<span class="lineNum">     176 </span>            :         } else {
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :           pGrP-&gt;Fit(new TF1(Form(&quot;P%i&quot;,iCh),&quot;[0] + x*[1]&quot;,fStartTime,fEndTime),&quot;Q&quot;);</span>
<span class="lineNum">     178 </span>            :         }
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :         delete pGrP;</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :       } else {AliWarning(&quot; No Data Points from HMP_MP0-6_GAS_PMWPC.actual.value!&quot;);return kFALSE;}</span>
<span class="lineNum">     181 </span>            :     }
<span class="lineNum">     182 </span>            :     
<span class="lineNum">     183 </span>            : // evaluate High Voltage
<span class="lineNum">     184 </span>            :     
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :    for(Int_t iSec=0;iSec&lt;6;iSec++){</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :       TObjArray *pHV=(TObjArray*)pMap-&gt;GetValue(Form(&quot;HMP_DET/HMP_MP%i/HMP_MP%i_PW/HMP_MP%i_SEC%i/HMP_MP%i_SEC%i_HV.actual.vMon&quot;,iCh,iCh,iCh,iSec,iCh,iSec));</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :       if(!pHV) {</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot; No Data Points from HMP_MP%1i_SEC%1i_HV.actual.vMon!&quot;,iCh,iSec));</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :         return kFALSE;</span>
<span class="lineNum">     190 </span>            :       } else {
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :         Log(Form(&quot; HV for module %i and secto %i data       ---&gt; %3i entries&quot;,iCh,iSec,pHV-&gt;GetEntries()));</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :         if(pHV-&gt;GetEntries()) {</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :           TIter nextHV(pHV);</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :           TGraph *pGrHV=new TGraph; cnt=0;</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :           while((pVal=(AliDCSValue*)nextHV())) pGrHV-&gt;SetPoint(cnt++,pVal-&gt;GetTimeStamp(),pVal-&gt;GetFloat());            //HV</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :           if( cnt==1) {</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :             pGrHV-&gt;GetPoint(0,xP,yP);</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :             new TF1(Form(&quot;HV%i_%i&quot;,iCh,iSec),Form(&quot;%f&quot;,yP),fStartTime,fEndTime);               </span>
<span class="lineNum">     199 </span>            :           } else {
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :             pGrHV-&gt;Fit(new TF1(Form(&quot;HV%i_%i&quot;,iCh,iSec),&quot;[0]+x*[1]&quot;,fStartTime,fEndTime),&quot;Q&quot;);               </span>
<span class="lineNum">     201 </span>            :           }
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :           delete pGrHV;</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :         } else {AliWarning(&quot; No Data Points from HMP_MP0-6_SEC0-5_HV.actual.vMon!&quot;);return kFALSE;}</span>
<span class="lineNum">     204 </span>            :       }   
<span class="lineNum">     205 </span>            : // evaluate Qthre
<span class="lineNum">     206 </span>            :      
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :       arQthre.AddAt(new TF1(Form(&quot;HMP_QthreC%iS%i&quot;,iCh,iSec),</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :           Form(&quot;3*10^(3.01e-3*HV%i_%i - 4.72)+170745848*exp(-(P%i+Penv)*0.0162012)&quot;,iCh,iSec,iCh),fStartTime,fEndTime),6*iCh+iSec);</span>
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span>            :      //arQthre.AddAt(new TF1(Form(&quot;HMP_QthreC%iS%i&quot;,iCh,iSec),&quot;100&quot;,fStartTime,fEndTime),6*iCh+iSec);  
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     212 </span>            : // evaluate Temperatures: in and out of the radiators    
<span class="lineNum">     213 </span>            :     // T in
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :     for(Int_t iRad=0;iRad&lt;3;iRad++){</span>
<span class="lineNum">     215 </span>            :       
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :       pTin[3*iCh+iRad]  = new TF1(Form(&quot;Tin%i%i&quot; ,iCh,iRad),&quot;[0]+[1]*x&quot;,fStartTime,fEndTime);</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :       pTout[3*iCh+iRad] = new TF1(Form(&quot;Tout%i%i&quot;,iCh,iRad),&quot;[0]+[1]*x&quot;,fStartTime,fEndTime);          </span>
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span>            :       //pTin[3*iCh+iRad]  = new TF1(Form(&quot;Tin%i%i&quot; ,iCh,iRad),&quot;21&quot;,fStartTime,fEndTime);
<span class="lineNum">     220 </span>            :       //pTout[3*iCh+iRad] = new TF1(Form(&quot;Tout%i%i&quot;,iCh,iRad),&quot;22&quot;,fStartTime,fEndTime);          
<span class="lineNum">     221 </span>            :                   
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :     TObjArray *pT1=(TObjArray*)pMap-&gt;GetValue(Form(&quot;HMP_DET/HMP_MP%i/HMP_MP%i_LIQ_LOOP.actual.sensors.Rad%iIn_Temp&quot;,iCh,iCh,iRad));</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :       if(!pT1) {</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot; No Data Points from HMP_MP%1i_LIQ_LOOP.actual.sensors.Rad%1iIn_Temp!&quot;,iCh,iRad));</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :         return kFALSE;</span>
<span class="lineNum">     226 </span>            :       } else {
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :         Log(Form(&quot; Temperatures for module %i inside data  ---&gt; %3i entries&quot;,iCh,pT1-&gt;GetEntries()));</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :         if(pT1-&gt;GetEntries()) {</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :           TIter nextT1(pT1);//Tin</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :           TGraph *pGrT1=new TGraph; cnt=0;  while((pVal=(AliDCSValue*)nextT1())) pGrT1-&gt;SetPoint(cnt++,pVal-&gt;GetTimeStamp(),pVal-&gt;GetFloat()); //T inlet</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :           if(cnt==1) { </span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :             pGrT1-&gt;GetPoint(0,xP,yP);</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :             pTin[3*iCh+iRad]-&gt;SetParameter(0,yP);</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :             pTin[3*iCh+iRad]-&gt;SetParameter(1,0);</span>
<span class="lineNum">     235 </span>            :           } else {
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :             pGrT1-&gt;Fit(pTin[3*iCh+iRad],&quot;Q&quot;);</span>
<span class="lineNum">     237 </span>            :           }
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :           delete pGrT1;</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :         } else {AliWarning(&quot; No Data Points from HMP_MP0-6_LIQ_LOOP.actual.sensors.Rad0-2In_Temp!&quot;);return kFALSE;}</span>
<span class="lineNum">     240 </span>            :       }
<span class="lineNum">     241 </span>            :     // T out
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :       TObjArray *pT2=(TObjArray*)pMap-&gt;GetValue(Form(&quot;HMP_DET/HMP_MP%i/HMP_MP%i_LIQ_LOOP.actual.sensors.Rad%iOut_Temp&quot;,iCh,iCh,iRad)); </span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :       if(!pT2) {</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot; No Data Points from HMP_MP%1i_LIQ_LOOP.actual.sensors.Rad%1iOut_Temp!&quot;,iCh,iRad));</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         return kFALSE;</span>
<span class="lineNum">     246 </span>            :       } else {
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :         Log(Form(&quot; Temperatures for module %i outside data ---&gt; %3i entries&quot;,iCh,pT2-&gt;GetEntries()));</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :         if(pT2-&gt;GetEntries()) {</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :           TIter nextT2(pT2);//Tout      </span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :           TGraph *pGrT2=new TGraph; cnt=0;  while((pVal=(AliDCSValue*)nextT2())) pGrT2-&gt;SetPoint(cnt++,pVal-&gt;GetTimeStamp(),pVal-&gt;GetFloat()); //T outlet </span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :           if(cnt==1) { </span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :             pGrT2-&gt;GetPoint(0,xP,yP);</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :             pTout[3*iCh+iRad]-&gt;SetParameter(0,yP);</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :             pTout[3*iCh+iRad]-&gt;SetParameter(1,0);</span>
<span class="lineNum">     255 </span>            :           } else {
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :             pGrT2-&gt;Fit(pTout[3*iCh+iRad],&quot;Q&quot;);</span>
<span class="lineNum">     257 </span>            :           }
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :           delete pGrT2;</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :         } else {AliWarning(&quot; No Data Points from HMP_MP0-6_LIQ_LOOP.actual.sensors.Rad0-2Out_Temp!&quot;);return kFALSE;}</span>
<span class="lineNum">     260 </span>            :       }
<span class="lineNum">     261 </span>            :         
<span class="lineNum">     262 </span>            : // evaluate Mean Refractive Index
<span class="lineNum">     263 </span>            :       
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :       arNmean.AddAt(pTin[3*iCh+iRad] ,6*iCh+2*iRad  ); //Tin =f(t)</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :       arNmean.AddAt(pTout[3*iCh+iRad],6*iCh+2*iRad+1); //Tout=f(t)</span>
<span class="lineNum">     266 </span>            :       
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     }//radiators loop</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :   }//chambers loop</span>
<span class="lineNum">     269 </span>            :   
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :   Double_t eMean = ProcTrans(pMap);</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :   arNmean.AddAt(new TF1(&quot;HMP_PhotEmean&quot;,Form(&quot;%f&quot;,eMean),fStartTime,fEndTime),42); //Photon energy mean</span>
<span class="lineNum">     272 </span>            :     
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :   AliCDBMetaData metaData; </span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :   metaData.SetBeamPeriod(0); </span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   metaData.SetResponsible(&quot;AliHMPIDPreprocessor&quot;); </span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   metaData.SetComment(&quot;HMPID preprocessor fills TObjArrays.&quot;);</span>
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   stDcsStore =   Store(&quot;Calib&quot;,&quot;Qthre&quot;,&amp;arQthre,&amp;metaData,0,kTRUE) &amp;&amp;    // from DCS  0,kTRUE generates the file from Run 0 to Run 99999999</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :                  Store(&quot;Calib&quot;,&quot;Nmean&quot;,&amp;arNmean,&amp;metaData,0,kTRUE);      // from DCS</span>
<span class="lineNum">     280 </span>            : //  stDcsStore =   Store(&quot;Calib&quot;,&quot;Qthre&quot;,&amp;arQthre,&amp;metaData) &amp;&amp;    // from DCS 
<span class="lineNum">     281 </span>            : //                 Store(&quot;Calib&quot;,&quot;Nmean&quot;,&amp;arNmean,&amp;metaData);      // from DCS
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :   if(!stDcsStore) {</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     Log(&quot;HMPID - failure to store DCS data results in OCDB&quot;);    </span>
<span class="lineNum">     284 </span>            :   }
<span class="lineNum">     285 </span>            :   
<span class="lineNum">     286 </span>            : //  arNmean.Delete();
<span class="lineNum">     287 </span>            : //  arQthre.Delete();
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span>            : //  for(Int_t i=0;i&lt;21;i++) delete pTin[i]; delete []pTin;
<span class="lineNum">     290 </span>            : //  for(Int_t i=0;i&lt;21;i++) delete pTout[i]; delete []pTout;
<span class="lineNum">     291 </span>            :   
<span class="lineNum">     292 </span>            :   return stDcsStore;
<a name="293"><span class="lineNum">     293 </span><span class="lineNoCov">          0 : }//Process()</span></a>
<span class="lineNum">     294 </span>            : //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
<span class="lineNum">     295 </span>            : Bool_t AliHMPIDPreprocessor::ProcPed()
<span class="lineNum">     296 </span>            : {
<span class="lineNum">     297 </span>            : // Process pedestal files and create 7 M(padx,pady)=sigma, one for each chamber
<span class="lineNum">     298 </span>            : // Arguments:
<span class="lineNum">     299 </span>            : // Returns: kTRUE on success
<span class="lineNum">     300 </span>            :   
<span class="lineNum">     301 </span>            :   Bool_t stPedStore=kFALSE;
<span class="lineNum">     302 </span>            :   Bool_t stDeadMaskedStore=kFALSE;
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :   AliHMPIDDigit dig;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :   AliHMPIDRawStream rs;</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :   Int_t nSigCut,r,d,a,hard;  Float_t mean,sigma;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :   Int_t  runNumber,ldcId,timeStamp,nEv,nDdlEv,nBadEv;  Char_t tName[10]; </span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :   Float_t nBadEvPer;</span>
<span class="lineNum">     308 </span>            :   
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :   TObjArray aDaqSig(7);     aDaqSig.SetOwner(kTRUE);     for(Int_t i=0;i&lt;7;i++) aDaqSig.AddAt(new TMatrix(160,144),i);         //TObjArray of 7 TMatrixF, m(padx,pady)=sigma</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :   TObjArray aDeadMasked(7); aDeadMasked.SetOwner(kTRUE); for(Int_t i=0;i&lt;7;i++) aDeadMasked.AddAt(new TMatrix(160,144),i);     //TObjArray of 7 TMatrixF, m(padx,pady)=pedestal</span>
<span class="lineNum">     311 </span>            :   
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :   for(Int_t iddl=0;iddl&lt;AliHMPIDRawStream::kNDDL;iddl++)            //retrieve the files from LDCs independently the DDL&lt;-&gt;LDC connection</span>
<span class="lineNum">     313 </span>            :   {
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     TList *pLdc=GetFileSources(kDAQ,Form(&quot;HmpidPedDdl%02i.txt&quot;,iddl)); //get list of LDC names containing id &quot;pedestals&quot;</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     if(!pLdc) {Log(Form(&quot;ERROR: Retrieval of sources for pedestals: HmpidPedDdl%02i.txt failed!&quot;,iddl));continue;}</span>
<span class="lineNum">     316 </span>            :     
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     Log(Form(&quot;HMPID - Pedestal files to be read --&gt; %i LDCs for HMPID&quot;,pLdc-&gt;GetEntries()));</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :     for(Int_t i=0;i&lt;pLdc-&gt;GetEntries();i++) {//lists of LDCs -- but in general we have 1 LDC for 1 ped file</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     TString fileName = GetFile(kDAQ,Form(&quot;HmpidPedDdl%02i.txt&quot;,iddl),((TObjString*)pLdc-&gt;At(i))-&gt;GetName());</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     if(fileName.Length()==0) {Log(Form(&quot;ERROR retrieving pedestal file: HmpidPedDdl%02i.txt!&quot;,iddl));continue;}</span>
<span class="lineNum">     321 </span>            :   
<span class="lineNum">     322 </span>            :     //reading pedestal file
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :     ifstream infile(fileName.Data()); </span>
<span class="lineNum">     324 </span>            :     
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     if(!infile.is_open()) {Log(&quot;No pedestal file found for HMPID,bye!&quot;);continue;}</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     TMatrix *pM=(TMatrixF*)aDaqSig.At(iddl/2);</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     TMatrix *pDM=(TMatrixF*)aDeadMasked.At(iddl/2);</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     infile&gt;&gt;tName&gt;&gt;runNumber;Printf(&quot;Xcheck: reading run %i&quot;,runNumber);</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :     infile&gt;&gt;tName&gt;&gt;ldcId;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :     infile&gt;&gt;tName&gt;&gt;timeStamp;</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     infile&gt;&gt;tName&gt;&gt;nEv; </span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     infile&gt;&gt;tName&gt;&gt;nDdlEv;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     infile&gt;&gt;tName&gt;&gt;nBadEv;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     infile&gt;&gt;tName&gt;&gt;nBadEvPer;</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     infile&gt;&gt;tName&gt;&gt;nSigCut; pM-&gt;SetUniqueID(nSigCut); //n. of pedestal distribution sigmas used to create zero suppresion table</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     while(!infile.eof()){</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :       infile&gt;&gt;dec&gt;&gt;r&gt;&gt;d&gt;&gt;a&gt;&gt;mean&gt;&gt;sigma&gt;&gt;hex&gt;&gt;hard;</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :       if(rs.GetPad(iddl,r,d,a)&gt;=0){                  //the GetPad returns meaningful abs pad number                                                          </span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :       dig.SetPad(rs.GetPad(iddl,r,d,a));</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :       dig.SetQ((Int_t)mean);</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       (*pM)(dig.PadChX(),dig.PadChY()) = sigma;</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :       if( (mean == AliHMPIDParam::kPadMeanZeroCharge &amp;&amp; sigma == AliHMPIDParam::kPadSigmaZeroCharge) || </span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :           (mean == AliHMPIDParam::kPadMeanMasked     &amp;&amp; sigma == AliHMPIDParam::kPadSigmaMasked)     ) </span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :         {(*pDM)(dig.PadChX(),dig.PadChY()) = mean;} </span>
<span class="lineNum">     345 </span>            :       }
<span class="lineNum">     346 </span>            :     }
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :     infile.close();</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     Log(Form(&quot;Pedestal file for DDL %i read successfully&quot;,iddl));</span>
<span class="lineNum">     349 </span>            :   
<span class="lineNum">     350 </span>            :  
<span class="lineNum">     351 </span>            :     
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :   }//LDCs reading entries</span>
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :  }//DDL </span>
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :   AliCDBMetaData metaData; </span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :   metaData.SetBeamPeriod(0); </span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   metaData.SetResponsible(&quot;AliHMPIDPreprocessor&quot;); </span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :   metaData.SetComment(&quot;HMPID processor fills TObjArrays.&quot;);  </span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   stPedStore = Store(&quot;Calib&quot;,&quot;DaqSig&quot;,&amp;aDaqSig,&amp;metaData,0,kTRUE);</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :   if(!stPedStore) {     Log(&quot;HMPID - failure to store PEDESTAL data results in OCDB&quot;);      }</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :   stDeadMaskedStore = Store(&quot;Calib&quot;,&quot;Masked&quot;,&amp;aDeadMasked,&amp;metaData,0,kTRUE);</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :   if(!stDeadMaskedStore) {     Log(&quot;HMPID - failure to store DEAD &amp; MASKED channel map  in OCDB&quot;);      }</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :   Bool_t pedRes=stPedStore*stDeadMaskedStore;</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :   return pedRes;</span>
<span class="lineNum">     366 </span>            :   
<a name="367"><span class="lineNum">     367 </span><span class="lineNoCov">          0 : }//ProcPed()  </span></a>
<span class="lineNum">     368 </span>            : //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
<span class="lineNum">     369 </span>            : Double_t AliHMPIDPreprocessor::ProcTrans(TMap* pMap)
<span class="lineNum">     370 </span>            : {
<span class="lineNum">     371 </span>            :   //  Process transparency monitoring data and calculates Emean  
<span class="lineNum">     372 </span>            :   
<span class="lineNum">     373 </span>            :   Double_t sEnergProb=0, sProb=0;
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span>            :  // Double_t tRefCR5 = 19. ;                                      // mean temperature of CR5 where the system is in place
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span>            :   Double_t eMean = 0;
<span class="lineNum">     378 </span>            :       
<span class="lineNum">     379 </span>            :   AliDCSValue *pVal;
<span class="lineNum">     380 </span>            :   
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :   Double_t aCorrFactor[] = {0.937575212,0.93805688,0.938527113,0.938986068,0.939433897,0.939870746,0.940296755,0.94071206,0.941116795,0.941511085,0.941895054,0.942268821,0.942632502,</span>
<span class="lineNum">     382 </span>            :                             0.942986208,0.943330047,0.943664126,0.943988544,0.944303401,0.944608794,0.944904814,0.945191552,0.945469097,0.945737533,0.945996945,0.946247412,
<span class="lineNum">     383 </span>            :                             0.946489015,0.94672183,0.946945933,0.947161396,0.947368291}; 
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :   for(Int_t i=0; i&lt;30; i++){</span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span>            :     // evaluate wavelenght 
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :     TObjArray *pWaveLenght = (TObjArray*)pMap-&gt;GetValue(Form(&quot;HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.waveLenght&quot;,i));</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :     if(!pWaveLenght){ </span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;No Data Point values for HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.waveLenght  -----&gt; Default E mean used!!!!!&quot;,i));</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :         return DefaultEMean(); // to be checked</span>
<span class="lineNum">     392 </span>            :       } 
<span class="lineNum">     393 </span>            :         
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     pVal=(AliDCSValue*)pWaveLenght-&gt;At(0);</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     Double_t lambda = pVal-&gt;GetFloat();</span>
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     if(lambda&lt;150. || lambda&gt;230.){ </span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;Wrong value for HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.waveLenght  -----&gt; Default E mean used!!!!!&quot;,i));</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         return DefaultEMean(); // to be checked</span>
<span class="lineNum">     400 </span>            :       } 
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :     Double_t photEn = 1239.842609/lambda;     // 1239.842609 from nm to eV</span>
<span class="lineNum">     403 </span>            :     
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     if(photEn&lt;AliHMPIDParam::EPhotMin() || photEn&gt;AliHMPIDParam::EPhotMax()) continue;</span>
<span class="lineNum">     405 </span>            :     
<span class="lineNum">     406 </span>            :     // evaluate phototube current for argon reference
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     TObjArray *pArgonRef  = (TObjArray*)pMap-&gt;GetValue(Form(&quot;HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.argonReference&quot;,i));</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :     if(!pArgonRef){ </span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;No Data Point values for HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.argonReference  -----&gt; Default E mean used!!!!!&quot;,i));</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :         return DefaultEMean(); // to be checked</span>
<span class="lineNum">     411 </span>            :       } 
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     pVal=(AliDCSValue*)pArgonRef-&gt;At(0);    </span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :     Double_t aRefArgon = pVal-&gt;GetFloat();</span>
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            :     // evaluate phototube current for argon cell
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :     TObjArray *pArgonCell = (TObjArray*)pMap-&gt;GetValue(Form(&quot;HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.argonCell&quot;,i));</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :     if(!pArgonCell){ </span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;No Data Point values for HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.argonCell  -----&gt; Default E mean used!!!!!&quot;,i));</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :         return DefaultEMean(); // to be checked</span>
<span class="lineNum">     421 </span>            :       } 
<span class="lineNum">     422 </span>            :       
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :     pVal=(AliDCSValue*)pArgonRef-&gt;At(0);</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :     Double_t aCellArgon = pVal-&gt;GetFloat();</span>
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span>            :     //evaluate phototube current for freon reference
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :     TObjArray *pFreonRef  = (TObjArray*)pMap-&gt;GetValue(Form(&quot;HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.c6f14Reference&quot;,i));</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :     if(!pFreonRef){ </span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;No Data Point values for HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.c6f14Reference  -----&gt; Default E mean used!!!!!&quot;,i));</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :         return DefaultEMean(); // to be checked</span>
<span class="lineNum">     431 </span>            :       } 
<span class="lineNum">     432 </span>            :         
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :     pVal=(AliDCSValue*)pFreonRef-&gt;At(0);</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :     Double_t aRefFreon = pVal-&gt;GetFloat();</span>
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span>            :     //evaluate phototube current for freon cell
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :     TObjArray *pFreonCell = (TObjArray*)pMap-&gt;GetValue(Form(&quot;HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.c6f14Cell&quot;,i));</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :     if(!pFreonCell){</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;No Data Point values for HMP_DET/HMP_INFR/HMP_INFR_TRANPLANT/HMP_INFR_TRANPLANT_MEASURE.mesure%i.c6f14Cell  -----&gt; Default E mean used!!!!!&quot;,i));</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :         return DefaultEMean(); // to be checked</span>
<span class="lineNum">     441 </span>            :       }
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :     pVal=(AliDCSValue*)pFreonCell-&gt;At(0);</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :     Double_t aCellFreon = pVal-&gt;GetFloat();</span>
<span class="lineNum">     445 </span>            :  
<span class="lineNum">     446 </span>            :    //evaluate correction factor to calculate trasparency (Ref. NIMA 486 (2002) 590-609)
<span class="lineNum">     447 </span>            :     
<span class="lineNum">     448 </span>            :     //Double_t aN1 = AliHMPIDParam::NIdxRad(photEn,tRefCR5);
<span class="lineNum">     449 </span>            :     //Double_t aN2 = AliHMPIDParam::NMgF2Idx(photEn);
<span class="lineNum">     450 </span>            :     //Double_t aN3 = 1;                              // Argon Idx
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span>            :    // Double_t aR1               = ((aN1 - aN2)*(aN1 - aN2))/((aN1 + aN2)*(aN1 + aN2));
<span class="lineNum">     453 </span>            :   //  Double_t aR2               = ((aN2 - aN3)*(aN2 - aN3))/((aN2 + aN3)*(aN2 + aN3));
<span class="lineNum">     454 </span>            :    // Double_t aT1               = (1 - aR1);
<span class="lineNum">     455 </span>            :    // Double_t aT2               = (1 - aR2);
<span class="lineNum">     456 </span>            :    // Double_t aCorrFactor       = (aT1*aT1)/(aT2*aT2);
<span class="lineNum">     457 </span>            : 
<span class="lineNum">     458 </span>            :     // evaluate 15 mm of thickness C6F14 Trans
<span class="lineNum">     459 </span>            :     Double_t aTransRad;
<span class="lineNum">     460 </span>            :     
<span class="lineNum">     461 </span>            :     Double_t aConvFactor = 1.0 - 0.3/1.8;         
<span class="lineNum">     462 </span>            :         
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :     if(aRefFreon*aRefArgon&gt;0) {</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :       aTransRad  = TMath::Power((aCellFreon/aRefFreon)/(aCellArgon/aRefArgon)*aCorrFactor[i],aConvFactor);</span>
<span class="lineNum">     465 </span>            :     } else {
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :       return DefaultEMean();</span>
<span class="lineNum">     467 </span>            :     }
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span>            :     // evaluate 0.5 mm of thickness SiO2 Trans
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     Double_t aTransSiO2 = TMath::Exp(-0.5/AliHMPIDParam::LAbsWin(photEn));</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            :     // evaluate 80 cm of thickness Gap (low density CH4) transparency
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     Double_t aTransGap  = TMath::Exp(-80./AliHMPIDParam::LAbsGap(photEn));</span>
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span>            :     // evaluate CsI quantum efficiency
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     Double_t aCsIQE            = AliHMPIDParam::QEffCSI(photEn);</span>
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span>            :     // evaluate total convolution of all material optical properties
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :     Double_t aTotConvolution   = aTransRad*aTransSiO2*aTransGap*aCsIQE;</span>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :     sEnergProb+=aTotConvolution*photEn;  </span>
<span class="lineNum">     482 </span>            :   
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :     sProb+=aTotConvolution;  </span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :   if(sProb&gt;0) {</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :     eMean = sEnergProb/sProb;</span>
<span class="lineNum">     487 </span>            :   } else {
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     return DefaultEMean();</span>
<span class="lineNum">     489 </span>            :   }
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :   Log(Form(&quot; Mean energy photon calculated ---&gt; %f eV &quot;,eMean));</span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :   if(eMean&lt;AliHMPIDParam::EPhotMin() || eMean&gt;AliHMPIDParam::EPhotMax()) return DefaultEMean();</span>
<span class="lineNum">     493 </span>            :   
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :   return eMean;</span>
<a name="495"><span class="lineNum">     495 </span><span class="lineNoCov">          0 : }   </span></a>
<span class="lineNum">     496 </span>            : //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
<span class="lineNum">     497 </span>            : Double_t AliHMPIDPreprocessor::DefaultEMean()
<span class="lineNum">     498 </span>            : {
<span class="lineNum">     499 </span>            :     Double_t eMean = 6.675;      //just set a refractive index for C6F14 at ephot=6.675 eV @ T=25 C
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Mean energy for photons out of range [%f,%f] in Preprocessor. Default value Eph=%f eV taken.&quot;,AliHMPIDParam::EPhotMin(),</span>
<span class="lineNum">     501 </span>            :                                                                                                                    AliHMPIDParam::EPhotMax(),
<span class="lineNum">     502 </span>            :                                                                                                                    eMean));
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :     return eMean;</span>
<span class="lineNum">     504 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
