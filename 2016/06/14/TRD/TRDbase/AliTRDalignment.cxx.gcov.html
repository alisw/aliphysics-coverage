<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - TRD/TRDbase/AliTRDalignment.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">TRD/TRDbase</a> - AliTRDalignment.cxx<span style="font-size: 80%;"> (source / <a href="AliTRDalignment.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">548</td>
            <td class="headerCovTableEntryLo">0.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">44</td>
            <td class="headerCovTableEntryLo">2.3 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : /* $Id$ */
<span class="lineNum">      17 </span>            : ///////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      18 </span>            : //                                                                           //
<span class="lineNum">      19 </span>            : // An AliTRDalignment object contains the alignment data (3 shifts and 3     //
<span class="lineNum">      20 </span>            : // tilts) for all the alignable volumes of the TRD, i.e. for 18 supermodules //
<span class="lineNum">      21 </span>            : // and 540 chambers. The class provides simple tools for reading and writing //
<span class="lineNum">      22 </span>            : // these data in different formats, and for generating fake data that can be //
<span class="lineNum">      23 </span>            : // used to simulate misalignment.                                            //
<span class="lineNum">      24 </span>            : // The six alignment variables have the following meaning:                   //
<span class="lineNum">      25 </span>            : // shift in rphi                                                             //
<span class="lineNum">      26 </span>            : // shift in z                                                                //
<span class="lineNum">      27 </span>            : // shift in r                                                                //
<span class="lineNum">      28 </span>            : // tilt around rphi                                                          //
<span class="lineNum">      29 </span>            : // tilt around z                                                             //
<span class="lineNum">      30 </span>            : // tilt around r                                                             //
<span class="lineNum">      31 </span>            : // The shifts are in cm and the tilts are in degrees.                        //
<span class="lineNum">      32 </span>            : // The currently supported formats are:                                      //
<span class="lineNum">      33 </span>            : // - ascii                                                                   //
<span class="lineNum">      34 </span>            : // - root file containing a TClonesArray of alignment objects                //
<span class="lineNum">      35 </span>            : // - offline conditions database                                             //
<span class="lineNum">      36 </span>            : // - OCDB-like root file                                                     //
<span class="lineNum">      37 </span>            : // - geometry file (like misaligned_geometry.root)                           //
<span class="lineNum">      38 </span>            : //                                                                           //
<span class="lineNum">      39 </span>            : // Some examples of usage (in an aliroot session):                           //
<span class="lineNum">      40 </span>            : // AliTRDalignment a,b,c,d,e;                                                //
<span class="lineNum">      41 </span>            : // double xsm[]={0,0,0,-70,0,0};                                             //
<span class="lineNum">      42 </span>            : // double xch[]={0,0,-50,0,0,0};                                             //
<span class="lineNum">      43 </span>            : // a.SetSm(4,xsm);                                                           // 
<span class="lineNum">      44 </span>            : // a.SetCh(120,xch);                                                         //
<span class="lineNum">      45 </span>            : // a.WriteAscii(&quot;kuku.dat&quot;);                                                 //
<span class="lineNum">      46 </span>            : // TGeoManager::Import(&quot;geometry.root&quot;); a.WriteRoot(&quot;kuku.root&quot;);           //
<span class="lineNum">      47 </span>            : // TGeoManager::Import(&quot;geometry.root&quot;); a.WriteDB(&quot;kukudb.root&quot;,0,0);       //
<span class="lineNum">      48 </span>            : // TGeoManager::Import(&quot;geometry.root&quot;);                                     //
<span class="lineNum">      49 </span>            : // a.WriteDB(&quot;local://$ALICE_ROOT/OCDB&quot;, &quot;TRD/Align/Data&quot;, 0,0);                  //
<span class="lineNum">      50 </span>            : // TGeoManager::Import(&quot;geometry.root&quot;); a.WriteGeo(&quot;kukugeometry.root&quot;);    //
<span class="lineNum">      51 </span>            : //                                                                           //
<span class="lineNum">      52 </span>            : // b.ReadAscii(&quot;kuku.dat&quot;);                                                  //
<span class="lineNum">      53 </span>            : // TGeoManager::Import(&quot;geometry.root&quot;); c.ReadRoot(&quot;kuku.root&quot;);            //
<span class="lineNum">      54 </span>            : // TGeoManager::Import(&quot;geometry.root&quot;); d.ReadDB(&quot;kukudb.root&quot;);            //
<span class="lineNum">      55 </span>            : // TGeoManager::Import(&quot;kukugeometry.root&quot;); e.ReadCurrentGeo();             //
<span class="lineNum">      56 </span>            : //                                                                           //
<span class="lineNum">      57 </span>            : // e.PrintSm(4);                                                             //
<span class="lineNum">      58 </span>            : // e.PrintCh(120);                                                           // 
<span class="lineNum">      59 </span>            : // a.PrintRMS();                                                             //
<span class="lineNum">      60 </span>            : // b.PrintRMS();                                                             //
<span class="lineNum">      61 </span>            : // e.PrintRMS();                                                             //
<span class="lineNum">      62 </span>            : //                                                                           //
<span class="lineNum">      63 </span>            : //                                                                           //
<span class="lineNum">      64 </span>            : // D.Miskowiec, November 2006                                                //
<span class="lineNum">      65 </span>            : //                                                                           //
<span class="lineNum">      66 </span>            : ///////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : #include &lt;iostream&gt;
<span class="lineNum">      69 </span>            : #include &lt;fstream&gt;
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            : #include &quot;TMath.h&quot;
<span class="lineNum">      72 </span>            : #include &quot;TFile.h&quot;
<span class="lineNum">      73 </span>            : #include &quot;TGeoManager.h&quot;
<span class="lineNum">      74 </span>            : #include &quot;TGeoPhysicalNode.h&quot;
<span class="lineNum">      75 </span>            : #include &quot;TClonesArray.h&quot;
<span class="lineNum">      76 </span>            : #include &quot;TString.h&quot;
<span class="lineNum">      77 </span>            : #include &quot;TFitter.h&quot;
<span class="lineNum">      78 </span>            : #include &quot;TMinuit.h&quot;
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      81 </span>            : #include &quot;AliAlignObj.h&quot;
<span class="lineNum">      82 </span>            : #include &quot;AliAlignObjParams.h&quot;
<span class="lineNum">      83 </span>            : #include &quot;AliCDBManager.h&quot;
<span class="lineNum">      84 </span>            : #include &quot;AliCDBStorage.h&quot;
<span class="lineNum">      85 </span>            : #include &quot;AliCDBMetaData.h&quot;
<span class="lineNum">      86 </span>            : #include &quot;AliCDBEntry.h&quot;
<span class="lineNum">      87 </span>            : #include &quot;AliSurveyObj.h&quot;
<span class="lineNum">      88 </span>            : #include &quot;AliSurveyPoint.h&quot;
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            : #include &quot;AliTRDalignment.h&quot;
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span>            : void trdAlignmentFcn(Int_t &amp;npar, Double_t *gin, Double_t &amp;f, Double_t *x, Int_t iflag);
<span class="lineNum">      93 </span>            : 
<a name="94"><span class="lineNum">      94 </span>            : using std::ostream;</a>
<span class="lineNum">      95 </span>            : using std::fstream;
<span class="lineNum">      96 </span><span class="lineCov">         48 : ClassImp(AliTRDalignment)</span>
<a name="97"><span class="lineNum">      97 </span>            : </a>
<span class="lineNum">      98 </span>            : //_____________________________________________________________________________
<span class="lineNum">      99 </span>            : AliTRDalignment::AliTRDalignment() 
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   :TObject()</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :   ,fComment()</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :   ,fRan(0)</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     104 </span>            :   //
<span class="lineNum">     105 </span>            :   // constructor
<span class="lineNum">     106 </span>            :   //
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   SetZero();</span>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :   for (int i=0; i&lt;18; i++) for (int j=0; j&lt;2; j++) for (int k=0; k&lt;2; k++) for (int l=0; l&lt;2; l++) {</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :     fSurveyX[i][j][k][l] = 0.0;</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     fSurveyY[i][j][k][l] = 0.0;</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     fSurveyZ[i][j][k][l] = 0.0;</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :     fSurveyEX[i][j][k][l] = 0.0;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     fSurveyEY[i][j][k][l] = 0.0;</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     fSurveyEZ[i][j][k][l] = 0.0;</span>
<span class="lineNum">     117 </span>            :   }
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span>            :   // Initialize the nominal positions of the survey points 
<span class="lineNum">     120 </span>            :   // in the local frame of supermodule (where y is the long side, 
<span class="lineNum">     121 </span>            :   // z corresponds to the radius in lab, and x to the phi in lab).
<span class="lineNum">     122 </span>            :   // Four survey marks are on each z-side of the supermodule. 
<span class="lineNum">     123 </span>            :   //               A           B
<span class="lineNum">     124 </span>            :   //           ----o-----------o----        x |
<span class="lineNum">     125 </span>            :   //           \                   /          |
<span class="lineNum">     126 </span>            :   //            \                 /           |
<span class="lineNum">     127 </span>            :   //             \               /            |
<span class="lineNum">     128 </span>            :   //              \             /             |
<span class="lineNum">     129 </span>            :   //               ---o-----o---              --------------&gt;
<span class="lineNum">     130 </span>            :   //                  C     D                              y
<span class="lineNum">     131 </span>            :   // 
<span class="lineNum">     132 </span>            :   // For the purpose of this explanation lets define the origin such that 
<span class="lineNum">     133 </span>            :   // the supermodule occupies 0 &lt; x &lt; 77.9 cm. Then the coordinates (x,y) 
<span class="lineNum">     134 </span>            :   // are (in cm) 
<span class="lineNum">     135 </span>            :   // A (76.2,-30.25)
<span class="lineNum">     136 </span>            :   // B (76.2,+30.25)
<span class="lineNum">     137 </span>            :   // C ( 2.2,-22.5 )
<span class="lineNum">     138 </span>            :   // D ( 2.2,+22.5 )
<span class="lineNum">     139 </span>            :   // 
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   double x[2] = {22.5,30.25};                   // lab phi, or tracking-y</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :   double y[2] = {353.0, -353.0};                // lab z; inc. 2 cm survey target offset</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :   double z[2] = {-(77.9/2.0-2.0),77.9/2.0-1.5}; // lab r, or better tracking-x</span>
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :   for (int j=0; j&lt;2; j++) for (int k=0; k&lt;2; k++) for (int l=0; l&lt;2; l++) {</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :     fSurveyX0[j][k][l] = -TMath::Power(-1,l) * x[k];</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     fSurveyY0[j][k][l] = y[j];</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :     fSurveyZ0[j][k][l] = z[k];</span>
<span class="lineNum">     149 </span>            :   }
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   for (int i=0; i&lt;1000; i++) {</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :     fIbuffer[i] = 0;</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :     fDbuffer[i] = 0.0;</span>
<span class="lineNum">     154 </span>            :   }
<span class="lineNum">     155 </span>            : 
<span class="lineNum">     156 </span><span class="lineNoCov">          0 : }</span>
<a name="157"><span class="lineNum">     157 </span>            : </a>
<span class="lineNum">     158 </span>            : //_____________________________________________________________________________
<span class="lineNum">     159 </span>            : AliTRDalignment::AliTRDalignment(const AliTRDalignment&amp; source) 
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :   :TObject(source)</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   ,fComment(source.fComment)</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   ,fRan(source.fRan)</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     164 </span>            :   //
<span class="lineNum">     165 </span>            :   // copy constructor
<span class="lineNum">     166 </span>            :   //
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :   for (int i=0; i&lt;18; i++) SetSm(i,source.fSm[i]);</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :   for (int i=0; i&lt;540; i++) SetCh(i,source.fCh[i]);</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :   for (int i=0; i&lt;18; i++) for (int j=0; j&lt;2; j++) for (int k=0; k&lt;2; k++) for (int l=0; l&lt;2; l++) {</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :     fSurveyX[i][j][k][l] = source.fSurveyX[i][j][k][l];</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :     fSurveyY[i][j][k][l] = source.fSurveyY[i][j][k][l];</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :     fSurveyZ[i][j][k][l] = source.fSurveyZ[i][j][k][l];</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :     fSurveyEX[i][j][k][l] = source.fSurveyEX[i][j][k][l];</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     fSurveyEY[i][j][k][l] = source.fSurveyEY[i][j][k][l];</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     fSurveyEZ[i][j][k][l] = source.fSurveyEZ[i][j][k][l];</span>
<span class="lineNum">     177 </span>            :   }
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   for (int j=0; j&lt;2; j++) for (int k=0; k&lt;2; k++) for (int l=0; l&lt;2; l++) {</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :     fSurveyX0[j][k][l] = source.fSurveyX0[j][k][l];</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :     fSurveyY0[j][k][l] = source.fSurveyY0[j][k][l];</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     fSurveyZ0[j][k][l] = source.fSurveyZ0[j][k][l];</span>
<span class="lineNum">     182 </span>            :   }
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   for (int i=0; i&lt;1000; i++) {</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :     fIbuffer[i] = 0;</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :     fDbuffer[i] = 0.0;</span>
<span class="lineNum">     186 </span>            :   }
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span><span class="lineNoCov">          0 : }</span>
<a name="189"><span class="lineNum">     189 </span>            : </a>
<span class="lineNum">     190 </span>            : //_____________________________________________________________________________
<span class="lineNum">     191 </span>            : AliTRDalignment&amp; AliTRDalignment::operator=(const AliTRDalignment &amp;source) 
<span class="lineNum">     192 </span>            : {
<span class="lineNum">     193 </span>            :   //
<span class="lineNum">     194 </span>            :   // assignment operator
<span class="lineNum">     195 </span>            :   //
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   if (this != &amp;source) {</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     for (int i = 0; i &lt;  18; i++) SetSm(i,source.fSm[i]);</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     for (int i = 0; i &lt; 540; i++) SetCh(i,source.fCh[i]);</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     for (int i=0; i&lt;18; i++) for (int j=0; j&lt;2; j++) for (int k=0; k&lt;2; k++) for (int l=0; l&lt;2; l++) {</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :       fSurveyX[i][j][k][l] = source.fSurveyX[i][j][k][l];</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :       fSurveyY[i][j][k][l] = source.fSurveyY[i][j][k][l];</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :       fSurveyZ[i][j][k][l] = source.fSurveyZ[i][j][k][l];</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :       fSurveyEX[i][j][k][l] = source.fSurveyEX[i][j][k][l];</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :       fSurveyEY[i][j][k][l] = source.fSurveyEY[i][j][k][l];</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :       fSurveyEZ[i][j][k][l] = source.fSurveyEZ[i][j][k][l];</span>
<span class="lineNum">     207 </span>            :     }
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :     for (int j=0; j&lt;2; j++) for (int k=0; k&lt;2; k++) for (int l=0; l&lt;2; l++) {</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :       fSurveyX0[j][k][l] = source.fSurveyX0[j][k][l];</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :       fSurveyY0[j][k][l] = source.fSurveyY0[j][k][l];</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :       fSurveyZ0[j][k][l] = source.fSurveyZ0[j][k][l];</span>
<span class="lineNum">     212 </span>            :     }
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     fComment = source.fComment;</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :   return *this;</span>
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span>            : }
<a name="219"><span class="lineNum">     219 </span>            : </a>
<span class="lineNum">     220 </span>            : //_____________________________________________________________________________
<span class="lineNum">     221 </span>            : AliTRDalignment&amp; AliTRDalignment::operator*=(double fac) 
<span class="lineNum">     222 </span>            : {
<span class="lineNum">     223 </span>            :   //
<span class="lineNum">     224 </span>            :   // multiplication operator
<span class="lineNum">     225 </span>            :   //
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt;  18; i++) for (int j = 0; j &lt; 6; j++) this-&gt;fSm[i][j] *= fac;</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 540; i++) for (int j = 0; j &lt; 6; j++) this-&gt;fCh[i][j] *= fac;</span>
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :   return *this;</span>
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span>            : }
<a name="233"><span class="lineNum">     233 </span>            : </a>
<span class="lineNum">     234 </span>            : //_____________________________________________________________________________
<span class="lineNum">     235 </span>            : AliTRDalignment&amp; AliTRDalignment::operator+=(const AliTRDalignment &amp;source) 
<span class="lineNum">     236 </span>            : {
<span class="lineNum">     237 </span>            :   //
<span class="lineNum">     238 </span>            :   // addition operator
<span class="lineNum">     239 </span>            :   //
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt;  18; i++) for (int j = 0; j &lt; 6; j++) this-&gt;fSm[i][j] += source.fSm[i][j];</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 540; i++) for (int j = 0; j &lt; 6; j++) this-&gt;fCh[i][j] += source.fCh[i][j];</span>
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :   return *this;</span>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span>            : }
<a name="247"><span class="lineNum">     247 </span>            : </a>
<span class="lineNum">     248 </span>            : //_____________________________________________________________________________
<span class="lineNum">     249 </span>            : AliTRDalignment&amp; AliTRDalignment::operator-=(const AliTRDalignment &amp;source) 
<span class="lineNum">     250 </span>            : {
<span class="lineNum">     251 </span>            :   //
<span class="lineNum">     252 </span>            :   // subtraction operator
<span class="lineNum">     253 </span>            :   //
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt;  18; i++) for (int j = 0; j &lt; 6; j++) fSm[i][j] -= source.fSm[i][j];</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 540; i++) for (int j = 0; j &lt; 6; j++) fCh[i][j] -= source.fCh[i][j];</span>
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :   return *this;</span>
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span>            : }
<a name="261"><span class="lineNum">     261 </span>            : </a>
<span class="lineNum">     262 </span>            : //_____________________________________________________________________________
<span class="lineNum">     263 </span>            : Bool_t AliTRDalignment::operator==(const AliTRDalignment &amp;source) const
<span class="lineNum">     264 </span>            : {
<span class="lineNum">     265 </span>            :   //
<span class="lineNum">     266 </span>            :   // comparison operator
<span class="lineNum">     267 </span>            :   //
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span>            :   Bool_t areEqual = 1;
<span class="lineNum">     270 </span>            : 
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt;  18; i++) for (int j = 0; j &lt; 6; j++) areEqual &amp;= (fSm[i][j] == source.fSm[i][j]);</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 540; i++) for (int j = 0; j &lt; 6; j++) areEqual &amp;= (fCh[i][j] == source.fCh[i][j]);</span>
<span class="lineNum">     273 </span>            : 
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :   return areEqual;</span>
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span>            : }
<a name="277"><span class="lineNum">     277 </span>            : </a>
<span class="lineNum">     278 </span>            : //_____________________________________________________________________________
<span class="lineNum">     279 </span>            : void AliTRDalignment::SetSmZero() 
<span class="lineNum">     280 </span>            : {
<span class="lineNum">     281 </span>            :   //
<span class="lineNum">     282 </span>            :   // reset to zero supermodule data
<span class="lineNum">     283 </span>            :   //
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :   memset(&amp;fSm[0][0],0,sizeof(fSm));</span>
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span><span class="lineNoCov">          0 : }</span>
<a name="288"><span class="lineNum">     288 </span>            : </a>
<span class="lineNum">     289 </span>            : //_____________________________________________________________________________
<span class="lineNum">     290 </span>            : void AliTRDalignment::SetChZero() 
<span class="lineNum">     291 </span>            : {
<span class="lineNum">     292 </span>            :   //
<span class="lineNum">     293 </span>            :   // reset to zero chamber data
<span class="lineNum">     294 </span>            :   //
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :   memset(&amp;fCh[0][0],0,sizeof(fCh));</span>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineNoCov">          0 : }</span>
<a name="299"><span class="lineNum">     299 </span>            : </a>
<span class="lineNum">     300 </span>            : //_____________________________________________________________________________
<span class="lineNum">     301 </span>            : void AliTRDalignment::SetSmRandom(double a[6]) 
<span class="lineNum">     302 </span>            : {
<span class="lineNum">     303 </span>            :   //
<span class="lineNum">     304 </span>            :   // generate random gaussian supermodule data with sigmas a
<span class="lineNum">     305 </span>            :   //
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :   double x[6];</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :   double xmax[6]={999, 0.6, 999, 999, 999, 999};</span>
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 18; i++) {</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :     for (int j = 0; j &lt; 6; j++) {</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :       do {x[j] = fRan.Gaus(0,a[j]);} while (TMath::Abs(x[j]) &gt; xmax[j]);</span>
<span class="lineNum">     313 </span>            :     }
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     SetSm(i,x);</span>
<span class="lineNum">     315 </span>            :     //PrintSm(i);
<span class="lineNum">     316 </span>            :   }
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span><span class="lineNoCov">          0 : }</span>
<a name="319"><span class="lineNum">     319 </span>            : </a>
<span class="lineNum">     320 </span>            : //_____________________________________________________________________________
<span class="lineNum">     321 </span>            : void AliTRDalignment::SetChRandom(double a[6]) 
<span class="lineNum">     322 </span>            : {
<span class="lineNum">     323 </span>            :   //
<span class="lineNum">     324 </span>            :   // generate random gaussian chamber data with sigmas a
<span class="lineNum">     325 </span>            :   //
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :   double x[6];</span>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 540; i++) {</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :     fRan.Rannor(x[0],x[1]);</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     fRan.Rannor(x[2],x[3]);</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     fRan.Rannor(x[4],x[5]);</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     for (int j = 0; j &lt; 6; j++) x[j] *= a[j];</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     SetCh(i,x);</span>
<span class="lineNum">     335 </span>            :     //PrintCh(i);
<span class="lineNum">     336 </span>            :   }
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span><span class="lineNoCov">          0 : }</span>
<a name="339"><span class="lineNum">     339 </span>            : </a>
<span class="lineNum">     340 </span>            : //_____________________________________________________________________________
<span class="lineNum">     341 </span>            : void AliTRDalignment::SetSmFull() 
<span class="lineNum">     342 </span>            : {
<span class="lineNum">     343 </span>            :   //
<span class="lineNum">     344 </span>            :   // generate random gaussian supermodule data similar to the misalignment 
<span class="lineNum">     345 </span>            :   // expected from the mechanical precision 
<span class="lineNum">     346 </span>            :   //
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :   double a[6];</span>
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :   a[0] = 0.3; // phi</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :   a[1] = 0.3; // z</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :   a[2] = 0.3; // r</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :   a[3] = 0.4/1000.0 / TMath::Pi()*180.0; // phi</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :   a[4] = 2.0/1000.0 / TMath::Pi()*180.0; // z</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :   a[5] = 0.4/1000.0 / TMath::Pi()*180.0; // r</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :   SetSmRandom(a);</span>
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span><span class="lineNoCov">          0 : }</span>
<a name="360"><span class="lineNum">     360 </span>            : </a>
<span class="lineNum">     361 </span>            : //_____________________________________________________________________________
<span class="lineNum">     362 </span>            : void AliTRDalignment::SetChFull() 
<span class="lineNum">     363 </span>            : {
<span class="lineNum">     364 </span>            :   //
<span class="lineNum">     365 </span>            :   // generate random gaussian chamber data similar to the misalignment 
<span class="lineNum">     366 </span>            :   // expected from the mechanical precision 
<span class="lineNum">     367 </span>            :   //
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :   double a[6];</span>
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   a[0] = 0.1; // phi</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :   a[1] = 0.1; // z</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :   a[2] = 0.1; // r</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :   a[3] = 1.0/1000.0 / TMath::Pi()*180.0; // phi</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :   a[4] = 1.0/1000.0 / TMath::Pi()*180.0; // z</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :   a[5] = 0.7/1000.0 / TMath::Pi()*180.0; // r</span>
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   SetChRandom(a);</span>
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 : }</span>
<a name="381"><span class="lineNum">     381 </span>            : </a>
<span class="lineNum">     382 </span>            : //_____________________________________________________________________________
<span class="lineNum">     383 </span>            : void AliTRDalignment::SetSmResidual() 
<span class="lineNum">     384 </span>            : {
<span class="lineNum">     385 </span>            :   //
<span class="lineNum">     386 </span>            :   // generate random gaussian supermodule data similar to the misalignment 
<span class="lineNum">     387 </span>            :   // remaining after full calibration
<span class="lineNum">     388 </span>            :   // I assume that it will be negligible
<span class="lineNum">     389 </span>            :   //
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :   SetSmZero();</span>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span><span class="lineNoCov">          0 : }</span>
<a name="394"><span class="lineNum">     394 </span>            : </a>
<span class="lineNum">     395 </span>            : //_____________________________________________________________________________
<span class="lineNum">     396 </span>            : void AliTRDalignment::SetChResidual() 
<span class="lineNum">     397 </span>            : {
<span class="lineNum">     398 </span>            :   //
<span class="lineNum">     399 </span>            :   // generate random gaussian chamber data similar to the misalignment 
<span class="lineNum">     400 </span>            :   // remaining after full calibration
<span class="lineNum">     401 </span>            :   //
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :   double a[6];</span>
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :   a[0] = 0.002; // phi</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :   a[1] = 0.003; // z</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :   a[2] = 0.007; // r</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :   a[3] = 0.3/1000.0 / TMath::Pi()*180.0; // phi</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :   a[4] = 0.3/1000.0 / TMath::Pi()*180.0; // z</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :   a[5] = 0.1/1000.0 / TMath::Pi()*180.0; // r</span>
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :   SetChRandom(a);</span>
<span class="lineNum">     413 </span>            : 
<span class="lineNum">     414 </span><span class="lineNoCov">          0 : }</span>
<a name="415"><span class="lineNum">     415 </span>            : </a>
<span class="lineNum">     416 </span>            : //_____________________________________________________________________________
<span class="lineNum">     417 </span>            : void AliTRDalignment::PrintSm(int i, FILE * const fp) const 
<span class="lineNum">     418 </span>            : {
<span class="lineNum">     419 </span>            :   //
<span class="lineNum">     420 </span>            :   // print the supermodule data
<span class="lineNum">     421 </span>            :   //
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :   fprintf(fp,&quot;%4d   %11.4f %11.4f  %11.4f      %11.5f  %11.5f  %11.5f   %6d  %s\n&quot;</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :          ,i,fSm[i][0],fSm[i][1],fSm[i][2],fSm[i][3],fSm[i][4],fSm[i][5]</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :          ,0,GetSmName(i));</span>
<span class="lineNum">     426 </span>            : 
<span class="lineNum">     427 </span><span class="lineNoCov">          0 : }</span>
<a name="428"><span class="lineNum">     428 </span>            : </a>
<span class="lineNum">     429 </span>            : //_____________________________________________________________________________
<span class="lineNum">     430 </span>            : void AliTRDalignment::PrintCh(int i, FILE * const fp) const 
<span class="lineNum">     431 </span>            : {
<span class="lineNum">     432 </span>            :   //
<span class="lineNum">     433 </span>            :   // print the chamber data
<span class="lineNum">     434 </span>            :   //
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :   fprintf(fp,&quot;%4d   %11.4f %11.4f  %11.4f      %11.5f  %11.5f  %11.5f   %6d  %s\n&quot;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :          ,i,fCh[i][0],fCh[i][1],fCh[i][2],fCh[i][3],fCh[i][4],fCh[i][5]</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :          ,GetVoi(i),GetChName(i));</span>
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span><span class="lineNoCov">          0 : }</span>
<a name="441"><span class="lineNum">     441 </span>            : </a>
<span class="lineNum">     442 </span>            : //_____________________________________________________________________________
<span class="lineNum">     443 </span>            : void AliTRDalignment::ReadAscii(const char * const filename) 
<span class="lineNum">     444 </span>            : {
<span class="lineNum">     445 </span>            :   //
<span class="lineNum">     446 </span>            :   // read the alignment data from ascii file
<span class="lineNum">     447 </span>            :   //
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :   double x[6];      // alignment data</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :   int volid;        // volume id</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :   std::string syna; // symbolic name</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   int j;            // dummy index</span>
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   fstream fi(filename,fstream::in);</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :   if (!fi) {</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;cannot open input file %s&quot;,filename));</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     458 </span>            :   }
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span>            :   // supermodules
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 18; i++) {</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :     fi&gt;&gt;j&gt;&gt;x[0]&gt;&gt;x[1]&gt;&gt;x[2]&gt;&gt;x[3]&gt;&gt;x[4]&gt;&gt;x[5]&gt;&gt;volid&gt;&gt;syna;</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :     if (j != i) AliError(Form(&quot;sm %d expected, %d found&quot;,i,j));</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :     if (volid != 0) AliError(Form(&quot;sm %d volume id %d expected, %d found&quot;,i,0,volid));</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :     std::string symnam = GetSmName(i);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     if (syna != symnam) AliError(Form(&quot;sm %d name %s expected, %s found&quot;,i,symnam.data(),syna.data()));</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     SetSm(i,x);</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span>            :   // chambers
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 540; i++) {</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     fi&gt;&gt;j&gt;&gt;x[0]&gt;&gt;x[1]&gt;&gt;x[2]&gt;&gt;x[3]&gt;&gt;x[4]&gt;&gt;x[5]&gt;&gt;volid&gt;&gt;syna;</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :     if (j != i) AliError(Form(&quot;ch %d expected, %d found&quot;,i,j));</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     if (volid != GetVoi(i)) AliError(Form(&quot;ch %d volume id %d expected, %d found&quot;,i,GetVoi(i),volid));</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :     std::string symnam = GetChName(i);</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     if (syna != symnam) AliError(Form(&quot;ch %d name %s expected, %s found&quot;,i,symnam.data(),syna.data()));</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :     SetCh(i,x);</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :   fi.close();</span>
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span><span class="lineNoCov">          0 : }</span>
<a name="485"><span class="lineNum">     485 </span>            : </a>
<span class="lineNum">     486 </span>            : //_____________________________________________________________________________
<span class="lineNum">     487 </span>            : void AliTRDalignment::ReadCurrentGeo() 
<span class="lineNum">     488 </span>            : {
<span class="lineNum">     489 </span>            :   //
<span class="lineNum">     490 </span>            :   // use currently loaded geometry to determine misalignment by comparing 
<span class="lineNum">     491 </span>            :   // original and misaligned matrix of the last node
<span class="lineNum">     492 </span>            :   // Now, original, does not mean &quot;ideal&quot;. It is the matrix before the alignment. 
<span class="lineNum">     493 </span>            :   // So, if alignment was applied more than once, the numbers extracted will 
<span class="lineNum">     494 </span>            :   // represent just the last alignment. -- check this!
<span class="lineNum">     495 </span>            :   //
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span>            :   TGeoPNEntry *pne;
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :   TGeoHMatrix *ideSm[18];  // ideal</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :   TGeoHMatrix *misSm[18];  // misaligned</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 18; i++) if ((pne = gGeoManager-&gt;GetAlignableEntry(GetSmName(i)))) {</span>
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span>            :     // read misaligned and original matrices
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :     TGeoPhysicalNode *node = pne-&gt;GetPhysicalNode();</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :     if (!node) AliError(Form(&quot;physical node entry %s has no physical node&quot;,GetSmName(i)));</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :     if (!node) continue;</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :     misSm[i] = new TGeoHMatrix(*node-&gt;GetNode(node-&gt;GetLevel())-&gt;GetMatrix());</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :     ideSm[i] = new TGeoHMatrix(*node-&gt;GetOriginalMatrix());</span>
<span class="lineNum">     509 </span>            : 
<span class="lineNum">     510 </span>            :     // calculate the local misalignment matrices as inverse misaligned times ideal
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :     TGeoHMatrix mat(ideSm[i]-&gt;Inverse()); </span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :     mat.Multiply(misSm[i]);</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     double *tra = mat.GetTranslation();</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     double *rot = mat.GetRotationMatrix();</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :     double pars[6];</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :     pars[0] = tra[0];</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     pars[1] = tra[1];</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     pars[2] = tra[2];</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     if (TMath::Abs(rot[0])&lt;1e-7 || TMath::Abs(rot[8])&lt;1e-7) AliError(&quot;Failed to extract roll-pitch-yall angles!&quot;);</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :     double raddeg = TMath::RadToDeg();</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     pars[3] = raddeg * TMath::ATan2(-rot[5],rot[8]);</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :     pars[4] = raddeg * TMath::ASin(rot[2]);</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :     pars[5] = raddeg * TMath::ATan2(-rot[1],rot[0]);</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     SetSm(i,pars);</span>
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span>            :     // cleanup
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :     delete ideSm[i];</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :     delete misSm[i];</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     532 </span>            : 
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :   TGeoHMatrix *ideCh[540]; // ideal</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :   TGeoHMatrix *misCh[540]; // misaligned</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 540; i++) if ((pne = gGeoManager-&gt;GetAlignableEntry(GetChName(i)))) {</span>
<span class="lineNum">     536 </span>            : 
<span class="lineNum">     537 </span>            :     // read misaligned and original matrices
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :     TGeoPhysicalNode *node = pne-&gt;GetPhysicalNode();</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :     if (!node) AliError(Form(&quot;physical node entry %s has no physical node&quot;,GetChName(i)));</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :     if (!node) continue;</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :     misCh[i] = new TGeoHMatrix(*node-&gt;GetNode(node-&gt;GetLevel())-&gt;GetMatrix());</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     ideCh[i] = new TGeoHMatrix(*node-&gt;GetOriginalMatrix());</span>
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span>            :     // calculate the local misalignment matrices as inverse misaligned times ideal
<span class="lineNum">     546 </span>            : 
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :     TGeoHMatrix mat(ideCh[i]-&gt;Inverse()); </span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :     mat.Multiply(misCh[i]);</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :     double *tra = mat.GetTranslation();</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :     double *rot = mat.GetRotationMatrix();</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :     double pars[6];</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     pars[0] = tra[0];</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :     pars[1] = tra[1];</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :     pars[2] = tra[2];</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :     if(TMath::Abs(rot[0])&lt;1e-7 || TMath::Abs(rot[8])&lt;1e-7) {</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :       AliError(&quot;Failed to extract roll-pitch-yall angles!&quot;);</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     558 </span>            :     }
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :     double raddeg = TMath::RadToDeg();</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :     pars[3] = raddeg * TMath::ATan2(-rot[5],rot[8]);</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :     pars[4] = raddeg * TMath::ASin(rot[2]);</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :     pars[5] = raddeg * TMath::ATan2(-rot[1],rot[0]);</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :     SetCh(i,pars);</span>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span>            :     // cleanup
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :     delete ideCh[i];</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :     delete misCh[i];</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :   return;</span>
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span><span class="lineNoCov">          0 : }</span>
<a name="573"><span class="lineNum">     573 </span>            : </a>
<span class="lineNum">     574 </span>            : //_____________________________________________________________________________
<span class="lineNum">     575 </span>            : void AliTRDalignment::ReadRoot(const char * const filename) 
<span class="lineNum">     576 </span>            : {
<span class="lineNum">     577 </span>            :   //
<span class="lineNum">     578 </span>            :   // read the alignment data from root file
<span class="lineNum">     579 </span>            :   //
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :   TFile fi(filename,&quot;READ&quot;);</span>
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :   if (fi.IsOpen()) {</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :     TClonesArray *ar = (TClonesArray*) fi.Get(&quot;TRDAlignObjs&quot;);</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :     ArToNumbers(ar);</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :     fi.Close();</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :   } </span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :   else AliError(Form(&quot;cannot open input file %s&quot;,filename));</span>
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span>            :   return;
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineNoCov">          0 : }</span>
<a name="593"><span class="lineNum">     593 </span>            : </a>
<span class="lineNum">     594 </span>            : //_____________________________________________________________________________
<span class="lineNum">     595 </span>            : void AliTRDalignment::ReadDB(const char * const filename) 
<span class="lineNum">     596 </span>            : {
<span class="lineNum">     597 </span>            :   //
<span class="lineNum">     598 </span>            :   // read the alignment data from database file
<span class="lineNum">     599 </span>            :   //
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :   TFile fi(filename,&quot;READ&quot;);</span>
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :   if (fi.IsOpen()) {</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :     AliCDBEntry  *e  = (AliCDBEntry *) fi.Get(&quot;AliCDBEntry&quot;);</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :     e-&gt;PrintMetaData();</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :     fComment.SetString(e-&gt;GetMetaData()-&gt;GetComment());</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     TClonesArray *ar = (TClonesArray *) e-&gt;GetObject();</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :     ArToNumbers(ar);</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :     fi.Close();</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :   } </span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :   else AliError(Form(&quot;cannot open input file %s&quot;,filename));</span>
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span>            :   return;
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineNoCov">          0 : }</span>
<a name="616"><span class="lineNum">     616 </span>            : </a>
<span class="lineNum">     617 </span>            : //_____________________________________________________________________________
<span class="lineNum">     618 </span>            : void AliTRDalignment::ReadDB(const char * const db, const char * const path, 
<span class="lineNum">     619 </span>            :                              int run, int version, int subversion)
<span class="lineNum">     620 </span>            : {
<span class="lineNum">     621 </span>            :   //
<span class="lineNum">     622 </span>            :   // read the alignment data from database
<span class="lineNum">     623 </span>            :   //
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :   AliCDBManager *cdb     = AliCDBManager::Instance();</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :   AliCDBStorage *storLoc = cdb-&gt;GetStorage(db);</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :   AliCDBEntry   *e       = storLoc-&gt;Get(path,run,version,subversion);</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :   if (e) {</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :     e-&gt;PrintMetaData();</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :     fComment.SetString(e-&gt;GetMetaData()-&gt;GetComment());</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :     TClonesArray  *ar      =  (TClonesArray *) e-&gt;GetObject();</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :     ArToNumbers(ar);</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 : }</span>
<a name="635"><span class="lineNum">     635 </span>            : </a>
<span class="lineNum">     636 </span>            : //_____________________________________________________________________________
<span class="lineNum">     637 </span>            : Bool_t AliTRDalignment::DecodeSurveyPointName(TString pna, Int_t &amp;sm, Int_t &amp;iz, 
<span class="lineNum">     638 </span>            :                                               Int_t &amp;ir, Int_t &amp;iphi) {
<span class="lineNum">     639 </span>            :   // decode the survey point name and extract the sm, z, r and phi indices
<span class="lineNum">     640 </span>            :   
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :   if (pna(0,6)!=&quot;TRD_sm&quot;) {</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;unexpected point name: %s&quot;,pna.Data()));</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     644 </span>            :   }
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :   sm = atoi(pna(6,2).Data()); // supermodule number</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :   iz = -1;</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :   if (pna(8) == 'a') iz=0; // anticlockwise, positive z</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :   if (pna(8) == 'c') iz=1; // clockwise, negative z</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :   ir = -1;</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :   if (pna(9) == 'l') ir=0; // low radius</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :   if (pna(9) == 'h') ir=1; // high radius</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :   iphi = -1;</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :   if (pna(10) == '0') iphi = 0; // low phi within supermodule</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :   if (pna(10) == '1') iphi = 1; // high phi within supermodule</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :   if (sm&gt;=0 &amp;&amp; sm&lt;18 &amp;&amp; iz&gt;=0 &amp;&amp; iz&lt;2 &amp;&amp; ir&gt;=0 &amp;&amp; ir&lt;2 &amp;&amp; iphi&gt;=0 &amp;&amp; iphi&lt;2) return kTRUE;</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :   AliError(Form(&quot;cannot decode point name: %s&quot;,pna.Data()));</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :   return kFALSE;</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 : }</span>
<a name="659"><span class="lineNum">     659 </span>            : </a>
<span class="lineNum">     660 </span>            : //_____________________________________________________________________________
<span class="lineNum">     661 </span>            : void AliTRDalignment::ReadSurveyReport(const char * const filename) 
<span class="lineNum">     662 </span>            : {
<span class="lineNum">     663 </span>            :   //
<span class="lineNum">     664 </span>            :   // Read survey report and store the numbers in fSurveyX, fSurveyY, fSurveyZ, 
<span class="lineNum">     665 </span>            :   // and fSurveyE.  Store the survey info in the fComment.
<span class="lineNum">     666 </span>            :   // Each supermodule has 8 survey points. The point names look like 
<span class="lineNum">     667 </span>            :   // TRD_sm08ah0 and have the following meaning. 
<span class="lineNum">     668 </span>            :   //
<span class="lineNum">     669 </span>            :   // sm00..17 mean supermodule 0 through 17, following the phi.
<span class="lineNum">     670 </span>            :   // Supermodule 00 is between phi=0 and phi=20 degrees.
<span class="lineNum">     671 </span>            :   //
<span class="lineNum">     672 </span>            :   // a or c denotes the anticlockwise and clockwise end of the supermodule
<span class="lineNum">     673 </span>            :   // in z. Clockwise end is where z is negative and where the muon arm sits.
<span class="lineNum">     674 </span>            :   //
<span class="lineNum">     675 </span>            :   // l or h denote low radius and high radius holes
<span class="lineNum">     676 </span>            :   //
<span class="lineNum">     677 </span>            :   // 0 or 1 denote the hole at smaller and at larger phi, respectively.
<span class="lineNum">     678 </span>            :   //
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span>            :   // read the survey file
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :   fstream in(filename,fstream::in);</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :   if (!in) {</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;cannot open input file %s&quot;,filename));</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     686 </span>            :   }
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span>            :   // loop through the lines of the file until the beginning of data
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :   TString title,date,subdetector,url,version,observations,system,units;</span>
<span class="lineNum">     691 </span>            :   while (1) {
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :     char pee=in.peek();</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :     if (pee==EOF) break; </span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :     TString line;</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :     line.ReadLine(in);</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :     if (line.Contains(&quot;Title:&quot;))        title.ReadLine(in);</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :     if (line.Contains(&quot;Date:&quot;))         date.ReadLine(in);</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :     if (line.Contains(&quot;Subdetector:&quot;))  subdetector.ReadLine(in);</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :     if (line.Contains(&quot;URL:&quot;))          url.ReadLine(in);</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :     if (line.Contains(&quot;Version:&quot;))      version.ReadLine(in);</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :     if (line.Contains(&quot;Observations:&quot;)) observations.ReadLine(in);</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :     if (line.Contains(&quot;System:&quot;))       system.ReadLine(in);</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :     if (line.Contains(&quot;Units:&quot;))        units.ReadLine(in);</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :     if (line.Contains(&quot;Data:&quot;))         break;</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span>            :   // check what we found so far (watch out, they have \r at the end)
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;title ..........&quot;&lt;&lt;title&lt;&lt;std::endl;</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;date ...........&quot;&lt;&lt;date&lt;&lt;std::endl;</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;subdetector ....&quot;&lt;&lt;subdetector&lt;&lt;std::endl;</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;url ............&quot;&lt;&lt;url&lt;&lt;std::endl;</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;version ........&quot;&lt;&lt;version&lt;&lt;std::endl;</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;observations ...&quot;&lt;&lt;observations&lt;&lt;std::endl;</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;system .........&quot;&lt;&lt;system&lt;&lt;std::endl;</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;units ..........&quot;&lt;&lt;units&lt;&lt;std::endl;</span>
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :   if (!subdetector.Contains(&quot;TRD&quot;)) {</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Not a TRD survey file, subdetector = %s&quot;,subdetector.Data()));</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     721 </span>            :   }
<span class="lineNum">     722 </span>            :   double tocm = 0; // we want to have it in cm
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :   if (units.Contains(&quot;mm&quot;))      tocm = 0.1;</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :   else if (units.Contains(&quot;cm&quot;)) tocm = 1.0;</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :   else if (units.Contains(&quot;m&quot;))  tocm = 100.0;</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :   else if (units.Contains(&quot;pc&quot;)) tocm = 3.24078e-15;</span>
<span class="lineNum">     727 </span>            :   else {
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;unexpected units: %s&quot;,units.Data()));</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     730 </span>            :   }
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :   if (!system.Contains(&quot;ALICEPH&quot;)) {</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;wrong system: %s, should be ALICEPH&quot;,system.Data()));</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     734 </span>            :   }
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span>            :   // scan the rest of the file which should contain list of surveyed points
<span class="lineNum">     737 </span>            :   // for every point, decode the point name and store the numbers in the right 
<span class="lineNum">     738 </span>            :   // place in the arrays fSurveyX etc.
<span class="lineNum">     739 </span>            : 
<span class="lineNum">     740 </span>            :   while (1) {
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :     TString pna; // point name</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :     char type, target;</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :     double x,y,z,precision;</span>
<span class="lineNum">     744 </span>            :     
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :     in &gt;&gt; pna &gt;&gt; x &gt;&gt; y &gt;&gt; z &gt;&gt; type &gt;&gt; target &gt;&gt; precision;  </span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :     if (in.fail()) break;</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :     Int_t i,j,k,l;</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :     if (DecodeSurveyPointName(pna,i,j,k,l)) {</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :       fSurveyX[i][j][k][l] = tocm*x;</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :       fSurveyY[i][j][k][l] = tocm*y;</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :       fSurveyZ[i][j][k][l] = tocm*z;</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :       fSurveyEX[i][j][k][l] = precision/10; // &quot;precision&quot; is supposed to be in mm</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :       fSurveyEY[i][j][k][l] = precision/10; // &quot;precision&quot; is supposed to be in mm</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :       fSurveyEZ[i][j][k][l] = precision/10; // &quot;precision&quot; is supposed to be in mm</span>
<span class="lineNum">     755 </span>            :       // if, at some point, separate precision numbers for x,y,z show up in the 
<span class="lineNum">     756 </span>            :       // survey reports the function will fail here
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :       printf(&quot;decoded %s %02d %d %d %d  %8.2f %8.2f %8.2f %6.2f %6.2f %6.2f\n&quot;, </span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :              pna.Data(), i, j, k, l,</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :              fSurveyX[i][j][k][l], fSurveyY[i][j][k][l], fSurveyZ[i][j][k][l],</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :              fSurveyEX[i][j][k][l], fSurveyEY[i][j][k][l], fSurveyEZ[i][j][k][l]);</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :     } else AliError(Form(&quot;cannot decode point name: %s&quot;,pna.Data()));</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :   in.close();</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :   TString info = &quot;Survey &quot;+title+&quot; &quot;+date+&quot; &quot;+url+&quot; &quot;+version+&quot; &quot;+observations;</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :   info.ReplaceAll(&quot;\r&quot;,&quot;&quot;);</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :   fComment.SetString(info.Data());</span>
<span class="lineNum">     767 </span>            :  
<span class="lineNum">     768 </span><span class="lineNoCov">          0 : }</span>
<a name="769"><span class="lineNum">     769 </span>            : </a>
<span class="lineNum">     770 </span>            : //_____________________________________________________________________________
<span class="lineNum">     771 </span>            : void AliTRDalignment::ReadSurveyReport(const AliSurveyObj * const so) 
<span class="lineNum">     772 </span>            : {
<span class="lineNum">     773 </span>            :   //
<span class="lineNum">     774 </span>            :   // Read survey report and store the numbers in fSurveyX, fSurveyY, fSurveyZ, 
<span class="lineNum">     775 </span>            :   // and fSurveyE.  Store the survey info in the fComment.
<span class="lineNum">     776 </span>            :   // Each supermodule has 8 survey points. The point names look like 
<span class="lineNum">     777 </span>            :   // TRD_sm08ah0 and have the following meaning. 
<span class="lineNum">     778 </span>            :   //
<span class="lineNum">     779 </span>            :   // sm00..17 mean supermodule 0 through 17, following the phi.
<span class="lineNum">     780 </span>            :   // Supermodule 00 is between phi=0 and phi=20 degrees.
<span class="lineNum">     781 </span>            :   //
<span class="lineNum">     782 </span>            :   // a or c denotes the anticlockwise and clockwise end of the supermodule
<span class="lineNum">     783 </span>            :   // in z. Clockwise end is where z is negative and where the muon arm sits.
<span class="lineNum">     784 </span>            :   //
<span class="lineNum">     785 </span>            :   // l or h denote low radius and high radius holes
<span class="lineNum">     786 </span>            :   //
<span class="lineNum">     787 </span>            :   // 0 or 1 denote the hole at smaller and at larger phi, respectively.
<span class="lineNum">     788 </span>            :   //
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span>            :   // read and process the data from the survey object
<span class="lineNum">     791 </span>            : 
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :   Int_t size = so-&gt;GetEntries();</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :   printf(&quot;-&gt; %d\n&quot;, size);</span>
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :   TString title        = so-&gt;GetReportTitle();</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :   TString date         = so-&gt;GetReportDate();</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :   TString subdetector  = so-&gt;GetDetector();</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :   TString url          = so-&gt;GetURL();</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :   TString report       = so-&gt;GetReportNumber();</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :   TString version      = so-&gt;GetReportVersion();</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :   TString observations = so-&gt;GetObservations();</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :   TString system       = so-&gt;GetCoordSys();</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :   TString units        = so-&gt;GetUnits();</span>
<span class="lineNum">     804 </span>            : 
<span class="lineNum">     805 </span>            :   // check what we found so far (watch out, they have \r at the end)
<span class="lineNum">     806 </span>            : 
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;title ..........&quot;&lt;&lt;title&lt;&lt;std::endl;</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;date ...........&quot;&lt;&lt;date&lt;&lt;std::endl;</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;subdetector ....&quot;&lt;&lt;subdetector&lt;&lt;std::endl;</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;url ............&quot;&lt;&lt;url&lt;&lt;std::endl;</span>
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;version ........&quot;&lt;&lt;version&lt;&lt;std::endl;</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;observations ...&quot;&lt;&lt;observations&lt;&lt;std::endl;</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;system .........&quot;&lt;&lt;system&lt;&lt;std::endl;</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :   std::cout&lt;&lt;&quot;units ..........&quot;&lt;&lt;units&lt;&lt;std::endl;</span>
<span class="lineNum">     815 </span>            : 
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :   if (!subdetector.Contains(&quot;TRD&quot;)) {</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Not a TRD survey file, subdetector = %s&quot;,subdetector.Data()));</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     819 </span>            :   }
<span class="lineNum">     820 </span>            :   double tocm = 0; // we want to have it in cm
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :   if (units.Contains(&quot;mm&quot;))      tocm = 0.1;</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :   else if (units.Contains(&quot;cm&quot;)) tocm = 1.0;</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :   else if (units.Contains(&quot;m&quot;))  tocm = 100.0;</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :   else if (units.Contains(&quot;pc&quot;)) tocm = 3.24078e-15;</span>
<span class="lineNum">     825 </span>            :   else {
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;unexpected units: %s&quot;,units.Data()));</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     828 </span>            :   }
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :   if (!system.Contains(&quot;ALICEPH&quot;)) {</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;wrong system: %s, should be ALICEPH&quot;,system.Data()));</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     832 </span>            :   }
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span>            :   // for every survey point, decode the point name and store the numbers in 
<span class="lineNum">     835 </span>            :   // the right place in the arrays fSurveyX etc.
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :   TObjArray *points = so-&gt;GetData();</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :   for (int ip = 0; ip&lt;points-&gt;GetEntries(); ++ip) {</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :     AliSurveyPoint *po = (AliSurveyPoint *) points-&gt;At(ip);</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :     TString pna = po-&gt;GetPointName();</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :     Int_t i,j,k,l;</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :     if (DecodeSurveyPointName(pna,i,j,k,l)) {</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :       fSurveyX[i][j][k][l] = tocm*po-&gt;GetX();</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :       fSurveyY[i][j][k][l] = tocm*po-&gt;GetY();</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :       fSurveyZ[i][j][k][l] = tocm*po-&gt;GetZ();</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :       fSurveyEX[i][j][k][l] = po-&gt;GetPrecisionX()/10; // &quot;precision&quot; is supposed to be in mm</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :       fSurveyEY[i][j][k][l] = po-&gt;GetPrecisionY()/10;</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :       fSurveyEZ[i][j][k][l] = po-&gt;GetPrecisionZ()/10;</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :       printf(&quot;decoded %s %02d %d %d %d  %8.2f %8.2f %8.2f %6.2f %6.2f %6.2f\n&quot;, </span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :              pna.Data(), i, j, k, l,</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :              fSurveyX[i][j][k][l], fSurveyY[i][j][k][l], fSurveyZ[i][j][k][l],</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :              fSurveyEX[i][j][k][l], fSurveyEY[i][j][k][l], fSurveyEZ[i][j][k][l]);</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :     } else AliError(Form(&quot;cannot decode point name: %s&quot;,pna.Data()));</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :   TString info = &quot;Survey &quot;+title+&quot; &quot;+date+&quot; &quot;+url+&quot; &quot;+report+&quot; &quot;+version+&quot; &quot;+observations;</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :   info.ReplaceAll(&quot;\r&quot;,&quot;&quot;);</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :   fComment.SetString(info.Data());                       </span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 : }</span>
<a name="860"><span class="lineNum">     860 </span>            : </a>
<span class="lineNum">     861 </span>            : //_____________________________________________________________________________
<span class="lineNum">     862 </span>            : double AliTRDalignment::SurveyChi2(int i, const double * const a) {
<span class="lineNum">     863 </span>            : 
<span class="lineNum">     864 </span>            :   //
<span class="lineNum">     865 </span>            :   // Compare the survey results to the ideal positions of the survey marks
<span class="lineNum">     866 </span>            :   // in the local frame of supermodule. When transforming, use the alignment 
<span class="lineNum">     867 </span>            :   // parameters a[6]. Return chi-squared.
<span class="lineNum">     868 </span>            :   //
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :   if (!IsGeoLoaded()) return 0;</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :   printf(&quot;Survey of supermodule %d\n&quot;,i);</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :   AliAlignObjParams al(GetSmName(i),0,a[0],a[1],a[2],a[3],a[4],a[5],0);</span>
<span class="lineNum">     873 </span>            : 
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :   TGeoPNEntry      *pne  = gGeoManager-&gt;GetAlignableEntry(GetSmName(i));</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :   if (!pne) AliError(Form(&quot;no such physical node entry: %s&quot;,GetSmName(i)));</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :   TGeoPhysicalNode *node = pne-&gt;GetPhysicalNode();</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :   if (!node) {</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;physical node entry %s has no physical node; making a new one&quot;,GetSmName(i))); </span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :     node = gGeoManager-&gt;MakeAlignablePN(pne);</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span>            :   //  al.ApplyToGeometry();    
<span class="lineNum">     883 </span>            :   //  node = pne-&gt;GetPhysicalNode(); // changed in the meantime
<span class="lineNum">     884 </span>            :   //  TGeoHMatrix *ma = node-&gt;GetMatrix();
<span class="lineNum">     885 </span>            : 
<span class="lineNum">     886 </span>            :   // a less destructive method (it does not modify geometry), gives the same result:
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :   TGeoHMatrix *ma = new TGeoHMatrix();</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :   al.GetLocalMatrix(*ma);</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :   ma-&gt;MultiplyLeft(node-&gt;GetMatrix()); // global trafo, modified by a[]</span>
<span class="lineNum">     891 </span>            : 
<span class="lineNum">     892 </span>            :   double chi2=0;
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :   printf(&quot;              sm   z   r  phi    x (lab phi)  y (lab z)   z (lab r)   all in cm\n&quot;);</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :   for (int j=0; j&lt;2; j++) for (int k=0; k&lt;2; k++) for (int l=0; l&lt;2; l++) {</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :     if (fSurveyEX[i][j][k][l] == 0.0 </span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :         &amp;&amp; fSurveyEY[i][j][k][l] == 0.0 </span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :         &amp;&amp; fSurveyEZ[i][j][k][l] == 0.0) continue; // no data for this survey point</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :     double master[3] = {fSurveyX[i][j][k][l],fSurveyY[i][j][k][l],fSurveyZ[i][j][k][l]};</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :     double local[3];</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :     ma-&gt;MasterToLocal(master,local);</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :     double dx = local[0]-fSurveyX0[j][k][l];</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :     double dy = local[1]-fSurveyY0[j][k][l];</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :     double dz = local[2]-fSurveyZ0[j][k][l];</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :     chi2 += dx*dx/fSurveyEX[i][j][k][l]/fSurveyEX[i][j][k][l];</span>
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :     chi2 += dy*dy/fSurveyEY[i][j][k][l]/fSurveyEY[i][j][k][l];</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :     chi2 += dz*dz/fSurveyEZ[i][j][k][l]/fSurveyEZ[i][j][k][l];</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :     printf(&quot;local survey %3d %3d %3d %3d %12.3f %12.3f %12.3f\n&quot;,i,j,k,l,local[0],local[1],local[2]);</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :     printf(&quot;local ideal                  %12.3f %12.3f %12.3f\n&quot;,fSurveyX0[j][k][l],</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :            fSurveyY0[j][k][l],fSurveyZ0[j][k][l]);</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :     printf(&quot;difference                   %12.3f %12.3f %12.3f\n&quot;,dx,dy,dz);</span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :   printf(&quot;chi2 = %.2f\n&quot;,chi2);</span>
<span class="lineNum">     913 </span>            :   return chi2;
<span class="lineNum">     914 </span><span class="lineNoCov">          0 : }</span>
<a name="915"><span class="lineNum">     915 </span>            : </a>
<span class="lineNum">     916 </span>            : //_____________________________________________________________________________
<span class="lineNum">     917 </span>            : void trdAlignmentFcn(int &amp;npar, double *g, double &amp;f, double *par, int iflag) {
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span>            :   // 
<span class="lineNum">     920 </span>            :   // Standard function as needed by Minuit-like minimization procedures. 
<span class="lineNum">     921 </span>            :   // For the set of parameters par calculates and returns chi-squared.
<span class="lineNum">     922 </span>            :   //
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span>            :   // smuggle a C++ object into a C function
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :   AliTRDalignment *alignment = (AliTRDalignment*) gMinuit-&gt;GetObjectFit(); </span>
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :   f = alignment-&gt;SurveyChi2(par);</span>
<span class="lineNum">     928 </span>            :   if (iflag==3) {}
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :   if (npar) {} </span>
<span class="lineNum">     930 </span>            :   if (g) {} // no warnings about unused stuff...
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span><span class="lineNoCov">          0 : }</span>
<a name="933"><span class="lineNum">     933 </span>            : </a>
<span class="lineNum">     934 </span>            : //_____________________________________________________________________________
<span class="lineNum">     935 </span>            : void AliTRDalignment::SurveyToAlignment(int i, const char * const flag) {
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span>            :   //
<span class="lineNum">     938 </span>            :   // Find the supermodule alignment parameters needed to make the survey 
<span class="lineNum">     939 </span>            :   // results coincide with the ideal positions of the survey marks.
<span class="lineNum">     940 </span>            :   // The string flag should look like &quot;101000&quot;; the six characters corresponds 
<span class="lineNum">     941 </span>            :   // to the six alignment parameters and 0/1 mean that the parameter should 
<span class="lineNum">     942 </span>            :   // be fixed/released in the fit. 
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :   if (strlen(flag)!=6) {</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;unexpected flag: %s&quot;,flag));</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     947 </span>            :   }
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :   printf(&quot;Finding alignment matrix for supermodule %d\n&quot;,i);</span>
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :   fIbuffer[0] = i; // store the sm number in the buffer so minuit can see it</span>
<span class="lineNum">     951 </span>            : 
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :   TFitter fitter(100);</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :   gMinuit-&gt;SetObjectFit(this);</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :   fitter.SetFCN(trdAlignmentFcn);</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :   fitter.SetParameter(0,&quot;dx&quot;,0,0.5,0,0);</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :   fitter.SetParameter(1,&quot;dy&quot;,0,0.5,0,0);</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :   fitter.SetParameter(2,&quot;dz&quot;,0,0.5,0,0);</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :   fitter.SetParameter(3,&quot;rx&quot;,0,0.1,0,0);</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :   fitter.SetParameter(4,&quot;ry&quot;,0,0.1,0,0);</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :   fitter.SetParameter(5,&quot;rz&quot;,0,0.1,0,0);</span>
<span class="lineNum">     961 </span>            : 
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :   for (int j=0; j&lt;6; j++) if (flag[j]=='0') fitter.FixParameter(j);</span>
<span class="lineNum">     963 </span>            : 
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :   double arglist[100];</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :   arglist[0] = 2;</span>
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :   fitter.ExecuteCommand(&quot;SET PRINT&quot;, arglist, 1);</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :   fitter.ExecuteCommand(&quot;SET ERR&quot;, arglist, 1);</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :   arglist[0]=50;</span>
<span class="lineNum">     969 </span>            :   //fitter.ExecuteCommand(&quot;SIMPLEX&quot;, arglist, 1);
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :   fitter.ExecuteCommand(&quot;MINIMIZE&quot;, arglist, 1);</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :   fitter.ExecuteCommand(&quot;CALL 3&quot;, arglist,0);</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :   double a[6];</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :   for (int j=0; j&lt;6; j++) a[j] = fitter.GetParameter(j);</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :   SetSm(i,a);</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :   for (int j=0; j&lt;6; j++) printf(&quot;%10.3f &quot;,fitter.GetParameter(j));   </span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :   printf(&quot;\n&quot;);</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :   for (int j=0; j&lt;6; j++) printf(&quot;%10.3f &quot;,fitter.GetParError(j));</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :   printf(&quot;\n&quot;);</span>
<span class="lineNum">     979 </span>            : 
<span class="lineNum">     980 </span><span class="lineNoCov">          0 : }</span>
<a name="981"><span class="lineNum">     981 </span>            : </a>
<span class="lineNum">     982 </span>            : //_____________________________________________________________________________
<span class="lineNum">     983 </span>            : void AliTRDalignment::ReadAny(const char * const filename) 
<span class="lineNum">     984 </span>            : {
<span class="lineNum">     985 </span>            :   //
<span class="lineNum">     986 </span>            :   // read the alignment data from any kind of file
<span class="lineNum">     987 </span>            :   //
<span class="lineNum">     988 </span>            : 
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :   TString fist(filename);</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :   if (fist.EndsWith(&quot;.txt&quot;)) ReadAscii(filename);</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :   if (fist.EndsWith(&quot;.dat&quot;)) ReadAscii(filename);</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :   if (fist.EndsWith(&quot;.root&quot;)) {</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :     if (fist.Contains(&quot;Run&quot;)) ReadDB(filename);</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :     else ReadRoot(filename);</span>
<span class="lineNum">     995 </span>            :   }
<span class="lineNum">     996 </span>            : 
<span class="lineNum">     997 </span><span class="lineNoCov">          0 : }</span>
<a name="998"><span class="lineNum">     998 </span>            : </a>
<span class="lineNum">     999 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1000 </span>            : void AliTRDalignment::WriteAscii(const char * const filename) const
<span class="lineNum">    1001 </span>            : {
<span class="lineNum">    1002 </span>            :   //
<span class="lineNum">    1003 </span>            :   // store the alignment data on ascii file
<span class="lineNum">    1004 </span>            :   //
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :   FILE *fp = fopen(filename, &quot;w&quot;);</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :   if (!fp) {</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;cannot open output file %s&quot;,filename));</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1010 </span>            :   }
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :   PrintSm(fp);</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :   PrintCh(fp);</span>
<span class="lineNum">    1014 </span>            :   
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :   fclose(fp);</span>
<span class="lineNum">    1016 </span>            : 
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 : }</span>
<a name="1018"><span class="lineNum">    1018 </span>            : </a>
<span class="lineNum">    1019 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1020 </span>            : void AliTRDalignment::WriteRoot(const char * const filename) 
<span class="lineNum">    1021 </span>            : {
<span class="lineNum">    1022 </span>            :   //
<span class="lineNum">    1023 </span>            :   // store the alignment data on root file
<span class="lineNum">    1024 </span>            :   //
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :   TClonesArray *ar = new TClonesArray(&quot;AliAlignObjParams&quot;,10000);</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :   NumbersToAr(ar);</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :   TFile fo(filename,&quot;RECREATE&quot;);</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :   if (fo.IsOpen()) {</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :     fo.cd();</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :     fo.WriteObject(ar,&quot;TRDAlignObjs&quot;,&quot;kSingleKey&quot;);</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :     fo.Close();</span>
<span class="lineNum">    1033 </span>            :   } 
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :   else AliError(Form(&quot;cannot open output file %s&quot;,filename));</span>
<span class="lineNum">    1035 </span>            : 
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :   delete ar;</span>
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 : }</span>
<a name="1039"><span class="lineNum">    1039 </span>            : </a>
<span class="lineNum">    1040 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1041 </span>            : void AliTRDalignment::WriteDB(const char * const filename, int run0, int run1, int ver, int subver) 
<span class="lineNum">    1042 </span>            : {
<span class="lineNum">    1043 </span>            :   //
<span class="lineNum">    1044 </span>            :   // dumping on a DB-like file
<span class="lineNum">    1045 </span>            :   //
<span class="lineNum">    1046 </span>            : 
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :   TClonesArray   *ar = new TClonesArray(&quot;AliAlignObjParams&quot;,10000);</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :   NumbersToAr(ar);</span>
<span class="lineNum">    1049 </span>            :   const Char_t *path = &quot;TRD/Align/Data&quot;;
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :   AliCDBId id(path,run0,run1);</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :   AliCDBMetaData *md = new AliCDBMetaData();</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :   md-&gt;SetResponsible(&quot;Dariusz Miskowiec&quot;);</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :   md-&gt;SetComment(fComment.GetString().Data());</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :   AliCDBEntry *e  = new AliCDBEntry(ar, id, md);</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :   e-&gt;SetVersion(ver);</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :   e-&gt;SetSubVersion(subver);</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :   TFile fi(filename,&quot;RECREATE&quot;);</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :   if (fi.IsOpen()) {</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :     e-&gt;Write();</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :     fi.Close();</span>
<span class="lineNum">    1061 </span>            :   } 
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :   else AliError(Form(&quot;cannot open input file %s&quot;,filename));</span>
<span class="lineNum">    1063 </span>            : 
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :   delete e;</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :   delete md;</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :   delete ar;</span>
<span class="lineNum">    1067 </span>            : 
<span class="lineNum">    1068 </span>            :   return;
<span class="lineNum">    1069 </span>            : 
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 : }</span>
<a name="1071"><span class="lineNum">    1071 </span>            : </a>
<span class="lineNum">    1072 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1073 </span>            : void AliTRDalignment::WriteDB(char * const db, const char * const path, int run0, int run1) 
<span class="lineNum">    1074 </span>            : {
<span class="lineNum">    1075 </span>            :   //
<span class="lineNum">    1076 </span>            :   // store the alignment data in database
<span class="lineNum">    1077 </span>            :   //
<span class="lineNum">    1078 </span>            : 
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :   TClonesArray   *ar      = new TClonesArray(&quot;AliAlignObjParams&quot;,10000);</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :   NumbersToAr(ar);</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :   AliCDBManager  *cdb     = AliCDBManager::Instance();</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :   AliCDBStorage  *storLoc = cdb-&gt;GetStorage(db);</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :   AliCDBMetaData *md      = new AliCDBMetaData();</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :   md-&gt;SetResponsible(&quot;Dariusz Miskowiec&quot;);</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :   md-&gt;SetComment(fComment.GetString().Data());</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :   AliCDBId id(path,run0,run1);</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :   storLoc-&gt;Put(ar,id,md);</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :   md-&gt;Delete();</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :   delete ar;</span>
<span class="lineNum">    1090 </span>            : 
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 : }</span>
<a name="1092"><span class="lineNum">    1092 </span>            : </a>
<span class="lineNum">    1093 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1094 </span>            : void AliTRDalignment::WriteGeo(char *filename) 
<span class="lineNum">    1095 </span>            : {
<span class="lineNum">    1096 </span>            :   //
<span class="lineNum">    1097 </span>            :   // apply misalignment to current geometry and store the 
<span class="lineNum">    1098 </span>            :   // resulting geometry on a root file
<span class="lineNum">    1099 </span>            :   //
<span class="lineNum">    1100 </span>            : 
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :   TClonesArray *ar = new TClonesArray(&quot;AliAlignObjParams&quot;,10000);</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :   NumbersToAr(ar);</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :   delete ar;</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :   gGeoManager-&gt;Export(filename);</span>
<span class="lineNum">    1105 </span>            : 
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 : }</span>
<a name="1107"><span class="lineNum">    1107 </span>            : </a>
<span class="lineNum">    1108 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1109 </span>            : double AliTRDalignment::GetSmRMS(int xyz) const 
<span class="lineNum">    1110 </span>            : {
<span class="lineNum">    1111 </span>            :   //
<span class="lineNum">    1112 </span>            :   // rms fSm[][xyz]
<span class="lineNum">    1113 </span>            :   //
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span>            :   double s1 = 0.0;
<span class="lineNum">    1116 </span>            :   double s2 = 0.0;
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 18; i++) {</span>
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :     s1 += fSm[i][xyz];</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :     s2 += fSm[i][xyz]*fSm[i][xyz];</span>
<span class="lineNum">    1120 </span>            :   }
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :   double rms2 = s2/18.0 - s1*s1/18.0/18.0;</span>
<span class="lineNum">    1122 </span>            : 
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :   return rms2&gt;0 ? sqrt(rms2) : 0.0;</span>
<span class="lineNum">    1124 </span>            : 
<span class="lineNum">    1125 </span>            : }
<a name="1126"><span class="lineNum">    1126 </span>            : </a>
<span class="lineNum">    1127 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1128 </span>            : double AliTRDalignment::GetChRMS(int xyz) const
<span class="lineNum">    1129 </span>            : {
<span class="lineNum">    1130 </span>            :   //
<span class="lineNum">    1131 </span>            :   // rms fCh[][xyz]
<span class="lineNum">    1132 </span>            :   //
<span class="lineNum">    1133 </span>            : 
<span class="lineNum">    1134 </span>            :   double s1 =0.0;
<span class="lineNum">    1135 </span>            :   double s2 =0.0;
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 540; i++) {</span>
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :     s1 += fCh[i][xyz];</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :     s2 += fCh[i][xyz]*fCh[i][xyz];</span>
<span class="lineNum">    1139 </span>            :   }
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :   double rms2 = s2/540.0 - s1*s1/540.0/540.0;</span>
<span class="lineNum">    1141 </span>            : 
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :   return rms2&gt;0 ? sqrt(rms2) : 0.0;</span>
<span class="lineNum">    1143 </span>            : 
<span class="lineNum">    1144 </span>            : }
<a name="1145"><span class="lineNum">    1145 </span>            : </a>
<span class="lineNum">    1146 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1147 </span>            : void AliTRDalignment::PrintSmRMS() const
<span class="lineNum">    1148 </span>            : {
<span class="lineNum">    1149 </span>            :   //
<span class="lineNum">    1150 </span>            :   // dump rms of fSm
<span class="lineNum">    1151 </span>            :   //
<span class="lineNum">    1152 </span>            : 
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :   printf(&quot;       %11.4f %11.4f  %11.4f      %11.5f  %11.5f  %11.5f  supermodule rms\n&quot;</span>
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :         ,GetSmRMS(0),GetSmRMS(1),GetSmRMS(2),GetSmRMS(3),GetSmRMS(4),GetSmRMS(5));</span>
<span class="lineNum">    1155 </span>            : 
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 : }</span>
<a name="1157"><span class="lineNum">    1157 </span>            : </a>
<span class="lineNum">    1158 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1159 </span>            : void AliTRDalignment::PrintChRMS() const
<span class="lineNum">    1160 </span>            : {
<span class="lineNum">    1161 </span>            :   //
<span class="lineNum">    1162 </span>            :   // dump rms of fCh
<span class="lineNum">    1163 </span>            :   //
<span class="lineNum">    1164 </span>            : 
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :   printf(&quot;       %11.4f %11.4f  %11.4f      %11.5f  %11.5f  %11.5f  chamber rms\n&quot;</span>
<span class="lineNum">    1166 </span><span class="lineNoCov">          0 :         ,GetChRMS(0),GetChRMS(1),GetChRMS(2),GetChRMS(3),GetChRMS(4),GetChRMS(5));</span>
<span class="lineNum">    1167 </span>            : 
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 : }</span>
<a name="1169"><span class="lineNum">    1169 </span>            : </a>
<span class="lineNum">    1170 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1171 </span>            : void AliTRDalignment::ArToNumbers(TClonesArray * const ar) 
<span class="lineNum">    1172 </span>            : {
<span class="lineNum">    1173 </span>            :   //
<span class="lineNum">    1174 </span>            :   // for each of the alignment objects in array ar extract the six local 
<span class="lineNum">    1175 </span>            :   // alignment parameters; recognize by name to which supermodule or chamber 
<span class="lineNum">    1176 </span>            :   // the alignment object pertains; set the respective fSm or fCh
<span class="lineNum">    1177 </span>            :   //
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :   ar-&gt;Sort();</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :   if (!IsGeoLoaded()) return;</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; ar-&gt;GetEntries(); i++) {</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :     AliAlignObj *aao = (AliAlignObj *) ar-&gt;At(i);</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :     aao-&gt;ApplyToGeometry();</span>
<span class="lineNum">    1184 </span>            :   }
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :   SetZero();</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :   ReadCurrentGeo();</span>
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 : }</span>
<a name="1189"><span class="lineNum">    1189 </span>            : </a>
<span class="lineNum">    1190 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1191 </span>            : void AliTRDalignment::NumbersToAr(TClonesArray * const ar) 
<span class="lineNum">    1192 </span>            : {
<span class="lineNum">    1193 </span>            :   //
<span class="lineNum">    1194 </span>            :   // build array of AliAlignObj objects based on fSm and fCh data
<span class="lineNum">    1195 </span>            :   // at the same time, apply misalignment to the currently loaded geometry
<span class="lineNum">    1196 </span>            :   // it is important to apply misalignment of supermodules before creating 
<span class="lineNum">    1197 </span>            :   // alignment objects for chambers
<span class="lineNum">    1198 </span>            :   //
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :   if (!IsGeoLoaded()) return;</span>
<span class="lineNum">    1201 </span>            :   TClonesArray &amp;alobj = *ar;
<span class="lineNum">    1202 </span>            :   int nobj = 0;
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt;  18; i++) {      </span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :       new(alobj[nobj]) AliAlignObjParams(GetSmName(i)</span>
<span class="lineNum">    1205 </span>            :                                         ,0 
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :                                         ,fSm[i][0],fSm[i][1],fSm[i][2]</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :                                         ,fSm[i][3],fSm[i][4],fSm[i][5]</span>
<span class="lineNum">    1208 </span>            :                                         ,0);
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :     ((AliAlignObj *) alobj[nobj])-&gt;ApplyToGeometry();</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :     nobj++;</span>
<span class="lineNum">    1211 </span>            :   }
<span class="lineNum">    1212 </span>            : 
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; 540; i++) {</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :     if (gGeoManager-&gt;GetAlignableEntry(GetChName(i))) {</span>
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :       new(alobj[nobj]) AliAlignObjParams(GetChName(i)</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                                          ,GetVoi(i)</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :                                          ,fCh[i][0],fCh[i][1],fCh[i][2]</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :                                          ,fCh[i][3],fCh[i][4],fCh[i][5]</span>
<span class="lineNum">    1219 </span>            :                                          ,0);
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :       ((AliAlignObj *) alobj[nobj])-&gt;ApplyToGeometry();</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :       nobj++;</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1223 </span>            :   }
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :   AliInfo(&quot;current geometry modified&quot;);</span>
<span class="lineNum">    1225 </span>            : 
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 : }</span>
<a name="1227"><span class="lineNum">    1227 </span>            : </a>
<span class="lineNum">    1228 </span>            : //_____________________________________________________________________________
<span class="lineNum">    1229 </span>            : int AliTRDalignment::IsGeoLoaded() 
<span class="lineNum">    1230 </span>            : {
<span class="lineNum">    1231 </span>            :   //
<span class="lineNum">    1232 </span>            :   // check whether a geometry is loaded
<span class="lineNum">    1233 </span>            :   // issue a warning if geometry is not ideal
<span class="lineNum">    1234 </span>            :   //
<span class="lineNum">    1235 </span>            : 
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :   if (gGeoManager) {</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :     if (gGeoManager-&gt;GetListOfPhysicalNodes()-&gt;GetEntries()) AliWarning(&quot;current geometry is not ideal&quot;);</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">    1239 </span>            :   } else {
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :     AliError(&quot;first load geometry by calling TGeoManager::Import(filename)&quot;);</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">    1242 </span>            :   }
<span class="lineNum">    1243 </span>            : 
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span>            : //_____________________________________________________________________________
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
