<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - TRD/TRDbase/AliTRDtrapConfigHandler.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">TRD/TRDbase</a> - AliTRDtrapConfigHandler.cxx<span style="font-size: 80%;"> (source / <a href="AliTRDtrapConfigHandler.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">154</td>
            <td class="headerCovTableEntry">308</td>
            <td class="headerCovTableEntryLo">50.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">11</td>
            <td class="headerCovTableEntry">17</td>
            <td class="headerCovTableEntryLo">64.7 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : ////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      17 </span>            : //                                                                        //
<span class="lineNum">      18 </span>            : //  MCM configuraton handler                                              //
<span class="lineNum">      19 </span>            : //                                                                        //
<span class="lineNum">      20 </span>            : //  Author: U. Westerhoff                                                 //
<span class="lineNum">      21 </span>            : //                                                                        //
<span class="lineNum">      22 </span>            : ////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #include &quot;AliTRDtrapConfigHandler.h&quot;
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;iostream&gt;
<span class="lineNum">      27 </span>            : #include &lt;sstream&gt;
<span class="lineNum">      28 </span>            : #include &lt;iomanip&gt;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : #include &quot;AliTRDfeeParam.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;AliTRDtrapConfig.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;AliTRDmcmSim.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;AliTRDgeometry.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;AliTRDcalibDB.h&quot;
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : #include &quot;TMath.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;TGeoMatrix.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;TGraph.h&quot;
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            : #include &quot;AliTRDCalOnlineGainTable.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;AliTRDCalOnlineGainTableROC.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;AliTRDCalOnlineGainTableMCM.h&quot;
<span class="lineNum">      45 </span>            : 
<a name="46"><span class="lineNum">      46 </span>            : using namespace std;</a>
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span><span class="lineCov">          1 : AliTRDtrapConfigHandler::AliTRDtrapConfigHandler(AliTRDtrapConfig *cfg) :</span>
<span class="lineNum">      49 </span><span class="lineCov">          1 :      ltuParam()</span>
<span class="lineNum">      50 </span><span class="lineCov">          1 :      , fRestrictiveMask((0x3ffff &lt;&lt; 11) | (0x1f &lt;&lt; 6) | 0x3f)</span>
<span class="lineNum">      51 </span><span class="lineCov">          1 :      , fTrapConfig(cfg)</span>
<span class="lineNum">      52 </span><span class="lineCov">          1 :      , fGtbl()</span>
<span class="lineNum">      53 </span><span class="lineCov">          5 : {</span>
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span><span class="lineCov">          2 : }</span>
<a name="56"><span class="lineNum">      56 </span>            : </a>
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            : AliTRDtrapConfigHandler::~AliTRDtrapConfigHandler()
<span class="lineNum">      59 </span><span class="lineCov">          4 : {</span>
<span class="lineNum">      60 </span>            : 
<a name="61"><span class="lineNum">      61 </span><span class="lineCov">          2 : }</span></a>
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            : void AliTRDtrapConfigHandler::Init()
<span class="lineNum">      64 </span>            : {
<span class="lineNum">      65 </span><span class="lineCov">          2 :   if (!fTrapConfig) {</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :     AliError(&quot;No TRAPconfig given&quot;);</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">      68 </span>            :   }
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span>            :   // setup of register allocation
<span class="lineNum">      71 </span>            :   // I/O configuration which we don't care about
<span class="lineNum">      72 </span><span class="lineCov">          1 :   fTrapConfig-&gt;SetTrapRegAlloc(AliTRDtrapConfig::kSEBDOU, AliTRDtrapConfig::kAllocNone);</span>
<span class="lineNum">      73 </span>            :   // position look-up table by layer
<span class="lineNum">      74 </span><span class="lineCov">        258 :   for (Int_t iBin = 0; iBin &lt; 128; iBin++)</span>
<span class="lineNum">      75 </span><span class="lineCov">        128 :     fTrapConfig-&gt;SetTrapRegAlloc((AliTRDtrapConfig::TrapReg_t) (AliTRDtrapConfig::kTPL00 + iBin), AliTRDtrapConfig::kAllocByLayer);</span>
<span class="lineNum">      76 </span>            :   // ... individual
<span class="lineNum">      77 </span><span class="lineCov">          1 :   fTrapConfig-&gt;SetTrapRegAlloc(AliTRDtrapConfig::kC14CPUA, AliTRDtrapConfig::kAllocByMCM);</span>
<span class="lineNum">      78 </span><span class="lineCov">          1 :   fTrapConfig-&gt;SetTrapRegAlloc(AliTRDtrapConfig::kC15CPUA, AliTRDtrapConfig::kAllocByMCM);</span>
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span>            :   // setup of DMEM allocation
<span class="lineNum">      81 </span><span class="lineCov">       2050 :   for(Int_t iAddr = AliTRDtrapConfig::fgkDmemStartAddress;</span>
<span class="lineNum">      82 </span><span class="lineCov">       2049 :             iAddr &lt; (AliTRDtrapConfig::fgkDmemWords + AliTRDtrapConfig::fgkDmemStartAddress); iAddr++) {</span>
<span class="lineNum">      83 </span>            : 
<span class="lineNum">      84 </span><span class="lineCov">       1024 :     if(iAddr == AliTRDmcmSim::fgkDmemAddrDeflCorr)</span>
<span class="lineNum">      85 </span><span class="lineCov">          1 :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocByMCMinSM);</span>
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span><span class="lineCov">       1023 :     else if(iAddr == AliTRDmcmSim::fgkDmemAddrNdrift)</span>
<span class="lineNum">      88 </span><span class="lineCov">          1 :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocByDetector);</span>
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span><span class="lineCov">       1022 :     else if((iAddr &gt;= AliTRDmcmSim::fgkDmemAddrDeflCutStart) &amp;&amp; (iAddr &lt;= AliTRDmcmSim::fgkDmemAddrDeflCutEnd))</span>
<span class="lineNum">      91 </span><span class="lineCov">         38 :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocByMCMinSM);</span>
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span><span class="lineCov">        984 :     else if((iAddr &gt;= AliTRDmcmSim::fgkDmemAddrTrackletStart) &amp;&amp; (iAddr &lt;= AliTRDmcmSim::fgkDmemAddrTrackletEnd))</span>
<span class="lineNum">      94 </span><span class="lineCov">          4 :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocByMCM);</span>
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span><span class="lineCov">        980 :     else if((iAddr &gt;= AliTRDmcmSim::fgkDmemAddrLUTStart) &amp;&amp; (iAddr &lt;= AliTRDmcmSim::fgkDmemAddrLUTEnd))</span>
<span class="lineNum">      97 </span><span class="lineCov">        768 :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocGlobal);</span>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineCov">        212 :     else if(iAddr == AliTRDmcmSim::fgkDmemAddrLUTcor0)</span>
<span class="lineNum">     100 </span><span class="lineCov">          1 :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocByMCMinSM);</span>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span><span class="lineCov">        422 :     else if(iAddr == AliTRDmcmSim::fgkDmemAddrLUTcor1)</span>
<span class="lineNum">     103 </span><span class="lineCov">        212 :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocByMCMinSM);</span>
<span class="lineNum">     104 </span>            : 
<span class="lineNum">     105 </span>            :     else if(iAddr == AliTRDmcmSim::fgkDmemAddrLUTnbins)
<span class="lineNum">     106 </span><span class="lineCov">        210 :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocGlobal);</span>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span>            :     else if(iAddr == AliTRDmcmSim::fgkDmemAddrLUTLength)
<span class="lineNum">     109 </span>            :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocGlobal);
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span>            :     else
<span class="lineNum">     112 </span>            :       fTrapConfig-&gt;SetDmemAlloc(iAddr, AliTRDtrapConfig::kAllocGlobal);
<span class="lineNum">     113 </span>            :   }
<a name="114"><span class="lineNum">     114 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span>            : void AliTRDtrapConfigHandler::ResetMCMs()
<span class="lineNum">     117 </span>            : {
<span class="lineNum">     118 </span>            :    //
<span class="lineNum">     119 </span>            :    // Reset all MCM registers and DMEM
<span class="lineNum">     120 </span>            :    //
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :   if (!fTrapConfig) {</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :     AliError(&quot;No TRAPconfig given&quot;);</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     125 </span>            :   }
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :    fTrapConfig-&gt;ResetRegs();</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :    fTrapConfig-&gt;ResetDmem();</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 : }</span>
<a name="130"><span class="lineNum">     130 </span>            : </a>
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span>            : Int_t AliTRDtrapConfigHandler::LoadConfig()
<span class="lineNum">     133 </span>            : {
<span class="lineNum">     134 </span>            :   // load a default configuration which is suitable for simulation
<span class="lineNum">     135 </span>            :   // for a detailed description of the registers see the TRAP manual
<span class="lineNum">     136 </span>            :   // if you want to resimulate tracklets on real data use the appropriate config instead
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span><span class="lineCov">          2 :   if (!fTrapConfig) {</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :     AliError(&quot;No TRAPconfig given&quot;);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :     return -1;</span>
<span class="lineNum">     141 </span>            :   }
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span>            :   // prepare ltuParam
<span class="lineNum">     144 </span>            :   // ndrift (+ 5 binary digits)
<span class="lineNum">     145 </span><span class="lineCov">          1 :   ltuParam.SetNtimebins(20 &lt;&lt; 5);</span>
<span class="lineNum">     146 </span>            :   // deflection + tilt correction
<span class="lineNum">     147 </span><span class="lineCov">          1 :   ltuParam.SetRawOmegaTau(0.16133);</span>
<span class="lineNum">     148 </span>            :   // deflection range table
<span class="lineNum">     149 </span><span class="lineCov">          1 :   ltuParam.SetRawPtMin(0.1);</span>
<span class="lineNum">     150 </span>            :   // magnetic field
<span class="lineNum">     151 </span><span class="lineCov">          1 :   ltuParam.SetRawMagField(0.0);</span>
<span class="lineNum">     152 </span>            :   // scaling factors for q0, q1
<span class="lineNum">     153 </span><span class="lineCov">          1 :   ltuParam.SetRawScaleQ0(0);</span>
<span class="lineNum">     154 </span><span class="lineCov">          1 :   ltuParam.SetRawScaleQ1(0);</span>
<span class="lineNum">     155 </span>            :   // disable length correction and tilting correction
<span class="lineNum">     156 </span><span class="lineCov">          1 :   ltuParam.SetRawLengthCorrectionEnable(kFALSE);</span>
<span class="lineNum">     157 </span><span class="lineCov">          1 :   ltuParam.SetRawTiltCorrectionEnable(kFALSE);</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineCov">       1082 :   for (Int_t iDet = 0; iDet &lt; 540; iDet++) {</span>
<span class="lineNum">     160 </span>            :     // HC header configuration bits
<span class="lineNum">     161 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kC15CPUA, 0x2102, iDet); // zs, deh</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span>            :     // no. of timebins
<span class="lineNum">     164 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kC13CPUA, 24, iDet);</span>
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            :     // pedestal filter
<span class="lineNum">     167 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFPNP, 4*10, iDet);</span>
<span class="lineNum">     168 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFPTC, 0, iDet);</span>
<span class="lineNum">     169 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFPBY, 0, iDet); // bypassed!</span>
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span>            :     // gain filter
<span class="lineNum">     172 </span><span class="lineCov">      22680 :     for (Int_t adc = 0; adc &lt; 20; adc++) {</span>
<span class="lineNum">     173 </span><span class="lineCov">      10800 :       fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::TrapReg_t(AliTRDtrapConfig::kFGA0+adc), 40, iDet);</span>
<span class="lineNum">     174 </span><span class="lineCov">      10800 :       fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::TrapReg_t(AliTRDtrapConfig::kFGF0+adc), 15, iDet);</span>
<span class="lineNum">     175 </span>            :     }
<span class="lineNum">     176 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFGTA, 20, iDet);</span>
<span class="lineNum">     177 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFGTB, 2060, iDet);</span>
<span class="lineNum">     178 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFGBY, 0, iDet);  // bypassed!</span>
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span>            :     // tail cancellation
<span class="lineNum">     181 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFTAL, 200, iDet);</span>
<span class="lineNum">     182 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFTLL, 0, iDet);</span>
<span class="lineNum">     183 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFTLS, 200, iDet);</span>
<span class="lineNum">     184 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kFTBY, 0, iDet);</span>
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span>            :     // tracklet calculation
<span class="lineNum">     187 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPQS0, 5, iDet);</span>
<span class="lineNum">     188 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPQE0, 10, iDet);</span>
<span class="lineNum">     189 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPQS1, 11, iDet);</span>
<span class="lineNum">     190 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPQE1, 20, iDet);</span>
<span class="lineNum">     191 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPFS, 5, iDet);</span>
<span class="lineNum">     192 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPFE, 20, iDet);</span>
<span class="lineNum">     193 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPVBY, 0, iDet);</span>
<span class="lineNum">     194 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPVT, 10, iDet);</span>
<span class="lineNum">     195 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPHT, 150, iDet);</span>
<span class="lineNum">     196 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPFP, 40, iDet);</span>
<span class="lineNum">     197 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPCL, 1, iDet);</span>
<span class="lineNum">     198 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kTPCT, 10, iDet);</span>
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            :     // apply ltuParams
<span class="lineNum">     201 </span><span class="lineCov">        540 :     ConfigureDyCorr(iDet);</span>
<span class="lineNum">     202 </span><span class="lineCov">        540 :     ConfigureDRange(iDet); // deflection range</span>
<span class="lineNum">     203 </span><span class="lineCov">        540 :     ConfigureNTimebins(iDet);  // timebins in the drift region</span>
<span class="lineNum">     204 </span><span class="lineCov">        540 :     ConfigurePIDcorr(iDet);  // scaling parameters for the PID</span>
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span>            :     // event buffer
<span class="lineNum">     207 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kEBSF, 1, iDet);  // 0: store filtered; 1: store unfiltered</span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span>            :     // zs applied to data stored in event buffer (sel. by EBSF)
<span class="lineNum">     210 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kEBIS, 15, iDet); // single indicator threshold (plus two digits)</span>
<span class="lineNum">     211 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kEBIT, 30, iDet); // sum indicator threshold (plus two digits)</span>
<span class="lineNum">     212 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kEBIL, 0xf0, iDet);   // lookup table</span>
<span class="lineNum">     213 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kEBIN, 0, iDet);      // neighbour sensitivity</span>
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span>            :     // raw data
<span class="lineNum">     216 </span><span class="lineCov">        540 :     fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kNES, (0x0000 &lt;&lt; 16) | 0x1000, iDet);</span>
<span class="lineNum">     217 </span>            :   }
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span>            :   // ****** hit position LUT
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            :   // now calculate it from PRF
<span class="lineNum">     222 </span><span class="lineCov">          1 :   AliTRDcalibDB *cal = AliTRDcalibDB::Instance();</span>
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span><span class="lineCov">          1 :   Double_t padResponse[3]; // pad response left, central, right</span>
<span class="lineNum">     225 </span><span class="lineCov">          1 :   Double_t padResponseR[3]; // pad response left, central, right</span>
<span class="lineNum">     226 </span><span class="lineCov">          1 :   Double_t padResponseL[3]; // pad response left, central, right</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineCov">         14 :   for (Int_t iLayer = 0; iLayer &lt; 6; iLayer++) {</span>
<span class="lineNum">     229 </span><span class="lineCov">          6 :     TGraph gr(128);</span>
<span class="lineNum">     230 </span><span class="lineCov">       1548 :     for (Int_t iBin = 0; iBin &lt; 256*0.5; iBin++) {</span>
<span class="lineNum">     231 </span><span class="lineCov">        768 :       cal-&gt;PadResponse(1., iBin*1./256.,    iLayer, padResponse);</span>
<span class="lineNum">     232 </span><span class="lineCov">        768 :       cal-&gt;PadResponse(1., iBin*1./256.-1., iLayer, padResponseR);</span>
<span class="lineNum">     233 </span><span class="lineCov">        768 :       cal-&gt;PadResponse(1., iBin*1./256.+1., iLayer, padResponseL);</span>
<span class="lineNum">     234 </span><span class="lineCov">        768 :       gr.SetPoint(iBin, (0.5 * (padResponseR[1] - padResponseL[1])/padResponse[1] * 256), iBin);</span>
<span class="lineNum">     235 </span>            :     }
<span class="lineNum">     236 </span><span class="lineCov">       1548 :     for (Int_t iBin = 0; iBin &lt; 128; iBin++) {</span>
<span class="lineNum">     237 </span><span class="lineCov">       1536 :       Int_t corr = (Int_t) (gr.Eval(iBin)) - iBin;</span>
<span class="lineNum">     238 </span><span class="lineCov">        768 :       if (corr &lt; 0)</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :         corr = 0;</span>
<span class="lineNum">     240 </span><span class="lineCov">        768 :       else if (corr &gt; 31)</span>
<span class="lineNum">     241 </span><span class="lineCov">          4 :         corr = 31;</span>
<span class="lineNum">     242 </span><span class="lineCov">     139776 :       for (Int_t iStack = 0; iStack &lt; 540/6; iStack++) {</span>
<span class="lineNum">     243 </span><span class="lineCov">      69120 :         fTrapConfig-&gt;SetTrapReg((AliTRDtrapConfig::TrapReg_t) (AliTRDtrapConfig::kTPL00 + iBin), corr, 6*iStack + iLayer);</span>
<span class="lineNum">     244 </span>            :       }
<span class="lineNum">     245 </span>            :     }
<span class="lineNum">     246 </span><span class="lineCov">          6 :   }</span>
<span class="lineNum">     247 </span>            :   // ****** hit position LUT configuration end
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span>            :   return 0;
<span class="lineNum">     250 </span><span class="lineCov">          2 : }</span>
<a name="251"><span class="lineNum">     251 </span>            : </a>
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span>            : Int_t AliTRDtrapConfigHandler::LoadConfig(TString filename)
<span class="lineNum">     254 </span>            : {
<span class="lineNum">     255 </span>            :    //
<span class="lineNum">     256 </span>            :   // load a TRAP configuration from a file
<span class="lineNum">     257 </span>            :    // The file format is the format created by the standalone
<span class="lineNum">     258 </span>            :    // command coder scc / show_cfdat but without the running number
<span class="lineNum">     259 </span>            :    // scc /show_cfdat adds as the first column
<span class="lineNum">     260 </span>            :    // which are two tools to inspect/export configurations from wingDB
<span class="lineNum">     261 </span>            :    //
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :   if (!fTrapConfig) {</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     AliError(&quot;No TRAPconfig given&quot;);</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     return -1;</span>
<span class="lineNum">     266 </span>            :   }
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span>            :    Int_t ignoredLines=0;
<span class="lineNum">     269 </span>            :    Int_t ignoredCmds=0;
<span class="lineNum">     270 </span>            :    Int_t readLines=0;
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :    AliDebug(5, Form(&quot;Processing file %s&quot;, filename.Data()));</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :    std::ifstream infile;</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :    infile.open(filename.Data(), std::ifstream::in);</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :    if (!infile.is_open()) {</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Can not open MCM configuration file %s&quot;, filename.Data()));</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     279 </span>            :    }
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :    UInt_t cmd;</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :    Int_t extali, addr, data;</span>
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span>            :    // reset restrictive mask
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :    fRestrictiveMask = (0x3ffff &lt;&lt; 11) | (0x1f &lt;&lt; 6) | 0x3f;</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :    char linebuffer[512];</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :    istringstream line;</span>
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :    while(infile.getline(linebuffer, 512) &amp;&amp; infile.good()) {</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :       line.clear();</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :       line.str(linebuffer);</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :       cmd=999;</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :       extali=-1;</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :       addr=-1;</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :       data=-1;</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :       line &gt;&gt; std::skipws &gt;&gt; cmd &gt;&gt; addr &gt;&gt; data &gt;&gt; extali;  // the lines read from config file can contain additional columns.</span>
<span class="lineNum">     297 </span>            :       // Therefore the detour via istringstream
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :       if(cmd!=999 &amp;&amp; addr != -1 &amp;&amp; data!= -1 &amp;&amp; extali!=-1) {</span>
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :          if(cmd==fgkScsnCmdWrite) {</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :             for(Int_t det=0; det&lt;AliTRDgeometry::Ndet(); det++) {</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :                UInt_t rocpos = (1 &lt;&lt; (AliTRDgeometry::GetSector(det)+11)) | (1 &lt;&lt; (AliTRDgeometry::GetStack(det)+6)) | (1 &lt;&lt; AliTRDgeometry::GetLayer(det));</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :                AliDebug(1, Form(&quot;checking restriction: mask=0x%08x, rocpos=0x%08x&quot;, fRestrictiveMask, rocpos));</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :                if ((fRestrictiveMask &amp; rocpos) == rocpos) {</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :                  AliDebug(1, Form(&quot;match: %i %i %i %i&quot;, cmd, extali, addr, data));</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :                   AddValues(det, cmd, extali, addr, data);</span>
<span class="lineNum">     308 </span>            :                }
<span class="lineNum">     309 </span>            :             }
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :          else if(cmd == fgkScsnLTUparam) {</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :             ProcessLTUparam(extali, addr, data);</span>
<span class="lineNum">     314 </span>            :          }
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :          else if(cmd == fgkScsnCmdRestr) {</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :             fRestrictiveMask = data;</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :            AliDebug(1, Form(&quot;updated restrictive mask to 0x%08x&quot;, fRestrictiveMask));</span>
<span class="lineNum">     319 </span>            :          }
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :          else if((cmd == fgkScsnCmdReset) ||</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :                  (cmd == fgkScsnCmdRobReset)) {</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :            fTrapConfig-&gt;ResetRegs();</span>
<span class="lineNum">     324 </span>            :          }
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :          else if (cmd == fgkScsnCmdSetHC) {</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :            Int_t fullVersion = ((data &amp; 0x7F00) &gt;&gt; 1) | (data &amp; 0x7f);</span>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :            for (Int_t iDet = 0; iDet &lt; AliTRDgeometry::Ndet(); iDet++) {</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :              Int_t smls = (AliTRDgeometry::GetSector(iDet) &lt;&lt; 6) | (AliTRDgeometry::GetLayer(iDet) &lt;&lt; 3) | AliTRDgeometry::GetStack(iDet);</span>
<span class="lineNum">     331 </span>            : 
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :              for (Int_t iRob = 0; iRob &lt; 8; iRob++) {</span>
<span class="lineNum">     333 </span>            :                // HC mergers
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :                fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kC14CPUA, 0xc &lt;&lt; 16, iDet, iRob, 17);</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :                fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kC15CPUA, ((1&lt;&lt;29) | (fullVersion&lt;&lt;15) | (1&lt;&lt;12) | (smls&lt;&lt;1) | (iRob%2)), iDet, iRob, 17);</span>
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span>            :                // board mergers
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kC14CPUA, 0, iDet, iRob, 16);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :                fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kC15CPUA, ((1&lt;&lt;29) | (fullVersion&lt;&lt;15) | (1&lt;&lt;12) | (smls&lt;&lt;1) | (iRob%2)), iDet, iRob, 16);</span>
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            :                // and now for the others
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                for (Int_t iMcm = 0; iMcm &lt; 16; iMcm++) {</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :                  fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kC14CPUA, iMcm | (iRob &lt;&lt; 4) | (3 &lt;&lt; 16), iDet, iRob, iMcm);</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :                  fTrapConfig-&gt;SetTrapReg(AliTRDtrapConfig::kC15CPUA, ((1&lt;&lt;29) | (fullVersion&lt;&lt;15) | (1&lt;&lt;12) | (smls&lt;&lt;1) | (iRob%2)), iDet, iRob, iMcm);</span>
<span class="lineNum">     345 </span>            :                }
<span class="lineNum">     346 </span>            :              }
<span class="lineNum">     347 </span>            :            }
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :          else if((cmd == fgkScsnCmdRead) ||</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :                  (cmd == fgkScsnCmdPause) ||</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :                  (cmd == fgkScsnCmdPtrg) ||</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :                  (cmd == fgkScsnCmdHwPtrg) ||</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :                  (cmd == fgkScsnCmdRobPower) ||</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :                  (cmd == fgkScsnCmdTtcRx) ||</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :                  (cmd == fgkScsnCmdMcmTemp) ||</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :                  (cmd == fgkScsnCmdOri) ||</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :                  (cmd == fgkScsnCmdPM) ) {</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :            AliDebug(2, Form(&quot;ignored SCSN command: %i %i %i %i&quot;, cmd, addr, data, extali));</span>
<span class="lineNum">     360 </span>            :          }
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span>            :          else {
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :             AliWarning(Form(&quot;unknown SCSN command: %i %i %i %i&quot;, cmd, addr, data, extali));</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :             ignoredCmds++;</span>
<span class="lineNum">     365 </span>            :          }
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :          readLines++;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :       else if(!infile.eof() &amp;&amp; !infile.good()) {</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :          infile.clear();</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :          infile.ignore(256, '\n');</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :          ignoredLines++;</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :       if(!infile.eof())</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :          infile.clear();</span>
<span class="lineNum">     378 </span>            :    }
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :    infile.close();</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :    AliDebug(5, Form(&quot;Ignored lines: %i, ignored cmds: %i&quot;, ignoredLines, ignoredCmds));</span>
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :    if(ignoredLines&gt;readLines)</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :       AliError(Form(&quot;More than 50 %% of the input file could not be processed. Perhaps you should check the input file %s&quot;, filename.Data()));</span>
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            :    return kTRUE;
<span class="lineNum">     390 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     391 </span>            : 
<a name="392"><span class="lineNum">     392 </span>            : </a>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span>            : Int_t AliTRDtrapConfigHandler::SetGaintable(AliTRDCalOnlineGainTable const &amp;gtbl)
<span class="lineNum">     395 </span>            : {
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :    fGtbl=gtbl;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :    return 0;</span>
<span class="lineNum">     398 </span>            : }
<a name="399"><span class="lineNum">     399 </span>            : </a>
<span class="lineNum">     400 </span>            : 
<span class="lineNum">     401 </span>            : void AliTRDtrapConfigHandler::ProcessLTUparam(Int_t dest, Int_t addr, UInt_t data)
<span class="lineNum">     402 </span>            : {
<span class="lineNum">     403 </span>            :    //
<span class="lineNum">     404 </span>            :    // Process the LTU parameters and stores them in internal class variables
<span class="lineNum">     405 </span>            :    // or transfer the stored values to AliTRDtrapConfig, depending on the dest parameter
<span class="lineNum">     406 </span>            :    //
<span class="lineNum">     407 </span>            : 
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :    switch (dest) {</span>
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span>            :    case 0: // set the parameters in AliTRDtrapConfig
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :       for(Int_t det=0; det&lt;AliTRDgeometry::Ndet(); det++) {</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :          ConfigureDyCorr(det);</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :          ConfigureDRange(det); // deflection range</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :          ConfigureNTimebins(det);  // timebins in the drift region</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :          ConfigurePIDcorr(det);  // scaling parameters for the PID</span>
<span class="lineNum">     416 </span>            :       }
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span>            :    case 1: // set variables
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :       switch (addr) {</span>
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :       case 0: ltuParam.SetPtMin(data); break; // pt_min in GeV/c (*1000)</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :       case 1: ltuParam.SetMagField(data); break; // B in T (*1000)</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :       case 2: ltuParam.SetOmegaTau(data); break; // omega*tau</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :       case 3: ltuParam.SetNtimebins(data); break;</span>
<span class="lineNum">     426 </span>            :         // ntimbins: drift time (for 3 cm) in timebins (5 add. bin. digits)
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :       case 4: ltuParam.SetScaleQ0(data); break;</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :       case 5: ltuParam.SetScaleQ1(data); break;</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :       case 6: ltuParam.SetLengthCorrectionEnable(data); break;</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :       case 7: ltuParam.SetTiltCorrectionEnable(data); break;</span>
<span class="lineNum">     431 </span>            :       }
<span class="lineNum">     432 </span>            :       break;
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span>            :    default:
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :       AliError(Form(&quot;dest %i not implemented&quot;, dest));</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span><span class="lineNoCov">          0 : }</span>
<a name="439"><span class="lineNum">     439 </span>            : </a>
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span>            : void AliTRDtrapConfigHandler::ConfigureNTimebins(Int_t det)
<span class="lineNum">     442 </span>            : {
<span class="lineNum">     443 </span>            :    //
<span class="lineNum">     444 </span>            :    // Set timebins in the drift region
<span class="lineNum">     445 </span>            :    //
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineCov">       1080 :   if (!fTrapConfig) {</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     AliError(&quot;No TRAPconfig given&quot;);</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     450 </span>            :   }
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineCov">        540 :   AddValues(det, fgkScsnCmdWrite, 127, AliTRDmcmSim::fgkDmemAddrNdrift, ltuParam.GetNtimebins());</span>
<span class="lineNum">     453 </span><span class="lineCov">       1080 : }</span>
<span class="lineNum">     454 </span>            : 
<a name="455"><span class="lineNum">     455 </span>            : </a>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span>            : void AliTRDtrapConfigHandler::ConfigureDyCorr(Int_t det)
<span class="lineNum">     458 </span>            : {
<span class="lineNum">     459 </span>            :    //
<span class="lineNum">     460 </span>            :    //  Deflection length correction
<span class="lineNum">     461 </span>            :    //  due to Lorentz angle and tilted pad correction
<span class="lineNum">     462 </span>            :    //  This correction is in units of padwidth / (256*32)
<span class="lineNum">     463 </span>            :    //
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span><span class="lineCov">       1080 :   if (!fTrapConfig) {</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :     AliError(&quot;No TRAPconfig given&quot;);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     468 </span>            :   }
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span><span class="lineCov">        540 :    Int_t nRobs = AliTRDgeometry::GetStack(det) == 2 ? 6 : 8;</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span><span class="lineCov">       9288 :   for (Int_t r = 0; r &lt; nRobs; r++) {</span>
<span class="lineNum">     473 </span><span class="lineCov">     139536 :     for (Int_t m = 0; m &lt; 16; m++) {</span>
<span class="lineNum">     474 </span><span class="lineCov">      65664 :       Int_t dest =  1&lt;&lt;10 | r&lt;&lt;7 | m;</span>
<span class="lineNum">     475 </span><span class="lineCov">      65664 :       Int_t dyCorrInt = ltuParam.GetDyCorrection(det, r, m);</span>
<span class="lineNum">     476 </span><span class="lineCov">      65664 :       AddValues(det, fgkScsnCmdWrite, dest, AliTRDmcmSim::fgkDmemAddrDeflCorr, dyCorrInt);</span>
<span class="lineNum">     477 </span>            :     }
<span class="lineNum">     478 </span>            :   }
<span class="lineNum">     479 </span><span class="lineCov">       1080 : }</span>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span>            : 
<a name="483"><span class="lineNum">     483 </span>            : </a>
<span class="lineNum">     484 </span>            : 
<span class="lineNum">     485 </span>            : void AliTRDtrapConfigHandler::ConfigureDRange(Int_t det)
<span class="lineNum">     486 </span>            : {
<span class="lineNum">     487 </span>            :    //
<span class="lineNum">     488 </span>            :    // deflection range LUT
<span class="lineNum">     489 </span>            :    // range calculated according to B-field (in T) and pt_min (in GeV/c)
<span class="lineNum">     490 </span>            :    // if pt_min &lt; 0.1 GeV/c the maximal allowed range for the tracklet
<span class="lineNum">     491 </span>            :    // deflection (-64..63) is used
<span class="lineNum">     492 </span>            :    //
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span><span class="lineCov">       1080 :   if (!fTrapConfig) {</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     AliError(&quot;No TRAPconfig given&quot;);</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     497 </span>            :   }
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span><span class="lineCov">        540 :   Int_t nRobs = AliTRDgeometry::GetStack(det) == 2 ? 6 : 8;</span>
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span><span class="lineCov">        540 :   Int_t dyMinInt;</span>
<span class="lineNum">     502 </span><span class="lineCov">        540 :   Int_t dyMaxInt;</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineCov">       9288 :    for (Int_t r = 0; r &lt; nRobs; r++) {</span>
<span class="lineNum">     505 </span><span class="lineCov">     139536 :       for (Int_t m = 0; m &lt; 16; m++) {</span>
<span class="lineNum">     506 </span><span class="lineCov">    2495232 :          for (Int_t c = 0; c &lt; 18; c++) {</span>
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span>            :            // cout &lt;&lt; &quot;maxdefl: &quot; &lt;&lt; maxDeflAngle &lt;&lt; &quot;, localPhi &quot; &lt;&lt; localPhi &lt;&lt; endl;
<span class="lineNum">     509 </span>            :            // cout &lt;&lt; &quot;r &quot; &lt;&lt; r &lt;&lt; &quot;, m&quot; &lt;&lt; m &lt;&lt; &quot;, c &quot; &lt;&lt; c &lt;&lt; &quot;, min angle: &quot; &lt;&lt; localPhi-maxDeflAngle &lt;&lt; &quot;, max: &quot; &lt;&lt; localPhi+maxDeflAngle
<span class="lineNum">     510 </span>            :            //   &lt;&lt; &quot;, min int: &quot; &lt;&lt; dyMinInt &lt;&lt; &quot;, max int: &quot; &lt;&lt; dyMaxInt &lt;&lt; endl;
<span class="lineNum">     511 </span><span class="lineCov">    1181952 :            Int_t dest =  1&lt;&lt;10 | r&lt;&lt;7 | m;</span>
<span class="lineNum">     512 </span><span class="lineCov">    1181952 :            Int_t lutAddr = AliTRDmcmSim::fgkDmemAddrDeflCutStart + 2*c;</span>
<span class="lineNum">     513 </span><span class="lineCov">    1181952 :            ltuParam.GetDyRange(det, r, m, c, dyMinInt, dyMaxInt);</span>
<span class="lineNum">     514 </span><span class="lineCov">    1181952 :            AddValues(det, fgkScsnCmdWrite, dest, lutAddr+0, dyMinInt);</span>
<span class="lineNum">     515 </span><span class="lineCov">    1181952 :            AddValues(det, fgkScsnCmdWrite, dest, lutAddr+1, dyMaxInt);</span>
<span class="lineNum">     516 </span>            :          }
<span class="lineNum">     517 </span>            :       }
<span class="lineNum">     518 </span>            :    }
<a name="519"><span class="lineNum">     519 </span><span class="lineCov">       1080 : }</span></a>
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span>            : void AliTRDtrapConfigHandler::PrintGeoTest()
<span class="lineNum">     522 </span>            : {
<span class="lineNum">     523 </span>            :    //
<span class="lineNum">     524 </span>            :    // Prints some information about the geometry. Only for debugging
<span class="lineNum">     525 </span>            :    //
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span>            :    int sm=0;
<span class="lineNum">     528 </span>            :    //   for(int sm=0; sm&lt;6; sm++) {
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :    for(int stack=0; stack&lt;5; stack++) {</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :       for(int layer=0; layer&lt;6; layer++) {</span>
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :          Int_t det = sm*30+stack*6+layer;</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :          for (Int_t r = 0; r &lt; 6; r++) {</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :             for (Int_t m = 0; m &lt; 16; m++) {</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :                for (Int_t c = 7; c &lt; 8; c++) {</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :                  cout &lt;&lt; stack &lt;&lt; &quot;;&quot; &lt;&lt; layer &lt;&lt; &quot;;&quot; &lt;&lt; r &lt;&lt; &quot;;&quot; &lt;&lt; m</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :                       &lt;&lt; &quot;;&quot; &lt;&lt; ltuParam.GetX(det, r, m)</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :                       &lt;&lt; &quot;;&quot; &lt;&lt; ltuParam.GetLocalY(det, r, m, c)</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :                       &lt;&lt; &quot;;&quot; &lt;&lt; ltuParam.GetLocalZ(det, r, m) &lt;&lt; endl;</span>
<span class="lineNum">     540 </span>            :                }
<span class="lineNum">     541 </span>            :             }
<span class="lineNum">     542 </span>            :          }
<span class="lineNum">     543 </span>            :       }
<span class="lineNum">     544 </span>            :    }
<span class="lineNum">     545 </span>            :    // }
<span class="lineNum">     546 </span><span class="lineNoCov">          0 : }</span>
<a name="547"><span class="lineNum">     547 </span>            : </a>
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span>            : void AliTRDtrapConfigHandler::ConfigurePIDcorr(Int_t det)
<span class="lineNum">     550 </span>            : {
<span class="lineNum">     551 </span>            :    //
<span class="lineNum">     552 </span>            :    // Calculate the MCM individual correction factors for the PID
<span class="lineNum">     553 </span>            :    // and transfer them to AliTRDtrapConfig
<span class="lineNum">     554 </span>            :    //
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span><span class="lineCov">       1080 :   if (!fTrapConfig) {</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :     AliError(&quot;No TRAPconfig given&quot;);</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     559 </span>            :   }
<span class="lineNum">     560 </span>            : 
<span class="lineNum">     561 </span>            :    static const Int_t addrLUTcor0 = AliTRDmcmSim::fgkDmemAddrLUTcor0;
<span class="lineNum">     562 </span>            :    static const Int_t addrLUTcor1 = AliTRDmcmSim::fgkDmemAddrLUTcor1;
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineCov">        540 :    UInt_t cor0;</span>
<span class="lineNum">     565 </span><span class="lineCov">        540 :    UInt_t cor1;</span>
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span><span class="lineCov">        540 :    Int_t nRobs = AliTRDgeometry::GetStack(det) == 2 ? 6 : 8;</span>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineCov">       9288 :    for (Int_t r=0; r&lt;nRobs; r++) {</span>
<span class="lineNum">     570 </span><span class="lineCov">     139536 :       for(Int_t m=0; m&lt;16; m++) {</span>
<span class="lineNum">     571 </span><span class="lineCov">      65664 :          Int_t dest =  1&lt;&lt;10 | r&lt;&lt;7 | m;</span>
<span class="lineNum">     572 </span><span class="lineCov">      65664 :          if(fGtbl.GetGainTableROC(det) &amp;&amp; fGtbl.GetGainTableROC(det)-&gt;GetGainTableMCM(r, m))</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :             ltuParam.GetCorrectionFactors(det, r, m, 9, cor0, cor1, fGtbl.GetGainTableROC(det)-&gt;GetGainTableMCM(r, m)-&gt;GetMCMGain());</span>
<span class="lineNum">     574 </span>            :          else
<span class="lineNum">     575 </span><span class="lineCov">      65664 :             ltuParam.GetCorrectionFactors(det, r, m, 9, cor0, cor1);</span>
<span class="lineNum">     576 </span><span class="lineCov">      65664 :          AddValues(det, fgkScsnCmdWrite, dest, addrLUTcor0, cor0);</span>
<span class="lineNum">     577 </span><span class="lineCov">      65664 :          AddValues(det, fgkScsnCmdWrite, dest, addrLUTcor1, cor1);</span>
<span class="lineNum">     578 </span>            :     }
<span class="lineNum">     579 </span>            :   }
<span class="lineNum">     580 </span><span class="lineCov">       1080 : }</span>
<a name="581"><span class="lineNum">     581 </span>            : </a>
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span>            : Bool_t AliTRDtrapConfigHandler::AddValues(UInt_t det, UInt_t cmd, UInt_t extali, Int_t addr, UInt_t data)
<span class="lineNum">     584 </span>            : {
<span class="lineNum">     585 </span>            :    // transfer the informations provided by LoadConfig to the internal class variables
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span><span class="lineCov">    5122872 :   if (!fTrapConfig) {</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :     AliError(&quot;No TRAPconfig given&quot;);</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     590 </span>            :   }
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineCov">    2561436 :   if(cmd != fgkScsnCmdWrite) {</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Invalid command received: %i&quot;, cmd));</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     595 </span>            :   }
<span class="lineNum">     596 </span>            : 
<span class="lineNum">     597 </span><span class="lineCov">    2561436 :   AliTRDtrapConfig::TrapReg_t mcmReg = fTrapConfig-&gt;GetRegByAddress(addr);</span>
<span class="lineNum">     598 </span><span class="lineCov">    2561436 :   Int_t rocType = AliTRDgeometry::GetStack(det) == 2 ? 0 : 1;</span>
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span>            :   static const int mcmListSize=40;  // 40 is more or less arbitrary
<span class="lineNum">     601 </span><span class="lineCov">    2561436 :   Int_t mcmList[mcmListSize];</span>
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span>            :   // configuration registers
<span class="lineNum">     604 </span><span class="lineCov">    2561436 :   if(mcmReg &gt;= 0 &amp;&amp; mcmReg &lt; AliTRDtrapConfig::kLastReg) {</span>
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :     for(Int_t linkPair=0; linkPair&lt;fgkMaxLinkPairs; linkPair++) {</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :       if(AliTRDfeeParam::ExtAliToAli(extali, linkPair, rocType, mcmList, mcmListSize)!=0) {</span>
<span class="lineNum">     608 </span>            :         Int_t i=0;
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :         while((i &lt; mcmListSize) &amp;&amp; (mcmList[i] != -1)) {</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :           if(mcmList[i]==127) {</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :             AliDebug(1, Form(&quot;broadcast write to %s: 0x%08x&quot;,</span>
<span class="lineNum">     612 </span>            :                              fTrapConfig-&gt;GetRegName((AliTRDtrapConfig::TrapReg_t) mcmReg), data));
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :             fTrapConfig-&gt;SetTrapReg( (AliTRDtrapConfig::TrapReg_t) mcmReg, data, det);</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">     615 </span>            :           else {
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :             AliDebug(1, Form(&quot;individual write to %s (%i, %i): 0x%08x&quot;,</span>
<span class="lineNum">     617 </span>            :                              fTrapConfig-&gt;GetRegName((AliTRDtrapConfig::TrapReg_t) mcmReg), (mcmList[i]&gt;&gt;7), (mcmList[i]&amp;0x7F), data));
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :             fTrapConfig-&gt;SetTrapReg( (AliTRDtrapConfig::TrapReg_t) mcmReg, data, det, (mcmList[i]&gt;&gt;7)&amp;0x7, (mcmList[i]&amp;0x7F));</span>
<span class="lineNum">     619 </span>            :           }
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :           i++;</span>
<span class="lineNum">     621 </span>            :         }
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     623 </span>            :     }
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :     return kTRUE;</span>
<span class="lineNum">     625 </span>            :   }
<span class="lineNum">     626 </span>            :   // DMEM
<span class="lineNum">     627 </span><span class="lineCov">    5122872 :   else if ( (addr &gt;= AliTRDtrapConfig::fgkDmemStartAddress) &amp;&amp;</span>
<span class="lineNum">     628 </span><span class="lineCov">    2561436 :             (addr &lt; (AliTRDtrapConfig::fgkDmemStartAddress + AliTRDtrapConfig::fgkDmemWords))) {</span>
<span class="lineNum">     629 </span><span class="lineCov">   25614360 :     for(Int_t linkPair=0; linkPair&lt;fgkMaxLinkPairs; linkPair++) {</span>
<span class="lineNum">     630 </span><span class="lineCov">   10245744 :       if(AliTRDfeeParam::ExtAliToAli(extali, linkPair, rocType, mcmList, mcmListSize)!=0) {</span>
<span class="lineNum">     631 </span>            :         Int_t i=0;
<span class="lineNum">     632 </span><span class="lineCov">   10252224 :         while(mcmList[i] != -1 &amp;&amp; i &lt; mcmListSize) {</span>
<span class="lineNum">     633 </span><span class="lineCov">    5126112 :           if(mcmList[i] == 127)</span>
<span class="lineNum">     634 </span><span class="lineCov">    2565216 :              fTrapConfig-&gt;SetDmem(addr, data, det, 0, 127);</span>
<span class="lineNum">     635 </span>            :           else
<span class="lineNum">     636 </span><span class="lineCov">    2560896 :              fTrapConfig-&gt;SetDmem(addr, data, det, mcmList[i] &gt;&gt; 7, mcmList[i] &amp; 0x7f);</span>
<span class="lineNum">     637 </span><span class="lineCov">    2563056 :           i++;</span>
<span class="lineNum">     638 </span>            :         }
<span class="lineNum">     639 </span><span class="lineCov">    2563056 :       }</span>
<span class="lineNum">     640 </span>            :     }
<span class="lineNum">     641 </span><span class="lineCov">    2561436 :     return kTRUE;</span>
<span class="lineNum">     642 </span>            :   }
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :   else if ( (addr &gt;= AliTRDtrapConfig::fgkImemStartAddress) &amp;&amp;</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :             (addr &lt; (AliTRDtrapConfig::fgkImemStartAddress + AliTRDtrapConfig::fgkImemWords))) {</span>
<span class="lineNum">     645 </span>            :     // IMEM is ignored for now
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :     return kTRUE;</span>
<span class="lineNum">     647 </span>            :   }
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :   else if ( (addr &gt;= AliTRDtrapConfig::fgkDbankStartAddress) &amp;&amp;</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :             (addr &lt; (AliTRDtrapConfig::fgkDbankStartAddress + AliTRDtrapConfig::fgkImemWords))) {</span>
<span class="lineNum">     650 </span>            :     // DBANK is ignored for now
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :     return kTRUE;</span>
<span class="lineNum">     652 </span>            :   }
<span class="lineNum">     653 </span>            :   else {
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Writing to unhandled address 0x%04x&quot;, addr));</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     656 </span>            :   }
<span class="lineNum">     657 </span><span class="lineCov">    5122872 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
