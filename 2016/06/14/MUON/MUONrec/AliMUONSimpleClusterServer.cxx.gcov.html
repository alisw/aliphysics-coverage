<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - MUON/MUONrec/AliMUONSimpleClusterServer.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">MUON/MUONrec</a> - AliMUONSimpleClusterServer.cxx<span style="font-size: 80%;"> (source / <a href="AliMUONSimpleClusterServer.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">136</td>
            <td class="headerCovTableEntry">198</td>
            <td class="headerCovTableEntryLo">68.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">10</td>
            <td class="headerCovTableEntry">15</td>
            <td class="headerCovTableEntryLo">66.7 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            : * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            : *                                                                        *
<span class="lineNum">       4 </span>            : * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            : * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            : *                                                                        *
<span class="lineNum">       7 </span>            : * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            : * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            : * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            : * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            : * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            : * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            : * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            : **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : // $Id$
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #include &quot;AliMUONSimpleClusterServer.h&quot;
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #include &quot;AliCodeTimer.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;AliMUONCluster.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;AliMUONConstants.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;AliMUONGeometryTransformer.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;AliMUONPad.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;AliMUONTriggerTrackToTrackerClusters.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;AliMUONVCluster.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;AliMUONVClusterFinder.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;AliMUONVClusterStore.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;AliMUONVDigitStore.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;AliMUONRecoParam.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;AliMpArea.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;AliMpDEIterator.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;AliMpDEManager.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;AliMpExMap.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;AliMpExMapIterator.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;AliMpPad.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;AliMpSegmentation.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;AliMpVSegmentation.h&quot;
<span class="lineNum">      40 </span>            : #include &lt;Riostream.h&gt;
<span class="lineNum">      41 </span>            : #include &lt;TObjArray.h&gt;
<span class="lineNum">      42 </span>            : #include &lt;TString.h&gt;
<span class="lineNum">      43 </span>            : #include &lt;float.h&gt;
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : /// \class AliMUONSimpleClusterServer
<span class="lineNum">      46 </span>            : ///
<span class="lineNum">      47 </span>            : /// Implementation of AliMUONVClusterServer interface
<span class="lineNum">      48 </span>            : /// 
<span class="lineNum">      49 </span>            : /// 
<span class="lineNum">      50 </span>            : /// \author Laurent Aphecetche, Subatech
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : using std::endl;
<a name="53"><span class="lineNum">      53 </span>            : using std::cout;</a>
<span class="lineNum">      54 </span>            : /// \cond CLASSIMP  
<span class="lineNum">      55 </span><span class="lineCov">         18 : ClassImp(AliMUONSimpleClusterServer)</span>
<span class="lineNum">      56 </span>            : /// \endcond
<span class="lineNum">      57 </span>            : 
<a name="58"><span class="lineNum">      58 </span>            : namespace</a>
<span class="lineNum">      59 </span>            : {
<span class="lineNum">      60 </span>            :   TString AsString(const AliMpArea&amp; area)
<span class="lineNum">      61 </span>            :   {
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :     return Form(&quot;(X,Y)=(%7.3f,%7.3f) (DX,DY)=(%7.3f,%7.3f)&quot;,</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :                 area.GetPositionX(),</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :                 area.GetPositionY(),</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :                 area.GetDimensionX(),  /// TBCL was Y !!!</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :                 area.GetDimensionY());</span>
<span class="lineNum">      67 </span>            :   }
<span class="lineNum">      68 </span>            : }
<a name="69"><span class="lineNum">      69 </span>            : </a>
<span class="lineNum">      70 </span>            : //_____________________________________________________________________________
<span class="lineNum">      71 </span>            : AliMUONSimpleClusterServer::AliMUONSimpleClusterServer(AliMUONVClusterFinder* clusterFinder,
<span class="lineNum">      72 </span>            :                                                        const AliMUONGeometryTransformer&amp; transformer)
<span class="lineNum">      73 </span><span class="lineCov">          2 : : AliMUONVClusterServer(),</span>
<span class="lineNum">      74 </span><span class="lineCov">          2 :   fDigitStore(0x0),</span>
<span class="lineNum">      75 </span><span class="lineCov">          2 :   fClusterFinder(clusterFinder),</span>
<span class="lineNum">      76 </span><span class="lineCov">          2 :   fkTransformer(transformer),</span>
<span class="lineNum">      77 </span><span class="lineCov">          2 :   fPads(),</span>
<span class="lineNum">      78 </span><span class="lineCov">          2 :   fTriggerTrackStore(0x0),</span>
<span class="lineNum">      79 </span><span class="lineCov">          2 :   fBypass(0x0)</span>
<span class="lineNum">      80 </span><span class="lineCov">         10 : {</span>
<span class="lineNum">      81 </span>            :     /// Ctor
<span class="lineNum">      82 </span>            :     /// Note that we take ownership of the clusterFinder
<span class="lineNum">      83 </span>            :     
<span class="lineNum">      84 </span><span class="lineCov">          6 :     fPads[0] = new AliMpExMap;</span>
<span class="lineNum">      85 </span><span class="lineCov">          6 :     fPads[1] = new AliMpExMap;</span>
<span class="lineNum">      86 </span>            :     
<span class="lineNum">      87 </span><span class="lineCov">          4 :     fPadsIterator[0] = fPads[0]-&gt;CreateIterator();</span>
<span class="lineNum">      88 </span><span class="lineCov">          4 :     fPadsIterator[1] = fPads[1]-&gt;CreateIterator();</span>
<span class="lineNum">      89 </span><span class="lineCov">          4 : }</span>
<a name="90"><span class="lineNum">      90 </span>            : </a>
<span class="lineNum">      91 </span>            : //_____________________________________________________________________________
<span class="lineNum">      92 </span>            : AliMUONSimpleClusterServer::~AliMUONSimpleClusterServer()
<span class="lineNum">      93 </span><span class="lineCov">         12 : {</span>
<span class="lineNum">      94 </span>            :   /// Dtor
<span class="lineNum">      95 </span><span class="lineCov">          4 :   delete fClusterFinder;</span>
<span class="lineNum">      96 </span><span class="lineCov">          4 :   delete fPads[0];</span>
<span class="lineNum">      97 </span><span class="lineCov">          4 :   delete fPads[1];</span>
<span class="lineNum">      98 </span><span class="lineCov">          4 :   delete fPadsIterator[0];</span>
<span class="lineNum">      99 </span><span class="lineCov">          4 :   delete fPadsIterator[1];</span>
<span class="lineNum">     100 </span><span class="lineCov">          2 :   delete fBypass;</span>
<span class="lineNum">     101 </span><span class="lineCov">          6 : }</span>
<span class="lineNum">     102 </span>            : 
<a name="103"><span class="lineNum">     103 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     104 </span>            : Int_t 
<span class="lineNum">     105 </span>            : AliMUONSimpleClusterServer::Clusterize(Int_t chamberId,
<span class="lineNum">     106 </span>            :                                        AliMUONVClusterStore&amp; clusterStore,
<span class="lineNum">     107 </span>            :                                        const AliMpArea&amp; area,
<span class="lineNum">     108 </span>            :                                        const AliMUONRecoParam* recoParam)
<span class="lineNum">     109 </span>            : {
<span class="lineNum">     110 </span>            :   /// Area is in absolute coordinate. If not valid, means clusterize all
<span class="lineNum">     111 </span>            :   /// the chamber.
<span class="lineNum">     112 </span>            :   ///
<span class="lineNum">     113 </span>            :   /// We first find out the list of DE that have a non-zero overlap with area,
<span class="lineNum">     114 </span>            :   /// and then use the clusterfinder to find clusters in those areas (and DE).
<span class="lineNum">     115 </span>            :   
<span class="lineNum">     116 </span><span class="lineCov">        160 :   AliCodeTimerAuto(Form(&quot;Chamber %d&quot;,chamberId),0);</span>
<span class="lineNum">     117 </span>            :   
<span class="lineNum">     118 </span><span class="lineCov">         80 :   if ( fTriggerTrackStore &amp;&amp; chamberId &gt;= 6 ) </span>
<span class="lineNum">     119 </span>            :   {
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :     return fBypass-&gt;GenerateClusters(chamberId,clusterStore);</span>
<span class="lineNum">     121 </span>            :   }
<span class="lineNum">     122 </span>            :   
<span class="lineNum">     123 </span><span class="lineCov">         80 :   if (!recoParam) {</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     AliError(&quot;Reconstruction parameters are missing: unable to clusterize&quot;);</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     126 </span>            :   }
<span class="lineNum">     127 </span>            :   
<span class="lineNum">     128 </span><span class="lineCov">         80 :   AliMpDEIterator it;</span>
<span class="lineNum">     129 </span>            :   
<span class="lineNum">     130 </span><span class="lineCov">         80 :   it.First(chamberId);</span>
<span class="lineNum">     131 </span>            :   
<span class="lineNum">     132 </span>            :   Int_t nofAddedClusters(0);
<span class="lineNum">     133 </span><span class="lineCov">         80 :   Int_t fNCluster = clusterStore.GetSize();</span>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineCov">        400 :   AliDebug(1,Form(&quot;chamberId = %2d NofClusters before = %d searchArea=%s&quot;,</span>
<span class="lineNum">     136 </span>            :                   chamberId,fNCluster,AsString(area).Data()));
<span class="lineNum">     137 </span>            :   
<span class="lineNum">     138 </span><span class="lineCov">       3904 :   while ( !it.IsDone() )</span>
<span class="lineNum">     139 </span>            :   {
<span class="lineNum">     140 </span><span class="lineCov">       1248 :     Int_t detElemId = it.CurrentDEId();</span>
<span class="lineNum">     141 </span>            :     
<span class="lineNum">     142 </span><span class="lineCov">       1248 :     TObjArray* pads[2] = </span>
<span class="lineNum">     143 </span><span class="lineCov">       3744 :     { </span>
<span class="lineNum">     144 </span><span class="lineCov">       2496 :       static_cast&lt;TObjArray*&gt;(fPads[0]-&gt;GetValue(detElemId)),</span>
<span class="lineNum">     145 </span><span class="lineCov">       2496 :       static_cast&lt;TObjArray*&gt;(fPads[1]-&gt;GetValue(detElemId)) </span>
<span class="lineNum">     146 </span>            :     };
<span class="lineNum">     147 </span>            :     
<span class="lineNum">     148 </span><span class="lineCov">       1920 :     if ( ( pads[0] &amp;&amp; pads[0]-&gt;GetLast()&gt;=0 ) || </span>
<span class="lineNum">     149 </span><span class="lineCov">       1360 :          ( pads[1] &amp;&amp; pads[1]-&gt;GetLast()&gt;=0 ) )</span>
<span class="lineNum">     150 </span>            :     {
<span class="lineNum">     151 </span><span class="lineCov">        144 :       AliMpArea deArea; // area in DE-local-coordinates</span>
<span class="lineNum">     152 </span>            :       Bool_t ok(kTRUE);
<span class="lineNum">     153 </span>            :       
<span class="lineNum">     154 </span><span class="lineCov">        144 :       if ( area.IsValid() ) </span>
<span class="lineNum">     155 </span>            :       {
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :         ok = Overlap(detElemId,area,deArea);</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     158 </span>            :       
<span class="lineNum">     159 </span><span class="lineCov">        144 :       if ( ok ) </span>
<span class="lineNum">     160 </span>            :       {      
<span class="lineNum">     161 </span><span class="lineCov">        144 :         const AliMpVSegmentation* seg[2] = </span>
<span class="lineNum">     162 </span><span class="lineCov">        576 :         { AliMpSegmentation::Instance()-&gt;GetMpSegmentation(detElemId,AliMp::kCath0),</span>
<span class="lineNum">     163 </span><span class="lineCov">        288 :           AliMpSegmentation::Instance()-&gt;GetMpSegmentation(detElemId,AliMp::kCath1)</span>
<span class="lineNum">     164 </span>            :         };
<span class="lineNum">     165 </span>            :         
<span class="lineNum">     166 </span><span class="lineCov">        288 :         fClusterFinder-&gt;SetChargeHints(recoParam-&gt;LowestPadCharge(),</span>
<span class="lineNum">     167 </span><span class="lineCov">        144 :                                        recoParam-&gt;LowestClusterCharge());</span>
<span class="lineNum">     168 </span>            :         
<span class="lineNum">     169 </span><span class="lineCov">        288 :         if ( fClusterFinder-&gt;NeedSegmentation() )</span>
<span class="lineNum">     170 </span>            :         {
<span class="lineNum">     171 </span><span class="lineCov">        288 :           fClusterFinder-&gt;Prepare(detElemId,pads,deArea,seg);</span>
<span class="lineNum">     172 </span>            :         }
<span class="lineNum">     173 </span>            :         else
<span class="lineNum">     174 </span>            :         {
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :           fClusterFinder-&gt;Prepare(detElemId,pads,deArea);</span>
<span class="lineNum">     176 </span>            :         }
<span class="lineNum">     177 </span>            :         
<span class="lineNum">     178 </span><span class="lineCov">        720 :         AliDebug(1,Form(&quot;Clusterizing DE %04d with %3d pads (cath0) and %3d pads (cath1)&quot;,</span>
<span class="lineNum">     179 </span>            :                         detElemId,
<span class="lineNum">     180 </span>            :                         (pads[0] ? pads[0]-&gt;GetLast()+1 : 0),
<span class="lineNum">     181 </span>            :                         (pads[1] ? pads[1]-&gt;GetLast()+1 : 0)));
<span class="lineNum">     182 </span>            :         
<span class="lineNum">     183 </span>            :         AliMUONCluster* cluster;
<span class="lineNum">     184 </span>            :         
<span class="lineNum">     185 </span><span class="lineCov">        924 :         while ( ( cluster = fClusterFinder-&gt;NextCluster() ) ) </span>
<span class="lineNum">     186 </span>            :         {      
<span class="lineNum">     187 </span>            :           // add new cluster to the store with information to build its ID
<span class="lineNum">     188 </span>            :           // increment the number of clusters into the store
<span class="lineNum">     189 </span><span class="lineCov">        164 :           AliMUONVCluster* rawCluster = clusterStore.Add(chamberId, detElemId, fNCluster++);</span>
<span class="lineNum">     190 </span>            :           
<span class="lineNum">     191 </span><span class="lineCov">        164 :           ++nofAddedClusters;</span>
<span class="lineNum">     192 </span>            :           
<span class="lineNum">     193 </span>            :           // fill array of Id of digits attached to this cluster
<span class="lineNum">     194 </span><span class="lineCov">        164 :           Int_t nPad = cluster-&gt;Multiplicity();</span>
<span class="lineNum">     195 </span><span class="lineCov">        164 :           if (nPad &lt; 1) AliWarning(&quot;no pad attached to the cluster&quot;);</span>
<span class="lineNum">     196 </span>            :           
<span class="lineNum">     197 </span><span class="lineCov">       3188 :           for (Int_t iPad=0; iPad&lt;nPad; iPad++) </span>
<span class="lineNum">     198 </span>            :           {
<span class="lineNum">     199 </span><span class="lineCov">       1430 :             AliMUONPad *pad = cluster-&gt;Pad(iPad);</span>
<span class="lineNum">     200 </span>            :             
<span class="lineNum">     201 </span>            :             // skip virtual pads
<span class="lineNum">     202 </span><span class="lineCov">       1536 :             if (!pad-&gt;IsReal()) continue;</span>
<span class="lineNum">     203 </span>            :             
<span class="lineNum">     204 </span><span class="lineCov">       2648 :             rawCluster-&gt;AddDigitId(pad-&gt;GetUniqueID());</span>
<span class="lineNum">     205 </span><span class="lineCov">       1324 :           }</span>
<span class="lineNum">     206 </span>            :           
<span class="lineNum">     207 </span>            :           // fill charge and other cluster informations
<span class="lineNum">     208 </span><span class="lineCov">        328 :           rawCluster-&gt;SetCharge(cluster-&gt;Charge());</span>
<span class="lineNum">     209 </span><span class="lineCov">        164 :           rawCluster-&gt;SetChi2(cluster-&gt;Chi2());</span>
<span class="lineNum">     210 </span>            :           
<span class="lineNum">     211 </span><span class="lineCov">        164 :           Double_t xg, yg, zg;</span>
<span class="lineNum">     212 </span><span class="lineCov">        492 :           fkTransformer.Local2Global(detElemId, </span>
<span class="lineNum">     213 </span><span class="lineCov">        492 :                                     cluster-&gt;Position().X(), cluster-&gt;Position().Y(), </span>
<span class="lineNum">     214 </span>            :                                     0, xg, yg, zg);
<span class="lineNum">     215 </span><span class="lineCov">        164 :           rawCluster-&gt;SetXYZ(xg, yg, zg);</span>
<span class="lineNum">     216 </span><span class="lineCov">        164 :           rawCluster-&gt;SetErrXY(recoParam-&gt;GetDefaultNonBendingReso(chamberId),recoParam-&gt;GetDefaultBendingReso(chamberId));</span>
<span class="lineNum">     217 </span>            :           
<span class="lineNum">     218 </span>            :           // Set MC label
<span class="lineNum">     219 </span><span class="lineCov">        492 :           if (fDigitStore &amp;&amp; fDigitStore-&gt;HasMCInformation()) </span>
<span class="lineNum">     220 </span>            :           {
<span class="lineNum">     221 </span><span class="lineCov">        164 :             rawCluster-&gt;SetMCLabel(FindMCLabel(*cluster, detElemId, seg));</span>
<span class="lineNum">     222 </span>            :           }
<span class="lineNum">     223 </span>            :           
<span class="lineNum">     224 </span><span class="lineCov">        820 :           AliDebug(1,Form(&quot;Adding RawCluster detElemId %4d mult %2d charge %e (xl,yl,zl)=(%e,%e,%e) (xg,yg,zg)=(%e,%e,%e) label %d&quot;,</span>
<span class="lineNum">     225 </span>            :                           detElemId,rawCluster-&gt;GetNDigits(),rawCluster-&gt;GetCharge(),
<span class="lineNum">     226 </span>            :                           cluster-&gt;Position().X(),cluster-&gt;Position().Y(),0.0,
<span class="lineNum">     227 </span>            :                           xg,yg,zg,rawCluster-&gt;GetMCLabel()));
<span class="lineNum">     228 </span><span class="lineCov">        164 :         }</span>
<span class="lineNum">     229 </span><span class="lineCov">        144 :       }</span>
<span class="lineNum">     230 </span><span class="lineCov">        144 :     }</span>
<span class="lineNum">     231 </span><span class="lineCov">       1248 :     it.Next();</span>
<span class="lineNum">     232 </span><span class="lineCov">       1248 :   }</span>
<span class="lineNum">     233 </span>            :   
<span class="lineNum">     234 </span><span class="lineCov">        400 :   AliDebug(1,Form(&quot;chamberId = %2d NofClusters after = %d&quot;,chamberId,fNCluster));</span>
<span class="lineNum">     235 </span>            :   
<span class="lineNum">     236 </span>            :   return nofAddedClusters;
<span class="lineNum">     237 </span><span class="lineCov">        160 : }</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span>            : 
<a name="240"><span class="lineNum">     240 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     241 </span>            : void
<span class="lineNum">     242 </span>            : AliMUONSimpleClusterServer::Global2Local(Int_t detElemId, const AliMpArea&amp; globalArea,
<span class="lineNum">     243 </span>            :                                          AliMpArea&amp; localArea) const
<span class="lineNum">     244 </span>            : {
<span class="lineNum">     245 </span>            :   /// Convert a global area in local area for a given DE
<span class="lineNum">     246 </span>            :   
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :   Double_t xl,yl,zl;</span>
<span class="lineNum">     248 </span>            :   
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :   Int_t chamberId = AliMpDEManager::GetChamberId(detElemId);</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :   if ( chamberId &lt; 0 ) {</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :     AliErrorStream() &lt;&lt; &quot;Cannot get chamberId from detElemId=&quot; &lt;&lt; detElemId &lt;&lt; endl;</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     253 </span>            :   }  
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :   Double_t zg = AliMUONConstants::DefaultChamberZ(chamberId);</span>
<span class="lineNum">     255 </span>            :   
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :   fkTransformer.Global2Local(detElemId,</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :                              globalArea.GetPositionX(),globalArea.GetPositionY(),zg,</span>
<span class="lineNum">     258 </span>            :                              xl,yl,zl);
<span class="lineNum">     259 </span>            :   
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :   localArea = AliMpArea(xl,yl, globalArea.GetDimensionX(), globalArea.GetDimensionY());</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     262 </span>            : 
<a name="263"><span class="lineNum">     263 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     264 </span>            : Bool_t
<span class="lineNum">     265 </span>            : AliMUONSimpleClusterServer::Overlap(Int_t detElemId,
<span class="lineNum">     266 </span>            :                                     const AliMpArea&amp; area,
<span class="lineNum">     267 </span>            :                                     AliMpArea&amp; deArea) const
<span class="lineNum">     268 </span>            : {
<span class="lineNum">     269 </span>            :   /// Check whether (global) area overlaps with the given DE.
<span class="lineNum">     270 </span>            :   /// If it is, set deArea to the overlap region and convert it
<span class="lineNum">     271 </span>            :   /// in the local coordinate system of that DE.
<span class="lineNum">     272 </span>            :   
<span class="lineNum">     273 </span>            :   Bool_t overlap(kFALSE);
<span class="lineNum">     274 </span>            :   
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   AliMpArea* globalDEArea = fkTransformer.GetDEArea(detElemId);</span>
<span class="lineNum">     276 </span>            :   
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   if (!globalDEArea) return kFALSE;</span>
<span class="lineNum">     278 </span>            :   
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   AliMpArea overlapArea;</span>
<span class="lineNum">     280 </span>            :   
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :   if ( area.Overlap(*globalDEArea) )</span>
<span class="lineNum">     282 </span>            :   {
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     overlapArea = area.Intersect(*globalDEArea);</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     Global2Local(detElemId,overlapArea,deArea);</span>
<span class="lineNum">     285 </span>            :     overlap = kTRUE;
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     287 </span>            :   else
<span class="lineNum">     288 </span>            :   {
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :     deArea = AliMpArea();</span>
<span class="lineNum">     290 </span>            :   }
<span class="lineNum">     291 </span>            :   
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :   AliDebug(1,Form(&quot;DE %04d area %s globalDEArea %s overlapArea %s deArea %s overlap=%d&quot;,</span>
<span class="lineNum">     293 </span>            :                   detElemId,
<span class="lineNum">     294 </span>            :                   AsString(area).Data(),
<span class="lineNum">     295 </span>            :                   AsString(*globalDEArea).Data(),
<span class="lineNum">     296 </span>            :                   AsString(overlapArea).Data(),
<span class="lineNum">     297 </span>            :                   AsString(deArea).Data(),
<span class="lineNum">     298 </span>            :                   overlap));
<span class="lineNum">     299 </span>            :                   
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :   return overlap;</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     302 </span>            : 
<a name="303"><span class="lineNum">     303 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     304 </span>            : TObjArray* 
<span class="lineNum">     305 </span>            : AliMUONSimpleClusterServer::PadArray(Int_t detElemId, Int_t cathode) const
<span class="lineNum">     306 </span>            : {
<span class="lineNum">     307 </span>            :   /// Return array for given cathode of given DE
<span class="lineNum">     308 </span>            :   
<span class="lineNum">     309 </span><span class="lineCov">       2648 :   return static_cast&lt;TObjArray*&gt;(fPads[cathode]-&gt;GetValue(detElemId));</span>
<span class="lineNum">     310 </span>            : }
<span class="lineNum">     311 </span>            : 
<a name="312"><span class="lineNum">     312 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     313 </span>            : Bool_t 
<span class="lineNum">     314 </span>            : AliMUONSimpleClusterServer::UseTriggerTrackStore(AliMUONVTriggerTrackStore* trackStore)
<span class="lineNum">     315 </span>            : {
<span class="lineNum">     316 </span>            :   /// Tells us to use trigger track store, and thus to bypass St45 clusters
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :   fTriggerTrackStore = trackStore; // not owner</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :   delete fBypass;</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :   fBypass = new AliMUONTriggerTrackToTrackerClusters(fkTransformer,fTriggerTrackStore);</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     322 </span>            : 
<a name="323"><span class="lineNum">     323 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     324 </span>            : void 
<span class="lineNum">     325 </span>            : AliMUONSimpleClusterServer::UseDigits(TIter&amp; next, AliMUONVDigitStore* digitStore)
<span class="lineNum">     326 </span>            : {
<span class="lineNum">     327 </span>            :   /// Convert digitStore into two arrays of AliMUONPads
<span class="lineNum">     328 </span>            :   
<span class="lineNum">     329 </span><span class="lineCov">         16 :   fDigitStore = digitStore;</span>
<span class="lineNum">     330 </span>            :   
<span class="lineNum">     331 </span>            :   // Clear pads arrays in the maps
<span class="lineNum">     332 </span><span class="lineCov">         48 :   for ( Int_t i=0; i&lt;2; i++ ) {</span>
<span class="lineNum">     333 </span><span class="lineCov">         16 :     fPadsIterator[i]-&gt;Reset();</span>
<span class="lineNum">     334 </span><span class="lineCov">         16 :     Int_t key; TObject* obj;</span>
<span class="lineNum">     335 </span><span class="lineCov">        672 :     while ( ( obj = fPadsIterator[i]-&gt;Next(key) ) ) {</span>
<span class="lineNum">     336 </span>            :       //cout &lt;&lt; &quot;clearing array for detElemId &quot; &lt;&lt; key &lt;&lt;  &quot;  &quot;;
<span class="lineNum">     337 </span><span class="lineCov">        320 :       obj-&gt;Clear();</span>
<span class="lineNum">     338 </span>            :     }  
<span class="lineNum">     339 </span><span class="lineCov">         16 :   }   </span>
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            :   AliMUONVDigit* d;
<span class="lineNum">     342 </span><span class="lineCov">       2980 :   while ( ( d = static_cast&lt;AliMUONVDigit*&gt;(next()) ) )</span>
<span class="lineNum">     343 </span>            :   {
<span class="lineNum">     344 </span><span class="lineCov">       1640 :     if ( ! (d-&gt;Charge() &gt; 0.) ) continue; // skip void digits.</span>
<span class="lineNum">     345 </span><span class="lineCov">       1548 :     if ( ! d-&gt;IsTracker() ) continue; // skip trigger digits</span>
<span class="lineNum">     346 </span><span class="lineCov">       1324 :     Int_t ix = d-&gt;PadX();</span>
<span class="lineNum">     347 </span><span class="lineCov">       1324 :     Int_t iy = d-&gt;PadY();</span>
<span class="lineNum">     348 </span><span class="lineCov">       1324 :     Int_t cathode = d-&gt;Cathode();</span>
<span class="lineNum">     349 </span><span class="lineCov">       1324 :     Int_t detElemId = d-&gt;DetElemId();</span>
<span class="lineNum">     350 </span><span class="lineCov">       2648 :     const AliMpVSegmentation* seg = AliMpSegmentation::Instance()-&gt;</span>
<span class="lineNum">     351 </span><span class="lineCov">       1324 :       GetMpSegmentation(detElemId,AliMp::GetCathodType(cathode));</span>
<span class="lineNum">     352 </span><span class="lineCov">       1324 :     AliMpPad pad = seg-&gt;PadByIndices(ix,iy);</span>
<span class="lineNum">     353 </span>            :     
<span class="lineNum">     354 </span><span class="lineCov">       1324 :     TObjArray* padArray = PadArray(detElemId,cathode);</span>
<span class="lineNum">     355 </span><span class="lineCov">       1324 :     if (!padArray)</span>
<span class="lineNum">     356 </span>            :     {
<span class="lineNum">     357 </span><span class="lineCov">        448 :       padArray = new TObjArray(100);</span>
<span class="lineNum">     358 </span><span class="lineCov">        224 :       padArray-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     359 </span><span class="lineCov">        224 :       fPads[cathode]-&gt;Add(detElemId,padArray);</span>
<span class="lineNum">     360 </span>            :     }
<span class="lineNum">     361 </span>            :     
<span class="lineNum">     362 </span><span class="lineCov">       3972 :     AliMUONPad* mpad = new AliMUONPad(detElemId,cathode,</span>
<span class="lineNum">     363 </span><span class="lineCov">       1324 :                     ix,iy,pad.GetPositionX(),pad.GetPositionY(),</span>
<span class="lineNum">     364 </span><span class="lineCov">       1324 :                     pad.GetDimensionX(),pad.GetDimensionY(),</span>
<span class="lineNum">     365 </span><span class="lineCov">       2648 :                     d-&gt;Charge());</span>
<span class="lineNum">     366 </span><span class="lineCov">       2648 :     if ( d-&gt;IsSaturated() ) mpad-&gt;SetSaturated(kTRUE);</span>
<span class="lineNum">     367 </span><span class="lineCov">       2648 :     mpad-&gt;SetUniqueID(d-&gt;GetUniqueID());</span>
<span class="lineNum">     368 </span><span class="lineCov">       1324 :     padArray-&gt;Add(mpad);      </span>
<span class="lineNum">     369 </span><span class="lineCov">       1324 :   }</span>
<span class="lineNum">     370 </span><span class="lineCov">          8 : }</span>
<span class="lineNum">     371 </span>            : 
<a name="372"><span class="lineNum">     372 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     373 </span>            : Int_t
<span class="lineNum">     374 </span>            : AliMUONSimpleClusterServer::FindMCLabel(const AliMUONCluster&amp; cluster, Int_t detElemId, const AliMpVSegmentation* seg[2]) const
<span class="lineNum">     375 </span>            : {
<span class="lineNum">     376 </span>            :   /// Find the label of the most contributing MC track (-1 in case of failure)
<span class="lineNum">     377 </span>            :   /// The data member fDigitStore must be set
<span class="lineNum">     378 </span>            :   
<span class="lineNum">     379 </span>            :   // --- get the digit (if any) located at the cluster position on both cathods ---
<span class="lineNum">     380 </span><span class="lineCov">        164 :   Int_t nTracks[2] = {0, 0};</span>
<span class="lineNum">     381 </span><span class="lineCov">         82 :   AliMUONVDigit* digit[2] = {0x0, 0x0};</span>
<span class="lineNum">     382 </span><span class="lineCov">        492 :   for (Int_t iCath = 0; iCath &lt; 2; iCath++) {</span>
<span class="lineNum">     383 </span><span class="lineCov">        164 :     AliMpPad pad </span>
<span class="lineNum">     384 </span><span class="lineCov">        492 :       = seg[AliMp::GetCathodType(iCath)]-&gt;PadByPosition(cluster.Position().X(), cluster.Position().Y(),kFALSE);</span>
<span class="lineNum">     385 </span><span class="lineCov">        164 :     if (pad.IsValid()) {</span>
<span class="lineNum">     386 </span><span class="lineCov">        656 :       digit[iCath] = fDigitStore-&gt;FindObject(detElemId, pad.GetManuId(), pad.GetManuChannel(), iCath);</span>
<span class="lineNum">     387 </span><span class="lineCov">        492 :       if (digit[iCath]) nTracks[iCath] = digit[iCath]-&gt;Ntracks();</span>
<span class="lineNum">     388 </span>            :     }
<span class="lineNum">     389 </span><span class="lineCov">        164 :   }</span>
<span class="lineNum">     390 </span>            :   
<span class="lineNum">     391 </span><span class="lineCov">         82 :   if (nTracks[0] + nTracks[1] == 0) return -1;</span>
<span class="lineNum">     392 </span>            :   
<span class="lineNum">     393 </span>            :   // --- build the list of contributing tracks and of the associated charge ---
<span class="lineNum">     394 </span><span class="lineCov">         82 :   Int_t* trackId = new Int_t[nTracks[0] + nTracks[1]];</span>
<span class="lineNum">     395 </span><span class="lineCov">         82 :   Float_t* trackCharge = new Float_t[nTracks[0] + nTracks[1]];</span>
<span class="lineNum">     396 </span>            :   Int_t nTracksTot = 0;
<span class="lineNum">     397 </span>            :   
<span class="lineNum">     398 </span>            :   // fill with contributing tracks on first cathod
<span class="lineNum">     399 </span><span class="lineCov">        330 :   for (Int_t iTrack1 = 0; iTrack1 &lt; nTracks[0]; iTrack1++) {</span>
<span class="lineNum">     400 </span><span class="lineCov">         83 :     trackId[iTrack1] = digit[0]-&gt;Track(iTrack1);</span>
<span class="lineNum">     401 </span><span class="lineCov">         83 :     trackCharge[iTrack1] = digit[0]-&gt;TrackCharge(iTrack1);</span>
<span class="lineNum">     402 </span>            :   }
<span class="lineNum">     403 </span>            :   nTracksTot = nTracks[0];
<span class="lineNum">     404 </span>            :   
<span class="lineNum">     405 </span>            :   // complement with contributing tracks on second cathod
<span class="lineNum">     406 </span><span class="lineCov">        330 :   for (Int_t iTrack2 = 0; iTrack2 &lt; nTracks[1]; iTrack2++) {</span>
<span class="lineNum">     407 </span><span class="lineCov">         83 :     Int_t trackId2 = digit[1]-&gt;Track(iTrack2);</span>
<span class="lineNum">     408 </span>            :     // check if track exist
<span class="lineNum">     409 </span>            :     Bool_t trackExist = kFALSE;
<span class="lineNum">     410 </span><span class="lineCov">        168 :     for (Int_t iTrack1 = 0; iTrack1 &lt; nTracks[0]; iTrack1++) {</span>
<span class="lineNum">     411 </span><span class="lineCov">         84 :       if (trackId2 == trackId[iTrack1]) {</span>
<span class="lineNum">     412 </span>            :         // complement existing track
<span class="lineNum">     413 </span><span class="lineCov">         83 :         trackCharge[iTrack1] += digit[1]-&gt;TrackCharge(iTrack2);</span>
<span class="lineNum">     414 </span>            :         trackExist = kTRUE;
<span class="lineNum">     415 </span><span class="lineCov">         83 :         break;</span>
<span class="lineNum">     416 </span>            :       }
<span class="lineNum">     417 </span>            :     }
<span class="lineNum">     418 </span>            :     // add the new track
<span class="lineNum">     419 </span><span class="lineCov">         83 :     if (!trackExist) {</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :       trackId[nTracksTot] = trackId2;</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :       trackCharge[nTracksTot] = digit[1]-&gt;TrackCharge(iTrack2);</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :       nTracksTot++;</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     424 </span>            :   }
<span class="lineNum">     425 </span>            :   
<span class="lineNum">     426 </span>            :   // --- Find the most contributing track ---
<span class="lineNum">     427 </span>            :   Int_t mainTrackId = -1;
<span class="lineNum">     428 </span>            :   Float_t maxCharge = 0.;
<span class="lineNum">     429 </span><span class="lineCov">        330 :   for (Int_t iTrack = 0; iTrack &lt; nTracksTot; iTrack++) {</span>
<span class="lineNum">     430 </span><span class="lineCov">         83 :     if (trackCharge[iTrack] &gt; maxCharge) {</span>
<span class="lineNum">     431 </span><span class="lineCov">         83 :       mainTrackId = trackId[iTrack];</span>
<span class="lineNum">     432 </span>            :       maxCharge = trackCharge[iTrack];
<span class="lineNum">     433 </span><span class="lineCov">         83 :     }</span>
<span class="lineNum">     434 </span>            :   }
<span class="lineNum">     435 </span>            :   
<span class="lineNum">     436 </span><span class="lineCov">        164 :   delete[] trackId;</span>
<span class="lineNum">     437 </span><span class="lineCov">        164 :   delete[] trackCharge;</span>
<span class="lineNum">     438 </span>            :   
<span class="lineNum">     439 </span>            :   return mainTrackId;
<span class="lineNum">     440 </span><span class="lineCov">         82 : }</span>
<span class="lineNum">     441 </span>            : 
<a name="442"><span class="lineNum">     442 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     443 </span>            : void 
<span class="lineNum">     444 </span>            : AliMUONSimpleClusterServer::Print(Option_t*) const
<span class="lineNum">     445 </span>            : {
<span class="lineNum">     446 </span>            :   /// Printout for debug only
<span class="lineNum">     447 </span>            :   
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :   AliMpDEIterator it;</span>
<span class="lineNum">     449 </span>            :   
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :   it.First();</span>
<span class="lineNum">     451 </span>            :   
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   while ( !it.IsDone() )</span>
<span class="lineNum">     453 </span>            :   {
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     Int_t detElemId = it.CurrentDEId();</span>
<span class="lineNum">     455 </span>            :     
<span class="lineNum">     456 </span>            :     // printout the number of pads / de, and number of used pads / de
<span class="lineNum">     457 </span>            :     
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :     if ( ( PadArray(detElemId,0) &amp;&amp; PadArray(detElemId,0)-&gt;GetLast() &gt;= 0 ) || </span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :          ( PadArray(detElemId,1) &amp;&amp; PadArray(detElemId,1)-&gt;GetLast() &gt;= 0 ) )</span>
<span class="lineNum">     460 </span>            :     {
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :       cout &lt;&lt; Form(&quot;---- DE %04d&quot;,detElemId) &lt;&lt; endl;</span>
<span class="lineNum">     462 </span>            :       
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :       for ( Int_t cathode = 0; cathode &lt; 2; ++cathode ) </span>
<span class="lineNum">     464 </span>            :       {
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :         cout &lt;&lt; Form(&quot;  -- Cathode %1d&quot;,cathode) &lt;&lt; endl;</span>
<span class="lineNum">     466 </span>            :         
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :         TObjArray* padArray = PadArray(detElemId,cathode);</span>
<span class="lineNum">     468 </span>            :         
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :         if (!padArray)</span>
<span class="lineNum">     470 </span>            :         {
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :           cout &lt;&lt; &quot;no pad array&quot; &lt;&lt; endl;</span>
<span class="lineNum">     472 </span>            :         }
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :         else if ( padArray-&gt;GetLast() &lt; 0 ) </span>
<span class="lineNum">     474 </span>            :         {
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :           cout &lt;&lt; &quot;no pads&quot; &lt;&lt; endl;</span>
<span class="lineNum">     476 </span>            :         }
<span class="lineNum">     477 </span>            :         else
<span class="lineNum">     478 </span>            :         {
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :           TIter next(padArray);</span>
<span class="lineNum">     480 </span>            :           AliMUONPad* pad;
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :           while ( ( pad = static_cast&lt;AliMUONPad*&gt;(next()) ) )</span>
<span class="lineNum">     482 </span>            :           {
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :             pad-&gt;Print(&quot;full&quot;);</span>
<span class="lineNum">     484 </span>            :           }
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     486 </span>            :       }
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     it.Next();</span>
<span class="lineNum">     489 </span>            :   }
<span class="lineNum">     490 </span><span class="lineNoCov">          0 : }  </span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
