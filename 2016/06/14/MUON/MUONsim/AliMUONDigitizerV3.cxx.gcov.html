<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - MUON/MUONsim/AliMUONDigitizerV3.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">MUON/MUONsim</a> - AliMUONDigitizerV3.cxx<span style="font-size: 80%;"> (source / <a href="AliMUONDigitizerV3.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">202</td>
            <td class="headerCovTableEntry">337</td>
            <td class="headerCovTableEntryLo">59.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">20</td>
            <td class="headerCovTableEntry">23</td>
            <td class="headerCovTableEntryMed">87.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            : * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            : *                                                                        *
<span class="lineNum">       4 </span>            : * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            : * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            : *                                                                        *
<span class="lineNum">       7 </span>            : * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            : * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            : * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            : * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            : * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            : * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            : * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            : **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : // $Id$
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : #include &quot;AliMUONDigitizerV3.h&quot;
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : #include &quot;AliMUON.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;AliMUONCalibrationData.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;AliMUONConstants.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;AliMUONDigit.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;AliMUONLogger.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;AliMUONTriggerElectronics.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;AliMUONTriggerStoreV1.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;AliMUONVCalibParam.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;AliMUONVDigitStore.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;AliMUONGeometryTransformer.h&quot; //ADDED for trigger noise
<span class="lineNum">      31 </span>            : #include &quot;AliMUONRecoParam.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;AliMUONTriggerChamberEfficiency.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;AliMUONTriggerUtilities.h&quot;
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : #include &quot;AliMpCDB.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;AliMpSegmentation.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;AliMpCathodType.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;AliMpConstants.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;AliMpDEIterator.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;AliMpDEManager.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;AliMpPad.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;AliMpStationType.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;AliMpVSegmentation.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;AliMpDDLStore.h&quot;
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span>            : #include &quot;AliCDBManager.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;AliCodeTimer.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;AliRun.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;AliDigitizationInput.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;AliLoader.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;AliRunLoader.h&quot;
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            : #include &lt;Riostream.h&gt;
<span class="lineNum">      55 </span>            : #include &lt;TF1.h&gt;
<span class="lineNum">      56 </span>            : #include &lt;TFile.h&gt;
<span class="lineNum">      57 </span>            : #include &lt;TMath.h&gt;
<span class="lineNum">      58 </span>            : #include &lt;TRandom.h&gt;
<span class="lineNum">      59 </span>            : #include &lt;TString.h&gt;
<span class="lineNum">      60 </span>            : #include &lt;TSystem.h&gt;
<span class="lineNum">      61 </span>            : #include &lt;TTree.h&gt;
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            : //-----------------------------------------------------------------------------
<span class="lineNum">      64 </span>            : /// \class AliMUONDigitizerV3
<span class="lineNum">      65 </span>            : ///
<span class="lineNum">      66 </span>            : /// The digitizer is performing the transformation to go from SDigits (digits
<span class="lineNum">      67 </span>            : /// w/o any electronic noise) to Digits (w/ electronic noise, and decalibration)
<span class="lineNum">      68 </span>            : /// 
<span class="lineNum">      69 </span>            : /// The decalibration is performed by doing the reverse operation of the
<span class="lineNum">      70 </span>            : /// calibration, that is we do (Signal+pedestal)/gain -&gt; ADC
<span class="lineNum">      71 </span>            : ///
<span class="lineNum">      72 </span>            : /// Note also that the digitizer takes care of merging sdigits that belongs
<span class="lineNum">      73 </span>            : /// to the same pad, either because we're merging several input sdigit files
<span class="lineNum">      74 </span>            : /// or with a single file because the sdigitizer does not merge sdigits itself
<span class="lineNum">      75 </span>            : /// (for performance reason mainly, and because anyway we know we have to do it
<span class="lineNum">      76 </span>            : /// here, at the digitization level).
<span class="lineNum">      77 </span>            : ///
<span class="lineNum">      78 </span>            : /// August 2011. In order to remove the need for specific MC OCDB storages,
<span class="lineNum">      79 </span>            : /// we're introducing a dependence of simulation on AliMUONRecoParam (stored
<span class="lineNum">      80 </span>            : /// in MUON/Calib/RecoParam in OCDB), which is normally (or conceptually, if
<span class="lineNum">      81 </span>            : /// you will) only a reconstruction object. That's not a pretty solution, but,
<span class="lineNum">      82 </span>            : /// well, we have to do it...
<span class="lineNum">      83 </span>            : /// This dependence comes from the fact that we must know how to decalibrate
<span class="lineNum">      84 </span>            : /// the digits, so that the decalibration (done here) - calibration (done during
<span class="lineNum">      85 </span>            : /// reco) process is (as much as possible) neutral.
<span class="lineNum">      86 </span>            : ///
<span class="lineNum">      87 </span>            : ///
<span class="lineNum">      88 </span>            : /// \author Laurent Aphecetche
<span class="lineNum">      89 </span>            : ///
<span class="lineNum">      90 </span>            : //-----------------------------------------------------------------------------
<span class="lineNum">      91 </span>            : 
<a name="92"><span class="lineNum">      92 </span>            : namespace</a>
<span class="lineNum">      93 </span>            : {
<span class="lineNum">      94 </span>            :   AliMUON* muon()
<span class="lineNum">      95 </span>            :   {
<span class="lineNum">      96 </span><span class="lineCov">          2 :     return static_cast&lt;AliMUON*&gt;(gAlice-&gt;GetModule(&quot;MUON&quot;));</span>
<span class="lineNum">      97 </span>            :   }
<a name="98"><span class="lineNum">      98 </span>            : </a>
<span class="lineNum">      99 </span>            :   //ADDED for trigger noise
<span class="lineNum">     100 </span>            :   const AliMUONGeometryTransformer* GetTransformer()
<span class="lineNum">     101 </span>            :   {
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :       return muon()-&gt;GetGeometryTransformer();</span>
<span class="lineNum">     103 </span>            :   }
<span class="lineNum">     104 </span>            : }
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            : Double_t AliMUONDigitizerV3::fgNSigmas = 4.0;
<a name="107"><span class="lineNum">     107 </span>            : </a>
<span class="lineNum">     108 </span>            : /// \cond CLASSIMP
<span class="lineNum">     109 </span><span class="lineCov">         16 : ClassImp(AliMUONDigitizerV3)</span>
<span class="lineNum">     110 </span>            : /// \endcond
<a name="111"><span class="lineNum">     111 </span>            : </a>
<span class="lineNum">     112 </span>            : //_____________________________________________________________________________
<span class="lineNum">     113 </span>            : AliMUONDigitizerV3::AliMUONDigitizerV3(AliDigitizationInput* digInput, 
<span class="lineNum">     114 </span>            :                                        Int_t generateNoisyDigits)
<span class="lineNum">     115 </span><span class="lineCov">          1 : : AliDigitizer(digInput),</span>
<span class="lineNum">     116 </span><span class="lineCov">          1 : fIsInitialized(kFALSE),</span>
<span class="lineNum">     117 </span><span class="lineCov">          1 : fCalibrationData(0x0),</span>
<span class="lineNum">     118 </span><span class="lineCov">          1 : fTriggerProcessor(0x0),</span>
<span class="lineNum">     119 </span><span class="lineCov">          1 : fNoiseFunctionTrig(0x0),</span>
<span class="lineNum">     120 </span><span class="lineCov">          1 : fGenerateNoisyDigits(generateNoisyDigits),</span>
<span class="lineNum">     121 </span><span class="lineCov">          3 : fLogger(new AliMUONLogger(4207)), /* 4207 = 25% of the 16828 MCH manus */</span>
<span class="lineNum">     122 </span><span class="lineCov">          3 : fTriggerStore(new AliMUONTriggerStoreV1),</span>
<span class="lineNum">     123 </span><span class="lineCov">          1 : fDigitStore(0x0),</span>
<span class="lineNum">     124 </span><span class="lineCov">          1 : fOutputDigitStore(0x0),</span>
<span class="lineNum">     125 </span><span class="lineCov">          1 : fInputDigitStores(0x0),</span>
<span class="lineNum">     126 </span><span class="lineCov">          1 : fRecoParam(0x0),</span>
<span class="lineNum">     127 </span><span class="lineCov">          1 : fTriggerEfficiency(0x0),</span>
<span class="lineNum">     128 </span><span class="lineCov">          1 : fTriggerUtilities(0x0),</span>
<span class="lineNum">     129 </span><span class="lineCov">          2 : fEfficiencyResponse(2*AliMUONConstants::NTriggerCh()*AliMUONConstants::NTriggerCircuit())</span>
<span class="lineNum">     130 </span><span class="lineCov">          5 : {</span>
<span class="lineNum">     131 </span>            :   /// Ctor.
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span><span class="lineCov">          5 :   AliDebug(1,Form(&quot;AliDigitizationInput=%p&quot;,fDigInput));</span>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineCov">          2 : }</span>
<a name="136"><span class="lineNum">     136 </span>            : </a>
<span class="lineNum">     137 </span>            : //_____________________________________________________________________________
<span class="lineNum">     138 </span>            : AliMUONDigitizerV3::~AliMUONDigitizerV3()
<span class="lineNum">     139 </span><span class="lineCov">          6 : {</span>
<span class="lineNum">     140 </span>            :   /// Dtor. Note we're the owner of some pointers.
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span><span class="lineCov">          5 :   AliDebug(1,&quot;dtor&quot;);</span>
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span>            :  // delete fCalibrationData;
<span class="lineNum">     145 </span><span class="lineCov">          2 :   delete fTriggerProcessor;</span>
<span class="lineNum">     146 </span><span class="lineCov">          1 :   delete fNoiseFunctionTrig;</span>
<span class="lineNum">     147 </span><span class="lineCov">          2 :   delete fTriggerStore;</span>
<span class="lineNum">     148 </span><span class="lineCov">          2 :   delete fDigitStore;</span>
<span class="lineNum">     149 </span><span class="lineCov">          2 :   delete fOutputDigitStore;</span>
<span class="lineNum">     150 </span><span class="lineCov">          2 :   delete fInputDigitStores;</span>
<span class="lineNum">     151 </span><span class="lineCov">          2 :   delete fTriggerUtilities;</span>
<span class="lineNum">     152 </span>            :   
<span class="lineNum">     153 </span><span class="lineCov">          2 :   AliInfo(&quot;Summary of messages&quot;);</span>
<span class="lineNum">     154 </span><span class="lineCov">          1 :   fLogger-&gt;Print();</span>
<span class="lineNum">     155 </span>            :   
<span class="lineNum">     156 </span><span class="lineCov">          2 :   delete fLogger;</span>
<span class="lineNum">     157 </span><span class="lineCov">          3 : }</span>
<span class="lineNum">     158 </span>            : 
<a name="159"><span class="lineNum">     159 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     160 </span>            : void 
<span class="lineNum">     161 </span>            : AliMUONDigitizerV3::ApplyResponseToTrackerDigit(AliMUONVDigit&amp; digit, Bool_t addNoise)
<span class="lineNum">     162 </span>            : {
<span class="lineNum">     163 </span>            :   /// For tracking digits, starting from an ideal digit's charge, we :
<span class="lineNum">     164 </span>            :   ///
<span class="lineNum">     165 </span>            :   /// - &quot;divide&quot; by a gain (thus decalibrating the digit)
<span class="lineNum">     166 </span>            :   /// - add a pedestal (thus decalibrating the digit)
<span class="lineNum">     167 </span>            :   /// - add some electronics noise (thus leading to a realistic adc), if requested to do so
<span class="lineNum">     168 </span>            :   /// - sets the signal to zero if below 3*sigma of the noise
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span><span class="lineCov">        857 :   Float_t charge = digit.Charge();</span>
<span class="lineNum">     171 </span>            :   
<span class="lineNum">     172 </span><span class="lineCov">        857 :   if (!digit.IsChargeInFC())</span>
<span class="lineNum">     173 </span>            :   {
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :     charge *= AliMUONConstants::DefaultADC2MV()*AliMUONConstants::DefaultA0()*AliMUONConstants::DefaultCapa();</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     fLogger-&gt;Log(&quot;CHECK ME ! WAS NOT SUPPOSED TO BE HERE !!! ARE YOU RECONSTRUCTING OLD SIMULATIONS ? &quot;);</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     AliError(&quot;CHECK ME ! WAS NOT SUPPOSED TO BE HERE !!! ARE YOU RECONSTRUCTING OLD SIMULATIONS ? &quot;);</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     178 </span>            :   
<span class="lineNum">     179 </span>            :   // We set the charge to 0, as the only relevant piece of information
<span class="lineNum">     180 </span>            :   // after Digitization is the ADC value.  
<span class="lineNum">     181 </span><span class="lineCov">        857 :   digit.SetCharge(0);</span>
<span class="lineNum">     182 </span>            :     
<span class="lineNum">     183 </span><span class="lineCov">        857 :   Int_t detElemId = digit.DetElemId();</span>
<span class="lineNum">     184 </span><span class="lineCov">        857 :   Int_t manuId = digit.ManuId();</span>
<span class="lineNum">     185 </span>            :   
<span class="lineNum">     186 </span><span class="lineCov">        857 :   AliMUONVCalibParam* pedestal = fCalibrationData-&gt;Pedestals(detElemId,manuId);</span>
<span class="lineNum">     187 </span><span class="lineCov">        857 :   if (!pedestal)</span>
<span class="lineNum">     188 </span>            :   {
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :     fLogger-&gt;Log(Form(&quot;%s:%d:Could not get pedestal for DE=%4d manuId=%4d. Disabling.&quot;,</span>
<span class="lineNum">     190 </span>            :                       __FILE__,__LINE__,
<span class="lineNum">     191 </span>            :                       detElemId,manuId));
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :     digit.SetADC(0);</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :     return;    </span>
<span class="lineNum">     194 </span>            :   }
<span class="lineNum">     195 </span>            :   
<span class="lineNum">     196 </span><span class="lineCov">        857 :   Int_t manuChannel = digit.ManuChannel();</span>
<span class="lineNum">     197 </span>            :   
<span class="lineNum">     198 </span><span class="lineCov">       1714 :   if ( pedestal-&gt;ValueAsFloat(manuChannel,0) == AliMUONVCalibParam::InvalidFloatValue() ||</span>
<span class="lineNum">     199 </span><span class="lineCov">        857 :       pedestal-&gt;ValueAsFloat(manuChannel,1) == AliMUONVCalibParam::InvalidFloatValue() )</span>
<span class="lineNum">     200 </span>            :   {
<span class="lineNum">     201 </span>            :     // protection against invalid pedestal value
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     digit.SetADC(0);</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     204 </span>            :   }
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span><span class="lineCov">       1714 :   Int_t adc = DecalibrateTrackerDigit(*pedestal,manuChannel,charge,addNoise,</span>
<span class="lineNum">     207 </span><span class="lineCov">        857 :                                       digit.IsNoiseOnly());</span>
<span class="lineNum">     208 </span>            :   
<span class="lineNum">     209 </span><span class="lineCov">        857 :   digit.SetADC(adc);</span>
<span class="lineNum">     210 </span><span class="lineCov">       1714 : }</span>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span>            : 
<a name="213"><span class="lineNum">     213 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     214 </span>            : void 
<span class="lineNum">     215 </span>            : AliMUONDigitizerV3::ApplyResponseToTriggerDigit(AliMUONVDigit&amp; digit)
<span class="lineNum">     216 </span>            : {
<span class="lineNum">     217 </span>            :   /// For trigger digits, starting from an ideal digit, we :
<span class="lineNum">     218 </span>            :   ///
<span class="lineNum">     219 </span>            :   /// - apply efficiency (on demand)
<span class="lineNum">     220 </span>            :   /// - apply trigger masks
<span class="lineNum">     221 </span>            :     
<span class="lineNum">     222 </span><span class="lineCov">        224 :   Int_t detElemId = digit.DetElemId();</span>
<span class="lineNum">     223 </span><span class="lineCov">        112 :   Int_t localCircuit = digit.ManuId();</span>
<span class="lineNum">     224 </span><span class="lineCov">        112 :   Int_t strip = digit.ManuChannel();</span>
<span class="lineNum">     225 </span><span class="lineCov">        112 :   Int_t cathode = digit.Cathode();</span>
<span class="lineNum">     226 </span><span class="lineCov">        112 :   Int_t trigCh = detElemId/100 - 11;</span>
<span class="lineNum">     227 </span>            :   
<span class="lineNum">     228 </span>            :   // Masked channels
<span class="lineNum">     229 </span><span class="lineCov">        112 :   Bool_t isMasked = fTriggerUtilities-&gt;IsMasked(digit);</span>
<span class="lineNum">     230 </span><span class="lineCov">        336 :   AliDebug(1,Form(&quot;detElemId %i  cath %i  board %i  strip %i  is masked %i\n&quot;, detElemId, cathode, localCircuit, strip, isMasked));</span>
<span class="lineNum">     231 </span><span class="lineCov">        112 :   if ( isMasked ) {</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :     digit.SetCharge(0);</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :     digit.SetADC(0);</span>
<span class="lineNum">     234 </span>            :     //AliDebug(1,Form(&quot;ch %i  cath %i  board %i  strip %i  masked\n&quot;, trigCh, cathode, localCircuit, strip));
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     236 </span>            :   }
<span class="lineNum">     237 </span>            :   
<span class="lineNum">     238 </span>            :   
<span class="lineNum">     239 </span><span class="lineCov">        112 :   Int_t arrayIndex = GetArrayIndex(cathode, trigCh, localCircuit);</span>
<span class="lineNum">     240 </span>            :   
<span class="lineNum">     241 </span>            :   // Trigger chamber efficiency
<span class="lineNum">     242 </span><span class="lineCov">        112 :   if ( fTriggerEfficiency ) {</span>
<span class="lineNum">     243 </span><span class="lineCov">        112 :     if ( fEfficiencyResponse[arrayIndex] &lt; 0 ) {</span>
<span class="lineNum">     244 </span><span class="lineCov">         43 :       Bool_t isTrig[2] = {kTRUE, kTRUE};</span>
<span class="lineNum">     245 </span><span class="lineCov">         43 :       fTriggerEfficiency-&gt;IsTriggered(detElemId, localCircuit, isTrig[0], isTrig[1]);</span>
<span class="lineNum">     246 </span><span class="lineCov">         43 :       Int_t arrayIndexBend = GetArrayIndex(0, trigCh, localCircuit);</span>
<span class="lineNum">     247 </span><span class="lineCov">         43 :       Int_t arrayIndexNonBend = GetArrayIndex(1, trigCh, localCircuit);</span>
<span class="lineNum">     248 </span><span class="lineCov">         43 :       fEfficiencyResponse[arrayIndexBend] = isTrig[0];</span>
<span class="lineNum">     249 </span><span class="lineCov">         43 :       fEfficiencyResponse[arrayIndexNonBend] = isTrig[1];</span>
<span class="lineNum">     250 </span><span class="lineCov">         43 :     }</span>
<span class="lineNum">     251 </span><span class="lineCov">        336 :     AliDebug(1,Form(&quot;detElemId %i  cath %i  board %i  strip %i  efficiency %i\n&quot;, detElemId, cathode, localCircuit, strip, fEfficiencyResponse[arrayIndex]));</span>
<span class="lineNum">     252 </span><span class="lineCov">        112 :     if ( fEfficiencyResponse[arrayIndex] == 0 ) {</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :       digit.SetCharge(0);</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :       digit.SetADC(0);</span>
<span class="lineNum">     255 </span>            :       //AliDebug(1,Form(&quot;ch %i  cath %i  board %i  strip %i  NOT efficient\n&quot;, trigCh, cathode, localCircuit, strip));
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     257 </span>            :     }
<span class="lineNum">     258 </span>            :   }  
<span class="lineNum">     259 </span><span class="lineCov">        224 : }</span>
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span>            : 
<a name="263"><span class="lineNum">     263 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     264 </span>            : void
<span class="lineNum">     265 </span>            : AliMUONDigitizerV3::ApplyResponse(const AliMUONVDigitStore&amp; store,
<span class="lineNum">     266 </span>            :                                   AliMUONVDigitStore&amp; filteredStore)
<span class="lineNum">     267 </span>            : {
<span class="lineNum">     268 </span>            :   /// Loop over all chamber digits, and apply the response to them
<span class="lineNum">     269 </span>            :   /// Note that this method may remove digits.
<span class="lineNum">     270 </span>            : 
<span class="lineNum">     271 </span><span class="lineCov">          8 :   filteredStore.Clear();</span>
<span class="lineNum">     272 </span>            :   
<span class="lineNum">     273 </span>            :   const Bool_t kAddNoise = kTRUE;
<span class="lineNum">     274 </span>            :   
<span class="lineNum">     275 </span><span class="lineCov">          4 :   TIter next(store.CreateIterator());</span>
<span class="lineNum">     276 </span>            :   AliMUONVDigit* digit;
<span class="lineNum">     277 </span>            :   
<span class="lineNum">     278 </span><span class="lineCov">          8 :   if ( fTriggerEfficiency ) fEfficiencyResponse.Reset(-1);</span>
<span class="lineNum">     279 </span>            :   
<span class="lineNum">     280 </span><span class="lineCov">       2915 :   while ( ( digit = static_cast&lt;AliMUONVDigit*&gt;(next()) ) )</span>
<span class="lineNum">     281 </span>            :   {
<span class="lineNum">     282 </span><span class="lineCov">       1938 :     AliMp::StationType stationType = AliMpDEManager::GetStationType(digit-&gt;DetElemId());</span>
<span class="lineNum">     283 </span>            :     
<span class="lineNum">     284 </span><span class="lineCov">        969 :     if ( stationType != AliMp::kStationTrigger )</span>
<span class="lineNum">     285 </span>            :     {
<span class="lineNum">     286 </span>            :       Bool_t addNoise = kAddNoise;
<span class="lineNum">     287 </span><span class="lineCov">       1714 :       if (digit-&gt;IsConverted()) addNoise = kFALSE; // No need to add extra noise to a converted real digit</span>
<span class="lineNum">     288 </span><span class="lineCov">        857 :       ApplyResponseToTrackerDigit(*digit,addNoise);</span>
<span class="lineNum">     289 </span><span class="lineCov">        857 :     }</span>
<span class="lineNum">     290 </span>            :     else {
<span class="lineNum">     291 </span><span class="lineCov">        112 :       ApplyResponseToTriggerDigit(*digit);</span>
<span class="lineNum">     292 </span>            :     }
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span><span class="lineCov">       2460 :     if ( digit-&gt;ADC() &gt; 0  || digit-&gt;Charge() &gt; 0 )</span>
<span class="lineNum">     295 </span>            :     {
<span class="lineNum">     296 </span><span class="lineCov">        820 :       filteredStore.Add(*digit,AliMUONVDigitStore::kIgnore);</span>
<span class="lineNum">     297 </span>            :     }
<span class="lineNum">     298 </span>            :   }
<span class="lineNum">     299 </span><span class="lineCov">          4 : }    </span>
<span class="lineNum">     300 </span>            : 
<a name="301"><span class="lineNum">     301 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     302 </span>            : Int_t 
<span class="lineNum">     303 </span>            : AliMUONDigitizerV3::DecalibrateTrackerDigit(const AliMUONVCalibParam&amp; pedestals,
<span class="lineNum">     304 </span>            :                                             Int_t channel,
<span class="lineNum">     305 </span>            :                                             Float_t charge,
<span class="lineNum">     306 </span>            :                                             Bool_t addNoise,
<span class="lineNum">     307 </span>            :                                             Bool_t noiseOnly)
<span class="lineNum">     308 </span>            : {
<span class="lineNum">     309 </span>            :   /// Decalibrate (i.e. go from charge to adc) a tracker digit, given its
<span class="lineNum">     310 </span>            :   /// pedestal and gain parameters.
<span class="lineNum">     311 </span>            :   /// Must insure before calling that channel is valid (i.e. between 0 and
<span class="lineNum">     312 </span>            :   /// pedestals-&gt;GetSize()-1, but also corresponding to a valid channel
<span class="lineNum">     313 </span>            :   /// otherwise results are not predictible...)
<span class="lineNum">     314 </span>            :   ///
<span class="lineNum">     315 </span>            :   /// This method is completely tied to what happens in its sister method :
<span class="lineNum">     316 </span>            :   /// AliMUONDigitCalibrator::CalibrateDigit, which is doing the reverse work...
<span class="lineNum">     317 </span>            :   ///
<span class="lineNum">     318 </span>            :   
<span class="lineNum">     319 </span>            :   static const Int_t kMaxADC = (1&lt;&lt;12)-1; // We code the charge on a 12 bits ADC.
<span class="lineNum">     320 </span>            :   
<span class="lineNum">     321 </span>            :   Int_t thres(4095);
<span class="lineNum">     322 </span>            :   Int_t qual(0xF);
<span class="lineNum">     323 </span><span class="lineCov">        857 :   Float_t capa(AliMUONConstants::DefaultCapa()); // capa = 0.2 and a0 = 1.25</span>
<span class="lineNum">     324 </span><span class="lineCov">        857 :   Float_t a0(AliMUONConstants::DefaultA0());  // is equivalent to gain = 4 mV/fC</span>
<span class="lineNum">     325 </span><span class="lineCov">        857 :   Float_t adc2mv(AliMUONConstants::DefaultADC2MV()); // 1 ADC channel = 0.61 mV</span>
<span class="lineNum">     326 </span>            :                
<span class="lineNum">     327 </span><span class="lineCov">        857 :   Float_t pedestalMean = pedestals.ValueAsFloat(channel,0);</span>
<span class="lineNum">     328 </span><span class="lineCov">        857 :   Float_t pedestalSigma = pedestals.ValueAsFloat(channel,1);</span>
<span class="lineNum">     329 </span>            :   
<span class="lineNum">     330 </span><span class="lineCov">       2571 :   AliDebugClass(2,Form(&quot;DE %04d MANU %04d CH %02d PEDMEAN %7.2f PEDSIGMA %7.2f&quot;,</span>
<span class="lineNum">     331 </span>            :                        pedestals.ID0(),pedestals.ID1(),channel,pedestalMean,pedestalSigma));
<span class="lineNum">     332 </span>            :   
<span class="lineNum">     333 </span><span class="lineCov">        857 :   if ( qual &lt;= 0 ) return 0;</span>
<span class="lineNum">     334 </span>            :   
<span class="lineNum">     335 </span>            :   Float_t chargeThres = a0*thres;
<span class="lineNum">     336 </span>            :   
<span class="lineNum">     337 </span><span class="lineCov">        857 :   Float_t padc = charge/a0; // (adc - ped) value</span>
<span class="lineNum">     338 </span>            :   
<span class="lineNum">     339 </span><span class="lineCov">        857 :   padc /= capa*adc2mv;</span>
<span class="lineNum">     340 </span>            :   
<span class="lineNum">     341 </span>            :   Int_t adc(0);
<span class="lineNum">     342 </span>            :   
<span class="lineNum">     343 </span>            :   Float_t adcNoise = 0.0;
<span class="lineNum">     344 </span>            :     
<span class="lineNum">     345 </span><span class="lineCov">        857 :   if ( addNoise ) </span>
<span class="lineNum">     346 </span>            :   {
<span class="lineNum">     347 </span><span class="lineCov">        857 :     if ( noiseOnly )</span>
<span class="lineNum">     348 </span>            :     {      
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :       adcNoise = NoiseFunction()-&gt;GetRandom()*pedestalSigma;</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     351 </span>            :     else
<span class="lineNum">     352 </span>            :     {
<span class="lineNum">     353 </span><span class="lineCov">        857 :       adcNoise = gRandom-&gt;Gaus(0.0,pedestalSigma);</span>
<span class="lineNum">     354 </span>            :     }
<span class="lineNum">     355 </span>            :   }
<span class="lineNum">     356 </span>            :     
<span class="lineNum">     357 </span><span class="lineCov">        857 :   adc = TMath::Nint(padc + pedestalMean + adcNoise + 0.5);</span>
<span class="lineNum">     358 </span>            :   
<span class="lineNum">     359 </span><span class="lineCov">        857 :   if ( adc &lt; TMath::Nint(pedestalMean + fgNSigmas*pedestalSigma + 0.5) ) </span>
<span class="lineNum">     360 </span>            :   {
<span class="lineNum">     361 </span>            :     // this is an error only in specific cases
<span class="lineNum">     362 </span><span class="lineCov">        447 :     if ( !addNoise || (addNoise &amp;&amp; noiseOnly) ) </span>
<span class="lineNum">     363 </span>            :     {
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :       AliDebugClass(1,Form(&quot; DE %04d Manu %04d Channel %02d &quot;</span>
<span class="lineNum">     365 </span>            :                                                                                                          &quot; a0 %7.2f thres %04d ped %7.2f pedsig %7.2f adcNoise %7.2f &quot;
<span class="lineNum">     366 </span>            :                                                                                                          &quot; charge=%7.2f padc=%7.2f adc=%04d ZS=%04d fgNSigmas=%e addNoise %d noiseOnly %d &quot;,
<span class="lineNum">     367 </span>            :                                                                                                          pedestals.ID0(),pedestals.ID1(),channel, 
<span class="lineNum">     368 </span>            :                                                                                                          a0, thres, pedestalMean, pedestalSigma, adcNoise,
<span class="lineNum">     369 </span>            :                                                                                                          charge, padc, adc, 
<span class="lineNum">     370 </span>            :                                                                                                          TMath::Nint(pedestalMean + fgNSigmas*pedestalSigma + 0.5),
<span class="lineNum">     371 </span>            :                                                                                                          fgNSigmas,addNoise,noiseOnly));
<span class="lineNum">     372 </span>            :     }
<span class="lineNum">     373 </span>            :     
<span class="lineNum">     374 </span>            :     adc = 0;
<span class="lineNum">     375 </span><span class="lineCov">        149 :   }</span>
<span class="lineNum">     376 </span>            :   
<span class="lineNum">     377 </span>            :   // be sure we stick to 12 bits.
<span class="lineNum">     378 </span><span class="lineCov">        857 :   if ( adc &gt; kMaxADC )</span>
<span class="lineNum">     379 </span>            :   {
<span class="lineNum">     380 </span>            :     adc = kMaxADC;
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     382 </span>            :   
<span class="lineNum">     383 </span>            :   return adc;
<span class="lineNum">     384 </span><span class="lineCov">        857 : }</span>
<span class="lineNum">     385 </span>            : 
<a name="386"><span class="lineNum">     386 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     387 </span>            : void
<span class="lineNum">     388 </span>            : AliMUONDigitizerV3::CreateInputDigitStores()
<span class="lineNum">     389 </span>            : {
<span class="lineNum">     390 </span>            :   /// Create input digit stores
<span class="lineNum">     391 </span>            :   /// 
<span class="lineNum">     392 </span>            :   
<span class="lineNum">     393 </span><span class="lineCov">          2 :   if (fInputDigitStores)</span>
<span class="lineNum">     394 </span>            :   {
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     AliFatal(&quot;Should be called only once !&quot;);</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     397 </span>            :   
<span class="lineNum">     398 </span><span class="lineCov">          2 :   fInputDigitStores = new TObjArray;</span>
<span class="lineNum">     399 </span>            :   
<span class="lineNum">     400 </span><span class="lineCov">          1 :   fInputDigitStores-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     401 </span>            :   
<span class="lineNum">     402 </span><span class="lineCov">          4 :   for ( Int_t iFile = 0; iFile &lt; fDigInput-&gt;GetNinputs(); ++iFile )</span>
<span class="lineNum">     403 </span>            :   {    
<span class="lineNum">     404 </span><span class="lineCov">          1 :     AliLoader* inputLoader = GetLoader(fDigInput-&gt;GetInputFolderName(iFile));</span>
<span class="lineNum">     405 </span>            :     
<span class="lineNum">     406 </span><span class="lineCov">          1 :     inputLoader-&gt;LoadSDigits(&quot;READ&quot;);</span>
<span class="lineNum">     407 </span>            :     
<span class="lineNum">     408 </span><span class="lineCov">          1 :     TTree* iTreeS = inputLoader-&gt;TreeS();</span>
<span class="lineNum">     409 </span><span class="lineCov">          1 :     if (!iTreeS)</span>
<span class="lineNum">     410 </span>            :     {
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :       AliFatal(Form(&quot;Could not get access to input file #%d&quot;,iFile));</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     413 </span>            :     
<span class="lineNum">     414 </span><span class="lineCov">          1 :     fInputDigitStores-&gt;AddAt(AliMUONVDigitStore::Create(*iTreeS),iFile);</span>
<span class="lineNum">     415 </span>            :   }
<span class="lineNum">     416 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     417 </span>            : 
<a name="418"><span class="lineNum">     418 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     419 </span>            : void
<span class="lineNum">     420 </span>            : AliMUONDigitizerV3::Digitize(Option_t*)
<span class="lineNum">     421 </span>            : {
<span class="lineNum">     422 </span>            :   /// Main method.
<span class="lineNum">     423 </span>            :   /// We first loop over input files, and merge the sdigits we found there.
<span class="lineNum">     424 </span>            :   /// Second, we digitize all the resulting sdigits
<span class="lineNum">     425 </span>            :   /// Then we generate noise-only digits (for tracker only)
<span class="lineNum">     426 </span>            :   /// And we finally generate the trigger outputs.
<span class="lineNum">     427 </span>            :     
<span class="lineNum">     428 </span><span class="lineCov">          8 :   AliCodeTimerAuto(&quot;&quot;,0)</span>
<span class="lineNum">     429 </span>            :   
<span class="lineNum">     430 </span><span class="lineCov">          4 :   if ( fDigInput-&gt;GetNinputs() == 0 )</span>
<span class="lineNum">     431 </span>            :   {
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :     AliWarning(&quot;No input set. Nothing to do.&quot;);</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     434 </span>            :   }
<span class="lineNum">     435 </span>            :   
<span class="lineNum">     436 </span><span class="lineCov">          4 :   if ( !fIsInitialized )</span>
<span class="lineNum">     437 </span>            :   {
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :     AliError(&quot;Not initialized. Cannot perform the work. Sorry&quot;);</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     440 </span>            :   }
<span class="lineNum">     441 </span>            :   
<span class="lineNum">     442 </span><span class="lineCov">          4 :   Int_t nInputFiles = fDigInput-&gt;GetNinputs();</span>
<span class="lineNum">     443 </span>            :   
<span class="lineNum">     444 </span><span class="lineCov">         16 :   AliLoader* outputLoader = GetLoader(fDigInput-&gt;GetOutputFolderName());</span>
<span class="lineNum">     445 </span>            :   
<span class="lineNum">     446 </span><span class="lineCov">          4 :   outputLoader-&gt;MakeDigitsContainer();</span>
<span class="lineNum">     447 </span>            :   
<span class="lineNum">     448 </span><span class="lineCov">          4 :   TTree* oTreeD = outputLoader-&gt;TreeD();</span>
<span class="lineNum">     449 </span>            :   
<span class="lineNum">     450 </span><span class="lineCov">          4 :   if (!oTreeD) </span>
<span class="lineNum">     451 </span>            :   {
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :     AliFatal(&quot;Cannot create output TreeD&quot;);</span>
<span class="lineNum">     453 </span>            :   }
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span>            :   // Loop over all the input files, and merge the sdigits found in those
<span class="lineNum">     456 </span>            :   // files.
<span class="lineNum">     457 </span>            :   
<span class="lineNum">     458 </span><span class="lineCov">         16 :   for ( Int_t iFile = 0; iFile &lt; nInputFiles; ++iFile )</span>
<span class="lineNum">     459 </span>            :   {  
<span class="lineNum">     460 </span><span class="lineCov">          8 :     AliLoader* inputLoader = GetLoader(fDigInput-&gt;GetInputFolderName(iFile));</span>
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineCov">          4 :     inputLoader-&gt;LoadSDigits(&quot;READ&quot;);</span>
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span><span class="lineCov">          4 :     TTree* iTreeS = inputLoader-&gt;TreeS();</span>
<span class="lineNum">     465 </span><span class="lineCov">          4 :     if (!iTreeS)</span>
<span class="lineNum">     466 </span>            :     {
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :       AliFatal(Form(&quot;Could not get access to input file #%d&quot;,iFile));</span>
<span class="lineNum">     468 </span>            :     }
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span><span class="lineCov">          4 :     if (!fInputDigitStores)</span>
<span class="lineNum">     471 </span>            :     {
<span class="lineNum">     472 </span><span class="lineCov">          1 :       CreateInputDigitStores();      </span>
<span class="lineNum">     473 </span>            :     }
<span class="lineNum">     474 </span>            :     
<span class="lineNum">     475 </span><span class="lineCov">          8 :     AliMUONVDigitStore* dstore = static_cast&lt;AliMUONVDigitStore*&gt;(fInputDigitStores-&gt;At(iFile));</span>
<span class="lineNum">     476 </span>            :     
<span class="lineNum">     477 </span><span class="lineCov">          4 :     dstore-&gt;Connect(*iTreeS);</span>
<span class="lineNum">     478 </span>            :     
<span class="lineNum">     479 </span><span class="lineCov">          4 :     iTreeS-&gt;GetEvent(0);</span>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span><span class="lineCov">          4 :     MergeWithSDigits(fDigitStore,*dstore,fDigInput-&gt;GetMask(iFile));</span>
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span><span class="lineCov">          4 :     inputLoader-&gt;UnloadSDigits();</span>
<span class="lineNum">     484 </span>            :     
<span class="lineNum">     485 </span><span class="lineCov">          4 :     dstore-&gt;Clear();</span>
<span class="lineNum">     486 </span>            :   }
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span>            :   
<span class="lineNum">     489 </span>            :   // At this point, we do have digit arrays (one per chamber) which contains 
<span class="lineNum">     490 </span>            :   // the merging of all the sdigits of the input file(s).
<span class="lineNum">     491 </span>            :   // We now massage them to apply the detector response, i.e. this
<span class="lineNum">     492 </span>            :   // is here that we do the &quot;digitization&quot; work.
<span class="lineNum">     493 </span>            :   
<span class="lineNum">     494 </span><span class="lineCov">          4 :   if (!fOutputDigitStore)</span>
<span class="lineNum">     495 </span>            :   {
<span class="lineNum">     496 </span><span class="lineCov">          2 :     fOutputDigitStore = fDigitStore-&gt;Create();</span>
<span class="lineNum">     497 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     498 </span>            :   
<span class="lineNum">     499 </span><span class="lineCov">          4 :   if ( fGenerateNoisyDigits&gt;=2 )</span>
<span class="lineNum">     500 </span>            :   {
<span class="lineNum">     501 </span>            :     // Generate noise-only digits for trigger.
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :     GenerateNoisyDigitsForTrigger(*fDigitStore);</span>
<span class="lineNum">     503 </span>            :   }
<span class="lineNum">     504 </span><span class="lineCov">          4 :   ApplyResponse(*fDigitStore,*fOutputDigitStore);</span>
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span><span class="lineCov">          4 :   if ( fGenerateNoisyDigits )</span>
<span class="lineNum">     507 </span>            :   {
<span class="lineNum">     508 </span>            :     // Generate noise-only digits for tracker.
<span class="lineNum">     509 </span><span class="lineCov">          4 :     GenerateNoisyDigits(*fOutputDigitStore);</span>
<span class="lineNum">     510 </span>            :   }
<span class="lineNum">     511 </span>            :   
<span class="lineNum">     512 </span>            :   // We generate the global and local trigger decisions.
<span class="lineNum">     513 </span><span class="lineCov">          4 :   fTriggerProcessor-&gt;Digits2Trigger(*fOutputDigitStore,*fTriggerStore);</span>
<span class="lineNum">     514 </span>            : 
<span class="lineNum">     515 </span>            :   // Prepare output tree
<span class="lineNum">     516 </span><span class="lineCov">          8 :   Bool_t okD = fOutputDigitStore-&gt;Connect(*oTreeD,kFALSE);</span>
<span class="lineNum">     517 </span><span class="lineCov">          8 :   Bool_t okT = fTriggerStore-&gt;Connect(*oTreeD,kFALSE);</span>
<span class="lineNum">     518 </span><span class="lineCov">          8 :   if (!okD || !okT)</span>
<span class="lineNum">     519 </span>            :   {
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Could not make branch : Digit %d Trigger %d&quot;,okD,okT));</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     522 </span>            :   }
<span class="lineNum">     523 </span>            :   
<span class="lineNum">     524 </span>            :   // Fill the output treeD
<span class="lineNum">     525 </span><span class="lineCov">          4 :   oTreeD-&gt;Fill();</span>
<span class="lineNum">     526 </span>            :   
<span class="lineNum">     527 </span>            :   // Write to the output tree(D).
<span class="lineNum">     528 </span>            :   // Please note that as GlobalTrigger, LocalTrigger and Digits are in the same
<span class="lineNum">     529 </span>            :   // tree (=TreeD) in different branches, this WriteDigits in fact writes all of 
<span class="lineNum">     530 </span>            :   // the 3 branches.
<span class="lineNum">     531 </span><span class="lineCov">          4 :   outputLoader-&gt;WriteDigits(&quot;OVERWRITE&quot;);  </span>
<span class="lineNum">     532 </span>            :   
<span class="lineNum">     533 </span><span class="lineCov">          4 :   outputLoader-&gt;UnloadDigits();</span>
<span class="lineNum">     534 </span>            :   
<span class="lineNum">     535 </span>            :   // Finally, we clean up after ourselves.
<span class="lineNum">     536 </span><span class="lineCov">          4 :   fTriggerStore-&gt;Clear();</span>
<span class="lineNum">     537 </span><span class="lineCov">          4 :   fDigitStore-&gt;Clear();</span>
<span class="lineNum">     538 </span><span class="lineCov">          4 :   fOutputDigitStore-&gt;Clear();</span>
<span class="lineNum">     539 </span><span class="lineCov">          8 : }</span>
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span>            : 
<a name="542"><span class="lineNum">     542 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     543 </span>            : void
<span class="lineNum">     544 </span>            : AliMUONDigitizerV3::GenerateNoisyDigits(AliMUONVDigitStore&amp; digitStore)
<span class="lineNum">     545 </span>            : {
<span class="lineNum">     546 </span>            :   /// According to a given probability, generate digits that
<span class="lineNum">     547 </span>            :   /// have a signal above the noise cut (ped+n*sigma_ped), i.e. digits
<span class="lineNum">     548 </span>            :   /// that are &quot;only noise&quot;.
<span class="lineNum">     549 </span>            :   
<span class="lineNum">     550 </span><span class="lineCov">          8 :   AliCodeTimerAuto(&quot;&quot;,0)</span>
<span class="lineNum">     551 </span>            :   
<span class="lineNum">     552 </span><span class="lineCov">        132 :   for ( Int_t i = 0; i &lt; AliMUONConstants::NTrackingCh(); ++i )</span>
<span class="lineNum">     553 </span>            :   {
<span class="lineNum">     554 </span><span class="lineCov">         40 :     AliMpDEIterator it;</span>
<span class="lineNum">     555 </span>            :   
<span class="lineNum">     556 </span><span class="lineCov">         40 :     it.First(i);</span>
<span class="lineNum">     557 </span>            :   
<span class="lineNum">     558 </span><span class="lineCov">       1328 :     while ( !it.IsDone() )</span>
<span class="lineNum">     559 </span>            :     {
<span class="lineNum">     560 </span><span class="lineCov">       3744 :       for ( Int_t cathode = 0; cathode &lt; 2; ++cathode )</span>
<span class="lineNum">     561 </span>            :       {
<span class="lineNum">     562 </span><span class="lineCov">       2496 :         GenerateNoisyDigitsForOneCathode(digitStore,it.CurrentDEId(),cathode);</span>
<span class="lineNum">     563 </span>            :       }
<span class="lineNum">     564 </span><span class="lineCov">        624 :       it.Next();</span>
<span class="lineNum">     565 </span>            :     }
<span class="lineNum">     566 </span><span class="lineCov">         40 :   }</span>
<span class="lineNum">     567 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">     568 </span>            :  
<a name="569"><span class="lineNum">     569 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     570 </span>            : void
<span class="lineNum">     571 </span>            : AliMUONDigitizerV3::GenerateNoisyDigitsForOneCathode(AliMUONVDigitStore&amp; digitStore,
<span class="lineNum">     572 </span>            :                                                      Int_t detElemId, Int_t cathode)
<span class="lineNum">     573 </span>            : {
<span class="lineNum">     574 </span>            :   /// Generate noise-only digits for one cathode of one detection element.
<span class="lineNum">     575 </span>            :   /// Called by GenerateNoisyDigits()
<span class="lineNum">     576 </span>            :   
<span class="lineNum">     577 </span>            :   const AliMpVSegmentation* seg 
<span class="lineNum">     578 </span><span class="lineCov">       2496 :     = AliMpSegmentation::Instance()-&gt;GetMpSegmentation(detElemId,AliMp::GetCathodType(cathode));</span>
<span class="lineNum">     579 </span><span class="lineCov">       1248 :   Int_t nofPads = seg-&gt;NofPads();</span>
<span class="lineNum">     580 </span>            :   
<span class="lineNum">     581 </span><span class="lineCov">       1248 :   Int_t maxIx = seg-&gt;MaxPadIndexX();</span>
<span class="lineNum">     582 </span><span class="lineCov">       1248 :   Int_t maxIy = seg-&gt;MaxPadIndexY();</span>
<span class="lineNum">     583 </span>            :   
<span class="lineNum">     584 </span><span class="lineCov">       1251 :   static const Double_t kProbToBeOutsideNsigmas = TMath::Erfc(fgNSigmas/TMath::Sqrt(2.0)) / 2. ;</span>
<span class="lineNum">     585 </span>            :   
<span class="lineNum">     586 </span><span class="lineCov">       1248 :   Int_t nofNoisyPads = TMath::Nint(kProbToBeOutsideNsigmas*nofPads);</span>
<span class="lineNum">     587 </span><span class="lineCov">       2496 :   if ( !nofNoisyPads ) return;</span>
<span class="lineNum">     588 </span>            :   
<span class="lineNum">     589 </span>            :   nofNoisyPads = 
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :     TMath::Nint(gRandom-&gt;Gaus(nofNoisyPads,</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :                               nofNoisyPads/TMath::Sqrt(nofNoisyPads)));</span>
<span class="lineNum">     592 </span>            :   
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :   AliDebug(3,Form(&quot;DE %d cath %d nofNoisyPads %d&quot;,detElemId,cathode,nofNoisyPads));</span>
<span class="lineNum">     594 </span>            :   
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :   for ( Int_t i = 0; i &lt; nofNoisyPads; ++i ) </span>
<span class="lineNum">     596 </span>            :   {
<span class="lineNum">     597 </span>            :     Int_t ix(-1);
<span class="lineNum">     598 </span>            :     Int_t iy(-1);
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :     AliMpPad pad;</span>
<span class="lineNum">     600 </span>            :     
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :     do {</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :       ix = gRandom-&gt;Integer(maxIx+1);</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :       iy = gRandom-&gt;Integer(maxIy+1);</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :       pad = seg-&gt;PadByIndices(ix,iy,kFALSE);</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :     } while ( !pad.IsValid() );</span>
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     Int_t manuId = pad.GetManuId();</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :     Int_t manuChannel = pad.GetManuChannel();    </span>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     AliMUONVCalibParam* pedestals = fCalibrationData-&gt;Pedestals(detElemId,manuId);</span>
<span class="lineNum">     611 </span>            :     
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     if (!pedestals) </span>
<span class="lineNum">     613 </span>            :     {
<span class="lineNum">     614 </span>            :       // no pedestal available for this channel, simply give up
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     616 </span>            :     }
<span class="lineNum">     617 </span>            :     
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     AliMUONVDigit* d = digitStore.CreateDigit(detElemId,manuId,manuChannel,cathode);</span>
<span class="lineNum">     619 </span>            :     
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :     d-&gt;SetPadXY(ix,iy);</span>
<span class="lineNum">     621 </span>            :     
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :     d-&gt;SetCharge(0.0); // charge is zero, the ApplyResponseToTrackerDigit will add the noise</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :     d-&gt;NoiseOnly(kTRUE);</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :     ApplyResponseToTrackerDigit(*d,kTRUE);</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :     if ( d-&gt;ADC() &gt; 0 )</span>
<span class="lineNum">     626 </span>            :     {
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :       Bool_t ok = digitStore.Add(*d,AliMUONVDigitStore::kDeny);</span>
<span class="lineNum">     628 </span>            :       // this can happen (that we randomly chose a digit that is
<span class="lineNum">     629 </span>            :       // already there). We simply ignore this, but log the occurence
<span class="lineNum">     630 </span>            :       // to cross-check that it's not too frequent.
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :       if (!ok)</span>
<span class="lineNum">     632 </span>            :       {
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :         fLogger-&gt;Log(&quot;Collision while adding noiseOnly digit&quot;);</span>
<span class="lineNum">     634 </span>            :       }
<span class="lineNum">     635 </span>            :       else
<span class="lineNum">     636 </span>            :       {
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :         fLogger-&gt;Log(&quot;Added noiseOnly digit&quot;);</span>
<span class="lineNum">     638 </span>            :       }
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :     delete d;</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     642 </span><span class="lineCov">       1248 : }</span>
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span>            : 
<a name="645"><span class="lineNum">     645 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     646 </span>            : void
<span class="lineNum">     647 </span>            : AliMUONDigitizerV3::GenerateNoisyDigitsForTrigger(AliMUONVDigitStore&amp; digitStore)
<span class="lineNum">     648 </span>            : {
<span class="lineNum">     649 </span>            :   /// Generate noise-only digits for one cathode of one detection element.
<span class="lineNum">     650 </span>            :   /// Called by GenerateNoisyDigits()
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :   if ( !fNoiseFunctionTrig )</span>
<span class="lineNum">     653 </span>            :   {
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :     fNoiseFunctionTrig = new TF1(&quot;AliMUONDigitizerV3::fNoiseFunctionTrig&quot;,&quot;landau&quot;,</span>
<span class="lineNum">     655 </span>            :                                  50.,270.);
<span class="lineNum">     656 </span>            :     
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :     fNoiseFunctionTrig-&gt;SetParameters(3.91070e+02, 9.85026, 9.35881e-02);</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :   AliMpPad pad[2];</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :   AliMUONVDigit *d[2]={0x0};</span>
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :   for ( Int_t chamberId = AliMUONConstants::NTrackingCh(); chamberId &lt; AliMUONConstants::NCh(); ++chamberId )</span>
<span class="lineNum">     664 </span>            :   {
<span class="lineNum">     665 </span>            :   
<span class="lineNum">     666 </span>            :     Int_t nofNoisyPads = 50;
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :     Float_t r=-1, fi = 0., gx, gy, x, y, z, xg01, yg01, zg, xg02, yg02;</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :     AliMpDEIterator it;</span>
<span class="lineNum">     670 </span>            :   
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :     AliDebug(3,Form(&quot;Chamber %d nofNoisyPads %d&quot;,chamberId,nofNoisyPads));</span>
<span class="lineNum">     672 </span>            : 
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :     for ( Int_t i = 0; i &lt; nofNoisyPads; ++i )</span>
<span class="lineNum">     674 </span>            :     {
<span class="lineNum">     675 </span>            :       //printf(&quot;Generating noise %i\n&quot;,i);
<span class="lineNum">     676 </span>            :         Int_t ix(-1);
<span class="lineNum">     677 </span>            :         Int_t iy(-1);
<span class="lineNum">     678 </span>            :         Bool_t isOk = kFALSE;
<span class="lineNum">     679 </span>            :         Int_t detElemId = -1;
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :         do {</span>
<span class="lineNum">     681 </span>            :           //r = gRandom-&gt;Landau(9.85026, 9.35881e-02);
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :             r = fNoiseFunctionTrig-&gt;GetRandom();</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :             fi = 2. * TMath::Pi() * gRandom-&gt;Rndm();</span>
<span class="lineNum">     684 </span>            :             //printf(&quot;r = %f\tfi = %f\n&quot;, r, fi);
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :             gx = r * TMath::Cos(fi);</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :             gy = r * TMath::Sin(fi);</span>
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :             for ( it.First(chamberId); ! it.IsDone(); it.Next() ){</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :                 Int_t currDetElemId = it.CurrentDEId();</span>
<span class="lineNum">     690 </span>            :                 const AliMpVSegmentation* seg
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :                     = AliMpSegmentation::Instance()-&gt;GetMpSegmentation(currDetElemId,AliMp::GetCathodType(0));</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :                 if (!seg) continue;</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :                 Float_t deltax = seg-&gt;GetDimensionX();</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :                 Float_t deltay = seg-&gt;GetDimensionY();</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :                 GetTransformer()-&gt;Local2Global(currDetElemId, -deltax, -deltay, 0, xg01, yg01, zg);</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :                 GetTransformer()-&gt;Local2Global(currDetElemId,  deltax,  deltay, 0, xg02, yg02, zg);</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :                 Float_t xg1 = xg01, xg2 = xg02, yg1 = yg01, yg2 = yg02;</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :                 if(xg01&gt;xg02){</span>
<span class="lineNum">     699 </span>            :                     xg1 = xg02;
<span class="lineNum">     700 </span>            :                     xg2 = xg01;
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :                 if(yg01&gt;yg02){</span>
<span class="lineNum">     703 </span>            :                     yg1 = yg02;
<span class="lineNum">     704 </span>            :                     yg2 = yg01;
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :                 if(gx&gt;=xg1 &amp;&amp; gx&lt;=xg2 &amp;&amp; gy&gt;=yg1 &amp;&amp; gy&lt;=yg2){</span>
<span class="lineNum">     707 </span>            :                     detElemId = currDetElemId;
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :                     GetTransformer()-&gt;Global2Local(detElemId, gx, gy, 0, x, y, z);</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :                     pad[0] = seg-&gt;PadByPosition(x,y,kFALSE);</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :                     if(!pad[0].IsValid()) continue;</span>
<span class="lineNum">     711 </span>            :                     isOk = kTRUE;
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">     713 </span>            :                 }
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :             } // loop on slats</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :         } while ( !isOk );</span>
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span>            :         const AliMpVSegmentation* seg1
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :             = AliMpSegmentation::Instance()-&gt;GetMpSegmentation(detElemId,AliMp::GetCathodType(1));</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :         pad[1] = seg1-&gt;PadByPosition(x,y,kFALSE);</span>
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :         for ( Int_t cathode = 0; cathode &lt; 2; ++cathode ){</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :           Int_t manuId = pad[cathode].GetLocalBoardId(0);</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :           Int_t manuChannel = pad[cathode].GetLocalBoardChannel(0);    </span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :           d[cathode] = digitStore.CreateDigit(detElemId,manuId,manuChannel,cathode);</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :           ix = pad[cathode].GetIx();</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :           iy = pad[cathode].GetIy();</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :           d[cathode]-&gt;SetPadXY(ix,iy);</span>
<span class="lineNum">     728 </span>            :           //d[cathode].SetSignal(1);
<span class="lineNum">     729 </span>            :           //d[cathode].SetPhysicsSignal(0);
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :           d[cathode]-&gt;SetCharge(1);</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :           d[cathode]-&gt;NoiseOnly(kTRUE);</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :           AliDebug(3,Form(&quot;Adding a pure noise digit :&quot;));</span>
<span class="lineNum">     733 </span>            : 
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :           Bool_t ok = digitStore.Add(*d[cathode],AliMUONVDigitStore::kDeny);</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :           if (!ok)</span>
<span class="lineNum">     736 </span>            :           {
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :               fLogger-&gt;Log(&quot;Collision while adding TriggerNoise digit&quot;);</span>
<span class="lineNum">     738 </span>            :           }
<span class="lineNum">     739 </span>            :           else
<span class="lineNum">     740 </span>            :           {
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :               fLogger-&gt;Log(&quot;Added triggerNoise digit&quot;);</span>
<span class="lineNum">     742 </span>            :           }
<span class="lineNum">     743 </span>            :         } //loop on cathodes
<span class="lineNum">     744 </span>            :     } // loop on noisy pads
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :   } // loop on chambers</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     747 </span>            : 
<span class="lineNum">     748 </span>            : 
<a name="749"><span class="lineNum">     749 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     750 </span>            : AliLoader*
<span class="lineNum">     751 </span>            : AliMUONDigitizerV3::GetLoader(const TString&amp; folderName)
<span class="lineNum">     752 </span>            : {
<span class="lineNum">     753 </span>            :   /// Get a MUON loader
<span class="lineNum">     754 </span>            : 
<span class="lineNum">     755 </span><span class="lineCov">         36 :   AliDebug(2,Form(&quot;Getting access to folder %s&quot;,folderName.Data()));</span>
<span class="lineNum">     756 </span><span class="lineCov">          9 :   AliLoader* loader = AliRunLoader::GetDetectorLoader(&quot;MUON&quot;,folderName.Data());</span>
<span class="lineNum">     757 </span><span class="lineCov">          9 :   if (!loader)</span>
<span class="lineNum">     758 </span>            :   {
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Could not get MuonLoader from folder %s&quot;,folderName.Data()));</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     return 0x0;</span>
<span class="lineNum">     761 </span>            :   }
<span class="lineNum">     762 </span><span class="lineCov">          9 :   return loader;</span>
<span class="lineNum">     763 </span><span class="lineCov">          9 : }</span>
<span class="lineNum">     764 </span>            : 
<a name="765"><span class="lineNum">     765 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     766 </span>            : Bool_t
<span class="lineNum">     767 </span>            : AliMUONDigitizerV3::Init()
<span class="lineNum">     768 </span>            : {
<span class="lineNum">     769 </span>            :   /// Initialization of the digitization :
<span class="lineNum">     770 </span>            :   /// a) create the calibrationData, according to run number
<span class="lineNum">     771 </span>            :   /// b) create the trigger processing task
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span><span class="lineCov">          4 :   AliDebug(2,&quot;&quot;);</span>
<span class="lineNum">     774 </span>            :   
<span class="lineNum">     775 </span><span class="lineCov">          1 :   if ( fIsInitialized )</span>
<span class="lineNum">     776 </span>            :   {
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :     AliError(&quot;Object already initialized.&quot;);</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     779 </span>            :   }
<span class="lineNum">     780 </span>            :   
<span class="lineNum">     781 </span><span class="lineCov">          1 :   if (!fDigInput)</span>
<span class="lineNum">     782 </span>            :   {
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :     AliError(&quot;fDigInput is null !&quot;);</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     785 </span>            :   }
<span class="lineNum">     786 </span>            :   
<span class="lineNum">     787 </span>            :   // Load mapping
<span class="lineNum">     788 </span><span class="lineCov">          1 :   if ( ! AliMpCDB::LoadDDLStore() ) {</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :     AliFatal(&quot;Could not access mapping from OCDB !&quot;);</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     791 </span>            :   
<span class="lineNum">     792 </span><span class="lineCov">          1 :   if (!fCalibrationData)</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :       AliFatal(&quot;Calibration data object not defined&quot;);</span>
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span><span class="lineCov">          1 :   if ( !fCalibrationData-&gt;Pedestals() )</span>
<span class="lineNum">     796 </span>            :   {
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :     AliFatal(&quot;Could not access pedestals from OCDB !&quot;);</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     799 </span>            :   
<span class="lineNum">     800 </span><span class="lineCov">          1 :   AliInfo(&quot;Using trigger configuration from CDB&quot;);</span>
<span class="lineNum">     801 </span>            :   
<span class="lineNum">     802 </span><span class="lineCov">          2 :   fTriggerProcessor = new AliMUONTriggerElectronics(fCalibrationData);</span>
<span class="lineNum">     803 </span>            :   
<span class="lineNum">     804 </span><span class="lineCov">          3 :   AliDebug(1, Form(&quot;Will %s generate noise-only digits for tracker&quot;,</span>
<span class="lineNum">     805 </span>            :                      (fGenerateNoisyDigits ? &quot;&quot;:&quot;NOT&quot;)));
<span class="lineNum">     806 </span>            :   
<span class="lineNum">     807 </span><span class="lineCov">          2 :   fTriggerUtilities = new AliMUONTriggerUtilities(fCalibrationData);</span>
<span class="lineNum">     808 </span>            :   
<span class="lineNum">     809 </span><span class="lineCov">          1 :   if ( muon()-&gt;GetTriggerEffCells() ) {</span>
<span class="lineNum">     810 </span>            :     // Apply trigger efficiency
<span class="lineNum">     811 </span><span class="lineCov">          3 :     AliDebug(1, &quot;Will apply trigger efficiency&quot;);</span>
<span class="lineNum">     812 </span><span class="lineCov">          3 :     fTriggerEfficiency = new AliMUONTriggerChamberEfficiency(fCalibrationData-&gt;TriggerEfficiency());</span>
<span class="lineNum">     813 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span><span class="lineCov">          1 :   fIsInitialized = kTRUE;</span>
<span class="lineNum">     816 </span><span class="lineCov">          1 :   return kTRUE;</span>
<span class="lineNum">     817 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     818 </span>            : 
<a name="819"><span class="lineNum">     819 </span>            : </a>
<span class="lineNum">     820 </span>            : //_____________________________________________________________________________
<span class="lineNum">     821 </span>            : Int_t AliMUONDigitizerV3::GetArrayIndex(Int_t cathode, Int_t trigCh, Int_t localCircuit)
<span class="lineNum">     822 </span>            : {
<span class="lineNum">     823 </span>            :   /// Get index of array with trigger status map or efficiency
<span class="lineNum">     824 </span><span class="lineCov">        198 :   return</span>
<span class="lineNum">     825 </span><span class="lineCov">        594 :     AliMUONConstants::NTriggerCircuit() * AliMUONConstants::NTriggerCh() * cathode +</span>
<span class="lineNum">     826 </span><span class="lineCov">        396 :     AliMUONConstants::NTriggerCircuit() * trigCh + localCircuit-1;</span>
<span class="lineNum">     827 </span>            : }
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span>            : 
<a name="830"><span class="lineNum">     830 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     831 </span>            : void 
<span class="lineNum">     832 </span>            : AliMUONDigitizerV3::MergeWithSDigits(AliMUONVDigitStore*&amp; outputStore,
<span class="lineNum">     833 </span>            :                                      const AliMUONVDigitStore&amp; input,
<span class="lineNum">     834 </span>            :                                      Int_t mask)
<span class="lineNum">     835 </span>            : {
<span class="lineNum">     836 </span>            :   /// Merge the sdigits in inputData with the digits already present in outputData
<span class="lineNum">     837 </span>            :   
<span class="lineNum">     838 </span><span class="lineCov">          9 :   if ( !outputStore ) outputStore = input.Create();</span>
<span class="lineNum">     839 </span>            :   
<span class="lineNum">     840 </span><span class="lineCov">          4 :   TIter next(input.CreateIterator());</span>
<span class="lineNum">     841 </span>            :   AliMUONVDigit* sdigit;
<span class="lineNum">     842 </span>            :   
<span class="lineNum">     843 </span><span class="lineCov">       2919 :   while ( ( sdigit = static_cast&lt;AliMUONVDigit*&gt;(next()) ) )</span>
<span class="lineNum">     844 </span>            :   {
<span class="lineNum">     845 </span>            :     // Update the track references using the mask.
<span class="lineNum">     846 </span>            :     // FIXME: this is dirty, for backward compatibility only.
<span class="lineNum">     847 </span>            :     // Should re-design all this way of keeping track of MC information...
<span class="lineNum">     848 </span><span class="lineCov">        969 :     if ( mask ) sdigit-&gt;PatchTracks(mask);</span>
<span class="lineNum">     849 </span>            :     // Then add or update the digit to the output.
<span class="lineNum">     850 </span><span class="lineCov">        969 :     AliMUONVDigit* added = outputStore-&gt;Add(*sdigit,AliMUONVDigitStore::kMerge);</span>
<span class="lineNum">     851 </span><span class="lineCov">        969 :     if (!added)</span>
<span class="lineNum">     852 </span>            :     {
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :       AliError(&quot;Could not add digit in merge mode&quot;);</span>
<span class="lineNum">     854 </span>            :     }
<span class="lineNum">     855 </span>            :   }
<span class="lineNum">     856 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">     857 </span>            : 
<a name="858"><span class="lineNum">     858 </span>            : //_____________________________________________________________________________</a>
<span class="lineNum">     859 </span>            : TF1*
<span class="lineNum">     860 </span>            : AliMUONDigitizerV3::NoiseFunction()
<span class="lineNum">     861 </span>            : {
<span class="lineNum">     862 </span>            :   /// Return noise function
<span class="lineNum">     863 </span>            :   static TF1* f = 0x0;
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :   if (!f)</span>
<span class="lineNum">     865 </span>            :   {
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :     f = new TF1(&quot;AliMUONDigitizerV3::NoiseFunction&quot;,&quot;gaus&quot;,fgNSigmas,fgNSigmas*10);</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :     f-&gt;SetParameters(1,0,1);</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :   return f;</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 : }</span>
<a name="871"><span class="lineNum">     871 </span>            : </a>
<span class="lineNum">     872 </span>            : //_____________________________________________________________________________
<span class="lineNum">     873 </span>            : void AliMUONDigitizerV3::SetCalibrationData(AliMUONCalibrationData* calibrationData, 
<span class="lineNum">     874 </span>            :                                             AliMUONRecoParam* recoParam) 
<span class="lineNum">     875 </span>            : {
<span class="lineNum">     876 </span><span class="lineCov">          2 :   fCalibrationData = calibrationData;</span>
<span class="lineNum">     877 </span><span class="lineCov">          1 :   fRecoParam = recoParam;</span>
<span class="lineNum">     878 </span><span class="lineCov">          1 :   if (!fRecoParam)</span>
<span class="lineNum">     879 </span>            :   {
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :     AliError(&quot;Cannot work (e.g. decalibrate) without recoparams !&quot;);</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     882 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     883 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
