<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - PHOS/PHOSrec/AliPHOSEvalRecPoint.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">PHOS/PHOSrec</a> - AliPHOSEvalRecPoint.cxx<span style="font-size: 80%;"> (source / <a href="AliPHOSEvalRecPoint.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">564</td>
            <td class="headerCovTableEntryLo">0.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">33</td>
            <td class="headerCovTableEntryLo">3.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : /* $Id$ */
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : //*-- Author: Boris Polichtchouk, IHEP
<span class="lineNum">      19 </span>            : //////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      20 </span>            : // Reconstructed point operations for the Clusterization class for IHEP reconstruction.
<span class="lineNum">      21 </span>            : // Performs clusterization (collects neighbouring active cells)
<span class="lineNum">      22 </span>            : // It differs from AliPHOSClusterizerv1 in neighbour definition only
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : // ---- ROOT system ---
<span class="lineNum">      25 </span>            : #include &lt;TMath.h&gt;
<span class="lineNum">      26 </span>            : #include &lt;TDirectory.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;TBranch.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;TTree.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;TROOT.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;TFolder.h&gt;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : // --- AliRoot header files ---
<span class="lineNum">      33 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;AliConfig.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;AliPHOSDigit.h&quot; 
<span class="lineNum">      36 </span>            : #include &quot;AliPHOSClusterizer.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;AliPHOSEvalRecPoint.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;AliRun.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;AliPHOSLoader.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;AliPHOSRecCpvManager.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;AliPHOSRecEmcManager.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;AliPHOSDigitizer.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;AliPHOSGeometry.h&quot; 
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : // --- Standard library ---
<a name="46"><span class="lineNum">      46 </span>            : </a>
<span class="lineNum">      47 </span>            : 
<a name="48"><span class="lineNum">      48 </span><span class="lineCov">         20 : ClassImp(AliPHOSEvalRecPoint)</span></a>
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span><span class="lineNoCov">          0 : AliPHOSEvalRecPoint::AliPHOSEvalRecPoint() :</span>
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :   fIsEmc(kFALSE),</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   fIsCpv(kTRUE),</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :   fParent(-333),</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :   fChi2Dof(-111),</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :   fEventFolderName(AliConfig::GetDefaultEventFolderName())</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      57 </span>            :   // default ctor
<a name="58"><span class="lineNum">      58 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span><span class="lineNoCov">          0 : AliPHOSEvalRecPoint::AliPHOSEvalRecPoint(Bool_t cpv, AliPHOSEvalRecPoint* parent) : </span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :   fIsEmc(kFALSE),</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :   fIsCpv(kFALSE),</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :   fParent(-333),</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :   fChi2Dof(-111),</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   fEventFolderName(&quot;&quot;)</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      67 </span>            :   // ctor
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :   fParent=-333;</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :   fChi2Dof=-111;</span>
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            : //    fParent=parent;
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :   TObjArray* wPool = (TObjArray*)GetWorkingPool();</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :   if(!wPool) {</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :     Fatal(&quot;ctor&quot;, &quot;Couldn't find working pool&quot;) ; </span>
<span class="lineNum">      75 </span>            :   }
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :   if(wPool)</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :     fParent = wPool-&gt;IndexOf((TObject*)parent);</span>
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :   fChi2Dof = parent-&gt;Chi2Dof();</span>
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :   if(cpv) {</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :     fIsEmc = kFALSE;</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :     fIsCpv = kTRUE;</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">      86 </span>            :   else {
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :     fIsEmc = kTRUE;</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :     fIsCpv = kFALSE;</span>
<span class="lineNum">      89 </span>            :   }
<span class="lineNum">      90 </span>            : 
<span class="lineNum">      91 </span>            :   // Add itself to working pool
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :   AddToWorkingPool((TObject*)this);</span>
<span class="lineNum">      93 </span>            :   
<a name="94"><span class="lineNum">      94 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span><span class="lineNoCov">          0 : AliPHOSEvalRecPoint::AliPHOSEvalRecPoint(Int_t i, Bool_t cpv) : </span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :   fIsEmc(kFALSE),</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   fIsCpv(kFALSE),</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :   fParent(-333),</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   fChi2Dof(-111),</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :   fEventFolderName(AliConfig::GetDefaultEventFolderName())</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     103 </span>            :   // ctor
<span class="lineNum">     104 </span>            :   AliPHOSEmcRecPoint* rp=0;
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :   AliPHOSLoader* fLoader = AliPHOSLoader::GetPHOSLoader(fEventFolderName);</span>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   if(cpv) {</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :     rp = (AliPHOSCpvRecPoint*)fLoader-&gt;CpvRecPoints()-&gt;At(i);</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :     fIsEmc = kFALSE;</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :     fIsCpv = kTRUE;</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     113 </span>            :   else {
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :     rp = (AliPHOSEmcRecPoint*)fLoader-&gt;EmcRecPoints()-&gt;At(i);</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     fIsEmc = kTRUE;</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     fIsCpv = kFALSE;</span>
<span class="lineNum">     117 </span>            :   }
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :   Int_t* digits = rp-&gt;GetDigitsList();</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :   Float_t* energies = rp-&gt;GetEnergiesList();</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :   Int_t nDigits = rp-&gt;GetMultiplicity();</span>
<span class="lineNum">     122 </span>            :   
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :   for(Int_t iDigit=0; iDigit&lt;nDigits; iDigit++) {</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     AliPHOSDigit* digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At( digits[iDigit] );</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     Float_t eDigit = energies[iDigit];</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     this-&gt;AddDigit(*digit,eDigit);</span>
<span class="lineNum">     127 </span>            :   }
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :   TVector3 locpos;</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :   rp-&gt;GetLocalPosition(locpos);</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   fLocPos = locpos; </span>
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            :   // Add itself to working pool
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :   AddToWorkingPool((TObject*)this);</span>
<span class="lineNum">     135 </span>            :    
<a name="136"><span class="lineNum">     136 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span>            : AliPHOSClusterizer* AliPHOSEvalRecPoint::GetClusterizer()
<span class="lineNum">     139 </span>            : {
<span class="lineNum">     140 </span>            :   // returns clusterizer task
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   TFolder* aliceF = (TFolder*)gROOT-&gt;FindObjectAny(&quot;YSAlice&quot;);</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :   TFolder* wPoolF = (TFolder*)aliceF-&gt;FindObject(&quot;WhiteBoard/RecPoints/PHOS/SmP&quot;);</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :   AliPHOSClusterizer* clu = (AliPHOSClusterizer*)wPoolF-&gt;FindObject(&quot;PHOS:clu-v1&quot;);</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :   if(!clu) { </span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :     Fatal(&quot;GetClusterizer&quot;, &quot;Couldn't find Clusterizer&quot;) ; </span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :   return clu;</span>
<a name="149"><span class="lineNum">     149 </span>            : }</a>
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            : Bool_t AliPHOSEvalRecPoint::TooClose(AliPHOSRecPoint* pt) const 
<span class="lineNum">     152 </span>            : {
<span class="lineNum">     153 </span>            :   // check if a rec.point pt is too close to this one
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   TVector3 herPos;</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   TVector3 myPos;</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   pt-&gt;GetLocalPosition(herPos);</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   this-&gt;GetLocalPosition(myPos);</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   Float_t dx = herPos.X() - myPos.X();</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :   Float_t dz = herPos.Z() - myPos.Z();</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :   Float_t dr = TMath::Sqrt(dx*dx + dz*dz);</span>
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   if(dr&lt;GetReconstructionManager()-&gt;MergeGammasMinDistanceCut())</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :     return kTRUE;</span>
<span class="lineNum">     164 </span>            :   else
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     166 </span>            : 
<a name="167"><span class="lineNum">     167 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span>            : Bool_t AliPHOSEvalRecPoint::NeedToSplit() const 
<span class="lineNum">     170 </span>            : {
<span class="lineNum">     171 </span>            :   // rec.point needs to be split
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :   return kFALSE;</span>
<a name="173"><span class="lineNum">     173 </span>            : }</a>
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span>            : void AliPHOSEvalRecPoint::DeleteParent()
<span class="lineNum">     176 </span>            : {
<span class="lineNum">     177 </span>            :   // delete parent
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   fParent=-333;</span>
<a name="179"><span class="lineNum">     179 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span>            : void AliPHOSEvalRecPoint::UpdateWorkingPool()
<span class="lineNum">     182 </span>            : {
<span class="lineNum">     183 </span>            :   // update pool of rec.points
<span class="lineNum">     184 </span>            :   Int_t i; //loop variable
<span class="lineNum">     185 </span>            :   
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   for(i=0; i&lt;this-&gt;InWorkingPool(); i++) {</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :      AliPHOSEvalRecPoint* parent = (AliPHOSEvalRecPoint*)GetFromWorkingPool(i);</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :      TObjArray children;</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :      Int_t nChild = parent-&gt;HasChild(children);</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :      for(Int_t iChild=0; iChild&lt;nChild; iChild++)</span>
<span class="lineNum">     191 </span>            :        {
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :          ((AliPHOSEvalRecPoint*)children.At(iChild))-&gt;DeleteParent();</span>
<span class="lineNum">     193 </span>            :        }
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :      if(nChild) {</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :        RemoveFromWorkingPool(parent);</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :        delete parent;</span>
<span class="lineNum">     198 </span>            :      }
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :   for(i=0; i&lt;this-&gt;InWorkingPool(); i++) {</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :     AliPHOSEvalRecPoint* weak = (AliPHOSEvalRecPoint*)GetFromWorkingPool(i);</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :     if (weak-&gt;KillWeakPoint()) delete weak;</span>
<span class="lineNum">     205 </span>            :   }
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :   for(i=0; i&lt;this-&gt;InWorkingPool(); i++) {</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :     AliPHOSEvalRecPoint* close = (AliPHOSEvalRecPoint*)GetFromWorkingPool(i);</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :     close-&gt;MergeClosePoint();</span>
<span class="lineNum">     210 </span>            :   }
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :   for(i=0; i&lt;this-&gt;InWorkingPool(); i++)</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     ((AliPHOSEvalRecPoint*)AliPHOSEvalRecPoint::GetFromWorkingPool(i))-&gt;SetIndexInList(i);</span>
<span class="lineNum">     214 </span>            : 
<a name="215"><span class="lineNum">     215 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span>            : Int_t AliPHOSEvalRecPoint::HasChild(TObjArray&amp; children)
<span class="lineNum">     218 </span>            : {
<span class="lineNum">     219 </span>            :   // returns the number of children
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   for(Int_t iChild=0; iChild&lt;InWorkingPool(); iChild++)</span>
<span class="lineNum">     221 </span>            :     {
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :       AliPHOSEvalRecPoint* child = (AliPHOSEvalRecPoint*)GetFromWorkingPool(iChild);</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :       TObject* parent = (TObject*)child-&gt;Parent();</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :       TObject* me = (TObject*)this;</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :       if(parent==me) children.Add(child);</span>
<span class="lineNum">     226 </span>            :     }
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   return children.GetEntries();</span>
<a name="229"><span class="lineNum">     229 </span>            : }</a>
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span>            : void AliPHOSEvalRecPoint::Init()
<span class="lineNum">     232 </span>            : {
<span class="lineNum">     233 </span>            :   // initialization
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :   AliPHOSClusterizer* clusterizer = GetClusterizer();</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :   if(!clusterizer) {</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     AliFatal(&quot;Cannot get clusterizer&quot;) ;</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :   TClonesArray* digits = AliPHOSLoader::GetPHOSLoader(fEventFolderName)-&gt;Digits();</span>
<span class="lineNum">     240 </span>            :   Float_t logWeight=0;  
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :   if(this-&gt;IsEmc()) {</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :     logWeight = clusterizer-&gt;GetEmcLogWeight();</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     245 </span>            :   else {
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :     logWeight = clusterizer-&gt;GetCpvLogWeight();</span>
<span class="lineNum">     247 </span>            :   }
<span class="lineNum">     248 </span>            :   
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :   TVector3 vtx(0.,0.,0.) ;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :   TVector3 inc(0.,0.,0.) ;</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :   EvalLocalPosition(logWeight,vtx,digits,inc); // evaluate initial position</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 : }</span>
<a name="253"><span class="lineNum">     253 </span>            : </a>
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span>            : void AliPHOSEvalRecPoint::MakeJob()
<span class="lineNum">     256 </span>            : {
<span class="lineNum">     257 </span>            :   // Reconstruction algoritm implementation.
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :   AliPHOSRecManager* recMng = GetReconstructionManager();</span>
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :   Init();</span>
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :   UnfoldLocalMaxima();</span>
<span class="lineNum">     264 </span>            :   
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :   TObjArray children;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :   Int_t nChild = HasChild(children);</span>
<span class="lineNum">     267 </span>            :   
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :   if(!nChild) {</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     EvaluatePosition();</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     if(Chi2Dof()&gt;recMng-&gt;OneGamChisqCut()) SplitMergedShowers();</span>
<span class="lineNum">     271 </span>            :   }
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :   for(Int_t iChild=0; iChild&lt;nChild; iChild++) {</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :     AliPHOSEvalRecPoint* child = (AliPHOSEvalRecPoint*)children.At(iChild);</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :     child-&gt;EvaluatePosition();</span>
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     if(child-&gt;Chi2Dof()&gt;recMng-&gt;OneGamChisqCut())</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :       child-&gt;SplitMergedShowers();</span>
<span class="lineNum">     279 </span>            :   }  
<span class="lineNum">     280 </span>            : 
<a name="281"><span class="lineNum">     281 </span><span class="lineNoCov">          0 : } </span></a>
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span>            : void AliPHOSEvalRecPoint::InitTwoGam(Float_t* gamma1, Float_t* gamma2)
<span class="lineNum">     284 </span>            : {
<span class="lineNum">     285 </span>            :   //Compute start values for two gamma fit algorithm.
<span class="lineNum">     286 </span>            :   // gamma1[0], gamma1[1], gamma1[2] are Energy,x,z of the reconstructed &quot;gammas&quot;.
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   TVector3 lpos; // start point choosing.</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :   GetLocalPosition(lpos);</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :   Float_t xx = lpos.Z();</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :   Float_t yy = lpos.X();</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :   Float_t e = GetEnergy();</span>
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :   AliInfo(Form(&quot;(x,z,e)[old] = (%f, %f, %f)&quot;, yy, xx, e)) ;</span>
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            : //    xx = XY(xx/e);
<span class="lineNum">     298 </span>            : //    yy = XY(yy/e);
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span>            :   Float_t eDigit ;
<span class="lineNum">     302 </span>            :   AliPHOSDigit * digit ;
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :   Int_t nDigits = GetMultiplicity();  </span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :   Int_t * digits = GetDigitsList();</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :   Float_t * energies = GetEnergiesList();</span>
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :   Float_t ix ;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :   Float_t iy ;</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :   Int_t relid[4] ; </span>
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span>            :   Float_t exx = 0;
<span class="lineNum">     312 </span>            :   Float_t eyy = 0;
<span class="lineNum">     313 </span>            :   Float_t exy = 0;
<span class="lineNum">     314 </span>            :   Float_t sqr;
<span class="lineNum">     315 </span>            :   Float_t cos2fi = 1.;
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :   AliPHOSLoader* fLoader = AliPHOSLoader::GetPHOSLoader(fEventFolderName);</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :   AliPHOSGeometry * phosgeom =  AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span>            :   Int_t iDigit; //loop variable
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :   for(iDigit = 0 ; iDigit &lt; nDigits ; iDigit ++)</span>
<span class="lineNum">     323 </span>            :     {
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :       digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At( digits[iDigit] ); </span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :       eDigit = energies[iDigit];</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :       phosgeom-&gt;AbsToRelNumbering(digit-&gt;GetId(), relid) ;</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :       phosgeom-&gt;RelPosInModule(relid, iy, ix);</span>
<span class="lineNum">     328 </span>            :     
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       Float_t dx =  ix - xx;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :       Float_t dy =  iy - yy;</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :       exx += eDigit*dx*dx;</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :       eyy += eDigit*dy*dy;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :       exy += eDigit*dx*dy;</span>
<span class="lineNum">     334 </span>            :       
<span class="lineNum">     335 </span>            :     }
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :   sqr = TMath::Sqrt(4.*exy*exy + (exx-eyy)*(exx-eyy));</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :   Float_t euu = (exx+eyy+sqr)/2.;</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :   if(sqr&gt;1.e-10) cos2fi = (exx - eyy)/sqr;</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :   Float_t cosfi = TMath::Sqrt((1.+cos2fi)/2.);</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :   Float_t sinfi = TMath::Sqrt((1.-cos2fi)/2.);</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :   if(exy&lt;0) sinfi = -sinfi;</span>
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span>            :   Float_t eu3 = 0;
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :   for(iDigit = 0 ; iDigit &lt; nDigits ; iDigit ++)</span>
<span class="lineNum">     346 </span>            :     {
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :       digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At( digits[iDigit] ); </span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :       eDigit = energies[iDigit];</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :       phosgeom-&gt;AbsToRelNumbering(digit-&gt;GetId(), relid) ;</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :       phosgeom-&gt;RelPosInModule(relid, iy, ix);</span>
<span class="lineNum">     351 </span>            :     
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :       Float_t dx =  ix - xx;</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :       Float_t dy =  iy - yy;</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :       Float_t du = dx*cosfi + dy*sinfi;</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :       eu3 += eDigit*du*du*du;</span>
<span class="lineNum">     356 </span>            :     }
<span class="lineNum">     357 </span>            :   
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   Float_t c = e*eu3*eu3/(euu*euu*euu)/2.;</span>
<span class="lineNum">     359 </span>            :   Float_t sign = 1.;
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   if(eu3&lt;0) sign = -1.;</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :   Float_t r = 1.+ c + sign*TMath::Sqrt(2.*c + c*c);</span>
<span class="lineNum">     362 </span>            :   Float_t u = 0;
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :   if(TMath::Abs(r-1.)&gt;0.1) u = eu3/euu*(r+1.)/(r-1.);</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :   if(TMath::Abs(r-1.)&lt;0.1) u = TMath::Sqrt(sqr/e/r)*(1.+r);</span>
<span class="lineNum">     365 </span>            :   
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   Float_t e2c = e/(1.+r);</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :   Float_t e1c = e-e2c;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :   Float_t u1 = -u/(1.+r);</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :   Float_t u2 = u+u1;</span>
<span class="lineNum">     370 </span>            :   
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   Float_t x1c = xx+u1*cosfi;</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :   Float_t y1c = yy+u1*sinfi;</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :   Float_t x2c = xx+u2*cosfi;</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :   Float_t y2c = yy+u2*sinfi;</span>
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span>            : //    printf(&quot;e1c -&gt; %f\n&quot;,e1c);
<span class="lineNum">     377 </span>            : //    printf(&quot;x1c -&gt; %f\n&quot;,x1c);
<span class="lineNum">     378 </span>            : //    printf(&quot;y1c -&gt; %f\n&quot;,y1c);
<span class="lineNum">     379 </span>            : //    printf(&quot;e2c -&gt; %f\n&quot;,e2c);
<span class="lineNum">     380 </span>            : //    printf(&quot;x2c -&gt; %f\n&quot;,x2c);
<span class="lineNum">     381 </span>            : //    printf(&quot;y2c -&gt; %f\n&quot;,y2c);
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :   gamma1[0] = e1c;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :   gamma1[1] = y1c;</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :   gamma1[2] = x1c;</span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :   gamma2[0] = e2c;</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :   gamma2[1] = y2c;</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :   gamma2[2] = x2c;</span>
<span class="lineNum">     390 </span>            :   
<a name="391"><span class="lineNum">     391 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span>            : void AliPHOSEvalRecPoint::TwoGam(Float_t* gamma1, Float_t* gamma2)
<span class="lineNum">     394 </span>            : {
<span class="lineNum">     395 </span>            :   //Fitting algorithm for the two very closed gammas 
<span class="lineNum">     396 </span>            :   //that merged into the cluster with one maximum.
<span class="lineNum">     397 </span>            :   // Starting points gamma1 and gamma2 must be provided before ( see InitTwoGam)
<span class="lineNum">     398 </span>            :   //Set chisquare of the fit.
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            : 
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :   Float_t st0 = GetReconstructionManager()-&gt;TwoGamInitialStep();</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :   Float_t chmin = GetReconstructionManager()-&gt;TwoGamChisqMin();</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :   Float_t emin = GetReconstructionManager()-&gt;TwoGamEmin();</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :   Float_t stpmin = GetReconstructionManager()-&gt;TwoGamStepMin();</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :   Int_t nIter = GetReconstructionManager()-&gt;TwoGamNumOfIterations(); // Number of iterations.</span>
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span>            :   Float_t chisq = 100.; //Initial chisquare.
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :   Int_t nadc = GetMultiplicity();</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :   if(nadc&lt;3)</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :       fChi2Dof= -111.;</span>
<span class="lineNum">     412 </span>            :   
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :   Int_t dof = nadc - 5;</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :   if(dof&lt;1) dof=1;</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :   Float_t chstop = chmin*dof;</span>
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span>            :   Float_t ch = 1.e+20;
<span class="lineNum">     418 </span>            :   Float_t st = st0;
<span class="lineNum">     419 </span>            :   Float_t grx1 = 0.;
<span class="lineNum">     420 </span>            :   Float_t gry1 = 0.;
<span class="lineNum">     421 </span>            :   Float_t grx2 = 0.;
<span class="lineNum">     422 </span>            :   Float_t gry2 = 0.;
<span class="lineNum">     423 </span>            :   Float_t gre = 0.;
<span class="lineNum">     424 </span>            :   Float_t gr = 1.;
<span class="lineNum">     425 </span>            :   Float_t ee1=0,xx1=0,yy1=0,ee2=0,xx2=0,yy2=0,cosi;
<span class="lineNum">     426 </span>            : 
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :   Float_t e1c = gamma1[0];</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :   Float_t y1c = gamma1[1];</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :   Float_t x1c = gamma1[2];</span>
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :   Float_t e2c = gamma2[0];</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :   Float_t y2c = gamma2[1];</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :   Float_t x2c = gamma2[2];</span>
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :   Float_t e = GetEnergy();</span>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span>            :   Float_t eDigit ;
<span class="lineNum">     438 </span>            :   AliPHOSDigit * digit ;
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :   Int_t nDigits = GetMultiplicity();  </span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :   Int_t * digits = GetDigitsList();</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :   Float_t * energies = GetEnergiesList();</span>
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :   Float_t ix ;</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :   Float_t iy ;</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :   Int_t relid[4] ; </span>
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :   AliPHOSLoader* fLoader = AliPHOSLoader::GetPHOSLoader(fEventFolderName);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :   AliPHOSGeometry * phosgeom =  AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :   for(Int_t iter=0; iter&lt;nIter; iter++)</span>
<span class="lineNum">     451 </span>            :     {
<span class="lineNum">     452 </span>            :       Float_t chisqc = 0.;
<span class="lineNum">     453 </span>            :       Float_t grx1c = 0.;
<span class="lineNum">     454 </span>            :       Float_t gry1c = 0.;
<span class="lineNum">     455 </span>            :       Float_t grx2c = 0.;
<span class="lineNum">     456 </span>            :       Float_t gry2c = 0.;
<span class="lineNum">     457 </span>            :       Float_t grec = 0.;
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :       for(Int_t iDigit = 0 ; iDigit &lt; nDigits ; iDigit ++)</span>
<span class="lineNum">     460 </span>            :         {
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :           digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At( digits[iDigit] ); </span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :           eDigit = energies[iDigit];</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :           phosgeom-&gt;AbsToRelNumbering(digit-&gt;GetId(), relid) ;</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :           phosgeom-&gt;RelPosInModule(relid, iy, ix);</span>
<span class="lineNum">     465 </span>            :           
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :           Float_t a1,gx1,gy1;</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :           Float_t a2,gx2,gy2;</span>
<span class="lineNum">     468 </span>            :           
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :           Float_t dx1 =  x1c - ix;</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :           Float_t dy1 =  y1c - iy;</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :           GetReconstructionManager()-&gt;AG(e1c,dx1,dy1,a1,gx1,gy1);</span>
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :           Float_t dx2 =  x2c - ix;</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :           Float_t dy2 =  y2c - iy;</span>
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :           GetReconstructionManager()-&gt;AG(e2c,dx2,dy2,a2,gx2,gy2);</span>
<span class="lineNum">     478 </span>            :       
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :           Float_t a = a1+a2;</span>
<span class="lineNum">     480 </span>            : //        Float_t D = Const*a*(1. - a/e);
<span class="lineNum">     481 </span>            : //        if(D&lt;0) D=0;
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span>            : //  //            D = 9.; // ????
<span class="lineNum">     484 </span>            :           
<span class="lineNum">     485 </span>            : //        Float_t da = a - eDigit;
<span class="lineNum">     486 </span>            : //        chisqc += da*da/D;
<span class="lineNum">     487 </span>            : //        Float_t dd = da/D;
<span class="lineNum">     488 </span>            : //        dd = dd*(2.-dd*Const*(1.-2.*a/e));
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :           Float_t dd;</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :           chisqc += GetReconstructionManager()-&gt;TwoGamChi2(a,eDigit,e,dd);</span>
<span class="lineNum">     492 </span>            :           
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :           grx1c += gx1*dd;</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :           gry1c += gy1*dd;</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :           grx2c += gx2*dd;</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :           gry2c += gy2*dd;</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :           grec += (a1/e1c - a2/e2c)*e*dd;</span>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :       Float_t grc = TMath::Sqrt(grx1c*grx1c + gry1c*gry1c + grx2c*grx2c + gry2c*gry2c);</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :       if(grc&lt;1.e-10) grc=1.e-10;</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :       Float_t sc = 1. + chisqc/ch;</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :       st = st/sc; </span>
<span class="lineNum">     506 </span>            : 
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :       if(chisqc&gt;ch) </span>
<span class="lineNum">     508 </span>            :         goto loop20;
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :       cosi = (grx1*grx1c + gry1*gry1c + grx2*grx2c + gry2*gry2c + gre*grec)/gr/grc;</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :       st = st*sc/(1.4 - cosi);</span>
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span>            :       ee1 = e1c;
<span class="lineNum">     513 </span>            :       xx1 = x1c;
<span class="lineNum">     514 </span>            :       yy1 = y1c;
<span class="lineNum">     515 </span>            :       ee2 = e2c;
<span class="lineNum">     516 </span>            :       xx2 = x2c;
<span class="lineNum">     517 </span>            :       yy2 = y2c;
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span>            :       ch = chisqc;
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :       if(ch&lt;chstop)</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :         goto loop101;</span>
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span>            :       grx1 = grx1c;
<span class="lineNum">     525 </span>            :       gry1 = gry1c;
<span class="lineNum">     526 </span>            :       grx2 = grx2c;
<span class="lineNum">     527 </span>            :       gry2 = gry2c;
<span class="lineNum">     528 </span>            :       gre = grec;
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :       gr = grc;</span>
<span class="lineNum">     530 </span>            :  
<span class="lineNum">     531 </span>            :     loop20: ;
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :       Float_t step = st*gr;</span>
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :       AliInfo(Form(&quot;Iteration %d dof %d chisq/dof %f chstop/dof %f step %f stpmin %f&quot;,</span>
<span class="lineNum">     535 </span>            :            iter, dof, ch/dof, chstop/dof, step, stpmin)) ;
<span class="lineNum">     536 </span>            : 
<span class="lineNum">     537 </span>            :       
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :       if(step&lt;stpmin) </span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :         goto loop101;</span>
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :       Float_t de = st*gre*e;</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :       e1c = ee1 - de;</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :       e2c = ee2 + de;</span>
<span class="lineNum">     544 </span>            :       
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :       if( (e1c&gt;emin) &amp;&amp; (e2c&gt;emin) )</span>
<span class="lineNum">     546 </span>            :         goto loop25;
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :       st = st/2.;</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :       goto loop20;</span>
<span class="lineNum">     549 </span>            :       
<span class="lineNum">     550 </span>            :     loop25: ;
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :       x1c = xx1 - st*grx1;</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :       y1c = yy1 - st*gry1;</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :       x2c = xx2 - st*grx2;</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :       y2c = yy2 - st*gry2;</span>
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span>            : 
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span>            :  loop101: 
<span class="lineNum">     560 </span>            : 
<span class="lineNum">     561 </span>            : //    if(ch&gt;chisq*(nadc-2)-delch)
<span class="lineNum">     562 </span>            : //      return ch/dof;  
<span class="lineNum">     563 </span>            :   
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :   chisq = ch/dof;</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :   gamma1[0] = ee1;</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :   gamma1[1] = yy1;</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :   gamma1[2] = xx1;</span>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :   gamma2[0] = ee2;</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :   gamma2[1] = yy2;</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :   gamma2[2] = xx2;</span>
<span class="lineNum">     572 </span>            : 
<span class="lineNum">     573 </span>            :   Float_t x1New = yy1;
<span class="lineNum">     574 </span>            :   Float_t z1New = xx1;
<span class="lineNum">     575 </span>            :   Float_t e1New = ee1;
<span class="lineNum">     576 </span>            :   Float_t x2New = yy2;
<span class="lineNum">     577 </span>            :   Float_t z2New = xx2;
<span class="lineNum">     578 </span>            :   Float_t e2New = ee2;
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :   TString message ; </span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :   message  = &quot;     (x,z,e)[1 fit] = (%f, %f, %f)\n&quot; ;  </span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :   message  = &quot;     (x,z,e)[2 fit] = (%f, %f, %f)\n&quot; ;  </span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :   AliInfo(Form(message.Data(), </span>
<span class="lineNum">     584 </span>            :        x1New, z1New, e1New, 
<span class="lineNum">     585 </span>            :        x2New, z2New, e2New)) ;
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :   fChi2Dof = chisq;</span>
<span class="lineNum">     588 </span>            : 
<a name="589"><span class="lineNum">     589 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span>            : void AliPHOSEvalRecPoint::UnfoldTwoMergedPoints(Float_t* gamma1, Float_t* gamma2)
<span class="lineNum">     592 </span>            : {
<span class="lineNum">     593 </span>            :   //Unfold TWO merged rec. points in the case when cluster has only one maximum, 
<span class="lineNum">     594 </span>            :   //but it's fitting to the one gamma shower is too bad.
<span class="lineNum">     595 </span>            :   // Use TwoGam() to estimate the positions and energies of merged points.
<span class="lineNum">     596 </span>            :  
<span class="lineNum">     597 </span>            :   
<span class="lineNum">     598 </span>            :   Int_t nMax = 2;
<span class="lineNum">     599 </span>            :   Float_t* gamma;
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :   Int_t* digits = GetDigitsList();</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :   Int_t nDigits = GetMultiplicity();</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :   Float_t* energies = GetEnergiesList();</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :   Float_t* eFit = new Float_t[nDigits];</span>
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :   AliPHOSLoader* fLoader = AliPHOSLoader::GetPHOSLoader(fEventFolderName);</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :   AliPHOSGeometry * phosgeom =  AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     608 </span>            : 
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :   for(Int_t iDigit=0; iDigit&lt;nDigits; iDigit++)</span>
<span class="lineNum">     610 </span>            :     {
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :       AliPHOSDigit* digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At( digits[iDigit] ); </span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :       Int_t relid[4] ;</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :       phosgeom-&gt;AbsToRelNumbering(digit-&gt;GetId(), relid) ;</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :       Float_t x,z;     </span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :       phosgeom-&gt;RelPosInModule(relid, x, z);</span>
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            :       Float_t gain = 0.;
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :       for(Int_t iMax=0; iMax&lt;nMax; iMax++)</span>
<span class="lineNum">     619 </span>            :         {
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :           if(iMax==0)</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :             gamma = gamma1;</span>
<span class="lineNum">     622 </span>            :           else
<span class="lineNum">     623 </span>            :             gamma = gamma2;
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :           Float_t eMax = gamma[0];</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :           Float_t xMax = gamma[1];</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :           Float_t zMax = gamma[2];</span>
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :           Float_t dx = xMax - x;</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :           Float_t dz = zMax - z;</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :           Float_t amp,gx,gy;</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :           GetReconstructionManager()-&gt;AG(eMax,dz,dx,amp,gx,gy); </span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :           gain += amp;</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     635 </span>            :  
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :       eFit[iDigit] = gain;</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :   for( Int_t iMax=0; iMax&lt;nMax; iMax++)</span>
<span class="lineNum">     641 </span>            :     {      
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :       if(iMax==0)</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :         gamma = gamma1;</span>
<span class="lineNum">     644 </span>            :       else
<span class="lineNum">     645 </span>            :         gamma = gamma2;
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :       Float_t eMax = gamma[0];</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :       Float_t xMax = gamma[1];</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :       Float_t zMax = gamma[2];</span>
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :       AliPHOSEvalRecPoint* newRP = new AliPHOSEvalRecPoint(IsCPV(),this);</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :       TVector3 newpos(xMax,0,zMax);</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :       newRP-&gt;SetLocalPosition(newpos);</span>
<span class="lineNum">     654 </span>            : 
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :       for( Int_t iDigit = 0 ; iDigit &lt; nDigits ; iDigit ++)</span>
<span class="lineNum">     656 </span>            :         {
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :           AliPHOSDigit* digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At( digits[iDigit] ); </span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :           Float_t eDigit = energies[iDigit];</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :           Int_t relid[4] ;</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :           phosgeom-&gt;AbsToRelNumbering(digit-&gt;GetId(), relid) ;</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :           Float_t ix,iz;</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :           phosgeom-&gt;RelPosInModule(relid, ix, iz);</span>
<span class="lineNum">     663 </span>            :           
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :           Float_t dx = xMax - ix;</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :           Float_t dz = zMax - iz;</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :           Float_t singleShowerGain,gxMax,gyMax;</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :           GetReconstructionManager()-&gt;AG(eMax,dz,dx,singleShowerGain,gxMax,gyMax);</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :           Float_t totalGain = eFit[iDigit];</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :           Float_t ratio = singleShowerGain/totalGain; </span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :           eDigit = eDigit*ratio;</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :           newRP-&gt;AddDigit(*digit,eDigit);</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :       AliInfo(Form(&quot;======= Split: daughter rec point %d =================&quot;, </span>
<span class="lineNum">     674 </span>            :                    iMax)) ;
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :       newRP-&gt;Print();</span>
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :   delete[] eFit;</span>
<span class="lineNum">     680 </span>            :   
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span><span class="lineNoCov">          0 : }</span>
<a name="683"><span class="lineNum">     683 </span>            : </a>
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span>            : void AliPHOSEvalRecPoint::EvaluatePosition() 
<span class="lineNum">     686 </span>            : {
<span class="lineNum">     687 </span>            :   // One gamma fit algorithm.
<span class="lineNum">     688 </span>            :   // Set chisq/dof of the fit.
<span class="lineNum">     689 </span>            :   // gamma1[0], gamma1[1], gamma1[2] are Energy,x,z of the reconstructed gamma, respectively.
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :   Int_t nDigits = GetMultiplicity();</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :   if(nDigits&lt;2)</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :   Int_t nIter = GetReconstructionManager()-&gt;OneGamNumOfIterations(); // number of iterations</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :   Float_t st0 = GetReconstructionManager()-&gt;OneGamInitialStep(); // initial step</span>
<span class="lineNum">     697 </span>            : //    const Float_t stpMin = 0.005;
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :   Float_t stpMin = GetReconstructionManager()-&gt;OneGamStepMin();</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :   Float_t chmin =  GetReconstructionManager()-&gt;OneGamChisqMin();</span>
<span class="lineNum">     700 </span>            :  
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :   TVector3 locpos;</span>
<span class="lineNum">     702 </span>            :   AliPHOSDigit* digit;
<span class="lineNum">     703 </span>            :   Float_t eDigit;
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :   Int_t relid[4] ; </span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :   Float_t ix, iy;</span>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :   GetLocalPosition(locpos);</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :   Float_t e = GetEnergy();</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :   Float_t xc = locpos.Z();</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :   Float_t yc = locpos.X();</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :   Float_t dx,dy,gx,gy,grxc,gryc;</span>
<span class="lineNum">     712 </span>            :   Float_t st = st0;
<span class="lineNum">     713 </span>            :   Float_t chisq = 1.e+20;
<span class="lineNum">     714 </span>            :   Float_t gr = 1.;
<span class="lineNum">     715 </span>            :   Float_t grx = 0.;
<span class="lineNum">     716 </span>            :   Float_t gry = 0.;
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :   Int_t dof = GetMultiplicity() - 2;</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :   if(dof&lt;1)</span>
<span class="lineNum">     719 </span>            :     dof = 1;
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :   Float_t chstop = chmin*dof;</span>
<span class="lineNum">     721 </span>            :   Float_t cosi,x1=0,y1=0;
<span class="lineNum">     722 </span>            :   Float_t chisqc;
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :   AliPHOSLoader* fLoader = AliPHOSLoader::GetPHOSLoader(fEventFolderName);</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :   AliPHOSGeometry * phosgeom =  AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :   for(Int_t iter=0; iter&lt;nIter; iter++)</span>
<span class="lineNum">     728 </span>            :     {
<span class="lineNum">     729 </span>            :  
<span class="lineNum">     730 </span>            :       chisqc = 0.;
<span class="lineNum">     731 </span>            :       grxc = 0.;
<span class="lineNum">     732 </span>            :       gryc = 0.;
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :       for(Int_t iDigit = 0 ; iDigit &lt; nDigits ; iDigit ++)</span>
<span class="lineNum">     734 </span>            :         {
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :           Float_t* energies = GetEnergiesList();</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :           Int_t* digits = GetDigitsList();</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :           digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At( digits[iDigit] );</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :           eDigit = energies[iDigit];</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :           phosgeom-&gt;AbsToRelNumbering(digit-&gt;GetId(), relid) ;</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :           phosgeom-&gt;RelPosInModule(relid, iy, ix);</span>
<span class="lineNum">     742 </span>            :       
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :           dx =  xc - ix;</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :           dy =  yc - iy;</span>
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :           if(!dx) dx=dy;</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :           if(!dy) dy=dx;</span>
<span class="lineNum">     748 </span>            :                   
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :           Float_t a;</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :           GetReconstructionManager()-&gt;AG(e,dx,dy,a,gx,gy);</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :           Float_t dd;</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :           AliInfo(Form(&quot;  (ix iy  xc yc  dx dy)   %f %f %f %f %f %f&quot;, </span>
<span class="lineNum">     753 </span>            :                        ix, iy, xc, yc, dx, dy)) ;
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :           Float_t chi2dg = GetReconstructionManager()-&gt;OneGamChi2(a,eDigit,e,dd);</span>
<span class="lineNum">     755 </span>            : 
<span class="lineNum">     756 </span>            :           // Exclude digit with too large chisquare.
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :           if(chi2dg &gt; 10) {  continue; }</span>
<span class="lineNum">     758 </span>            : 
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :           chisqc += chi2dg;</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :           grxc += gx*dd;</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :           gryc += gy*dd;</span>
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     764 </span>            : 
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :       Float_t grc = TMath::Sqrt(grxc*grxc + gryc*gryc);</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :       if(grc&lt;1.e-10) grc=1.e-10;</span>
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :       Float_t sc = 1. + chisqc/chisq;</span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :        AliInfo(Form(&quot; chisq: %f&quot;, chisq)) ;</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :       st = st/sc;</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :       if(chisqc&gt;chisq)</span>
<span class="lineNum">     771 </span>            :         goto loop20;
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :       cosi = (grx*grxc + gry*gryc)/gr/grc;</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :       st = st*sc/(1.4 - cosi);</span>
<span class="lineNum">     774 </span>            :       x1 = xc;
<span class="lineNum">     775 </span>            :       y1 = yc;
<span class="lineNum">     776 </span>            :       grx = grxc;
<span class="lineNum">     777 </span>            :       gry = gryc;
<span class="lineNum">     778 </span>            :       gr = grc;
<span class="lineNum">     779 </span>            :       chisq = chisqc;
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :       if(chisq&lt;chstop)</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :         goto loop101;</span>
<span class="lineNum">     783 </span>            :   
<span class="lineNum">     784 </span>            :     loop20: ;
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :       Float_t step = st*gr;</span>
<span class="lineNum">     786 </span>            : 
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :       AliInfo(Form(&quot; Iteration %d dof %d chisq/dof %f chstop/dof %f step %f stpMin %f&quot;,</span>
<span class="lineNum">     788 </span>            :            iter, dof, chisq/dof, chstop/dof, step, stpMin)) ;
<span class="lineNum">     789 </span>            :         
<span class="lineNum">     790 </span>            : 
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :       if(step&lt;stpMin)</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :         goto loop101;</span>
<span class="lineNum">     793 </span>            : 
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :       if(step&gt;1.)</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :         st = 1./gr;</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :       xc = x1 - st*grx;</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :       yc = y1 - st*gry;</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     799 </span>            : 
<span class="lineNum">     800 </span>            : 
<span class="lineNum">     801 </span>            :  loop101:
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :   chisq = chisq/dof;</span>
<span class="lineNum">     803 </span>            : //    if(chisq&gt;Chsqcut)
<span class="lineNum">     804 </span>            : //      {
<span class="lineNum">     805 </span>            : //  //        TwoGam();
<span class="lineNum">     806 </span>            : //      }
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span>            :   Float_t gamma1[3];
<span class="lineNum">     809 </span>            :   gamma1[0] = e;
<span class="lineNum">     810 </span>            :   gamma1[1] = y1;
<span class="lineNum">     811 </span>            :   gamma1[2] = x1;
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :   TVector3 newpos(gamma1[1],0,gamma1[2]);</span>
<span class="lineNum">     814 </span>            :   //SetLocalPosition(newpos);
<span class="lineNum">     815 </span>            :   
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :   fLocPos=newpos;</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :   fAmp=e;</span>
<span class="lineNum">     818 </span>            : 
<span class="lineNum">     819 </span>            : //    TVector3 pos;
<span class="lineNum">     820 </span>            : //    RP-&gt;GetLocalPosition(pos);
<span class="lineNum">     821 </span>            : 
<span class="lineNum">     822 </span>            :   
<span class="lineNum">     823 </span>            :   
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :   fChi2Dof = chisq;</span>
<span class="lineNum">     825 </span>            : 
<span class="lineNum">     826 </span><span class="lineNoCov">          0 : } </span>
<a name="827"><span class="lineNum">     827 </span>            : </a>
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span>            : Bool_t AliPHOSEvalRecPoint::KillWeakPoint()
<span class="lineNum">     830 </span>            : {
<span class="lineNum">     831 </span>            :   // Remove this point from further procession
<span class="lineNum">     832 </span>            :   // if it's energy is too small.
<span class="lineNum">     833 </span>            :   
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :   Float_t thr0 = GetReconstructionManager()-&gt;KillGamMinEnergy();</span>
<span class="lineNum">     835 </span>            :   
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :   if(GetEnergy()&lt;thr0) {</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :     AliInfo(Form(&quot;+++++++ Killing this rec point ++++++++++&quot;)) ;</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :     RemoveFromWorkingPool(this);</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :     return kTRUE;</span>
<span class="lineNum">     840 </span>            :   }
<span class="lineNum">     841 </span>            : 
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :   return kFALSE;</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 : }</span>
<a name="844"><span class="lineNum">     844 </span>            : </a>
<span class="lineNum">     845 </span>            : 
<span class="lineNum">     846 </span>            : void AliPHOSEvalRecPoint::SplitMergedShowers() 
<span class="lineNum">     847 </span>            : {
<span class="lineNum">     848 </span>            :   // Split two very close rec. points.
<span class="lineNum">     849 </span>            : 
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :   if(GetMultiplicity()&lt;2) </span>
<span class="lineNum">     851 </span>            :     return; 
<span class="lineNum">     852 </span>            : 
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :   Float_t gamma1[3];</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :   Float_t gamma2[3];</span>
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :   InitTwoGam(gamma1,gamma2); // start points for fit</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :   TwoGam(gamma1,gamma2); // evaluate the positions and energies</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :   UnfoldTwoMergedPoints(gamma1,gamma2); // make the job</span>
<span class="lineNum">     859 </span>            :   
<span class="lineNum">     860 </span><span class="lineNoCov">          0 : }</span>
<a name="861"><span class="lineNum">     861 </span>            : </a>
<span class="lineNum">     862 </span>            : 
<span class="lineNum">     863 </span>            : void AliPHOSEvalRecPoint::MergeClosePoint() 
<span class="lineNum">     864 </span>            : {
<span class="lineNum">     865 </span>            :   // merge rec.points if they are too close
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :   AliPHOSLoader* fLoader = AliPHOSLoader::GetPHOSLoader(fEventFolderName);</span>
<span class="lineNum">     867 </span>            : //    AliPHOSDigitizer* digitizer = fLoader-&gt;Digitizer();
<span class="lineNum">     868 </span>            : //    Float_t fPedestal = digitizer-&gt;GetPedestal();  // YVK 30.09.2001
<span class="lineNum">     869 </span>            : //    Float_t fSlope = digitizer-&gt;GetSlope();
<span class="lineNum">     870 </span>            :   
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;InWorkingPool(); i++)</span>
<span class="lineNum">     872 </span>            :     {
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :       TObject* obj = GetFromWorkingPool(i);</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :       if(!((TObject*)this)-&gt;IsEqual(obj))</span>
<span class="lineNum">     875 </span>            :         {
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :           AliPHOSRecPoint* rp = (AliPHOSRecPoint*)obj;</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :           if(GetPHOSMod() == rp-&gt;GetPHOSMod())</span>
<span class="lineNum">     878 </span>            :             {
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :               if(TooClose(rp))</span>
<span class="lineNum">     880 </span>            :                 {
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                   AliInfo(Form(&quot;+++++++ Merging point 1: ++++++&quot;)) ;</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :                   this-&gt;Print();</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :                   AliInfo(Form(&quot;+++++++ and point 2: ++++++++++&quot;)) ;</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :                   ((AliPHOSEvalRecPoint*)rp)-&gt;Print();</span>
<span class="lineNum">     885 </span>            : 
<span class="lineNum">     886 </span>            :                   //merge two rec. points
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :                   TVector3 lpos1;</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :                   TVector3 lpos2;</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :                   this-&gt;GetLocalPosition(lpos1);</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :                   rp-&gt;GetLocalPosition(lpos2);</span>
<span class="lineNum">     891 </span>            : 
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :                   Int_t* digits = rp-&gt;GetDigitsList();</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :                   Float_t dE = rp-&gt;GetEnergy()/(rp-&gt;GetEnergy()+this-&gt;GetEnergy());</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :                   Float_t newX = lpos1.X()*dE + lpos2.X()*(1.-dE); </span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :                   Float_t newZ = lpos1.Z()*dE + lpos2.Z()*(1.-dE);</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :                   Float_t newE = rp-&gt;GetEnergy()+this-&gt;GetEnergy();</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :                   Float_t* energies = ((AliPHOSEmcRecPoint*)rp)-&gt;GetEnergiesList();</span>
<span class="lineNum">     898 </span>            : 
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :                   for(Int_t iDigit=0; iDigit&lt;rp-&gt;GetDigitsMultiplicity(); iDigit++)</span>
<span class="lineNum">     900 </span>            :                     {
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :                       AliPHOSDigit* digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At(digits[iDigit]);</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :                       Float_t eDigit = energies[iDigit];</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :                       this-&gt;AddDigit(*digit,eDigit);</span>
<span class="lineNum">     904 </span>            :                     }
<span class="lineNum">     905 </span>            : 
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :                   TVector3 newpos(newX,0,newZ);</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :                   fLocPos = newpos;</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :                   fAmp = newE;</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :                   RemoveFromWorkingPool(rp);</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :                   delete rp;</span>
<span class="lineNum">     911 </span>            :                   
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :                   AliInfo(Form(&quot;++++++ Resulting point: ++++++++&quot;)) ;</span>
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :                   this-&gt;Print();</span>
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span>            :                   break;
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :                 } </span>
<span class="lineNum">     917 </span>            :             }
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     920 </span>            : 
<a name="921"><span class="lineNum">     921 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     922 </span>            : 
<span class="lineNum">     923 </span>            : Int_t AliPHOSEvalRecPoint::UnfoldLocalMaxima() 
<span class="lineNum">     924 </span>            : {
<span class="lineNum">     925 </span>            :   // Make unfolding in the reconstruction point with several local maxima.
<span class="lineNum">     926 </span>            :   // Return the number of local maxima.
<span class="lineNum">     927 </span>            : 
<span class="lineNum">     928 </span>            :   // if multiplicity less then 2 - nothing to unfold
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :   if(GetMultiplicity()&lt;2) return 1; </span>
<span class="lineNum">     930 </span>            : 
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :   AliPHOSDigit * maxAt[1000];</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :   Float_t maxAtEnergy[1000];  </span>
<span class="lineNum">     933 </span>            :   Float_t locMaxCut, logWeight;
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :   Int_t relid[4] ; </span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :   Float_t xMax;</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :   Float_t zMax;</span>
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :   AliPHOSClusterizer* clusterizer = GetClusterizer();</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :   if(!clusterizer) {</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :     AliFatal(Form(&quot;Cannot get clusterizer&quot;)) ;</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     942 </span>            : 
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :   if(this-&gt;IsEmc()) {</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :     locMaxCut = clusterizer-&gt;GetEmcLocalMaxCut();</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :     logWeight = clusterizer-&gt;GetEmcLogWeight();</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     947 </span>            :   else {
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :     locMaxCut = clusterizer-&gt;GetCpvLocalMaxCut();</span>
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :     logWeight = clusterizer-&gt;GetCpvLogWeight();</span>
<span class="lineNum">     950 </span>            :   }
<span class="lineNum">     951 </span>            : 
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :   AliPHOSLoader* fLoader = AliPHOSLoader::GetPHOSLoader(fEventFolderName);</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :   AliPHOSGeometry * phosgeom =  AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :   TClonesArray* digits = fLoader-&gt;Digits();</span>
<span class="lineNum">     955 </span>            : 
<span class="lineNum">     956 </span>            :   // if number of local maxima less then 2 - nothing to unfold
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :   Int_t nMax = GetNumberOfLocalMax(maxAt,maxAtEnergy,locMaxCut,digits); </span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :   if(nMax&lt;2) return nMax;</span>
<span class="lineNum">     959 </span>            : 
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :   Int_t* digitsList = GetDigitsList();</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :   Int_t nDigits = GetMultiplicity();</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :   Float_t* energies = GetEnergiesList();</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :   Float_t* eFit = new Float_t[nDigits];</span>
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span>            :   Int_t iDigit; //loop variable
<span class="lineNum">     966 </span>            : 
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :   for(iDigit=0; iDigit&lt;nDigits; iDigit++)</span>
<span class="lineNum">     968 </span>            :     {
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :       eFit[iDigit] = 0.;</span>
<span class="lineNum">     970 </span>            :     }
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :   for(iDigit=0; iDigit&lt;nDigits; iDigit++)</span>
<span class="lineNum">     973 </span>            :     {
<span class="lineNum">     974 </span>            :       
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :       AliPHOSDigit* digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At( digitsList[iDigit] );</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :       phosgeom-&gt;AbsToRelNumbering(digit-&gt;GetId(), relid) ;</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :       Float_t x,z;</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :       phosgeom-&gt;RelPosInModule(relid, x, z);</span>
<span class="lineNum">     979 </span>            : 
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :       for(Int_t iMax=0; iMax&lt;nMax; iMax++)</span>
<span class="lineNum">     981 </span>            :         {
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :           AliPHOSDigit* digitMax = maxAt[iMax];</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :           Float_t eMax = maxAtEnergy[iMax]; </span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :           phosgeom-&gt;AbsToRelNumbering(digitMax-&gt;GetId(), relid) ;</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :           phosgeom-&gt;RelPosInModule(relid, xMax, zMax);</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :           Float_t dx = xMax - x;</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :           Float_t dz = zMax - z;</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :           Float_t amp,gx,gy;</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :           GetReconstructionManager()-&gt;AG(eMax,dz,dx,amp,gx,gy); </span>
<span class="lineNum">     990 </span>            : //        amp = amp + 0.5;
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :           eFit[iDigit] += amp;</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span>            : 
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :   for(Int_t iMax=0; iMax&lt;nMax; iMax++) </span>
<span class="lineNum">     997 </span>            :     {
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :       AliPHOSDigit* digitMax = maxAt[iMax];</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :       phosgeom-&gt;AbsToRelNumbering(digitMax-&gt;GetId(), relid) ;</span>
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :       phosgeom-&gt;RelPosInModule(relid, xMax, zMax);</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :       Float_t eMax = maxAtEnergy[iMax];</span>
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :       AliPHOSEvalRecPoint* newRP = new AliPHOSEvalRecPoint(IsCPV(),this);    </span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :       newRP-&gt;AddDigit(*digitMax,maxAtEnergy[iMax]);</span>
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span>            :       //Neighbous ( matrix 3x3 around the local maximum)
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :       for(iDigit=0; iDigit&lt;nDigits; iDigit++)</span>
<span class="lineNum">    1008 </span>            :         {     
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :           AliPHOSDigit* digit = (AliPHOSDigit*)fLoader-&gt;Digits()-&gt;At( digitsList[iDigit] );</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :           Float_t eDigit = energies[iDigit];</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :           phosgeom-&gt;AbsToRelNumbering(digit-&gt;GetId(), relid) ;</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :           Float_t ix,iz;</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :           phosgeom-&gt;RelPosInModule(relid, ix, iz);</span>
<span class="lineNum">    1014 </span>            : 
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :           if(AreNeighbours(digitMax,digit))</span>
<span class="lineNum">    1016 </span>            :             {
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :               Float_t dx = xMax - ix;</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :               Float_t dz = zMax - iz;</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :               Float_t singleShowerGain,gxMax,gyMax;</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :               GetReconstructionManager()-&gt;AG(eMax,dz,dx,singleShowerGain,gxMax,gyMax);</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :               Float_t totalGain = eFit[iDigit];</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :               Float_t ratio = singleShowerGain/totalGain; </span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :               AliInfo(Form(&quot; ratio -&gt; %f&quot;, ratio)) ;</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :               eDigit = eDigit*ratio;</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :               newRP-&gt;AddDigit(*digit,eDigit);</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1028 </span>            : 
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :       TVector3 vtx(0.,0.,0.) ;</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :       TVector3 inc(0.,0.,0.) ;</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :       newRP-&gt;EvalLocalPosition(logWeight,vtx,digits,inc);</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :       AliInfo(Form(&quot;======= Unfold: daughter rec point %d =================&quot;, </span>
<span class="lineNum">    1033 </span>            :                    iMax)) ;
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :       newRP-&gt;Print();</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1036 </span>            : 
<span class="lineNum">    1037 </span>            : //    RemoveFromWorkingPool(this);
<span class="lineNum">    1038 </span>            : 
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :   delete[] eFit;</span>
<span class="lineNum">    1040 </span>            : 
<span class="lineNum">    1041 </span>            :   return nMax;
<span class="lineNum">    1042 </span>            : 
<a name="1043"><span class="lineNum">    1043 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span>            : void AliPHOSEvalRecPoint::PrintPoint()
<span class="lineNum">    1046 </span>            : {
<span class="lineNum">    1047 </span>            :   // print rec.point to stdout
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :   AliPHOSCpvRecPoint::Print();</span>
<span class="lineNum">    1049 </span>            : 
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :   TVector3 lpos;</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :   GetLocalPosition(lpos);</span>
<span class="lineNum">    1052 </span>            : 
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :   TString message ; </span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :   message  = &quot;       Chi2/dof = %f&quot; ;</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :   message += &quot;       Local (x,z) = (%f, %f) in module %d&quot; ; </span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :   AliInfo(Form(message.Data(), Chi2Dof(), lpos.X(), lpos.Z(), GetPHOSMod())) ;</span>
<span class="lineNum">    1057 </span>            : 
<a name="1058"><span class="lineNum">    1058 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1059 </span>            : 
<span class="lineNum">    1060 </span>            : AliPHOSRecManager* AliPHOSEvalRecPoint::GetReconstructionManager() const
<span class="lineNum">    1061 </span>            : {
<span class="lineNum">    1062 </span>            :   // returns reconstruction manager
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :   TFolder* aliceF = (TFolder*)gROOT-&gt;FindObjectAny(&quot;YSAlice&quot;);</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :   TFolder* wPoolF = (TFolder*)aliceF-&gt;FindObject(&quot;WhiteBoard/RecPoints/PHOS/SmP&quot;);</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :   AliPHOSRecManager* recMng = (AliPHOSRecManager*)wPoolF-&gt;FindObject(&quot;AliPHOSRecManager&quot;);</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :   if(!recMng) { </span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :     AliFatal(Form(&quot;Couldn't find Reconstruction Manager&quot;)) ;  </span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1069 </span>            : 
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :   return recMng;</span>
<span class="lineNum">    1071 </span>            : }
<a name="1072"><span class="lineNum">    1072 </span>            : </a>
<span class="lineNum">    1073 </span>            : 
<span class="lineNum">    1074 </span>            : AliPHOSRecPoint* AliPHOSEvalRecPoint::Parent()
<span class="lineNum">    1075 </span>            : {
<span class="lineNum">    1076 </span>            :   // returns a parent
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :   if(fParent&lt;0) return NULL;</span>
<span class="lineNum">    1078 </span>            :   else
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :     return (AliPHOSRecPoint*)GetFromWorkingPool(fParent);</span>
<span class="lineNum">    1080 </span>            : //    return fParent;
<a name="1081"><span class="lineNum">    1081 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1082 </span>            : 
<span class="lineNum">    1083 </span>            : Float_t AliPHOSEvalRecPoint::Chi2Dof() const 
<span class="lineNum">    1084 </span>            : {
<span class="lineNum">    1085 </span>            :   // returns a chi^2 per degree of freedom
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :   return fChi2Dof;</span>
<a name="1087"><span class="lineNum">    1087 </span>            : }</a>
<span class="lineNum">    1088 </span>            : 
<span class="lineNum">    1089 </span>            : const TObject* AliPHOSEvalRecPoint::GetWorkingPool()
<span class="lineNum">    1090 </span>            : {
<span class="lineNum">    1091 </span>            :   // returns a pool of rec.points
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :   TFolder* aliceF = (TFolder*)gROOT-&gt;FindObjectAny(&quot;YSAlice&quot;);</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :   TFolder* wPoolF = (TFolder*)aliceF-&gt;FindObject(&quot;WhiteBoard/RecPoints/PHOS/SmP&quot;);</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :   TObject* wPool = wPoolF-&gt;FindObject(&quot;SmartPoints&quot;);</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :   if(!wPool) { </span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :     AliFatal(Form(&quot;Couldn't find Working Pool&quot;)) ;  </span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1098 </span>            : 
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :   return wPool;</span>
<a name="1100"><span class="lineNum">    1100 </span>            : }</a>
<span class="lineNum">    1101 </span>            : 
<span class="lineNum">    1102 </span>            : void AliPHOSEvalRecPoint::AddToWorkingPool(TObject* obj)
<span class="lineNum">    1103 </span>            : {
<span class="lineNum">    1104 </span>            :   // add a rec.point to a pool
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :   ((TObjArray*)GetWorkingPool())-&gt;Add(obj);</span>
<a name="1106"><span class="lineNum">    1106 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1107 </span>            : 
<span class="lineNum">    1108 </span>            : TObject* AliPHOSEvalRecPoint::GetFromWorkingPool(Int_t i)
<span class="lineNum">    1109 </span>            : {
<span class="lineNum">    1110 </span>            :   // return a rec.point from a pool at an index i
<span class="lineNum">    1111 </span>            : //    return fWorkingPool-&gt;At(i);
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :   return ((TObjArray*)GetWorkingPool())-&gt;At(i);</span>
<a name="1113"><span class="lineNum">    1113 </span>            : }</a>
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span>            : Int_t AliPHOSEvalRecPoint::InWorkingPool()
<span class="lineNum">    1116 </span>            : {
<span class="lineNum">    1117 </span>            :   // return the number of rec.points in a pool
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :   return ((TObjArray*)GetWorkingPool())-&gt;GetEntries();</span>
<a name="1119"><span class="lineNum">    1119 </span>            : }</a>
<span class="lineNum">    1120 </span>            : 
<span class="lineNum">    1121 </span>            : void AliPHOSEvalRecPoint::RemoveFromWorkingPool(TObject* obj)
<span class="lineNum">    1122 </span>            : {
<span class="lineNum">    1123 </span>            :   // remove a rec.point from a pool
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :   ((TObjArray*)GetWorkingPool())-&gt;Remove(obj);</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :   ((TObjArray*)GetWorkingPool())-&gt;Compress();</span>
<a name="1126"><span class="lineNum">    1126 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1127 </span>            : 
<span class="lineNum">    1128 </span>            : void AliPHOSEvalRecPoint::PrintWorkingPool()
<span class="lineNum">    1129 </span>            : {
<span class="lineNum">    1130 </span>            :   // print pool of rec.points to stdout
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :   ((TObjArray*)GetWorkingPool())-&gt;Print();</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
