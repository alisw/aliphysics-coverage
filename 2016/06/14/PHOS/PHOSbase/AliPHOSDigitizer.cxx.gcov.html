<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - PHOS/PHOSbase/AliPHOSDigitizer.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">PHOS/PHOSbase</a> - AliPHOSDigitizer.cxx<span style="font-size: 80%;"> (source / <a href="AliPHOSDigitizer.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">253</td>
            <td class="headerCovTableEntry">489</td>
            <td class="headerCovTableEntryLo">51.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">15</td>
            <td class="headerCovTableEntry">24</td>
            <td class="headerCovTableEntryLo">62.5 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : /* $Id$ */
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : /* History of cvs commits:
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  * $Log: AliPHOSDigitizer.cxx,v $
<span class="lineNum">      21 </span>            :  * Revision 1.104  2007/12/18 09:08:18  hristov
<span class="lineNum">      22 </span>            :  * Splitting of the QA maker into simulation and reconstruction dependent parts (Yves)
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  * Revision 1.103  2007/11/07 11:25:06  schutz
<span class="lineNum">      25 </span>            :  * Comment out the QA checking before starting digitization
<span class="lineNum">      26 </span>            :  *
<span class="lineNum">      27 </span>            :  * Revision 1.102  2007/10/19 18:04:29  schutz
<span class="lineNum">      28 </span>            :  * The standalone QA data maker is called from AliSimulation and AliReconstruction outside the event loop; i.e. re-reading the data. The QA data making in the event loop has been commented out.
<span class="lineNum">      29 </span>            :  *
<span class="lineNum">      30 </span>            :  * Revision 1.101  2007/10/14 21:08:10  schutz
<span class="lineNum">      31 </span>            :  * Introduced the checking of QA results from previous step before entering the event loop
<span class="lineNum">      32 </span>            :  *
<span class="lineNum">      33 </span>            :  * Revision 1.100  2007/10/10 09:05:10  schutz
<span class="lineNum">      34 </span>            :  * Changing name QualAss to QA
<span class="lineNum">      35 </span>            :  *
<span class="lineNum">      36 </span>            :  * Revision 1.99  2007/09/30 17:08:20  schutz
<span class="lineNum">      37 </span>            :  * Introducing the notion of QA data acquisition cycle (needed by online)
<span class="lineNum">      38 </span>            :  *
<span class="lineNum">      39 </span>            :  * Revision 1.98  2007/09/26 14:22:17  cvetan
<span class="lineNum">      40 </span>            :  * Important changes to the reconstructor classes. Complete elimination of the run-loaders, which are now steered only from AliReconstruction. Removal of the corresponding Reconstruct() and FillESD() methods.
<span class="lineNum">      41 </span>            :  *
<span class="lineNum">      42 </span>            :  * Revision 1.97  2007/08/07 14:12:03  kharlov
<span class="lineNum">      43 </span>            :  * Quality assurance added (Yves Schutz)
<span class="lineNum">      44 </span>            :  *
<span class="lineNum">      45 </span>            :  * Revision 1.96  2007/04/28 10:43:36  policheh
<span class="lineNum">      46 </span>            :  * Dead channels simulation: digit energy sets to 0.
<span class="lineNum">      47 </span>            :  *
<span class="lineNum">      48 </span>            :  * Revision 1.95  2007/04/10 07:20:52  kharlov
<span class="lineNum">      49 </span>            :  * Decalibration should use the same CDB as calibration in AliPHOSClusterizerv1
<span class="lineNum">      50 </span>            :  *
<span class="lineNum">      51 </span>            :  * Revision 1.94  2007/02/01 10:34:47  hristov
<span class="lineNum">      52 </span>            :  * Removing warnings on Solaris x86
<span class="lineNum">      53 </span>            :  *
<span class="lineNum">      54 </span>            :  * Revision 1.93  2006/10/17 13:17:01  kharlov
<span class="lineNum">      55 </span>            :  * Replace AliInfo by AliDebug
<span class="lineNum">      56 </span>            :  *
<span class="lineNum">      57 </span>            :  * Revision 1.92  2006/08/28 10:01:56  kharlov
<span class="lineNum">      58 </span>            :  * Effective C++ warnings fixed (Timur Pocheptsov)
<span class="lineNum">      59 </span>            :  *
<span class="lineNum">      60 </span>            :  * Revision 1.91  2006/04/29 20:25:30  hristov
<span class="lineNum">      61 </span>            :  * Decalibration is implemented (Yu.Kharlov)
<span class="lineNum">      62 </span>            :  *
<span class="lineNum">      63 </span>            :  * Revision 1.90  2006/04/22 10:30:17  hristov
<span class="lineNum">      64 </span>            :  * Add fEnergy to AliPHOSDigit and operate with EMC amplitude in energy units (Yu.Kharlov)
<span class="lineNum">      65 </span>            :  *
<span class="lineNum">      66 </span>            :  * Revision 1.89  2006/04/11 15:22:59  hristov
<span class="lineNum">      67 </span>            :  * run number in query set to -1: forces AliCDBManager to use its run number (A.Colla)
<span class="lineNum">      68 </span>            :  *
<span class="lineNum">      69 </span>            :  * Revision 1.88  2006/03/13 14:05:43  kharlov
<span class="lineNum">      70 </span>            :  * Calibration objects for EMC and CPV
<span class="lineNum">      71 </span>            :  *
<span class="lineNum">      72 </span>            :  * Revision 1.87  2005/08/24 15:33:49  kharlov
<span class="lineNum">      73 </span>            :  * Calibration data for raw digits
<span class="lineNum">      74 </span>            :  *
<span class="lineNum">      75 </span>            :  * Revision 1.86  2005/07/12 20:07:35  hristov
<span class="lineNum">      76 </span>            :  * Changes needed to run simulation and reconstrruction in the same AliRoot session
<span class="lineNum">      77 </span>            :  *
<span class="lineNum">      78 </span>            :  * Revision 1.85  2005/05/28 14:19:04  schutz
<span class="lineNum">      79 </span>            :  * Compilation warnings fixed by T.P.
<span class="lineNum">      80 </span>            :  *
<span class="lineNum">      81 </span>            :  */
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            : //_________________________________________________________________________
<span class="lineNum">      84 </span>            : //*-- Author :  Dmitri Peressounko (SUBATECH &amp; Kurchatov Institute) 
<span class="lineNum">      85 </span>            : //////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      86 </span>            : // This class performs digitization of Summable digits (in the PHOS case it is just
<span class="lineNum">      87 </span>            : // the sum of contributions from all primary particles into a given cell). 
<span class="lineNum">      88 </span>            : // In addition it performs mixing of summable digits from different events.
<span class="lineNum">      89 </span>            : // The name of the class is also the title of the branch that will contain 
<span class="lineNum">      90 </span>            : // the created SDigits
<span class="lineNum">      91 </span>            : // The title of the class is the name of the file that contains the hits from
<span class="lineNum">      92 </span>            : // which the SDigits are created
<span class="lineNum">      93 </span>            : //
<span class="lineNum">      94 </span>            : // For each event two branches are created in TreeD:
<span class="lineNum">      95 </span>            : //   &quot;PHOS&quot; - list of digits
<span class="lineNum">      96 </span>            : //   &quot;AliPHOSDigitizer&quot; - AliPHOSDigitizer with all parameters used in digitization
<span class="lineNum">      97 </span>            : //
<span class="lineNum">      98 </span>            : // Note, that one can set a title for new digits branch, and repeat digitization with
<span class="lineNum">      99 </span>            : // another set of parameters.
<span class="lineNum">     100 </span>            : //
<span class="lineNum">     101 </span>            : // Use case:
<span class="lineNum">     102 </span>            : // root[0] AliPHOSDigitizer * d = new AliPHOSDigitizer() ;
<span class="lineNum">     103 </span>            : // root[1] d-&gt;Digitize()             
<span class="lineNum">     104 </span>            : // Warning in &lt;TDatabasePDG::TDatabasePDG&gt;: object already instantiated
<span class="lineNum">     105 </span>            : //                       //Digitizes SDigitis in all events found in file galice.root 
<span class="lineNum">     106 </span>            : //
<span class="lineNum">     107 </span>            : // root[2] AliPHOSDigitizer * d1 = new AliPHOSDigitizer(&quot;galice1.root&quot;) ;  
<span class="lineNum">     108 </span>            : //                       // Will read sdigits from galice1.root
<span class="lineNum">     109 </span>            : // root[3] d1-&gt;MixWith(&quot;galice2.root&quot;)       
<span class="lineNum">     110 </span>            : // Warning in &lt;TDatabasePDG::TDatabasePDG&gt;: object already instantiated
<span class="lineNum">     111 </span>            : //                       // Reads another set of sdigits from galice2.root
<span class="lineNum">     112 </span>            : // root[3] d1-&gt;MixWith(&quot;galice3.root&quot;)       
<span class="lineNum">     113 </span>            : //                       // Reads another set of sdigits from galice3.root
<span class="lineNum">     114 </span>            : // root[4] d-&gt;Digitize(&quot;deb timing&quot;)    
<span class="lineNum">     115 </span>            : //                       // Reads SDigits from files galice1.root, galice2.root ....
<span class="lineNum">     116 </span>            : //                       // mixes them and stores produced Digits in file galice1.root          
<span class="lineNum">     117 </span>            : //                       // deb - prints number of produced digits
<span class="lineNum">     118 </span>            : //                       // deb all - prints list of produced digits
<span class="lineNum">     119 </span>            : //                       // timing  - prints time used for digitization
<span class="lineNum">     120 </span>            : //
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            : // --- ROOT system ---
<span class="lineNum">     123 </span>            : #include &quot;TTree.h&quot;
<span class="lineNum">     124 </span>            : #include &quot;TSystem.h&quot;
<span class="lineNum">     125 </span>            : #include &quot;TBenchmark.h&quot;
<span class="lineNum">     126 </span>            : #include &quot;TRandom.h&quot;
<span class="lineNum">     127 </span>            : #include &quot;TMath.h&quot;
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span>            : // --- Standard library ---
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span>            : // --- AliRoot header files ---
<span class="lineNum">     132 </span>            : #include &lt;TGeoManager.h&gt;                                                                                                                   
<span class="lineNum">     133 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">     134 </span>            : #include &quot;AliDigitizationInput.h&quot;
<span class="lineNum">     135 </span>            : #include &quot;AliPHOSDigit.h&quot;
<span class="lineNum">     136 </span>            : #include &quot;AliPHOSDigitizer.h&quot;
<span class="lineNum">     137 </span>            : #include &quot;AliPHOSGeometry.h&quot;
<span class="lineNum">     138 </span>            : #include &quot;AliPHOSTick.h&quot;
<span class="lineNum">     139 </span>            : #include &quot;AliPHOSSimParam.h&quot;
<span class="lineNum">     140 </span>            : #include &quot;AliPHOSCalibData.h&quot;
<span class="lineNum">     141 </span>            : #include &quot;AliRunLoader.h&quot;
<span class="lineNum">     142 </span>            : #include &quot;AliPHOSLoader.h&quot;
<a name="143"><span class="lineNum">     143 </span>            : #include &quot;AliPHOSPulseGenerator.h&quot;</a>
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span><span class="lineCov">         22 : ClassImp(AliPHOSDigitizer)</span>
<span class="lineNum">     146 </span>            : 
<a name="147"><span class="lineNum">     147 </span>            : </a>
<span class="lineNum">     148 </span>            : //____________________________________________________________________________ 
<span class="lineNum">     149 </span>            : AliPHOSDigitizer::AliPHOSDigitizer() :
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :   AliDigitizer(&quot;&quot;,&quot;&quot;),</span>
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   fDefaultInit(kTRUE),</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :   fDigitsInRun(0),</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   fInit(kFALSE),</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   fInput(0),</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   fInputFileNames(0x0),</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   fEventNames(0x0),</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   fEmcCrystals(0),</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   fEventFolderName(&quot;&quot;),</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :   fFirstEvent(0),</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :   fLastEvent(0), </span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   fcdb(0x0),</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   fEventCounter(0),</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :   fPulse(0),</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :   fADCValuesLG(0),</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   fADCValuesHG(0)</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     167 </span>            :   // ctor
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :   InitParameters() ; </span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :   fDigInput = 0 ;                     // We work in the standalong mode</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 : }</span>
<a name="171"><span class="lineNum">     171 </span>            : </a>
<span class="lineNum">     172 </span>            : //____________________________________________________________________________ 
<span class="lineNum">     173 </span>            : AliPHOSDigitizer::AliPHOSDigitizer(TString alirunFileName, 
<span class="lineNum">     174 </span>            :                                    TString eventFolderName):
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :   AliDigitizer(&quot;PHOSDigitizer&quot;, alirunFileName), </span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :   fDefaultInit(kFALSE),</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :   fDigitsInRun(0),</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   fInit(kFALSE),</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :   fInput(0),</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   fInputFileNames(0x0),</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :   fEventNames(0x0),</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   fEmcCrystals(0),</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   fEventFolderName(eventFolderName),</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   fFirstEvent(0),</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   fLastEvent(0), </span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   fcdb(0x0),</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   fEventCounter(0),</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   fPulse(0),</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :   fADCValuesLG(0),</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :   fADCValuesHG(0)</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     192 </span>            :   // ctor
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :   InitParameters() ; </span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :   Init() ;</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :   fDefaultInit = kFALSE ; </span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   fDigInput = 0 ;                     // We work in the standalone mode</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   fcdb = new AliPHOSCalibData(-1);</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 : }</span>
<a name="199"><span class="lineNum">     199 </span>            : </a>
<span class="lineNum">     200 </span>            : //____________________________________________________________________________ 
<span class="lineNum">     201 </span>            : AliPHOSDigitizer::AliPHOSDigitizer(AliDigitizationInput * rd) :
<span class="lineNum">     202 </span><span class="lineCov">          1 :   AliDigitizer(rd,&quot;PHOSDigitizer&quot;),</span>
<span class="lineNum">     203 </span><span class="lineCov">          1 :   fDefaultInit(kFALSE),</span>
<span class="lineNum">     204 </span><span class="lineCov">          1 :   fDigitsInRun(0),</span>
<span class="lineNum">     205 </span><span class="lineCov">          1 :   fInit(kFALSE),</span>
<span class="lineNum">     206 </span><span class="lineCov">          1 :   fInput(0),</span>
<span class="lineNum">     207 </span><span class="lineCov">          1 :   fInputFileNames(0x0),</span>
<span class="lineNum">     208 </span><span class="lineCov">          1 :   fEventNames(0x0),</span>
<span class="lineNum">     209 </span><span class="lineCov">          1 :   fEmcCrystals(0),</span>
<span class="lineNum">     210 </span><span class="lineCov">          2 :   fEventFolderName(fDigInput-&gt;GetInputFolderName(0)),</span>
<span class="lineNum">     211 </span><span class="lineCov">          1 :   fFirstEvent(0),</span>
<span class="lineNum">     212 </span><span class="lineCov">          1 :   fLastEvent(0), </span>
<span class="lineNum">     213 </span><span class="lineCov">          1 :   fcdb (0x0), </span>
<span class="lineNum">     214 </span><span class="lineCov">          1 :   fEventCounter(0),</span>
<span class="lineNum">     215 </span><span class="lineCov">          1 :   fPulse(0),</span>
<span class="lineNum">     216 </span><span class="lineCov">          1 :   fADCValuesLG(0),</span>
<span class="lineNum">     217 </span><span class="lineCov">          1 :   fADCValuesHG(0)</span>
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span><span class="lineCov">          5 : {</span>
<span class="lineNum">     220 </span>            :   // ctor Init() is called by RunDigitizer
<span class="lineNum">     221 </span><span class="lineCov">          1 :   fDigInput = rd ; </span>
<span class="lineNum">     222 </span><span class="lineCov">          5 :   SetTitle(static_cast&lt;AliStream*&gt;(fDigInput-&gt;GetInputStream(0))-&gt;GetFileName(0));</span>
<span class="lineNum">     223 </span><span class="lineCov">          1 :   InitParameters() ; </span>
<span class="lineNum">     224 </span><span class="lineCov">          1 :   fDefaultInit = kFALSE ; </span>
<span class="lineNum">     225 </span><span class="lineCov">          3 :   fcdb = new AliPHOSCalibData(-1);</span>
<span class="lineNum">     226 </span><span class="lineCov">          2 : }</span>
<a name="227"><span class="lineNum">     227 </span>            : </a>
<span class="lineNum">     228 </span>            : //____________________________________________________________________________ 
<span class="lineNum">     229 </span>            :   AliPHOSDigitizer::~AliPHOSDigitizer()
<span class="lineNum">     230 </span><span class="lineCov">          6 : {</span>
<span class="lineNum">     231 </span>            :   // dtor  
<span class="lineNum">     232 </span><span class="lineCov">          4 :   delete [] fInputFileNames ; </span>
<span class="lineNum">     233 </span><span class="lineCov">          4 :   delete [] fEventNames ; </span>
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span><span class="lineCov">          2 :   delete fPulse;</span>
<span class="lineNum">     236 </span><span class="lineCov">          2 :   delete [] fADCValuesLG;</span>
<span class="lineNum">     237 </span><span class="lineCov">          2 :   delete [] fADCValuesHG;</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineCov">          4 :   if(fcdb){ delete fcdb ; fcdb=0;} </span>
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span><span class="lineCov">          3 : }</span>
<a name="242"><span class="lineNum">     242 </span>            : </a>
<span class="lineNum">     243 </span>            : //____________________________________________________________________________
<span class="lineNum">     244 </span>            : void AliPHOSDigitizer::Digitize(Int_t event) 
<span class="lineNum">     245 </span>            : { 
<span class="lineNum">     246 </span>            :   
<span class="lineNum">     247 </span>            :   // Makes the digitization of the collected summable digits.
<span class="lineNum">     248 </span>            :   //  It first creates the array of all PHOS modules
<span class="lineNum">     249 </span>            :   //  filled with noise (different for EMC, and CPV) and
<span class="lineNum">     250 </span>            :   //  then adds contributions from SDigits. 
<span class="lineNum">     251 </span>            :   // This design avoids scanning over the list of digits to add 
<span class="lineNum">     252 </span>            :   // contribution to new SDigits only.
<span class="lineNum">     253 </span>            : 
<span class="lineNum">     254 </span>            :   Bool_t toMakeNoise = kTRUE ; //Do not create noisy digits if merge with real data
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span>            :   //First stream 
<span class="lineNum">     257 </span><span class="lineCov">          8 :   AliRunLoader* rl = AliRunLoader::GetRunLoader(fEventFolderName) ;</span>
<span class="lineNum">     258 </span><span class="lineCov">          4 :   AliPHOSLoader * phosLoader = static_cast&lt;AliPHOSLoader*&gt;(rl-&gt;GetLoader(&quot;PHOSLoader&quot;));</span>
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span>            :   Int_t readEvent = event ; 
<span class="lineNum">     261 </span><span class="lineCov">          4 :   if (fDigInput) </span>
<span class="lineNum">     262 </span><span class="lineCov">          4 :     readEvent = static_cast&lt;AliStream*&gt;(fDigInput-&gt;GetInputStream(0))-&gt;GetCurrentEventNumber() ; </span>
<span class="lineNum">     263 </span><span class="lineCov">         12 :   AliDebug(1,Form(&quot;Adding event %d from input stream 0 %s %s&quot;, </span>
<span class="lineNum">     264 </span>            :                   readEvent, GetTitle(), fEventFolderName.Data())) ; 
<span class="lineNum">     265 </span><span class="lineCov">          4 :   rl-&gt;GetEvent(readEvent) ;</span>
<span class="lineNum">     266 </span><span class="lineCov">          4 :   phosLoader-&gt;CleanSDigits() ; </span>
<span class="lineNum">     267 </span><span class="lineCov">          4 :   phosLoader-&gt;LoadSDigits(&quot;READ&quot;) ;</span>
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span>            :   //Prepare Output
<span class="lineNum">     270 </span><span class="lineCov">          4 :   TClonesArray * digits = phosLoader-&gt;Digits() ;</span>
<span class="lineNum">     271 </span><span class="lineCov">          4 :   if( !digits ) {</span>
<span class="lineNum">     272 </span><span class="lineCov">          1 :     phosLoader-&gt;MakeDigitsArray() ; </span>
<span class="lineNum">     273 </span><span class="lineCov">          1 :     digits = phosLoader-&gt;Digits() ;</span>
<span class="lineNum">     274 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     275 </span>            :  
<span class="lineNum">     276 </span><span class="lineCov">          4 :   digits-&gt;Clear() ;</span>
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span>            :   //
<span class="lineNum">     279 </span><span class="lineCov">          4 :   const AliPHOSGeometry *geom = AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     280 </span>            :   //Making digits with noise, first EMC
<span class="lineNum">     281 </span>            :   //Check which PHOS modules are present
<span class="lineNum">     282 </span><span class="lineCov">          4 :   Bool_t isPresent[5] ;</span>
<span class="lineNum">     283 </span><span class="lineCov">          4 :   Bool_t isCPVpresent[5] ;</span>
<span class="lineNum">     284 </span><span class="lineCov">          4 :   TString volpath ;</span>
<span class="lineNum">     285 </span>            :   Int_t nmod=0 ;
<span class="lineNum">     286 </span>            :   Int_t nCPVmod=0 ;
<span class="lineNum">     287 </span><span class="lineCov">         48 :   for(Int_t i=0; i&lt;5; i++){</span>
<span class="lineNum">     288 </span><span class="lineCov">         20 :     isPresent[i]=0 ;</span>
<span class="lineNum">     289 </span><span class="lineCov">         20 :     isCPVpresent[i]=0 ;</span>
<span class="lineNum">     290 </span><span class="lineCov">         60 :     if (gGeoManager-&gt;CheckPath(Form(&quot;/ALIC_1/PHOS_%d&quot;,i+1))) { //PHOS module without CPV</span>
<span class="lineNum">     291 </span><span class="lineCov">         12 :       isPresent[i]=1 ;</span>
<span class="lineNum">     292 </span><span class="lineCov">         12 :       nmod++ ;</span>
<span class="lineNum">     293 </span><span class="lineCov">         12 :     }</span>
<span class="lineNum">     294 </span><span class="lineCov">         60 :     if (gGeoManager-&gt;CheckPath(Form(&quot;/ALIC_1/PHOC_%d&quot;,i+1))) { //PHOS module with CPV</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :       isPresent[i]=1 ;</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :       isCPVpresent[i]=1 ;</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :       nCPVmod++ ;</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :       nmod++ ;</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     300 </span><span class="lineCov">         60 :     if (gGeoManager-&gt;CheckPath(Form(&quot;/ALIC_1/PHOH_%d&quot;,i+1))) { //1/2 PHOS module</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :       isPresent[i]=1 ;</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :       nmod++ ;</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     304 </span>            :   }
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineCov">         12 :   Int_t nEMC = nmod*geom-&gt;GetNPhi()*geom-&gt;GetNZ();</span>
<span class="lineNum">     307 </span>            :   
<span class="lineNum">     308 </span>            :   Int_t nCPV ;
<span class="lineNum">     309 </span>            :   Int_t absID ;
<span class="lineNum">     310 </span>            :     
<span class="lineNum">     311 </span><span class="lineCov">          4 :   if(nCPVmod){</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :     nCPV = nEMC + geom-&gt;GetNumberOfCPVPadsZ() * geom-&gt;GetNumberOfCPVPadsPhi() * nCPVmod ;</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     314 </span>            :   else{
<span class="lineNum">     315 </span>            :      nCPV = nEMC ;
<span class="lineNum">     316 </span>            :   }    
<span class="lineNum">     317 </span>            :   
<span class="lineNum">     318 </span><span class="lineCov">          4 :   digits-&gt;Expand(nCPV) ;</span>
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span>            :   //take all the inputs to add together and load the SDigits
<span class="lineNum">     321 </span><span class="lineCov">          8 :   TObjArray * sdigArray = new TObjArray(fInput) ;</span>
<span class="lineNum">     322 </span><span class="lineCov">          8 :   sdigArray-&gt;AddAt(phosLoader-&gt;SDigits(), 0) ;</span>
<span class="lineNum">     323 </span>            :  
<span class="lineNum">     324 </span><span class="lineCov">         12 :   for(Int_t i = 1 ; i &lt; fInput ; i++){</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     TString tempo(fEventNames[i]) ; </span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     tempo += i ;</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     AliRunLoader* rl2 = AliRunLoader::GetRunLoader(tempo) ;</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     if(!rl2){ </span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       rl2 = AliRunLoader::Open(fInputFileNames[i], tempo) ;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :       if (!rl2) {</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :         Fatal(&quot;AliPHOSDigitizer&quot;, &quot;Could not find the Run Loader for %s - %s&quot;,fInputFileNames[i].Data(), tempo.Data()) ;</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :         return ;</span>
<span class="lineNum">     333 </span>            :       }
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :       rl2-&gt;LoadHeader();</span>
<span class="lineNum">     335 </span>            :     }
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     AliPHOSLoader * phosLoader2 = static_cast&lt;AliPHOSLoader*&gt;(rl2-&gt;GetLoader(&quot;PHOSLoader&quot;));</span>
<span class="lineNum">     337 </span>            :  
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :     if(fDigInput){ </span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :       readEvent = static_cast&lt;AliStream*&gt;(fDigInput-&gt;GetInputStream(i))-&gt;GetCurrentEventNumber() ; </span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     341 </span>            :     TClonesArray * digs ;
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :     if(AliPHOSSimParam::GetInstance()-&gt;IsStreamDigits(i)){ //This is Digits Stream</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :       AliInfo(Form(&quot;Adding event %d from input stream %d %s %s&quot;, </span>
<span class="lineNum">     344 </span>            :                  readEvent, i, fInputFileNames[i].Data(), tempo.Data())) ; 
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :        rl2-&gt;GetEvent(readEvent) ;</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :        phosLoader2-&gt;CleanDigits() ;</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :        phosLoader2-&gt;LoadDigits(&quot;READ&quot;) ;</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :        digs = phosLoader2-&gt;Digits() ;</span>
<span class="lineNum">     349 </span>            :        toMakeNoise=0 ; //Do not add noise, it is already in stream
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     351 </span>            :     else{
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :       AliInfo(Form(&quot;Adding event %d (SDigits) from input stream %d %s %s&quot;,</span>
<span class="lineNum">     353 </span>            :                  readEvent, i, fInputFileNames[i].Data(), tempo.Data())) ;
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :        rl2-&gt;GetEvent(readEvent) ;</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :        phosLoader2-&gt;CleanSDigits() ; </span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :        phosLoader2-&gt;LoadSDigits(&quot;READ&quot;) ;</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :        digs = phosLoader2-&gt;SDigits() ;</span>
<span class="lineNum">     358 </span>            :     } 
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :     sdigArray-&gt;AddAt(digs, i) ;</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span>            :   //Find the first crystal with signal
<span class="lineNum">     363 </span>            :   Int_t nextSig = 200000 ; 
<span class="lineNum">     364 </span>            :   TClonesArray * sdigits ;  
<span class="lineNum">     365 </span><span class="lineCov">         16 :   for(Int_t i = 0 ; i &lt; fInput ; i++){</span>
<span class="lineNum">     366 </span><span class="lineCov">          8 :     sdigits = static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i)) ;</span>
<span class="lineNum">     367 </span><span class="lineCov">          8 :     if ( !sdigits-&gt;GetEntriesFast() )</span>
<span class="lineNum">     368 </span>            :       continue ; 
<span class="lineNum">     369 </span><span class="lineCov">          8 :     Int_t curNext = static_cast&lt;AliPHOSDigit *&gt;(sdigits-&gt;At(0))-&gt;GetId() ;</span>
<span class="lineNum">     370 </span><span class="lineCov">          4 :     if(curNext &lt; nextSig) </span>
<span class="lineNum">     371 </span><span class="lineCov">          4 :       nextSig = curNext ;</span>
<span class="lineNum">     372 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">     373 </span>            :   
<span class="lineNum">     374 </span><span class="lineCov">          4 :   TArrayI index(fInput) ;</span>
<span class="lineNum">     375 </span><span class="lineCov">          4 :   index.Reset() ;  //Set all indexes to zero</span>
<span class="lineNum">     376 </span>            :   
<span class="lineNum">     377 </span>            :   AliPHOSDigit * digit ;
<span class="lineNum">     378 </span>            :   AliPHOSDigit * curSDigit ;
<span class="lineNum">     379 </span>            :   
<span class="lineNum">     380 </span>            : //  TClonesArray * ticks = new TClonesArray(&quot;AliPHOSTick&quot;,1000) ;
<span class="lineNum">     381 </span>            :   
<span class="lineNum">     382 </span>            :   //Put Noise contribution
<span class="lineNum">     383 </span>            :   Double_t apdNoise = 0. ;
<span class="lineNum">     384 </span><span class="lineCov">          4 :   if(toMakeNoise)</span>
<span class="lineNum">     385 </span><span class="lineCov">          8 :      apdNoise = AliPHOSSimParam::GetInstance()-&gt;GetAPDNoise() ; </span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineCov">          4 :   Int_t relId[4] ;</span>
<span class="lineNum">     388 </span><span class="lineCov">         12 :   Int_t emcpermod=geom-&gt;GetNPhi()*geom-&gt;GetNZ();</span>
<span class="lineNum">     389 </span>            :   Int_t idigit= 0;
<span class="lineNum">     390 </span><span class="lineCov">         48 :   for(Int_t imod=0; imod&lt;5; imod++){</span>
<span class="lineNum">     391 </span><span class="lineCov">         20 :     if(!isPresent[imod])</span>
<span class="lineNum">     392 </span>            :       continue ;
<span class="lineNum">     393 </span><span class="lineCov">         12 :     Int_t firstAbsId=imod*emcpermod+1 ;</span>
<span class="lineNum">     394 </span><span class="lineCov">         12 :     Int_t lastAbsId =(imod+1)*emcpermod ; </span>
<span class="lineNum">     395 </span><span class="lineCov">      86040 :     for(absID = firstAbsId ; absID &lt;= lastAbsId ; absID++){</span>
<span class="lineNum">     396 </span>            :       //do not add digits to non-existing part of mod4
<span class="lineNum">     397 </span><span class="lineCov">      43008 :       geom-&gt;AbsToRelNumbering(absID,relId) ;</span>
<span class="lineNum">     398 </span><span class="lineCov">      43008 :       if(relId[0]==4 &amp;&amp; relId[2]&lt;33) //This part of module does not exist</span>
<span class="lineNum">     399 </span>            :         continue ;
<span class="lineNum">     400 </span><span class="lineCov">      86016 :       Float_t noise = gRandom-&gt;Gaus(0.,apdNoise) ; </span>
<span class="lineNum">     401 </span><span class="lineCov">     172032 :       new((*digits)[idigit]) AliPHOSDigit( -1, absID, noise, TimeOfNoise() ) ;</span>
<span class="lineNum">     402 </span>            :       //look if we have to add signal?
<span class="lineNum">     403 </span><span class="lineCov">      86016 :       digit = static_cast&lt;AliPHOSDigit *&gt;(digits-&gt;At(idigit)) ;</span>
<span class="lineNum">     404 </span><span class="lineCov">      43008 :       idigit++ ;</span>
<span class="lineNum">     405 </span>            :     
<span class="lineNum">     406 </span><span class="lineCov">      43008 :       if(absID==nextSig){</span>
<span class="lineNum">     407 </span>            :       //Add SDigits from all inputs 
<span class="lineNum">     408 </span>            : //      ticks-&gt;Clear() ;
<span class="lineNum">     409 </span>            : //      Int_t contrib = 0 ;
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span>            : //New Timing model is necessary
<span class="lineNum">     412 </span>            : //      Float_t a = digit-&gt;GetEnergy() ;
<span class="lineNum">     413 </span>            : //      Float_t b = TMath::Abs( a / fTimeSignalLength) ;
<span class="lineNum">     414 </span>            : //      //Mark the beginning of the signal
<span class="lineNum">     415 </span>            : //      new((*ticks)[contrib++]) AliPHOSTick(digit-&gt;GetTime(),0, b);  
<span class="lineNum">     416 </span>            : //      //Mark the end of the signal     
<span class="lineNum">     417 </span>            : //      new((*ticks)[contrib++]) AliPHOSTick(digit-&gt;GetTime()+fTimeSignalLength, -a, -b); 
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span>            : // Calculate time as time of the largest digit
<span class="lineNum">     420 </span><span class="lineCov">        365 :         Float_t time = digit-&gt;GetTime() ;</span>
<span class="lineNum">     421 </span><span class="lineCov">        365 :         Float_t eTime= digit-&gt;GetEnergy() ;</span>
<span class="lineNum">     422 </span>            :       
<span class="lineNum">     423 </span>            :         //loop over inputs
<span class="lineNum">     424 </span><span class="lineCov">       1460 :         for(Int_t i = 0 ; i &lt; fInput ; i++){</span>
<span class="lineNum">     425 </span><span class="lineCov">       1460 :           if( static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i))-&gt;GetEntriesFast() &gt; index[i] ){</span>
<span class="lineNum">     426 </span><span class="lineCov">       1460 :             curSDigit = static_cast&lt;AliPHOSDigit*&gt;(static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i))-&gt;At(index[i])) ;     </span>
<span class="lineNum">     427 </span><span class="lineCov">        730 :             if(AliPHOSSimParam::GetInstance()-&gt;IsStreamDigits(i)){ //This is Digits Stream</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :               curSDigit-&gt;SetEnergy(Calibrate(curSDigit-&gt;GetEnergy(),curSDigit-&gt;GetId())) ;</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :               curSDigit-&gt;SetTime(CalibrateT(curSDigit-&gt;GetTime(),curSDigit-&gt;GetId())) ;</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     431 </span>            :           }
<span class="lineNum">     432 </span>            :           else
<span class="lineNum">     433 </span>            :             curSDigit = 0 ;
<span class="lineNum">     434 </span>            :           //May be several digits will contribute from the same input
<span class="lineNum">     435 </span><span class="lineCov">       1821 :           while(curSDigit &amp;&amp; curSDigit-&gt;GetId() == absID){      </span>
<span class="lineNum">     436 </span>            :             //Shift primary to separate primaries belonging different inputs
<span class="lineNum">     437 </span>            :             Int_t primaryoffset ;
<span class="lineNum">     438 </span><span class="lineCov">        365 :             if(fDigInput)</span>
<span class="lineNum">     439 </span><span class="lineCov">        365 :               primaryoffset = fDigInput-&gt;GetMask(i) ; </span>
<span class="lineNum">     440 </span>            :             else
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :               primaryoffset = 10000000*i ;</span>
<span class="lineNum">     442 </span><span class="lineCov">        365 :             curSDigit-&gt;ShiftPrimary(primaryoffset) ;</span>
<span class="lineNum">     443 </span>            :           
<span class="lineNum">     444 </span>            : //New Timing model is necessary
<span class="lineNum">     445 </span>            : //        a = curSDigit-&gt;GetEnergy() ;
<span class="lineNum">     446 </span>            : //        b = a /fTimeSignalLength ;
<span class="lineNum">     447 </span>            : //        new((*ticks)[contrib++]) AliPHOSTick(curSDigit-&gt;GetTime(),0, b);  
<span class="lineNum">     448 </span>            : //        new((*ticks)[contrib++]) AliPHOSTick(curSDigit-&gt;GetTime()+fTimeSignalLength, -a, -b); 
<span class="lineNum">     449 </span><span class="lineCov">        365 :           if(curSDigit-&gt;GetEnergy()&gt;eTime){</span>
<span class="lineNum">     450 </span><span class="lineCov">        292 :             eTime=curSDigit-&gt;GetEnergy() ;</span>
<span class="lineNum">     451 </span><span class="lineCov">        292 :             time=curSDigit-&gt;GetTime() ;</span>
<span class="lineNum">     452 </span><span class="lineCov">        292 :           }</span>
<span class="lineNum">     453 </span><span class="lineCov">        365 :             *digit += *curSDigit ;  //add energies</span>
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span><span class="lineCov">        730 :             index[i]++ ;</span>
<span class="lineNum">     456 </span><span class="lineCov">       1460 :             if( static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i))-&gt;GetEntriesFast() &gt; index[i] )</span>
<span class="lineNum">     457 </span><span class="lineCov">       1444 :               curSDigit = static_cast&lt;AliPHOSDigit*&gt;(static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i))-&gt;At(index[i])) ;   </span>
<span class="lineNum">     458 </span>            :             else
<span class="lineNum">     459 </span>            :               curSDigit = 0 ;
<span class="lineNum">     460 </span>            :           }
<span class="lineNum">     461 </span>            :         }
<span class="lineNum">     462 </span>            :       
<span class="lineNum">     463 </span>            :         //calculate and set time
<span class="lineNum">     464 </span>            : //New Timing model is necessary
<span class="lineNum">     465 </span>            : //      Float_t time = FrontEdgeTime(ticks) ;
<span class="lineNum">     466 </span><span class="lineCov">        365 :         digit-&gt;SetTime(time) ;</span>
<span class="lineNum">     467 </span>            :       
<span class="lineNum">     468 </span>            :         //Find next signal module
<span class="lineNum">     469 </span>            :         nextSig = 200000 ;
<span class="lineNum">     470 </span><span class="lineCov">       1460 :         for(Int_t i = 0 ; i &lt; fInput ; i++){</span>
<span class="lineNum">     471 </span><span class="lineCov">        730 :           sdigits = static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i)) ;</span>
<span class="lineNum">     472 </span>            :           Int_t curNext = nextSig ;
<span class="lineNum">     473 </span><span class="lineCov">       1095 :           if(sdigits-&gt;GetEntriesFast() &gt; index[i] ){</span>
<span class="lineNum">     474 </span><span class="lineCov">       1083 :             curNext = static_cast&lt;AliPHOSDigit *&gt;(sdigits-&gt;At(index[i]))-&gt;GetId() ;</span>
<span class="lineNum">     475 </span><span class="lineCov">        361 :           }</span>
<span class="lineNum">     476 </span><span class="lineCov">        726 :           if(curNext &lt; nextSig) nextSig = curNext ;</span>
<span class="lineNum">     477 </span>            :         }
<span class="lineNum">     478 </span><span class="lineCov">        365 :       }</span>
<span class="lineNum">     479 </span><span class="lineCov">      43008 :     }</span>
<span class="lineNum">     480 </span><span class="lineCov">         12 :   }</span>
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span>            :   Int_t nEMCcreated=idigit ;
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span>            :   //Apply non-linearity
<span class="lineNum">     485 </span><span class="lineCov">          8 :   if(AliPHOSSimParam::GetInstance()-&gt;IsCellNonlinearityOn()){ //Apply non-lineairyt on cell level</span>
<span class="lineNum">     486 </span><span class="lineCov">          8 :     const Double_t aNL = AliPHOSSimParam::GetInstance()-&gt;GetCellNonLineairyA() ;</span>
<span class="lineNum">     487 </span><span class="lineCov">          8 :     const Double_t bNL = AliPHOSSimParam::GetInstance()-&gt;GetCellNonLineairyB() ;</span>
<span class="lineNum">     488 </span><span class="lineCov">          8 :     const Double_t cNL = AliPHOSSimParam::GetInstance()-&gt;GetCellNonLineairyC() ;</span>
<span class="lineNum">     489 </span><span class="lineCov">      86024 :     for(Int_t i = 0 ; i &lt; nEMCcreated ; i++){</span>
<span class="lineNum">     490 </span><span class="lineCov">      86016 :       digit = static_cast&lt;AliPHOSDigit*&gt;( digits-&gt;At(i) ) ;</span>
<span class="lineNum">     491 </span><span class="lineCov">      43008 :       if(digit){ //if there is mod 4, there is a hole</span>
<span class="lineNum">     492 </span><span class="lineCov">      43008 :          Double_t e= digit-&gt;GetEnergy() ;</span>
<span class="lineNum">     493 </span>            :          // version(1)      digit-&gt;SetEnergy(e*(1+a*TMath::Exp(-e/b))) ;
<span class="lineNum">     494 </span><span class="lineCov">      43008 :          digit-&gt;SetEnergy(e*cNL*(1.+aNL*TMath::Exp(-e*e/2./bNL/bNL))) ; //Better agreement with data...</span>
<span class="lineNum">     495 </span><span class="lineCov">      43008 :       }</span>
<span class="lineNum">     496 </span>            :     }  
<span class="lineNum">     497 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span>            :   //distretize energy if necessary
<span class="lineNum">     501 </span><span class="lineCov">          8 :   if(AliPHOSSimParam::GetInstance()-&gt;IsEDigitizationOn()){</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :     Float_t adcW=AliPHOSSimParam::GetInstance()-&gt;GetADCchannelW() ;</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :     for(Int_t i = 0 ; i &lt; nEMCcreated ; i++){                                                                                                       </span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :       digit = static_cast&lt;AliPHOSDigit*&gt;( digits-&gt;At(i) ) ;</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :       if(digit)</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :         digit-&gt;SetEnergy(adcW*ceil(digit-&gt;GetEnergy()/adcW)) ;</span>
<span class="lineNum">     507 </span>            :     } 
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     509 </span>            :  
<span class="lineNum">     510 </span>            :   //Apply decalibration if necessary
<span class="lineNum">     511 </span><span class="lineCov">      86024 :   for(Int_t i = 0 ; i &lt; nEMCcreated ; i++){</span>
<span class="lineNum">     512 </span><span class="lineCov">      86016 :     digit = static_cast&lt;AliPHOSDigit*&gt;( digits-&gt;At(i) ) ;</span>
<span class="lineNum">     513 </span><span class="lineCov">      43008 :     if(digit)</span>
<span class="lineNum">     514 </span><span class="lineCov">      43008 :       Decalibrate(digit) ;</span>
<span class="lineNum">     515 </span>            :   }
<span class="lineNum">     516 </span>            :   
<span class="lineNum">     517 </span>            : //  ticks-&gt;Delete() ;
<span class="lineNum">     518 </span>            : //  delete ticks ;
<span class="lineNum">     519 </span>            :   
<span class="lineNum">     520 </span>            :   //Now CPV digits (different noise and no timing)
<span class="lineNum">     521 </span><span class="lineCov">         12 :   Int_t cpvpermod = geom-&gt;GetNumberOfCPVPadsZ() * geom-&gt;GetNumberOfCPVPadsPhi() ;</span>
<span class="lineNum">     522 </span><span class="lineCov">          4 :   Int_t nEMCtotal=emcpermod*5 ;</span>
<span class="lineNum">     523 </span><span class="lineCov">          8 :   Float_t cpvNoise = AliPHOSSimParam::GetInstance()-&gt;GetCPVNoise() ;</span>
<span class="lineNum">     524 </span><span class="lineCov">         48 :   for(Int_t imod=0; imod&lt;5; imod++){ //module is present in current geometry</span>
<span class="lineNum">     525 </span><span class="lineCov">         20 :     if(isCPVpresent[imod]){  //CPV is present in current geometry</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :       Int_t firstAbsId=nEMCtotal+imod*cpvpermod+1 ;</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :       Int_t lastAbsId =nEMCtotal+(imod+1)*cpvpermod ;</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :       for(absID = firstAbsId; absID &lt;= lastAbsId; absID++){</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :         Float_t noise = gRandom-&gt;Gaus(0., cpvNoise) ; </span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :         new((*digits)[idigit]) AliPHOSDigit( -1,absID,noise, TimeOfNoise() ) ;</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :         idigit++ ;</span>
<span class="lineNum">     532 </span>            :         //look if we have to add signal?
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :         if(absID==nextSig){</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :           digit = static_cast&lt;AliPHOSDigit *&gt;(digits-&gt;At(idigit-1)) ;</span>
<span class="lineNum">     535 </span>            :           //Add SDigits from all inputs
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :           for(Int_t i = 0 ; i &lt; fInput ; i++){</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :              if( static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i))-&gt;GetEntriesFast() &gt; index[i] )</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :                curSDigit = static_cast&lt;AliPHOSDigit*&gt;( static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i))-&gt;At(index[i])) ;         </span>
<span class="lineNum">     539 </span>            :              else
<span class="lineNum">     540 </span>            :                curSDigit = 0 ;
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span>            :              //May be several digits will contribute from the same input
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :              while(curSDigit &amp;&amp; curSDigit-&gt;GetId() == absID){           </span>
<span class="lineNum">     544 </span>            :                //Shift primary to separate primaries belonging different inputs
<span class="lineNum">     545 </span>            :                Int_t primaryoffset ;
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :                if(fDigInput)</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :                  primaryoffset = fDigInput-&gt;GetMask(i) ; </span>
<span class="lineNum">     548 </span>            :                else
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :                  primaryoffset = 10000000*i ;</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :                curSDigit-&gt;ShiftPrimary(primaryoffset) ;</span>
<span class="lineNum">     551 </span>            : 
<span class="lineNum">     552 </span>            :                //add energies
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :                *digit += *curSDigit ;  </span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :                index[i]++ ;</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :                if( static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i))-&gt;GetEntriesFast() &gt; index[i] )</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                  curSDigit = static_cast&lt;AliPHOSDigit*&gt;( static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i))-&gt;At(index[i]) ) ;      </span>
<span class="lineNum">     557 </span>            :                else
<span class="lineNum">     558 </span>            :                  curSDigit = 0 ;
<span class="lineNum">     559 </span>            :              }
<span class="lineNum">     560 </span>            :           }
<span class="lineNum">     561 </span>            : 
<span class="lineNum">     562 </span>            :           //Find next signal module
<span class="lineNum">     563 </span>            :           nextSig = 200000 ;
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :           for(Int_t i = 0 ; i &lt; fInput ; i++){</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :             sdigits = static_cast&lt;TClonesArray *&gt;(sdigArray-&gt;At(i)) ;</span>
<span class="lineNum">     566 </span>            :             Int_t curNext = nextSig ;
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :             if(sdigits-&gt;GetEntriesFast() &gt; index[i] )</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :               curNext = static_cast&lt;AliPHOSDigit *&gt;( sdigits-&gt;At(index[i]) )-&gt;GetId() ;</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :             if(curNext &lt; nextSig) nextSig = curNext ;</span>
<span class="lineNum">     570 </span>            :           }
<span class="lineNum">     571 </span>            :       
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     573 </span>            :       }
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     575 </span>            :   }
<span class="lineNum">     576 </span>            : 
<span class="lineNum">     577 </span><span class="lineCov">          8 :   delete sdigArray ; //We should not delete its contents </span>
<span class="lineNum">     578 </span>            :   
<span class="lineNum">     579 </span>            :   //set amplitudes in bad channels to zero
<span class="lineNum">     580 </span>            :   
<span class="lineNum">     581 </span>            :   
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span>            : //  for(Int_t i = 0 ; i &lt;digits-&gt;GetEntriesFast(); i++){
<span class="lineNum">     584 </span><span class="lineCov">      86024 :   for(Int_t i = 0 ; i &lt;nEMCcreated; i++){</span>
<span class="lineNum">     585 </span><span class="lineCov">      86016 :     digit = static_cast&lt;AliPHOSDigit*&gt;( digits-&gt;At(i) ) ;</span>
<span class="lineNum">     586 </span><span class="lineCov">      43008 :     if(digit){</span>
<span class="lineNum">     587 </span><span class="lineCov">      43008 :       geom-&gt;AbsToRelNumbering(digit-&gt;GetId(),relId);</span>
<span class="lineNum">     588 </span><span class="lineCov">      43008 :       if(relId[1] == 0){ // Emc</span>
<span class="lineNum">     589 </span><span class="lineCov">      86016 :         if(fcdb-&gt;IsBadChannelEmc(relId[0],relId[3],relId[2])) digit-&gt;SetEnergy(0.); </span>
<span class="lineNum">     590 </span>            :       }
<span class="lineNum">     591 </span><span class="lineCov">      43008 :       if(relId[1] == -1){ // Cpv</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :         if(fcdb-&gt;IsBadChannelCpv(relId[0],relId[3],relId[2])) digit-&gt;SetEnergy(0.); </span>
<span class="lineNum">     593 </span>            :       }
<span class="lineNum">     594 </span>            :     }
<span class="lineNum">     595 </span>            :   }
<span class="lineNum">     596 </span>            : 
<span class="lineNum">     597 </span>            :   //remove digits below thresholds
<span class="lineNum">     598 </span><span class="lineCov">          8 :   Float_t emcThreshold = AliPHOSSimParam::GetInstance()-&gt;GetEmcDigitsThreshold() ;</span>
<span class="lineNum">     599 </span><span class="lineCov">      86024 :   for(Int_t i = 0 ; i &lt; nEMCcreated ; i++){</span>
<span class="lineNum">     600 </span><span class="lineCov">      86016 :     digit = static_cast&lt;AliPHOSDigit*&gt;( digits-&gt;At(i) ) ;</span>
<span class="lineNum">     601 </span><span class="lineCov">      43008 :     if(!digit)</span>
<span class="lineNum">     602 </span>            :       continue ;
<span class="lineNum">     603 </span><span class="lineCov">      43008 :     if(digit-&gt;GetEnergy() &lt; emcThreshold){</span>
<span class="lineNum">     604 </span><span class="lineCov">      42884 :       digits-&gt;RemoveAt(i) ;</span>
<span class="lineNum">     605 </span>            :       continue ;
<span class="lineNum">     606 </span>            :     }
<span class="lineNum">     607 </span>            : 
<span class="lineNum">     608 </span><span class="lineCov">        124 :     geom-&gt;AbsToRelNumbering(digit-&gt;GetId(),relId);</span>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span>            : //    digit-&gt;SetEnergy(TMath::Ceil(digit-&gt;GetEnergy())-0.9999) ;
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span><span class="lineCov">        124 :     Float_t tres = TimeResolution(digit-&gt;GetEnergy()) ; </span>
<span class="lineNum">     613 </span><span class="lineCov">        248 :     digit-&gt;SetTime(gRandom-&gt;Gaus(digit-&gt;GetTime(), tres) ) ;</span>
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineCov">        124 :     fPulse-&gt;Reset();</span>
<span class="lineNum">     616 </span><span class="lineCov">        248 :     fPulse-&gt;SetAmplitude(digit-&gt;GetEnergy()/</span>
<span class="lineNum">     617 </span><span class="lineCov">        124 :                          fcdb-&gt;GetADCchannelEmc(relId[0],relId[3],relId[2]));</span>
<span class="lineNum">     618 </span><span class="lineCov">        124 :     fPulse-&gt;SetTZero(digit-&gt;GetTimeR());</span>
<span class="lineNum">     619 </span><span class="lineCov">        124 :     fPulse-&gt;MakeSamples();</span>
<span class="lineNum">     620 </span><span class="lineCov">        124 :     fPulse-&gt;GetSamples(fADCValuesHG, fADCValuesLG) ; </span>
<span class="lineNum">     621 </span><span class="lineCov">        124 :     Int_t nSamples = fPulse-&gt;GetRawFormatTimeBins();</span>
<span class="lineNum">     622 </span><span class="lineCov">        124 :     digit-&gt;SetALTROSamplesHG(nSamples,fADCValuesHG);</span>
<span class="lineNum">     623 </span><span class="lineCov">        124 :     digit-&gt;SetALTROSamplesLG(nSamples,fADCValuesLG);</span>
<span class="lineNum">     624 </span><span class="lineCov">        124 :   }</span>
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span><span class="lineCov">          4 :   Int_t nCPVcreated=digits-&gt;GetEntriesFast() ;</span>
<span class="lineNum">     627 </span><span class="lineCov">          8 :   Float_t cpvDigitThreshold = AliPHOSSimParam::GetInstance()-&gt;GetCpvDigitsThreshold() ;</span>
<span class="lineNum">     628 </span><span class="lineCov">          8 :   for(Int_t i = nEMCcreated; i &lt; nCPVcreated ; i++){</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :     if( static_cast&lt;AliPHOSDigit*&gt;(digits-&gt;At(i))-&gt;GetEnergy() &lt; cpvDigitThreshold )</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :       digits-&gt;RemoveAt(i) ;</span>
<span class="lineNum">     631 </span>            :   } 
<span class="lineNum">     632 </span>            :     
<span class="lineNum">     633 </span><span class="lineCov">          4 :   digits-&gt;Compress() ;  </span>
<span class="lineNum">     634 </span><span class="lineCov">          4 :   Int_t ndigits = digits-&gt;GetEntriesFast() ;</span>
<span class="lineNum">     635 </span>            :   
<span class="lineNum">     636 </span>            :   //Set indexes in list of digits and make true digitization of the energy
<span class="lineNum">     637 </span><span class="lineCov">        256 :   for (Int_t i = 0 ; i &lt; ndigits ; i++) { </span>
<span class="lineNum">     638 </span><span class="lineCov">        248 :     digit = static_cast&lt;AliPHOSDigit*&gt;( digits-&gt;At(i) ) ; </span>
<span class="lineNum">     639 </span><span class="lineCov">        124 :     digit-&gt;SetIndexInList(i) ;     </span>
<span class="lineNum">     640 </span><span class="lineCov">        124 :     if(digit-&gt;GetId() &gt; fEmcCrystals){ //digitize CPV only</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :       digit-&gt;SetAmp(DigitizeCPV(digit-&gt;GetEnergy(),digit-&gt;GetId()) ) ;</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     643 </span>            :   }
<span class="lineNum">     644 </span>            : 
<a name="645"><span class="lineNum">     645 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">     646 </span>            : //____________________________________________________________________________
<span class="lineNum">     647 </span>            : Float_t AliPHOSDigitizer::Calibrate(Float_t amp,Int_t absId){
<span class="lineNum">     648 </span>            :   //Apply calibration
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :   const AliPHOSGeometry *geom = AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span>            :   //Determine rel.position of the cell absolute ID
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :   Int_t relId[4];</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :   geom-&gt;AbsToRelNumbering(absId,relId);</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :   Int_t module=relId[0];</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :   Int_t row   =relId[2];</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :   Int_t column=relId[3];</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :   if(relId[1]==0){ //This Is EMC</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :     Float_t calibration = fcdb-&gt;GetADCchannelEmc(module,column,row);</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :     return amp*calibration ;</span>
<span class="lineNum">     660 </span>            :   }
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :   return 0 ;</span>
<a name="662"><span class="lineNum">     662 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     663 </span>            : //____________________________________________________________________________
<span class="lineNum">     664 </span>            : void AliPHOSDigitizer::Decalibrate(AliPHOSDigit *digit)
<span class="lineNum">     665 </span>            : {
<span class="lineNum">     666 </span>            :   // Decalibrate EMC digit, i.e. change its energy by a factor read from CDB
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span><span class="lineCov">      86016 :   const AliPHOSGeometry *geom = AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     669 </span>            : 
<span class="lineNum">     670 </span>            :   //Determine rel.position of the cell absolute ID
<span class="lineNum">     671 </span><span class="lineCov">      43008 :   Int_t relId[4];</span>
<span class="lineNum">     672 </span><span class="lineCov">      43008 :   geom-&gt;AbsToRelNumbering(digit-&gt;GetId(),relId);</span>
<span class="lineNum">     673 </span><span class="lineCov">      43008 :   Int_t module=relId[0];</span>
<span class="lineNum">     674 </span><span class="lineCov">      43008 :   Int_t row   =relId[2];</span>
<span class="lineNum">     675 </span><span class="lineCov">      43008 :   Int_t column=relId[3];</span>
<span class="lineNum">     676 </span><span class="lineCov">      43008 :   if(relId[1]==0){ //This Is EMC</span>
<span class="lineNum">     677 </span><span class="lineCov">      43008 :     Float_t decalib     = fcdb-&gt;GetADCchannelEmcDecalib(module,column,row); // O(1)</span>
<span class="lineNum">     678 </span><span class="lineCov">      43008 :     Float_t calibration = fcdb-&gt;GetADCchannelEmc(module,column,row)*decalib;</span>
<span class="lineNum">     679 </span><span class="lineCov">      43008 :     Float_t energy = digit-&gt;GetEnergy()/calibration;</span>
<span class="lineNum">     680 </span><span class="lineCov">      43008 :     digit-&gt;SetEnergy(energy); //Now digit measures E in ADC counts</span>
<span class="lineNum">     681 </span><span class="lineCov">      43008 :     Float_t time = digit-&gt;GetTime() ;</span>
<span class="lineNum">     682 </span><span class="lineCov">      43008 :     time-=fcdb-&gt;GetTimeShiftEmc(module,column,row);</span>
<span class="lineNum">     683 </span><span class="lineCov">      43008 :     digit-&gt;SetTime(time) ;</span>
<span class="lineNum">     684 </span><span class="lineCov">      43008 :   }</span>
<a name="685"><span class="lineNum">     685 </span><span class="lineCov">      43008 : }</span></a>
<span class="lineNum">     686 </span>            : //____________________________________________________________________________
<span class="lineNum">     687 </span>            : Float_t AliPHOSDigitizer::CalibrateT(Float_t time,Int_t absId){
<span class="lineNum">     688 </span>            :   //Apply time calibration
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :   const AliPHOSGeometry *geom = AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span>            :   //Determine rel.position of the cell absolute ID
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :   Int_t relId[4];</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :   geom-&gt;AbsToRelNumbering(absId,relId);</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :   Int_t module=relId[0];</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :   Int_t row   =relId[2];</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :   Int_t column=relId[3];</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :   time += fcdb-&gt;GetTimeShiftEmc(module,column,row);</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :   return time ;</span>
<a name="699"><span class="lineNum">     699 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     700 </span>            : //____________________________________________________________________________
<span class="lineNum">     701 </span>            : Int_t AliPHOSDigitizer::DigitizeCPV(Float_t charge, Int_t absId)
<span class="lineNum">     702 </span>            : {
<span class="lineNum">     703 </span>            :   // Returns digitized value of the CPV charge in a pad absId
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :   const AliPHOSGeometry *geom = AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span>            :   //Determine rel.position of the cell absId
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :   Int_t relId[4];</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :   geom-&gt;AbsToRelNumbering(absId,relId);</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :   Int_t module=relId[0];</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :   Int_t row   =relId[2];</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :   Int_t column=relId[3];</span>
<span class="lineNum">     713 </span>            :   
<span class="lineNum">     714 </span>            :   Int_t channel = 0;
<span class="lineNum">     715 </span>            :   
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :   if(absId &gt; fEmcCrystals){ //digitize CPV only</span>
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span>            :     //reading calibration data for cell absId.
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :     Float_t adcPedestalCpv = fcdb-&gt;GetADCpedestalCpv(module,column,row);</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :     Float_t adcChanelCpv   = fcdb-&gt;GetADCchannelCpv( module,column,row);</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :     channel = (Int_t) TMath::Ceil((charge - adcPedestalCpv)/adcChanelCpv) ;       </span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :     Int_t nMax = AliPHOSSimParam::GetInstance()-&gt;GetNADCcpv() ;</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :     if(channel &gt; nMax ) channel = nMax ;</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :   return channel ;</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 : }</span>
<a name="728"><span class="lineNum">     728 </span>            : </a>
<span class="lineNum">     729 </span>            : //____________________________________________________________________________
<span class="lineNum">     730 </span>            : void AliPHOSDigitizer::Digitize(Option_t *option) 
<span class="lineNum">     731 </span>            : { 
<span class="lineNum">     732 </span>            :   // Steering method to process digitization for events
<span class="lineNum">     733 </span>            :   // in the range from fFirstEvent to fLastEvent.
<span class="lineNum">     734 </span>            :   // This range is optionally set by SetEventRange().
<span class="lineNum">     735 </span>            :   // if fLastEvent=-1, then process events until the end.
<span class="lineNum">     736 </span>            :   // by default fLastEvent = fFirstEvent (process only one event)
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span><span class="lineCov">          8 :   if (!fInit) { // to prevent overwrite existing file</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Give a version name different from %s&quot;, </span>
<span class="lineNum">     740 </span>            :                   fEventFolderName.Data() )) ;
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :     return ;</span>
<span class="lineNum">     742 </span>            :   }   
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span><span class="lineCov">          4 :   if (strstr(option,&quot;print&quot;)) {</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :     Print();</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :     return ; </span>
<span class="lineNum">     747 </span>            :   }
<span class="lineNum">     748 </span>            :   
<span class="lineNum">     749 </span><span class="lineCov">          4 :  if(strstr(option,&quot;tim&quot;))</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :      gBenchmark-&gt;Start(&quot;PHOSDigitizer&quot;);</span>
<span class="lineNum">     751 </span>            :   
<span class="lineNum">     752 </span><span class="lineCov">          4 :   AliRunLoader* rl = AliRunLoader::GetRunLoader(fEventFolderName) ;</span>
<span class="lineNum">     753 </span><span class="lineCov">          4 :   AliPHOSLoader * phosLoader = static_cast&lt;AliPHOSLoader*&gt;(rl-&gt;GetLoader(&quot;PHOSLoader&quot;));</span>
<span class="lineNum">     754 </span>            :   
<span class="lineNum">     755 </span><span class="lineCov">          4 :   if (fLastEvent == -1) </span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :     fLastEvent = rl-&gt;GetNumberOfEvents() - 1 ;</span>
<span class="lineNum">     757 </span><span class="lineCov">          4 :   else if (fDigInput) </span>
<span class="lineNum">     758 </span><span class="lineCov">          4 :     fLastEvent = fFirstEvent ; </span>
<span class="lineNum">     759 </span>            :  
<span class="lineNum">     760 </span><span class="lineCov">          4 :   Int_t nEvents   = fLastEvent - fFirstEvent + 1;</span>
<span class="lineNum">     761 </span>            :   
<span class="lineNum">     762 </span>            :   Int_t ievent ;
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span><span class="lineCov">         16 :   for (ievent = fFirstEvent; ievent &lt;= fLastEvent; ievent++) {</span>
<span class="lineNum">     765 </span><span class="lineCov">          4 :     fEventCounter++ ; </span>
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span><span class="lineCov">          4 :     Digitize(ievent) ; //Add prepared SDigits to digits and add the noise</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span><span class="lineCov">          4 :     WriteDigits() ;</span>
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span><span class="lineCov">          4 :     if(strstr(option,&quot;deb&quot;))</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :       PrintDigits(option);</span>
<span class="lineNum">     773 </span>            :     
<span class="lineNum">     774 </span>            :     //increment the total number of Digits per run 
<span class="lineNum">     775 </span><span class="lineCov">          4 :     fDigitsInRun += phosLoader-&gt;Digits()-&gt;GetEntriesFast() ;  </span>
<span class="lineNum">     776 </span>            :  }
<span class="lineNum">     777 </span>            :  
<span class="lineNum">     778 </span><span class="lineCov">          4 :   if(strstr(option,&quot;tim&quot;)){</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :     gBenchmark-&gt;Stop(&quot;PHOSDigitizer&quot;);</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :     TString message ; </span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :     message = &quot;  took %f seconds for Digitizing %f seconds per event\n&quot; ; </span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :     AliInfo(Form( message.Data(), </span>
<span class="lineNum">     783 </span>            :          gBenchmark-&gt;GetCpuTime(&quot;PHOSDigitizer&quot;), 
<span class="lineNum">     784 </span>            :          gBenchmark-&gt;GetCpuTime(&quot;PHOSDigitizer&quot;)/nEvents )); 
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :   } </span>
<a name="786"><span class="lineNum">     786 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">     787 </span>            : //____________________________________________________________________________ 
<span class="lineNum">     788 </span>            : Float_t AliPHOSDigitizer::TimeResolution(Float_t e){
<span class="lineNum">     789 </span>            :   //calculate TOF resolution using beam-test resutls
<span class="lineNum">     790 </span><span class="lineCov">        248 :   Float_t a=AliPHOSSimParam::GetInstance()-&gt;GetTOFa() ;</span>
<span class="lineNum">     791 </span><span class="lineCov">        124 :   Float_t b=AliPHOSSimParam::GetInstance()-&gt;GetTOFb() ;</span>
<span class="lineNum">     792 </span><span class="lineCov">        124 :   return TMath::Sqrt(a*a+b*b/e) ;</span>
<span class="lineNum">     793 </span>            : }
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span>            : ////____________________________________________________________________________ 
<span class="lineNum">     796 </span>            : //Float_t AliPHOSDigitizer::FrontEdgeTime(TClonesArray * ticks) const
<span class="lineNum">     797 </span>            : //{
<span class="lineNum">     798 </span>            : //  // Returns the shortest time among all time ticks
<span class="lineNum">     799 </span>            : //
<span class="lineNum">     800 </span>            : //  ticks-&gt;Sort() ; //Sort in accordance with times of ticks
<span class="lineNum">     801 </span>            : //  TIter it(ticks) ;
<span class="lineNum">     802 </span>            : //  AliPHOSTick * ctick = (AliPHOSTick *) it.Next() ;
<span class="lineNum">     803 </span>            : //  Float_t time = ctick-&gt;CrossingTime(fTimeThreshold) ;    
<span class="lineNum">     804 </span>            : //
<span class="lineNum">     805 </span>            : //  AliPHOSTick * t ;  
<span class="lineNum">     806 </span>            : //  while((t=(AliPHOSTick*) it.Next())){
<span class="lineNum">     807 </span>            : //    if(t-&gt;GetTime() &lt; time)  //This tick starts before crossing
<span class="lineNum">     808 </span>            : //      *ctick+=*t ;
<span class="lineNum">     809 </span>            : //    else
<span class="lineNum">     810 </span>            : //      return time ;
<span class="lineNum">     811 </span>            : //
<span class="lineNum">     812 </span>            : //    time = ctick-&gt;CrossingTime(fTimeThreshold) ;    
<span class="lineNum">     813 </span>            : //  }
<span class="lineNum">     814 </span>            : //  return time ;
<span class="lineNum">     815 </span>            : //}
<a name="816"><span class="lineNum">     816 </span>            : </a>
<span class="lineNum">     817 </span>            : //____________________________________________________________________________ 
<span class="lineNum">     818 </span>            : Bool_t AliPHOSDigitizer::Init()
<span class="lineNum">     819 </span>            : {
<span class="lineNum">     820 </span>            :   // Makes all memory allocations
<span class="lineNum">     821 </span><span class="lineCov">          2 :   fInit = kTRUE ; </span>
<span class="lineNum">     822 </span>            : 
<span class="lineNum">     823 </span>            :   AliPHOSGeometry *geom;
<span class="lineNum">     824 </span><span class="lineCov">          1 :   if (!(geom = AliPHOSGeometry::GetInstance())) </span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :         geom = AliPHOSGeometry::GetInstance(&quot;IHEP&quot;,&quot;&quot;);</span>
<span class="lineNum">     826 </span>            : //   const AliPHOSGeometry *geom = AliPHOSGeometry::GetInstance() ;
<span class="lineNum">     827 </span>            : 
<span class="lineNum">     828 </span><span class="lineCov">          1 :   fEmcCrystals = geom-&gt;GetNModules() * geom-&gt;GetNCristalsInModule() ;</span>
<span class="lineNum">     829 </span>            :   
<span class="lineNum">     830 </span><span class="lineCov">          1 :   fFirstEvent = 0 ; </span>
<span class="lineNum">     831 </span><span class="lineCov">          1 :   fLastEvent = fFirstEvent ; </span>
<span class="lineNum">     832 </span><span class="lineCov">          1 :   if (fDigInput) </span>
<span class="lineNum">     833 </span><span class="lineCov">          1 :     fInput = fDigInput-&gt;GetNinputs() ; </span>
<span class="lineNum">     834 </span>            :   else 
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :     fInput           = 1 ;</span>
<span class="lineNum">     836 </span>            :   
<span class="lineNum">     837 </span><span class="lineCov">          5 :   fInputFileNames  = new TString[fInput] ; </span>
<span class="lineNum">     838 </span><span class="lineCov">          5 :   fEventNames      = new TString[fInput] ; </span>
<span class="lineNum">     839 </span><span class="lineCov">          1 :   fInputFileNames[0] = GetTitle() ; </span>
<span class="lineNum">     840 </span><span class="lineCov">          1 :   fEventNames[0]     = fEventFolderName.Data() ; </span>
<span class="lineNum">     841 </span>            :   Int_t index ; 
<span class="lineNum">     842 </span><span class="lineCov">          2 :   for (index = 1 ; index &lt; fInput ; index++) {</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :     fInputFileNames[index] = static_cast&lt;AliStream*&gt;(fDigInput-&gt;GetInputStream(index))-&gt;GetFileName(0); </span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :     TString tempo = fDigInput-&gt;GetInputFolderName(index) ;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :     fEventNames[index] = tempo.Remove(tempo.Length()-1) ; // strip of the stream number added by fDigInput</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     847 </span>            : 
<span class="lineNum">     848 </span>            :   //to prevent cleaning of this object while GetEvent is called
<span class="lineNum">     849 </span><span class="lineCov">          1 :   AliRunLoader* rl = AliRunLoader::GetRunLoader(fEventFolderName) ;</span>
<span class="lineNum">     850 </span><span class="lineCov">          1 :   if(!rl){</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :     AliRunLoader::Open(GetTitle(), fEventFolderName) ; </span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     853 </span><span class="lineCov">          1 :   return fInit ; </span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 : }</span>
<a name="855"><span class="lineNum">     855 </span>            : </a>
<span class="lineNum">     856 </span>            : //____________________________________________________________________________ 
<span class="lineNum">     857 </span>            : void AliPHOSDigitizer::InitParameters()
<span class="lineNum">     858 </span>            : {
<span class="lineNum">     859 </span>            :   // Set initial parameters Digitizer
<span class="lineNum">     860 </span>            : 
<span class="lineNum">     861 </span><span class="lineCov">          2 :   fDigitsInRun  = 0 ; </span>
<span class="lineNum">     862 </span><span class="lineCov">          1 :   SetEventRange(0,-1) ;</span>
<span class="lineNum">     863 </span><span class="lineCov">          2 :   fPulse = new AliPHOSPulseGenerator();</span>
<span class="lineNum">     864 </span><span class="lineCov">          1 :   fADCValuesLG = new Int_t[fPulse-&gt;GetRawFormatTimeBins()];</span>
<span class="lineNum">     865 </span><span class="lineCov">          1 :   fADCValuesHG = new Int_t[fPulse-&gt;GetRawFormatTimeBins()];</span>
<span class="lineNum">     866 </span>            :     
<span class="lineNum">     867 </span><span class="lineCov">          1 : }</span>
<a name="868"><span class="lineNum">     868 </span>            : </a>
<span class="lineNum">     869 </span>            : //__________________________________________________________________
<span class="lineNum">     870 </span>            : void AliPHOSDigitizer::Print(const Option_t *)const 
<span class="lineNum">     871 </span>            : {
<span class="lineNum">     872 </span>            :   // Print Digitizer's parameters
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :   AliInfo(Form(&quot;\n------------------- %s -------------&quot;, GetName() )) ; </span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :   if( strcmp(fEventFolderName.Data(), &quot;&quot;) != 0 ){</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :     printf(&quot; Writing Digits to branch with title  %s\n&quot;, fEventFolderName.Data()) ;</span>
<span class="lineNum">     876 </span>            :     
<span class="lineNum">     877 </span>            :     Int_t nStreams ; 
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :     if (fDigInput) </span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :       nStreams =  GetNInputStreams() ;</span>
<span class="lineNum">     880 </span>            :     else 
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :       nStreams = fInput ; </span>
<span class="lineNum">     882 </span>            :     
<span class="lineNum">     883 </span>            :     Int_t index = 0 ;  
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     for (index = 0 ; index &lt; nStreams ; index++) {  </span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :       TString tempo(fEventNames[index]) ; </span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :       tempo += index ;</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :       printf (&quot;Adding SDigits from %s \n&quot;, fInputFileNames[index].Data()) ; </span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     889 </span>            :     
<span class="lineNum">     890 </span>            :  //   printf(&quot;\nWith following parameters:\n&quot;) ;
<span class="lineNum">     891 </span>            :  //   printf(&quot;  Electronics noise in EMC (fPinNoise)    = %f GeV\n&quot;, fPinNoise ) ; 
<span class="lineNum">     892 </span>            :  //   printf(&quot;  Threshold  in EMC  (fEMCDigitThreshold) = %f GeV\n&quot;, fEMCDigitThreshold ) ;  
<span class="lineNum">     893 </span>            :  //   printf(&quot;  Noise in CPV (fCPVNoise)                = %f aux units\n&quot;, fCPVNoise ) ; 
<span class="lineNum">     894 </span>            :  //   printf(&quot;  Threshold in CPV (fCPVDigitThreshold)   = %f aux units\n&quot;,fCPVDigitThreshold ) ;  
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :     printf(&quot; ---------------------------------------------------\n&quot;) ;   </span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     897 </span>            :   else
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :     AliInfo(Form(&quot;AliPHOSDigitizer not initialized&quot; )) ;</span>
<span class="lineNum">     899 </span>            :   
<span class="lineNum">     900 </span><span class="lineNoCov">          0 : }</span>
<a name="901"><span class="lineNum">     901 </span>            : </a>
<span class="lineNum">     902 </span>            : //__________________________________________________________________
<span class="lineNum">     903 </span>            :  void AliPHOSDigitizer::PrintDigits(Option_t * option)
<span class="lineNum">     904 </span>            : {
<span class="lineNum">     905 </span>            :   // Print a table of digits
<span class="lineNum">     906 </span>            :   
<span class="lineNum">     907 </span>            : 
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :   AliRunLoader* rl = AliRunLoader::GetRunLoader(fEventFolderName) ;</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :   AliPHOSLoader * phosLoader = static_cast&lt;AliPHOSLoader*&gt;(rl-&gt;GetLoader(&quot;PHOSLoader&quot;));</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :   TClonesArray * digits = phosLoader-&gt;Digits() ; </span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :   const AliPHOSGeometry *geom = AliPHOSGeometry::GetInstance() ;</span>
<span class="lineNum">     912 </span>            :   
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :   AliInfo(Form(&quot;%d&quot;, digits-&gt;GetEntriesFast())) ; </span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :   printf(&quot;\nevent %d&quot;, gAlice-&gt;GetEvNumber()) ;</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :   printf(&quot;\n       Number of entries in Digits list %d&quot;, digits-&gt;GetEntriesFast() )  ;  </span>
<span class="lineNum">     916 </span>            : 
<span class="lineNum">     917 </span>            :  
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :   if(strstr(option,&quot;all&quot;)||strstr(option,&quot;EMC&quot;)){  </span>
<span class="lineNum">     919 </span>            :     //loop over digits
<span class="lineNum">     920 </span>            :     AliPHOSDigit * digit;
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :     printf(&quot;\nEMC digits (with primaries):\n&quot;)  ;</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :     printf(&quot;\n   Id  Amplitude    Time          Index Nprim: Primaries list \n&quot;) ;    </span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :     Int_t maxEmc = geom-&gt;GetNModules()*geom-&gt;GetNCristalsInModule() ;</span>
<span class="lineNum">     924 </span>            :     Int_t index ;
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :     for (index = 0 ; (index &lt; digits-&gt;GetEntriesFast()) &amp;&amp; </span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :            (static_cast&lt;AliPHOSDigit *&gt;(digits-&gt;At(index))-&gt;GetId() &lt;= maxEmc) ; index++) {</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :       digit = (AliPHOSDigit * )  digits-&gt;At(index) ;</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :       if(digit-&gt;GetNprimary() == 0) </span>
<span class="lineNum">     929 </span>            :         continue;
<span class="lineNum">     930 </span>            : //       printf(&quot;%6d  %8d    %6.5e %4d      %2d :&quot;,
<span class="lineNum">     931 </span>            : //            digit-&gt;GetId(), digit-&gt;GetAmp(), digit-&gt;GetTime(), digit-&gt;GetIndexInList(), digit-&gt;GetNprimary()) ;  // YVK
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :       printf(&quot;%6d  %.4f    %6.5e %4d      %2d :&quot;,</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :               digit-&gt;GetId(), digit-&gt;GetEnergy(), digit-&gt;GetTime(), digit-&gt;GetIndexInList(), digit-&gt;GetNprimary()) ;  </span>
<span class="lineNum">     934 </span>            :       Int_t iprimary;
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :       for (iprimary=0; iprimary&lt;digit-&gt;GetNprimary(); iprimary++) {</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :         printf(&quot;%d &quot;,digit-&gt;GetPrimary(iprimary+1) ) ; </span>
<span class="lineNum">     937 </span>            :       }    
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :       printf(&quot;\n&quot;) ;</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     941 </span>            :   
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :   if(strstr(option,&quot;all&quot;)||strstr(option,&quot;CPV&quot;)){</span>
<span class="lineNum">     943 </span>            :     
<span class="lineNum">     944 </span>            :     //loop over CPV digits
<span class="lineNum">     945 </span>            :     AliPHOSDigit * digit;
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :     printf(&quot;\nCPV digits (with primaries):\n&quot;)  ;</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :     printf(&quot;\n   Id  Amplitude    Time          Index Nprim: Primaries list \n&quot;) ;    </span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :     Int_t maxEmc = geom-&gt;GetNModules()*geom-&gt;GetNCristalsInModule() ;</span>
<span class="lineNum">     949 </span>            :     Int_t index ;
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :     for (index = 0 ; index &lt; digits-&gt;GetEntriesFast(); index++) {</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :       digit = (AliPHOSDigit * )  digits-&gt;At(index) ;</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :       if(digit-&gt;GetId() &gt; maxEmc){</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :         printf(&quot;%6d  %8d    %4d      %2d :&quot;,</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :                 digit-&gt;GetId(), digit-&gt;GetAmp(), digit-&gt;GetIndexInList(), digit-&gt;GetNprimary()) ;  </span>
<span class="lineNum">     955 </span>            :         Int_t iprimary;
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :         for (iprimary=0; iprimary&lt;digit-&gt;GetNprimary(); iprimary++) {</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :           printf(&quot;%d &quot;,digit-&gt;GetPrimary(iprimary+1) ) ; </span>
<span class="lineNum">     958 </span>            :         }    
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :         printf(&quot;\n&quot;) ;</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     961 </span>            :     }
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     963 </span>            : 
<span class="lineNum">     964 </span><span class="lineNoCov">          0 : }</span>
<a name="965"><span class="lineNum">     965 </span>            : </a>
<span class="lineNum">     966 </span>            : //__________________________________________________________________
<span class="lineNum">     967 </span>            : Float_t AliPHOSDigitizer::TimeOfNoise(void) const
<span class="lineNum">     968 </span>            : {  // Calculates the time signal generated by noise
<span class="lineNum">     969 </span>            :   //PH  Info(&quot;TimeOfNoise&quot;, &quot;Change me&quot;) ; 
<span class="lineNum">     970 </span><span class="lineCov">      86016 :   return gRandom-&gt;Rndm() * 1.28E-5;</span>
<span class="lineNum">     971 </span>            : }
<a name="972"><span class="lineNum">     972 </span>            : </a>
<span class="lineNum">     973 </span>            : //__________________________________________________________________
<span class="lineNum">     974 </span>            : void AliPHOSDigitizer::Unload() 
<span class="lineNum">     975 </span>            : {  
<span class="lineNum">     976 </span>            :   
<span class="lineNum">     977 </span>            :   Int_t i ; 
<span class="lineNum">     978 </span><span class="lineCov">         12 :   for(i = 1 ; i &lt; fInput ; i++){</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :     TString tempo(fEventNames[i]) ; </span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :     tempo += i ;</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :     AliRunLoader* rl = AliRunLoader::GetRunLoader(tempo) ; </span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :     AliPHOSLoader * phosLoader = static_cast&lt;AliPHOSLoader*&gt;(rl-&gt;GetLoader(&quot;PHOSLoader&quot;));</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :     phosLoader-&gt;UnloadSDigits() ; </span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     985 </span>            :   
<span class="lineNum">     986 </span><span class="lineCov">          4 :   AliRunLoader* rl = AliRunLoader::GetRunLoader(fEventFolderName) ;</span>
<span class="lineNum">     987 </span><span class="lineCov">          4 :   AliPHOSLoader * phosLoader = static_cast&lt;AliPHOSLoader*&gt;(rl-&gt;GetLoader(&quot;PHOSLoader&quot;));</span>
<span class="lineNum">     988 </span><span class="lineCov">          4 :   phosLoader-&gt;UnloadDigits() ; </span>
<span class="lineNum">     989 </span><span class="lineCov">          4 : }</span>
<a name="990"><span class="lineNum">     990 </span>            : </a>
<span class="lineNum">     991 </span>            : //____________________________________________________________________________
<span class="lineNum">     992 </span>            : void AliPHOSDigitizer::WriteDigits()
<span class="lineNum">     993 </span>            : {
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span>            :   // Makes TreeD in the output file. 
<span class="lineNum">     996 </span>            :   // Check if branch already exists: 
<span class="lineNum">     997 </span>            :   //   if yes, exit without writing: ROOT TTree does not support overwriting/updating of 
<span class="lineNum">     998 </span>            :   //      already existing branches. 
<span class="lineNum">     999 </span>            :   //   else creates branch with Digits, named &quot;PHOS&quot;, title &quot;...&quot;,
<span class="lineNum">    1000 </span>            :   //      and branch &quot;AliPHOSDigitizer&quot;, with the same title to keep all the parameters
<span class="lineNum">    1001 </span>            :   //      and names of files, from which digits are made.
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span><span class="lineCov">          8 :   AliRunLoader* rl = AliRunLoader::GetRunLoader(fEventFolderName) ;</span>
<span class="lineNum">    1004 </span><span class="lineCov">          4 :   AliPHOSLoader * phosLoader = static_cast&lt;AliPHOSLoader*&gt;(rl-&gt;GetLoader(&quot;PHOSLoader&quot;));</span>
<span class="lineNum">    1005 </span>            :  
<span class="lineNum">    1006 </span><span class="lineCov">          4 :   const TClonesArray * digits = phosLoader-&gt;Digits() ; </span>
<span class="lineNum">    1007 </span><span class="lineCov">          4 :   TTree * treeD = phosLoader-&gt;TreeD();</span>
<span class="lineNum">    1008 </span><span class="lineCov">          4 :   if(!treeD){</span>
<span class="lineNum">    1009 </span><span class="lineCov">          4 :     phosLoader-&gt;MakeTree(&quot;D&quot;);</span>
<span class="lineNum">    1010 </span><span class="lineCov">          4 :     treeD = phosLoader-&gt;TreeD();</span>
<span class="lineNum">    1011 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">    1012 </span>            :   
<span class="lineNum">    1013 </span>            :   // -- create Digits branch
<span class="lineNum">    1014 </span>            :   Int_t bufferSize = 32000 ;    
<span class="lineNum">    1015 </span><span class="lineCov">          4 :   TBranch * digitsBranch = treeD-&gt;Branch(&quot;PHOS&quot;,&quot;TClonesArray&quot;,&amp;digits,bufferSize);</span>
<span class="lineNum">    1016 </span><span class="lineCov">          4 :   digitsBranch-&gt;SetTitle(fEventFolderName);</span>
<span class="lineNum">    1017 </span><span class="lineCov">          4 :   digitsBranch-&gt;Fill() ;</span>
<span class="lineNum">    1018 </span>            :   
<span class="lineNum">    1019 </span><span class="lineCov">          4 :   phosLoader-&gt;WriteDigits(&quot;OVERWRITE&quot;);</span>
<span class="lineNum">    1020 </span>            : 
<span class="lineNum">    1021 </span><span class="lineCov">          4 :   Unload() ; </span>
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span><span class="lineCov">          4 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
