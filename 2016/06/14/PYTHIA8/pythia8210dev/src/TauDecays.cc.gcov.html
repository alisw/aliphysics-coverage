<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - PYTHIA8/pythia8210dev/src/TauDecays.cc</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">PYTHIA8/pythia8210dev/src</a> - TauDecays.cc<span style="font-size: 80%;"> (source / <a href="TauDecays.cc.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">360</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : // TauDecays.cc is a part of the PYTHIA event generator.</a>
<span class="lineNum">       2 </span>            : // Copyright (C) 2015 Philip Ilten, Torbjorn Sjostrand.
<span class="lineNum">       3 </span>            : // PYTHIA is licenced under the GNU GPL version 2, see COPYING for details.
<span class="lineNum">       4 </span>            : // Please respect the MCnet Guidelines, see GUIDELINES for details.
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : // Function definitions (not found in the header) for the TauDecays class.
<span class="lineNum">       7 </span>            : 
<span class="lineNum">       8 </span>            : #include &quot;Pythia8/TauDecays.h&quot;
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            : namespace Pythia8 {
<span class="lineNum">      11 </span>            : 
<span class="lineNum">      12 </span>            : //==========================================================================
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            : // The TauDecays class.
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : //--------------------------------------------------------------------------
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : // Constants: could be changed here if desired, but normally should not.
<span class="lineNum">      19 </span>            : // These are of technical nature, as described for each.
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : // Number of times to try a decay channel.
<span class="lineNum">      22 </span>            : const int    TauDecays::NTRYCHANNEL = 10;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : // Number of times to try a decay sampling.
<span class="lineNum">      25 </span>            : const int    TauDecays::NTRYDECAY   = 10000;
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : // These numbers are hardwired empirical parameters,
<span class="lineNum">      28 </span>            : // intended to speed up the M-generator.
<span class="lineNum">      29 </span>            : const double TauDecays::WTCORRECTION[11] = { 1., 1., 1.,
<span class="lineNum">      30 </span>            :   2., 5., 15., 60., 250., 1250., 7000., 50000. };
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : //--------------------------------------------------------------------------
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : // Initialize the TauDecays class with the necessary pointers to info,
<span class="lineNum">      35 </span>            : // particle data, random numbers, and Standard Model couplings.
<span class="lineNum">      36 </span>            : // Additionally, the necessary matrix elements are initialized with the
<a name="37"><span class="lineNum">      37 </span>            : // Standard Model couplings, and particle data pointers.</a>
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : void TauDecays::init(Info* infoPtrIn, Settings* settingsPtrIn,
<span class="lineNum">      40 </span>            :   ParticleData* particleDataPtrIn, Rndm* rndmPtrIn,
<span class="lineNum">      41 </span>            :   Couplings* couplingsPtrIn) {
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            :   // Set the pointers.
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :   infoPtr         = infoPtrIn;</span>
<span class="lineNum">      45 </span><span class="lineNoCov">          0 :   settingsPtr     = settingsPtrIn;</span>
<span class="lineNum">      46 </span><span class="lineNoCov">          0 :   particleDataPtr = particleDataPtrIn;</span>
<span class="lineNum">      47 </span><span class="lineNoCov">          0 :   rndmPtr         = rndmPtrIn;</span>
<span class="lineNum">      48 </span><span class="lineNoCov">          0 :   couplingsPtr    = couplingsPtrIn;</span>
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span>            :   // Initialize the hard matrix elements.
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :   hmeTwoFermions2W2TwoFermions</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :     .initPointers(particleDataPtr, couplingsPtr, settingsPtr);</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :   hmeTwoFermions2GammaZ2TwoFermions</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :     .initPointers(particleDataPtr, couplingsPtr, settingsPtr);</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :   hmeW2TwoFermions</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :     .initPointers(particleDataPtr, couplingsPtr, settingsPtr);</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :   hmeZ2TwoFermions</span>
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :     .initPointers(particleDataPtr, couplingsPtr, settingsPtr);</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :   hmeGamma2TwoFermions</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :     .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :   hmeHiggs2TwoFermions</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :     .initPointers(particleDataPtr, couplingsPtr, settingsPtr);</span>
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            :   // Initialize the tau decay matrix elements.
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   hmeTau2Meson                   .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :   hmeTau2TwoLeptons              .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :   hmeTau2TwoMesonsViaVector      .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :   hmeTau2TwoMesonsViaVectorScalar.initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :   hmeTau2ThreePions              .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :   hmeTau2ThreeMesonsWithKaons    .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :   hmeTau2ThreeMesonsGeneric      .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :   hmeTau2TwoPionsGamma           .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :   hmeTau2FourPions               .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :   hmeTau2FivePions               .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :   hmeTau2PhaseSpace              .initPointers(particleDataPtr, couplingsPtr);</span>
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            :   // User selected tau settings.
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :   tauExt    = settingsPtr-&gt;mode(&quot;TauDecays:externalMode&quot;);</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :   tauMode   = settingsPtr-&gt;mode(&quot;TauDecays:mode&quot;);</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :   tauMother = settingsPtr-&gt;mode(&quot;TauDecays:tauMother&quot;);</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :   tauPol    = settingsPtr-&gt;parm(&quot;TauDecays:tauPolarization&quot;);</span>
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            :   // Parameters to determine if correlated partner should decay.
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :   limitTau0     = settingsPtr-&gt;flag(&quot;ParticleDecays:limitTau0&quot;);</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :   tau0Max       = settingsPtr-&gt;parm(&quot;ParticleDecays:tau0Max&quot;);</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :   limitTau      = settingsPtr-&gt;flag(&quot;ParticleDecays:limitTau&quot;);</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :   tauMax        = settingsPtr-&gt;parm(&quot;ParticleDecays:tauMax&quot;);</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :   limitRadius   = settingsPtr-&gt;flag(&quot;ParticleDecays:limitRadius&quot;);</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :   rMax          = settingsPtr-&gt;parm(&quot;ParticleDecays:rMax&quot;);</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :   limitCylinder = settingsPtr-&gt;flag(&quot;ParticleDecays:limitCylinder&quot;);</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :   xyMax         = settingsPtr-&gt;parm(&quot;ParticleDecays:xyMax&quot;);</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :   zMax          = settingsPtr-&gt;parm(&quot;ParticleDecays:zMax&quot;);</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :   limitDecay    = limitTau0 || limitTau || limitRadius || limitCylinder;</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            : //--------------------------------------------------------------------------
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            : // Main method of the TauDecays class. Pass the index of the tau requested
<span class="lineNum">      99 </span>            : // to be decayed along with the event record in which the tau exists. The
<span class="lineNum">     100 </span>            : // tau is then decayed with proper spin correlations as well any partner.
<span class="lineNum">     101 </span>            : // The children of the decays are written to the event record, and if the
<a name="102"><span class="lineNum">     102 </span>            : // decays were succesful, a return value of true is supplied.</a>
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span>            : bool TauDecays::decay(int idxOut1, Event&amp; event) {
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :   // Set the outgoing particles of the hard process.
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :   out1                    = HelicityParticle(event[idxOut1]);</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   int         idxOut1Top  = out1.iTopCopyId();</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :   vector&lt;int&gt; sistersOut1 = event[idxOut1Top].sisterList();</span>
<span class="lineNum">     110 </span>            :   int         idxOut2Top  = idxOut1Top;
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :   if (sistersOut1.size() == 1) idxOut2Top = sistersOut1[0];</span>
<span class="lineNum">     112 </span>            :   else {
<span class="lineNum">     113 </span>            :     // If more then one sister, select by preference tau, nu_tau, lep, nu_lep.
<span class="lineNum">     114 </span>            :     int tau(-1), tnu(-1), lep(-1), lnu(-1);
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     for (int i = 0; i &lt; int(sistersOut1.size()); ++i) {</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :       int sn = out1.id() == 15 ? -1 : 1;</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :       int id = event[sistersOut1[i]].id();</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :       if      (id == sn * 15 &amp;&amp; tau == -1) tau = sistersOut1[i];</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :       else if (id == sn * 16 &amp;&amp; tnu == -1) tnu = sistersOut1[i];</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :       else if ((id == sn * 11 || (id == sn * 13)) &amp;&amp; lep == -1)</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :         lep = sistersOut1[i];</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :       else if ((id == sn * 12 || (id == sn * 14)) &amp;&amp; lnu == -1)</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :         lnu = sistersOut1[i];</span>
<span class="lineNum">     124 </span>            :     }
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     if      (tau &gt; 0) idxOut2Top = tau;</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     else if (tnu &gt; 0) idxOut2Top = tnu;</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :     else if (lep &gt; 0) idxOut2Top = lep;</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     else if (lnu &gt; 0) idxOut2Top = lnu;</span>
<span class="lineNum">     129 </span>            :   }
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :   int idxOut2 = event[idxOut2Top].iBotCopyId();</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   out2        = HelicityParticle(event[idxOut2]);</span>
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            :   // Set the mediator of the hard process.
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :   int idxMediator    = event[idxOut1Top].mother1();</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :   mediator           = HelicityParticle(event[idxMediator]);</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :   mediator.direction = -1;</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :   if (mediator.m() &lt; out1.m() + out2.m()) {</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :     Vec4 p = out1.p() + out2.p();</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :     mediator.p(p);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :     mediator.m(p.mCalc());</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span>            :   // Set the incoming particles of the hard process.
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :   int idxMediatorTop = mediator.iTopCopyId();</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :   int idxIn1         = event[event[idxMediatorTop].mother1()].iBotCopyId();</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :   int idxIn2         = event[event[idxMediatorTop].mother2()].iBotCopyId();</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :   in1                = HelicityParticle(event[idxIn1]);</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :   in1.direction      = -1;</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :   in2                = HelicityParticle(event[idxIn2]);</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :   in2.direction      = -1;</span>
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            :   // Set the particles vector.
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   particles.clear();</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   particles.push_back(in1);</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   particles.push_back(in2);</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   particles.push_back(out1);</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   particles.push_back(out2);</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            :   // Determine if correlated (allow lepton flavor violating partner).
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :   correlated = false;</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   if (idxOut1 != idxOut2 &amp;&amp;</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :       (abs(out2.id()) == 11 || abs(out2.id()) == 13 || abs(out2.id()) == 15)) {</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :     correlated = true;</span>
<span class="lineNum">     164 </span>            :     // Check partner vertex is within limits.
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     if (limitTau0 &amp;&amp; out2.tau0() &gt; tau0Max) correlated = false;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :     else if (limitTau &amp;&amp; out2.tau() &gt; tauMax) correlated = false;</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :     else if (limitRadius &amp;&amp; pow2(out2.xDec()) + pow2(out2.yDec())</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :              + pow2(out2.zDec()) &gt; pow2(rMax)) correlated = false;</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :     else if (limitCylinder &amp;&amp; (pow2(out2.xDec()) + pow2(out2.yDec())</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :                                &gt; pow2(xyMax) || abs(out2.zDec()) &gt; zMax))</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :       correlated = false;</span>
<span class="lineNum">     172 </span>            :     // Check partner can decay.
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :     else if (!out2.canDecay()) correlated = false;</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :     else if (!out2.mayDecay()) correlated = false;</span>
<span class="lineNum">     175 </span>            :   }
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span>            :   // Set the production mechanism.
<span class="lineNum">     178 </span>            :   bool known = false;
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :   hardME = 0;</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   if      (tauMode == 4) known = internalMechanism(event);</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :   else if (tauMode == 5) known = externalMechanism(event);</span>
<span class="lineNum">     182 </span>            :   else {
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :     if ((tauMode == 2 &amp;&amp; abs(mediator.id()) == tauMother) || tauMode == 3) {</span>
<span class="lineNum">     184 </span>            :       known       = true;
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :       correlated  = false;</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :       double sign = out1.id() == -15 ? -1 : 1;</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :       particles[2].rho[0][0] = (1 - sign * tauPol) / 2;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :       particles[2].rho[1][1] = (1 + sign * tauPol) / 2;</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :       if (!externalMechanism(event)) known = internalMechanism(event);</span>
<span class="lineNum">     191 </span>            :       else known = true;
<span class="lineNum">     192 </span>            :     }
<span class="lineNum">     193 </span>            :   }
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            :   // Catch unknown production mechanims.
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   if (!known) {</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :     particles[1] = mediator;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     if (abs(mediator.id()) == 22)</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :       hardME = hmeGamma2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     else if (abs(mediator.id()) == 23 || abs(mediator.id()) == 32)</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :       hardME = hmeZ2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     else if (abs(mediator.id()) == 24 || abs(mediator.id()) == 34)</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :       hardME = hmeW2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :     else if (correlated) {</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :       Vec4 p = out1.p() + out2.p();</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :       particles[1] = HelicityParticle(22, -22, idxIn1, idxIn2, idxOut1,</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :         idxOut2, 0, 0, p, p.mCalc(), 0, particleDataPtr);</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :       hardME = hmeGamma2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :       infoPtr-&gt;errorMsg(&quot;Warning in TauDecays::decay: unknown correlated &quot;</span>
<span class="lineNum">     210 </span>            :                         &quot;tau production, assuming from unpolarized photon&quot;);
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :       infoPtr-&gt;errorMsg(&quot;Warning in TauDecays::decay: unknown uncorrelated &quot;</span>
<span class="lineNum">     213 </span>            :                         &quot;tau production, assuming unpolarized&quot;);
<span class="lineNum">     214 </span>            :     }
<span class="lineNum">     215 </span>            :   }
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span>            :   // Undecay correlated partner if already decayed.
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :   if (correlated &amp;&amp; !out2.isFinal()) event[out2.index()].undoDecay();</span>
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span>            :   // Pick the first tau to decay.
<span class="lineNum">     221 </span>            :   HelicityParticle* tau;
<span class="lineNum">     222 </span>            :   int idx = 2;
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :   if (correlated) idx = (rndmPtr-&gt;flat() &lt; 0.5) ? 2 : 3;</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :   tau = &amp;particles[idx];</span>
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span>            :   // Calculate the density matrix (if needed) and select channel.
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :   if (hardME) hardME-&gt;calculateRho(idx, particles);</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   vector&lt;HelicityParticle&gt; children = createChildren(*tau);</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :   if (children.size() == 0) return false;</span>
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span>            :   // Decay the first tau.
<span class="lineNum">     232 </span>            :   bool accepted = false;
<span class="lineNum">     233 </span>            :   int  tries    = 0;
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :   while (!accepted) {</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :     isotropicDecay(children);</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     double decayWeight    = decayME-&gt;decayWeight(children);</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :     double decayWeightMax = decayME-&gt;decayWeightMax(children);</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :     accepted = (rndmPtr-&gt;flat() &lt; decayWeight / decayWeightMax);</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :     if (decayWeight &gt; decayWeightMax)</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :       infoPtr-&gt;errorMsg(&quot;Warning in TauDecays::decay: maximum &quot;</span>
<span class="lineNum">     241 </span>            :         &quot;decay weight exceeded in tau decay&quot;);
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     if (tries &gt; NTRYDECAY) {</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :       infoPtr-&gt;errorMsg(&quot;Warning in TauDecays::decay: maximum &quot;</span>
<span class="lineNum">     244 </span>            :         &quot;number of decay attempts exceeded&quot;);
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     246 </span>            :     }
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     ++tries;</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :   writeDecay(event,children);</span>
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span>            :   // If a correlated second tau exists, decay that tau as well.
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :   if (correlated) {</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :     idx = (idx == 2) ? 3 : 2;</span>
<span class="lineNum">     254 </span>            :     // Calculate the first tau decay matrix.
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :     decayME-&gt;calculateD(children);</span>
<span class="lineNum">     256 </span>            :     // Update the decay matrix for the tau.
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :     tau-&gt;D = children[0].D;</span>
<span class="lineNum">     258 </span>            :     // Switch the taus.
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :     tau = &amp;particles[idx];</span>
<span class="lineNum">     260 </span>            :     // Calculate second tau's density matrix.
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     hardME-&gt;calculateRho(idx, particles);</span>
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span>            :     // Decay the second tau.
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     children.clear();</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     children = createChildren(*tau);</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     if (children.size() == 0) return false;</span>
<span class="lineNum">     267 </span>            :     accepted = false;
<span class="lineNum">     268 </span>            :     tries    = 0;
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     while (!accepted) {</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :       isotropicDecay(children);</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :       double decayWeight    = decayME-&gt;decayWeight(children);</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :       double decayWeightMax = decayME-&gt;decayWeightMax(children);</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :       accepted = (rndmPtr-&gt;flat() &lt; decayWeight / decayWeightMax);</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :       if (decayWeight &gt; decayWeightMax)</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :         infoPtr-&gt;errorMsg(&quot;Warning in TauDecays::decay: maximum &quot;</span>
<span class="lineNum">     276 </span>            :           &quot;decay weight exceeded in correlated tau decay&quot;);
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :       if (tries &gt; NTRYDECAY) {</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         infoPtr-&gt;errorMsg(&quot;Warning in TauDecays::decay: maximum &quot;</span>
<span class="lineNum">     279 </span>            :           &quot;number of decay attempts exceeded&quot;);
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     281 </span>            :       }
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :       ++tries;</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     writeDecay(event,children);</span>
<span class="lineNum">     285 </span>            :   }
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span>            :   // Done.
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   return true;</span>
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span>            : //--------------------------------------------------------------------------
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span>            : // Determine the tau polarization and tau decay correlation using the internal
<a name="295"><span class="lineNum">     295 </span>            : // helicity matrix elements.</a>
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            : bool TauDecays::internalMechanism(Event&amp;) {
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span>            :   // Flag if process is known.
<span class="lineNum">     300 </span>            :   bool known = true;
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span>            :   // Produced from a photon, Z, or Z'.
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :   if (abs(mediator.id()) == 22 || abs(mediator.id()) == 23 ||</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :       abs(mediator.id()) == 32) {</span>
<span class="lineNum">     305 </span>            :     // Produced from fermions: s-channel.
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     if (abs(in1.id()) &lt;= 18 &amp;&amp; abs(in2.id()) &lt;= 18) {</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :       particles.push_back(mediator);</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :       hardME = hmeTwoFermions2GammaZ2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     309 </span>            :     // Unknown photon production.
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :     } else known = false;</span>
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            :   // Produced from a W or W'.
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   } else if (abs(mediator.id()) == 24 || abs(mediator.id()) == 34) {</span>
<span class="lineNum">     314 </span>            :     // Produced from fermions: s-channel.
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     if (abs(in1.id()) &lt;= 18 &amp;&amp; abs(in2.id()) &lt;= 18) {</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :       particles.push_back(mediator);</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :       hardME = hmeTwoFermions2W2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     318 </span>            :     // Unknown W production.
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     } else known = false;</span>
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span>            :   // Produced from a Higgs.
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :   } else if (abs(mediator.id()) == 25 || abs(mediator.id()) == 35 ||</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :              abs(mediator.id()) == 36 || abs(mediator.id()) == 37) {</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :     particles[1] = mediator;</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     hardME = hmeHiggs2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span>            :   // Produced from a D or B hadron decay with a single tau.
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :   } else if ((abs(mediator.id()) == 411 || abs(mediator.id()) == 431</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :               || abs(mediator.id()) == 511 || abs(mediator.id()) == 521</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :               || abs(mediator.id()) == 531 || abs(mediator.id()) == 541</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :               || (abs(mediator.id()) &gt; 5100 &amp;&amp; abs(mediator.id()) &lt; 5600) )</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :              &amp;&amp; abs(out2.id()) == 16) {</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     int idBmother = (mediator.id() &gt; 0) ? -5 : 5;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     if (abs(mediator.id()) &gt; 5100) idBmother = -idBmother;</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     particles[0] = HelicityParticle(  idBmother, 0, 0, 0, 0, 0, 0, 0,</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :                                       0., 0., 0., 0., 0., 0., particleDataPtr);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :     particles[1] = HelicityParticle( -idBmother, 0, 0, 0, 0, 0, 0, 0,</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                                      0., 0., 0., 0., 0., 0., particleDataPtr);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     particles[0].index(-1);</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     particles[1].index(-1);</span>
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span>            :     // D or B meson decays into neutrino + tau + meson.
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :     if (mediator.daughter1() + 2 == mediator.daughter2()) {</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :       particles[0].p(mediator.p());</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :       particles[1].direction = 1;</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :       particles[1].id(-particles[1].id());</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :       particles[1].p(particles[0].p() - particles[2].p() - particles[3].p());</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span>            :     // D or B meson decays into neutrino + tau.
<span class="lineNum">     351 </span>            :     else {
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :       particles[0].p(mediator.p()/2);</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :       particles[1].p(mediator.p()/2);</span>
<span class="lineNum">     354 </span>            :     }
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     hardME = hmeTwoFermions2W2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span>            :   // Unknown production.
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   } else known = false;</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :   return known;</span>
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span>            : //--------------------------------------------------------------------------
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span>            : // Determine the tau polarization and tau decay correlation using the provided
<a name="366"><span class="lineNum">     366 </span>            : // SPINUP digits.</a>
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span>            : bool TauDecays::externalMechanism(Event &amp;event) {
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span>            :   // Flag if process is known.
<span class="lineNum">     371 </span>            :   bool known = true;
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span>            :   // Uncorrelated, take directly from SPINUP if valid.
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :   if (tauExt == 0) correlated = false;</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :   if (!correlated) {</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     double spinup = particles[2].pol();</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     if (abs(spinup) &gt; 1.001) spinup = event[particles[2].iTopCopyId()].pol();</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :     if (abs(spinup) &gt; 1.001) known = false;</span>
<span class="lineNum">     379 </span>            :     else {
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :       particles[2].rho[0][0] = (1 - spinup) / 2;</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :       particles[2].rho[1][1] = (1 + spinup) / 2;</span>
<span class="lineNum">     382 </span>            :     }
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span>            :   // Correlated, try mother.
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :   } else if (tauExt == 1) {</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     double spinup = mediator.pol();</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     if (abs(spinup) &gt; 1.001) spinup = event[mediator.iTopCopyId()].pol();</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :     if (abs(spinup) &gt; 1.001) spinup = 0;</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :     if (mediator.rho.size() &gt; 1) {</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :       mediator.rho[0][0] = (1 - spinup) / mediator.spinStates();</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :       mediator.rho[1][1] = (1 + spinup) / mediator.spinStates();</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     particles[1] = mediator;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     if (abs(mediator.id()) == 22)</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :       hardME = hmeGamma2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :     else if (abs(mediator.id()) == 23 || abs(mediator.id()) == 32)</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :       hardME = hmeZ2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     else if (abs(mediator.id()) == 24 || abs(mediator.id()) == 34)</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :       hardME = hmeZ2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :     else if (abs(mediator.id()) == 25 || abs(mediator.id()) == 35 ||</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :              abs(mediator.id()) == 36 || abs(mediator.id()) == 37)</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :       hardME = hmeHiggs2TwoFermions.initChannel(particles);</span>
<span class="lineNum">     403 </span>            :     else known = false;
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span>            :     // Unknown mechanism.
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :   } else known = false;</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :   return known;</span>
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span>            : }
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span>            : //--------------------------------------------------------------------------
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span>            : // Given a HelicityParticle parent, select the decay channel and return
<span class="lineNum">     414 </span>            : // a vector of HelicityParticles containing the children, with the parent
<a name="415"><span class="lineNum">     415 </span>            : // particle duplicated in the first entry of the vector.</a>
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span>            : vector&lt;HelicityParticle&gt; TauDecays::createChildren(HelicityParticle parent) {
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span>            :   // Initial values.
<span class="lineNum">     420 </span>            :   int meMode = 0;
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :   vector&lt;HelicityParticle&gt; children;</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span>            :   // Set the parent as incoming.
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :   parent.direction = -1;</span>
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span>            :   // Setup decay data for the decaying particle.
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :   ParticleDataEntry decayData = parent.particleDataEntry();</span>
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span>            :   // Initialize the decay data.
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :   if (!decayData.preparePick(parent.id())) return children;</span>
<span class="lineNum">     431 </span>            : 
<span class="lineNum">     432 </span>            :   // Try to pick a decay channel.
<span class="lineNum">     433 </span>            :   bool decayed = false;
<span class="lineNum">     434 </span>            :   int decayTries = 0;
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :   while (!decayed &amp;&amp; decayTries &lt; NTRYCHANNEL) {</span>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span>            :     // Pick a decay channel.
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :     DecayChannel decayChannel = decayData.pickChannel();</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :     meMode = decayChannel.meMode();</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :     int decayMult = decayChannel.multiplicity();</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span>            :     // Select children masses.
<span class="lineNum">     443 </span>            :     bool allowed = false;
<span class="lineNum">     444 </span>            :     int channelTries = 0;
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :     while (!allowed &amp;&amp; channelTries &lt; NTRYCHANNEL) {</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :       children.resize(0);</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :       children.push_back(parent);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :       for (int i = 0; i &lt; decayMult; ++i) {</span>
<span class="lineNum">     449 </span>            :         // Grab child ID.
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :         int childId = decayChannel.product(i);</span>
<span class="lineNum">     451 </span>            :         // Flip sign for anti-particle decay.
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :         if (parent.id() &lt; 0 &amp;&amp; particleDataPtr-&gt;hasAnti(childId))</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :           childId = -childId;</span>
<span class="lineNum">     454 </span>            :         // Grab child mass.
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :         double childMass = particleDataPtr-&gt;mSel(childId);</span>
<span class="lineNum">     456 </span>            :         // Push back the child into the children vector.
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :         children.push_back( HelicityParticle(childId, 91, parent.index(), 0, 0,</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :           0, 0, 0, 0., 0., 0., 0.,childMass, 0., particleDataPtr) );</span>
<span class="lineNum">     459 </span>            :       }
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span>            :       // Check there is enough phase space for decay.
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :       if (decayMult &gt; 1) {</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :         double massDiff = parent.m();</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :         for (int i = 0; i &lt; decayMult; ++i) massDiff -= children[i].m();</span>
<span class="lineNum">     465 </span>            :         // For now we just check kinematically available.
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :         if (massDiff &gt; 0) {</span>
<span class="lineNum">     467 </span>            :           allowed = true;
<span class="lineNum">     468 </span>            :           decayed = true;
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            :       // End pick a channel.
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :       ++channelTries;</span>
<span class="lineNum">     474 </span>            :     }
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :     ++decayTries;</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span>            :   // Swap the children ordering for muons.
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :   if (parent.idAbs() == 13 &amp;&amp; children.size() == 4 &amp;&amp; meMode == 22)</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :     swap(children[1], children[3]);</span>
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span>            :   // Set the decay matrix element.
<span class="lineNum">     483 </span>            :   // Two body decays.
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :   if (children.size() == 3) {</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :     if (meMode == 1521)</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :       decayME = hmeTau2Meson.initChannel(children);</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :     else decayME = hmeTau2PhaseSpace.initChannel(children);</span>
<span class="lineNum">     488 </span>            :   }
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span>            :   // Three body decays.
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :   else if (children.size() == 4) {</span>
<span class="lineNum">     492 </span>            :     // Leptonic decay.
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :     if (meMode == 1531 || (parent.idAbs() == 13 &amp;&amp; meMode == 22))</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :       decayME = hmeTau2TwoLeptons.initChannel(children);</span>
<span class="lineNum">     495 </span>            :     // Two meson decay via vector meson.
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :     else if (meMode == 1532)</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :       decayME = hmeTau2TwoMesonsViaVector.initChannel(children);</span>
<span class="lineNum">     498 </span>            :     // Two meson decay via vector or scalar meson.
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :     else if (meMode == 1533)</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :       decayME = hmeTau2TwoMesonsViaVectorScalar.initChannel(children);</span>
<span class="lineNum">     501 </span>            :     // Flat phase space.
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :     else decayME = hmeTau2PhaseSpace.initChannel(children);</span>
<span class="lineNum">     503 </span>            :   }
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span>            :   // Four body decays.
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :   else if (children.size() == 5) {</span>
<span class="lineNum">     507 </span>            :     // Three pion CLEO decay.
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :     if (meMode == 1541)</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :       decayME = hmeTau2ThreePions.initChannel(children);</span>
<span class="lineNum">     510 </span>            :     // Three meson decay with one or more kaons decay.
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     else if (meMode == 1542)</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :       decayME = hmeTau2ThreeMesonsWithKaons.initChannel(children);</span>
<span class="lineNum">     513 </span>            :     // Generic three meson decay.
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     else if (meMode == 1543)</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :       decayME = hmeTau2ThreeMesonsGeneric.initChannel(children);</span>
<span class="lineNum">     516 </span>            :     // Two pions and photon decay.
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :     else if (meMode == 1544)</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :       decayME = hmeTau2TwoPionsGamma.initChannel(children);</span>
<span class="lineNum">     519 </span>            :     // Flat phase space.
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     else decayME = hmeTau2PhaseSpace.initChannel(children);</span>
<span class="lineNum">     521 </span>            :   }
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :   // Five body decays.
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :   else if (children.size() == 6) {</span>
<span class="lineNum">     525 </span>            :     // Four pion Novosibirsk current.
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :     if (meMode == 1551)</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :       decayME = hmeTau2FourPions.initChannel(children);</span>
<span class="lineNum">     528 </span>            :     // Flat phase space.
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :     else decayME = hmeTau2PhaseSpace.initChannel(children);</span>
<span class="lineNum">     530 </span>            :   }
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span>            :   // Six body decays.
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :   else if (children.size() == 7) {</span>
<span class="lineNum">     534 </span>            :     // Four pion Novosibirsk current.
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :     if (meMode == 1561)</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :       decayME = hmeTau2FivePions.initChannel(children);</span>
<span class="lineNum">     537 </span>            :     // Flat phase space.
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :     else decayME = hmeTau2PhaseSpace.initChannel(children);</span>
<span class="lineNum">     539 </span>            :   }
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span>            :   // Flat phase space.
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :   else decayME = hmeTau2PhaseSpace.initChannel(children);</span>
<span class="lineNum">     543 </span>            : 
<span class="lineNum">     544 </span>            :   // Done.
<span class="lineNum">     545 </span>            :   return children;
<span class="lineNum">     546 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span>            : //--------------------------------------------------------------------------
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span>            : // N-body decay using the M-generator algorithm described in
<span class="lineNum">     551 </span>            : // &quot;Monte Carlo Phase Space&quot; by F. James in CERN 68-15, May 1968. Taken
<span class="lineNum">     552 </span>            : // from ParticleDecays::mGenerator but modified to handle spin particles.
<span class="lineNum">     553 </span>            : // Given a vector of HelicityParticles where the first particle is
<a name="554"><span class="lineNum">     554 </span>            : // the mother, the remaining particles are decayed isotropically.</a>
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span>            : void TauDecays::isotropicDecay(vector&lt;HelicityParticle&gt;&amp; children) {
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span>            :   // Mother and sum daughter masses.
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :   int decayMult = children.size() - 1;</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :   double m0      = children[0].m();</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :   double mSum    = children[1].m();</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :   for (int i = 2; i &lt;= decayMult; ++i) mSum += children[i].m();</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :   double mDiff   = m0 - mSum;</span>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span>            :   // Begin setup of intermediate invariant masses.
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :   vector&lt;double&gt; mInv;</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt;= decayMult; ++i) mInv.push_back( children[i].m());</span>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span>            :   // Calculate the maximum weight in the decay.
<span class="lineNum">     570 </span>            :   double wtPS;
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :   double wtPSmax = 1. / WTCORRECTION[decayMult];</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :   double mMax    = mDiff + children[decayMult].m();</span>
<span class="lineNum">     573 </span>            :   double mMin    = 0.;
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :   for (int i = decayMult - 1; i &gt; 0; --i) {</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :     mMax        += children[i].m();</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :     mMin        += children[i+1].m();</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :     double mNow  = children[i].m();</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :     wtPSmax     *= 0.5 * sqrtpos( (mMax - mMin - mNow) * (mMax + mMin + mNow)</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :                  * (mMax + mMin - mNow) * (mMax - mMin + mNow) ) / mMax;</span>
<span class="lineNum">     580 </span>            :   }
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span>            :   // Begin loop to find the set of intermediate invariant masses.
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :   vector&lt;double&gt; rndmOrd;</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">     585 </span>            :     wtPS  = 1.;
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            :     // Find and order random numbers in descending order.
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :     rndmOrd.clear();</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :     rndmOrd.push_back(1.);</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :     for (int i = 1; i &lt; decayMult - 1; ++i) {</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :       double random = rndmPtr-&gt;flat();</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :       rndmOrd.push_back(random);</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :       for (int j = i - 1; j &gt; 0; --j) {</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :         if (random &gt; rndmOrd[j]) swap( rndmOrd[j], rndmOrd[j+1] );</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         else break;</span>
<span class="lineNum">     596 </span>            :       }
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :     rndmOrd.push_back(0.);</span>
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span>            :     // Translate into intermediate masses and find weight.
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :     for (int i = decayMult - 1; i &gt; 0; --i) {</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :       mInv[i] = mInv[i+1] + children[i].m()</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :               + (rndmOrd[i-1] - rndmOrd[i]) * mDiff;</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :       wtPS   *= 0.5 * sqrtpos( (mInv[i] - mInv[i+1] - children[i].m())</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :               * (mInv[i] + mInv[i+1] + children[i].m())</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :               * (mInv[i] + mInv[i+1] - children[i].m())</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :               * (mInv[i] - mInv[i+1] + children[i].m()) ) / mInv[i];</span>
<span class="lineNum">     608 </span>            :     }
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span>            :     // If rejected, try again with new invariant masses.
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :   } while ( wtPS &lt; rndmPtr-&gt;flat() * wtPSmax );</span>
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span>            :   // Perform two-particle decays in the respective rest frame.
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :   vector&lt;Vec4&gt; pInv(decayMult + 1);</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :   for (int i = 1; i &lt; decayMult; ++i) {</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :     double pAbs = 0.5 * sqrtpos( (mInv[i] - mInv[i+1] - children[i].m())</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :                 * (mInv[i] + mInv[i+1] + children[i].m())</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :                 * (mInv[i] + mInv[i+1] - children[i].m())</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :                 * (mInv[i] - mInv[i+1] + children[i].m()) ) / mInv[i];</span>
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span>            :     // Isotropic angles give three-momentum.
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :     double cosTheta = 2. * rndmPtr-&gt;flat() - 1.;</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :     double sinTheta = sqrt(1. - cosTheta*cosTheta);</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :     double phi      = 2. * M_PI * rndmPtr-&gt;flat();</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :     double pX       = pAbs * sinTheta * cos(phi);</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :     double pY       = pAbs * sinTheta * sin(phi);</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :     double pZ       = pAbs * cosTheta;</span>
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span>            :     // Calculate energies, fill four-momenta.
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :     double eHad     = sqrt( children[i].m()*children[i].m() + pAbs*pAbs);</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :     double eInv     = sqrt( mInv[i+1]*mInv[i+1] + pAbs*pAbs);</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :     children[i].p( pX, pY, pZ, eHad);</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :     pInv[i+1].p( -pX, -pY, -pZ, eInv);</span>
<span class="lineNum">     634 </span>            :   }
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span>            :   // Boost decay products to the mother rest frame.
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :   children[decayMult].p( pInv[decayMult] );</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :   for (int iFrame = decayMult - 1; iFrame &gt; 1; --iFrame)</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :     for (int i = iFrame; i &lt;= decayMult; ++i)</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :       children[i].bst( pInv[iFrame], mInv[iFrame]);</span>
<span class="lineNum">     641 </span>            : 
<span class="lineNum">     642 </span>            :   // Boost decay products to the current frame.
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :   pInv[1].p( children[0].p() );</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :   for (int i = 1; i &lt;= decayMult; ++i) children[i].bst( pInv[1], mInv[1] );</span>
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span>            :   // Done.
<span class="lineNum">     647 </span>            :   return;
<span class="lineNum">     648 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     649 </span>            : 
<span class="lineNum">     650 </span>            : //--------------------------------------------------------------------------
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span>            : // Write the vector of HelicityParticles to the event record, excluding the
<span class="lineNum">     653 </span>            : // first particle. Set the lifetime and production vertex of the particles
<a name="654"><span class="lineNum">     654 </span>            : // and mark the first particle of the vector as decayed.</a>
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span>            : void TauDecays::writeDecay(Event&amp; event, vector&lt;HelicityParticle&gt;&amp; children) {
<span class="lineNum">     657 </span>            : 
<span class="lineNum">     658 </span>            :   // Set additional information and append children to event.
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :   int  decayMult   = children.size() - 1;</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :   Vec4 decayVertex = children[0].vDec();</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :   for (int i = 1; i &lt;= decayMult; i++) {</span>
<span class="lineNum">     662 </span>            :     // Set child lifetime.
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :     children[i].tau(children[i].tau0() * rndmPtr-&gt;exp());</span>
<span class="lineNum">     664 </span>            :     // Set child production vertex.
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :     children[i].vProd(decayVertex);</span>
<span class="lineNum">     666 </span>            :     // Append child to record.
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :     children[i].index(event.append(children[i]));</span>
<span class="lineNum">     668 </span>            :   }
<span class="lineNum">     669 </span>            : 
<span class="lineNum">     670 </span>            :   // Mark the parent as decayed and set children.
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :   event[children[0].index()].statusNeg();</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :   event[children[0].index()].daughters(children[1].index(),</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :     children[decayMult].index());</span>
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span>            : //==========================================================================
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span>            : } // end namespace Pythia8
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
