<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - FMD/FMDbase/AliFMDDetector.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">FMD/FMDbase</a> - AliFMDDetector.cxx<span style="font-size: 80%;"> (source / <a href="AliFMDDetector.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">163</td>
            <td class="headerCovTableEntry">296</td>
            <td class="headerCovTableEntryLo">55.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">9</td>
            <td class="headerCovTableEntry">15</td>
            <td class="headerCovTableEntryLo">60.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 2004, ALICE Experiment at CERN, All rights reserved.      *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : /* $Id$ */
<span class="lineNum">      16 </span>            : /** @file    AliFMDDetector.cxx
<span class="lineNum">      17 </span>            :     @author  Christian Holm Christensen &lt;cholm@nbi.dk&gt;
<span class="lineNum">      18 </span>            :     @date    Mon Mar 27 12:36:27 2006
<span class="lineNum">      19 </span>            :     @brief   Sub-detector base class implementation
<span class="lineNum">      20 </span>            :     @ingroup FMD_base
<span class="lineNum">      21 </span>            : */
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span>            : //____________________________________________________________________
<span class="lineNum">      24 </span>            : //
<span class="lineNum">      25 </span>            : // AliFMDDetector.   
<span class="lineNum">      26 </span>            : //
<span class="lineNum">      27 </span>            : // Base class for concrete FMD detectors, like AliFMD1, AliFMD2,
<span class="lineNum">      28 </span>            : // AliFMD3. 
<span class="lineNum">      29 </span>            : // Utility class to help implement the FMD geometry.  This provides
<span class="lineNum">      30 </span>            : // the interface for the concrete geometry implementations of the FMD
<span class="lineNum">      31 </span>            : // sub-detectors. 
<span class="lineNum">      32 </span>            : //
<span class="lineNum">      33 </span>            : // The AliFMDGeometry object owns the AliFMDDetector objects
<span class="lineNum">      34 </span>            : //
<span class="lineNum">      35 </span>            : // Latest changes by Christian Holm Christensen
<span class="lineNum">      36 </span>            : //
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : #include &lt;TGeoManager.h&gt;  // ROOT_TGeoManager 
<span class="lineNum">      39 </span>            : #include &lt;TGeoPhysicalNode.h&gt;   // ROOT_TGeoPhysicalNode
<span class="lineNum">      40 </span>            : #include &lt;TGeoMatrix.h&gt;           // ROOT_TGeoMatrix 
<span class="lineNum">      41 </span>            : #include &lt;TMath.h&gt;              // ROOT_TMath
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : #include &quot;AliFMDDetector.h&quot;   // ALIFMDSUBDETECTOR_H
<span class="lineNum">      44 </span>            : #include &quot;AliFMDRing.h&quot;               // ALIFMDRING_H
<span class="lineNum">      45 </span>            : #include &quot;AliFMDDebug.h&quot;              // ALIFMDDEBUG_H ALILOG_H
<a name="46"><span class="lineNum">      46 </span>            : </a>
<span class="lineNum">      47 </span>            : //====================================================================
<span class="lineNum">      48 </span><span class="lineCov">         12 : ClassImp(AliFMDDetector)</span>
<span class="lineNum">      49 </span>            : #if 0
<span class="lineNum">      50 </span>            :   ; // This is here to keep Emacs for indenting the next line
<span class="lineNum">      51 </span>            : #endif
<a name="52"><span class="lineNum">      52 </span>            : </a>
<span class="lineNum">      53 </span>            : //____________________________________________________________________
<span class="lineNum">      54 </span>            : AliFMDDetector::AliFMDDetector(Int_t id, AliFMDRing* inner, AliFMDRing* outer) 
<span class="lineNum">      55 </span><span class="lineCov">          9 :   : TNamed(Form(&quot;FMD%d&quot;, id), &quot;Forward multiplicity ring&quot;), </span>
<span class="lineNum">      56 </span><span class="lineCov">          9 :     fId(id), </span>
<span class="lineNum">      57 </span><span class="lineCov">          9 :     fInnerZ(0.),</span>
<span class="lineNum">      58 </span><span class="lineCov">          9 :     fOuterZ(0.),</span>
<span class="lineNum">      59 </span><span class="lineCov">          9 :     fInnerHoneyLowR(0.),</span>
<span class="lineNum">      60 </span><span class="lineCov">          9 :     fInnerHoneyHighR(0.),</span>
<span class="lineNum">      61 </span><span class="lineCov">          9 :     fOuterHoneyLowR(0.),</span>
<span class="lineNum">      62 </span><span class="lineCov">          9 :     fOuterHoneyHighR(0.),</span>
<span class="lineNum">      63 </span><span class="lineCov">          9 :     fInner(inner),</span>
<span class="lineNum">      64 </span><span class="lineCov">          9 :     fOuter(outer), </span>
<span class="lineNum">      65 </span><span class="lineCov">          9 :     fInnerTransforms(0),</span>
<span class="lineNum">      66 </span><span class="lineCov">          9 :     fOuterTransforms(0)</span>
<span class="lineNum">      67 </span><span class="lineCov">         27 : {</span>
<span class="lineNum">      68 </span>            :   // Constructor
<span class="lineNum">      69 </span>            :   // 
<span class="lineNum">      70 </span>            :   //   ID         Id of detector (1,2, or 3)
<span class="lineNum">      71 </span>            :   //   INNER      Inner ring geometry 
<span class="lineNum">      72 </span>            :   //   OUTER      Outer ring geometry (if any)
<span class="lineNum">      73 </span>            :   // 
<span class="lineNum">      74 </span><span class="lineCov">          9 :   SetInnerHoneyLowR(0);</span>
<span class="lineNum">      75 </span><span class="lineCov">          9 :   SetInnerHoneyHighR(0);</span>
<span class="lineNum">      76 </span><span class="lineCov">          9 :   SetInnerZ(0);</span>
<span class="lineNum">      77 </span><span class="lineCov">          9 :   SetOuterZ(0);</span>
<span class="lineNum">      78 </span><span class="lineCov">          9 :   SetOuterHoneyLowR(0);</span>
<span class="lineNum">      79 </span><span class="lineCov">          9 :   SetOuterHoneyHighR(0);</span>
<span class="lineNum">      80 </span><span class="lineCov">          9 : }</span>
<a name="81"><span class="lineNum">      81 </span>            : </a>
<span class="lineNum">      82 </span>            : //____________________________________________________________________
<span class="lineNum">      83 </span>            : AliFMDDetector::AliFMDDetector(const AliFMDDetector&amp; other)
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :   : TNamed(other), </span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :     fId(other.fId),</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :     fInnerZ(0.),</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :     fOuterZ(0.),</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :     fInnerHoneyLowR(0.),</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :     fInnerHoneyHighR(0.),</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :     fOuterHoneyLowR(0.),</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :     fOuterHoneyHighR(0.),</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :     fInner(other.fInner),</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :     fOuter(other.fOuter),</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :     fInnerTransforms(other.fInnerTransforms),</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :     fOuterTransforms(other.fOuterTransforms)</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      97 </span>            :   // Copy constructor 
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   SetInnerHoneyLowR(other.GetInnerHoneyLowR());</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :   SetInnerHoneyHighR(other.GetInnerHoneyHighR());</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   SetInnerZ(other.GetInnerZ());</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :   SetOuterZ(other.GetOuterZ());</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :   SetOuterHoneyLowR(other.GetOuterHoneyLowR());</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :   SetOuterHoneyHighR(other.GetOuterHoneyHighR());</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     105 </span>            : 
<a name="106"><span class="lineNum">     106 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     107 </span>            : AliFMDDetector&amp;
<span class="lineNum">     108 </span>            : AliFMDDetector::operator=(const AliFMDDetector&amp; other)
<span class="lineNum">     109 </span>            : {
<span class="lineNum">     110 </span>            :   // Assignment operator
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :   if (&amp;other == this) return *this; </span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :   SetName(other.GetName());</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :   SetTitle(other.GetTitle());</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :   fId              = other.fId;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :   fInner           = other.fInner;</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :   fOuter           = other.fOuter;</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :   fInnerTransforms = other.fInnerTransforms;</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :   fOuterTransforms = other.fOuterTransforms;</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :   SetInnerHoneyLowR(other.GetInnerHoneyLowR());</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :   SetInnerHoneyHighR(other.GetInnerHoneyHighR());</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :   SetInnerZ(other.GetInnerZ());</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :   SetOuterZ(other.GetOuterZ());</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :   SetOuterHoneyLowR(other.GetOuterHoneyLowR());</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   SetOuterHoneyHighR(other.GetOuterHoneyHighR());</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :   return *this;</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     127 </span>            : 
<a name="128"><span class="lineNum">     128 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     129 </span>            : void
<span class="lineNum">     130 </span>            : AliFMDDetector::Init()
<span class="lineNum">     131 </span>            : {
<span class="lineNum">     132 </span>            :   // Initialize. 
<span class="lineNum">     133 </span><span class="lineCov">         66 :   if (fInner) {</span>
<span class="lineNum">     134 </span><span class="lineCov">         33 :     SetInnerHoneyLowR(fInner-&gt;GetLowR() + 1.);</span>
<span class="lineNum">     135 </span><span class="lineCov">         33 :     SetInnerHoneyHighR(fInner-&gt;GetHighR() + 1.);</span>
<span class="lineNum">     136 </span><span class="lineCov">         33 :   }</span>
<span class="lineNum">     137 </span><span class="lineCov">         33 :   if (fOuter) {</span>
<span class="lineNum">     138 </span><span class="lineCov">         22 :     SetOuterHoneyLowR(fOuter-&gt;GetLowR() + 1.);</span>
<span class="lineNum">     139 </span><span class="lineCov">         22 :     SetOuterHoneyHighR(fOuter-&gt;GetHighR() + 1.);</span>
<span class="lineNum">     140 </span><span class="lineCov">         22 :   }  </span>
<span class="lineNum">     141 </span><span class="lineCov">         33 : }</span>
<span class="lineNum">     142 </span>            : 
<a name="143"><span class="lineNum">     143 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     144 </span>            : Bool_t
<span class="lineNum">     145 </span>            : AliFMDDetector::HasAllTransforms(Char_t ring) const
<span class="lineNum">     146 </span>            : {
<span class="lineNum">     147 </span>            :   // Check if we got all transformations for a given ring.  Return
<span class="lineNum">     148 </span>            :   // true in that case. 
<span class="lineNum">     149 </span><span class="lineCov">         24 :   AliFMDRing* r = GetRing(ring);</span>
<span class="lineNum">     150 </span><span class="lineCov">         14 :   if (!r) return kTRUE;</span>
<span class="lineNum">     151 </span><span class="lineCov">         30 :   TObjArray* matricies = (r == fInner ? fInnerTransforms : fOuterTransforms);</span>
<span class="lineNum">     152 </span><span class="lineCov">         10 :   if (!matricies) return kTRUE;</span>
<span class="lineNum">     153 </span><span class="lineCov">         20 :   if (matricies-&gt;GetEntries() == r-&gt;GetNModules()) return kTRUE;</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   return kFALSE;</span>
<span class="lineNum">     155 </span><span class="lineCov">         12 : }</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span>            : #define IS_NODE_THIS(name) \
<span class="lineNum">     158 </span>            :   (name[0] == 'F' &amp;&amp; name[2] == 'M' &amp;&amp; name[1] == Char_t(48+fId) &amp;&amp; \
<span class="lineNum">     159 </span>            :    (name[3] == 'T' || name[3] == 'B'))
<span class="lineNum">     160 </span>            : #define IS_NODE_SENSOR(name)                            \
<span class="lineNum">     161 </span>            :   (name[0] == 'F' &amp;&amp; (name[2] == 'B' || name[2] == 'F') &amp;&amp; name[3] == 'H')
<span class="lineNum">     162 </span>            : //#define IS_NODE_SENSOR(name)                          
<span class="lineNum">     163 </span>            : //  (name[0] == 'F' &amp;&amp; name[2] == 'S' &amp;&amp; name[3] == 'E')
<span class="lineNum">     164 </span>            : #define IS_NODE_HALF(name) \
<span class="lineNum">     165 </span>            :   (name[0] == 'F' &amp;&amp; name[2] == 'M' &amp;&amp; (name[3] == 'B' || name[3] == 'T'))
<span class="lineNum">     166 </span>            : #define HALF_FORMAT   &quot;FMD/FMD%d_%c&quot;
<span class="lineNum">     167 </span>            : #define SENSOR_FORMAT &quot;FMD/FMD%d_%c/FMD%c_%02d&quot;
<span class="lineNum">     168 </span>            : 
<a name="169"><span class="lineNum">     169 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     170 </span>            : void
<span class="lineNum">     171 </span>            : AliFMDDetector::InitTransformations()
<span class="lineNum">     172 </span>            : {
<span class="lineNum">     173 </span>            :   // Find all local&lt;-&gt;global transformations for this detector. 
<span class="lineNum">     174 </span><span class="lineCov">         24 :   if ((!fInner || (fInner &amp;&amp; fInnerTransforms)) &amp;&amp; </span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :       (!fOuter || (fOuter &amp;&amp; fOuterTransforms))) {</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     AliFMDDebug(5, (&quot;Transforms for FMD%d already registered&quot;, fId));</span>
<span class="lineNum">     177 </span>            :     return;
<span class="lineNum">     178 </span>            :   }
<span class="lineNum">     179 </span><span class="lineCov">         12 :   AliFMDDebug(5, (&quot;Initializing transforms for FMD%d&quot;, fId));</span>
<span class="lineNum">     180 </span><span class="lineCov">          6 :   if (!gGeoManager) {</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     AliFatal(&quot;No TGeoManager defined&quot;);</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     183 </span>            :   }
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span>            :   // Implementation using alignable volume names. 
<span class="lineNum">     186 </span>            :   // Make container of transforms 
<span class="lineNum">     187 </span><span class="lineCov">         12 :   if (fInner &amp;&amp; !fInnerTransforms) </span>
<span class="lineNum">     188 </span><span class="lineCov">         18 :     fInnerTransforms = new TObjArray(fInner-&gt;GetNModules());</span>
<span class="lineNum">     189 </span><span class="lineCov">         10 :   if (fOuter &amp;&amp; !fOuterTransforms) </span>
<span class="lineNum">     190 </span><span class="lineCov">         12 :     fOuterTransforms = new TObjArray(fOuter-&gt;GetNModules());</span>
<span class="lineNum">     191 </span>            :   
<span class="lineNum">     192 </span>            :   // Loop over bottom/top 
<span class="lineNum">     193 </span><span class="lineCov">         36 :   for (size_t ihalf = 0; ihalf &lt; 2; ihalf++) {</span>
<span class="lineNum">     194 </span><span class="lineCov">         12 :     char  half = (ihalf == 0 ? 'T' : 'B');</span>
<span class="lineNum">     195 </span><span class="lineCov">         12 :     TString path(Form(HALF_FORMAT, fId, half));</span>
<span class="lineNum">     196 </span><span class="lineCov">         24 :     TGeoPNEntry* entry = gGeoManager-&gt;GetAlignableEntry(path.Data());</span>
<span class="lineNum">     197 </span><span class="lineCov">         12 :     if (!entry) {</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :       AliError(Form(&quot;Alignable entry for half-detector \&quot;%s\&quot; not found!&quot;, </span>
<span class="lineNum">     199 </span>            :                     path.Data()));
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     201 </span>            :     }
<span class="lineNum">     202 </span><span class="lineCov">         12 :     TGeoPhysicalNode* pn = entry-&gt;GetPhysicalNode();</span>
<span class="lineNum">     203 </span><span class="lineCov">         12 :     if (!pn) {</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot;Making physical volume for \&quot;%s\&quot;&quot;, path.Data()));</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :       pn = gGeoManager-&gt;MakeAlignablePN(entry);</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :       if (!pn) {</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :         AliError(Form(&quot;No physical node for \&quot;%s\&quot;&quot;, path.Data()));</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     209 </span>            :       }
<span class="lineNum">     210 </span>            :     }
<span class="lineNum">     211 </span><span class="lineCov">         24 :   }</span>
<span class="lineNum">     212 </span>            :   
<span class="lineNum">     213 </span>            :   // Loop over rings 
<span class="lineNum">     214 </span><span class="lineCov">         36 :   for (size_t iring = 0; iring &lt; 2; iring++) {</span>
<span class="lineNum">     215 </span><span class="lineCov">         24 :     char ring = (iring == 0 ? 'I' : 'O');</span>
<span class="lineNum">     216 </span>            :     TObjArray*  trans = 0;
<span class="lineNum">     217 </span>            :     AliFMDRing* r     = 0; 
<span class="lineNum">     218 </span><span class="lineCov">         24 :     switch (ring) {</span>
<span class="lineNum">     219 </span><span class="lineCov">          6 :     case 'I': r = fInner; trans = fInnerTransforms; break;</span>
<span class="lineNum">     220 </span><span class="lineCov">          6 :     case 'O': r = fOuter; trans = fOuterTransforms; break; </span>
<span class="lineNum">     221 </span>            :     }
<span class="lineNum">     222 </span><span class="lineCov">         14 :     if (!r || !trans) continue;</span>
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span><span class="lineCov">         10 :     Int_t nModules = r-&gt;GetNModules();</span>
<span class="lineNum">     225 </span><span class="lineCov">         10 :     if (nModules &lt;= 0) continue;</span>
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span>            :     // Loop over bottom/top 
<span class="lineNum">     228 </span><span class="lineCov">         60 :     for (size_t ihalf = 0; ihalf &lt; 2; ihalf++) {</span>
<span class="lineNum">     229 </span><span class="lineCov">         20 :       char  half = (ihalf == 0 ? 'T' : 'B');</span>
<span class="lineNum">     230 </span><span class="lineCov">         50 :       Int_t base = (half == 'T' ? 0 : nModules / 2);</span>
<span class="lineNum">     231 </span>            :       
<span class="lineNum">     232 </span>            :       // Loop over modules in this half ring 
<span class="lineNum">     233 </span><span class="lineCov">        320 :       for (Int_t imod = 0; imod &lt; nModules / 2; imod++) {</span>
<span class="lineNum">     234 </span>            :         // Find physical node entry
<span class="lineNum">     235 </span><span class="lineCov">        140 :         TString path(Form(SENSOR_FORMAT, fId, half, ring, base+imod));</span>
<span class="lineNum">     236 </span><span class="lineCov">        280 :         TGeoPNEntry* entry = gGeoManager-&gt;GetAlignableEntry(path.Data());</span>
<span class="lineNum">     237 </span><span class="lineCov">        140 :         if (!entry) {</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :           AliError(Form(&quot;Alignable entry for sensor \&quot;%s\&quot; not found!&quot;, </span>
<span class="lineNum">     239 </span>            :                         path.Data()));
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     241 </span>            :         }
<span class="lineNum">     242 </span><span class="lineCov">        140 :         TGeoPhysicalNode* pn = entry-&gt;GetPhysicalNode();</span>
<span class="lineNum">     243 </span><span class="lineCov">        140 :         if (!pn) {</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :           AliWarning(Form(&quot;Making physical volume for \&quot;%s\&quot;&quot;, path.Data()));</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :           pn = gGeoManager-&gt;MakeAlignablePN(entry);</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :           if (!pn) {</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :             AliError(Form(&quot;No physical node for \&quot;%s\&quot;&quot;, path.Data()));</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     249 </span>            :           }
<span class="lineNum">     250 </span>            :         }
<span class="lineNum">     251 </span>            :         
<span class="lineNum">     252 </span><span class="lineCov">        280 :         const TGeoMatrix* pm = pn-&gt;GetMatrix();</span>
<span class="lineNum">     253 </span><span class="lineCov">        140 :         if (!pm) {</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :           AliError(Form(&quot;No matrix for path \&quot;%s\&quot;&quot;, path.Data()));</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     256 </span>            :         }
<span class="lineNum">     257 </span>            :         // Get transformation matrix for this node, and store it. 
<span class="lineNum">     258 </span><span class="lineCov">        420 :         TGeoMatrix*  t = new TGeoHMatrix(*pm);</span>
<span class="lineNum">     259 </span><span class="lineCov">        140 :         trans-&gt;AddAt(t, base+imod);</span>
<span class="lineNum">     260 </span><span class="lineCov">        560 :         AliFMDDebug(5, (&quot;Found matrix for path \&quot;%s\&quot;: %p&quot;,path.Data(),pm));</span>
<span class="lineNum">     261 </span><span class="lineCov">        280 :       }</span>
<span class="lineNum">     262 </span>            :     }
<span class="lineNum">     263 </span><span class="lineCov">         10 :   }</span>
<span class="lineNum">     264 </span><span class="lineCov">         12 :   if (HasAllTransforms('I') &amp;&amp; HasAllTransforms('O')) return;</span>
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span>            :   // Alternative implementation using TGeoIter. 
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :   TGeoVolume* topVolume = gGeoManager-&gt;GetTopVolume();</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :   if (!topVolume) {</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     AliFatal(&quot;No top-level volume defined&quot;);</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     271 </span>            :   }
<span class="lineNum">     272 </span>            :   // Make an iterator
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :   TGeoIterator next(topVolume);</span>
<span class="lineNum">     274 </span>            :   TGeoNode* node = 0;
<span class="lineNum">     275 </span>            :   
<span class="lineNum">     276 </span>            :   // Find the node corresponding to this detector, and then find the
<span class="lineNum">     277 </span>            :   // sensor volumes 
<span class="lineNum">     278 </span>            :   Bool_t thisNodeFound = kFALSE;
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   Bool_t allInners     = HasAllTransforms('I');</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :   Bool_t allOuters     = HasAllTransforms('O');</span>
<span class="lineNum">     281 </span>            :   
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :   while ((node = static_cast&lt;TGeoNode*&gt;(next())) </span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :          &amp;&amp; !(allInners &amp;&amp; allOuters)) {</span>
<span class="lineNum">     284 </span>            :     // Get nodes names 
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     const Char_t* name = node-&gt;GetName();</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     if (!name) continue;</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :     AliFMDDebug(50, (&quot;Got volume %s&quot;, name));</span>
<span class="lineNum">     288 </span>            :     // Check if this node is this detector 
<span class="lineNum">     289 </span>            :     // The base offset for numbers in the ASCII table is 48
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :     if (IS_NODE_THIS(name)) {</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :       AliFMDDebug(20, (&quot;Found detector node '%s' for FMD%d&quot;, name, fId));</span>
<span class="lineNum">     292 </span>            :       thisNodeFound = kTRUE;
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     294 </span>            :     // if the detector was found, then we're on that branch, and we
<span class="lineNum">     295 </span>            :     // check if this node represents a module in that branch.
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :     if (thisNodeFound &amp;&amp; IS_NODE_SENSOR(name)) {</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :       AliFMDDebug(20, (&quot;Found sensor node '%s' for FMD%d&quot;, name, fId));</span>
<span class="lineNum">     298 </span>            :       // Get the ring Id.
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :       Char_t ringid = name[1];</span>
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span>            :       // Get the approprate ring
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :       AliFMDRing* ring = GetRing(ringid);</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :       if (!ring) continue;</span>
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span>            :       // Check whether we have all the modules we need for this ring,
<span class="lineNum">     306 </span>            :       // and if so, go on to the next node. 
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :       Bool_t&amp; done = (ring == fInner ? allInners : allOuters);</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :       if ((done = HasAllTransforms(ringid))) {</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :         AliFMDDebug(20, (&quot;Already has all module transforms for ring %c&quot;, </span>
<span class="lineNum">     310 </span>            :                          ringid));
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     312 </span>            :       }
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span>            :       // Get the approprate container
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :       TObjArray* matricies = (ringid == 'i' || ringid == 'I' </span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :                               ? fInnerTransforms : fOuterTransforms);</span>
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span>            :       // Get the copy (module) number, and check that it hasn't
<span class="lineNum">     319 </span>            :       // already been added to the container. 
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :       Int_t copy  = node-&gt;GetNumber();</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :       if (matricies-&gt;At(copy)) {</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;Have a transformation for module %d in ring %c&quot;, </span>
<span class="lineNum">     323 </span>            :                         copy, ringid));
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     325 </span>            :       }
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span>            :       // Get the global transformation matrix, and store it. 
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :       TGeoMatrix*  trans = new TGeoHMatrix(*(next.GetCurrentMatrix()));</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       matricies-&gt;AddAt(trans, copy);</span>
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     333 </span><span class="lineCov">          6 : }</span>
<span class="lineNum">     334 </span>            : 
<a name="335"><span class="lineNum">     335 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     336 </span>            : void
<span class="lineNum">     337 </span>            : AliFMDDetector::SetAlignableVolumes() const
<span class="lineNum">     338 </span>            : {
<span class="lineNum">     339 </span>            :   // Set alignable volumes. 
<span class="lineNum">     340 </span>            :   // This will define the alignable volumes. 
<span class="lineNum">     341 </span>            :   // That is currently, the modules and the half-rings. 
<span class="lineNum">     342 </span>            :   
<span class="lineNum">     343 </span><span class="lineCov">          9 :   AliFMDDebug(10, (&quot;Making alignable volumes for FMD%d&quot;, fId));</span>
<span class="lineNum">     344 </span><span class="lineCov">          3 :   if (!gGeoManager) {</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     AliFatal(&quot;No TGeoManager defined&quot;);</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     347 </span>            :   }
<span class="lineNum">     348 </span><span class="lineCov">          3 :   TGeoVolume* topVolume = gGeoManager-&gt;GetTopVolume();</span>
<span class="lineNum">     349 </span><span class="lineCov">          3 :   if (!topVolume) {</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     AliFatal(&quot;No top-level volume defined&quot;);</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     352 </span>            :   }
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span>            :   // Make an iterator
<span class="lineNum">     355 </span><span class="lineCov">          3 :   TGeoIterator next(topVolume);</span>
<span class="lineNum">     356 </span><span class="lineCov">          3 :   next.Reset(topVolume);</span>
<span class="lineNum">     357 </span><span class="lineCov">          9 :   next.SetTopName(Form(&quot;/%s_1&quot;, topVolume-&gt;GetName()));</span>
<span class="lineNum">     358 </span>            :   TGeoNode* node = 0;
<span class="lineNum">     359 </span>            :   
<span class="lineNum">     360 </span><span class="lineCov">          9 :   Int_t nInnerSensor = (fInner ? fInner-&gt;GetNModules() : 0);</span>
<span class="lineNum">     361 </span><span class="lineCov">          8 :   Int_t nOuterSensor = (fOuter ? fOuter-&gt;GetNModules() : 0);</span>
<span class="lineNum">     362 </span>            :   // Find the node corresponding to this detector, and then find the
<span class="lineNum">     363 </span>            :   // sensor volumes 
<span class="lineNum">     364 </span>            :   Bool_t thisNodeFound = kFALSE;
<span class="lineNum">     365 </span>            :   Char_t thisHalf      = '\0';
<span class="lineNum">     366 </span>            :   Int_t  iInnerSensor  = 0;
<span class="lineNum">     367 </span>            :   Int_t  iOuterSensor  = 0;
<span class="lineNum">     368 </span>            :   Bool_t hasTop        = false;
<span class="lineNum">     369 </span>            :   Bool_t hasBottom     = false;
<span class="lineNum">     370 </span>            :   
<span class="lineNum">     371 </span><span class="lineCov">          6 :   TString path, align;</span>
<span class="lineNum">     372 </span><span class="lineCov">   16223345 :   while ((node = static_cast&lt;TGeoNode*&gt;(next())) </span>
<span class="lineNum">     373 </span><span class="lineCov">   16234839 :          &amp;&amp; (iInnerSensor &lt; nInnerSensor || iOuterSensor &lt; nOuterSensor</span>
<span class="lineNum">     374 </span><span class="lineCov">      11503 :              || !hasBottom || !hasTop)) {</span>
<span class="lineNum">     375 </span>            :     // Get nodes names 
<span class="lineNum">     376 </span><span class="lineCov">    8111668 :     const Char_t* name = node-&gt;GetName();</span>
<span class="lineNum">     377 </span><span class="lineCov">    8111668 :     if (!name) continue;</span>
<span class="lineNum">     378 </span><span class="lineCov">   32446672 :     AliFMDDebug((name[0] == 'F' ? 40 : 50), (&quot;Got volume %s&quot;, name));</span>
<span class="lineNum">     379 </span>            :     // Check if this node is this detector 
<span class="lineNum">     380 </span>            :     // The base offset for numbers in the ASCII table is 48
<span class="lineNum">     381 </span><span class="lineCov">    8986939 :     if (IS_NODE_THIS(name)) {</span>
<span class="lineNum">     382 </span><span class="lineCov">         24 :       AliFMDDebug(20, (&quot;Found detector node '%s' for FMD%d&quot;, name, fId));</span>
<span class="lineNum">     383 </span>            :       thisNodeFound = kTRUE;
<span class="lineNum">     384 </span><span class="lineCov">          6 :     }</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span>            :     // if a half ring is found, then we're on that branch, and we
<span class="lineNum">     387 </span>            :     // check if this node represents a half ring on that branch 
<span class="lineNum">     388 </span><span class="lineCov">    8211701 :     if (thisNodeFound &amp;&amp; IS_NODE_HALF(name)) {</span>
<span class="lineNum">     389 </span><span class="lineCov">         24 :       AliFMDDebug(30, (&quot;Found half node '%s' for FMD%d&quot;, name, fId));</span>
<span class="lineNum">     390 </span>            :       // Get the half Id.
<span class="lineNum">     391 </span><span class="lineCov">          6 :       thisHalf = name[3];</span>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span>            :       // Check if we're done 
<span class="lineNum">     394 </span><span class="lineCov">          6 :       Bool_t done = (thisHalf == 'T' ? hasTop : hasBottom);</span>
<span class="lineNum">     395 </span><span class="lineCov">          6 :       if (done) {</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         AliFMDDebug(20, (&quot;Already has all halves for detector %c&quot;,name[1]));</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     398 </span>            :       }
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineCov">          6 :       switch (thisHalf) {</span>
<span class="lineNum">     401 </span><span class="lineCov">          3 :       case 'T': hasTop = true; break;</span>
<span class="lineNum">     402 </span><span class="lineCov">          3 :       case 'B': hasBottom = true; break;</span>
<span class="lineNum">     403 </span>            :       default:  
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;Unknown part '%c' of FMD%d&quot;, thisHalf, fId));</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         continue; // because the node is unknown. </span>
<span class="lineNum">     406 </span>            :       }
<span class="lineNum">     407 </span>            :       
<span class="lineNum">     408 </span>            :       // Get the node path 
<span class="lineNum">     409 </span><span class="lineCov">          6 :       next.GetPath(path);</span>
<span class="lineNum">     410 </span><span class="lineCov">         12 :       align = Form(HALF_FORMAT, fId, thisHalf);</span>
<span class="lineNum">     411 </span><span class="lineCov">          6 :     }</span>
<span class="lineNum">     412 </span>            :     
<span class="lineNum">     413 </span>            :     // if the detector was found, then we're on that branch, and we
<span class="lineNum">     414 </span>            :     // check if this node represents a module in that branch.
<span class="lineNum">     415 </span><span class="lineCov">    8261738 :     if (thisNodeFound &amp;&amp; thisHalf &amp;&amp; IS_NODE_SENSOR(name)) {</span>
<span class="lineNum">     416 </span><span class="lineCov">        280 :       AliFMDDebug(30, (&quot;Found sensor node '%s' for FMD%d&quot;, name, fId));</span>
<span class="lineNum">     417 </span>            :       // Get the ring Id.
<span class="lineNum">     418 </span><span class="lineCov">         70 :       Char_t ringid = name[1];</span>
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span>            :       // check that the ring is valid 
<span class="lineNum">     421 </span><span class="lineCov">        140 :       if (!GetRing(ringid)) {</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;Invalid ring %c for FMD%d&quot;, ringid, fId));</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     424 </span>            :       }
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span>            :       // Check if we're done
<span class="lineNum">     427 </span>            :       Bool_t done = false;
<span class="lineNum">     428 </span><span class="lineCov">         70 :       switch (ringid) {</span>
<span class="lineNum">     429 </span><span class="lineCov">         30 :       case 'I': done = iInnerSensor &gt;= nInnerSensor; break;</span>
<span class="lineNum">     430 </span><span class="lineCov">         40 :       case 'O': done = iOuterSensor &gt;= nOuterSensor; break;</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :       default: continue;</span>
<span class="lineNum">     432 </span>            :       }
<span class="lineNum">     433 </span><span class="lineCov">         70 :       if (done) {</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :         AliFMDDebug(20, (&quot;Already has all sensor volumes for ring %c&quot;,ringid));</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     436 </span>            :       }
<span class="lineNum">     437 </span>            :       // Get the copy (module) number, and check that it hasn't
<span class="lineNum">     438 </span>            :       // already been added to the container. 
<span class="lineNum">     439 </span><span class="lineCov">         70 :       Int_t copy  = node-&gt;GetNumber();</span>
<span class="lineNum">     440 </span><span class="lineCov">         70 :       next.GetPath(path);</span>
<span class="lineNum">     441 </span>            :       // path.Replace(&quot;ALIC&quot;, &quot;/ALIC_1&quot;);
<span class="lineNum">     442 </span><span class="lineCov">        140 :       align = Form(SENSOR_FORMAT, fId, thisHalf, ringid, copy);</span>
<span class="lineNum">     443 </span>            :       
<span class="lineNum">     444 </span><span class="lineCov">        140 :       switch (ringid) {</span>
<span class="lineNum">     445 </span><span class="lineCov">         30 :       case 'I': iInnerSensor++; break;</span>
<span class="lineNum">     446 </span><span class="lineCov">         40 :       case 'O': iOuterSensor++; break;</span>
<span class="lineNum">     447 </span>            :       }
<span class="lineNum">     448 </span><span class="lineCov">         70 :     }</span>
<span class="lineNum">     449 </span><span class="lineCov">   16223488 :     if (!align.IsNull() &amp;&amp; !path.IsNull()) {</span>
<span class="lineNum">     450 </span><span class="lineCov">        304 :       AliFMDDebug(20, (&quot;Got %s -&gt; %s&quot;, path.Data(), align.Data()));</span>
<span class="lineNum">     451 </span>            :       TGeoPNEntry* entry = 
<span class="lineNum">     452 </span><span class="lineCov">        228 :         gGeoManager-&gt;SetAlignableEntry(align.Data(),path.Data());</span>
<span class="lineNum">     453 </span><span class="lineCov">         76 :       if(!entry)</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :         AliFatal(Form(&quot;Alignable entry %s not created. &quot;</span>
<span class="lineNum">     455 </span>            :                       &quot;Volume path %s not valid&quot;, 
<span class="lineNum">     456 </span>            :                         align.Data(),path.Data()));
<span class="lineNum">     457 </span>            : #ifdef MAKE_ALIGNABLE_PHYSICAL
<span class="lineNum">     458 </span>            :       TGeoPhysicalNode* phys = gGeoManager-&gt;MakeAlignablePN(entry);
<span class="lineNum">     459 </span>            :       if (!phys) 
<span class="lineNum">     460 </span>            :         AliWarning(Form(&quot;Physical node entry %s not created. &quot;
<span class="lineNum">     461 </span>            :                         &quot;Volume path %s not valid&quot;, 
<span class="lineNum">     462 </span>            :                         align.Data(),path.Data()));
<span class="lineNum">     463 </span>            : #endif
<span class="lineNum">     464 </span><span class="lineCov">         76 :       align = &quot;&quot;;</span>
<span class="lineNum">     465 </span><span class="lineCov">         76 :     }</span>
<span class="lineNum">     466 </span><span class="lineCov">   32446672 :     AliFMDDebug(20, (&quot;FMD%d: top: %d bottom: %d Inner: %d/%d Outer %d/%d&quot;, </span>
<span class="lineNum">     467 </span>            :                       fId, hasTop, hasBottom, iInnerSensor,  nInnerSensor, 
<span class="lineNum">     468 </span>            :                       iOuterSensor, nOuterSensor));
<span class="lineNum">     469 </span><span class="lineCov">    8111668 :   }</span>
<span class="lineNum">     470 </span><span class="lineCov">          6 : }</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            :   
<span class="lineNum">     473 </span>            : 
<a name="474"><span class="lineNum">     474 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     475 </span>            : AliFMDRing*
<span class="lineNum">     476 </span>            : AliFMDDetector::GetRing(Char_t id) const
<span class="lineNum">     477 </span>            : {
<span class="lineNum">     478 </span>            :   // Get the specified ring 
<span class="lineNum">     479 </span>            :   // 
<span class="lineNum">     480 </span>            :   //   ID      Id of ring ('I' or 'O')
<span class="lineNum">     481 </span>            :   // 
<span class="lineNum">     482 </span><span class="lineCov">     885672 :   switch (id) {</span>
<span class="lineNum">     483 </span>            :   case 'i':
<span class="lineNum">     484 </span><span class="lineCov">     270671 :   case 'I': return GetInner();</span>
<span class="lineNum">     485 </span>            :   case 'o':
<span class="lineNum">     486 </span><span class="lineCov">     172165 :   case 'O': return GetOuter();</span>
<span class="lineNum">     487 </span>            :   }
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     489 </span><span class="lineCov">     442836 : }</span>
<span class="lineNum">     490 </span>            : 
<a name="491"><span class="lineNum">     491 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     492 </span>            : Double_t
<span class="lineNum">     493 </span>            : AliFMDDetector::GetRingZ(Char_t id) const
<span class="lineNum">     494 </span>            : {
<span class="lineNum">     495 </span>            :   // Get the z-coordinate specified ring 
<span class="lineNum">     496 </span>            :   // 
<span class="lineNum">     497 </span>            :   //   ID      Id of ring ('I' or 'O')
<span class="lineNum">     498 </span>            :   // 
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :   switch (id) {</span>
<span class="lineNum">     500 </span>            :   case 'i':
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :   case 'I': return GetInnerZ();</span>
<span class="lineNum">     502 </span>            :   case 'o':
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :   case 'O': return GetOuterZ();</span>
<span class="lineNum">     504 </span>            :   }
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     507 </span>            : 
<a name="508"><span class="lineNum">     508 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     509 </span>            : TGeoMatrix*
<span class="lineNum">     510 </span>            : AliFMDDetector::FindTransform(Char_t ring, UShort_t sector) const 
<span class="lineNum">     511 </span>            : {
<span class="lineNum">     512 </span>            :   // Find the transformation that corresponds to sector sector in ring
<span class="lineNum">     513 </span>            :   // ring. 
<span class="lineNum">     514 </span>            :   TObjArray* matricies = 0;
<span class="lineNum">     515 </span><span class="lineCov">    1327104 :   switch (ring) {</span>
<span class="lineNum">     516 </span><span class="lineCov">     270336 :   case 'i': case 'I': matricies = fInnerTransforms; break;</span>
<span class="lineNum">     517 </span><span class="lineCov">     172032 :   case 'o': case 'O': matricies = fOuterTransforms; break;</span>
<span class="lineNum">     518 </span>            :   }
<span class="lineNum">     519 </span><span class="lineCov">     442368 :   if (!matricies) { </span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Unknown ring %c of FMD%d&quot;, ring, fId));</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     522 </span>            :   }
<span class="lineNum">     523 </span><span class="lineCov">     442368 :   UInt_t module = sector / 2;</span>
<span class="lineNum">     524 </span><span class="lineCov">     442368 :   TGeoMatrix* m = static_cast&lt;TGeoMatrix*&gt;(matricies-&gt;At(module));</span>
<span class="lineNum">     525 </span><span class="lineCov">     442368 :   if (!m) {</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;No matrix found for sector %d in FMD%d%c&quot;, </span>
<span class="lineNum">     527 </span>            :                     sector, fId, ring));
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     529 </span>            :   }
<span class="lineNum">     530 </span><span class="lineCov">     442368 :   return m;</span>
<span class="lineNum">     531 </span><span class="lineCov">     442368 : }</span>
<span class="lineNum">     532 </span>            : 
<span class="lineNum">     533 </span>            :   
<a name="534"><span class="lineNum">     534 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     535 </span>            : void
<span class="lineNum">     536 </span>            : AliFMDDetector::Detector2XYZ(Char_t   ring, 
<span class="lineNum">     537 </span>            :                              UShort_t sector,
<span class="lineNum">     538 </span>            :                              UShort_t strip, 
<span class="lineNum">     539 </span>            :                              Double_t&amp; x, 
<span class="lineNum">     540 </span>            :                              Double_t&amp; y, 
<span class="lineNum">     541 </span>            :                              Double_t&amp; z) const
<span class="lineNum">     542 </span>            : {
<span class="lineNum">     543 </span>            :   // Translate detector coordinates (this,ring,sector,strip) into
<span class="lineNum">     544 </span>            :   // (x,y,z) coordinates (in global reference frame)
<span class="lineNum">     545 </span><span class="lineCov">     884736 :   AliFMDRing* r = GetRing(ring);</span>
<span class="lineNum">     546 </span><span class="lineCov">     442368 :   if (!r) { </span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;No such ring FMD%d%c &quot;, fId, ring));</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     549 </span>            :   }
<span class="lineNum">     550 </span><span class="lineCov">     442368 :   TGeoMatrix* m = FindTransform(ring, sector);</span>
<span class="lineNum">     551 </span><span class="lineCov">     442368 :   if (!m) { </span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;No transfrmation found for FMD%d%c[%02d]&quot;, </span>
<span class="lineNum">     553 </span>            :                     fId, ring, sector));
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     555 </span>            :   }
<span class="lineNum">     556 </span><span class="lineCov">     442368 :   Double_t rho      = r-&gt;GetStripRadius(strip);</span>
<span class="lineNum">     557 </span><span class="lineCov">     442368 :   Double_t phi      = ((sector % 2) - .5) * r-&gt;GetTheta();</span>
<span class="lineNum">     558 </span><span class="lineCov">     442368 :   Double_t siThick  = r-&gt;GetSiThickness();</span>
<span class="lineNum">     559 </span>            : #if 0 
<span class="lineNum">     560 </span>            :   Double_t modThick = (siThick
<span class="lineNum">     561 </span>            :                        + r-&gt;GetPrintboardThickness()
<span class="lineNum">     562 </span>            :                        + r-&gt;GetCopperThickness()
<span class="lineNum">     563 </span>            :                        + r-&gt;GetChipThickness()
<span class="lineNum">     564 </span>            :                        + r-&gt;GetSpacing());
<span class="lineNum">     565 </span>            : #endif
<span class="lineNum">     566 </span><span class="lineCov">     884736 :   AliFMDDebug(30, (&quot;Rho %7.3f, angle %7.3f&quot;, rho, phi));</span>
<span class="lineNum">     567 </span><span class="lineCov">    1327104 :   Double_t local[]  = { rho * TMath::Cos(phi * TMath::DegToRad()), </span>
<span class="lineNum">     568 </span><span class="lineCov">     442368 :                         rho * TMath::Sin(phi * TMath::DegToRad()), </span>
<span class="lineNum">     569 </span><span class="lineCov">     442368 :                         /* -modThick + */ siThick / 2 };</span>
<span class="lineNum">     570 </span><span class="lineCov">     442368 :   Double_t master[3];</span>
<span class="lineNum">     571 </span><span class="lineCov">     884736 :   AliFMDDebug(30, (&quot;Local (%7.3f,%7.3f,%7.3f)&quot;,local[0], local[1], local[2]));</span>
<span class="lineNum">     572 </span><span class="lineCov">     442368 :   m-&gt;LocalToMaster(local, master);</span>
<span class="lineNum">     573 </span><span class="lineCov">     884736 :   AliFMDDebug(30, (&quot;Master (%7.3f,%7.3f,%7.3f)&quot;,</span>
<span class="lineNum">     574 </span>            :                     master[0],master[1],master[2]));
<span class="lineNum">     575 </span><span class="lineCov">     442368 :   x = master[0];</span>
<span class="lineNum">     576 </span><span class="lineCov">     442368 :   y = master[1];</span>
<span class="lineNum">     577 </span><span class="lineCov">     442368 :   z = master[2];</span>
<span class="lineNum">     578 </span><span class="lineCov">     884736 : }</span>
<span class="lineNum">     579 </span>            : 
<a name="580"><span class="lineNum">     580 </span>            : //____________________________________________________________________</a>
<span class="lineNum">     581 </span>            : Bool_t
<span class="lineNum">     582 </span>            : AliFMDDetector::XYZ2Detector(Double_t  x,
<span class="lineNum">     583 </span>            :                              Double_t  y,
<span class="lineNum">     584 </span>            :                              Double_t  z,
<span class="lineNum">     585 </span>            :                              Char_t&amp;   ring, 
<span class="lineNum">     586 </span>            :                              UShort_t&amp; sector,
<span class="lineNum">     587 </span>            :                              UShort_t&amp; strip) const
<span class="lineNum">     588 </span>            : {
<span class="lineNum">     589 </span>            :   // Translate (x,y,z) coordinates (in global reference frame) into 
<span class="lineNum">     590 </span>            :   // detector coordinates (this,ring,sector,strip).
<span class="lineNum">     591 </span>            :   AliFMDRing* rng = 0;
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :   ring = -1;</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :   for (int j = 0; j &lt; 2; j++) {</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :     rng = GetRing(j == 0 ? 'I'  : 'O');</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :     if (!rng) continue;</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :     Double_t ringZ    = GetRingZ(j == 0 ? 'I'  : 'O');</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :     Double_t modSpace = TMath::Sign(rng-&gt;GetModuleSpacing(), ringZ);</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :     if (TMath::Abs(z - ringZ) &lt; 0.01 || </span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :         TMath::Abs(z - ringZ + modSpace) &lt; 0.01) break;</span>
<span class="lineNum">     600 </span>            :     rng = 0;
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :   if (rng &amp;&amp; rng-&gt;XYZ2Detector(x, y, z - GetRingZ(rng-&gt;GetId()),</span>
<span class="lineNum">     603 </span>            :                                sector, strip)) {
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :     ring = rng-&gt;GetId();</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :     return kTRUE;</span>
<span class="lineNum">     606 </span>            :   }
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :   return kFALSE;</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span>            :   
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span>            : //____________________________________________________________________
<span class="lineNum">     613 </span>            : // 
<span class="lineNum">     614 </span>            : // EOF
<span class="lineNum">     615 </span>            : //
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
