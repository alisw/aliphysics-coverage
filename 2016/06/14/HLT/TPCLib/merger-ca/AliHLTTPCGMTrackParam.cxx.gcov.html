<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - HLT/TPCLib/merger-ca/AliHLTTPCGMTrackParam.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">HLT/TPCLib/merger-ca</a> - AliHLTTPCGMTrackParam.cxx<span style="font-size: 80%;"> (source / <a href="AliHLTTPCGMTrackParam.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">296</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : // $Id: AliHLTTPCGMTrackParam.cxx 41769 2010-06-16 13:58:00Z sgorbuno $</a>
<span class="lineNum">       2 </span>            : // **************************************************************************
<span class="lineNum">       3 </span>            : // This file is property of and copyright by the ALICE HLT Project          *
<span class="lineNum">       4 </span>            : // ALICE Experiment at CERN, All rights reserved.                           *
<span class="lineNum">       5 </span>            : //                                                                          *
<span class="lineNum">       6 </span>            : // Primary Authors: Sergey Gorbunov &lt;sergey.gorbunov@kip.uni-heidelberg.de&gt; *
<span class="lineNum">       7 </span>            : //                  for The ALICE HLT Project.                              *
<span class="lineNum">       8 </span>            : //                                                                          *
<span class="lineNum">       9 </span>            : // Permission to use, copy, modify and distribute this software and its     *
<span class="lineNum">      10 </span>            : // documentation strictly for non-commercial purposes is hereby granted     *
<span class="lineNum">      11 </span>            : // without fee, provided that the above copyright notice appears in all     *
<span class="lineNum">      12 </span>            : // copies and that both the copyright notice and this permission notice     *
<span class="lineNum">      13 </span>            : // appear in the supporting documentation. The authors make no claims       *
<span class="lineNum">      14 </span>            : // about the suitability of this software for any purpose. It is            *
<span class="lineNum">      15 </span>            : // provided &quot;as is&quot; without express or implied warranty.                    *
<span class="lineNum">      16 </span>            : //                                                                          *
<span class="lineNum">      17 </span>            : //***************************************************************************
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : #include &quot;AliHLTTPCGMTrackParam.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;AliHLTTPCCAMath.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;AliHLTTPCGMTrackLinearisation.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;AliHLTTPCGMBorderTrack.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;Riostream.h&quot;
<span class="lineNum">      24 </span>            : #ifndef HLTCA_STANDALONE
<span class="lineNum">      25 </span>            : #include &quot;AliExternalTrackParam.h&quot;
<span class="lineNum">      26 </span>            : #endif
<span class="lineNum">      27 </span>            : #include &quot;AliHLTTPCCAParam.h&quot;
<a name="28"><span class="lineNum">      28 </span>            : #include &lt;cmath&gt;</a>
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : GPUd() void AliHLTTPCGMTrackParam::Fit
<span class="lineNum">      31 </span>            : (
<span class="lineNum">      32 </span>            :  float* PolinomialFieldBz,
<span class="lineNum">      33 </span>            :  float x[], float y[], float z[], unsigned int rowType[], float alpha[], AliHLTTPCCAParam &amp;param,
<span class="lineNum">      34 </span>            :  int &amp;N,
<span class="lineNum">      35 </span>            :  float &amp;Alpha, 
<span class="lineNum">      36 </span>            :  bool UseMeanPt,
<span class="lineNum">      37 </span>            :  float maxSinPhi
<span class="lineNum">      38 </span>            :  ){
<span class="lineNum">      39 </span>            :   
<span class="lineNum">      40 </span>            :   const float kRho = 1.025e-3;//0.9e-3;
<span class="lineNum">      41 </span>            :   const float kRadLen = 29.532;//28.94;
<span class="lineNum">      42 </span>            :   const float kRhoOverRadLen = kRho / kRadLen;
<span class="lineNum">      43 </span>            :   
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :   AliHLTTPCGMTrackLinearisation t0(*this);</span>
<span class="lineNum">      45 </span>            :  
<span class="lineNum">      46 </span>            :   const float kZLength = 250.f - 0.275f;
<span class="lineNum">      47 </span><span class="lineNoCov">          0 :   float trDzDs2 = t0.DzDs()*t0.DzDs();</span>
<span class="lineNum">      48 </span>            :  
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :   AliHLTTPCGMTrackFitParam par;</span>
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :   CalculateFitParameters( par, kRhoOverRadLen, kRho, UseMeanPt );</span>
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   int maxN = N;</span>
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            :   bool first = 1;
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :   N = 0;</span>
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :   for( int ihit=0; ihit&lt;maxN; ihit++ ){</span>
<span class="lineNum">      58 </span>            :     
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :     float sliceAlpha =  alpha[ihit];</span>
<span class="lineNum">      60 </span>            :     
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :     if ( fabs( sliceAlpha - Alpha ) &gt; 1.e-4 ) {</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :       if( !Rotate(  sliceAlpha - Alpha, t0, .999 ) ) break;</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :       Alpha = sliceAlpha;</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            :     float dL=0;    
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :     float bz =  GetBz(x[ihit], y[ihit],z[ihit], PolinomialFieldBz);</span>
<span class="lineNum">      68 </span>            :         
<span class="lineNum">      69 </span>            :     float err2Y, err2Z;
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            :     { // transport block
<span class="lineNum">      72 </span>            :       
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :       bz = -bz;</span>
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :       float ex = t0.CosPhi();</span>
<span class="lineNum">      76 </span>            :       
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :       float ey = t0.SinPhi();</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :       float k  = t0.QPt()*bz;</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :       float dx = x[ihit] - X();</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :       float kdx = k*dx;</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :       float ey1 = kdx + ey;</span>
<span class="lineNum">      82 </span>            :       
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :       if( fabs( ey1 ) &gt;= maxSinPhi ) break;</span>
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :       float ss = ey + ey1;   </span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :       float ex1 = sqrt(1 - ey1*ey1);</span>
<span class="lineNum">      87 </span>            :       
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :       float dxBz = dx * bz;</span>
<span class="lineNum">      89 </span>            :     
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :       float cc = ex + ex1;  </span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :       float dxcci = dx * Reciprocal(cc);</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :       float kdx205 = kdx*kdx*0.5f;</span>
<span class="lineNum">      93 </span>            :       
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :       float dy = dxcci * ss;      </span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :       float norm2 = float(1.f) + ey*ey1 + ex*ex1;</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :       float dl = dxcci * sqrt( norm2 + norm2 );</span>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            :       float dS;    
<span class="lineNum">      99 </span>            :       { 
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :         float dSin = float(0.5f)*k*dl;</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :         float a = dSin*dSin;</span>
<span class="lineNum">     102 </span>            :         const float k2 = 1.f/6.f;
<span class="lineNum">     103 </span>            :         const float k4 = 3.f/40.f;
<span class="lineNum">     104 </span>            :         //const float k6 = 5.f/112.f;
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :         dS = dl + dl*a*(k2 + a*(k4 ));//+ k6*a) );</span>
<span class="lineNum">     106 </span>            :       }
<span class="lineNum">     107 </span>            :       
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :       float ex1i = Reciprocal(ex1);</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :       float dz = dS * t0.DzDs();  </span>
<span class="lineNum">     110 </span>            :       
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :       dL = -dS * t0.DlDs();</span>
<span class="lineNum">     112 </span>            :       
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :       float hh = dxcci*ex1i*(2.f+kdx205); </span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :       float h2 = hh * t0.SecPhi();</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :       float h4 = bz*dxcci*hh;</span>
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :       float d2 = fP[2] - t0.SinPhi();</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :       float d3 = fP[3] - t0.DzDs();</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :       float d4 = fP[4] - t0.QPt();</span>
<span class="lineNum">     120 </span>            :       
<span class="lineNum">     121 </span>            :       
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :       fX+=dx;</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :       fP[0]+= dy     + h2 * d2           +   h4 * d4;</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :       fP[1]+= dz               + dS * d3;</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :       fP[2] = ey1 +     d2           + dxBz * d4;    </span>
<span class="lineNum">     126 </span>            :       
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :       t0.CosPhi() = ex1;</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :       t0.SecPhi() = ex1i;</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :       t0.SinPhi() = ey1;      </span>
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span>            :       {
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :         const float *cy = param.GetParamS0Par(0,rowType[ihit]);</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :         const float *cz = param.GetParamS0Par(1,rowType[ihit]);</span>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :         float secPhi2 = ex1i*ex1i;</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :         float zz = fabs( kZLength - fabs(fP[2]) );      </span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         float zz2 = zz*zz;</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :         float angleY2 = secPhi2 - 1.f; </span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :         float angleZ2 = trDzDs2 * secPhi2 ;</span>
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :         float cy0 = cy[0] + cy[1]*zz + cy[3]*zz2;</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :         float cy1 = cy[2] + cy[5]*zz;</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :         float cy2 = cy[4];</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :         float cz0 = cz[0] + cz[1]*zz + cz[3]*zz2;</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :         float cz1 = cz[2] + cz[5]*zz;</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :         float cz2 = cz[4];</span>
<span class="lineNum">     147 </span>            :         
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :         err2Y = fabs( cy0 + angleY2 * ( cy1 + angleY2*cy2 ) );</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :         err2Z = fabs( cz0 + angleZ2 * ( cz1 + angleZ2*cz2 ) );      </span>
<span class="lineNum">     150 </span>            :      }
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            : 
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :       if ( first ) {</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :         fP[0] = y[ihit];</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :         fP[1] = z[ihit];</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :         SetCov( 0, err2Y );</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :         SetCov( 1,  0 );</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :         SetCov( 2, err2Z);</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :         SetCov( 3,  0 );</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :         SetCov( 4,  0 );</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :         SetCov( 5,  1 );</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :         SetCov( 6,  0 );</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :         SetCov( 7,  0 );</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :         SetCov( 8,  0 );</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :         SetCov( 9,  1 );</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :         SetCov( 10,  0 );</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :         SetCov( 11,  0 );</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :         SetCov( 12,  0 );</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :         SetCov( 13,  0 );</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :         SetCov( 14,  10 );</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :         SetChi2( 0 );</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :         SetNDF( -3 );</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :         CalculateFitParameters( par, kRhoOverRadLen, kRho, UseMeanPt );</span>
<span class="lineNum">     174 </span>            :         first = 0;
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :         N+=1;</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     177 </span>            :       }
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :       float c20 = fC[3];</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :       float c21 = fC[4];</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :       float c22 = fC[5];</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :       float c30 = fC[6];</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :       float c31 = fC[7];</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :       float c32 = fC[8];</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :       float c33 = fC[9];</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :       float c40 = fC[10];</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :       float c41 = fC[11];</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :       float c42 = fC[12];</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :       float c43 = fC[13];</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :       float c44 = fC[14];</span>
<span class="lineNum">     191 </span>            :       
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :       float c20ph4c42 =  c20 + h4*c42;</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :       float h2c22 = h2*c22;</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :       float h4c44 = h4*c44;</span>
<span class="lineNum">     195 </span>            :       
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :       float n6 = c30 + h2*c32 + h4*c43;</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :       float n7 = c31 + dS*c33;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :       float n10 = c40 + h2*c42 + h4c44;</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :       float n11 = c41 + dS*c43;</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :       float n12 = c42 + dxBz*c44;</span>
<span class="lineNum">     201 </span>            :       
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :       fC[8] = c32 + dxBz * c43;</span>
<span class="lineNum">     203 </span>            :       
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :       fC[0]+= h2*h2c22 + h4*h4c44 + float(2.f)*( h2*c20ph4c42  + h4*c40 );</span>
<span class="lineNum">     205 </span>            :       
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :       fC[1]+= h2*c21 + h4*c41 + dS*n6;</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :       fC[6] = n6;</span>
<span class="lineNum">     208 </span>            :       
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :       fC[2]+= dS*(c31 + n7);</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :       fC[7] = n7; </span>
<span class="lineNum">     211 </span>            :       
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :       fC[3] = c20ph4c42 + h2c22  + dxBz*n10;</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :       fC[10] = n10;</span>
<span class="lineNum">     214 </span>            :       
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :       fC[4] = c21 + dS*c32 + dxBz*n11;</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :       fC[11] = n11;</span>
<span class="lineNum">     217 </span>            :       
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :       fC[5] = c22 + dxBz*( c42 + n12 );</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :       fC[12] = n12;</span>
<span class="lineNum">     220 </span>            :       
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :     } // end transport block </span>
<span class="lineNum">     222 </span>            : 
<span class="lineNum">     223 </span>            :  
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :     float &amp;fC22 = fC[5];</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :     float &amp;fC33 = fC[9];</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :     float &amp;fC40 = fC[10];</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :     float &amp;fC41 = fC[11];</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :     float &amp;fC42 = fC[12];</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :     float &amp;fC43 = fC[13];</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :     float &amp;fC44 = fC[14];</span>
<span class="lineNum">     231 </span>            :     
<span class="lineNum">     232 </span>            :     float 
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :       c00 = fC[ 0],</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :       c11 = fC[ 2],</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :       c20 = fC[ 3],</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :       c31 = fC[ 7];</span>
<span class="lineNum">     237 </span>            :     
<span class="lineNum">     238 </span>            :     
<span class="lineNum">     239 </span>            :     // MS block  
<span class="lineNum">     240 </span>            :     
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     float dLmask = 0.f;</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     bool maskMS = ( fabs( dL ) &lt; par.fDLMax );</span>
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span>            :     
<span class="lineNum">     245 </span>            :     // Filter block
<span class="lineNum">     246 </span>            :     
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     float mS0 = Reciprocal(err2Y + c00);</span>
<span class="lineNum">     248 </span>            :     
<span class="lineNum">     249 </span>            :     // MS block
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :     Assign( dLmask, maskMS, dL );</span>
<span class="lineNum">     251 </span>            :     
<span class="lineNum">     252 </span>            :     // Filter block
<span class="lineNum">     253 </span>            :     
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :     float  z0 = y[ihit] - fP[0];</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :     float mS2 = Reciprocal(err2Z + c11);</span>
<span class="lineNum">     256 </span>            :     
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :     if( fabs( fP[2] + z0*c20*mS0  ) &gt; maxSinPhi ) break;</span>
<span class="lineNum">     258 </span>            :     
<span class="lineNum">     259 </span>            :     // MS block
<span class="lineNum">     260 </span>            :     
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     float dLabs = fabs( dLmask); </span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :     float corr = float(1.f) - par.fEP2* dLmask ;</span>
<span class="lineNum">     263 </span>            :     
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     fP[4]*= corr;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     fC40 *= corr;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     fC41 *= corr;</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     fC42 *= corr;</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     fC43 *= corr;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     fC44  = fC44*corr*corr + dLabs*par.fSigmadE2;</span>
<span class="lineNum">     270 </span>            :     
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     fC22 += dLabs * par.fK22 * (float(1.f)-fP[2]*fP[2]);</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     fC33 += dLabs * par.fK33;</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     fC43 += dLabs * par.fK43;</span>
<span class="lineNum">     274 </span>            :         
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span>            :     // Filter block
<span class="lineNum">     277 </span>            :   
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :     float c40 = fC40;</span>
<span class="lineNum">     279 </span>            :     
<span class="lineNum">     280 </span>            :     // K = CHtS
<span class="lineNum">     281 </span>            :     
<span class="lineNum">     282 </span>            :     float k00, k11, k20, k31, k40;
<span class="lineNum">     283 </span>            :     
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     k00 = c00 * mS0;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     k20 = c20 * mS0;</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     k40 = c40 * mS0;</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :     fChi2  += mS0*z0*z0;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     fP[0] += k00 * z0;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :     fP[2] += k20 * z0;</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :     fP[4] += k40 * z0;</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :     fC[ 0] -= k00 * c00 ;</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :     fC[ 5] -= k20 * c20 ;</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     fC[10] -= k00 * c40 ;</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :     fC[12] -= k40 * c20 ;</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :     fC[ 3] -= k20 * c00 ;</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :     fC[14] -= k40 * c40 ;</span>
<span class="lineNum">     297 </span>            :   
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :     float  z1 = z[ihit] - fP[1];</span>
<span class="lineNum">     299 </span>            :     
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :     k11 = c11 * mS2;</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :     k31 = c31 * mS2;</span>
<span class="lineNum">     302 </span>            :     
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :     fChi2  +=  mS2*z1*z1 ;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :     fNDF  += 2;</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     N+=1;</span>
<span class="lineNum">     306 </span>            :     
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :     fP[1] += k11 * z1;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :     fP[3] += k31 * z1;</span>
<span class="lineNum">     309 </span>            :     
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :     fC[ 7] -= k31 * c11;</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :     fC[ 2] -= k11 * c11;</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :     fC[ 9] -= k31 * c31;    </span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   } </span>
<a name="314"><span class="lineNum">     314 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span>            : GPUd() bool AliHLTTPCGMTrackParam::CheckNumericalQuality() const
<span class="lineNum">     317 </span>            : {
<span class="lineNum">     318 </span>            :   //* Check that the track parameters and covariance matrix are reasonable
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :   bool ok = AliHLTTPCCAMath::Finite(fX) &amp;&amp; AliHLTTPCCAMath::Finite( fChi2 ) &amp;&amp; AliHLTTPCCAMath::Finite( fNDF );</span>
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :   const float *c = fC;</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :   for ( int i = 0; i &lt; 15; i++ ) ok = ok &amp;&amp; AliHLTTPCCAMath::Finite( c[i] );</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :   for ( int i = 0; i &lt; 5; i++ ) ok = ok &amp;&amp; AliHLTTPCCAMath::Finite( fP[i] );</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   if ( c[0] &lt;= 0 || c[2] &lt;= 0 || c[5] &lt;= 0 || c[9] &lt;= 0 || c[14] &lt;= 0 ) ok = 0;</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :   if ( c[0] &gt; 5. || c[2] &gt; 5. || c[5] &gt; 2. || c[9] &gt; 2. </span>
<span class="lineNum">     328 </span>            :        //|| ( CAMath::Abs( QPt() ) &gt; 1.e-2 &amp;&amp; c[14] &gt; 2. ) 
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :        ) ok = 0;</span>
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :   if ( fabs( fP[2] ) &gt; .999 ) ok = 0;</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :   if ( fabs( fP[4] ) &gt; 1. / 0.05 ) ok = 0;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   if( ok ){</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     ok = ok </span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[1]*c[1]&lt;=c[2]*c[0] )</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[3]*c[3]&lt;=c[5]*c[0] )</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[4]*c[4]&lt;=c[5]*c[2] )</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[6]*c[6]&lt;=c[9]*c[0] )</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[7]*c[7]&lt;=c[9]*c[2] )</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[8]*c[8]&lt;=c[9]*c[5] )</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[10]*c[10]&lt;=c[14]*c[0] )</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[11]*c[11]&lt;=c[14]*c[2] )</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[12]*c[12]&lt;=c[14]*c[5] )</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :       &amp;&amp; ( c[13]*c[13]&lt;=c[14]*c[9] );      </span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :   return ok;</span>
<span class="lineNum">     347 </span>            : }
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span>            : //*
<span class="lineNum">     350 </span>            : //*  Multiple scattering and energy losses
<a name="351"><span class="lineNum">     351 </span>            : //*</a>
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span>            : GPUd() float AliHLTTPCGMTrackParam::ApproximateBetheBloch( float beta2 )
<span class="lineNum">     354 </span>            : {
<span class="lineNum">     355 </span>            :   //------------------------------------------------------------------
<span class="lineNum">     356 </span>            :   // This is an approximation of the Bethe-Bloch formula with
<span class="lineNum">     357 </span>            :   // the density effect taken into account at beta*gamma &gt; 3.5
<span class="lineNum">     358 </span>            :   // (the approximation is reasonable only for solid materials)
<span class="lineNum">     359 </span>            :   //------------------------------------------------------------------
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :   const float log0 = log( float(5940.f));</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :   const float log1 = log( float(3.5f*5940.f) );</span>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :   bool bad = (beta2 &gt;= .999f)||( beta2 &lt; 1.e-8f );</span>
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   Assign( beta2, bad, 0.5f);</span>
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :   float a = beta2 / ( 1.f - beta2 ); </span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :   float b = 0.5*log(a);</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :   float d =  0.153e-3 / beta2;</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   float c = b - beta2;</span>
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :   float ret = d*(log0 + b + c );</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :   float case1 = d*(log1 + c );</span>
<span class="lineNum">     375 </span>            :   
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :   Assign( ret, ( a &gt; 3.5*3.5  ), case1);</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :   Assign( ret,  bad, 0. ); </span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :   return ret;</span>
<a name="380"><span class="lineNum">     380 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span>            :  GPUd() void AliHLTTPCGMTrackParam::CalculateFitParameters( AliHLTTPCGMTrackFitParam &amp;par, float RhoOverRadLen,  float Rho, bool NoField, float mass )
<span class="lineNum">     383 </span>            : {
<span class="lineNum">     384 </span>            :   //*!
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   float qpt = fP[4];</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :   if( NoField ) qpt = 1./0.35;</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :   float p2 = ( 1. + fP[3] * fP[3] );</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :   float k2 = qpt * qpt;</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :   Assign( k2, (  k2 &lt; 1.e-4f ), 1.e-4f );</span>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :   float mass2 = mass * mass;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :   float beta2 = p2 / ( p2 + mass2 * k2 );</span>
<span class="lineNum">     395 </span>            :   
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :   float pp2 = p2 / k2; // impuls 2</span>
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span>            :   //par.fBethe = BetheBlochGas( pp2/mass2);
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :   par.fBetheRho = ApproximateBetheBloch( pp2 / mass2 )*Rho;</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :   par.fE = sqrt( pp2 + mass2 );</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :   par.fTheta2 = ( 14.1*14.1/1.e6 ) / ( beta2 * pp2 )*RhoOverRadLen;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :   par.fEP2 = par.fE / pp2;</span>
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span>            :   // Approximate energy loss fluctuation (M.Ivanov)
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span>            :   const float knst = 0.07; // To be tuned.
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :   par.fSigmadE2 = knst * par.fEP2 * qpt;</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :   par.fSigmadE2 = par.fSigmadE2 * par.fSigmadE2;</span>
<span class="lineNum">     409 </span>            :   
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :   float k22 = 1. + fP[3] * fP[3];</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :   par.fK22 = par.fTheta2*k22;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :   par.fK33 = par.fK22 * k22;</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :   par.fK43 = 0.;</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :   par.fK44 =  par.fTheta2*fP[3] * fP[3] * k2;</span>
<span class="lineNum">     415 </span>            :   
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :   float br=1.e-8f;</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :   Assign( br, ( par.fBetheRho&gt;1.e-8f ), par.fBetheRho );</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :   par.fDLMax = 0.3*par.fE * Reciprocal( br );</span>
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :   par.fEP2*=par.fBetheRho;</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :   par.fSigmadE2 = par.fSigmadE2*par.fBetheRho+par.fK44;  </span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span>            : 
<span class="lineNum">     427 </span>            : //*
<span class="lineNum">     428 </span>            : //* Rotation
<span class="lineNum">     429 </span>            : //*
<a name="430"><span class="lineNum">     430 </span>            : </a>
<span class="lineNum">     431 </span>            : 
<span class="lineNum">     432 </span>            : GPUd() bool AliHLTTPCGMTrackParam::Rotate( float alpha, AliHLTTPCGMTrackLinearisation &amp;t0, float maxSinPhi )
<span class="lineNum">     433 </span>            : {
<span class="lineNum">     434 </span>            :   //* Rotate the coordinate system in XY on the angle alpha
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :   float cA = CAMath::Cos( alpha );</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :   float sA = CAMath::Sin( alpha );</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :   float x0 = X(), y0 = Y(), sP = t0.SinPhi(), cP = t0.CosPhi();</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :   float cosPhi = cP * cA + sP * sA;</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :   float sinPhi = -cP * sA + sP * cA;</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :   if ( CAMath::Abs( sinPhi ) &gt; maxSinPhi || CAMath::Abs( cosPhi ) &lt; 1.e-2 || CAMath::Abs( cP ) &lt; 1.e-2  ) return 0;</span>
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span>            :   //float J[5][5] = { { j0, 0, 0,  0,  0 }, // Y
<span class="lineNum">     445 </span>            :   //                    {  0, 1, 0,  0,  0 }, // Z
<span class="lineNum">     446 </span>            :   //                    {  0, 0, j2, 0,  0 }, // SinPhi
<span class="lineNum">     447 </span>            :   //                  {  0, 0, 0,  1,  0 }, // DzDs
<span class="lineNum">     448 </span>            :   //                  {  0, 0, 0,  0,  1 } }; // Kappa
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :   float j0 = cP / cosPhi;</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :   float j2 = cosPhi / cP;</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   float d[2] = {Y() - y0, SinPhi() - sP};</span>
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   X() = ( x0*cA +  y0*sA );</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :   Y() = ( -x0*sA +  y0*cA + j0*d[0] );</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :   t0.CosPhi() = fabs( cosPhi );</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :   t0.SecPhi() = ( 1./t0.CosPhi() );</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   t0.SinPhi() = ( sinPhi );</span>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :   SinPhi() = ( sinPhi + j2*d[1] );</span>
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :   fC[0] *= j0 * j0;</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :   fC[1] *= j0;</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :   fC[3] *= j0;</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :   fC[6] *= j0;</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :   fC[10] *= j0;</span>
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :   fC[3] *= j2;</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :   fC[4] *= j2;</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :   fC[5] *= j2 * j2;</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :   fC[8] *= j2;</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :   fC[12] *= j2;</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :   if( cosPhi &lt;0 ){ // change direction</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     t0.SinPhi() = -sinPhi;</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :     t0.DzDs() = -t0.DzDs();</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     t0.DlDs() = -t0.DlDs();</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :     t0.QPt() = -t0.QPt();</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     SinPhi() = -SinPhi();</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :     DzDs() = -DzDs();</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :     QPt() = -QPt();</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :     fC[3] = -fC[3];</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :     fC[4] = -fC[4];</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :     fC[6] = -fC[6];</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :     fC[7] = -fC[7];</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :     fC[10] = -fC[10];</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :     fC[11] = -fC[11];</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span>            :   return 1;
<span class="lineNum">     490 </span><span class="lineNoCov">          0 : }</span>
<a name="491"><span class="lineNum">     491 </span>            : </a>
<span class="lineNum">     492 </span>            : #if !defined(HLTCA_STANDALONE) &amp; !defined(HLTCA_GPUCODE)
<span class="lineNum">     493 </span>            : bool AliHLTTPCGMTrackParam::GetExtParam( AliExternalTrackParam &amp;T, double alpha ) const
<span class="lineNum">     494 </span>            : {
<span class="lineNum">     495 </span>            :   //* Convert from AliHLTTPCGMTrackParam to AliExternalTrackParam parameterisation,
<span class="lineNum">     496 </span>            :   //* the angle alpha is the global angle of the local X axis
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :   bool ok = CheckNumericalQuality();</span>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :   double par[5], cov[15];</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :   for ( int i = 0; i &lt; 5; i++ ) par[i] = fP[i];</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :   for ( int i = 0; i &lt; 15; i++ ) cov[i] = fC[i];</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :   if ( par[2] &gt; .99 ) par[2] = .99;</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :   if ( par[2] &lt; -.99 ) par[2] = -.99;</span>
<span class="lineNum">     506 </span>            : 
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :   if ( fabs( par[4] ) &lt; 1.e-5 ) par[4] = 1.e-5; // some other software will crash if q/Pt==0</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :   if ( fabs( par[4] ) &gt; 1./0.08 ) ok = 0; // some other software will crash if q/Pt is too big</span>
<span class="lineNum">     509 </span>            : 
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :   T.Set( (double) fX, alpha, par, cov );</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :   return ok;</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     513 </span>            : 
<a name="514"><span class="lineNum">     514 </span>            : </a>
<span class="lineNum">     515 </span>            :  
<span class="lineNum">     516 </span>            : void AliHLTTPCGMTrackParam::SetExtParam( const AliExternalTrackParam &amp;T )
<span class="lineNum">     517 </span>            : {
<span class="lineNum">     518 </span>            :   //* Convert from AliExternalTrackParam parameterisation
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :   for ( int i = 0; i &lt; 5; i++ ) fP[i] = T.GetParameter()[i];</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :   for ( int i = 0; i &lt; 15; i++ ) fC[i] = T.GetCovariance()[i];</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :   fX = T.GetX();</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :   if ( fP[2] &gt; .999 ) fP[2] = .999;</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :   if ( fP[2] &lt; -.999 ) fP[2] = -.999;</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     526 </span>            : #endif
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span>            : #ifdef HLTCA_GPUCODE
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span>            : #include &quot;AliHLTTPCGMMergedTrack.h&quot;
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span>            : GPUg() void RefitTracks(AliHLTTPCGMMergedTrack* tracks, int nTracks, float* PolinomialFieldBz, float* x, float* y, float* z, unsigned int* rowType, float* alpha, AliHLTTPCCAParam* param)
<span class="lineNum">     533 </span>            : {
<span class="lineNum">     534 </span>            :         for (int i = get_global_id(0);i &lt; nTracks;i += get_global_size(0))
<span class="lineNum">     535 </span>            :         {
<span class="lineNum">     536 </span>            :                 //This is in fact a copy of ReFit() in AliHLTTPCGMMerger.cxx
<span class="lineNum">     537 </span>            :                 AliHLTTPCGMMergedTrack&amp; track = tracks[i];
<span class="lineNum">     538 </span>            :                 float Alpha = track.Alpha();
<span class="lineNum">     539 </span>            :                 int N = track.NClusters();
<span class="lineNum">     540 </span>            :                 AliHLTTPCGMTrackParam t = track.Param();
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span>            :                 t.Fit(PolinomialFieldBz,
<span class="lineNum">     543 </span>            :                         x+track.FirstClusterRef(),
<span class="lineNum">     544 </span>            :                         y+track.FirstClusterRef(),
<span class="lineNum">     545 </span>            :                         z+track.FirstClusterRef(),
<span class="lineNum">     546 </span>            :                         rowType+track.FirstClusterRef(),
<span class="lineNum">     547 </span>            :                         alpha+track.FirstClusterRef(),
<span class="lineNum">     548 </span>            :                         *param,
<span class="lineNum">     549 </span>            :                         N,
<span class="lineNum">     550 </span>            :                         Alpha,
<span class="lineNum">     551 </span>            :                         0
<span class="lineNum">     552 </span>            :                         );
<span class="lineNum">     553 </span>            : 
<span class="lineNum">     554 </span>            :                 if ( fabs( t.QPt() ) &lt; 1.e-4 ) t.QPt() = 1.e-4 ;
<span class="lineNum">     555 </span>            :                 
<span class="lineNum">     556 </span>            :                 bool ok = N &gt;= 30 &amp;&amp; t.CheckNumericalQuality() &amp;&amp; fabs( t.SinPhi() ) &lt;= .999;
<span class="lineNum">     557 </span>            :                 track.SetOK(ok);
<span class="lineNum">     558 </span>            :                 if( !ok ) continue;
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span>            :                 if( 1 ){//SG!!!
<span class="lineNum">     561 </span>            :                   track.SetNClusters( N );
<span class="lineNum">     562 </span>            :                   track.Param() = t;
<span class="lineNum">     563 </span>            :                   track.Alpha() = Alpha;
<span class="lineNum">     564 </span>            :                 }
<span class="lineNum">     565 </span>            : 
<span class="lineNum">     566 </span>            :                 {
<span class="lineNum">     567 </span>            :                   int ind = track.FirstClusterRef();
<span class="lineNum">     568 </span>            :                   float alphaalpha = alpha[ind];
<span class="lineNum">     569 </span>            :                   float xx = x[ind];
<span class="lineNum">     570 </span>            :                   float yy = y[ind];
<span class="lineNum">     571 </span>            :                   float zz = z[ind];
<span class="lineNum">     572 </span>            :                   float sinA = AliHLTTPCCAMath::Sin( alphaalpha - track.Alpha());
<span class="lineNum">     573 </span>            :                   float cosA = AliHLTTPCCAMath::Cos( alphaalpha - track.Alpha());
<span class="lineNum">     574 </span>            :                   track.SetLastX( xx*cosA - yy*sinA );
<span class="lineNum">     575 </span>            :                   track.SetLastY( xx*sinA + yy*cosA );
<span class="lineNum">     576 </span>            :                   track.SetLastZ( zz );
<span class="lineNum">     577 </span>            :                 }
<span class="lineNum">     578 </span>            :         }
<span class="lineNum">     579 </span>            : }
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span>            : #endif
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
