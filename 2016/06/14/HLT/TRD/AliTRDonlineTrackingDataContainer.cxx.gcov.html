<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - HLT/TRD/AliTRDonlineTrackingDataContainer.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">HLT/TRD</a> - AliTRDonlineTrackingDataContainer.cxx<span style="font-size: 80%;"> (source / <a href="AliTRDonlineTrackingDataContainer.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">306</td>
            <td class="headerCovTableEntryLo">0.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">50</td>
            <td class="headerCovTableEntryLo">2.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : #include &lt;cstdlib&gt;</a>
<span class="lineNum">       2 </span>            : #include &quot;TString.h&quot;
<span class="lineNum">       3 </span>            : #include &quot;AliHLTLogging.h&quot;
<span class="lineNum">       4 </span>            : #include &quot;AliTRDonlineTrackingDataContainer.h&quot;
<a name="5"><span class="lineNum">       5 </span>            : </a>
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span><span class="lineCov">          6 : ClassImp(AliTRDonlineTrackingDataContainer)</span>
<span class="lineNum">       8 </span>            : 
<a name="9"><span class="lineNum">       9 </span>            : const Float_t AliTRDonlineTrackingDataContainer::fgkBinWidthY   = 160e-4; // 160 um</a>
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span><span class="lineNoCov">          0 : AliTRDonlineTrackingDataContainer::AliTRDonlineTrackingDataContainer() : AliHLTLogging(),</span>
<span class="lineNum">      12 </span><span class="lineNoCov">          0 :   fGtuPtMultiplier(1.),</span>
<span class="lineNum">      13 </span><span class="lineNoCov">          0 :   fStoreGtuInfo(kTRUE),</span>
<span class="lineNum">      14 </span><span class="lineNoCov">          0 :   fLogPrefix(NULL)</span>
<span class="lineNum">      15 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      16 </span><span class="lineNoCov">          0 :   fLogPrefix = new TString(&quot;&quot;);</span>
<span class="lineNum">      17 </span><span class="lineNoCov">          0 :   Clear();</span>
<a name="18"><span class="lineNum">      18 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span><span class="lineNoCov">          0 : AliTRDonlineTrackingDataContainer::AliTRDonlineTrackingDataContainer(const AliTRDonlineTrackingDataContainer&amp; /*cont*/) : AliHLTLogging(),</span>
<span class="lineNum">      21 </span><span class="lineNoCov">          0 :   fGtuPtMultiplier(1.),</span>
<span class="lineNum">      22 </span><span class="lineNoCov">          0 :   fStoreGtuInfo(kTRUE),</span>
<span class="lineNum">      23 </span><span class="lineNoCov">          0 :   fLogPrefix(NULL)</span>
<span class="lineNum">      24 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      25 </span><span class="lineNoCov">          0 :   fLogPrefix = new TString(&quot;&quot;);</span>
<span class="lineNum">      26 </span><span class="lineNoCov">          0 :   Clear();</span>
<a name="27"><span class="lineNum">      27 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span><span class="lineNoCov">          0 : AliTRDonlineTrackingDataContainer::~AliTRDonlineTrackingDataContainer(){</span>
<span class="lineNum">      30 </span><span class="lineNoCov">          0 :   if (fLogPrefix)</span>
<span class="lineNum">      31 </span><span class="lineNoCov">          0 :     delete fLogPrefix;</span>
<span class="lineNum">      32 </span><span class="lineNoCov">          0 :   fLogPrefix = NULL;</span>
<a name="33"><span class="lineNum">      33 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : void AliTRDonlineTrackingDataContainer::Clear(const Option_t*) {
<span class="lineNum">      36 </span><span class="lineNoCov">          0 :   memset(fNumTracklets, 0, sizeof(UInt_t)*fgkNumChambers);</span>
<span class="lineNum">      37 </span><span class="lineNoCov">          0 :   memset(fNumTracks, 0, sizeof(UInt_t)*fgkNumStacks);</span>
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span><span class="lineNoCov">          0 :   memset(fSectorTrgWords, 0, sizeof(UInt_t)*fgkNumSectors);</span>
<span class="lineNum">      40 </span><span class="lineNoCov">          0 :   memset(fStackTrgWords, 0, sizeof(ULong64_t)*fgkNumSectors*fgkNumStacksPerSector);</span>
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            :   //## todo: only for debugging, may be removed without harm
<span class="lineNum">      43 </span>            : //  memset(fTrackletWords, 0, sizeof(UInt_t)*fgkNumChambers*fgkMaxTrackletsPerChamber);
<span class="lineNum">      44 </span>            : //  memset(fTrackletHCId, 0, sizeof(UInt_t)*fgkNumChambers*fgkMaxTrackletsPerChamber);
<span class="lineNum">      45 </span>            : //  memset(fTrackWords, 0, sizeof(ULong64_t)*fgkNumStacks*fgkMaxTracksPerStack);
<span class="lineNum">      46 </span>            : //  memset(fTrackExtWords, 0, sizeof(ULong64_t)*fgkNumStacks*fgkMaxTracksPerStack);
<span class="lineNum">      47 </span>            : //  memset(fTrackTrackletWords, 0, sizeof(UInt_t)*fgkNumStacks*fgkMaxTracksPerStack*fgkNumLayers);
<a name="48"><span class="lineNum">      48 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetNumTracklets() {
<span class="lineNum">      51 </span>            :   Int_t count = 0;
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   for (UShort_t det = 0; det &lt; fgkNumChambers; ++det)</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :     count += fNumTracklets[det];</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :   return count;</span>
<a name="55"><span class="lineNum">      55 </span>            : }</a>
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetNumTracklets(UInt_t det) {
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :   return fNumTracklets[det];</span>
<a name="59"><span class="lineNum">      59 </span>            : }</a>
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetNumTracks() {
<span class="lineNum">      62 </span>            :   Int_t count = 0;
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :   for (UShort_t stack = 0; stack &lt; fgkNumStacks; ++stack)</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :     count += fNumTracks[stack];</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   return count;</span>
<a name="66"><span class="lineNum">      66 </span>            : }</a>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetNumTracks(UShort_t stack){
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :   return fNumTracks[stack];</span>
<a name="70"><span class="lineNum">      70 </span>            : }</a>
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetTrackletBinY(UInt_t det, UInt_t trackletIndex) {
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :   UInt_t trackletWord = fTrackletWords[det][trackletIndex];</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :   if (trackletWord &amp; 0x1000) {</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :     return -((~(trackletWord - 1)) &amp; 0x1fff);</span>
<span class="lineNum">      76 </span>            :   }
<span class="lineNum">      77 </span>            :   else {
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :     return (trackletWord &amp; 0x1fff);</span>
<span class="lineNum">      79 </span>            :   }
<a name="80"><span class="lineNum">      80 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetTrackletBinDy(UInt_t det, UInt_t trackletIndex) {
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :   UInt_t trackletWord = fTrackletWords[det][trackletIndex];</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :   if (trackletWord &amp; (1 &lt;&lt; 19))</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :     return -((~((trackletWord &gt;&gt; 13) - 1)) &amp; 0x7f);</span>
<span class="lineNum">      86 </span>            :   else
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :     return ((trackletWord &gt;&gt; 13) &amp; 0x7f);</span>
<a name="88"><span class="lineNum">      88 </span><span class="lineNoCov">          0 : };</span></a>
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetTrackletBinZ(UInt_t det, UInt_t trackletIndex) {
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :   return ((fTrackletWords[det][trackletIndex] &gt;&gt; 20) &amp; 0xf);</span>
<a name="92"><span class="lineNum">      92 </span>            : }</a>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetTrackletPID(UInt_t det, UInt_t trackletIndex) {
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :   return ((fTrackletWords[det][trackletIndex] &gt;&gt; 24) &amp; 0xff);</span>
<a name="96"><span class="lineNum">      96 </span>            : };</a>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            : Float_t AliTRDonlineTrackingDataContainer::GetTrackletLocalY(UInt_t det, UInt_t trackletIndex) {
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :   return GetTrackletBinY(det, trackletIndex) * fgkBinWidthY;</span>
<a name="100"><span class="lineNum">     100 </span>            : }</a>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span>            : AliESDTrdTracklet* AliTRDonlineTrackingDataContainer::GetTracklet(UInt_t det, UInt_t trackletIndex) {
<span class="lineNum">     103 </span>            :   AliESDTrdTracklet* trkl = NULL;
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :   if ((det &lt; fgkNumChambers) &amp;&amp; (trackletIndex &lt; fNumTracklets[det])){</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :     trkl = new AliESDTrdTracklet(fTrackletWords[det][trackletIndex], fTrackletHCId[det][trackletIndex], -1);</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :   return trkl;</span>
<a name="108"><span class="lineNum">     108 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            : AliESDTrdTrack* AliTRDonlineTrackingDataContainer::GetTrack(UInt_t stack, UInt_t trackIndex, Bool_t constructTracklets){
<span class="lineNum">     111 </span>            :   AliESDTrdTrack* trk = NULL;
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :   if ((stack &lt; fgkNumStacks) &amp;&amp; (trackIndex &lt; fNumTracks[stack])){</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     trk = new AliESDTrdTrack();</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :     ULong64_t tw = fTrackWords[stack][trackIndex];</span>
<span class="lineNum">     115 </span>            :     ULong64_t etw = fTrackWords[stack][trackIndex];
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     trk-&gt;SetLayerMask(GetTrackLayerMask(stack, trackIndex));</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :     trk-&gt;SetA(GetTrackA(stack, trackIndex));</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     trk-&gt;SetB( (((tw &gt;&gt; 20) &amp; 0x3ffff) ^ 0x20000) - 0x20000);</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :     trk-&gt;SetC( (((tw &gt;&gt; 8)  &amp;  0xffff) ^  0x8000) -  0x8000);</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :     trk-&gt;SetPID(GetTrackPID(stack, trackIndex));</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :     trk-&gt;SetSector(stack/5);</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :     trk-&gt;SetStack(stack%5);</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :     trk-&gt;SetLabel(-3);</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     trk-&gt;SetFlags((etw &gt;&gt; 52) &amp; 0x7ff);</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     trk-&gt;SetReserved((etw &gt;&gt; 49) &amp; 0x7);</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     trk-&gt;SetY((etw &gt;&gt; 36) &amp; 0x1fff);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :     trk-&gt;SetTrackletIndex((etw &gt;&gt;  0) &amp; 0x3f, 0);</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     trk-&gt;SetTrackletIndex((etw &gt;&gt;  6) &amp; 0x3f, 1);</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     trk-&gt;SetTrackletIndex((etw &gt;&gt; 12) &amp; 0x3f, 2);</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :     trk-&gt;SetTrackletIndex((etw &gt;&gt; 18) &amp; 0x3f, 3);</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :     trk-&gt;SetTrackletIndex((etw &gt;&gt; 24) &amp; 0x3f, 4);</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :     trk-&gt;SetTrackletIndex((etw &gt;&gt; 30) &amp; 0x3f, 5);</span>
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :     if (constructTracklets) {</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :       for (UShort_t iLayer = 0; iLayer &lt; fgkNumLayers; ++iLayer){</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :         AliESDTrdTracklet * trkl = new AliESDTrdTracklet(GetTrackTrackletWord(stack, trackIndex, iLayer), 2*(stack*6 + iLayer));</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         trk-&gt;AddTrackletReference(trkl, iLayer);</span>
<span class="lineNum">     138 </span>            :       }
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :     HLTError(&quot;invalid stack (%d) or track index (%d) in GetTrack&quot;, stack, trackIndex);</span>
<span class="lineNum">     143 </span>            :   }
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :   return trk;</span>
<a name="145"><span class="lineNum">     145 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     146 </span>            : 
<span class="lineNum">     147 </span>            : Double_t AliTRDonlineTrackingDataContainer::GetTrackPt(UInt_t stack, UInt_t trackIndex){
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span>            :   // calculate pt from a as done in hardware
<span class="lineNum">     150 </span>            :   const Int_t maskIdLut[64] = {
<span class="lineNum">     151 </span>            :     -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  0,
<span class="lineNum">     152 </span>            :     -1, -1, -1, -1, -1, -1, -1,  1, -1, -1, -1,  2, -1,  3,  4,  5,
<span class="lineNum">     153 </span>            :     -1, -1, -1, -1, -1, -1, -1,  6, -1, -1, -1,  7, -1,  8,  9, 10,
<span class="lineNum">     154 </span>            :     -1, -1, -1, 11, -1, 12, 13, 14, -1, 15, 16, 17, 18, 19, 20, 21
<span class="lineNum">     155 </span>            :   };
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span>            :   const Int_t c1Lut[32] = {
<span class="lineNum">     158 </span>            :     -2371, -2474, -2474, -2474, -2563, -2448, -2578, -2578,
<span class="lineNum">     159 </span>            :     -2578, -2670, -2557, -2578, -2578, -2670, -2557, -2578,
<span class="lineNum">     160 </span>            :     -2670, -2557, -2763, -2557, -2644, -2523,    -1,    -1,
<span class="lineNum">     161 </span>            :     -1,    -1,    -1,    -1,    -1,    -1,    -1,    -1
<span class="lineNum">     162 </span>            :   };
<span class="lineNum">     163 </span>            : 
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :   Int_t a = GetTrackA(stack, trackIndex);</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   UShort_t lm = GetTrackLayerMask(stack, trackIndex);</span>
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :   if (a != 0) {</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :     Int_t layerMaskId = maskIdLut[lm];</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :     Int_t c1 = c1Lut[layerMaskId];</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :     Int_t c1Ext = c1 &lt;&lt; 8;</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :     Int_t ptRawStage4 = c1Ext / ((a &gt;&gt; 2) != 0 ? (a &gt;&gt; 2) : 1 );</span>
<span class="lineNum">     172 </span>            :     Int_t ptRawComb4 = ptRawStage4;
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :     Int_t ptExtComb4 = (ptRawComb4 &gt; 0) ? ptRawComb4 + 33 : ptRawComb4 - 30;</span>
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     return ((-ptExtComb4/2) / 128.) * fGtuPtMultiplier;</span>
<span class="lineNum">     176 </span>            :   }
<span class="lineNum">     177 </span>            :   else
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :     return 0.;</span>
<span class="lineNum">     179 </span>            : 
<a name="180"><span class="lineNum">     180 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span>            : UShort_t AliTRDonlineTrackingDataContainer::GetTrackLayerNum(UInt_t stack, UInt_t trackIndex) {
<span class="lineNum">     183 </span>            :   UShort_t num = 0;
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   UShort_t layerMask = GetTrackLayerMask(stack, trackIndex);</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   for (UShort_t iLayer = 0; iLayer &lt; fgkNumLayers; ++iLayer)</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :     if ((layerMask &gt;&gt; iLayer) &amp; 1)</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :       num++;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   return num;</span>
<a name="189"><span class="lineNum">     189 </span>            : }</a>
<span class="lineNum">     190 </span>            : 
<span class="lineNum">     191 </span>            : UInt_t AliTRDonlineTrackingDataContainer::GetTrackTrackletWord(UInt_t stack, UInt_t trackIndex, UShort_t layer) {
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :   return fTrackTrackletWords[stack][trackIndex][layer];</span>
<span class="lineNum">     193 </span>            : }
<a name="194"><span class="lineNum">     194 </span>            : </a>
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetTrackTrackletBinY(UInt_t stack, UInt_t trackIndex, UShort_t layer) {
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   UInt_t trackletWord = fTrackTrackletWords[stack][trackIndex][layer];</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :   if (trackletWord &amp; 0x1000) {</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     return -((~(trackletWord - 1)) &amp; 0x1fff);</span>
<span class="lineNum">     200 </span>            :   }
<span class="lineNum">     201 </span>            :   else {
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     return (trackletWord &amp; 0x1fff);</span>
<span class="lineNum">     203 </span>            :   }
<a name="204"><span class="lineNum">     204 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetTrackAddInfo(UShort_t stack, UInt_t trackIndex) {
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :   return fTrackAddInfo[stack][trackIndex];</span>
<a name="208"><span class="lineNum">     208 </span>            : }</a>
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span>            : Float_t AliTRDonlineTrackingDataContainer::GetTrackTrackletLocalY(UInt_t stack, UInt_t trackIndex, UShort_t layer) {
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :   return GetTrackTrackletBinY(stack, trackIndex, layer) * fgkBinWidthY;</span>
<a name="212"><span class="lineNum">     212 </span>            : }</a>
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span>            : Int_t AliTRDonlineTrackingDataContainer::GetTrackTrackletBinZ(UInt_t stack, UInt_t trackIndex, UShort_t layer) {
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :   return ((fTrackTrackletWords[stack][trackIndex][layer] &gt;&gt; 20) &amp; 0xf);</span>
<a name="216"><span class="lineNum">     216 </span>            : }</a>
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span>            : UShort_t AliTRDonlineTrackingDataContainer::GetTrackTrackletPID(UInt_t stack, UInt_t trackIndex, UShort_t layer) {
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   return ((fTrackTrackletWords[stack][trackIndex][layer] &gt;&gt; 24) &amp; 0xff);</span>
<a name="220"><span class="lineNum">     220 </span>            : }</a>
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span>            : Int_t AliTRDonlineTrackingDataContainer::AddTracklet(UInt_t HCId, UInt_t trackletWord) {
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :   UShort_t det = HCId/2;</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :   Int_t pos = fNumTracklets[det]++;</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :   fTrackletWords[det][pos] = trackletWord;</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   fTrackletHCId[det][pos] = HCId;</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :   return pos;</span>
<a name="228"><span class="lineNum">     228 </span>            : }</a>
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span>            : Int_t AliTRDonlineTrackingDataContainer::AddTracklet(const AliESDTrdTracklet* tracklet) {
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :   return AddTracklet(tracklet-&gt;GetHCId(), tracklet-&gt;GetTrackletWord());</span>
<a name="232"><span class="lineNum">     232 </span>            : }</a>
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span>            : Int_t AliTRDonlineTrackingDataContainer::AddTrack(UShort_t stack,
<span class="lineNum">     235 </span>            :                                                   ULong64_t trackWord, ULong64_t extTrackWord,
<span class="lineNum">     236 </span>            :                                                   const UInt_t trackletWords[6], const Int_t addInfo){
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :   Int_t pos = fNumTracks[stack]++;</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :   fTrackWords[stack][pos] = trackWord;</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :   fTrackExtWords[stack][pos] = extTrackWord;</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :   fTrackAddInfo[stack][pos] = addInfo;</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :   for (UShort_t iLayer = 0; iLayer &lt; fgkNumLayers; ++iLayer){</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     fTrackTrackletWords[stack][pos][iLayer] = trackletWords[iLayer];</span>
<span class="lineNum">     243 </span>            :   }
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :   return pos;</span>
<a name="245"><span class="lineNum">     245 </span>            : }</a>
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span>            : Int_t AliTRDonlineTrackingDataContainer::AddTrack(const AliESDTrdTrack* track, Int_t addInfo) {
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :   UInt_t trackletWords[fgkNumLayers];</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :   UShort_t lm = track-&gt;GetLayerMask();</span>
<span class="lineNum">     251 </span>            :   Bool_t checkOk = kTRUE;
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :   for (UShort_t iLayer = 0; iLayer &lt; fgkNumLayers; ++iLayer){</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :     if ((lm &gt;&gt; iLayer) &amp; 1){</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :       if (track-&gt;GetTracklet(iLayer))</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :         trackletWords[iLayer] = track-&gt;GetTracklet(iLayer)-&gt;GetTrackletWord();</span>
<span class="lineNum">     256 </span>            :       else
<span class="lineNum">     257 </span>            :         checkOk = kFALSE;  // inconsistency between layer mask and tracklet pointers: do not use this track
<span class="lineNum">     258 </span>            :     } else
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :       trackletWords[iLayer] = fgkInvalidTrackletWord;</span>
<span class="lineNum">     260 </span>            :   }
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :   if (checkOk){</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :     return AddTrack(track-&gt;GetSector()*5 + track-&gt;GetStack(),</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :                     track-&gt;GetTrackWord(0), track-&gt;GetExtendedTrackWord(0), trackletWords, addInfo);</span>
<span class="lineNum">     265 </span>            :   } else {
<span class="lineNum">     266 </span>            :     // DbgLog(&quot;ERROR&quot;, &quot;Ignoring GTU track with inconsistency between layer mask and tracklet pointers&quot;);
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     printf(&quot;&lt;ERROR&gt; Ignoring GTU track with inconsistency between layer mask and tracklet pointers\n&quot;);</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     return -1;</span>
<span class="lineNum">     269 </span>            :   }
<span class="lineNum">     270 </span>            : 
<a name="271"><span class="lineNum">     271 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span>            : void AliTRDonlineTrackingDataContainer::SetTrackAddInfo(UShort_t stack, UInt_t trackIndex, Int_t addInfo) {
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :   fTrackAddInfo[stack][trackIndex] = addInfo;</span>
<a name="275"><span class="lineNum">     275 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span>            : void AliTRDonlineTrackingDataContainer::SetGtuPtMultiplierFromMagField(Double_t magField) {
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   if (magField &gt; 0)</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     fGtuPtMultiplier = -1.;</span>
<span class="lineNum">     280 </span>            :   else
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :     fGtuPtMultiplier = 1.;</span>
<a name="282"><span class="lineNum">     282 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span>            : void AliTRDonlineTrackingDataContainer::PrintBuffer(const void* buffer, UInt_t sizeInBytes, const char* identifier) {
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :   UInt_t* buf = (UInt_t*)buffer;</span>
<span class="lineNum">     287 </span>            :   UInt_t currPos = 0;
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   TString str(&quot;&quot;);</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   TString ident(identifier);</span>
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :   HLTDebug(&quot;BUFFER DUMP for &lt;%s&gt;&quot;, ident.Data());
<span class="lineNum">     292 </span>            : 
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :   while (currPos &lt; sizeInBytes/4){</span>
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :     str = Form(&quot;%06d: 0x%08x  &quot;, currPos, buf[currPos]);</span>
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :     if (currPos == 0){  // leading magic constant</span>
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :       if (buf[currPos++] == fgkLeadingMagicConst)</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :         str += &quot;correct leading magic constant&quot;;</span>
<span class="lineNum">     301 </span>            :       else
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         str += Form(&quot;incorrect leading magic constant, should be 0x%08x&quot;,</span>
<span class="lineNum">     303 </span>            :                     fgkLeadingMagicConst);
<span class="lineNum">     304 </span>            :     }
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     if (currPos == sizeInBytes/4 - 1){</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :       if (buf[sizeInBytes/4 - 1] == fgkTrailingMagicConst)</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :         str += &quot;correct trailing magic constant&quot;;</span>
<span class="lineNum">     310 </span>            :       else
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         str += Form(&quot;incorrect trailing magic constant, should be 0x%08x&quot;,</span>
<span class="lineNum">     312 </span>            :                     fgkTrailingMagicConst);
<span class="lineNum">     313 </span>            :     }
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     currPos++;</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span>            :     HLTDebug(str.Data());
<span class="lineNum">     318 </span>            : 
<span class="lineNum">     319 </span>            :   }
<span class="lineNum">     320 </span>            : 
<a name="321"><span class="lineNum">     321 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span>            : void AliTRDonlineTrackingDataContainer::PrintSummary(const char* identifier){
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :   TString ident(identifier);</span>
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span>            :   HLTDebug(&quot;TRDGM AliTRDonlineTrackingDataContainer &lt;%s&gt; summary: %5d tracklets, %2d tracks, %6ld bytes comp. mem size&quot;,
<span class="lineNum">     328 </span>            :            ident.Data(), GetNumTracklets(), GetNumTracks(), DataWordsNeeded()*sizeof(UInt_t));
<span class="lineNum">     329 </span>            : 
<a name="330"><span class="lineNum">     330 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     331 </span>            : 
<span class="lineNum">     332 </span>            : inline UInt_t AliTRDonlineTrackingDataContainer::MakeDataHeader(){
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   if (fStoreGtuInfo)</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     return (fgkHeaderTypeData &lt;&lt; 28) | (1 &lt;&lt; 16) | DataWordsNeeded();</span>
<span class="lineNum">     335 </span>            :   else
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     return (fgkHeaderTypeData &lt;&lt; 28) | DataWordsNeeded();</span>
<a name="337"><span class="lineNum">     337 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span>            : inline UInt_t AliTRDonlineTrackingDataContainer::MakeStackHeader(UShort_t stack,
<span class="lineNum">     340 </span>            :                                                                  Bool_t trackletsPresent,
<span class="lineNum">     341 </span>            :                                                                  Bool_t tracksPresent,
<span class="lineNum">     342 </span>            :                                                                  UInt_t size){
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :   return</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :     (fgkHeaderTypeStack &lt;&lt; 28) |</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     (((tracksPresent) ? 1 : 0) &lt;&lt; 27) |</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     (((trackletsPresent) ? 1 : 0) &lt;&lt; 26) |</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :     ((stack &amp; 0xff) &lt;&lt; 16) | (size &amp; 0xffff);</span>
<a name="348"><span class="lineNum">     348 </span>            : }</a>
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span>            : inline Int_t AliTRDonlineTrackingDataContainer::StackFromStackHeader(UInt_t stackHeader) {
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :   return (stackHeader &gt;&gt; 16) &amp; 0xff;</span>
<a name="352"><span class="lineNum">     352 </span>            : }</a>
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span>            : inline UInt_t AliTRDonlineTrackingDataContainer::SizeFromStackHeader(UInt_t stackHeader) {
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :   return stackHeader &amp; 0xffff;</span>
<a name="356"><span class="lineNum">     356 </span>            : }</a>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            : inline UInt_t AliTRDonlineTrackingDataContainer::MakeTrackletHeader(UShort_t halfChamber){
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :   return (fgkHeaderTypeTracklet &lt;&lt; 28) | ((halfChamber &amp; 0xfff) &lt;&lt; 16) | 0x2;</span>
<a name="360"><span class="lineNum">     360 </span>            : }</a>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span>            : inline Int_t AliTRDonlineTrackingDataContainer::HCIdFromTrackletHeader(UInt_t trackletHeader) {
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :   return (trackletHeader &gt;&gt; 16) &amp; 0xfff;</span>
<a name="364"><span class="lineNum">     364 </span>            : }</a>
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span>            : inline UInt_t AliTRDonlineTrackingDataContainer::MakeTrackHeader(UShort_t stack){
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :   return (fgkHeaderTypeTrack &lt;&lt; 28) | ((stack &amp; 0xff) &lt;&lt; 16) | 12;</span>
<a name="368"><span class="lineNum">     368 </span>            : }</a>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span>            : inline UInt_t AliTRDonlineTrackingDataContainer::MakeGtuHeader(Bool_t storeInfo){
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   if (storeInfo)</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :     return (fgkHeaderTypeGtu &lt;&lt; 28) | (1 &lt;&lt; 16) | (1 + 18 + 2*90);</span>
<span class="lineNum">     373 </span>            :   else
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :     return (fgkHeaderTypeGtu &lt;&lt; 28) | 1;</span>
<a name="375"><span class="lineNum">     375 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span>            : inline Bool_t AliTRDonlineTrackingDataContainer::StoreGtuInfoFromDataHeader(UInt_t dataHeader){
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   return ((dataHeader &gt;&gt; 16) &amp; 1);</span>
<a name="379"><span class="lineNum">     379 </span>            : }</a>
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span>            : inline Bool_t AliTRDonlineTrackingDataContainer::GtuInfoPresentFromGtuHeader(UInt_t gtuHeader){
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :   return ((gtuHeader &gt;&gt; 16) &amp; 1);</span>
<a name="383"><span class="lineNum">     383 </span>            : }</a>
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span>            : inline UInt_t AliTRDonlineTrackingDataContainer::DataWordsNeeded() {
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span>            :   UInt_t size = 0;
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            :   size += 1;                              // leading magic word
<span class="lineNum">     390 </span>            :   size += 1;                              // overall data header
<span class="lineNum">     391 </span>            :   size += 90;                             // stack headers
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :   size += GetNumTracklets()*(1 + 1);      // tracklets (mark + trackword)</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :   size += GetNumTracks()*(1 + 4 + 1 + 6); // GTU tracks (mark + trackword[2] + exttrackword[2] + addInfo + 6*trackletword)</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :   size += 1;                              // crosscheck word</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :   size += 1;                              // trailing magic word</span>
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :   if (fStoreGtuInfo)</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     size += 1 + 18 + 2*90;                // trigger header + 18 sector trigger words, 90 stack tracking done words[2]</span>
<span class="lineNum">     399 </span>            :   else
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :     size += 1;                            // trigger header only</span>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :   return size;</span>
<a name="403"><span class="lineNum">     403 </span>            : }</a>
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span>            : inline UInt_t calcCheck(UInt_t prevCrc, UInt_t c) {
<span class="lineNum">     406 </span>            :   // CCITT 16 bit (X^16 + X^12 + X^5 + 1).
<span class="lineNum">     407 </span>            :   UInt_t crc = prevCrc;
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :   crc  = (unsigned char)(crc &gt;&gt; 8) | (crc &lt;&lt; 8);</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :   crc ^= c;</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :   crc ^= (unsigned char)(crc &amp; 0xff) &gt;&gt; 4;</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :   crc ^= (crc &lt;&lt; 8) &lt;&lt; 4;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :   crc ^= ((crc &amp; 0xff) &lt;&lt; 4) &lt;&lt; 1;</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :   return (crc);</span>
<a name="414"><span class="lineNum">     414 </span>            : }</a>
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            : Bool_t AliTRDonlineTrackingDataContainer::Compress(void* &amp;buffer, UInt_t &amp;sizeInBytes){
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span>            :   // TString ptrInfo(&quot;COMPRESS CALLED: [&quot;);
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :   UInt_t bufSize = sizeof(UInt_t)*DataWordsNeeded();</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :   UInt_t* buf = (UInt_t*)malloc(bufSize);</span>
<span class="lineNum">     422 </span>            :   UInt_t crosscheck = fgkCrosscheckSeed;
<span class="lineNum">     423 </span>            :   UInt_t lastStackHeaderPos;
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :   if (!buf){</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :     HLTError(&quot;Could not allocate %d bytes for buffer&quot;, bufSize);</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     428 </span>            :   }
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :   memset(buf, 0, bufSize);</span>
<span class="lineNum">     431 </span>            :   // ptrInfo += Form(&quot; memset(%p, 0, %d) -&gt; %p - %p, &quot;, buf, bufSize, buf, (char*)buf + bufSize);
<span class="lineNum">     432 </span>            :   UInt_t currPos = 0;
<span class="lineNum">     433 </span>            :   UInt_t det;
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span>            :   // ptrInfo += Form(&quot; lowest write addr: %p, &quot;, &amp;(buf[currPos]));
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :   buf[currPos++] = fgkLeadingMagicConst;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :   buf[currPos++] = MakeDataHeader();</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :   for (UShort_t iStack = 0; iStack &lt; 90; ++iStack){</span>
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span>            :     // add stack info
<span class="lineNum">     441 </span>            :     lastStackHeaderPos = currPos;
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :     buf[currPos++] = MakeStackHeader(iStack, 1, 1, 0);</span>
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span>            :     // add tracklet infos
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :     for (UShort_t iLayer = 0; iLayer &lt; fgkNumLayers; ++iLayer){</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :       det = iStack*fgkNumLayers + iLayer;</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :       for (UInt_t iTrkl = 0; iTrkl &lt; fNumTracklets[det]; ++iTrkl){</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :         buf[currPos++] = MakeTrackletHeader(fTrackletHCId[det][iTrkl]);</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :         buf[currPos++] = fTrackletWords[det][iTrkl];</span>
<span class="lineNum">     450 </span>            :       }
<span class="lineNum">     451 </span>            :     }
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            :     // add track infos
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     for (UInt_t iTrk = 0; iTrk &lt; fNumTracks[iStack]; ++iTrk){</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :       buf[currPos++] = MakeTrackHeader(iStack);</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :       buf[currPos++] = fTrackWords[iStack][iTrk] &amp; 0xffffffff;</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :       buf[currPos++] = (fTrackWords[iStack][iTrk] &gt;&gt; 32) &amp; 0xffffffff;</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :       buf[currPos++] = fTrackExtWords[iStack][iTrk] &amp; 0xffffffff;</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :       buf[currPos++] = (fTrackExtWords[iStack][iTrk] &gt;&gt; 32) &amp; 0xffffffff;</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :       buf[currPos++] = fTrackAddInfo[iStack][iTrk];</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :       for (UShort_t iLayer = 0; iLayer &lt; fgkNumLayers; ++iLayer)</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :         buf[currPos++] = fTrackTrackletWords[iStack][iTrk][iLayer];</span>
<span class="lineNum">     463 </span>            :     }
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :     buf[lastStackHeaderPos] = MakeStackHeader(iStack,</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                                               ((GetNumTracklets() &gt; 0) ? 1 : 0),</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                                               ((GetNumTracks() &gt; 0) ? 1 : 0),</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :                                               currPos - lastStackHeaderPos); // update size  //## todo: check off-by-one issues</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span>            :   } // loop over all stacks
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            :   // add Gtu header info
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :   buf[currPos++] = MakeGtuHeader(fStoreGtuInfo);</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :   if (fStoreGtuInfo){</span>
<span class="lineNum">     475 </span>            :     // store trigger info from GTU headers
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     for (UShort_t iSector = 0; iSector &lt; fgkNumSectors; ++iSector)</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :       buf[currPos++] = fSectorTrgWords[iSector];</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     for (UShort_t iSector = 0; iSector &lt; fgkNumSectors; ++iSector){</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :       for (UShort_t iStack = 0; iStack &lt; fgkNumStacksPerSector; ++iStack){</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :         buf[currPos++] = fStackTrgWords[iSector][iStack] &amp; 0xffffffff;</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :         buf[currPos++] = (fStackTrgWords[iSector][iStack] &gt;&gt; 32) &amp; 0xffffffff;</span>
<span class="lineNum">     482 </span>            :       }
<span class="lineNum">     483 </span>            :     }
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span>            :   // calc crosscheck
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :   for (UInt_t ofs = 1; ofs &lt; currPos; ++ofs)</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     crosscheck = calcCheck(crosscheck, buf[ofs]);</span>
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :   buf[currPos++] = crosscheck;</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :   buf[currPos++] = fgkTrailingMagicConst;</span>
<span class="lineNum">     492 </span>            :   // ptrInfo += Form(&quot; highest write addr: %p, %d]&quot;, &amp;(buf[currPos - 1]), (currPos-1)*4);
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :   if (sizeof(UInt_t)*currPos != bufSize){</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     HLTError(&quot;inconsistent memory layout! (%ld %d)&quot;, sizeof(UInt_t)*currPos, bufSize);</span>
<span class="lineNum">     496 </span>            :   }
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span>            : //  for (UInt_t ofs = 0; ofs &lt; bufSize/4; ++ofs)
<span class="lineNum">     499 </span>            : //    printf(&quot;%04d: 0x%08x\n&quot;, ofs, buf[ofs]);
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :   buffer = buf;</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :   sizeInBytes = bufSize;</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span>            :   // DbgLog(&quot;&quot;, ptrInfo.Data());
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span>            :   return kFALSE;
<a name="507"><span class="lineNum">     507 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span>            : Bool_t AliTRDonlineTrackingDataContainer::Decompress(const void* buffer, UInt_t sizeInBytes, Bool_t cumulative, Bool_t verbose) {
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span>            :   // TString ptrInfo(Form(&quot;DECOMPRESS CALLED: [buf: %p, size: %d - %p - %p, &quot;, buffer, sizeInBytes, buffer, (char*)buffer + sizeInBytes));
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :   UInt_t* buf = (UInt_t*)buffer;</span>
<span class="lineNum">     514 </span>            :   UInt_t currPos = 0;
<span class="lineNum">     515 </span>            :   UInt_t crosscheck = fgkCrosscheckSeed;
<span class="lineNum">     516 </span>            :   UInt_t stackHeader;
<span class="lineNum">     517 </span>            :   UInt_t gtuInfoHeader = 0;
<span class="lineNum">     518 </span>            :   Int_t stack = 0;
<span class="lineNum">     519 </span>            :   UInt_t size = 0;
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :   if (!cumulative)</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     Clear();</span>
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :   if (buf[currPos++] != fgkLeadingMagicConst){</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     HLTError(&quot;invalid data: leading mark should be 0x%08x, is 0x%08x&quot;, fgkLeadingMagicConst, buf[currPos - 1]);</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :   } else if (verbose)</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     HLTError(&quot;0x%05d: 0x%08x  correct leading mark&quot;, currPos, buf[currPos - 1]);</span>
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :   UInt_t overallDataHeader = buf[currPos++];</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :   if ((overallDataHeader &gt;&gt; 28) != fgkHeaderTypeData){</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :     HLTError(&quot;invalid data header: 0x%08x&quot;, overallDataHeader);</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     534 </span>            :   } else {
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :     fStoreGtuInfo = StoreGtuInfoFromDataHeader(overallDataHeader);</span>
<span class="lineNum">     536 </span>            :   }
<span class="lineNum">     537 </span>            : 
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :   if (buf[sizeInBytes/4 - 1] != fgkTrailingMagicConst){</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :     HLTError(&quot;invalid data: trailing mark should be 0x%08x, is 0x%08x&quot;, fgkTrailingMagicConst, buf[sizeInBytes/4 - 1]);</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     541 </span>            :   } else if (verbose){
<span class="lineNum">     542 </span>            :     HLTDebug(&quot;0x%05d: 0x%08x  correct trailing mark&quot;, sizeInBytes/4 - 1, buf[sizeInBytes/4 - 1]);
<span class="lineNum">     543 </span>            :   }
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :   while (currPos &lt; (sizeInBytes/4) - 2) { // stack-level loop</span>
<span class="lineNum">     546 </span>            : 
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :     stackHeader = buf[currPos++];</span>
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span>            :     // stack header + encapsulated tracklet and track data
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :     if (((stackHeader &gt;&gt; 28) &amp; 0xf) == fgkHeaderTypeStack){</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :       stack = StackFromStackHeader(stackHeader);</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :       size = SizeFromStackHeader(stackHeader);</span>
<span class="lineNum">     553 </span>            : 
<span class="lineNum">     554 </span>            :       if (verbose){
<span class="lineNum">     555 </span>            :         HLTDebug(&quot;STACK HEADER: 0x%08x - S%02d-%d, size: %d  [checksum: 0x%08x]&quot;, stackHeader, stack/5, stack%5, size, buf[sizeInBytes/4 - 2]);
<span class="lineNum">     556 </span>            :       }
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :       while (currPos &lt; sizeInBytes/4 - 2){</span>
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :         if (((buf[currPos] &gt;&gt; 28) &amp; 0xf) == fgkHeaderTypeTracklet){</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :           UInt_t trklHdr = buf[currPos++];</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :           UInt_t trklWord = buf[currPos++];</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :           AddTracklet(HCIdFromTrackletHeader(trklHdr), trklWord);</span>
<span class="lineNum">     564 </span>            :           if (verbose){
<span class="lineNum">     565 </span>            :             HLTDebug(&quot;Tracklet: 0x%08x 0x%08x&quot;, trklHdr, trklWord);
<span class="lineNum">     566 </span>            :           }
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :         } else if (((buf[currPos] &gt;&gt; 28) &amp; 0xf) == fgkHeaderTypeTrack){</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :           UInt_t trkHdr = buf[currPos++];</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :           if (trkHdr == 0)</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :             HLTError(&quot;ERROR&quot;, &quot;invalid track header&quot;);</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :           ULong64_t trackWord = buf[currPos++];</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :           trackWord |= ((ULong64_t)buf[currPos++] &lt;&lt; 32);</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :           ULong64_t extTrackWord = buf[currPos++];</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :           extTrackWord |= ((ULong64_t)buf[currPos++] &lt;&lt; 32);</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :           UInt_t addInfo = buf[currPos++];</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :           UInt_t trackletWords[6];</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :           for (UShort_t iLayer = 0; iLayer &lt; fgkNumLayers; ++iLayer){</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :             trackletWords[iLayer] = buf[currPos++];</span>
<span class="lineNum">     579 </span>            :           }
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :           AddTrack(stack, trackWord, extTrackWord, trackletWords, addInfo);</span>
<span class="lineNum">     581 </span>            :           if (verbose){
<span class="lineNum">     582 </span>            :             HLTDebug(&quot;GTU track: 0x%016llx 0x%016llx&quot;, trackWord, extTrackWord);
<span class="lineNum">     583 </span>            :           }
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :         } else if (((buf[currPos] &gt;&gt; 28) &amp; 0xf) == fgkHeaderTypeStack){</span>
<span class="lineNum">     585 </span>            :         //printf(&quot;next stack header\n&quot;);
<span class="lineNum">     586 </span>            :           break;
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :         } else if (((buf[currPos] &gt;&gt; 28) &amp; 0xf) == fgkHeaderTypeGtu){</span>
<span class="lineNum">     588 </span>            :           gtuInfoHeader = buf[currPos];
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">     590 </span>            :         } else {
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :           HLTError(&quot;unknown data block: 0x%08x&quot;, buf[currPos]);</span>
<span class="lineNum">     592 </span>            :           break;
<span class="lineNum">     593 </span>            :         }
<span class="lineNum">     594 </span>            :       }
<span class="lineNum">     595 </span>            : 
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :       if (gtuInfoHeader)</span>
<span class="lineNum">     597 </span>            :         break;
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span>            :     } else {
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :       HLTError(&quot;invalid header while analyzing tracking data block: 0x%08x - S%02d-%d, size: %d&quot;,</span>
<span class="lineNum">     601 </span>            :                            stackHeader, stack/5, stack%5, size);
<span class="lineNum">     602 </span>            :       break;
<span class="lineNum">     603 </span>            :     }
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span>            :   } // stack-level loop
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span>            :   // GTU header data loop
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :   if (((gtuInfoHeader &gt;&gt; 28) &amp; 0xf) == fgkHeaderTypeGtu) {</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :     UInt_t gtuHeader = buf[currPos++];</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     HLTInfo(&quot;gtu header: 0x%08x&quot;, gtuHeader);</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :     if (GtuInfoPresentFromGtuHeader(gtuHeader)){</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :       for (UShort_t iSector = 0; iSector &lt; fgkNumSectors; ++iSector)</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :         fSectorTrgWords[iSector] = buf[currPos++];</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :       for (UShort_t iSector = 0; iSector &lt; fgkNumSectors; ++iSector){</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :         for (UShort_t iStack = 0; iStack &lt; fgkNumStacksPerSector; ++iStack){</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :           UInt_t low = buf[currPos++];</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :           UInt_t high = buf[currPos++];</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :           fStackTrgWords[iSector][iStack] = ((ULong64_t)high &lt;&lt; 32) | low;</span>
<span class="lineNum">     619 </span>            :         }
<span class="lineNum">     620 </span>            :       }
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :     HLTError(&quot;expected GtuInfoHeader at position %d, but is 0x%08x&quot;,</span>
<span class="lineNum">     624 </span>            :                          currPos, buf[currPos]);
<span class="lineNum">     625 </span>            :   }
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :   if (currPos != (sizeInBytes/4) - 2){</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :     HLTError(&quot;invalid read position after analyzing tracking data block.&quot;);</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     630 </span>            :   }
<span class="lineNum">     631 </span>            : 
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :   for (UInt_t ofs = 1; ofs &lt; sizeInBytes/4 - 2; ++ofs)</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :     crosscheck = calcCheck(crosscheck, buf[ofs]);</span>
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :   if (crosscheck != buf[sizeInBytes/4 - 2]){  // compare recalculated checksum with the one in the data</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :     HLTError(&quot;decompress checksum mismatch: should be 0x%08x, is 0x%08x&quot;,</span>
<span class="lineNum">     637 </span>            :            crosscheck, buf[sizeInBytes/4 - 2]);
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     639 </span>            :   }
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            :   // HLTDebug(ptrInfo.Data());
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
