<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - ZDC/ZDCbase/AliZDCPreprocessor.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">ZDC/ZDCbase</a> - AliZDCPreprocessor.cxx<span style="font-size: 80%;"> (source / <a href="AliZDCPreprocessor.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">547</td>
            <td class="headerCovTableEntryLo">0.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">16</td>
            <td class="headerCovTableEntryLo">6.2 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : // --- ROOT system</a>
<span class="lineNum">       2 </span>            : #include &lt;TFile.h&gt;
<span class="lineNum">       3 </span>            : #include &lt;TClonesArray.h&gt;
<span class="lineNum">       4 </span>            : #include &lt;TList.h&gt;
<span class="lineNum">       5 </span>            : #include &lt;TObjString.h&gt;
<span class="lineNum">       6 </span>            : #include &lt;TTimeStamp.h&gt;
<span class="lineNum">       7 </span>            : 
<span class="lineNum">       8 </span>            : #include &quot;AliZDCPreprocessor.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;AliCDBManager.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;AliCDBEntry.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;AliCDBMetaData.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;AliDCSValue.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;AliAlignObj.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;AliAlignObjParams.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;AliZDCDataDCS.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;AliZDCChMap.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;AliZDCPedestals.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;AliZDCLaserCalib.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;AliZDCEnCalib.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;AliZDCTowerCalib.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;AliZDCMBCalib.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;AliZDCTDCCalib.h&quot;
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : /////////////////////////////////////////////////////////////////////
<span class="lineNum">      26 </span>            : //                                                                 //
<span class="lineNum">      27 </span>            : // Class implementing Shuttle ZDC pre-processor.                   //
<span class="lineNum">      28 </span>            : // It takes data from DCS and DAQ and writes calibration objects   //
<span class="lineNum">      29 </span>            : // in the OCDB and reference values/histos in the ReferenceData.   //
<span class="lineNum">      30 </span>            : //                                                                 //
<span class="lineNum">      31 </span>            : /////////////////////////////////////////////////////////////////////
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : // ******************************************************************
<span class="lineNum">      34 </span>            : //    RETURN CODES:
<span class="lineNum">      35 </span>            : // return 0 : everything OK
<span class="lineNum">      36 </span>            : // return 1 : no DCS input data Map
<span class="lineNum">      37 </span>            : // return 2 : error storing DCS data in RefData 
<span class="lineNum">      38 </span>            : // return 3 : error storing alignment object in OCDB
<span class="lineNum">      39 </span>            : // return 4 : error in ZDCMapping.dat file retrieved from DAQ FXS (not existing|empty|corrupted)
<span class="lineNum">      40 </span>            : // return 5 : error storing mapping obj. in OCDB
<span class="lineNum">      41 </span>            : // return 6 : error storing energy calibration obj. in OCDB
<span class="lineNum">      42 </span>            : // return 7 : error storing tower inter-calibration obj. in OCDB
<span class="lineNum">      43 </span>            : // return 8 : error in ZDCEnergyCalib.dat file retrieved from DAQ FXS 
<span class="lineNum">      44 </span>            : // return 9 : error in ZDCTowerCalib.dat file retrieved from DAQ FXS 
<span class="lineNum">      45 </span>            : // return 10: error in ZDCPedestal.dat file retrieved from DAQ FXS 
<span class="lineNum">      46 </span>            : // return 11: error storing pedestal calibration obj. in OCDB
<span class="lineNum">      47 </span>            : // return 12: error in ZDCPedHisto.root file retrieved from DAQ FXS 
<span class="lineNum">      48 </span>            : // return 13: error storing pedestal histos in RefData 
<span class="lineNum">      49 </span>            : // return 14: error in ZDCLaserCalib.dat file retrieved from DAQ FXS 
<span class="lineNum">      50 </span>            : // return 15: error storing laser calibration obj. in OCDB
<span class="lineNum">      51 </span>            : // return 16: error in ZDCLaserHisto.root file retrieved from DAQ FXS 
<span class="lineNum">      52 </span>            : // return 17: error storing laser histos in RefData 
<span class="lineNum">      53 </span>            : // return 18: error in ZDCMBCalib.root file retrieved from DAQ FXS 
<span class="lineNum">      54 </span>            : // return 19: error storing MB calibration obj. in OCDB
<span class="lineNum">      55 </span>            : // return 20: error in ZDCTDCCalib.root file retrieved from DAQ FXS
<span class="lineNum">      56 </span>            : // return 21: error in storing TDC calibration obj. in OCDB
<span class="lineNum">      57 </span>            : // return 22: error in ZDCTDCHisto.root file retrieved from DAQ FXS
<span class="lineNum">      58 </span>            : // Return 23: error storing TDC reference histos in RefData
<a name="59"><span class="lineNum">      59 </span>            : // ******************************************************************</a>
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span><span class="lineCov">         12 : ClassImp(AliZDCPreprocessor)</span>
<a name="62"><span class="lineNum">      62 </span>            : </a>
<span class="lineNum">      63 </span>            : //______________________________________________________________________________________________
<span class="lineNum">      64 </span>            : AliZDCPreprocessor::AliZDCPreprocessor(AliShuttleInterface* shuttle) :
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   AliPreprocessor(&quot;ZDC&quot;, shuttle),</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :   fData(0)</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      68 </span>            :   // constructor
<span class="lineNum">      69 </span>            :   // May 2009 - run types updated according to
<span class="lineNum">      70 </span>            :   // http://alice-ecs.web.cern.ch/alice-ecs/runtypes_3.36.html
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :   AddRunType(&quot;STANDALONE_PEDESTAL&quot;);</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :   AddRunType(&quot;STANDALONE_LASER&quot;);</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :   AddRunType(&quot;STANDALONE_COSMIC&quot;);</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :   AddRunType(&quot;CALIBRATION_EMD&quot;);</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :   AddRunType(&quot;CALIBRATION_MB&quot;);</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :   AddRunType(&quot;CALIBRATION_BC&quot;);</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :   AddRunType(&quot;PHYSICS&quot;);</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      79 </span>            : 
<a name="80"><span class="lineNum">      80 </span>            : </a>
<span class="lineNum">      81 </span>            : //______________________________________________________________________________________________
<span class="lineNum">      82 </span>            : AliZDCPreprocessor::~AliZDCPreprocessor()
<span class="lineNum">      83 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      84 </span>            :   // destructor
<span class="lineNum">      85 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      86 </span>            : 
<a name="87"><span class="lineNum">      87 </span>            : </a>
<span class="lineNum">      88 </span>            : //______________________________________________________________________________________________
<span class="lineNum">      89 </span>            : void AliZDCPreprocessor::Initialize(Int_t run, UInt_t startTime, UInt_t endTime)
<span class="lineNum">      90 </span>            : {
<span class="lineNum">      91 </span>            :   // Creates AliZDCDataDCS object
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :   AliPreprocessor::Initialize(run, startTime, endTime);</span>
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :   AliDebug(2,Form(&quot;\n\tRun %d \n\tStartTime %s \n\tEndTime %s \n\tStartTime DCS Query %s \n\tEndTime DCS Query %s&quot;, run,</span>
<span class="lineNum">      96 </span>            :                 TTimeStamp(startTime).AsString(),
<span class="lineNum">      97 </span>            :                 TTimeStamp(endTime).AsString(), ((TTimeStamp)GetStartTimeDCSQuery()).AsString(), ((TTimeStamp)GetEndTimeDCSQuery()).AsString()));
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :   fRun = run;</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   fStartTime = startTime;</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :   fEndTime = endTime;</span>
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :   fData = new AliZDCDataDCS(fRun, fStartTime, fEndTime, GetStartTimeDCSQuery(), GetEndTimeDCSQuery());</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :   fPedSubMethFlag = kFALSE;</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 : }</span>
<a name="106"><span class="lineNum">     106 </span>            : </a>
<span class="lineNum">     107 </span>            : //_____________________________________________________________________________
<span class="lineNum">     108 </span>            : Bool_t AliZDCPreprocessor::ProcessDCS(){
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            :   // tells whether DCS should be processed or not
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :   TString runType = GetRunType();</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :   Log(Form(&quot;RunType %s&quot;,runType.Data()));</span>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :   if (runType==&quot;STANDALONE_COSMIC&quot; || runType==&quot;STANDALONE_PEDESTAL&quot;){</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     117 </span>            :   }
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 : }</span>
<a name="121"><span class="lineNum">     121 </span>            : </a>
<span class="lineNum">     122 </span>            : //______________________________________________________________________________________________
<span class="lineNum">     123 </span>            : UInt_t AliZDCPreprocessor::ProcessDCSData(TMap* dcsAliasMap)
<span class="lineNum">     124 </span>            : {
<span class="lineNum">     125 </span>            :   
<span class="lineNum">     126 </span>            :   // Fills data into a AliZDCDataDCS object
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :   if(!dcsAliasMap){</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     Log(&quot; No DCS map found: ZDC exiting from Shuttle&quot;);</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     if(fData){</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :       delete fData;</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :       fData = 0;</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">     134 </span>            :   }
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :   Log(Form(&quot;Processing data from DCS&quot;));</span>
<span class="lineNum">     137 </span>            :    
<span class="lineNum">     138 </span>            :   // The processing of the DCS input data is forwarded to AliZDCDataDCS
<span class="lineNum">     139 </span>            :   //dcsAliasMap-&gt;Print(&quot;&quot;); 
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :   Bool_t resDCSProcess = fData-&gt;ProcessData(*dcsAliasMap);</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   if(resDCSProcess==kFALSE){</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :     Log(&quot; Problems in processing DCS DP&quot;);</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">     144 </span>            :   }  
<span class="lineNum">     145 </span>            :   
<span class="lineNum">     146 </span>            :   // ------------------------------------------------------
<span class="lineNum">     147 </span>            :   // Change introduced 26/9/09 in order NOT to process the
<span class="lineNum">     148 </span>            :   // HV DP since some of them are never found in amanda DB
<span class="lineNum">     149 </span>            :   // ------------------------------------------------------
<span class="lineNum">     150 </span>            :   // Store DCS data as reference
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   AliCDBMetaData metadata;</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :   metadata.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   metadata.SetComment(&quot;DCS DP TMap for ZDC&quot;);</span>
<span class="lineNum">     154 </span>            :   Bool_t resDCSRef = kTRUE;
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   resDCSRef = StoreReferenceData(&quot;DCS&quot;,&quot;Data&quot;, dcsAliasMap, &amp;metadata);</span>
<span class="lineNum">     156 </span>            :   
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   if(resDCSRef==kFALSE) return 2;</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            :   // --- Writing ZDC table positions into alignment object
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :   TClonesArray *array = new TClonesArray(&quot;AliAlignObjParams&quot;,10);</span>
<span class="lineNum">     161 </span>            :   TClonesArray &amp;alobj = *array;
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   AliAlignObjParams a;</span>
<span class="lineNum">     163 </span>            :   Double_t dx=0., dz=0., dpsi=0., dtheta=0., dphi=0.;
<span class="lineNum">     164 </span>            :   // Vertical table position in mm from DCS
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   Double_t dyZN1 = (Double_t) ((fData-&gt;GetAlignData(0)-184.0)/10.);</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :   Double_t dyZP1 = (Double_t) ((fData-&gt;GetAlignData(1)-198.1)/10.);</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :   Double_t dyZN2 = (Double_t) ((fData-&gt;GetAlignData(2)-186.5)/10.);</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :   Double_t dyZP2 = (Double_t) ((fData-&gt;GetAlignData(3)-202.9)/10.);</span>
<span class="lineNum">     169 </span>            :   //
<span class="lineNum">     170 </span>            :   const char *n1ZDC=&quot;ZDC/NeutronZDC_C&quot;;  
<span class="lineNum">     171 </span>            :   const char *p1ZDC=&quot;ZDC/ProtonZDC_C&quot;;
<span class="lineNum">     172 </span>            :   const char *n2ZDC=&quot;ZDC/NeutronZDC_A&quot;;
<span class="lineNum">     173 </span>            :   const char *p2ZDC=&quot;ZDC/ProtonZDC_A&quot;;
<span class="lineNum">     174 </span>            :   //
<span class="lineNum">     175 </span>            :   UShort_t iIndex=0;
<span class="lineNum">     176 </span>            :   AliGeomManager::ELayerID iLayer = AliGeomManager::kInvalidLayer;
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :   UShort_t volid = AliGeomManager::LayerToVolUID(iLayer,iIndex);</span>
<span class="lineNum">     178 </span>            :   //
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :   new(alobj[0]) AliAlignObjParams(n1ZDC, volid, dx, dyZN1, dz, dpsi, dtheta, dphi, kTRUE);</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   new(alobj[1]) AliAlignObjParams(p1ZDC, volid, dx, dyZP1, dz, dpsi, dtheta, dphi, kTRUE);</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :   new(alobj[2]) AliAlignObjParams(n2ZDC, volid, dx, dyZN2, dz, dpsi, dtheta, dphi, kTRUE);</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   new(alobj[3]) AliAlignObjParams(p2ZDC, volid, dx, dyZP2, dz, dpsi, dtheta, dphi, kTRUE);</span>
<span class="lineNum">     183 </span>            :  
<span class="lineNum">     184 </span>            :   // save in CDB storage
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   AliCDBMetaData mdDCS;</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   mdDCS.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   mdDCS.SetComment(&quot;Alignment object for ZDC&quot;);</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   Bool_t resultAl = Store(&quot;Align&quot;,&quot;Data&quot;, array, &amp;mdDCS, 0, kFALSE);</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :   if(resultAl==kFALSE)  return 3;</span>
<span class="lineNum">     190 </span>            :   
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 : }</span>
<a name="193"><span class="lineNum">     193 </span>            : </a>
<span class="lineNum">     194 </span>            : //______________________________________________________________________________________________
<span class="lineNum">     195 </span>            : UInt_t AliZDCPreprocessor::ProcessChMap()
<span class="lineNum">     196 </span>            : { 
<span class="lineNum">     197 </span>            :   const int kNModules=10, kNch=48, kNScch=32, kNtdcch=32;
<span class="lineNum">     198 </span>            :   
<span class="lineNum">     199 </span>            :   // Reading the file for mapping from FXS
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :   TList* daqSource = GetFileSources(kDAQ, &quot;MAPPING&quot;);</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :   if(!daqSource){</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;No sources for file ZDCChMapping.dat in run %d &quot;, fRun));</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :     return 4;</span>
<span class="lineNum">     204 </span>            :   }
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :   if(daqSource-&gt;GetEntries()==0) return 4;</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :   Log(&quot;\t List of DAQ sources for MAPPING id: &quot;); daqSource-&gt;Print();</span>
<span class="lineNum">     207 </span>            :   //
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :   TIter iter(daqSource);</span>
<span class="lineNum">     209 </span>            :   TObjString* source = 0;
<span class="lineNum">     210 </span>            :   Int_t isou = 0;
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :   Int_t modMap[kNModules][3], adcMap[kNch][6], scMap[kNScch][6], tdcMap[kNtdcch][4]; </span>
<span class="lineNum">     212 </span>            :   //
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :   while((source = dynamic_cast&lt;TObjString*&gt; (iter.Next()))){</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :      TString fileName = GetFile(kDAQ, &quot;MAPPING&quot;, source-&gt;GetName());</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :      Log(Form(&quot;\t Getting file #%d: ZDCChMapping.dat from %s\n&quot;,++isou, source-&gt;GetName()));</span>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :      if(fileName.Length() &lt;= 0){</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :        Log(Form(&quot;No file from source %s!&quot;, source-&gt;GetName()));</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :        return 4;</span>
<span class="lineNum">     220 </span>            :      }
<span class="lineNum">     221 </span>            :      // --- Reading file with calibration data
<span class="lineNum">     222 </span>            :      //const char* fname = fileName.Data();
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :      if(fileName){</span>
<span class="lineNum">     224 </span>            :        FILE *file;
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :        if((file = fopen(fileName,&quot;r&quot;)) == NULL){</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :          printf(&quot;Cannot open file %s \n&quot;,fileName.Data());</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :          return 4;</span>
<span class="lineNum">     228 </span>            :        }
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :        Log(Form(&quot;File %s connected to process data for ADC mapping&quot;, fileName.Data()));</span>
<span class="lineNum">     230 </span>            :        //
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :        for(Int_t j=0; j&lt;kNch; j++){    </span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :            for(Int_t k=0; k&lt;6; k++){</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :              int read = fscanf(file,&quot;%d&quot;,&amp;adcMap[j][k]);</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :              if(read == 0) AliDebug(3,&quot; Failing in reading data from mapping file&quot;);</span>
<span class="lineNum">     235 </span>            :            }
<span class="lineNum">     236 </span>            :        }
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :        for(Int_t j=kNch; j&lt;kNch+kNScch; j++){          </span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :            for(Int_t k=0; k&lt;6; k++){</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :              int read = fscanf(file,&quot;%d&quot;,&amp;scMap[j-kNch][k]);</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :              if(read == 0) AliDebug(3,&quot; Failing in reading data from mapping file&quot;);</span>
<span class="lineNum">     241 </span>            :            }
<span class="lineNum">     242 </span>            :        }
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :        for(Int_t j=kNch+kNScch; j&lt;kNch+kNScch+kNtdcch; j++){   </span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :            for(Int_t k=0; k&lt;4; k++){</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :              int read = fscanf(file,&quot;%d&quot;,&amp;tdcMap[j-kNch-kNScch][k]);</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :              if(read == 0) AliDebug(3,&quot; Failing in reading data from mapping file&quot;);</span>
<span class="lineNum">     247 </span>            :            }
<span class="lineNum">     248 </span>            :        }
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :        for(Int_t j=kNch+kNScch+kNtdcch; j&lt;kNch+kNScch+kNtdcch+kNModules; j++){         </span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :            for(Int_t k=0; k&lt;3; k++){</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :              int read = fscanf(file,&quot;%d&quot;,&amp;modMap[j-kNch-kNScch-kNtdcch][k]);</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :              if(read == 0) AliDebug(3,&quot; Failing in reading data from mapping file&quot;);</span>
<span class="lineNum">     253 </span>            :            }
<span class="lineNum">     254 </span>            :        }
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :        fclose(file);</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :      }</span>
<span class="lineNum">     257 </span>            :      else{
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :        Log(Form(&quot;File %s not found&quot;, fileName.Data()));</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :        return 4;</span>
<span class="lineNum">     260 </span>            :      }
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     262 </span>            :   
<span class="lineNum">     263 </span>            :   // Store the currently read map ONLY IF it is different
<span class="lineNum">     264 </span>            :   // from the entry in the OCDB
<span class="lineNum">     265 </span>            :   Bool_t adcMapUpdated=kFALSE, scMapUpdated=kFALSE, tdcMapUpdated=kFALSE;
<span class="lineNum">     266 </span>            :   Bool_t updateOCDB = kFALSE;
<span class="lineNum">     267 </span>            :   
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :   AliCDBEntry *cdbEntry = GetFromOCDB(&quot;Calib&quot;,&quot;ChMap&quot;);</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :   if(!cdbEntry){</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     Log(&quot; No existing CDB entry for ADC mapping&quot;);</span>
<span class="lineNum">     271 </span>            :     updateOCDB = kTRUE;
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     273 </span>            :   else{
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :     AliZDCChMap *chMap = (AliZDCChMap*) cdbEntry-&gt;GetObject();</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :     for(Int_t i=0; i&lt;kNch; i++){</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :       if(  (adcMap[i][1] != chMap-&gt;GetADCModule(i)) </span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :         || (adcMap[i][2] != chMap-&gt;GetADCChannel(i)) </span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         || (adcMap[i][3] != chMap-&gt;GetADCSignalCode(i)) </span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         || (adcMap[i][4] != chMap-&gt;GetDetector(i)) </span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         || (adcMap[i][5] != chMap-&gt;GetSector(i))) </span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :          adcMapUpdated = kTRUE;</span>
<span class="lineNum">     282 </span>            :     }
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     for(Int_t i=0; i&lt;kNScch; i++){</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :       if(  (scMap[i][2] != chMap-&gt;GetScChannel(i)) </span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         || (scMap[i][3] != chMap-&gt;GetScSignalCode(i)) )</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :          scMapUpdated = kTRUE;</span>
<span class="lineNum">     287 </span>            :     }
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     for(Int_t i=0; i&lt;kNtdcch; i++){</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :       if(  (tdcMap[i][2] != chMap-&gt;GetTDCChannel(i)) </span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :         || (tdcMap[i][3] != chMap-&gt;GetTDCSignalCode(i)))</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :          tdcMapUpdated = kTRUE;</span>
<span class="lineNum">     292 </span>            :     }
<span class="lineNum">     293 </span>            :   }
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :   if(adcMapUpdated || scMapUpdated || tdcMapUpdated) updateOCDB = kTRUE;</span>
<span class="lineNum">     295 </span>            :   //
<span class="lineNum">     296 </span>            :   Bool_t resChMapStore = kTRUE;
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :   if(updateOCDB==kTRUE){</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :     Log(&quot; A new entry ZDC/Calib/ChMap will be created&quot;);</span>
<span class="lineNum">     299 </span>            :     //
<span class="lineNum">     300 </span>            :     // --- Initializing mapping calibration object
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :     AliZDCChMap *mapCalib = new AliZDCChMap(&quot;ZDC&quot;);</span>
<span class="lineNum">     302 </span>            :     // Writing channel map in the OCDB
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :     for(Int_t k=0; k&lt;kNModules; k++){</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :       mapCalib-&gt;SetModuleMap(k, modMap[k][0], modMap[k][1], modMap[k][2]);</span>
<span class="lineNum">     305 </span>            :     }
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     for(Int_t k=0; k&lt;kNch; k++){</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :       mapCalib-&gt;SetADCModule(k,adcMap[k][1]);</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :       mapCalib-&gt;SetADCChannel(k,adcMap[k][2]);</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :       mapCalib-&gt;SetADCSignalCode(k,adcMap[k][3]);</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :       mapCalib-&gt;SetDetector(k,adcMap[k][4]);</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :       mapCalib-&gt;SetSector(k,adcMap[k][5]);</span>
<span class="lineNum">     312 </span>            :     }
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :     for(Int_t k=0; k&lt;kNScch; k++){</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :        mapCalib-&gt;SetScChannel(k, scMap[k][2]);</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :        mapCalib-&gt;SetScSignalCode(k, scMap[k][3]);</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :        mapCalib-&gt;SetScDetector(k, scMap[k][4]);</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :        mapCalib-&gt;SetScSector(k, scMap[k][5]);</span>
<span class="lineNum">     318 </span>            :     }
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     for(Int_t k=0; k&lt;kNtdcch; k++){</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :        mapCalib-&gt;SetTDCChannel(k, tdcMap[k][2]);</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :        mapCalib-&gt;SetTDCSignalCode(k, tdcMap[k][3]);</span>
<span class="lineNum">     322 </span>            :     }
<span class="lineNum">     323 </span>            :     //
<span class="lineNum">     324 </span>            :     //mapCalib-&gt;Print(&quot;&quot;);
<span class="lineNum">     325 </span>            :     // 
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     AliCDBMetaData metaData;</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     metaData.SetBeamPeriod(0);</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     metaData.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :     metaData.SetComment(&quot;AliZDCChMap object created by ZDC preprocessor&quot;);  </span>
<span class="lineNum">     330 </span>            :     //
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     resChMapStore = Store(&quot;Calib&quot;,&quot;ChMap&quot;,mapCalib, &amp;metaData, 0, kTRUE);</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     printf(&quot;  Mapping object stored in OCDB\n&quot;);</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     334 </span>            :   else{
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     Log(&quot; ZDC/Calib/ChMap entry in OCDB is valid and won't be updated&quot;);</span>
<span class="lineNum">     336 </span>            :     resChMapStore = kTRUE;
<span class="lineNum">     337 </span>            :   }
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :   delete daqSource; daqSource=0;</span>
<span class="lineNum">     339 </span>            :   
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :   TString runType = GetRunType();</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :   if(runType.CompareTo(&quot;PHYSICS&quot;)==0){</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :     Log(Form(&quot;RunType %s -&gt; producing TDC calibration data&quot;,runType.Data()));</span>
<span class="lineNum">     343 </span>            :     
<span class="lineNum">     344 </span>            :     // Reading the file for mapping from FXS
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     TList* daqSourcetdc = GetFileSources(kDAQ, &quot;TDCDATA&quot;);</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     if(!daqSourcetdc){</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :       AliError(Form(&quot;No sources for file ZDCChMappingTDCCalib.dat in run %d &quot;, fRun));</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :       return 20;</span>
<span class="lineNum">     349 </span>            :     }
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     if(daqSourcetdc-&gt;GetEntries()==0) return 20;</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     Log(&quot;\t List of DAQ sources for TDCDATA id: &quot;); daqSourcetdc-&gt;Print();</span>
<span class="lineNum">     352 </span>            :     //
<span class="lineNum">     353 </span>            :     Bool_t resTDCcal = kTRUE;
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     TIter itertdc(daqSourcetdc);</span>
<span class="lineNum">     355 </span>            :     TObjString* sourcetdc = 0;
<span class="lineNum">     356 </span>            :     Int_t isoutdc = 0;
<span class="lineNum">     357 </span>            :     //
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :     while((sourcetdc = dynamic_cast&lt;TObjString*&gt; (itertdc.Next()))){</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :      TString fileNametdc = GetFile(kDAQ, &quot;TDCDATA&quot;, sourcetdc-&gt;GetName());</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :      Log(Form(&quot;\t Getting file #%d: ZDCTDCdata.dat from %s\n&quot;,++isoutdc, sourcetdc-&gt;GetName()));</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :      if(fileNametdc.Length() &lt;= 0){</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :        Log(Form(&quot;No file from source %s!&quot;, sourcetdc-&gt;GetName()));</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :        return 20;</span>
<span class="lineNum">     365 </span>            :      }
<span class="lineNum">     366 </span>            :      // --- Initializing TDC calibration object
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :      AliZDCTDCCalib *tdcCalib = new AliZDCTDCCalib(&quot;ZDC&quot;);</span>
<span class="lineNum">     368 </span>            :      // --- Reading file with calibration data
<span class="lineNum">     369 </span>            :      //const char* fname = fileName.Data();
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :      if(fileNametdc){</span>
<span class="lineNum">     371 </span>            :        FILE *filetdc;
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :        if((filetdc = fopen(fileNametdc,&quot;r&quot;)) == NULL){</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :          printf(&quot;Cannot open file %s \n&quot;,fileNametdc.Data());</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :          return 20;</span>
<span class="lineNum">     375 </span>            :        }
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :        Log(Form(&quot;File %s connected to process TDC data&quot;, fileNametdc.Data()));</span>
<span class="lineNum">     377 </span>            :        //
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :        Float_t tdcMean[6][2];</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :        for(Int_t it=0; it&lt;6; it++){</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :          for(Int_t iu=0; iu&lt;2; iu++) tdcMean[it][iu]=0.;</span>
<span class="lineNum">     381 </span>            :        }
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :        for(Int_t k=0; k&lt;6; k++){</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :         for(Int_t j=0; j&lt;2; j++){</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :            int leggi = fscanf(filetdc,&quot;%f&quot;,&amp;tdcMean[k][j]);</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :            if(leggi==0) AliDebug(3,&quot; Failing reading data from tdc file&quot;);</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :            tdcCalib-&gt;SetMeanTDC(k, tdcMean[k][0]);</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :            tdcCalib-&gt;SetWidthTDC(k, tdcMean[k][1]);</span>
<span class="lineNum">     388 </span>            :         }
<span class="lineNum">     389 </span>            :        }
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :        fclose(filetdc);</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :      }</span>
<span class="lineNum">     392 </span>            :      else{
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :        Log(Form(&quot;File %s not found&quot;, fileNametdc.Data()));</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :        return 20;</span>
<span class="lineNum">     395 </span>            :      }
<span class="lineNum">     396 </span>            :      //
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :      AliCDBMetaData metaData;</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :      metaData.SetBeamPeriod(0);</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :      metaData.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :      metaData.SetComment(&quot;Filling AliZDCTDCCalib object&quot;);  </span>
<span class="lineNum">     401 </span>            :      //
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :      resTDCcal = Store(&quot;Calib&quot;,&quot;TDCCalib&quot;,tdcCalib, &amp;metaData, 0, kTRUE);</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :      if(resTDCcal==kFALSE) return 21;</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :     delete daqSourcetdc; daqSourcetdc = 0;</span>
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span>            :     Bool_t restdcHist = kTRUE;
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :     TList* daqSourceH = GetFileSources(kDAQ, &quot;TDCHISTOS&quot;);</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     if(!daqSourceH){</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :       Log(Form(&quot;No source for TDCHISTOS id run %d !&quot;, fRun));</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :       return 22;</span>
<span class="lineNum">     412 </span>            :     }
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     Log(&quot;\t List of DAQ sources for TDCHISTOS id: &quot;); daqSourceH-&gt;Print();</span>
<span class="lineNum">     414 </span>            :     //
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     TIter iterH(daqSourceH);</span>
<span class="lineNum">     416 </span>            :     TObjString* sourceH = 0;
<span class="lineNum">     417 </span>            :     Int_t iH=0;
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :     while((sourceH = dynamic_cast&lt;TObjString*&gt; (iterH.Next()))){</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :      TString stringTDCFileName = GetFile(kDAQ, &quot;TDCHISTOS&quot;, sourceH-&gt;GetName());</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :      if(stringTDCFileName.Length() &lt;= 0){</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         Log(Form(&quot;No TDCHISTOS file from source %s!&quot;, sourceH-&gt;GetName()));</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :         return 22;</span>
<span class="lineNum">     423 </span>            :      }
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :      const char* tdcFileName = stringTDCFileName.Data();</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :      Log(Form(&quot;\t Getting file #%d: %s from %s\n&quot;,++iH, tdcFileName, sourceH-&gt;GetName()));</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :      restdcHist = StoreReferenceFile(tdcFileName, &quot;tdcReference.root&quot;);</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :      if(restdcHist==kFALSE) return 23;</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :     delete daqSourceH; daqSourceH=0;</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     431 </span>            :   
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :     if(resChMapStore==kFALSE) return 5;</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :     else return 0;</span>
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineNoCov">          0 : }</span>
<a name="436"><span class="lineNum">     436 </span>            : </a>
<span class="lineNum">     437 </span>            : //______________________________________________________________________________________________
<span class="lineNum">     438 </span>            : UInt_t AliZDCPreprocessor::ProcessppData()
<span class="lineNum">     439 </span>            : {
<span class="lineNum">     440 </span>            :    Bool_t resEnCal=kTRUE, resTowCal=kTRUE;
<span class="lineNum">     441 </span>            :   
<span class="lineNum">     442 </span>            :    // *********** Energy calibration
<span class="lineNum">     443 </span>            :    // --- Cheking if there is already the entry in the OCDB
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :    AliCDBEntry *cdbEnEntry = GetFromOCDB(&quot;Calib&quot;, &quot;EnergyCalib&quot;);</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :    if(!cdbEnEntry){   </span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :      Log(Form(&quot; ZDC/Calib/EnergyCalib entry will be created&quot;));</span>
<span class="lineNum">     447 </span>            :      // --- Initializing calibration object
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :      AliCDBMetaData metaData;</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :      metaData.SetBeamPeriod(0);</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :      metaData.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     451 </span>            :      //
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :      AliZDCEnCalib *eCalib = new AliZDCEnCalib(&quot;ZDC&quot;);</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :      for(Int_t j=0; j&lt;6; j++) eCalib-&gt;SetEnCalib(j,1.);</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :      metaData.SetComment(&quot;AliZDCEnCalib object&quot;);  </span>
<span class="lineNum">     455 </span>            :      //eCalib-&gt;Print(&quot;&quot;);
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :      resEnCal = Store(&quot;Calib&quot;, &quot;EnergyCalib&quot;, eCalib, &amp;metaData, 0, kTRUE);</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     458 </span>            :    else{ 
<span class="lineNum">     459 </span>            :      // if entry exists it is still valid (=1 for all runs!)
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :      Log(Form(&quot; Valid ZDC/Calib/EnergyCalib object already existing in OCDB!!!&quot;));</span>
<span class="lineNum">     461 </span>            :      resEnCal = kTRUE;
<span class="lineNum">     462 </span>            :    }
<span class="lineNum">     463 </span>            :    
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :    if(resEnCal==kFALSE) return 6;</span>
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span>            :    //
<span class="lineNum">     467 </span>            :    // *********** Tower inter-calibration
<span class="lineNum">     468 </span>            :    // --- Cheking if there is already the entry in the OCDB
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :    AliCDBEntry *cdbTowEntry = GetFromOCDB(&quot;Calib&quot;, &quot;TowerCalib&quot;);</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :    if(!cdbTowEntry){   </span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :      AliZDCTowerCalib *towCalib = new AliZDCTowerCalib(&quot;ZDC&quot;);</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :      for(Int_t j=0; j&lt;5; j++){  </span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :         towCalib-&gt;SetZN1EqualCoeff(j, 1.);</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :         towCalib-&gt;SetZP1EqualCoeff(j, 1.);</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :         towCalib-&gt;SetZN2EqualCoeff(j, 1.);</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         towCalib-&gt;SetZP2EqualCoeff(j, 1.);  </span>
<span class="lineNum">     477 </span>            :      }
<span class="lineNum">     478 </span>            :      //towCalib-&gt;Print(&quot;&quot;);
<span class="lineNum">     479 </span>            :      // 
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :      AliCDBMetaData metaData;</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :      metaData.SetBeamPeriod(0);</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :      metaData.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :      metaData.SetComment(&quot;AliZDCTowerCalib object&quot;);  </span>
<span class="lineNum">     484 </span>            :      //
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :      resTowCal = Store(&quot;Calib&quot;, &quot;TowerCalib&quot;, towCalib, &amp;metaData, 0, kTRUE);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     487 </span>            :    else{ 
<span class="lineNum">     488 </span>            :      // if entry exists it is still valid (=1 for all runs!)
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :      Log(Form(&quot; Valid ZDC/Calib/TowerCalib object already existing in OCDB!!!&quot;));</span>
<span class="lineNum">     490 </span>            :      resTowCal = kTRUE;
<span class="lineNum">     491 </span>            :    }
<span class="lineNum">     492 </span>            :    
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :    if(resTowCal==kFALSE) return 7;</span>
<span class="lineNum">     494 </span>            :    
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :    return 0;</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 : }</span>
<a name="497"><span class="lineNum">     497 </span>            : </a>
<span class="lineNum">     498 </span>            : //______________________________________________________________________________________________
<span class="lineNum">     499 </span>            : UInt_t AliZDCPreprocessor::ProcessCalibData(Float_t beamEnergy)
<span class="lineNum">     500 </span>            : {
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :   TList* daqSources = GetFileSources(kDAQ, &quot;EMDENERGYCALIB&quot;);</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :   if(!daqSources){</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;No sources for CALIBRATION_EMD run %d !&quot;, fRun));</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :     return 8;</span>
<span class="lineNum">     505 </span>            :   }
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :   Log(&quot;\t List of DAQ sources for EMDENERGYCALIB id: &quot;); daqSources-&gt;Print();</span>
<span class="lineNum">     507 </span>            :   //
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :   TIter iter2(daqSources);</span>
<span class="lineNum">     509 </span>            :   TObjString* source = 0;
<span class="lineNum">     510 </span>            :   Int_t i=0;
<span class="lineNum">     511 </span>            :   Bool_t resEnCal=kTRUE, resTowCal=kTRUE;
<span class="lineNum">     512 </span>            :   
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :   while((source = dynamic_cast&lt;TObjString*&gt; (iter2.Next()))){</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     TString stringEMDFileName = GetFile(kDAQ, &quot;EMDENERGYCALIB&quot;, source-&gt;GetName());</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     if(stringEMDFileName.Length() &lt;= 0){</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :       Log(Form(&quot;No file from source %s!&quot;, source-&gt;GetName()));</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :       return 8;</span>
<span class="lineNum">     518 </span>            :     }
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     const char* emdFileName = stringEMDFileName.Data();</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     Log(Form(&quot;\t Getting file #%d: %s from %s\n&quot;,++i,emdFileName,source-&gt;GetName()));</span>
<span class="lineNum">     521 </span>            :     //
<span class="lineNum">     522 </span>            :     // --- Initializing energy calibration object
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :     AliZDCEnCalib *eCalib = new AliZDCEnCalib(&quot;ZDC&quot;);</span>
<span class="lineNum">     524 </span>            :     // --- Reading file with calibration data
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     if(emdFileName){</span>
<span class="lineNum">     526 </span>            :       FILE *file;
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :       if((file = fopen(emdFileName,&quot;r&quot;)) == NULL){</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :         printf(&quot;Cannot open file %s \n&quot;,emdFileName);</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :         return 8;</span>
<span class="lineNum">     530 </span>            :       }
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :       Log(Form(&quot;File %s connected to process data from EM dissociation events&quot;, emdFileName));</span>
<span class="lineNum">     532 </span>            :       //
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :       Float_t fitValEMD[6];</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :       for(Int_t j=0; j&lt;6; j++){        </span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :         if(j&lt;6){</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :           int iread = fscanf(file,&quot;%f&quot;,&amp;fitValEMD[j]);</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :           if(iread==0) AliDebug(3,&quot; Failing reading data from EMD calibration data file&quot;);</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :           if(fitValEMD[j]!=1.) eCalib-&gt;SetEnCalib(j, beamEnergy/fitValEMD[j]);</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :           else eCalib-&gt;SetEnCalib(j, fitValEMD[j]);</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     541 </span>            :       }
<span class="lineNum">     542 </span>            :       //
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :       fclose(file);</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     545 </span>            :     else{
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :       Log(Form(&quot;File %s not found&quot;, emdFileName));</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :       return 8;</span>
<span class="lineNum">     548 </span>            :     }
<span class="lineNum">     549 </span>            :     //eCalib-&gt;Print(&quot;&quot;);
<span class="lineNum">     550 </span>            :     // 
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :     AliCDBMetaData metaData;</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     metaData.SetBeamPeriod(0);</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :     metaData.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :     metaData.SetComment(&quot;Filling AliZDCEnCalib object&quot;);  </span>
<span class="lineNum">     555 </span>            :     //
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :     resEnCal = Store(&quot;Calib&quot;,&quot;EnergyCalib&quot;,eCalib, &amp;metaData, 0, kTRUE);</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :     if(resEnCal==kFALSE) return 6;</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :   delete daqSources; daqSources = 0;</span>
<span class="lineNum">     560 </span>            :   
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :   TList* daqSourcesH = GetFileSources(kDAQ, &quot;EMDTOWERCALIB&quot;);</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :   if(!daqSourcesH){</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;No sources for CALIBRATION_EMD run %d !&quot;, fRun));</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :     return 9;</span>
<span class="lineNum">     565 </span>            :   }
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :   Log(&quot;\t List of DAQ sources for EMDTOWERCALIB id: &quot;); daqSourcesH-&gt;Print();</span>
<span class="lineNum">     567 </span>            :   //
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :   TIter iter2H(daqSourcesH);</span>
<span class="lineNum">     569 </span>            :   TObjString* sourceH = 0;
<span class="lineNum">     570 </span>            :   Int_t iH=0;
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :   while((sourceH = dynamic_cast&lt;TObjString*&gt; (iter2H.Next()))){</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :     TString stringtowEMDFileName = GetFile(kDAQ, &quot;EMDTOWERCALIB&quot;, sourceH-&gt;GetName());</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :     if(stringtowEMDFileName.Length() &lt;= 0){</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :       Log(Form(&quot;No file from source %s!&quot;, sourceH-&gt;GetName()));</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :       return 9;</span>
<span class="lineNum">     576 </span>            :     }
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :     const char * towEMDFileName = stringtowEMDFileName.Data();</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :     Log(Form(&quot;\t Getting file #%d: %s from source %s\n&quot;,++iH,towEMDFileName,sourceH-&gt;GetName()));</span>
<span class="lineNum">     579 </span>            :     // --- Initializing energy calibration object
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :     AliZDCTowerCalib *towCalib = new AliZDCTowerCalib(&quot;ZDC&quot;);</span>
<span class="lineNum">     581 </span>            :     // --- Reading file with calibration data
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :     if(towEMDFileName){</span>
<span class="lineNum">     583 </span>            :       FILE *file;
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :       if((file = fopen(towEMDFileName,&quot;r&quot;)) == NULL){</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :         printf(&quot;Cannot open file %s \n&quot;,towEMDFileName);</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :         return 9;</span>
<span class="lineNum">     587 </span>            :       }
<span class="lineNum">     588 </span>            :       //
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :       Float_t equalCoeff[4][5];</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :       for(Int_t j=0; j&lt;4; j++){        </span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :          for(Int_t k=0; k&lt;5; k++){</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :            int leggi = fscanf(file,&quot;%f&quot;,&amp;equalCoeff[j][k]);</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :            if(leggi==0) AliDebug(3,&quot; Failing reading data from EMD calibration file&quot;);</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :            if(j==0)      towCalib-&gt;SetZN1EqualCoeff(k, equalCoeff[j][k]);</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :            else if(j==1) towCalib-&gt;SetZP1EqualCoeff(k, equalCoeff[j][k]);</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :            else if(j==2) towCalib-&gt;SetZN2EqualCoeff(k, equalCoeff[j][k]);</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :            else if(j==3) towCalib-&gt;SetZP2EqualCoeff(k, equalCoeff[j][k]);  </span>
<span class="lineNum">     598 </span>            :          }
<span class="lineNum">     599 </span>            :       }
<span class="lineNum">     600 </span>            :       //
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :       fclose(file);</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     603 </span>            :     else{
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :       Log(Form(&quot;File %s not found&quot;, towEMDFileName));</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :       return 9;</span>
<span class="lineNum">     606 </span>            :     }
<span class="lineNum">     607 </span>            :     //towCalib-&gt;Print(&quot;&quot;);
<span class="lineNum">     608 </span>            :     // 
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :     AliCDBMetaData metaData;</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     metaData.SetBeamPeriod(0);</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :     metaData.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     metaData.SetComment(&quot;Filling AliZDCTowerCalib object&quot;);  </span>
<span class="lineNum">     613 </span>            :     //
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :     resTowCal = Store(&quot;Calib&quot;,&quot;TowerCalib&quot;,towCalib, &amp;metaData, 0, kTRUE);</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :     if(resTowCal==kFALSE) return 7;</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :   delete daqSourcesH; daqSourcesH = 0;</span>
<span class="lineNum">     618 </span>            :   
<span class="lineNum">     619 </span>            :      
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 : }</span>
<a name="622"><span class="lineNum">     622 </span>            : </a>
<span class="lineNum">     623 </span>            : //______________________________________________________________________________________________
<span class="lineNum">     624 </span>            : UInt_t AliZDCPreprocessor::ProcessPedestalData()
<span class="lineNum">     625 </span>            : {
<span class="lineNum">     626 </span>            :   // ____________________________________________________________________
<span class="lineNum">     627 </span>            :   // 1: read mean values and fit parameters from ascii data file
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :   TList* daqSource1 = GetFileSources(kDAQ, &quot;PEDESTALDATA&quot;);</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :   if(!daqSource1){</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :     Log(Form(&quot;No source1 for STANDALONE_PEDESTAL run %d !&quot;, fRun));</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :     return 10;</span>
<span class="lineNum">     632 </span>            :   }
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :   if(daqSource1-&gt;GetEntries()==0) return 10;</span>
<span class="lineNum">     634 </span>            :   //
<span class="lineNum">     635 </span>            :   // ____________________________________________________________________
<span class="lineNum">     636 </span>            :   // 2: read channels to be subtracted from correlation fit (implemented from RUN2)
<span class="lineNum">     637 </span>            :   Bool_t resPedSubDecision=kFALSE;
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :   TList* daqSource2 = GetFileSources(kDAQ, &quot;PEDCORRTOFIT&quot;);</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :   if(!daqSource2){</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :     Log(Form(&quot;No source2 for STANDALONE_PEDESTAL run %d !&quot;, fRun));</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :     return 10;</span>
<span class="lineNum">     642 </span>            :   }
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :   if(daqSource2-&gt;GetEntries()==0) return 10;</span>
<span class="lineNum">     644 </span>            :   else   resPedSubDecision = kTRUE;
<span class="lineNum">     645 </span>            :   
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :   Log(&quot;\t List of DAQ sources for PEDESTALDATA id: &quot;); </span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :   daqSource1-&gt;Print();</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :   daqSource2-&gt;Print();</span>
<span class="lineNum">     649 </span>            :   //
<span class="lineNum">     650 </span>            :   // ____________________________________________________________________
<span class="lineNum">     651 </span>            :   // 1: read mean values and fit parameters from ascii data file
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :   TIter iter(daqSource1);</span>
<span class="lineNum">     653 </span>            :   TObjString* source;
<span class="lineNum">     654 </span>            :   //int i=0;
<span class="lineNum">     655 </span>            :   Bool_t resPedCal=kTRUE, resPedHist=kTRUE;
<span class="lineNum">     656 </span>            :   // --- Initializing pedestal calibration object
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :   AliZDCPedestals *pedCalib = new AliZDCPedestals(&quot;ZDC&quot;);</span>
<span class="lineNum">     658 </span>            :   
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :   while((source = dynamic_cast&lt;TObjString*&gt; (iter.Next()))){</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :      TString stringPedFileName = GetFile(kDAQ, &quot;PEDESTALDATA&quot;, source-&gt;GetName());</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :      if(stringPedFileName.Length() &lt;= 0){</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :         Log(Form(&quot;No PEDESTALDATA file from source %s!&quot;, source-&gt;GetName()));</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :         return 10;</span>
<span class="lineNum">     664 </span>            :      }
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :      const char* pedFileName = stringPedFileName.Data();</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :      Log(Form(&quot;\t Getting file %s from %s\n&quot;,pedFileName,source-&gt;GetName()));</span>
<span class="lineNum">     667 </span>            :      //
<span class="lineNum">     668 </span>            :      // --- Reading file with pedestal calibration data
<span class="lineNum">     669 </span>            :      // no. ADCch = (22 signal ch. + 2 reference PMs) * 2 gain chain = 48
<span class="lineNum">     670 </span>            :      const Int_t knZDCch = 48;
<span class="lineNum">     671 </span>            :      FILE *file;
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :      if((file = fopen(pedFileName,&quot;r&quot;)) == NULL){</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :        printf(&quot;Cannot open file %s \n&quot;,pedFileName);</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :        return 10;</span>
<span class="lineNum">     675 </span>            :      }
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :      Log(Form(&quot;File %s connected to process pedestal data&quot;, pedFileName));</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :      Float_t pedVal[(3*knZDCch)][2];</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :      for(Int_t k=0; k&lt;(3*knZDCch); k++){</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :         for(Int_t j=0; j&lt;2; j++){</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :            int aleggi = fscanf(file,&quot;%f&quot;,&amp;pedVal[k][j]);</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :            if(aleggi==0) AliDebug(3,&quot; Failing reading data from PEDESTALDATA file&quot;);</span>
<span class="lineNum">     682 </span>            :            //if(j==1) printf(&quot;pedVal[%d] -&gt; %f, %f \n&quot;,k,pedVal[k][0],pedVal[k][1]);
<span class="lineNum">     683 </span>            :         }
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :         if(k&lt;knZDCch){ // in time signals</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :           pedCalib-&gt;SetMeanPed(k,pedVal[k][0]);</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :           pedCalib-&gt;SetMeanPedWidth(k,pedVal[k][1]);</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :         else if(k&gt;=knZDCch &amp;&amp; k&lt;(2*knZDCch)){ // out of time signals</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :           pedCalib-&gt;SetOOTPed(k-knZDCch,pedVal[k][0]);</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :           pedCalib-&gt;SetOOTPedWidth(k-knZDCch,pedVal[k][1]);</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :         else if(k&gt;=(2*knZDCch) &amp;&amp; k&lt;(3*knZDCch)){ // correlazioni</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :           pedCalib-&gt;SetPedCorrCoeff(k-(2*knZDCch),pedVal[k][0],pedVal[k][1]);</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     695 </span>            :      }
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :      fclose(file);</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     698 </span>            :   // ____________________________________________________________________
<span class="lineNum">     699 </span>            :   // 2: read channels to be subtracted from correlation fit (implemented from RUN2)
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :   if(resPedSubDecision){</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :     TIter iter2(daqSource2);</span>
<span class="lineNum">     702 </span>            :     TObjString* source2;
<span class="lineNum">     703 </span>            :   
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :     while((source2 = dynamic_cast&lt;TObjString*&gt; (iter2.Next()))){</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :        TString stringFileName = GetFile(kDAQ, &quot;PEDCORRTOFIT&quot;, source2-&gt;GetName());</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :        if(stringFileName.Length() &lt;= 0){</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :           Log(Form(&quot;No PEDCORRTOFIT file from source %s!&quot;, source2-&gt;GetName()));</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :           return 10;</span>
<span class="lineNum">     709 </span>            :        }
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :        const char* pedFileName = stringFileName.Data();</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :        Log(Form(&quot;\t Getting file %s from %s\n&quot;,pedFileName,source2-&gt;GetName()));</span>
<span class="lineNum">     712 </span>            :        //
<span class="lineNum">     713 </span>            :        const Int_t kNch = 24;
<span class="lineNum">     714 </span>            :        FILE *file;
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :        if((file = fopen(pedFileName,&quot;r&quot;)) == NULL){</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :          printf(&quot;Cannot open file %s \n&quot;,pedFileName);</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :          return 10;</span>
<span class="lineNum">     718 </span>            :        }
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :        Log(Form(&quot;File %s connected to process pedestal data&quot;, pedFileName));</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :        pedCalib-&gt;SetPedModeBit(kTRUE);</span>
<span class="lineNum">     721 </span>            :        //
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :        Int_t val[kNch][2];</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :        for(Int_t k=0; k&lt;kNch; k++){</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :           for(int j=0; j&lt;2; j++){</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :              int aleggi = fscanf(file,&quot;%d&quot;,&amp;val[k][1]);</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :              if(aleggi==0) AliDebug(3,&quot; Failing reading data from PEDCORRTOFIT file&quot;);</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :              if(j==1 &amp;&amp; val[k][1]==1){</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :                pedCalib-&gt;SetSubFromCorr(k);</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :                printf(&quot;ped ch.%d -&gt; subtraction from correlation mode (%d) \n&quot;,k,val[k][j]);</span>
<span class="lineNum">     730 </span>            :              }
<span class="lineNum">     731 </span>            :           }
<span class="lineNum">     732 </span>            :       }
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :       fclose(file);</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     736 </span>            :   // 
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :   pedCalib-&gt;Print(&quot;&quot;);</span>
<span class="lineNum">     738 </span>            :   
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :   AliCDBMetaData metaData;</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :   metaData.SetBeamPeriod(0);</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :   metaData.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :   metaData.SetComment(&quot;Creating AliZDCPedestals object&quot;);  </span>
<span class="lineNum">     743 </span>            :   //
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :   resPedCal = Store(&quot;Calib&quot;,&quot;Pedestals&quot;,pedCalib, &amp;metaData, 0, kTRUE);</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :   if(resPedCal==kFALSE) return 11;</span>
<span class="lineNum">     746 </span>            :   //
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :   if(daqSource1){</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :     delete daqSource1; </span>
<span class="lineNum">     749 </span>            :     daqSource1 = 0;
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :   if(daqSource2){</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :     delete daqSource2; </span>
<span class="lineNum">     753 </span>            :     daqSource2 = 0;
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     755 </span>            :   
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :   TList* daqSourceH = GetFileSources(kDAQ, &quot;PEDESTALHISTOS&quot;);</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :   if(!daqSourceH){</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :     Log(Form(&quot;No source for PEDESTALHISTOS id run %d !&quot;, fRun));</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :     return 12;</span>
<span class="lineNum">     760 </span>            :   }
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :   Log(&quot;\t List of DAQ sources for PEDESTALHISTOS id: &quot;); daqSourceH-&gt;Print();</span>
<span class="lineNum">     762 </span>            :   //
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :   TIter iterH(daqSourceH);</span>
<span class="lineNum">     764 </span>            :   TObjString* sourceH = 0;
<span class="lineNum">     765 </span>            :   Int_t iH=0;
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :   while((sourceH = dynamic_cast&lt;TObjString*&gt; (iterH.Next()))){</span>
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :      TString stringPedFileName = GetFile(kDAQ, &quot;PEDESTALHISTOS&quot;, sourceH-&gt;GetName());</span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :      if(stringPedFileName.Length() &lt;= 0){</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :         Log(Form(&quot;No PEDESTALHISTOS file from source %s!&quot;, sourceH-&gt;GetName()));</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :         return 12;</span>
<span class="lineNum">     771 </span>            :      }
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :      const char* pedFileName = stringPedFileName.Data();</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :      Log(Form(&quot;\t Getting file #%d: %s from %s\n&quot;,++iH, pedFileName, sourceH-&gt;GetName()));</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :      resPedHist = StoreReferenceFile(pedFileName, &quot;pedestalReference.root&quot;);</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :      if(resPedHist==kFALSE) return 13;</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :   delete daqSourceH; daqSourceH=0;</span>
<span class="lineNum">     778 </span>            :   
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 : }</span>
<a name="781"><span class="lineNum">     781 </span>            : </a>
<span class="lineNum">     782 </span>            : //______________________________________________________________________________________________
<span class="lineNum">     783 </span>            : UInt_t AliZDCPreprocessor::ProcessLaserData()
<span class="lineNum">     784 </span>            : {
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :   TList* daqSources = GetFileSources(kDAQ, &quot;LASERDATA&quot;);</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :   if(!daqSources){</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;No sources for STANDALONE_LASER run %d !&quot;, fRun));</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :     return 14;</span>
<span class="lineNum">     789 </span>            :   }
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :   if(daqSources-&gt;GetEntries()==0) return 14;</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :   Log(&quot;\t List of DAQ sources for LASERDATA id: &quot;); daqSources-&gt;Print();</span>
<span class="lineNum">     792 </span>            :   //
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :   TIter iter2(daqSources);</span>
<span class="lineNum">     794 </span>            :   TObjString* source = 0;
<span class="lineNum">     795 </span>            :   Int_t i=0;
<span class="lineNum">     796 </span>            :   Bool_t resLaserCal=kTRUE, resLaserHist=kTRUE;
<span class="lineNum">     797 </span>            :   
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :   while((source = dynamic_cast&lt;TObjString*&gt; (iter2.Next()))){</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :      TString stringLaserFileName = GetFile(kDAQ, &quot;LASERDATA&quot;, source-&gt;GetName());</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :      if(stringLaserFileName.Length() &lt;= 0){</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :        Log(Form(&quot;No LASER file from source %s!&quot;, source-&gt;GetName()));</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :        return 14;</span>
<span class="lineNum">     803 </span>            :      }
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :      const char* laserFileName = stringLaserFileName.Data();</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :      Log(Form(&quot;\t Getting file #%d: %s from %s\n&quot;,++i,laserFileName,source-&gt;GetName()));</span>
<span class="lineNum">     806 </span>            :      //
<span class="lineNum">     807 </span>            :      // --- Initializing pedestal calibration object
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :      AliZDCLaserCalib *lCalib = new AliZDCLaserCalib(&quot;ZDC&quot;);</span>
<span class="lineNum">     809 </span>            :      // --- Reading file with pedestal calibration data
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :      if(laserFileName){</span>
<span class="lineNum">     811 </span>            :        FILE *file;
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :        if((file = fopen(laserFileName,&quot;r&quot;)) == NULL){</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :          printf(&quot;Cannot open file %s \n&quot;,laserFileName);</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :          return 14;</span>
<span class="lineNum">     815 </span>            :        }
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :        Log(Form(&quot;File %s connected to process data from LASER events&quot;, laserFileName));</span>
<span class="lineNum">     817 </span>            :        //
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :        Float_t ivalRead[22][4]; </span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :        for(Int_t j=0; j&lt;22; j++){</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :           for(Int_t k=0; k&lt;4; k++){</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :             int aleggi = fscanf(file,&quot;%f&quot;,&amp;ivalRead[j][k]);</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :             if(aleggi==0) AliDebug(3,&quot; Failng reading data from laser file&quot;);</span>
<span class="lineNum">     823 </span>            :             //printf(&quot; %d %1.0f  &quot;,k, ivalRead[j][k]);
<span class="lineNum">     824 </span>            :           }
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :           lCalib-&gt;SetDetector(j, (Int_t) ivalRead[j][0]);</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :           lCalib-&gt;SetSector(j, (Int_t) ivalRead[j][1]);</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :           lCalib-&gt;SetfPMValue(j, ivalRead[j][2]);</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :           lCalib-&gt;SetfPMWidth(j, ivalRead[j][3]);</span>
<span class="lineNum">     829 </span>            :        }
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :        fclose(file);</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :      }</span>
<span class="lineNum">     832 </span>            :      else{
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :        Log(Form(&quot;File %s not found&quot;, laserFileName));</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :        return 14;</span>
<span class="lineNum">     835 </span>            :      }
<span class="lineNum">     836 </span>            :      //lCalib-&gt;Print(&quot;&quot;);
<span class="lineNum">     837 </span>            :      // 
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :      AliCDBMetaData metaData;</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :      metaData.SetBeamPeriod(0);</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :      metaData.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :      metaData.SetComment(&quot;Filling AliZDCLaserCalib object&quot;);  </span>
<span class="lineNum">     842 </span>            :      //
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :      resLaserCal = Store(&quot;Calib&quot;,&quot;LaserCalib&quot;,lCalib, &amp;metaData, 0, kTRUE);</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :      if(resLaserCal==kFALSE) return 15;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :   delete daqSources; daqSources = 0;</span>
<span class="lineNum">     847 </span>            : 
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :   TList* daqSourceH = GetFileSources(kDAQ, &quot;LASERHISTOS&quot;);</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :   if(!daqSourceH){</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;No sources for STANDALONE_LASER run %d !&quot;, fRun));</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :     return 16;</span>
<span class="lineNum">     852 </span>            :   }
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :   Log(&quot;\t List of DAQ sources for LASERHISTOS id: &quot;); daqSourceH-&gt;Print();</span>
<span class="lineNum">     854 </span>            :   //
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :   TIter iter2H(daqSourceH);</span>
<span class="lineNum">     856 </span>            :   TObjString* sourceH = 0;
<span class="lineNum">     857 </span>            :   Int_t iH=0;
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :   while((sourceH = dynamic_cast&lt;TObjString*&gt; (iter2H.Next()))){</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :      Log(Form(&quot;\t Getting file #%d\n&quot;,++iH));</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :      TString stringLaserFileName = GetFile(kDAQ, &quot;LASERHISTOS&quot;, sourceH-&gt;GetName());</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :      if(stringLaserFileName.Length() &lt;= 0){</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :        Log(Form(&quot;No LASER file from source %s!&quot;, sourceH-&gt;GetName()));</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :        return 16;</span>
<span class="lineNum">     864 </span>            :      }
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :      resLaserHist = StoreReferenceFile(stringLaserFileName.Data(), &quot;laserReference.root&quot;);</span>
<span class="lineNum">     866 </span>            :      //
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :      if(resLaserHist==kFALSE) return 17;</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :   delete daqSourceH; daqSourceH = 0;</span>
<span class="lineNum">     870 </span>            :   
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     873 </span>            : 
<a name="874"><span class="lineNum">     874 </span>            : </a>
<span class="lineNum">     875 </span>            : //______________________________________________________________________________________________
<span class="lineNum">     876 </span>            : UInt_t AliZDCPreprocessor::ProcessMBCalibData()
<span class="lineNum">     877 </span>            : {
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :   TList* daqSources = GetFileSources(kDAQ, &quot;MBCALIB&quot;);</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :   if(!daqSources){</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;No sources for CALIBRATION_MB run %d !&quot;, fRun));</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :     return 18;</span>
<span class="lineNum">     882 </span>            :   }
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :   if(daqSources-&gt;GetEntries()==0) return 18;</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :   Log(&quot;\t List of DAQ sources for MBCALIB id: &quot;); daqSources-&gt;Print();</span>
<span class="lineNum">     885 </span>            :   //
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :   TIter iter2(daqSources);</span>
<span class="lineNum">     887 </span>            :   TObjString* source = 0;
<span class="lineNum">     888 </span>            :   Int_t i=0;
<span class="lineNum">     889 </span>            :   Bool_t resMBCal=kTRUE;
<span class="lineNum">     890 </span>            :   
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :   while((source = dynamic_cast&lt;TObjString*&gt; (iter2.Next()))){</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :      TString stringMBFileName = GetFile(kDAQ, &quot;MBCALIB&quot;, source-&gt;GetName());</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :      if(stringMBFileName.Length() &lt;= 0){</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :        Log(Form(&quot;No MBCALIB file from source %s!&quot;, source-&gt;GetName()));</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :        return 18;</span>
<span class="lineNum">     896 </span>            :      }
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :      const char* mbFileName = stringMBFileName.Data();</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :      Log(Form(&quot;\t Getting file #%d: %s from %s\n&quot;,++i,mbFileName,source-&gt;GetName()));</span>
<span class="lineNum">     899 </span>            :      //
<span class="lineNum">     900 </span>            :      // --- Initializing calibration object
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :      AliZDCMBCalib *mbCalib = new AliZDCMBCalib(&quot;ZDC&quot;);</span>
<span class="lineNum">     902 </span>            :      // --- Reading file with calibration data
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :      if(mbFileName){</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :        TFile * fileHistos = TFile::Open(mbFileName);</span>
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :        Log(Form(&quot;File %s connected to process data from CALIBRATION_MB events&quot;, mbFileName));</span>
<span class="lineNum">     906 </span>            :        //
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :        fileHistos-&gt;cd();</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :        TH2F *hZDCvsZEM = (TH2F*)  fileHistos-&gt;Get(&quot;hZDCvsZEM&quot;);</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :        TH2F *hZDCCvsZEM = (TH2F*) fileHistos-&gt;Get(&quot;hZDCCvsZEM&quot;);</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :        TH2F *hZDCAvsZEM = (TH2F*) fileHistos-&gt;Get(&quot;hZDCAvsZEM&quot;);</span>
<span class="lineNum">     911 </span>            :        //
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :        mbCalib-&gt;SetZDCvsZEM(hZDCvsZEM);</span>
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :        mbCalib-&gt;SetZDCCvsZEM(hZDCCvsZEM);</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :        mbCalib-&gt;SetZDCAvsZEM(hZDCAvsZEM);</span>
<span class="lineNum">     915 </span>            :        //
<span class="lineNum">     916 </span>            :        //fileHistos-&gt;Close();
<span class="lineNum">     917 </span>            :      }
<span class="lineNum">     918 </span>            :      else{
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :        Log(Form(&quot;File %s not found&quot;, mbFileName));</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :        return 14;</span>
<span class="lineNum">     921 </span>            :      }
<span class="lineNum">     922 </span>            :      // 
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :      AliCDBMetaData metaData;</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :      metaData.SetBeamPeriod(0);</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :      metaData.SetResponsible(&quot;Chiara Oppedisano&quot;);</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :      metaData.SetComment(&quot;Filling AliZDCMBCalib object&quot;);  </span>
<span class="lineNum">     927 </span>            :      //
<span class="lineNum">     928 </span>            :      //mbCalib-&gt;Dump();
<span class="lineNum">     929 </span>            :      //
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :      resMBCal = Store(&quot;Calib&quot;,&quot;MBCalib&quot;,mbCalib, &amp;metaData, 0, kTRUE);</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :      if(resMBCal==kFALSE) return 19;</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :   delete daqSources; daqSources = 0;</span>
<span class="lineNum">     934 </span>            :   
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 : }</span>
<a name="937"><span class="lineNum">     937 </span>            : </a>
<span class="lineNum">     938 </span>            : //______________________________________________________________________________________________
<span class="lineNum">     939 </span>            : UInt_t AliZDCPreprocessor::Process(TMap* dcsAliasMap)
<span class="lineNum">     940 </span>            : {
<span class="lineNum">     941 </span>            :  UInt_t resDCS = 0;
<span class="lineNum">     942 </span>            :  UInt_t resChMap=0;
<span class="lineNum">     943 </span>            :  UInt_t resEnergyCalib=0, resPedestalCalib=0, resLaserCalib=0, resMBCalib=0;
<span class="lineNum">     944 </span>            : 
<span class="lineNum">     945 </span>            :  // ************************* Process DCS data ****************************
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :  if(ProcessDCS()) resDCS = ProcessDCSData(dcsAliasMap);</span>
<span class="lineNum">     947 </span>            :   
<span class="lineNum">     948 </span>            :  // ********************************* From DAQ ************************************
<span class="lineNum">     949 </span>            : 
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :  const char* beamType = GetRunParameter(&quot;beamType&quot;);</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :  TString runType = GetRunType();</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :  Float_t beamEnergy = (Float_t)(((TString)GetRunParameter(&quot;beamEnergy&quot;)).Atof()); </span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :  printf(&quot;\t **** AliZDCPreprocessor -&gt; runType %s, beamType %s,  beamEnergy %1.0f ****\n&quot;,</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :         runType.Data(),beamType,beamEnergy);</span>
<span class="lineNum">     955 </span>            : 
<span class="lineNum">     956 </span>            :  // ******************************************
<span class="lineNum">     957 </span>            :  // ADC channel mapping
<span class="lineNum">     958 </span>            :  // ******************************************
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :  resChMap = ProcessChMap();</span>
<span class="lineNum">     960 </span>            :  
<span class="lineNum">     961 </span>            :  // ******************************************
<span class="lineNum">     962 </span>            :  // Calibration param. for p-p data (all = 1)
<span class="lineNum">     963 </span>            :  // ******************************************
<span class="lineNum">     964 </span>            :  // NO ENERGY CALIBRATION -&gt; coefficients set to 1.
<span class="lineNum">     965 </span>            :  // Temp -&gt; also inter-calibration coefficients are set to 1.
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :  if((strcmp(beamType,&quot;p-p&quot;)==0) || (strcmp(beamType,&quot;P-P&quot;)==0) </span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :      || (strcmp(beamType,&quot;P-A&quot;)==0) || (strcmp(beamType,&quot;A-P&quot;)==0)) </span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :         resEnergyCalib = ProcessppData();</span>
<span class="lineNum">     969 </span>            :  
<span class="lineNum">     970 </span>            :  // *****************************************************
<span class="lineNum">     971 </span>            :  // CALIBRATION_EMD -&gt; Energy calibration and equalization
<span class="lineNum">     972 </span>            :  // *****************************************************
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :  if((strcmp(beamType,&quot;A-A&quot;)==0) &amp;&amp; (runType.CompareTo(&quot;CALIBRATION_EMD&quot;)==0)) </span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :    resEnergyCalib =  ProcessCalibData(beamEnergy);</span>
<span class="lineNum">     975 </span>            :  
<span class="lineNum">     976 </span>            :  // *****************************************************
<span class="lineNum">     977 </span>            :  // STANDALONE_PEDESTALS -&gt; Pedestal subtraction 
<span class="lineNum">     978 </span>            :  // *****************************************************
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :  if(runType.CompareTo(&quot;STANDALONE_PEDESTAL&quot;)==0) resPedestalCalib = ProcessPedestalData();</span>
<span class="lineNum">     980 </span>            :  
<span class="lineNum">     981 </span>            :  // *****************************************************
<span class="lineNum">     982 </span>            :  // STANDALONE_LASER -&gt; Signal stability and ageing 
<span class="lineNum">     983 </span>            :  // *****************************************************
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :  else if(runType.CompareTo(&quot;STANDALONE_LASER&quot;)==0) resLaserCalib = ProcessLaserData();</span>
<span class="lineNum">     985 </span>            : 
<span class="lineNum">     986 </span>            :  // *****************************************************
<span class="lineNum">     987 </span>            :  // CALIBRATION_MB -&gt; Signal stability and ageing 
<span class="lineNum">     988 </span>            :  // *****************************************************
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :  else if(runType.CompareTo(&quot;CALIBRATION_MB&quot;)==0) resMBCalib = ProcessMBCalibData();</span>
<span class="lineNum">     990 </span>            :  
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :  if(resDCS!=0)                return resDCS;</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :  else if(resChMap!=0)         return resChMap;</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :  else if(resEnergyCalib!=0)   return resEnergyCalib;</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :  else if(resPedestalCalib!=0) return resPedestalCalib;</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :  else if(resLaserCalib!=0)    return resLaserCalib;</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :  else if(resMBCalib!=0)       return resMBCalib;</span>
<span class="lineNum">     997 </span>            :  
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :  return 0;</span>
<span class="lineNum">     999 </span>            :   
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
