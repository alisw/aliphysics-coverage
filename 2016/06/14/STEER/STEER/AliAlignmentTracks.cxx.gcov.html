<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - STEER/STEER/AliAlignmentTracks.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">STEER/STEER</a> - AliAlignmentTracks.cxx<span style="font-size: 80%;"> (source / <a href="AliAlignmentTracks.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">607</td>
            <td class="headerCovTableEntryLo">0.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">33</td>
            <td class="headerCovTableEntryLo">3.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : //-----------------------------------------------------------------
<span class="lineNum">      17 </span>            : //   Implementation of the alignment steering class
<span class="lineNum">      18 </span>            : //   It provides an access to the track space points
<span class="lineNum">      19 </span>            : //   written along the esd tracks. The class enables
<span class="lineNum">      20 </span>            : //   the user to plug any track fitter (deriving from
<span class="lineNum">      21 </span>            : //   AliTrackFitter class) and minimization fo the
<span class="lineNum">      22 </span>            : //   track residual sums (deriving from the AliTrackResiduals).
<span class="lineNum">      23 </span>            : //-----------------------------------------------------------------
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : #include &lt;TChain.h&gt;
<span class="lineNum">      26 </span>            : #include &lt;TFile.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;TVector3.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;TSystem.h&gt;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &quot;AliAlignmentTracks.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;AliTrackPointArray.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;AliAlignObjParams.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;AliTrackFitterRieman.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;AliTrackResidualsChi2.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;AliESDEvent.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;AliLog.h&quot;
<a name="37"><span class="lineNum">      37 </span>            : #include &quot;AliESDfriend.h&quot;</a>
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span><span class="lineCov">        126 : ClassImp(AliAlignmentTracks)</span>
<a name="40"><span class="lineNum">      40 </span>            : </a>
<span class="lineNum">      41 </span>            : //______________________________________________________________________________
<span class="lineNum">      42 </span><span class="lineNoCov">          0 : AliAlignmentTracks::AliAlignmentTracks():</span>
<span class="lineNum">      43 </span><span class="lineNoCov">          0 :   fESDChain(0),</span>
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :   fPointsFilename(&quot;AliTrackPoints.root&quot;),</span>
<span class="lineNum">      45 </span><span class="lineNoCov">          0 :   fPointsFile(0),</span>
<span class="lineNum">      46 </span><span class="lineNoCov">          0 :   fPointsTree(0),</span>
<span class="lineNum">      47 </span><span class="lineNoCov">          0 :   fLastIndex(0),</span>
<span class="lineNum">      48 </span><span class="lineNoCov">          0 :   fArrayIndex(0),</span>
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :   fIsIndexBuilt(kFALSE),</span>
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :   fAlignObjs(0),</span>
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :   fMisalignObjs(0),</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   fTrackFitter(0),</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :   fMinimizer(0),</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :   fDoUpdate(kTRUE),</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :   fCovIsUsed(kFALSE)</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      57 </span>            :   // Default constructor
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :   InitIndex();</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :   InitAlignObjs();</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 : }</span>
<a name="61"><span class="lineNum">      61 </span>            : </a>
<span class="lineNum">      62 </span>            : //______________________________________________________________________________
<span class="lineNum">      63 </span><span class="lineNoCov">          0 : AliAlignmentTracks::AliAlignmentTracks(TChain *esdchain):</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :   fESDChain(esdchain),</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   fPointsFilename(&quot;AliTrackPoints.root&quot;),</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :   fPointsFile(0),</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :   fPointsTree(0),</span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :   fLastIndex(0),</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :   fArrayIndex(0),</span>
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :   fIsIndexBuilt(kFALSE),</span>
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :   fAlignObjs(0),</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :   fMisalignObjs(0),</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :   fTrackFitter(0),</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :   fMinimizer(0),</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :   fDoUpdate(kTRUE),</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :   fCovIsUsed(kFALSE)</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">      78 </span>            :   // Constructor in the case
<span class="lineNum">      79 </span>            :   // the user provides an already
<span class="lineNum">      80 </span>            :   // built TChain with ESD trees
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :   InitIndex();</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :   InitAlignObjs();</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      84 </span>            : 
<a name="85"><span class="lineNum">      85 </span>            : </a>
<span class="lineNum">      86 </span>            : //______________________________________________________________________________
<span class="lineNum">      87 </span><span class="lineNoCov">          0 : AliAlignmentTracks::AliAlignmentTracks(const char *esdfilename, const char *esdtreename):</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :   fESDChain(new TChain(esdtreename)),</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :   fPointsFilename(&quot;AliTrackPoints.root&quot;),</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :   fPointsFile(0),</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :   fPointsTree(0),</span>
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :   fLastIndex(0),</span>
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :   fArrayIndex(0),</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :   fIsIndexBuilt(kFALSE),</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :   fAlignObjs(0),</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :   fMisalignObjs(0),</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :   fTrackFitter(0),</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   fMinimizer(0),</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :   fDoUpdate(kTRUE),</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   fCovIsUsed(kFALSE)</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     102 </span>            :   // Constructor in the case
<span class="lineNum">     103 </span>            :   // the user provides a single ESD file
<span class="lineNum">     104 </span>            :   // or a directory containing ESD files
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :   fESDChain-&gt;Add(esdfilename);</span>
<span class="lineNum">     106 </span>            : 
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :   InitIndex();</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   InitAlignObjs();</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     110 </span>            : 
<a name="111"><span class="lineNum">     111 </span>            : </a>
<span class="lineNum">     112 </span>            : //______________________________________________________________________________
<span class="lineNum">     113 </span>            : AliAlignmentTracks::~AliAlignmentTracks()
<span class="lineNum">     114 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     115 </span>            :   // Destructor
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :   if (fESDChain) delete fESDChain;</span>
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :   DeleteIndex();</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :   DeleteAlignObjs();</span>
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :   delete fTrackFitter;</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :   delete fMinimizer;</span>
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   if (fPointsFile) fPointsFile-&gt;Close();</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 : }</span>
<a name="126"><span class="lineNum">     126 </span>            : </a>
<span class="lineNum">     127 </span>            : //______________________________________________________________________________
<span class="lineNum">     128 </span>            : void AliAlignmentTracks::AddESD(TChain *esdchain)
<span class="lineNum">     129 </span>            : {
<span class="lineNum">     130 </span>            :   // Add a chain with ESD files
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   if (fESDChain)</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :     fESDChain-&gt;Add(esdchain);</span>
<span class="lineNum">     133 </span>            :   else
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :     fESDChain = esdchain;</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 : }</span>
<a name="136"><span class="lineNum">     136 </span>            : </a>
<span class="lineNum">     137 </span>            : //______________________________________________________________________________
<span class="lineNum">     138 </span>            : void AliAlignmentTracks::AddESD(const char *esdfilename, const char *esdtreename)
<span class="lineNum">     139 </span>            : {
<span class="lineNum">     140 </span>            :   // Add a single file or
<span class="lineNum">     141 </span>            :   // a directory to the chain
<span class="lineNum">     142 </span>            :   // with the ESD files
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :   if (fESDChain)</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :     fESDChain-&gt;AddFile(esdfilename,TChain::kBigNumber,esdtreename);</span>
<span class="lineNum">     145 </span>            :   else {
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :     fESDChain = new TChain(esdtreename);</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     fESDChain-&gt;Add(esdfilename);</span>
<span class="lineNum">     148 </span>            :   }
<span class="lineNum">     149 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     150 </span>            : 
<a name="151"><span class="lineNum">     151 </span>            : </a>
<span class="lineNum">     152 </span>            : //________________________________________________________________________
<span class="lineNum">     153 </span>            : void AliAlignmentTracks::ProcessESD(Bool_t onlyITS,
<span class="lineNum">     154 </span>            :                                     Int_t minITSpts,
<span class="lineNum">     155 </span>            :                                     Bool_t cuts,
<span class="lineNum">     156 </span>            :                                     Float_t minAngleWrtITSModulePlanes,
<span class="lineNum">     157 </span>            :                                     Float_t minMom,Float_t maxMom,
<span class="lineNum">     158 </span>            :                                     Float_t minAbsSinPhi,Float_t maxAbsSinPhi,
<span class="lineNum">     159 </span>            :                                     Float_t minSinTheta,Float_t maxSinTheta)
<span class="lineNum">     160 </span>            : {
<span class="lineNum">     161 </span>            :   // Analyzes and filters ESD tracks
<span class="lineNum">     162 </span>            :   // Stores the selected track space points
<span class="lineNum">     163 </span>            :   // into the output file
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   if (!fESDChain) return;</span>
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :   AliESDEvent *esd = new AliESDEvent();</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :   esd-&gt;ReadFromTree(fESDChain);</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :   AliESDfriend *esdf = 0; </span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :   fESDChain-&gt;SetBranchStatus(&quot;ESDfriend*&quot;,1);</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :   fESDChain-&gt;SetBranchAddress(&quot;ESDfriend.&quot;,&amp;esdf);</span>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            :   // Open the output file
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :   if (fPointsFilename.IsNull()) {</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     AliWarning(&quot;Incorrect output filename!&quot;);</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     177 </span>            :   }
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :   TFile *pointsFile = TFile::Open(fPointsFilename,&quot;RECREATE&quot;);</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   if (!pointsFile || !pointsFile-&gt;IsOpen()) {</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Can't open %s !&quot;,fPointsFilename.Data()));</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     183 </span>            :   }
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   TTree *pointsTree = new TTree(&quot;spTree&quot;, &quot;Tree with track space point arrays&quot;);</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   const AliTrackPointArray *array = 0;</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   AliTrackPointArray *array2 = 0;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   if(onlyITS) {   // only ITS AliTrackPoints </span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :     pointsTree-&gt;Branch(&quot;SP&quot;,&quot;AliTrackPointArray&quot;, &amp;array2);</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :     pointsTree-&gt;Branch(&quot;SP&quot;,&quot;AliTrackPointArray&quot;, &amp;array);</span>
<span class="lineNum">     192 </span>            :   } 
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            :   Int_t ievent = 0;
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :   while (fESDChain-&gt;GetEntry(ievent++)) {</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :     if (!esd) break;</span>
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     esd-&gt;SetESDfriend(esdf); //Attach the friend to the ESD</span>
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     Int_t ntracks = esd-&gt;GetNumberOfTracks();</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     for (Int_t itrack=0; itrack &lt; ntracks; itrack++) {</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :       AliESDtrack * track = esd-&gt;GetTrack(itrack);</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :       if (!track) continue;</span>
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :       if(track-&gt;GetNcls(0) &lt; minITSpts) continue;</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :       if(cuts) {</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :         if(track-&gt;GetP()&lt;minMom || track-&gt;GetP()&gt;maxMom) continue;</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :         Float_t abssinphi = TMath::Abs(TMath::Sin(track-&gt;GetAlpha()+TMath::ASin(track-&gt;GetSnp())));</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :         if(abssinphi&lt;minAbsSinPhi || abssinphi&gt;maxAbsSinPhi) continue;</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :         Float_t sintheta = TMath::Sin(0.5*TMath::Pi()-TMath::ATan(track-&gt;GetTgl()));</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :         if(sintheta&lt;minSinTheta || sintheta&gt;maxSinTheta) continue;</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :       } </span>
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :       AliTrackPoint point;</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :       array = track-&gt;GetTrackPointArray();</span>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :       if(onlyITS) {</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :         Bool_t layerOK[6]={kTRUE,kTRUE,kTRUE,kTRUE,kTRUE,kTRUE};</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :         Int_t ipt,volId,modId,layerId;</span>
<span class="lineNum">     220 </span>            :         Int_t jpt=0;
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         for(ipt=0; ipt&lt;array-&gt;GetNPoints(); ipt++) {</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :           array-&gt;GetPoint(point,ipt);</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :           volId = point.GetVolumeID();</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :           layerId = AliGeomManager::VolUIDToLayer(volId,modId);</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :           if(layerId&gt;6) continue;</span>
<span class="lineNum">     226 </span>            :           // check minAngleWrtITSModulePlanes
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :           if(cuts) {</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :             Double_t p[3]; track-&gt;GetDirection(p);</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :             TVector3 pvec(p[0],p[1],p[2]);</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :             Double_t rot[9]; AliGeomManager::GetOrigRotation(volId,rot);</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :             TVector3 normvec(rot[1],rot[4],rot[7]);</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :             Double_t angle = pvec.Angle(normvec);</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :             if(angle&gt;0.5*TMath::Pi()) angle = TMath::Pi()-angle;</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :             angle = 0.5*TMath::Pi()-angle;</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :             if(angle&lt;minAngleWrtITSModulePlanes) {</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :               layerOK[layerId-1]=kFALSE;</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">     238 </span>            :             }
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :           jpt++;</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :         if(jpt &lt; minITSpts) continue;      </span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :         array2 = new AliTrackPointArray(jpt);</span>
<span class="lineNum">     244 </span>            :         jpt=0;
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         for(ipt=0; ipt&lt;array-&gt;GetNPoints(); ipt++) {</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :           array-&gt;GetPoint(point,ipt);</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :           volId = point.GetVolumeID();</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :           layerId = AliGeomManager::VolUIDToLayer(volId,modId);</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :           if(layerId&gt;6 || !layerOK[layerId-1]) continue;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :           array2-&gt;AddPoint(jpt,&amp;point);</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :           jpt++;</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :       } // end if(onlyITS)</span>
<span class="lineNum">     254 </span>            :  
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :       pointsTree-&gt;Fill();</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     257 </span>            :   }
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :   if (!pointsTree-&gt;Write()) {</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :     AliWarning(&quot;Can't write the tree with track point arrays!&quot;);</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     262 </span>            :   }
<span class="lineNum">     263 </span>            : 
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :   pointsFile-&gt;Close();</span>
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :   return;</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 : }</span>
<a name="268"><span class="lineNum">     268 </span>            : </a>
<span class="lineNum">     269 </span>            : //_____________________________________________________________________________
<span class="lineNum">     270 </span>            : void AliAlignmentTracks::ProcessESDCosmics(Bool_t onlyITS,
<span class="lineNum">     271 </span>            :                                    Int_t minITSpts,Float_t maxMatchingAngle,
<span class="lineNum">     272 </span>            :                                    Bool_t cuts,
<span class="lineNum">     273 </span>            :                                    Float_t minAngleWrtITSModulePlanes,
<span class="lineNum">     274 </span>            :                                    Float_t minMom,Float_t maxMom,
<span class="lineNum">     275 </span>            :                                    Float_t minAbsSinPhi,Float_t maxAbsSinPhi,
<span class="lineNum">     276 </span>            :                                    Float_t minSinTheta,Float_t maxSinTheta)
<span class="lineNum">     277 </span>            : {
<span class="lineNum">     278 </span>            :   // Analyzes and filters ESD tracks
<span class="lineNum">     279 </span>            :   // Merges inward and outward tracks in one single track
<span class="lineNum">     280 </span>            :   // Stores the selected track space points
<span class="lineNum">     281 </span>            :   // into the output file
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :   if (!fESDChain) return;</span>
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :   AliESDEvent *esd = new AliESDEvent();</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :   esd-&gt;ReadFromTree(fESDChain);</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :   AliESDfriend *esdf = 0; </span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   fESDChain-&gt;SetBranchStatus(&quot;ESDfriend*&quot;,1);</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   fESDChain-&gt;SetBranchAddress(&quot;ESDfriend.&quot;,&amp;esdf);</span>
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :   // Open the output file
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :   if (fPointsFilename.IsNull()) {</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     AliWarning(&quot;Incorrect output filename!&quot;);</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     295 </span>            :   }
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :   TFile *pointsFile = TFile::Open(fPointsFilename,&quot;RECREATE&quot;);</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :   if (!pointsFile || !pointsFile-&gt;IsOpen()) {</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Can't open %s !&quot;,fPointsFilename.Data()));</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     301 </span>            :   }
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :   TTree *pointsTree = new TTree(&quot;spTree&quot;, &quot;Tree with track space point arrays&quot;);</span>
<span class="lineNum">     304 </span>            :   const AliTrackPointArray *array = 0;
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :   AliTrackPointArray *array2 = 0;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :   pointsTree-&gt;Branch(&quot;SP&quot;,&quot;AliTrackPointArray&quot;, &amp;array2);</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span>            :   Int_t ievent = 0;
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :   while (fESDChain-&gt;GetEntry(ievent++)) {</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :     if (!esd) break;</span>
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :     esd-&gt;SetESDfriend(esdf); //Attach the friend to the ESD</span>
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     Int_t ntracks = esd-&gt;GetNumberOfTracks();</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     if(ntracks&lt;2) continue;</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :     Int_t *goodtracksArray = new Int_t[ntracks];</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     Float_t *phiArray = new Float_t[ntracks];</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :     Float_t *thetaArray = new Float_t[ntracks];</span>
<span class="lineNum">     319 </span>            :     Int_t ngt=0;
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     for (Int_t itrack=0; itrack &lt; ntracks; itrack++) {</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :       AliESDtrack * track = esd-&gt;GetTrack(itrack);</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :       if (!track) continue;</span>
<span class="lineNum">     323 </span>            : 
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :       if(track-&gt;GetNcls(0) &lt; minITSpts) continue;</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :       Float_t phi = track-&gt;GetAlpha()+TMath::ASin(track-&gt;GetSnp());</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :       Float_t theta = 0.5*TMath::Pi()-TMath::ATan(track-&gt;GetTgl());</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :       if(cuts) {</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :         if(track-&gt;GetP()&lt;minMom || track-&gt;GetP()&gt;maxMom) continue;</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :         Float_t abssinphi = TMath::Abs(TMath::Sin(phi));</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :         if(abssinphi&lt;minAbsSinPhi || abssinphi&gt;maxAbsSinPhi) continue;</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :         Float_t sintheta = TMath::Sin(theta);</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :         if(sintheta&lt;minSinTheta || sintheta&gt;maxSinTheta) continue;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :       } </span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :       goodtracksArray[ngt]=itrack;</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       phiArray[ngt]=phi;</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :       thetaArray[ngt]=theta;</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :       ngt++;</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     if(ngt&lt;2) {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       delete [] goodtracksArray; goodtracksArray=0;</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :       delete [] phiArray; phiArray=0;</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :       delete [] thetaArray; thetaArray=0;</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     345 </span>            :     }
<span class="lineNum">     346 </span>            : 
<span class="lineNum">     347 </span>            :     // check matching of the two tracks from the muon
<span class="lineNum">     348 </span>            :     Float_t min = 10000000.;
<span class="lineNum">     349 </span>            :     Int_t good1 = -1, good2 = -1;
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     for(Int_t itr1=0; itr1&lt;ngt-1; itr1++) {</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :       for(Int_t itr2=itr1+1; itr2&lt;ngt; itr2++) {</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :         Float_t deltatheta = TMath::Abs(TMath::Pi()-thetaArray[itr1]-thetaArray[itr2]);</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :         if(deltatheta&gt;maxMatchingAngle) continue;</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :         Float_t deltaphi = TMath::Abs(TMath::Abs(phiArray[itr1]-phiArray[itr2])-TMath::Pi());</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :         if(deltaphi&gt;maxMatchingAngle) continue;</span>
<span class="lineNum">     356 </span>            :         //printf(&quot;%f  %f     %f  %f\n&quot;,deltaphi,deltatheta,thetaArray[itr1],thetaArray[itr2]);
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :         if(deltatheta+deltaphi&lt;min) {</span>
<span class="lineNum">     358 </span>            :           min=deltatheta+deltaphi;
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :           good1 = goodtracksArray[itr1];</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :           good2 = goodtracksArray[itr2];</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     363 </span>            :     }
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :     delete [] goodtracksArray; goodtracksArray=0;</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :     delete [] phiArray; phiArray=0;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     delete [] thetaArray; thetaArray=0;</span>
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     if(good1&lt;0) continue;</span>
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :     AliESDtrack * track1 = esd-&gt;GetTrack(good1);</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :     AliESDtrack * track2 = esd-&gt;GetTrack(good2);</span>
<span class="lineNum">     373 </span>            : 
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :     AliTrackPoint point;</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     Int_t ipt,volId,modId,layerId;</span>
<span class="lineNum">     376 </span>            :     Int_t jpt=0;
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     Bool_t layerOK[6][2]; </span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :     for(Int_t l1=0;l1&lt;6;l1++) for(Int_t l2=0;l2&lt;2;l2++) layerOK[l1][l2]=kTRUE; </span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :     array = track1-&gt;GetTrackPointArray();</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     for(ipt=0; ipt&lt;array-&gt;GetNPoints(); ipt++) {</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :       array-&gt;GetPoint(point,ipt);</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :       if(onlyITS) {</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :         volId = point.GetVolumeID();</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :         layerId = AliGeomManager::VolUIDToLayer(volId,modId);</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :         if(layerId&gt;6) continue;</span>
<span class="lineNum">     386 </span>            :         // check minAngleWrtITSModulePlanes
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :         if(cuts) {</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :           Double_t p[3]; track1-&gt;GetDirection(p);</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :           TVector3 pvec(p[0],p[1],p[2]);</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :           Double_t rot[9]; AliGeomManager::GetOrigRotation(volId,rot);</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :           TVector3 normvec(rot[1],rot[4],rot[7]);</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :           Double_t angle = pvec.Angle(normvec);</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :           if(angle&gt;0.5*TMath::Pi()) angle = TMath::Pi()-angle;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :           angle = 0.5*TMath::Pi()-angle;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :           if(angle&lt;minAngleWrtITSModulePlanes) {</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :             layerOK[layerId-1][0]=kFALSE;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     398 </span>            :           }
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     400 </span>            :       }
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :       jpt++;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :     array = track2-&gt;GetTrackPointArray();</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     for(ipt=0; ipt&lt;array-&gt;GetNPoints(); ipt++) {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :       array-&gt;GetPoint(point,ipt);</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :       if(onlyITS) {</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :         volId = point.GetVolumeID();</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :         layerId = AliGeomManager::VolUIDToLayer(volId,modId);</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :         if(layerId&gt;6) continue;</span>
<span class="lineNum">     410 </span>            :         // check minAngleWrtITSModulePlanes
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :         if(cuts) {</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :           Double_t p[3]; track2-&gt;GetDirection(p);</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :           TVector3 pvec(p[0],p[1],p[2]);</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :           Double_t rot[9]; AliGeomManager::GetOrigRotation(volId,rot);</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :           TVector3 normvec(rot[1],rot[4],rot[7]);</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :           Double_t angle = pvec.Angle(normvec);</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :           if(angle&gt;0.5*TMath::Pi()) angle = TMath::Pi()-angle;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :           angle = 0.5*TMath::Pi()-angle;</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :           if(angle&lt;minAngleWrtITSModulePlanes) {</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :             layerOK[layerId-1][0]=kFALSE;</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     422 </span>            :           }
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     424 </span>            :       }
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :       jpt++;</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :     if(jpt &lt; 2*minITSpts) continue;</span>
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :     array2 = new AliTrackPointArray(jpt);</span>
<span class="lineNum">     430 </span>            :     jpt=0;
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :     array = track1-&gt;GetTrackPointArray();</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :     for(ipt=0; ipt&lt;array-&gt;GetNPoints(); ipt++) {</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :       array-&gt;GetPoint(point,ipt);</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :       if(onlyITS) {</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :         volId = point.GetVolumeID();</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :         layerId = AliGeomManager::VolUIDToLayer(volId,modId);</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :         if(layerId&gt;6 || !layerOK[layerId-1][0]) continue;</span>
<span class="lineNum">     438 </span>            :       }
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :       array2-&gt;AddPoint(jpt,&amp;point);</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :       jpt++;</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :     array = track2-&gt;GetTrackPointArray();</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :     for(ipt=0; ipt&lt;array-&gt;GetNPoints(); ipt++) {</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :       array-&gt;GetPoint(point,ipt);</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :       if(onlyITS) {</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :         volId = point.GetVolumeID();</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :         layerId = AliGeomManager::VolUIDToLayer(volId,modId);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :         if(layerId&gt;6 || !layerOK[layerId-1][1]) continue;</span>
<span class="lineNum">     449 </span>            :       }
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :       array2-&gt;AddPoint(jpt,&amp;point);</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :       jpt++;</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     pointsTree-&gt;Fill();</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :   if (!pointsTree-&gt;Write()) {</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :     AliWarning(&quot;Can't write the tree with track point arrays!&quot;);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     460 </span>            :   }
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :   pointsFile-&gt;Close();</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :   return;</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 : }</span>
<a name="465"><span class="lineNum">     465 </span>            : </a>
<span class="lineNum">     466 </span>            : //______________________________________________________________________________
<span class="lineNum">     467 </span>            : void AliAlignmentTracks::ProcessESD(TSelector *selector)
<span class="lineNum">     468 </span>            : {
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :   AliWarning(Form(&quot;ESD processing based on selector is not yet implemented (%p) !&quot;,selector));</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 : }</span>
<a name="471"><span class="lineNum">     471 </span>            : </a>
<span class="lineNum">     472 </span>            : //______________________________________________________________________________
<span class="lineNum">     473 </span>            : void AliAlignmentTracks::BuildIndex()
<span class="lineNum">     474 </span>            : {
<span class="lineNum">     475 </span>            :   // Build index of points tree entries
<span class="lineNum">     476 </span>            :   // Used for access based on the volume IDs
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :   if (fIsIndexBuilt) return;</span>
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :   fIsIndexBuilt = kTRUE;</span>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span>            :   // Dummy object is created in order
<span class="lineNum">     482 </span>            :   // to initialize the volume paths
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :   AliAlignObjParams alobj;</span>
<span class="lineNum">     484 </span>            : 
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :   fPointsFile = TFile::Open(fPointsFilename);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :   if (!fPointsFile || !fPointsFile-&gt;IsOpen()) {</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :     AliWarning(Form(&quot;Can't open %s !&quot;,fPointsFilename.Data()));</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     489 </span>            :   }
<span class="lineNum">     490 </span>            :   
<span class="lineNum">     491 </span>            :   //  AliTrackPointArray* array = new AliTrackPointArray;
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :   AliTrackPointArray* array = 0;</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :   fPointsTree = (TTree*) fPointsFile-&gt;Get(&quot;spTree&quot;);</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :   if (!fPointsTree) {</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     AliWarning(&quot;No pointsTree found!&quot;);</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     497 </span>            :   }
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :   fPointsTree-&gt;SetBranchAddress(&quot;SP&quot;, &amp;array);</span>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :   Int_t nArrays = (Int_t)fPointsTree-&gt;GetEntries();</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :   for (Int_t iArray = 0; iArray &lt; nArrays; iArray++)</span>
<span class="lineNum">     502 </span>            :     {
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :       fPointsTree-&gt;GetEvent(iArray);</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :       if (!array) continue;</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :       for (Int_t ipoint = 0; ipoint &lt; array-&gt;GetNPoints(); ipoint++) {</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :         UShort_t volId = array-&gt;GetVolumeID()[ipoint];</span>
<span class="lineNum">     507 </span>            :         // check if the volId is valid
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :         if (!AliGeomManager::SymName(volId)) {</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :           AliError(Form(&quot;The volume id %d has no default volume name !&quot;,</span>
<span class="lineNum">     510 </span>            :                         volId));
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     512 </span>            :         }
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :         Int_t modId;</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :         Int_t layerId = AliGeomManager::VolUIDToLayer(volId,modId)</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :                       - AliGeomManager::kFirstLayer;</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :         if (!fArrayIndex[layerId][modId]) {</span>
<span class="lineNum">     517 </span>            :           //first entry for this volume
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :           fArrayIndex[layerId][modId] = new TArrayI(1000);</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     520 </span>            :         else {
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :           Int_t size = fArrayIndex[layerId][modId]-&gt;GetSize();</span>
<span class="lineNum">     522 </span>            :           // If needed allocate new size
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :           if (fLastIndex[layerId][modId] &gt;= size)</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :             fArrayIndex[layerId][modId]-&gt;Set(size + 1000);</span>
<span class="lineNum">     525 </span>            :         }
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span>            :         // Check if the index is already filled
<span class="lineNum">     528 </span>            :         Bool_t fillIndex = kTRUE;
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :         if (fLastIndex[layerId][modId] != 0) {</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :           if ((*fArrayIndex[layerId][modId])[fLastIndex[layerId][modId]-1] == iArray)</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :             fillIndex = kFALSE;</span>
<span class="lineNum">     532 </span>            :         }
<span class="lineNum">     533 </span>            :         // Fill the index array and store last filled index
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :         if (fillIndex) {</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :           (*fArrayIndex[layerId][modId])[fLastIndex[layerId][modId]] = iArray;</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :           fLastIndex[layerId][modId]++;</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span><span class="lineNoCov">          0 : }</span>
<a name="542"><span class="lineNum">     542 </span>            : </a>
<span class="lineNum">     543 </span>            : //______________________________________________________________________________
<span class="lineNum">     544 </span>            : void AliAlignmentTracks::InitIndex()
<span class="lineNum">     545 </span>            : {
<span class="lineNum">     546 </span>            :   // Initialize the index arrays
<span class="lineNum">     547 </span>            :   Int_t nLayers = AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer;
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :   fLastIndex = new Int_t*[nLayers];</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :   fArrayIndex = new TArrayI**[nLayers];</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = 0; iLayer &lt; (AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer); iLayer++) {</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :     fLastIndex[iLayer] = new Int_t[AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer)];</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     fArrayIndex[iLayer] = new TArrayI*[AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer)];</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :     for (Int_t iModule = 0; iModule &lt; AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer); iModule++) {</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :       fLastIndex[iLayer][iModule] = 0;</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :       fArrayIndex[iLayer][iModule] = 0;</span>
<span class="lineNum">     556 </span>            :     }
<span class="lineNum">     557 </span>            :   }
<span class="lineNum">     558 </span><span class="lineNoCov">          0 : }</span>
<a name="559"><span class="lineNum">     559 </span>            : </a>
<span class="lineNum">     560 </span>            : //______________________________________________________________________________
<span class="lineNum">     561 </span>            : void AliAlignmentTracks::ResetIndex()
<span class="lineNum">     562 </span>            : {
<span class="lineNum">     563 </span>            :   // Reset the value of the last filled index
<span class="lineNum">     564 </span>            :   // Do not realocate memory
<span class="lineNum">     565 </span>            : 
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :   fIsIndexBuilt = kFALSE;</span>
<span class="lineNum">     567 </span>            :   
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = 0; iLayer &lt; AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer; iLayer++) {</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :     for (Int_t iModule = 0; iModule &lt; AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer); iModule++) {</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :       fLastIndex[iLayer][iModule] = 0;</span>
<span class="lineNum">     571 </span>            :     }
<span class="lineNum">     572 </span>            :   }
<span class="lineNum">     573 </span><span class="lineNoCov">          0 : }</span>
<a name="574"><span class="lineNum">     574 </span>            : </a>
<span class="lineNum">     575 </span>            : //______________________________________________________________________________
<span class="lineNum">     576 </span>            : void AliAlignmentTracks::DeleteIndex()
<span class="lineNum">     577 </span>            : {
<span class="lineNum">     578 </span>            :   // Delete the index arrays
<span class="lineNum">     579 </span>            :   // Called by the destructor
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = 0; iLayer &lt; (AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer); iLayer++) {</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :     for (Int_t iModule = 0; iModule &lt; AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer); iModule++) {</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :       if (fArrayIndex[iLayer][iModule]) {</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :         delete fArrayIndex[iLayer][iModule];</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :         fArrayIndex[iLayer][iModule] = 0;</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     586 </span>            :     }
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :     delete [] fLastIndex[iLayer];</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :     delete [] fArrayIndex[iLayer];</span>
<span class="lineNum">     589 </span>            :   }
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :   delete [] fLastIndex;</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :   delete [] fArrayIndex;</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 : }</span>
<a name="593"><span class="lineNum">     593 </span>            : </a>
<span class="lineNum">     594 </span>            : //______________________________________________________________________________
<span class="lineNum">     595 </span>            : Bool_t AliAlignmentTracks::ReadAlignObjs(const char *alignObjFileName, const char* arrayName)
<span class="lineNum">     596 </span>            : {
<span class="lineNum">     597 </span>            :   // Read alignment object from a file: update the alignobj already present with the one in the file
<span class="lineNum">     598 </span>            :   // To be replaced by a call to CDB
<span class="lineNum">     599 </span>            :   
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :   if(gSystem-&gt;AccessPathName(alignObjFileName,kFileExists)){</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :     printf(&quot;Wrong AlignObjs File Name \n&quot;);</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     603 </span>            :   } 
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :   TFile *fRealign=TFile::Open(alignObjFileName);</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :   if (!fRealign || !fRealign-&gt;IsOpen()) {</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Could not open Align Obj File file %s !&quot;,alignObjFileName));</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     609 </span>            :   }  
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :   printf(&quot;Getting TClonesArray \n&quot;);</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :   TClonesArray *clnarray=(TClonesArray*)fRealign-&gt;Get(arrayName);</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :   Int_t size=clnarray-&gt;GetSize();</span>
<span class="lineNum">     613 </span>            :   UShort_t volid;
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :   for(Int_t ivol=0;ivol&lt;size;ivol++){</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :     AliAlignObjParams *a=(AliAlignObjParams*)clnarray-&gt;At(ivol);</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :     volid=a-&gt;GetVolUID();</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     Int_t iModule;</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     AliGeomManager::ELayerID iLayer = AliGeomManager::VolUIDToLayer(volid,iModule);</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :     if(iLayer&lt;AliGeomManager::kFirstLayer||iLayer&gt;AliGeomManager::kSSD2)continue;</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :     printf(&quot;Updating volume: %d ,layer: %d module: %d \n&quot;,volid,iLayer,iModule);</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :     *fAlignObjs[iLayer-AliGeomManager::kFirstLayer][iModule] *= *a;</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     624 </span>            :  
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :   delete clnarray;</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :   fRealign-&gt;Close();</span>
<span class="lineNum">     627 </span>            :   return kTRUE;
<span class="lineNum">     628 </span><span class="lineNoCov">          0 : }</span>
<a name="629"><span class="lineNum">     629 </span>            : </a>
<span class="lineNum">     630 </span>            : //______________________________________________________________________________
<span class="lineNum">     631 </span>            : void AliAlignmentTracks::InitAlignObjs()
<span class="lineNum">     632 </span>            : {
<span class="lineNum">     633 </span>            :   // Initialize the alignment objects array
<span class="lineNum">     634 </span>            :   Int_t nLayers = AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer;
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :   fAlignObjs = new AliAlignObj**[nLayers];</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = 0; iLayer &lt; (AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer); iLayer++) {</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :     fAlignObjs[iLayer] = new AliAlignObj*[AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer)];</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :     for (Int_t iModule = 0; iModule &lt; AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer); iModule++) {</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :       UShort_t volid = AliGeomManager::LayerToVolUID(iLayer+ AliGeomManager::kFirstLayer,iModule);</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :       fAlignObjs[iLayer][iModule] = new AliAlignObjParams(AliGeomManager::SymName(volid),volid,0,0,0,0,0,0,kTRUE);</span>
<span class="lineNum">     641 </span>            :     }
<span class="lineNum">     642 </span>            :   }
<span class="lineNum">     643 </span><span class="lineNoCov">          0 : }</span>
<a name="644"><span class="lineNum">     644 </span>            : </a>
<span class="lineNum">     645 </span>            : //______________________________________________________________________________
<span class="lineNum">     646 </span>            : void AliAlignmentTracks::ResetAlignObjs()
<span class="lineNum">     647 </span>            : {
<span class="lineNum">     648 </span>            :   // Reset the alignment objects array
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = 0; iLayer &lt; (AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer); iLayer++) {</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :     for (Int_t iModule = 0; iModule &lt; AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer); iModule++)</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :       fAlignObjs[iLayer][iModule]-&gt;SetPars(0,0,0,0,0,0);</span>
<span class="lineNum">     652 </span>            :   }
<span class="lineNum">     653 </span><span class="lineNoCov">          0 : }</span>
<a name="654"><span class="lineNum">     654 </span>            : </a>
<span class="lineNum">     655 </span>            : //______________________________________________________________________________
<span class="lineNum">     656 </span>            : void AliAlignmentTracks::DeleteAlignObjs()
<span class="lineNum">     657 </span>            : {
<span class="lineNum">     658 </span>            :   // Delete the alignment objects array
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = 0; iLayer &lt; (AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer); iLayer++) {</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :     for (Int_t iModule = 0; iModule &lt; AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer); iModule++)</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :       if (fAlignObjs[iLayer][iModule])</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :         delete fAlignObjs[iLayer][iModule];</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :     delete [] fAlignObjs[iLayer];</span>
<span class="lineNum">     664 </span>            :   }
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :   delete [] fAlignObjs;</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :   fAlignObjs = 0;</span>
<a name="667"><span class="lineNum">     667 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span>            : Bool_t AliAlignmentTracks::AlignDetector(AliGeomManager::ELayerID firstLayer,
<span class="lineNum">     670 </span>            :                                          AliGeomManager::ELayerID lastLayer,
<span class="lineNum">     671 </span>            :                                          AliGeomManager::ELayerID layerRangeMin,
<span class="lineNum">     672 </span>            :                                          AliGeomManager::ELayerID layerRangeMax,
<span class="lineNum">     673 </span>            :                                          Int_t iterations)
<span class="lineNum">     674 </span>            : {
<span class="lineNum">     675 </span>            :   // Align detector volumes within
<span class="lineNum">     676 </span>            :   // a given layer range
<span class="lineNum">     677 </span>            :   // (could be whole detector).
<span class="lineNum">     678 </span>            :   // Tracks are fitted only within
<span class="lineNum">     679 </span>            :   // the range defined by the user.
<span class="lineNum">     680 </span>            :   Int_t nModules = 0;
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = firstLayer; iLayer &lt;= lastLayer; iLayer++)</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :     nModules += AliGeomManager::LayerSize(iLayer);</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :   TArrayI volIds(nModules);</span>
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span>            :   Int_t modnum = 0;
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = firstLayer; iLayer &lt;= lastLayer; iLayer++) {</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :     for (Int_t iModule = 0; iModule &lt; AliGeomManager::LayerSize(iLayer); iModule++) {</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :       UShort_t volId = AliGeomManager::LayerToVolUID(iLayer,iModule);</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :       volIds.AddAt(volId,modnum);</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :       modnum++;</span>
<span class="lineNum">     691 </span>            :     }
<span class="lineNum">     692 </span>            :   }
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span>            :   Bool_t result = kFALSE;
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :   while (iterations &gt; 0) {</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :     if (!(result = AlignVolumes(&amp;volIds,0x0,layerRangeMin,layerRangeMax))) break;</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :     iterations--;</span>
<span class="lineNum">     698 </span>            :   }
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 : }</span>
<a name="701"><span class="lineNum">     701 </span>            : </a>
<span class="lineNum">     702 </span>            : //______________________________________________________________________________
<span class="lineNum">     703 </span>            : Bool_t AliAlignmentTracks::AlignLayer(AliGeomManager::ELayerID layer,
<span class="lineNum">     704 </span>            :                                       AliGeomManager::ELayerID layerRangeMin,
<span class="lineNum">     705 </span>            :                                       AliGeomManager::ELayerID layerRangeMax,
<span class="lineNum">     706 </span>            :                                       Int_t iterations)
<span class="lineNum">     707 </span>            : {
<span class="lineNum">     708 </span>            :   // Align detector volumes within
<span class="lineNum">     709 </span>            :   // a given layer.
<span class="lineNum">     710 </span>            :   // Tracks are fitted only within
<span class="lineNum">     711 </span>            :   // the range defined by the user.
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :   Int_t nModules = AliGeomManager::LayerSize(layer);</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :   TArrayI volIds(nModules);</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :   for (Int_t iModule = 0; iModule &lt; nModules; iModule++) {</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :     UShort_t volId = AliGeomManager::LayerToVolUID(layer,iModule);</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :     volIds.AddAt(volId,iModule);</span>
<span class="lineNum">     717 </span>            :   }
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span>            :   Bool_t result = kFALSE;
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :   while (iterations &gt; 0) {</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :     if (!(result = AlignVolumes(&amp;volIds,0x0,layerRangeMin,layerRangeMax))) break;</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :     iterations--;</span>
<span class="lineNum">     723 </span>            :   }
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 : }</span>
<a name="726"><span class="lineNum">     726 </span>            : </a>
<span class="lineNum">     727 </span>            : //______________________________________________________________________________
<span class="lineNum">     728 </span>            : Bool_t AliAlignmentTracks::AlignVolume(UShort_t volId, UShort_t volIdFit,
<span class="lineNum">     729 </span>            :                                      Int_t iterations)
<span class="lineNum">     730 </span>            : {
<span class="lineNum">     731 </span>            :   // Align single detector volume to
<span class="lineNum">     732 </span>            :   // another volume.
<span class="lineNum">     733 </span>            :   // Tracks are fitted only within
<span class="lineNum">     734 </span>            :   // the second volume.
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :   TArrayI volIds(1);</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :   volIds.AddAt(volId,0);</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :   TArrayI volIdsFit(1);</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :   volIdsFit.AddAt(volIdFit,0);</span>
<span class="lineNum">     739 </span>            : 
<span class="lineNum">     740 </span>            :   Bool_t result = kFALSE;
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :   while (iterations &gt; 0) {</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :     if (!(result = AlignVolumes(&amp;volIds,&amp;volIdsFit))) break;</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :     iterations--;</span>
<span class="lineNum">     744 </span>            :   }
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 : }</span>
<a name="747"><span class="lineNum">     747 </span>            : </a>
<span class="lineNum">     748 </span>            : //______________________________________________________________________________
<span class="lineNum">     749 </span>            : Bool_t AliAlignmentTracks::AlignVolumes(const TArrayI *volids, const TArrayI *volidsfit,
<span class="lineNum">     750 </span>            :                                      AliGeomManager::ELayerID layerRangeMin,
<span class="lineNum">     751 </span>            :                                      AliGeomManager::ELayerID layerRangeMax,
<span class="lineNum">     752 </span>            :                                      Int_t iterations)
<span class="lineNum">     753 </span>            : {
<span class="lineNum">     754 </span>            :   // Align a set of detector volumes.
<span class="lineNum">     755 </span>            :   // Tracks are fitted only within
<span class="lineNum">     756 </span>            :   // the range defined by the user
<span class="lineNum">     757 </span>            :   // (by layerRangeMin and layerRangeMax)
<span class="lineNum">     758 </span>            :   // or within the set of volidsfit
<span class="lineNum">     759 </span>            :   // Repeat the procedure 'iterations' times
<span class="lineNum">     760 </span>            : 
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :   Int_t nVolIds = volids-&gt;GetSize();</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :   if (nVolIds == 0) {</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :     AliError(&quot;Volume IDs array is empty!&quot;);</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     765 </span>            :   }
<span class="lineNum">     766 </span>            :  
<span class="lineNum">     767 </span>            :   // Load only the tracks with at least one
<span class="lineNum">     768 </span>            :   // space point in the set of volume (volids)
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :   BuildIndex();</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :   AliTrackPointArray **points;</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :   Int_t pointsdim;</span>
<span class="lineNum">     772 </span>            :   // Start the iterations
<span class="lineNum">     773 </span>            :   Bool_t result = kFALSE;
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :   while (iterations &gt; 0) {</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :     Int_t nArrays = LoadPoints(volids, points,pointsdim);</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :     if (nArrays == 0) {</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :       UnloadPoints(pointsdim, points);</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :       return kFALSE;</span>
<span class="lineNum">     779 </span>            :     }
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :     AliTrackResiduals *minimizer = CreateMinimizer();</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :     minimizer-&gt;SetNTracks(nArrays);</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :     minimizer-&gt;InitAlignObj();</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :     AliTrackFitter *fitter = CreateFitter();</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :     for (Int_t iArray = 0; iArray &lt; nArrays; iArray++) {</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :       if (!points[iArray]) continue;</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :       fitter-&gt;SetTrackPointArray(points[iArray], kFALSE);</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :       if (fitter-&gt;Fit(volids,volidsfit,layerRangeMin,layerRangeMax) == kFALSE) continue;</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :       AliTrackPointArray *pVolId,*pTrack;</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :       fitter-&gt;GetTrackResiduals(pVolId,pTrack);</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :       minimizer-&gt;AddTrackPointArrays(pVolId,pTrack);</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :     if (!(result = minimizer-&gt;Minimize())) {</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :       UnloadPoints(pointsdim, points);</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     796 </span>            :     }
<span class="lineNum">     797 </span>            : 
<span class="lineNum">     798 </span>            :     // Update the alignment object(s)
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :     if (fDoUpdate) for (Int_t iVolId = 0; iVolId &lt; nVolIds; iVolId++) {</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :       UShort_t volid = (*volids)[iVolId];</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :       Int_t iModule;</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :       AliGeomManager::ELayerID iLayer = AliGeomManager::VolUIDToLayer(volid,iModule);</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :       AliAlignObj *alignObj = fAlignObjs[iLayer-AliGeomManager::kFirstLayer][iModule];      </span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :       *alignObj *= *minimizer-&gt;GetAlignObj();</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :       if(iterations==1)alignObj-&gt;Print(&quot;&quot;);</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :     UnloadPoints(pointsdim, points);</span>
<span class="lineNum">     809 </span>            :     
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :     iterations--;</span>
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 : }</span>
<a name="814"><span class="lineNum">     814 </span>            :   </a>
<span class="lineNum">     815 </span>            : //______________________________________________________________________________
<span class="lineNum">     816 </span>            : Int_t AliAlignmentTracks::LoadPoints(const TArrayI *volids, AliTrackPointArray** &amp;points,Int_t &amp;pointsdim)
<span class="lineNum">     817 </span>            : {
<span class="lineNum">     818 </span>            :   // Load track point arrays with at least
<span class="lineNum">     819 </span>            :   // one space point in a given set of detector
<span class="lineNum">     820 </span>            :   // volumes (array volids).
<span class="lineNum">     821 </span>            :   // Use the already created tree index for
<span class="lineNum">     822 </span>            :   // fast access.
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :   if (!fPointsTree) {</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :     AliError(&quot;Tree with the space point arrays not initialized!&quot;);</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :     points = 0;</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     828 </span>            :   }
<span class="lineNum">     829 </span>            : 
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :   Int_t nVolIds = volids-&gt;GetSize();</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :   if (nVolIds == 0) {</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :     AliError(&quot;Volume IDs array is empty!&quot;);</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :     points = 0;</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     835 </span>            :   }
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span>            :   Int_t nArrays = 0;
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :   for (Int_t iVolId = 0; iVolId &lt; nVolIds; iVolId++) {</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :     UShort_t volid = (*volids)[iVolId];</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :     Int_t iModule;</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :     AliGeomManager::ELayerID iLayer = AliGeomManager::VolUIDToLayer(volid,iModule);</span>
<span class="lineNum">     842 </span>            : 
<span class="lineNum">     843 </span>            :     // In case of empty index
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :     if (fLastIndex[iLayer-AliGeomManager::kFirstLayer][iModule] == 0) {</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot;There are no space-points belonging to the volume which is to be aligned (Volume ID =%d)!&quot;,volid));</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     847 </span>            :     }
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :     nArrays += fLastIndex[iLayer-AliGeomManager::kFirstLayer][iModule];</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     850 </span>            : 
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :   if (nArrays == 0) {</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :     AliError(&quot;There are no space-points belonging to all of the volumes which are to be aligned!&quot;);</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :     points = 0x0;</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     855 </span>            :   }
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :   AliTrackPointArray* array = 0;</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :   fPointsTree-&gt;SetBranchAddress(&quot;SP&quot;, &amp;array);</span>
<span class="lineNum">     859 </span>            : 
<span class="lineNum">     860 </span>            :   // Allocate the pointer to the space-point arrays
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :   pointsdim=nArrays;</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :   points = new AliTrackPointArray*[nArrays];</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :   for (Int_t i = 0; i &lt; nArrays; i++) points[i] = 0x0;</span>
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span>            :   // Init the array used to flag already loaded tree entries
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :   Bool_t *indexUsed = new Bool_t[(UInt_t)fPointsTree-&gt;GetEntries()];</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :   for (Int_t i = 0; i &lt; fPointsTree-&gt;GetEntries(); i++)</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :     indexUsed[i] = kFALSE;</span>
<span class="lineNum">     869 </span>            : 
<span class="lineNum">     870 </span>            :   // Start the loop over the volume ids
<span class="lineNum">     871 </span>            :   Int_t iArray = 0;
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :   for (Int_t iVolId = 0; iVolId &lt; nVolIds; iVolId++) {</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :     UShort_t volid = (*volids)[iVolId];</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :     Int_t iModule;</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :     AliGeomManager::ELayerID iLayer = AliGeomManager::VolUIDToLayer(volid,iModule);</span>
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :     Int_t nArraysId = fLastIndex[iLayer-AliGeomManager::kFirstLayer][iModule];</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :     TArrayI *index = fArrayIndex[iLayer-AliGeomManager::kFirstLayer][iModule];</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :     AliTrackPoint p;</span>
<span class="lineNum">     880 </span>            : 
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :     for (Int_t iArrayId = 0; iArrayId &lt; nArraysId; iArrayId++) {</span>
<span class="lineNum">     882 </span>            : 
<span class="lineNum">     883 </span>            :       // Get tree entry
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :       Int_t entry = (*index)[iArrayId];</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :       if (indexUsed[entry] == kTRUE) {</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :         nArrays--;</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     888 </span>            :       }
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :       fPointsTree-&gt;GetEvent(entry);</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :       if (!array) {</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :         AliWarning(&quot;Wrong space point array index!&quot;);</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     893 </span>            :       }
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :       indexUsed[entry] = kTRUE;</span>
<span class="lineNum">     895 </span>            : 
<span class="lineNum">     896 </span>            :       // Get the space-point array
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :       Int_t nPoints = array-&gt;GetNPoints();</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :       points[iArray] = new AliTrackPointArray(nPoints);</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :       for (Int_t iPoint = 0; iPoint &lt; nPoints; iPoint++) {</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :         array-&gt;GetPoint(p,iPoint);</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :         Int_t modnum;</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :         AliGeomManager::ELayerID layer = AliGeomManager::VolUIDToLayer(p.GetVolumeID(),modnum);</span>
<span class="lineNum">     903 </span>            :         // check if the layer id is valid
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :         if ((layer &lt; AliGeomManager::kFirstLayer) ||</span>
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :             (layer &gt;= AliGeomManager::kLastLayer)) {</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :           AliError(Form(&quot;Layer index is invalid: %d (%d -&gt; %d) !&quot;,</span>
<span class="lineNum">     907 </span>            :                         layer,AliGeomManager::kFirstLayer,AliGeomManager::kLastLayer-1));
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     909 </span>            :         }
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :         if ((modnum &gt;= AliGeomManager::LayerSize(layer)) ||</span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :             (modnum &lt; 0)) {</span>
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :           AliError(Form(&quot;Module number inside layer %d is invalid: %d (0 -&gt; %d)&quot;,</span>
<span class="lineNum">     913 </span>            :                         layer,modnum,AliGeomManager::LayerSize(layer)));
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     915 </span>            :         }
<span class="lineNum">     916 </span>            : 
<span class="lineNum">     917 </span>            :         // Misalignment is introduced here
<span class="lineNum">     918 </span>            :         // Switch it off in case of real
<span class="lineNum">     919 </span>            :         // alignment job!
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :         if (fMisalignObjs) {</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :           AliAlignObj *misalignObj = fMisalignObjs[layer-AliGeomManager::kFirstLayer][modnum];</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :           if (misalignObj)</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :             misalignObj-&gt;Transform(p);</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     925 </span>            :         // End of misalignment
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span>            : 
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :         AliAlignObj *alignObj = fAlignObjs[layer-AliGeomManager::kFirstLayer][modnum];</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :         UShort_t volp=p.GetVolumeID();</span>
<span class="lineNum">     930 </span>            :         Bool_t found=kFALSE;
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :         if(fCovIsUsed){</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :           for (Int_t iVol = 0; iVol &lt; nVolIds; iVol++) {</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :             UShort_t vol = (*volids)[iVol];</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :             if(volp==vol){</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :               alignObj-&gt;Transform(p,kFALSE);</span>
<span class="lineNum">     936 </span>            :               found=kTRUE;
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :               break;</span>
<span class="lineNum">     938 </span>            :             }
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :         if(!found)alignObj-&gt;Transform(p,fCovIsUsed);</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :         points[iArray]-&gt;AddPoint(iPoint,&amp;p);</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :       iArray++;</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     947 </span>            : 
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :   delete [] indexUsed;</span>
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span>            :   return nArrays;
<span class="lineNum">     952 </span><span class="lineNoCov">          0 : }</span>
<a name="953"><span class="lineNum">     953 </span>            : </a>
<span class="lineNum">     954 </span>            : //______________________________________________________________________________
<span class="lineNum">     955 </span>            : void AliAlignmentTracks::UnloadPoints(Int_t n, AliTrackPointArray **points)
<span class="lineNum">     956 </span>            : {
<span class="lineNum">     957 </span>            :   // Unload track point arrays for a given
<span class="lineNum">     958 </span>            :   // detector volume
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :   for (Int_t iArray = 0; iArray &lt; n; iArray++)</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :     delete points[iArray];</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :   delete [] points;</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 : }</span>
<a name="963"><span class="lineNum">     963 </span>            : </a>
<span class="lineNum">     964 </span>            : //______________________________________________________________________________
<span class="lineNum">     965 </span>            : AliTrackFitter *AliAlignmentTracks::CreateFitter()
<span class="lineNum">     966 </span>            : {
<span class="lineNum">     967 </span>            :   // Check if the user has already supplied
<span class="lineNum">     968 </span>            :   // a track fitter object.
<span class="lineNum">     969 </span>            :   // If not, create a default one.
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :   if (!fTrackFitter)</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :     fTrackFitter = new AliTrackFitterRieman;</span>
<span class="lineNum">     972 </span>            : 
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :   return fTrackFitter;</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 : }</span>
<a name="975"><span class="lineNum">     975 </span>            : </a>
<span class="lineNum">     976 </span>            : //______________________________________________________________________________
<span class="lineNum">     977 </span>            : AliTrackResiduals *AliAlignmentTracks::CreateMinimizer()
<span class="lineNum">     978 </span>            : {
<span class="lineNum">     979 </span>            :   // Check if the user has already supplied
<span class="lineNum">     980 </span>            :   // a track residuals minimizer object.
<span class="lineNum">     981 </span>            :   // If not, create a default one.
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :   if (!fMinimizer)</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :     fMinimizer = new AliTrackResidualsChi2;</span>
<span class="lineNum">     984 </span>            : 
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :   return fMinimizer;</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 : }</span>
<a name="987"><span class="lineNum">     987 </span>            : </a>
<span class="lineNum">     988 </span>            : //______________________________________________________________________________
<span class="lineNum">     989 </span>            : Bool_t AliAlignmentTracks::Misalign(const char *misalignObjFileName, const char* arrayName)
<span class="lineNum">     990 </span>            : {
<span class="lineNum">     991 </span>            :   // The method reads from a file a set of AliAlignObj which are
<span class="lineNum">     992 </span>            :   // then used to apply misalignments directly on the track
<span class="lineNum">     993 </span>            :   // space-points. The method is supposed to be used only for
<span class="lineNum">     994 </span>            :   // fast development and debugging of the alignment algorithms.
<span class="lineNum">     995 </span>            :   // Be careful not to use it in the case of 'real' alignment
<span class="lineNum">     996 </span>            :   // scenario since it will bias the results.
<span class="lineNum">     997 </span>            : 
<span class="lineNum">     998 </span>            :   // Initialize the misalignment objects array
<span class="lineNum">     999 </span>            :   Int_t nLayers = AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer;
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :   fMisalignObjs = new AliAlignObj**[nLayers];</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = 0; iLayer &lt; (AliGeomManager::kLastLayer - AliGeomManager::kFirstLayer); iLayer++) {</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :     fMisalignObjs[iLayer] = new AliAlignObj*[AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer)];</span>
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :     for (Int_t iModule = 0; iModule &lt; AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer); iModule++)</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :       fMisalignObjs[iLayer][iModule] = 0x0;</span>
<span class="lineNum">    1005 </span>            :   }
<span class="lineNum">    1006 </span>            : 
<span class="lineNum">    1007 </span>            :   // Open the misliagnment file and load the array with
<span class="lineNum">    1008 </span>            :   // misalignment objects
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :   TFile* inFile = TFile::Open(misalignObjFileName,&quot;READ&quot;);</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :   if (!inFile || !inFile-&gt;IsOpen()) {</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Could not open misalignment file %s !&quot;,misalignObjFileName));</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">    1013 </span>            :   }
<span class="lineNum">    1014 </span>            : 
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :   TClonesArray* array = ((TClonesArray*) inFile-&gt;Get(arrayName));</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :   if (!array) {</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :     AliError(Form(&quot;Could not find misalignment array %s in the file %s !&quot;,arrayName,misalignObjFileName));</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :     inFile-&gt;Close();</span>
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">    1020 </span>            :   }
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :   inFile-&gt;Close();</span>
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span>            :   // Store the misalignment objects for further usage  
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :   Int_t nObjs = array-&gt;GetEntriesFast();</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :   AliGeomManager::ELayerID layerId; // volume layer</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :   Int_t modId; // volume ID inside the layer</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :   for(Int_t i=0; i&lt;nObjs; i++)</span>
<span class="lineNum">    1028 </span>            :     {
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :       AliAlignObj* alObj = (AliAlignObj*)array-&gt;UncheckedAt(i);</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :       alObj-&gt;GetVolUID(layerId,modId);</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :       if(layerId&lt;AliGeomManager::kFirstLayer) {</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :         AliWarning(Form(&quot;Alignment object is ignored: %s&quot;,alObj-&gt;GetSymName()));</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    1034 </span>            :       }
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :       fMisalignObjs[layerId-AliGeomManager::kFirstLayer][modId] = alObj;</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1037 </span>            :   return kTRUE;
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1039 </span>            : 
<a name="1040"><span class="lineNum">    1040 </span>            : </a>
<span class="lineNum">    1041 </span>            : //________________________________________________
<span class="lineNum">    1042 </span>            : void AliAlignmentTracks::WriteRealignObjArray(TString outfilename,AliGeomManager::ELayerID layerRangeMin,AliGeomManager::ELayerID layerRangeMax){
<span class="lineNum">    1043 </span>            :   
<span class="lineNum">    1044 </span>            :   Int_t last=0;
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :   TClonesArray *clonesArray=new TClonesArray(&quot;AliAlignObjParams&quot;,2200);</span>
<span class="lineNum">    1046 </span>            :   TClonesArray &amp;alo=*clonesArray;
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :   for (Int_t iLayer = layerRangeMin-AliGeomManager::kFirstLayer; iLayer &lt;= (layerRangeMax - AliGeomManager::kFirstLayer);iLayer++) {</span>
<span class="lineNum">    1048 </span>            :   
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :     for (Int_t iModule = 0; iModule &lt; AliGeomManager::LayerSize(iLayer + AliGeomManager::kFirstLayer); iModule++) {</span>
<span class="lineNum">    1050 </span>            :      
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :       AliAlignObj *alignObj = fAlignObjs[iLayer][iModule]; </span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :       new(alo[last])AliAlignObjParams(*alignObj);</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :       last++;</span>
<span class="lineNum">    1054 </span>            :     }
<span class="lineNum">    1055 </span>            :   }
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :   TFile *file=new TFile(outfilename.Data(),&quot;RECREATE&quot;);</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :   file-&gt;cd();</span>
<span class="lineNum">    1058 </span>            :  
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :   alo.Write(&quot;ITSAlignObjs&quot;,TObject::kSingleKey);</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :   file-&gt;Close();    </span>
<span class="lineNum">    1061 </span>            :  
<span class="lineNum">    1062 </span>            :      
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :   delete clonesArray;</span>
<span class="lineNum">    1064 </span>            :   return;
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
