<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - TPC/TPCcalib/AliTPCcalibCosmic.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">TPC/TPCcalib</a> - AliTPCcalibCosmic.cxx<span style="font-size: 80%;"> (source / <a href="AliTPCcalibCosmic.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">904</td>
            <td class="headerCovTableEntryLo">0.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">28</td>
            <td class="headerCovTableEntryLo">3.6 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : </a>
<span class="lineNum">       2 </span>            : 
<span class="lineNum">       3 </span>            : /**************************************************************************
<span class="lineNum">       4 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       5 </span>            :  *                                                                        *
<span class="lineNum">       6 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       7 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       8 </span>            :  *                                                                        *
<span class="lineNum">       9 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">      10 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">      11 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      12 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      13 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      14 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      15 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      16 </span>            :  **************************************************************************/
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : /*
<span class="lineNum">      19 </span>            :     Comments to be written here: 
<span class="lineNum">      20 </span>            :     1. What do we calibrate.
<span class="lineNum">      21 </span>            :     2. How to interpret results
<span class="lineNum">      22 </span>            :     3. Simple example
<span class="lineNum">      23 </span>            :     4. Analysis using debug streamers.
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            :     3.Simple example
<span class="lineNum">      28 </span>            :     // To make cosmic scan the user interaction neccessary
<span class="lineNum">      29 </span>            :     //
<span class="lineNum">      30 </span>            :      
<span class="lineNum">      31 </span>            :   */
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : #include &quot;Riostream.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;TChain.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;TTree.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;TH1F.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;TH2F.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;TList.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;TMath.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;TCanvas.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;TFile.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;TF1.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;THnSparse.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;TDatabasePDG.h&quot;
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span>            : #include &quot;AliTPCclusterMI.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;AliTPCseed.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;AliESDVertex.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;AliESDEvent.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;AliESDfriend.h&quot;
<span class="lineNum">      53 </span>            : #include &quot;AliESDInputHandler.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;AliAnalysisManager.h&quot;
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            : #include &quot;AliTracker.h&quot;
<span class="lineNum">      57 </span>            : #include &quot;AliMagF.h&quot;
<span class="lineNum">      58 </span>            : #include &quot;AliTPCCalROC.h&quot;
<span class="lineNum">      59 </span>            : #include &quot;AliTPCParam.h&quot;
<span class="lineNum">      60 </span>            : #include &quot;AliLog.h&quot;
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            : #include &quot;AliTPCcalibCosmic.h&quot;
<span class="lineNum">      63 </span>            : #include &quot;TTreeStream.h&quot;
<span class="lineNum">      64 </span>            : #include &quot;AliTPCTracklet.h&quot;
<span class="lineNum">      65 </span>            : //#include &quot;AliESDcosmic.h&quot;
<span class="lineNum">      66 </span>            : #include &quot;AliRecoParam.h&quot;
<span class="lineNum">      67 </span>            : #include &quot;AliMultiplicity.h&quot;
<span class="lineNum">      68 </span>            : #include &quot;AliTPCTransform.h&quot;
<span class="lineNum">      69 </span>            : #include &quot;AliTPCcalibDB.h&quot;
<span class="lineNum">      70 </span>            : #include &quot;AliTPCseed.h&quot;
<span class="lineNum">      71 </span>            : #include &quot;AliGRPObject.h&quot;
<a name="72"><span class="lineNum">      72 </span>            : #include &quot;AliTPCCorrection.h&quot;</a>
<span class="lineNum">      73 </span>            : #include &quot;AliTPCreco.h&quot;
<span class="lineNum">      74 </span><span class="lineCov">          6 : ClassImp(AliTPCcalibCosmic)</span>
<a name="75"><span class="lineNum">      75 </span>            : </a>
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : AliTPCcalibCosmic::AliTPCcalibCosmic() 
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :   :AliTPCcalibBase(),</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :    fHistNTracks(0),</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :    fClusters(0),</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :    fModules(0),</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :    fHistPt(0),</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :    fDeDx(0),</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :    fDeDxMIP(0),</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :    fMIPvalue(1), </span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :    fCutMaxD(5),        // maximal distance in rfi ditection</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :    fCutMaxDz(40),      // maximal distance in z ditection</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :    fCutTheta(0.03),    // maximal distan theta</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :    fCutMinDir(-0.99),   // direction vector products</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :    fCosmicTree(0)      // tree with cosmic data</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 : {  </span>
<span class="lineNum">      92 </span>            :   //
<span class="lineNum">      93 </span>            :   // CONSTRUCTOR - SEE COMMENTS ABOVE
<span class="lineNum">      94 </span>            :   //
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :   AliInfo(&quot;Default Constructor&quot;);    </span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :   for (Int_t ihis=0; ihis&lt;6;ihis++){</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :     fHistoDelta[ihis]=0;</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :     fHistoPull[ihis]=0;</span>
<span class="lineNum">      99 </span>            :   }
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   for (Int_t ihis=0; ihis&lt;4;ihis++){</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     fHistodEdxMax[ihis]    =0;</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :     fHistodEdxTot[ihis]    =0;</span>
<span class="lineNum">     103 </span>            :   }
<span class="lineNum">     104 </span><span class="lineNoCov">          0 : }</span>
<a name="105"><span class="lineNum">     105 </span>            : </a>
<span class="lineNum">     106 </span>            : 
<span class="lineNum">     107 </span>            : AliTPCcalibCosmic::AliTPCcalibCosmic(const Text_t *name, const Text_t *title) 
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   :AliTPCcalibBase(),</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :    fHistNTracks(0),</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :    fClusters(0),</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :    fModules(0),</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :    fHistPt(0),</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :    fDeDx(0),</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :    fDeDxMIP(0),</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :    fMIPvalue(1),</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :    fCutMaxD(5),        // maximal distance in rfi ditection </span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :    fCutMaxDz(40),      // maximal distance in z ditection</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :    fCutTheta(0.03),    // maximal distan theta</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :    fCutMinDir(-0.99),  // direction vector products</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :    fCosmicTree(0)      // tree with cosmic data</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 : {  </span>
<span class="lineNum">     122 </span>            :   //
<span class="lineNum">     123 </span>            :   // cONSTRUCTOR - SEE COMENTS ABOVE
<span class="lineNum">     124 </span>            :   //
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :   SetName(name);</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :   SetTitle(title);</span>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :   fHistNTracks = new TH1F(&quot;ntracks&quot;,&quot;Number of Tracks per Event; number of tracks per event; number of tracks&quot;,501,-0.5,500.5);</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :   fClusters = new TH1F(&quot;signal&quot;,&quot;Number of Clusters per track; number of clusters per track n_{cl}; counts&quot;,160,0,160);</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :   fModules = new TH2F(&quot;sector&quot;,&quot;Acorde hits; z (cm); x(cm)&quot;,1200,-650,650,600,-700,700);</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   fHistPt = new TH1F(&quot;Pt&quot;,&quot;Pt distribution; p_{T} (GeV); counts&quot;,2000,0,50);</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :   fDeDx = new TH2F(&quot;DeDx&quot;,&quot;dEdx; momentum p (GeV); TPC signal (a.u.)&quot;,500,0.01,100.,500,2.,1000);</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :   BinLogX(fDeDx);</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :   fDeDxMIP =  new TH1F(&quot;DeDxMIP&quot;,&quot;MIP region; TPC signal (a.u.);counts &quot;,500,2.,1000);</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :   Init();</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :   AliInfo(&quot;Non Default Constructor&quot;);  </span>
<span class="lineNum">     137 </span>            :   //
<a name="138"><span class="lineNum">     138 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span><span class="lineNoCov">          0 : AliTPCcalibCosmic::~AliTPCcalibCosmic(){</span>
<span class="lineNum">     141 </span>            :   //
<span class="lineNum">     142 </span>            :   // destructor
<span class="lineNum">     143 </span>            :   //
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :   for (Int_t ihis=0; ihis&lt;6;ihis++){</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :     delete fHistoDelta[ihis];</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :     delete fHistoPull[ihis];</span>
<span class="lineNum">     147 </span>            :   }
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :   for (Int_t ihis=0; ihis&lt;4;ihis++){</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     delete fHistodEdxTot[ihis];</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :     delete fHistodEdxMax[ihis];</span>
<span class="lineNum">     151 </span>            :   }
<span class="lineNum">     152 </span>            : 
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :   delete fHistNTracks;            //  histogram showing number of ESD tracks per event</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :   delete fClusters;               //  histogram showing the number of clusters per track</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   delete fModules;                //  2d histogram of tracks which are propagated to the ACORDE scintillator array</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   delete fHistPt;                 //  Pt histogram of reconstructed tracks</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   delete fDeDx;                   //  dEdx spectrum showing the different particle types</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   delete fDeDxMIP;                //  TPC signal close to the MIP region of muons 0.4 &lt; p &lt; 0.45 GeV</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 : }</span>
<a name="160"><span class="lineNum">     160 </span>            : </a>
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span>            : void AliTPCcalibCosmic::Init(){
<span class="lineNum">     163 </span>            :   //
<span class="lineNum">     164 </span>            :   // init component
<span class="lineNum">     165 </span>            :   // Make performance histograms
<span class="lineNum">     166 </span>            :   //
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span>            :   // tracking performance bins
<span class="lineNum">     169 </span>            :   // 0 - delta of interest
<span class="lineNum">     170 </span>            :   // 1 - min (track0, track1) number of clusters
<span class="lineNum">     171 </span>            :   // 2 - R  - vertex radius
<span class="lineNum">     172 </span>            :   // 3 - P1 - mean z
<span class="lineNum">     173 </span>            :   // 4 - P2 - snp(phi)    at inner wall of TPC
<span class="lineNum">     174 </span>            :   // 5 - P3 - tan(theta)  at inner wall of TPC
<span class="lineNum">     175 </span>            :   // 6 - P4 - 1/pt mean
<span class="lineNum">     176 </span>            :   // 7 - pt - pt mean
<span class="lineNum">     177 </span>            :   // 8 - alpha
<span class="lineNum">     178 </span>            :   // 9 - is corss indicator
<span class="lineNum">     179 </span>            :   Int_t ndim=10;
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   Double_t xminTrack[10], xmaxTrack[10];</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :   Int_t binsTrack[10];</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   TString axisName[10];</span>
<span class="lineNum">     183 </span>            :   //
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   binsTrack[0] =100;</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   axisName[0]  =&quot;#Delta&quot;;</span>
<span class="lineNum">     186 </span>            :   //
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   binsTrack[1] =8;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   xminTrack[1] =80; xmaxTrack[1]=160;</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :   axisName[1]  =&quot;N_{cl}&quot;;</span>
<span class="lineNum">     190 </span>            :   //
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :   binsTrack[2] =10;</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :   xminTrack[2] =0; xmaxTrack[2]=90;  // </span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :   axisName[2]  =&quot;dca_{r} (cm)&quot;;</span>
<span class="lineNum">     194 </span>            :   //
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :   binsTrack[3] =25;</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   xminTrack[3] =-250; xmaxTrack[3]=250;  // </span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   axisName[3]  =&quot;z (cm)&quot;;</span>
<span class="lineNum">     198 </span>            :   //
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :   binsTrack[4] =10;</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :   xminTrack[4] =-0.8; xmaxTrack[4]=0.8;  // </span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :   axisName[4]  =&quot;sin(#phi)&quot;;</span>
<span class="lineNum">     202 </span>            :   //
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :   binsTrack[5] =10;</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :   xminTrack[5] =-1; xmaxTrack[5]=1;  // </span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :   axisName[5]  =&quot;tan(#theta)&quot;;</span>
<span class="lineNum">     206 </span>            :   //
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :   binsTrack[6] =40;</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :   xminTrack[6] =-2; xmaxTrack[6]=2;  // </span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :   axisName[6]  =&quot;1/pt (1/GeV)&quot;;</span>
<span class="lineNum">     210 </span>            :   //
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :   binsTrack[7] =50;</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :   xminTrack[7] =1; xmaxTrack[7]=1000;  // </span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :   axisName[7]  =&quot;pt (GeV)&quot;;</span>
<span class="lineNum">     214 </span>            :   //
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :   binsTrack[8] =18;</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :   xminTrack[8] =0; xmaxTrack[8]=TMath::Pi();  // </span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :   axisName[8]  =&quot;alpha&quot;;</span>
<span class="lineNum">     218 </span>            :   //
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   binsTrack[9] =3;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   xminTrack[9] =-0.1; xmaxTrack[9]=2.1;  // </span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :   axisName[9]  =&quot;cross&quot;;</span>
<span class="lineNum">     222 </span>            :   //
<span class="lineNum">     223 </span>            :   // delta y
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :   xminTrack[0] =-1; xmaxTrack[0]=1;  // </span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :   fHistoDelta[0] = new THnSparseS(&quot;#Delta_{Y} (cm)&quot;,&quot;#Delta_{Y} (cm)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   xminTrack[0] =-5; xmaxTrack[0]=5;  // </span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :   fHistoPull[0] = new THnSparseS(&quot;#Delta_{Y} (unit)&quot;,&quot;#Delta_{Y} (unit)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     228 </span>            :   //
<span class="lineNum">     229 </span>            :   // delta z
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :   xminTrack[0] =-1; xmaxTrack[0]=1;  // </span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :   fHistoDelta[1] = new THnSparseS(&quot;#Delta_{Z} (cm)&quot;,&quot;#Delta_{Z} (cm)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :   xminTrack[0] =-5; xmaxTrack[0]=5;  // </span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :   fHistoPull[1] = new THnSparseS(&quot;#Delta_{Z} (unit)&quot;,&quot;#Delta_{Z} (unit)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     234 </span>            :   //
<span class="lineNum">     235 </span>            :   // delta P2
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :   xminTrack[0] =-10; xmaxTrack[0]=10;  // </span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :   fHistoDelta[2] = new THnSparseS(&quot;#Delta_{#phi} (mrad)&quot;,&quot;#Delta_{#phi} (mrad)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :   xminTrack[0] =-5; xmaxTrack[0]=5;  // </span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :   fHistoPull[2] = new THnSparseS(&quot;#Delta_{#phi} (unit)&quot;,&quot;#Delta_{#phi} (unit)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     240 </span>            :   //
<span class="lineNum">     241 </span>            :   // delta P3
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :   xminTrack[0] =-10; xmaxTrack[0]=10;  // </span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :   fHistoDelta[3] = new THnSparseS(&quot;#Delta_{#theta} (mrad)&quot;,&quot;#Delta_{#theta} (mrad)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :   xminTrack[0] =-5; xmaxTrack[0]=5;  // </span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :   fHistoPull[3] = new THnSparseS(&quot;#Delta_{#theta} (unit)&quot;,&quot;#Delta_{#theta} (unit)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     246 </span>            :   //
<span class="lineNum">     247 </span>            :   // delta P4
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :   xminTrack[0] =-0.2; xmaxTrack[0]=0.2;  // </span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :   fHistoDelta[4] = new THnSparseS(&quot;#Delta_{1/pt} (1/GeV)&quot;,&quot;#Delta_{1/pt} (1/GeV)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :   xminTrack[0] =-5; xmaxTrack[0]=5;  // </span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :   fHistoPull[4] = new THnSparseS(&quot;#Delta_{1/pt} (unit)&quot;,&quot;#Delta_{1/pt} (unit)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     252 </span>            :   
<span class="lineNum">     253 </span>            :   //
<span class="lineNum">     254 </span>            :   // delta Pt
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :   xminTrack[0] =-0.5; xmaxTrack[0]=0.5;  // </span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :   fHistoDelta[5] = new THnSparseS(&quot;#Delta_{pt}/p_{t}&quot;,&quot;#Delta_{pt}/p_{t}&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :   xminTrack[0] =-5; xmaxTrack[0]=5;  // </span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :   fHistoPull[5] = new THnSparseS(&quot;#Delta_{pt}/p_{t} (unit)&quot;,&quot;#Delta_{pt}/p_{t} (unit)&quot;, ndim, binsTrack,xminTrack, xmaxTrack);</span>
<span class="lineNum">     259 </span>            :   //
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :   for (Int_t idedx=0;idedx&lt;4;idedx++){</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :     xminTrack[0] =0.5; xmaxTrack[0]=1.5;  // </span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :     binsTrack[1] =40;</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     xminTrack[1] =10; xmaxTrack[1]=160;</span>
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     fHistodEdxMax[idedx] = new THnSparseS(Form(&quot;dEdx_{MaxUp}/dEdx_{MaxDown}_Pad%d&quot;,idedx),</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :                                           Form(&quot;dEdx_{MaxUp}/dEdx_{MaxDown}_Pad%d&quot;,idedx), </span>
<span class="lineNum">     268 </span>            :                                           ndim, binsTrack,xminTrack, xmaxTrack);
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     fHistodEdxTot[idedx] = new THnSparseS(Form(&quot;dEdx_{TotUp}/dEdx_{TotDown}_Pad%d&quot;,idedx),</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :                                           Form(&quot;dEdx_{TotUp}/dEdx_{TotDown}_Pad%d&quot;,idedx), </span>
<span class="lineNum">     271 </span>            :                                           ndim, binsTrack,xminTrack, xmaxTrack);
<span class="lineNum">     272 </span>            :   }
<span class="lineNum">     273 </span>            :   
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   for (Int_t ivar=0;ivar&lt;6;ivar++){</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     for (Int_t ivar2=0;ivar2&lt;ndim;ivar2++){      </span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :       fHistoDelta[ivar]-&gt;GetAxis(ivar2)-&gt;SetName(axisName[ivar2].Data());</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :       fHistoDelta[ivar]-&gt;GetAxis(ivar2)-&gt;SetTitle(axisName[ivar2].Data());</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :       fHistoPull[ivar]-&gt;GetAxis(ivar2)-&gt;SetName(axisName[ivar2].Data());</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :       fHistoPull[ivar]-&gt;GetAxis(ivar2)-&gt;SetTitle(axisName[ivar2].Data());</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :       BinLogX(fHistoDelta[ivar],7);</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :       BinLogX(fHistoPull[ivar],7);</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :       if (ivar&lt;4){</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         fHistodEdxMax[ivar]-&gt;GetAxis(ivar2)-&gt;SetName(axisName[ivar2].Data());</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :         fHistodEdxMax[ivar]-&gt;GetAxis(ivar2)-&gt;SetTitle(axisName[ivar2].Data());</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         fHistodEdxTot[ivar]-&gt;GetAxis(ivar2)-&gt;SetName(axisName[ivar2].Data());</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :         fHistodEdxTot[ivar]-&gt;GetAxis(ivar2)-&gt;SetTitle(axisName[ivar2].Data());</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :         BinLogX(fHistodEdxMax[ivar],7);</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :         BinLogX(fHistodEdxTot[ivar],7);</span>
<span class="lineNum">     291 </span>            :       }
<span class="lineNum">     292 </span>            :     }
<span class="lineNum">     293 </span>            :   }
<span class="lineNum">     294 </span><span class="lineNoCov">          0 : }</span>
<a name="295"><span class="lineNum">     295 </span>            : </a>
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            : void AliTPCcalibCosmic::Add(const AliTPCcalibCosmic* cosmic){
<span class="lineNum">     298 </span>            :   //
<span class="lineNum">     299 </span>            :   // merge the content of the cosmic componentnts
<span class="lineNum">     300 </span>            :   //
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :   for (Int_t ivar=0; ivar&lt;6;ivar++){</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :     if (fHistoDelta[ivar] &amp;&amp; cosmic-&gt;fHistoDelta[ivar]){</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :       fHistoDelta[ivar]-&gt;Add(cosmic-&gt;fHistoDelta[ivar]);</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     if (fHistoPull[ivar] &amp;&amp; cosmic-&gt;fHistoPull[ivar]){</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :       fHistoPull[ivar]-&gt;Add(cosmic-&gt;fHistoPull[ivar]);</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     308 </span>            :   }
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :   for (Int_t ivar=0; ivar&lt;4;ivar++){</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :     if (fHistodEdxMax[ivar] &amp;&amp; cosmic-&gt;fHistodEdxMax[ivar]){</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :       fHistodEdxMax[ivar]-&gt;Add(cosmic-&gt;fHistodEdxMax[ivar]);</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :     if (fHistodEdxTot[ivar] &amp;&amp; cosmic-&gt;fHistodEdxTot[ivar]){</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :       fHistodEdxTot[ivar]-&gt;Add(cosmic-&gt;fHistodEdxTot[ivar]);</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     316 </span>            :   }
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :   if (cosmic-&gt;fCosmicTree){</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :     if (!fCosmicTree) {</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :       fCosmicTree = new TTree(&quot;pairs&quot;,&quot;pairs&quot;);</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :       fCosmicTree-&gt;SetDirectory(0);</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :     AliTPCcalibCosmic::AddTree(fCosmicTree,cosmic-&gt;fCosmicTree);</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span>            : 
<a name="327"><span class="lineNum">     327 </span>            : </a>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            : void AliTPCcalibCosmic::Process(AliESDEvent *event) {
<span class="lineNum">     330 </span>            :   //
<span class="lineNum">     331 </span>            :   // Process of the ESD event  - fill calibration components
<span class="lineNum">     332 </span>            :   //
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   if (!event) {</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     Printf(&quot;ERROR: ESD not available&quot;);</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     336 </span>            :   }  
<span class="lineNum">     337 </span>            :    
<span class="lineNum">     338 </span>            :   //
<span class="lineNum">     339 </span>            :   //Int_t isOK=kTRUE;
<span class="lineNum">     340 </span>            :   // COSMIC not signed properly
<span class="lineNum">     341 </span>            :   //  UInt_t specie = event-&gt;GetEventSpecie();  // select only cosmic events
<span class="lineNum">     342 </span>            :   //if (specie==AliRecoParam::kCosmic || specie==AliRecoParam::kCalib) {
<span class="lineNum">     343 </span>            :   //  isOK = kTRUE;
<span class="lineNum">     344 </span>            :   //}
<span class="lineNum">     345 </span>            :   //if (!isOK) return;
<span class="lineNum">     346 </span>            :   // Work around
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :   FindCosmicPairs(event);</span>
<span class="lineNum">     348 </span>            :   //const AliMultiplicity *multiplicity = event-&gt;GetMultiplicity();
<span class="lineNum">     349 </span>            :   //  Int_t ntracklets = multiplicity-&gt;GetNumberOfTracklets();
<span class="lineNum">     350 </span>            :   //if (ntracklets&gt;6) return; // filter out &quot;normal&quot; event with high multiplicity
<span class="lineNum">     351 </span>            :   //const TString &amp;trigger = event-&gt;GetFiredTriggerClasses();
<span class="lineNum">     352 </span>            :   //if (trigger.Contains(&quot;C0OB0&quot;)==0) return;
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :   FindPairs(event); // nearly everything takes place in find pairs...</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :   if (GetDebugLevel()&gt;20) printf(&quot;Hallo world: Im here and processing an event\n&quot;);</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   Int_t ntracks=event-&gt;GetNumberOfTracks(); </span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :   fHistNTracks-&gt;Fill(ntracks);</span>
<span class="lineNum">     360 </span>            :   
<span class="lineNum">     361 </span><span class="lineNoCov">          0 : }</span>
<a name="362"><span class="lineNum">     362 </span>            : </a>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span>            : void AliTPCcalibCosmic::FillHistoPerformance(const AliExternalTrackParam *par0, const AliExternalTrackParam *par1, const AliExternalTrackParam *inner0, const AliExternalTrackParam */*inner1*/, AliTPCseed *seed0,  AliTPCseed *seed1, const AliExternalTrackParam *param0Combined , Int_t cross){
<span class="lineNum">     365 </span>            :   //
<span class="lineNum">     366 </span>            :   // par0,par1       - parameter of tracks at DCA 0
<span class="lineNum">     367 </span>            :   // inner0,inner1   - parameter of tracks at the TPC entrance
<span class="lineNum">     368 </span>            :   // seed0, seed1    - detailed track information
<span class="lineNum">     369 </span>            :   // param0Combined  - Use combined track parameters for binning
<span class="lineNum">     370 </span>            :   //
<span class="lineNum">     371 </span>            :   Int_t kMinCldEdx =20;
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :   Int_t ncl0 = seed0-&gt;GetNumberOfClusters();</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :   Int_t ncl1 = seed1-&gt;GetNumberOfClusters();</span>
<span class="lineNum">     374 </span>            :   const Double_t kpullCut    = 10;
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :   Double_t x[10];</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :   Double_t xyz0[3];</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :   Double_t xyz1[3];</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   par0-&gt;GetXYZ(xyz0);</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :   par1-&gt;GetXYZ(xyz1);</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :   Double_t radius0 = TMath::Sqrt(xyz0[0]*xyz0[0]+xyz0[1]*xyz0[1]);</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :   Double_t radius1 = TMath::Sqrt(xyz1[0]*xyz1[0]+xyz1[1]*xyz1[1]);</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :   inner0-&gt;GetXYZ(xyz0);</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :   Double_t alpha = TMath::ATan2(xyz0[1],xyz0[0]);</span>
<span class="lineNum">     384 </span>            :   // bin parameters
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :   x[1] = TMath::Min(ncl0,ncl1);</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   x[2] = (radius0+radius1)*0.5;</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :   x[3] = param0Combined-&gt;GetZ();</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :   x[4] = inner0-&gt;GetSnp();</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :   x[5] = param0Combined-&gt;GetTgl();</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :   x[6] = param0Combined-&gt;GetSigned1Pt();</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :   x[7] = param0Combined-&gt;Pt();</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :   x[8] = alpha;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :   x[9] = cross;</span>
<span class="lineNum">     394 </span>            :   // deltas
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :   Double_t delta[6];</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :   Double_t sigma[6];</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :   delta[0] = (par0-&gt;GetY()+par1-&gt;GetY());</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :   delta[1] = (par0-&gt;GetZ()-par1-&gt;GetZ());</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :   delta[2] = (par0-&gt;GetAlpha()-par1-&gt;GetAlpha()-TMath::Pi());</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :   delta[3] = (par0-&gt;GetTgl()+par1-&gt;GetTgl());</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :   delta[4] = (par0-&gt;GetParameter()[4]+par1-&gt;GetParameter()[4]);</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :   delta[5] = (par0-&gt;Pt()-par1-&gt;Pt())/((par0-&gt;Pt()+par1-&gt;Pt())*0.5);</span>
<span class="lineNum">     403 </span>            :   //
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :   sigma[0] = TMath::Sqrt(par0-&gt;GetSigmaY2()+par1-&gt;GetSigmaY2());</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :   sigma[1] = TMath::Sqrt(par0-&gt;GetSigmaZ2()+par1-&gt;GetSigmaZ2());</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :   sigma[2] = TMath::Sqrt(par0-&gt;GetSigmaSnp2()+par1-&gt;GetSigmaSnp2());</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :   sigma[3] = TMath::Sqrt(par0-&gt;GetSigmaTgl2()+par1-&gt;GetSigmaTgl2());</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :   sigma[4] = TMath::Sqrt(par0-&gt;GetSigma1Pt2()+par1-&gt;GetSigma1Pt2());</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :   sigma[5] = sigma[4]*((par0-&gt;Pt()+par1-&gt;Pt())*0.5);</span>
<span class="lineNum">     410 </span>            :   //
<span class="lineNum">     411 </span>            :   Bool_t isOK = kTRUE;
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :   for (Int_t ivar=0;ivar&lt;6;ivar++){</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     if (sigma[ivar]==0) isOK=kFALSE;</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :     x[0]= delta[ivar]/sigma[ivar];</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     if (TMath::Abs(x[0])&gt;kpullCut) isOK = kFALSE;</span>
<span class="lineNum">     416 </span>            :   }
<span class="lineNum">     417 </span>            :   //
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :   if (isOK) for (Int_t ivar=0;ivar&lt;6;ivar++){</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     x[0]= delta[ivar];    // Modifiation 10.10 use not normalized deltas</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     if (ivar==2 || ivar ==3) x[0]*=1000;  // angles in radian</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :     fHistoDelta[ivar]-&gt;Fill(x);</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :     if (sigma[ivar]&gt;0){</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :       x[0]= delta[ivar]/sigma[ivar];</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :       fHistoPull[ivar]-&gt;Fill(x);</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span>            :   //                                            
<span class="lineNum">     430 </span>            :   // Fill dedx performance
<span class="lineNum">     431 </span>            :   //
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :   for (Int_t ipad=0; ipad&lt;4;ipad++){</span>
<span class="lineNum">     433 </span>            :     //
<span class="lineNum">     434 </span>            :     //
<span class="lineNum">     435 </span>            :     //
<span class="lineNum">     436 </span>            :     Int_t row0=0;
<span class="lineNum">     437 </span>            :     Int_t row1=160;
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :     if (ipad==0) row1=63;</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :     if (ipad==1) {row0=63; row1=63+64;}</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :     if (ipad==2) {row0=128;}</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :     Int_t   nclUp       = TMath::Nint(seed0-&gt;CookdEdxAnalytical(0.01,0.7,0,row0,row1,2));</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :     Int_t   nclDown     = TMath::Nint(seed1-&gt;CookdEdxAnalytical(0.01,0.7,0,row0,row1,2));</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :     Int_t   minCl       = TMath::Min(nclUp,nclDown);</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :     if (minCl&lt;kMinCldEdx) continue;</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :     x[1] = minCl;</span>
<span class="lineNum">     446 </span>            :     //
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :     Float_t dEdxTotUp   = seed0-&gt;CookdEdxAnalytical(0.01,0.7,0,row0,row1);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     Float_t dEdxTotDown = seed1-&gt;CookdEdxAnalytical(0.01,0.7,0,row0,row1);</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :     Float_t dEdxMaxUp   = seed0-&gt;CookdEdxAnalytical(0.01,0.7,1,row0,row1);</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :     Float_t dEdxMaxDown = seed1-&gt;CookdEdxAnalytical(0.01,0.7,1,row0,row1);</span>
<span class="lineNum">     451 </span>            :     //
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :     if (dEdxTotDown&lt;=0) continue;</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :     if (dEdxMaxDown&lt;=0) continue;</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     x[0]=dEdxTotUp/dEdxTotDown;</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     fHistodEdxTot[ipad]-&gt;Fill(x);</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :     x[0]=dEdxMaxUp/dEdxMaxDown;</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :     fHistodEdxMax[ipad]-&gt;Fill(x);</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span>            :   
<a name="462"><span class="lineNum">     462 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span>            : void AliTPCcalibCosmic::FindPairs(const AliESDEvent *event){
<span class="lineNum">     465 </span>            :   //
<span class="lineNum">     466 </span>            :   // Find cosmic pairs
<span class="lineNum">     467 </span>            :   // 
<span class="lineNum">     468 </span>            :   // Track0 is choosen in upper TPC part
<span class="lineNum">     469 </span>            :   // Track1 is choosen in lower TPC part
<span class="lineNum">     470 </span>            :   //
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :   if (GetDebugLevel()&gt;20) printf(&quot;Hallo world: Im here\n&quot;);</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :   AliESDfriend *esdFriend=static_cast&lt;AliESDfriend*&gt;(event-&gt;FindListObject(&quot;AliESDfriend&quot;));</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :   Int_t ntracks=event-&gt;GetNumberOfTracks(); </span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :   TObjArray  tpcSeeds(ntracks);</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :   if (ntracks==0) return;</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :   Double_t vtxx[3]={0,0,0};</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :   Double_t svtxx[3]={0.000001,0.000001,100.};</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :   AliESDVertex vtx(vtxx,svtxx);</span>
<span class="lineNum">     479 </span>            :   //
<span class="lineNum">     480 </span>            :   //track loop
<span class="lineNum">     481 </span>            :   //
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;ntracks;++i) {</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :    AliESDtrack *track = event-&gt;GetTrack(i);</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :    fClusters-&gt;Fill(track-&gt;GetTPCNcls()); </span>
<span class="lineNum">     485 </span>            :   
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :    const AliExternalTrackParam * trackIn = track-&gt;GetInnerParam();</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :    const AliExternalTrackParam * trackOut = track-&gt;GetOuterParam();</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :    if (!trackIn) continue;</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :    if (!trackOut) continue;</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :    if (ntracks&gt;4 &amp;&amp; TMath::Abs(trackIn-&gt;GetTgl())&lt;0.0015) continue;  // filter laser </span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :    AliESDfriendTrack *friendTrack = (AliESDfriendTrack*)track-&gt;GetFriendTrack();</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :    if (!friendTrack) continue;</span>
<span class="lineNum">     495 </span>            :    TObject *calibObject;
<span class="lineNum">     496 </span>            :    AliTPCseed *seed = 0;   
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :    for (Int_t l=0;(calibObject=friendTrack-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :      if ((seed=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">     499 </span>            :    }
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :    if (seed) tpcSeeds.AddAt(seed,i);</span>
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :    Double_t meanP = 0.5*(trackIn-&gt;GetP() + trackOut-&gt;GetP());</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :    if (seed &amp;&amp; track-&gt;GetTPCNcls() &gt; 80 + 60/(1+TMath::Exp(-meanP+5))) {</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :      fDeDx-&gt;Fill(meanP, seed-&gt;CookdEdxNorm(0.0,0.45,0,0,kMaxRow));</span>
<span class="lineNum">     505 </span>            :      //
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :      if (meanP &gt; 0.4 &amp;&amp; meanP &lt; 0.45) fDeDxMIP-&gt;Fill(seed-&gt;CookdEdxNorm(0.0,0.45,0,0,kMaxRow));</span>
<span class="lineNum">     507 </span>            :      //
<span class="lineNum">     508 </span>            :      // if (GetDebugLevel()&gt;0&amp;&amp;meanP&gt;0.2&amp;&amp;seed-&gt;CookdEdxNorm(0.0,0.45,0,0,kMaxRow)&gt;300) {
<span class="lineNum">     509 </span>            : //        //TFile *curfile = AliAnalysisManager::GetAnalysisManager()-&gt;GetTree()-&gt;GetCurrentFile();
<span class="lineNum">     510 </span>            : //        //if (curfile) printf(&quot;&gt;&gt;&gt; p+ in file: %s \t event: %i \t Number of ESD tracks: %i \n&quot;, curfile-&gt;GetName(), (int)event-&gt;GetEventNumberInFile(), (int)ntracks);
<span class="lineNum">     511 </span>            : //        // if (track-&gt;GetOuterParam()-&gt;GetAlpha()&lt;0) cout &lt;&lt; &quot; Polartiy: &quot; &lt;&lt; track-&gt;GetSign() &lt;&lt; endl;
<span class="lineNum">     512 </span>            : //      }
<span class="lineNum">     513 </span>            : 
<span class="lineNum">     514 </span>            :    }
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :   if (ntracks&lt;2) return;</span>
<span class="lineNum">     519 </span>            :   //
<span class="lineNum">     520 </span>            :   // Find pairs
<span class="lineNum">     521 </span>            :   //
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;ntracks;++i) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :     AliESDtrack *track0 = event-&gt;GetTrack(i);     </span>
<span class="lineNum">     524 </span>            :     // track0 - choosen upper part
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     if (!track0) continue;</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :     if (!track0-&gt;GetOuterParam()) continue;</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :     if (track0-&gt;GetOuterParam()-&gt;GetAlpha()&lt;0) continue;</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     Double_t dir0[3];</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :     track0-&gt;GetDirection(dir0);    </span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :     for (Int_t j=0;j&lt;ntracks;++j) {</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :       if (i==j) continue;</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :       AliESDtrack *track1 = event-&gt;GetTrack(j);   </span>
<span class="lineNum">     533 </span>            :       //track 1 lower part
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :       if (!track1) continue;</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :       if (!track1-&gt;GetOuterParam()) continue;</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :       if (track1-&gt;GetOuterParam()-&gt;GetAlpha()&gt;0) continue;</span>
<span class="lineNum">     537 </span>            :       //
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :       Double_t dir1[3];</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :       track1-&gt;GetDirection(dir1);</span>
<span class="lineNum">     540 </span>            :       
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :       AliTPCseed * seed0 = (AliTPCseed*) tpcSeeds.At(i);</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :       AliTPCseed * seed1 = (AliTPCseed*) tpcSeeds.At(j);</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :       if (! seed0) continue;</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :       if (! seed1) continue;</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :       Float_t dedx0 = seed0-&gt;CookdEdxNorm(0.05,0.55,0,0,kMaxRow);</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :       Float_t dedx1 = seed1-&gt;CookdEdxNorm(0.05,0.55,0,0,kMaxRow);</span>
<span class="lineNum">     547 </span>            :       //
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :       Float_t dedx0I = seed0-&gt;CookdEdxNorm(0.05,0.55,0,0,63);</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :       Float_t dedx1I = seed1-&gt;CookdEdxNorm(0.05,0.55,0,0,63);</span>
<span class="lineNum">     550 </span>            :       //
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :       Float_t dedx0O = seed0-&gt;CookdEdxNorm(0.05,0.55,0,64,kMaxRow);</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :       Float_t dedx1O = seed1-&gt;CookdEdxNorm(0.05,0.55,0,64,kMaxRow);</span>
<span class="lineNum">     553 </span>            :       //
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :       Float_t dir = (dir0[0]*dir1[0] + dir0[1]*dir1[1] + dir0[2]*dir1[2]);</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :       Float_t d0  = track0-&gt;GetLinearD(0,0);</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :       Float_t d1  = track1-&gt;GetLinearD(0,0);</span>
<span class="lineNum">     557 </span>            :       //
<span class="lineNum">     558 </span>            :       // conservative cuts - convergence to be guarantied
<span class="lineNum">     559 </span>            :       // applying before track propagation
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :       if (TMath::Abs(d0+d1)&gt;fCutMaxD) continue;   // distance to the 0,0</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :       if (dir&gt;fCutMinDir) continue;               // direction vector product</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :       Float_t bz = AliTracker::GetBz();</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :       Float_t dvertex0[2];   //distance to 0,0</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :       Float_t dvertex1[2];   //distance to 0,0 </span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :       track0-&gt;GetDZ(0,0,0,bz,dvertex0);</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :       track1-&gt;GetDZ(0,0,0,bz,dvertex1);</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :       if (TMath::Abs(dvertex0[1])&gt;250) continue;</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :       if (TMath::Abs(dvertex1[1])&gt;250) continue;</span>
<span class="lineNum">     569 </span>            :       //
<span class="lineNum">     570 </span>            :       //
<span class="lineNum">     571 </span>            :       //
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :       Float_t dmax = TMath::Max(TMath::Abs(d0),TMath::Abs(d1));</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :       AliExternalTrackParam param0(*track0);</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :       AliExternalTrackParam param1(*track1);</span>
<span class="lineNum">     575 </span>            :       //
<span class="lineNum">     576 </span>            :       // Propagate using Magnetic field and correct fo material budget
<span class="lineNum">     577 </span>            :       //
<span class="lineNum">     578 </span>            :       Double_t sign0=-1;
<span class="lineNum">     579 </span>            :       Double_t sign1=1;
<span class="lineNum">     580 </span>            :       Double_t maxsnp=0.90;
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :       AliTracker::PropagateTrackToBxByBz(&amp;param0,dmax+1,TDatabasePDG::Instance()-&gt;GetParticle(&quot;e-&quot;)-&gt;Mass(),3,kTRUE,maxsnp,sign0);</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :       AliTracker::PropagateTrackToBxByBz(&amp;param1,dmax+1,TDatabasePDG::Instance()-&gt;GetParticle(&quot;e-&quot;)-&gt;Mass(),3,kTRUE,maxsnp,sign1);</span>
<span class="lineNum">     583 </span>            :       //
<span class="lineNum">     584 </span>            :       // Propagate rest to the 0,0 DCA - z should be ignored
<span class="lineNum">     585 </span>            :       //
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :       Bool_t b0 = param0.PropagateToDCA(&amp;vtx,bz,1000);</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :       Bool_t b1 = param1.PropagateToDCA(&amp;vtx,bz,1000);</span>
<span class="lineNum">     588 </span>            :       //      
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :       param0.GetDZ(0,0,0,bz,dvertex0);</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :       param1.GetDZ(0,0,0,bz,dvertex1);</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :       if (TMath::Abs(param0.GetZ()-param1.GetZ())&gt;fCutMaxDz) continue;</span>
<span class="lineNum">     592 </span>            :       //
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :       Double_t xyz0[3];//,pxyz0[3];</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :       Double_t xyz1[3];//,pxyz1[3];</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :       param0.GetXYZ(xyz0);</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :       param1.GetXYZ(xyz1);</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :       Bool_t isPair = IsPair(&amp;param0,&amp;param1);</span>
<span class="lineNum">     598 </span>            :       //
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :       if (isPair) FillAcordeHist(track0);</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :       if (isPair &amp;&amp;param0.Pt()&gt;1) {</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :         const TString &amp;trigger = event-&gt;GetFiredTriggerClasses(); </span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :         UInt_t specie = event-&gt;GetEventSpecie();</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :         printf(&quot;COSMIC ?\t%s\t%d\t%f\t%f\n&quot;, trigger.Data(),specie, param0.GetZ(), param1.GetZ()); </span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     605 </span>            :       //
<span class="lineNum">     606 </span>            :       // combined track params 
<span class="lineNum">     607 </span>            :       //
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :       AliExternalTrackParam *par0U=MakeCombinedTrack(&amp;param0,&amp;param1);</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :       AliExternalTrackParam *par1U=MakeCombinedTrack(&amp;param1,&amp;param0);</span>
<span class="lineNum">     610 </span>            :       
<span class="lineNum">     611 </span>            :       //
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :       if (fStreamLevel&gt;0){</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :         TTreeSRedirector * cstream =  GetDebugStreamer();</span>
<span class="lineNum">     614 </span>            :         //printf(&quot;My stream=%p\n&quot;,(void*)cstream);
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :         AliExternalTrackParam *ip0 = (AliExternalTrackParam *)track0-&gt;GetInnerParam();</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :         AliExternalTrackParam *ip1 = (AliExternalTrackParam *)track1-&gt;GetInnerParam();</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :         AliExternalTrackParam *op0 = (AliExternalTrackParam *)track0-&gt;GetOuterParam();</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :         AliExternalTrackParam *op1 = (AliExternalTrackParam *)track1-&gt;GetOuterParam();</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :         Bool_t isCrossI = ip0-&gt;GetZ()*ip1-&gt;GetZ()&lt;0;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :         Bool_t isCrossO = op0-&gt;GetZ()*op1-&gt;GetZ()&lt;0;</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :         Double_t alpha0 = TMath::ATan2(dir0[1],dir0[0]);</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :         Double_t alpha1 = TMath::ATan2(dir1[1],dir1[0]);</span>
<span class="lineNum">     623 </span>            :         //
<span class="lineNum">     624 </span>            :         //
<span class="lineNum">     625 </span>            :         //
<span class="lineNum">     626 </span>            :         Int_t cross =0;  // 0 no cross, 2 cross on both sides
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :         if (isCrossI) cross+=1; </span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :         if (isCrossO) cross+=1; </span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :         FillHistoPerformance(&amp;param0, &amp;param1, ip0, ip1, seed0, seed1,par0U, cross);</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :         if (cstream) {</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :           (*cstream) &lt;&lt; &quot;Track0&quot; &lt;&lt;</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :             &quot;run=&quot;&lt;&lt;fRun&lt;&lt;              //  run number</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :             &quot;event=&quot;&lt;&lt;fEvent&lt;&lt;          //  event number</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :             &quot;time=&quot;&lt;&lt;fTime&lt;&lt;            //  time stamp of event</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :             &quot;trigger=&quot;&lt;&lt;fTrigger&lt;&lt;      //  trigger</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :             &quot;triggerClass=&quot;&lt;&lt;&amp;fTriggerClass&lt;&lt;      //  trigger</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :             &quot;mag=&quot;&lt;&lt;fMagF&lt;&lt;             //  magnetic field</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :             &quot;dir=&quot;&lt;&lt;dir&lt;&lt;               //  direction</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :             &quot;OK=&quot;&lt;&lt;isPair&lt;&lt;             //  will be accepted</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :             &quot;b0=&quot;&lt;&lt;b0&lt;&lt;                 //  propagate status</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :             &quot;b1=&quot;&lt;&lt;b1&lt;&lt;                 //  propagate status</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :             &quot;crossI=&quot;&lt;&lt;isCrossI&lt;&lt;       //  cross inner</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :             &quot;crossO=&quot;&lt;&lt;isCrossO&lt;&lt;       //  cross outer</span>
<span class="lineNum">     644 </span>            :             //
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :             &quot;Orig0.=&quot; &lt;&lt; track0 &lt;&lt;      //  original track  0</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :             &quot;Orig1.=&quot; &lt;&lt; track1 &lt;&lt;      //  original track  1</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :             &quot;Tr0.=&quot;&lt;&lt;&amp;param0&lt;&lt;          //  track propagated to the DCA 0,0</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :             &quot;Tr1.=&quot;&lt;&lt;&amp;param1&lt;&lt;          //  track propagated to the DCA 0,0      </span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :             &quot;Ip0.=&quot;&lt;&lt;ip0&lt;&lt;              //  inner param - upper</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :             &quot;Ip1.=&quot;&lt;&lt;ip1&lt;&lt;              //  inner param - lower</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :             &quot;Op0.=&quot;&lt;&lt;op0&lt;&lt;              //  outer param - upper</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :             &quot;Op1.=&quot;&lt;&lt;op1&lt;&lt;              //  outer param - lower</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :             &quot;Up0.=&quot;&lt;&lt;par0U&lt;&lt;           //  combined track 0</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :             &quot;Up1.=&quot;&lt;&lt;par1U&lt;&lt;           //  combined track 1</span>
<span class="lineNum">     655 </span>            :             //
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :             &quot;v00=&quot;&lt;&lt;dvertex0[0]&lt;&lt;       //  distance using kalman</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :             &quot;v01=&quot;&lt;&lt;dvertex0[1]&lt;&lt;       // </span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :             &quot;v10=&quot;&lt;&lt;dvertex1[0]&lt;&lt;       //</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :             &quot;v11=&quot;&lt;&lt;dvertex1[1]&lt;&lt;       // </span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :             &quot;d0=&quot;&lt;&lt;d0&lt;&lt;                 //  linear distance to 0,0</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :             &quot;d1=&quot;&lt;&lt;d1&lt;&lt;                 //  linear distance to 0,0</span>
<span class="lineNum">     662 </span>            :             //
<span class="lineNum">     663 </span>            :             //
<span class="lineNum">     664 </span>            :             //
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :             &quot;x00=&quot;&lt;&lt;xyz0[0]&lt;&lt;           // global position close to vertex</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :             &quot;x01=&quot;&lt;&lt;xyz0[1]&lt;&lt;</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :             &quot;x02=&quot;&lt;&lt;xyz0[2]&lt;&lt;</span>
<span class="lineNum">     668 </span>            :             //
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :             &quot;x10=&quot;&lt;&lt;xyz1[0]&lt;&lt;           // global position close to vertex</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :             &quot;x11=&quot;&lt;&lt;xyz1[1]&lt;&lt;</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :             &quot;x12=&quot;&lt;&lt;xyz1[2]&lt;&lt;</span>
<span class="lineNum">     672 </span>            :             //
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :             &quot;alpha0=&quot;&lt;&lt;alpha0&lt;&lt;</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :             &quot;alpha1=&quot;&lt;&lt;alpha1&lt;&lt;</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :             &quot;dir00=&quot;&lt;&lt;dir0[0]&lt;&lt;           // direction upper</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :             &quot;dir01=&quot;&lt;&lt;dir0[1]&lt;&lt;</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :             &quot;dir02=&quot;&lt;&lt;dir0[2]&lt;&lt;</span>
<span class="lineNum">     678 </span>            :             //
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :             &quot;dir10=&quot;&lt;&lt;dir1[0]&lt;&lt;           // direction lower</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :             &quot;dir11=&quot;&lt;&lt;dir1[1]&lt;&lt;</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :             &quot;dir12=&quot;&lt;&lt;dir1[2]&lt;&lt;</span>
<span class="lineNum">     682 </span>            :             //
<span class="lineNum">     683 </span>            :             //
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :             &quot;Seed0.=&quot; &lt;&lt; seed0 &lt;&lt;       //  original seed 0</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :             &quot;Seed1.=&quot; &lt;&lt; seed1 &lt;&lt;       //  original seed 1</span>
<span class="lineNum">     686 </span>            :             //
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :             &quot;dedx0=&quot;&lt;&lt;dedx0&lt;&lt;           //  dedx0 - all</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :             &quot;dedx1=&quot;&lt;&lt;dedx1&lt;&lt;           //  dedx1 - all</span>
<span class="lineNum">     689 </span>            :             //
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :             &quot;dedx0I=&quot;&lt;&lt;dedx0I&lt;&lt;         //  dedx0 - inner ROC</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :             &quot;dedx1I=&quot;&lt;&lt;dedx1I&lt;&lt;         //  dedx1 - inner ROC</span>
<span class="lineNum">     692 </span>            :             //
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :             &quot;dedx0O=&quot;&lt;&lt;dedx0O&lt;&lt;         //  dedx0 - outer ROC</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :             &quot;dedx1O=&quot;&lt;&lt;dedx1O&lt;&lt;         //  dedx1 - outer ROC</span>
<span class="lineNum">     695 </span>            :             &quot;\n&quot;;
<span class="lineNum">     696 </span>            :         }
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :       delete par0U;</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :       delete par1U;</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :   }  </span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 : }    </span>
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span>            : 
<a name="705"><span class="lineNum">     705 </span>            : </a>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span>            : void  AliTPCcalibCosmic::FillAcordeHist(AliESDtrack *upperTrack) {
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span>            :   // Pt cut to select straight tracks which can be easily propagated to ACORDE which is outside the magnetic field
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :   if (upperTrack-&gt;Pt() &lt; 10 || upperTrack-&gt;GetTPCNcls() &lt; 80) return;</span>
<span class="lineNum">     711 </span>            :     
<span class="lineNum">     712 </span>            :   const Double_t acordePlane = 850.; // distance of the central Acorde detectors to the beam line at y =0
<span class="lineNum">     713 </span>            :   const Double_t roof = 210.5;       // distance from x =0 to end of magnet roof
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :   Double_t r[3];</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :   upperTrack-&gt;GetXYZ(r);</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :   Double_t d[3];</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :   upperTrack-&gt;GetDirection(d);</span>
<span class="lineNum">     719 </span>            :   Double_t x,z;
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :   z = r[2] + (d[2]/d[1])*(acordePlane - r[1]);</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :   x = r[0] + (d[0]/d[1])*(acordePlane - r[1]);</span>
<span class="lineNum">     722 </span>            :   
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :   if (x &gt; roof) {</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :     x = r[0] + (d[0]/(d[0]+d[1]))*(acordePlane+roof-r[0]-r[1]);</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :     z = r[2] + (d[2]/(d[0]+d[1]))*(acordePlane+roof-r[0]-r[1]);</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :   if (x &lt; -roof) {</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :     x = r[0] + (d[0]/(d[1]-d[0]))*(acordePlane+roof+r[0]-r[1]);       </span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :     z = r[2] + (d[2]/(d[1]-d[0]))*(acordePlane+roof+r[0]-r[1]);</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :   } </span>
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :   fModules-&gt;Fill(z, x);</span>
<span class="lineNum">     733 </span>            :  
<span class="lineNum">     734 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     735 </span>            : 
<a name="736"><span class="lineNum">     736 </span>            : </a>
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span>            : Long64_t AliTPCcalibCosmic::Merge(TCollection *const li) {
<span class="lineNum">     739 </span>            :   //
<span class="lineNum">     740 </span>            :   // component merging
<span class="lineNum">     741 </span>            :   //
<span class="lineNum">     742 </span>            : 
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :   TIterator* iter = li-&gt;MakeIterator();</span>
<span class="lineNum">     744 </span>            :   AliTPCcalibCosmic* cal = 0;
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :   while ((cal = (AliTPCcalibCosmic*)iter-&gt;Next())) {</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :     if (!cal-&gt;InheritsFrom(AliTPCcalibCosmic::Class())) {</span>
<span class="lineNum">     748 </span>            :       //Error(&quot;Merge&quot;,&quot;Attempt to add object of class %s to a %s&quot;, cal-&gt;ClassName(), this-&gt;ClassName());
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :       return -1;</span>
<span class="lineNum">     750 </span>            :     }
<span class="lineNum">     751 </span>            :     
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :     fHistNTracks-&gt;Add(cal-&gt;GetHistNTracks());</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :     fClusters-&gt;Add(cal-&gt; GetHistClusters());</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :     fModules-&gt;Add(cal-&gt;GetHistAcorde());</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     fHistPt-&gt;Add(cal-&gt;GetHistPt());</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :     fDeDx-&gt;Add(cal-&gt;GetHistDeDx());</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :     fDeDxMIP-&gt;Add(cal-&gt;GetHistMIP());</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :     Add(cal);</span>
<span class="lineNum">     759 </span>            :   }
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     761 </span>            :   
<span class="lineNum">     762 </span><span class="lineNoCov">          0 : }</span>
<a name="763"><span class="lineNum">     763 </span>            : </a>
<span class="lineNum">     764 </span>            : 
<span class="lineNum">     765 </span>            : Bool_t  AliTPCcalibCosmic::IsPair(AliExternalTrackParam *tr0, AliExternalTrackParam *tr1) const{
<span class="lineNum">     766 </span>            :   //
<span class="lineNum">     767 </span>            :   //
<span class="lineNum">     768 </span>            :   /*
<span class="lineNum">     769 </span>            :   // 0. Same direction - OPOSITE  - cutDir +cutT    
<span class="lineNum">     770 </span>            :   TCut cutDir(&quot;cutDir&quot;,&quot;dir&lt;-0.99&quot;)
<span class="lineNum">     771 </span>            :   // 1. 
<span class="lineNum">     772 </span>            :   TCut cutT(&quot;cutT&quot;,&quot;abs(Tr1.fP[3]+Tr0.fP[3])&lt;0.03&quot;)
<span class="lineNum">     773 </span>            :   //
<span class="lineNum">     774 </span>            :   // 2. The same rphi 
<span class="lineNum">     775 </span>            :   TCut cutD(&quot;cutD&quot;,&quot;abs(Tr0.fP[0]+Tr1.fP[0])&lt;5&quot;)
<span class="lineNum">     776 </span>            :   //
<span class="lineNum">     777 </span>            :   //
<span class="lineNum">     778 </span>            :   //
<span class="lineNum">     779 </span>            :   TCut cutPt(&quot;cutPt&quot;,&quot;abs(Tr1.fP[4]+Tr0.fP[4])&lt;1&amp;&amp;abs(Tr0.fP[4])+abs(Tr1.fP[4])&lt;10&quot;);  
<span class="lineNum">     780 </span>            :   // 1/Pt diff cut
<span class="lineNum">     781 </span>            :   */
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :   const Double_t *p0 = tr0-&gt;GetParameter();</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :   const Double_t *p1 = tr1-&gt;GetParameter();</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :   if (TMath::Abs(p0[3]+p1[3])&gt;fCutTheta) return kFALSE;</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :   if (TMath::Abs(p0[1]-p1[1])&gt;fCutMaxDz) return kFALSE;</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :   if (TMath::Abs(p0[0]+p1[0])&gt;fCutMaxD)  return kFALSE;</span>
<span class="lineNum">     787 </span>            :   
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :   Double_t d0[3], d1[3];</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :   tr0-&gt;GetDirection(d0);    </span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :   tr1-&gt;GetDirection(d1);       </span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :   if (d0[0]*d1[0] + d0[1]*d1[1] + d0[2]*d1[2] &gt;fCutMinDir) return kFALSE;</span>
<span class="lineNum">     792 </span>            :   //
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :   return kTRUE;  </span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     795 </span>            :  
<a name="796"><span class="lineNum">     796 </span>            : </a>
<span class="lineNum">     797 </span>            : 
<span class="lineNum">     798 </span>            : Double_t AliTPCcalibCosmic::CalculateMIPvalue(TH1F * hist) {
<span class="lineNum">     799 </span>            :   //
<span class="lineNum">     800 </span>            :   // Calculate the MIP value - gaussian fit used
<span class="lineNum">     801 </span>            :   //
<span class="lineNum">     802 </span>            : 
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :   TF1 * funcDoubleGaus = new TF1(&quot;funcDoubleGaus&quot;, &quot;gaus(0)+gaus(3)&quot;,0,1000);</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :   funcDoubleGaus-&gt;SetParameters(hist-&gt;GetEntries()*0.75,hist-&gt;GetMean()/1.3,hist-&gt;GetMean()*0.10,</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :                                 hist-&gt;GetEntries()*0.25,hist-&gt;GetMean()*1.3,hist-&gt;GetMean()*0.10);</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :   hist-&gt;Fit(funcDoubleGaus);</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :   Double_t aMIPvalue = TMath::Min(funcDoubleGaus-&gt;GetParameter(1),funcDoubleGaus-&gt;GetParameter(4));</span>
<span class="lineNum">     808 </span>            : 
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :   delete funcDoubleGaus;</span>
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :   return aMIPvalue;</span>
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span>            : 
<a name="816"><span class="lineNum">     816 </span>            : </a>
<span class="lineNum">     817 </span>            : 
<span class="lineNum">     818 </span>            : void AliTPCcalibCosmic::CalculateBetheParams(TH2F */*hist*/, Double_t * /*initialParam*/) {
<span class="lineNum">     819 </span>            :   //
<span class="lineNum">     820 </span>            :   // Not implemented yet
<span class="lineNum">     821 </span>            :   //
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :   return;</span>
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span>            : }
<a name="825"><span class="lineNum">     825 </span>            : </a>
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span>            : void AliTPCcalibCosmic::BinLogX(THnSparse *const h, Int_t axisDim) {
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span>            :   // Method for the correct logarithmic binning of histograms
<span class="lineNum">     830 </span>            : 
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :   TAxis *axis = h-&gt;GetAxis(axisDim);</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :   int bins = axis-&gt;GetNbins();</span>
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :   Double_t from = axis-&gt;GetXmin();</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :   Double_t to = axis-&gt;GetXmax();</span>
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :   Double_t *newBins = new Double_t[bins + 1];</span>
<span class="lineNum">     837 </span>            : 
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :   newBins[0] = from;</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :   Double_t factor = pow(to/from, 1./bins);</span>
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :   for (int i = 1; i &lt;= bins; i++) {</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :    newBins[i] = factor * newBins[i-1];</span>
<span class="lineNum">     843 </span>            :   }
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :   axis-&gt;Set(bins, newBins);</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :   delete [] newBins;</span>
<span class="lineNum">     846 </span>            : 
<span class="lineNum">     847 </span><span class="lineNoCov">          0 : }</span>
<a name="848"><span class="lineNum">     848 </span>            : </a>
<span class="lineNum">     849 </span>            : 
<span class="lineNum">     850 </span>            : void AliTPCcalibCosmic::BinLogX(TH1 *const h) {
<span class="lineNum">     851 </span>            : 
<span class="lineNum">     852 </span>            :   // Method for the correct logarithmic binning of histograms
<span class="lineNum">     853 </span>            : 
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :   TAxis *axis = h-&gt;GetXaxis();</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :   int bins = axis-&gt;GetNbins();</span>
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :   Double_t from = axis-&gt;GetXmin();</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :   Double_t to = axis-&gt;GetXmax();</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :   Double_t *newBins = new Double_t[bins + 1];</span>
<span class="lineNum">     860 </span>            :    
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :   newBins[0] = from;</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :   Double_t factor = pow(to/from, 1./bins);</span>
<span class="lineNum">     863 </span>            :   
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :   for (int i = 1; i &lt;= bins; i++) {</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :    newBins[i] = factor * newBins[i-1];</span>
<span class="lineNum">     866 </span>            :   }
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :   axis-&gt;Set(bins, newBins);</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :   delete [] newBins;</span>
<span class="lineNum">     869 </span>            :   
<span class="lineNum">     870 </span><span class="lineNoCov">          0 : }</span>
<a name="871"><span class="lineNum">     871 </span>            : </a>
<span class="lineNum">     872 </span>            : 
<span class="lineNum">     873 </span>            : AliExternalTrackParam *AliTPCcalibCosmic::MakeTrack(const AliExternalTrackParam *track0, const AliExternalTrackParam *track1){
<span class="lineNum">     874 </span>            :   //
<span class="lineNum">     875 </span>            :   // Make a atrack using the kalman update of track0 and track1
<span class="lineNum">     876 </span>            :   //
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :   AliExternalTrackParam *par1R= new AliExternalTrackParam(*track1);</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :   par1R-&gt;Rotate(track0-&gt;GetAlpha());</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :   par1R-&gt;PropagateTo(track0-&gt;GetX(),AliTracker::GetBz()); </span>
<span class="lineNum">     880 </span>            :   //
<span class="lineNum">     881 </span>            :   //
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :   Double_t * param = (Double_t*)par1R-&gt;GetParameter();</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :   Double_t * covar = (Double_t*)par1R-&gt;GetCovariance();</span>
<span class="lineNum">     884 </span>            : 
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :   param[0]*=1;  //OK</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :   param[1]*=1;  //OK</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :   param[2]*=1;  //?</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :   param[3]*=-1; //OK</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :   param[4]*=-1; //OK</span>
<span class="lineNum">     890 </span>            :   //
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :   covar[6] *=-1.; covar[7] *=-1.; covar[8] *=-1.;</span>
<span class="lineNum">     892 </span>            :   //covar[10]*=-1.; covar[11]*=-1.; covar[12]*=-1.;
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :   covar[13]*=-1.;</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :   return par1R;</span>
<a name="895"><span class="lineNum">     895 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span>            : AliExternalTrackParam *AliTPCcalibCosmic::MakeCombinedTrack(const AliExternalTrackParam *track0, const AliExternalTrackParam *track1){
<span class="lineNum">     898 </span>            :   //
<span class="lineNum">     899 </span>            :   // Make combined track
<span class="lineNum">     900 </span>            :   //
<span class="lineNum">     901 </span>            :   //
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :   AliExternalTrackParam * par1T = MakeTrack(track0,track1);</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :   AliExternalTrackParam * par0U = new AliExternalTrackParam(*track0);</span>
<span class="lineNum">     904 </span>            :   //
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :   UpdateTrack(*par0U,*par1T);</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :   delete par1T;</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :   return par0U;</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 : }</span>
<a name="909"><span class="lineNum">     909 </span>            : </a>
<span class="lineNum">     910 </span>            : 
<span class="lineNum">     911 </span>            : void AliTPCcalibCosmic::UpdateTrack(AliExternalTrackParam &amp;track1, const AliExternalTrackParam &amp;track2){
<span class="lineNum">     912 </span>            :   //
<span class="lineNum">     913 </span>            :   // Update track 1 with track 2
<span class="lineNum">     914 </span>            :   //
<span class="lineNum">     915 </span>            :   //
<span class="lineNum">     916 </span>            :   //
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :   TMatrixD vecXk(5,1);    // X vector</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :   TMatrixD covXk(5,5);    // X covariance </span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :   TMatrixD matHk(5,5);    // vector to mesurement</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :   TMatrixD measR(5,5);    // measurement error </span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :   TMatrixD vecZk(5,1);    // measurement</span>
<span class="lineNum">     922 </span>            :   //
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :   TMatrixD vecYk(5,1);    // Innovation or measurement residual</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :   TMatrixD matHkT(5,5);</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :   TMatrixD matSk(5,5);    // Innovation (or residual) covariance</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :   TMatrixD matKk(5,5);    // Optimal Kalman gain</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :   TMatrixD mat1(5,5);     // update covariance matrix</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :   TMatrixD covXk2(5,5);   // </span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :   TMatrixD covOut(5,5);</span>
<span class="lineNum">     930 </span>            :   //
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :   Double_t *param1=(Double_t*) track1.GetParameter();</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :   Double_t *covar1=(Double_t*) track1.GetCovariance();</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :   Double_t *param2=(Double_t*) track2.GetParameter();</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :   Double_t *covar2=(Double_t*) track2.GetCovariance();</span>
<span class="lineNum">     935 </span>            :   //
<span class="lineNum">     936 </span>            :   // copy data to the matrix
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :   for (Int_t ipar=0; ipar&lt;5; ipar++){</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :     for (Int_t jpar=0; jpar&lt;5; jpar++){</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :       covXk(ipar,jpar) = covar1[track1.GetIndex(ipar, jpar)];</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :       measR(ipar,jpar) = covar2[track2.GetIndex(ipar, jpar)];</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :       matHk(ipar,jpar)=0;</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :       mat1(ipar,jpar)=0;</span>
<span class="lineNum">     943 </span>            :     }
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :     vecXk(ipar,0) = param1[ipar];</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :     vecZk(ipar,0) = param2[ipar];</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :     matHk(ipar,ipar)=1;</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :     mat1(ipar,ipar)=0;</span>
<span class="lineNum">     948 </span>            :   }
<span class="lineNum">     949 </span>            :   //
<span class="lineNum">     950 </span>            :   //
<span class="lineNum">     951 </span>            :   //
<span class="lineNum">     952 </span>            :   //
<span class="lineNum">     953 </span>            :   //
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :   vecYk = vecZk-matHk*vecXk;                 // Innovation or measurement residual</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :   matHkT=matHk.T(); matHk.T();</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :   matSk = (matHk*(covXk*matHkT))+measR;      // Innovation (or residual) covariance</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :   matSk.Invert();</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :   matKk = (covXk*matHkT)*matSk;              //  Optimal Kalman gain</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :   vecXk += matKk*vecYk;                      //  updated vector </span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :   covXk2 = (mat1-(matKk*matHk));</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :   covOut =  covXk2*covXk; </span>
<span class="lineNum">     962 </span>            :   //
<span class="lineNum">     963 </span>            :   //
<span class="lineNum">     964 </span>            :   //
<span class="lineNum">     965 </span>            :   // copy from matrix to parameters
<span class="lineNum">     966 </span>            :   if (0) {
<span class="lineNum">     967 </span>            :     vecXk.Print();
<span class="lineNum">     968 </span>            :     vecZk.Print();
<span class="lineNum">     969 </span>            :     //
<span class="lineNum">     970 </span>            :     measR.Print();
<span class="lineNum">     971 </span>            :     covXk.Print();
<span class="lineNum">     972 </span>            :     covOut.Print();
<span class="lineNum">     973 </span>            :     //
<span class="lineNum">     974 </span>            :     track1.Print();
<span class="lineNum">     975 </span>            :     track2.Print();
<span class="lineNum">     976 </span>            :   }
<span class="lineNum">     977 </span>            : 
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :   for (Int_t ipar=0; ipar&lt;5; ipar++){</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :     param1[ipar]= vecXk(ipar,0) ;</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :     for (Int_t jpar=0; jpar&lt;5; jpar++){</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :       covar1[track1.GetIndex(ipar, jpar)]=covOut(ipar,jpar);</span>
<span class="lineNum">     982 </span>            :     }
<span class="lineNum">     983 </span>            :   }
<span class="lineNum">     984 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     985 </span>            : 
<a name="986"><span class="lineNum">     986 </span>            : </a>
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span>            : void AliTPCcalibCosmic::FindCosmicPairs(const AliESDEvent * event) {
<span class="lineNum">     989 </span>            :   //
<span class="lineNum">     990 </span>            :   // find cosmic pairs trigger by random trigger
<span class="lineNum">     991 </span>            :   //
<span class="lineNum">     992 </span>            :   //
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :   AliESDVertex *vertexSPD =  (AliESDVertex *)event-&gt;GetPrimaryVertexSPD();</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :   AliESDVertex *vertexTPC =  (AliESDVertex *)event-&gt;GetPrimaryVertexTPC(); </span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :   AliESDfriend *esdFriend=static_cast&lt;AliESDfriend*&gt;(event-&gt;FindListObject(&quot;AliESDfriend&quot;));</span>
<span class="lineNum">     996 </span>            :   const Double_t kMinPt=1;
<span class="lineNum">     997 </span>            :   const Double_t kMinPtMax=0.8;
<span class="lineNum">     998 </span>            :   const Double_t kMinNcl=50;
<span class="lineNum">     999 </span>            :   const Double_t kMaxDelta[5]={2,600,0.02,0.02,0.1};
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :   Int_t ntracks=event-&gt;GetNumberOfTracks(); </span>
<span class="lineNum">    1001 </span>            :   //  Float_t dcaTPC[2]={0,0};
<span class="lineNum">    1002 </span>            :   // Float_t covTPC[3]={0,0,0};
<span class="lineNum">    1003 </span>            : 
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :   UInt_t specie = event-&gt;GetEventSpecie();  // skip laser events</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :   if (specie==AliRecoParam::kCalib) return;</span>
<span class="lineNum">    1006 </span>            :   
<span class="lineNum">    1007 </span>            : 
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :   for (Int_t itrack0=0;itrack0&lt;ntracks;itrack0++) {</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :     AliESDtrack *track0 = event-&gt;GetTrack(itrack0);</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :     if (!track0) continue;</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :     if (!track0-&gt;IsOn(AliESDtrack::kTPCrefit)) continue;</span>
<span class="lineNum">    1013 </span>            : 
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :     if (TMath::Abs(AliTracker::GetBz())&gt;1&amp;&amp;track0-&gt;Pt()&lt;kMinPt) continue;</span>
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :     if (track0-&gt;GetTPCncls()&lt;kMinNcl) continue;</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :     if (TMath::Abs(track0-&gt;GetY())&lt;kMaxDelta[0]) continue; </span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :     if (track0-&gt;GetKinkIndex(0)&gt;0) continue;</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :     const Double_t * par0=track0-&gt;GetParameter(); //track param at rhe DCA</span>
<span class="lineNum">    1019 </span>            :     //rm primaries
<span class="lineNum">    1020 </span>            :     //
<span class="lineNum">    1021 </span>            :     //track0-&gt;GetImpactParametersTPC(dcaTPC,covTPC);
<span class="lineNum">    1022 </span>            :     //if (TMath::Abs(dcaTPC[0])&lt;kMaxDelta[0]) continue;
<span class="lineNum">    1023 </span>            :     //if (TMath::Abs(dcaTPC[1])&lt;kMaxDelta[0]*2) continue;
<span class="lineNum">    1024 </span>            :     //    const AliExternalTrackParam * trackIn0 = track0-&gt;GetInnerParam();
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :     for (Int_t itrack1=itrack0+1;itrack1&lt;ntracks;itrack1++) {</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :       AliESDtrack *track1 = event-&gt;GetTrack(itrack1);</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :       if (!track1) continue;  </span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :       if (!track1-&gt;IsOn(AliESDtrack::kTPCrefit)) continue;</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :       if (track1-&gt;GetKinkIndex(0)&gt;0) continue;</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :       if (TMath::Abs(AliTracker::GetBz())&gt;1&amp;&amp;track1-&gt;Pt()&lt;kMinPt) continue;</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :       if (track1-&gt;GetTPCncls()&lt;kMinNcl) continue;</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :       if (TMath::Abs(AliTracker::GetBz())&gt;1&amp;&amp;TMath::Max(track1-&gt;Pt(), track0-&gt;Pt())&lt;kMinPtMax) continue;</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :       if (TMath::Abs(track1-&gt;GetY())&lt;kMaxDelta[0]) continue;</span>
<span class="lineNum">    1034 </span>            :       //track1-&gt;GetImpactParametersTPC(dcaTPC,covTPC);
<span class="lineNum">    1035 </span>            :       //      if (TMath::Abs(dcaTPC[0])&lt;kMaxDelta[0]) continue;
<span class="lineNum">    1036 </span>            :       //if (TMath::Abs(dcaTPC[1])&lt;kMaxDelta[0]*2) continue;
<span class="lineNum">    1037 </span>            :       //
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :       const Double_t* par1=track1-&gt;GetParameter(); //track param at rhe DCA</span>
<span class="lineNum">    1039 </span>            :       //
<span class="lineNum">    1040 </span>            :       Bool_t isPair=kTRUE;
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :       for (Int_t ipar=0; ipar&lt;5; ipar++){</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :         if (ipar==4&amp;&amp;TMath::Abs(AliTracker::GetBz())&lt;1) continue; // 1/pt not defined for B field off</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :         if (TMath::Abs(TMath::Abs(par0[ipar])-TMath::Abs(par1[ipar]))&gt;kMaxDelta[ipar]) isPair=kFALSE;</span>
<span class="lineNum">    1044 </span>            :       }
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :       if (!isPair) continue;</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :       if (TMath::Abs(TMath::Abs(track0-&gt;GetAlpha()-track1-&gt;GetAlpha())-TMath::Pi())&gt;kMaxDelta[2]) isPair=kFALSE;</span>
<span class="lineNum">    1047 </span>            :       //delta with correct sign
<span class="lineNum">    1048 </span>            :       /*
<span class="lineNum">    1049 </span>            :         TCut cut0=&quot;abs(t1.fP[0]+t0.fP[0])&lt;2&quot;
<span class="lineNum">    1050 </span>            :         TCut cut3=&quot;abs(t1.fP[3]+t0.fP[3])&lt;0.02&quot;
<span class="lineNum">    1051 </span>            :         TCut cut4=&quot;abs(t1.fP[4]+t0.fP[4])&lt;0.2&quot;
<span class="lineNum">    1052 </span>            :       */
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :       if  (TMath::Abs(par0[0]+par1[0])&gt;kMaxDelta[0]) isPair=kFALSE; //delta y   opposite sign</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :       if  (TMath::Abs(par0[3]+par1[3])&gt;kMaxDelta[3]) isPair=kFALSE; //delta tgl opposite sign</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :       if  (TMath::Abs(AliTracker::GetBz())&gt;1 &amp;&amp; TMath::Abs(par0[4]+par1[4])&gt;kMaxDelta[4]) isPair=kFALSE; //delta 1/pt opposite sign</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :       if (!isPair) continue;</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :       TString filename(AliAnalysisManager::GetAnalysisManager()-&gt;GetTree()-&gt;GetCurrentFile()-&gt;GetName());</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :       Int_t eventNumber = event-&gt;GetEventNumberInFile(); </span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :       Bool_t hasFriend=(esdFriend) ? track0-&gt;GetFriendTrack() : 0;//( esdFriend-&gt;GetTrack(itrack0)!=0):0; </span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :       Bool_t hasITS=(track0-&gt;GetNcls(0)+track1-&gt;GetNcls(0)&gt;4);</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :       printf(&quot;DUMPHPTCosmic:%s|%f|%d|%d|%d\n&quot;,filename.Data(),(TMath::Min(track0-&gt;Pt(),track1-&gt;Pt())), eventNumber,hasFriend,hasITS);</span>
<span class="lineNum">    1062 </span>            : 
<span class="lineNum">    1063 </span>            : 
<span class="lineNum">    1064 </span>            :       //      const AliExternalTrackParam * trackIn1 = track1-&gt;GetInnerParam();      
<span class="lineNum">    1065 </span>            :       //
<span class="lineNum">    1066 </span>            :       //       
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :       TTreeSRedirector * pcstream =  GetDebugStreamer();</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :       Int_t ntracksSPD = vertexSPD-&gt;GetNContributors();</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :       Int_t ntracksTPC = vertexTPC-&gt;GetNContributors();</span>
<span class="lineNum">    1070 </span>            :       //
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :       AliESDfriendTrack *friendTrack0 = (AliESDfriendTrack*)track0-&gt;GetFriendTrack();//esdFriend-&gt;GetTrack(itrack0);</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :       if (!friendTrack0) continue;</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :       AliESDfriendTrack *friendTrack1 = (AliESDfriendTrack*)track1-&gt;GetFriendTrack();//esdFriend-&gt;GetTrack(itrack1);</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :       if (!friendTrack1) continue;</span>
<span class="lineNum">    1075 </span>            :       TObject *calibObject;
<span class="lineNum">    1076 </span>            :       AliTPCseed *seed0 = 0;   
<span class="lineNum">    1077 </span>            :       AliTPCseed *seed1 = 0;
<span class="lineNum">    1078 </span>            :       //
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :       for (Int_t l=0;(calibObject=friendTrack0-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :         if ((seed0=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1081 </span>            :       }
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :       for (Int_t l=0;(calibObject=friendTrack1-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :         if ((seed1=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1084 </span>            :       }
<span class="lineNum">    1085 </span>            :       //
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :       if (pcstream){</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :         (*pcstream)&lt;&lt;&quot;pairs&quot;&lt;&lt;</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :           &quot;run=&quot;&lt;&lt;fRun&lt;&lt;              //  run number</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :           &quot;event=&quot;&lt;&lt;fEvent&lt;&lt;          //  event number</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :           &quot;time=&quot;&lt;&lt;fTime&lt;&lt;            //  time stamp of event</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :           &quot;trigger=&quot;&lt;&lt;fTrigger&lt;&lt;      //  trigger</span>
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :           &quot;triggerClass=&quot;&lt;&lt;&amp;fTriggerClass&lt;&lt;      //  trigger</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :           &quot;mag=&quot;&lt;&lt;fMagF&lt;&lt;             //  magnetic field</span>
<span class="lineNum">    1094 </span>            :           //
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :           &quot;nSPD=&quot;&lt;&lt;ntracksSPD&lt;&lt;</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :           &quot;nTPC=&quot;&lt;&lt;ntracksTPC&lt;&lt;</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :           &quot;vSPD.=&quot;&lt;&lt;vertexSPD&lt;&lt;         //primary vertex -SPD</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :           &quot;vTPC.=&quot;&lt;&lt;vertexTPC&lt;&lt;         //primary vertex -TPC</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :           &quot;t0.=&quot;&lt;&lt;track0&lt;&lt;              //track0</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :           &quot;t1.=&quot;&lt;&lt;track1&lt;&lt;              //track1</span>
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :           &quot;ft0.=&quot;&lt;&lt;friendTrack0&lt;&lt;       //track0</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :           &quot;ft1.=&quot;&lt;&lt;friendTrack1&lt;&lt;       //track1</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :           &quot;s0.=&quot;&lt;&lt;seed0&lt;&lt;               //track0</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :           &quot;s1.=&quot;&lt;&lt;seed1&lt;&lt;               //track1</span>
<span class="lineNum">    1105 </span>            :           &quot;\n&quot;;      
<span class="lineNum">    1106 </span>            :       }
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :       if (!fCosmicTree) {</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :         fCosmicTree = new TTree(&quot;pairs&quot;,&quot;pairs&quot;);</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;SetDirectory(0);</span>
<span class="lineNum">    1110 </span>            :       }
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :       if (fCosmicTree-&gt;GetEntries()==0){</span>
<span class="lineNum">    1112 </span>            :         //
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;SetDirectory(0);</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;Branch(&quot;t0.&quot;,&amp;track0);</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;Branch(&quot;t1.&quot;,&amp;track1);</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;Branch(&quot;ft0.&quot;,&amp;friendTrack0);</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;Branch(&quot;ft1.&quot;,&amp;friendTrack1);</span>
<span class="lineNum">    1118 </span>            :       }else{
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;SetBranchAddress(&quot;t0.&quot;,&amp;track0);  </span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;SetBranchAddress(&quot;t1.&quot;,&amp;track1);</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;SetBranchAddress(&quot;ft0.&quot;,&amp;friendTrack0);   </span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :         fCosmicTree-&gt;SetBranchAddress(&quot;ft1.&quot;,&amp;friendTrack1);</span>
<span class="lineNum">    1123 </span>            :       }
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :       fCosmicTree-&gt;Fill();</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 : }</span>
<a name="1128"><span class="lineNum">    1128 </span>            : </a>
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span>            : void  AliTPCcalibCosmic::Terminate(){
<span class="lineNum">    1131 </span>            :   //
<span class="lineNum">    1132 </span>            :   // copy the cosmic tree to memory resident tree
<span class="lineNum">    1133 </span>            :   //
<span class="lineNum">    1134 </span>            :   static Int_t counter=0;
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :   printf(&quot;AliTPCcalibCosmic::Terminate\t%d\n&quot;,counter);</span>
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :   counter++;</span>
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :   AliTPCcalibBase::Terminate();</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 : }</span>
<a name="1139"><span class="lineNum">    1139 </span>            : </a>
<span class="lineNum">    1140 </span>            : 
<span class="lineNum">    1141 </span>            : void AliTPCcalibCosmic::AddTree(TTree* treeOutput, TTree * treeInput){
<span class="lineNum">    1142 </span>            :   //
<span class="lineNum">    1143 </span>            :   // Add the content of tree: 
<span class="lineNum">    1144 </span>            :   // Notice automatic copy of tree in ROOT does not work for such complicated tree
<span class="lineNum">    1145 </span>            :   //  
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :   return;</span>
<span class="lineNum">    1147 </span>            :   //if (TMath::Abs(fMagF)&lt;0.1) return; // work around - otherwise crashes 
<span class="lineNum">    1148 </span>            :   AliESDtrack *track0=new AliESDtrack;
<span class="lineNum">    1149 </span>            :   AliESDtrack *track1=new AliESDtrack;
<span class="lineNum">    1150 </span>            :   AliESDfriendTrack *ftrack0=new AliESDfriendTrack;
<span class="lineNum">    1151 </span>            :   AliESDfriendTrack *ftrack1=new AliESDfriendTrack;
<span class="lineNum">    1152 </span>            :   treeInput-&gt;SetBranchAddress(&quot;t0.&quot;,&amp;track0);  
<span class="lineNum">    1153 </span>            :   treeInput-&gt;SetBranchAddress(&quot;t1.&quot;,&amp;track1);
<span class="lineNum">    1154 </span>            :   treeInput-&gt;SetBranchAddress(&quot;ft0.&quot;,&amp;ftrack0);        
<span class="lineNum">    1155 </span>            :   treeInput-&gt;SetBranchAddress(&quot;ft1.&quot;,&amp;ftrack1);
<span class="lineNum">    1156 </span>            :   treeOutput-&gt;SetDirectory(0);
<span class="lineNum">    1157 </span>            :   //
<span class="lineNum">    1158 </span>            :   Int_t entries= treeInput-&gt;GetEntries();
<span class="lineNum">    1159 </span>            :   Int_t step=1+Int_t(TMath::Log(1+treeOutput-&gt;GetEntries()/10.));
<span class="lineNum">    1160 </span>            :   for (Int_t i=0; i&lt;entries; i+=step){
<span class="lineNum">    1161 </span>            :     treeInput-&gt;SetBranchAddress(&quot;t0.&quot;,&amp;track0);        
<span class="lineNum">    1162 </span>            :     treeInput-&gt;SetBranchAddress(&quot;t1.&quot;,&amp;track1);
<span class="lineNum">    1163 </span>            :     treeInput-&gt;SetBranchAddress(&quot;ft0.&quot;,&amp;ftrack0);      
<span class="lineNum">    1164 </span>            :     treeInput-&gt;SetBranchAddress(&quot;ft1.&quot;,&amp;ftrack1);
<span class="lineNum">    1165 </span>            :     treeInput-&gt;GetEntry(i);
<span class="lineNum">    1166 </span>            :     if (!track0) continue;
<span class="lineNum">    1167 </span>            :     if (!track1) continue;
<span class="lineNum">    1168 </span>            :     if (!ftrack0) continue;
<span class="lineNum">    1169 </span>            :     if (!ftrack1) continue;
<span class="lineNum">    1170 </span>            :     if (track0-&gt;GetTPCncls()&lt;=0) continue;
<span class="lineNum">    1171 </span>            :     if (track1-&gt;GetTPCncls()&lt;=0) continue;
<span class="lineNum">    1172 </span>            :     if (!track0-&gt;GetInnerParam()) continue;
<span class="lineNum">    1173 </span>            :     if (!track1-&gt;GetInnerParam()) continue;
<span class="lineNum">    1174 </span>            :     if (!track0-&gt;GetTPCInnerParam()) continue;
<span class="lineNum">    1175 </span>            :     if (!track1-&gt;GetTPCInnerParam()) continue;
<span class="lineNum">    1176 </span>            :     //track0
<span class="lineNum">    1177 </span>            :     treeOutput-&gt;SetBranchAddress(&quot;t0.&quot;,&amp;track0);       
<span class="lineNum">    1178 </span>            :     treeOutput-&gt;SetBranchAddress(&quot;t1.&quot;,&amp;track1);
<span class="lineNum">    1179 </span>            :     treeOutput-&gt;SetBranchAddress(&quot;ft0.&quot;,&amp;ftrack0);     
<span class="lineNum">    1180 </span>            :     treeOutput-&gt;SetBranchAddress(&quot;ft1.&quot;,&amp;ftrack1);    
<span class="lineNum">    1181 </span>            :     treeOutput-&gt;Fill();
<span class="lineNum">    1182 </span>            :     delete track0;
<span class="lineNum">    1183 </span>            :     delete track1;
<span class="lineNum">    1184 </span>            :     delete ftrack0;
<span class="lineNum">    1185 </span>            :     delete ftrack1;
<span class="lineNum">    1186 </span>            :     track0=0;
<span class="lineNum">    1187 </span>            :     track1=0;
<span class="lineNum">    1188 </span>            :     ftrack0=0;
<span class="lineNum">    1189 </span>            :     ftrack1=0;
<span class="lineNum">    1190 </span>            :   }
<span class="lineNum">    1191 </span>            : }
<span class="lineNum">    1192 </span>            : 
<a name="1193"><span class="lineNum">    1193 </span>            : </a>
<span class="lineNum">    1194 </span>            : 
<span class="lineNum">    1195 </span>            : void AliTPCcalibCosmic::MakeFitTree(TTree * treeInput, TTreeSRedirector *pcstream, const TObjArray * corrArray, Int_t step, Int_t run){
<span class="lineNum">    1196 </span>            :   //
<span class="lineNum">    1197 </span>            :   // Make fit tree
<span class="lineNum">    1198 </span>            :   // refit the tracks with original points + corrected points for each correction
<span class="lineNum">    1199 </span>            :   // Input:
<span class="lineNum">    1200 </span>            :   //   treeInput - tree with cosmic tracks
<span class="lineNum">    1201 </span>            :   //   pcstream  - debug output
<span class="lineNum">    1202 </span>            : 
<span class="lineNum">    1203 </span>            :   // Algorithm:
<span class="lineNum">    1204 </span>            :   // Loop over pair of cosmic tracks:
<span class="lineNum">    1205 </span>            :   //   1. Find trigger offset between cosmic event and &quot;physic&quot; trigger
<span class="lineNum">    1206 </span>            :   //   2. Refit tracks with current transformation
<span class="lineNum">    1207 </span>            :   //   3. Refit tracks using additional &quot;primitive&quot; distortion on top
<span class="lineNum">    1208 </span>            :   // Best correction estimated as linear combination of corrections 
<span class="lineNum">    1209 </span>            :   // minimizing the observed distortions
<span class="lineNum">    1210 </span>            :   // Observed distortions - matching in the y,z, snp, theta and 1/pt
<span class="lineNum">    1211 </span>            :   //
<span class="lineNum">    1212 </span>            :   const Double_t kResetCov=20.;
<span class="lineNum">    1213 </span>            :   const Double_t kMaxDelta[5]={1,40,0.03,0.01,0.2};
<span class="lineNum">    1214 </span>            :   const Double_t kSigma=2.;    
<span class="lineNum">    1215 </span>            :   const Double_t kMaxTime=1050;
<span class="lineNum">    1216 </span>            :   const Double_t kMaxSnp=0.8;
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :   Int_t ncorr=corrArray-&gt;GetEntries();</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :   AliTPCTransform *transform = AliTPCcalibDB::Instance()-&gt;GetTransform() ;</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :   AliTPCParam     *param     = AliTPCcalibDB::Instance()-&gt;GetParameters();</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :   AliGRPObject*  grp = AliTPCcalibDB::Instance()-&gt;GetGRP(run);</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :   Double_t time=0.5*(grp-&gt;GetTimeStart() +grp-&gt;GetTimeEnd()); </span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentRun(run);</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentTimeStamp(TMath::Nint(time));</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :   Double_t covar[15];</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;15;i++) covar[i]=0;</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :   covar[0]=kSigma*kSigma;</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :   covar[2]=kSigma*kSigma;</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :   covar[5]=kSigma*kSigma/Float_t(150*150);</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :   covar[9]=kSigma*kSigma/Float_t(150*150);</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :   covar[14]=0.2*0.2;</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :   Double_t *distortions = new Double_t[ncorr+1];</span>
<span class="lineNum">    1232 </span>            : 
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :   AliESDtrack *track0=new AliESDtrack;</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :   AliESDtrack *track1=new AliESDtrack;</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :   AliESDfriendTrack *ftrack0=new AliESDfriendTrack;</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :   AliESDfriendTrack *ftrack1=new AliESDfriendTrack;</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :   treeInput-&gt;SetBranchAddress(&quot;t0.&quot;,&amp;track0);  </span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :   treeInput-&gt;SetBranchAddress(&quot;t1.&quot;,&amp;track1);</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :   treeInput-&gt;SetBranchAddress(&quot;ft0.&quot;,&amp;ftrack0);        </span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :   treeInput-&gt;SetBranchAddress(&quot;ft1.&quot;,&amp;ftrack1);</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :   Int_t entries= treeInput-&gt;GetEntries();</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;entries; i+=step){    </span>
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :     treeInput-&gt;GetEntry(i);</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :     if (i%20==0) printf(&quot;%d\n&quot;,i);</span>
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :     if (!ftrack0-&gt;GetTPCOut()) continue;</span>
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :     if (!ftrack1-&gt;GetTPCOut()) continue;</span>
<span class="lineNum">    1247 </span>            :     AliTPCseed *seed0=0;
<span class="lineNum">    1248 </span>            :     AliTPCseed *seed1=0;
<span class="lineNum">    1249 </span>            :     TObject *calibObject;
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :     for (Int_t l=0;(calibObject=ftrack0-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :       if ((seed0=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1252 </span>            :     }
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :     for (Int_t l=0;(calibObject=ftrack1-&gt;GetCalibObject(l));++l) {</span>
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :       if ((seed1=dynamic_cast&lt;AliTPCseed*&gt;(calibObject))) break;</span>
<span class="lineNum">    1255 </span>            :     }
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :     if (!seed0) continue;</span>
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :     if (!seed1) continue;</span>
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :     if (TMath::Abs(seed0-&gt;GetSnp())&gt;kMaxSnp) continue;</span>
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :     if (TMath::Abs(seed1-&gt;GetSnp())&gt;kMaxSnp) continue;</span>
<span class="lineNum">    1260 </span>            :     //
<span class="lineNum">    1261 </span>            :     //
<span class="lineNum">    1262 </span>            :     Int_t nclA0=0, nclC0=0;     // number of clusters
<span class="lineNum">    1263 </span>            :     Int_t nclA1=0, nclC1=0;     // number of clusters
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :     Int_t ncl0=0,ncl1=0;</span>
<span class="lineNum">    1265 </span>            :     Double_t rmin0=300, rmax0=-300;  // variables to estimate the time0 - trigger offset
<span class="lineNum">    1266 </span>            :     Double_t rmin1=300, rmax1=-300;
<span class="lineNum">    1267 </span>            :     Double_t tmin0=2000, tmax0=-2000;
<span class="lineNum">    1268 </span>            :     Double_t tmin1=2000, tmax1=-2000;
<span class="lineNum">    1269 </span>            :     //
<span class="lineNum">    1270 </span>            :     //
<span class="lineNum">    1271 </span>            :     // calculate trigger offset usig &quot;missing clusters&quot;
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 :     for (Int_t irow=0; irow&lt;kMaxRow; irow++){</span>
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :       AliTPCclusterMI *cluster0=seed0-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :       if (cluster0 &amp;&amp;cluster0-&gt;GetX()&gt;10){</span>
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :         if (cluster0-&gt;GetX()&lt;rmin0) { rmin0=cluster0-&gt;GetX(); tmin0=cluster0-&gt;GetTimeBin();}</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :         if (cluster0-&gt;GetX()&gt;rmax0) { rmax0=cluster0-&gt;GetX(); tmax0=cluster0-&gt;GetTimeBin();}</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :         ncl0++;</span>
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :         if (cluster0-&gt;GetDetector()%36&lt;18) nclA0++;</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :         if (cluster0-&gt;GetDetector()%36&gt;=18) nclC0++;</span>
<span class="lineNum">    1280 </span>            :       }  
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :       AliTPCclusterMI *cluster1=seed1-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :       if (cluster1&amp;&amp;cluster1-&gt;GetX()&gt;10){</span>
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :         if (cluster1-&gt;GetX()&lt;rmin1) { rmin1=cluster1-&gt;GetX();  tmin1=cluster1-&gt;GetTimeBin();}</span>
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :         if (cluster1-&gt;GetX()&gt;rmax1) { rmax1=cluster1-&gt;GetX(); tmax1=cluster1-&gt;GetTimeBin();}</span>
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 :         ncl1++;</span>
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :         if (cluster1-&gt;GetDetector()%36&lt;18) nclA1++;</span>
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :         if (cluster1-&gt;GetDetector()%36&gt;=18) nclC1++;</span>
<span class="lineNum">    1288 </span>            :       }
<span class="lineNum">    1289 </span>            :     }
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :     Int_t cosmicType=0;  // types of cosmic topology</span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :     if ((nclA0&gt;nclC0) &amp;&amp; (nclA1&gt;nclC1)) cosmicType=0; // AA side</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :     if ((nclA0&lt;nclC0) &amp;&amp; (nclA1&lt;nclC1)) cosmicType=1; // CC side</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :     if ((nclA0&gt;nclC0) &amp;&amp; (nclA1&lt;nclC1)) cosmicType=2; // AC side</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :     if ((nclA0&lt;nclC0) &amp;&amp; (nclA1&gt;nclC1)) cosmicType=3; // CA side</span>
<span class="lineNum">    1295 </span>            :     //if ((nclA0&gt;nclC0) &amp;&amp; (nclA1&lt;nclC1)) cosmicType=6; // AC side out of time
<span class="lineNum">    1296 </span>            :     //if ((nclA0&gt;nclC0) &amp;&amp; (nclA1&lt;nclC1)) cosmicType=7; // CA side out of time
<span class="lineNum">    1297 </span>            :     //
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :     Double_t deltaTime = 0;   // correction for trigger not in time - equalizing the time arival</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :     if ((cosmicType&gt;1)&amp;&amp;TMath::Abs(track1-&gt;GetZ()-track0-&gt;GetZ())&gt;4){</span>
<span class="lineNum">    1300 </span><span class="lineNoCov">          0 :       cosmicType+=4;</span>
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :       deltaTime=0.5*(track1-&gt;GetZ()-track0-&gt;GetZ())/param-&gt;GetZWidth();</span>
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :       if (nclA0&gt;nclC0) deltaTime*=-1; // if A side track</span>
<span class="lineNum">    1303 </span>            :     }
<span class="lineNum">    1304 </span>            :     //
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 :     TVectorD vectorDT(8);</span>
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :     Int_t crossCounter=0;</span>
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :     Double_t deltaTimeCross = AliTPCcalibCosmic::GetDeltaTime(rmin0, rmax0, rmin1, rmax1, tmin0, tmax0, tmin1, tmax1, TMath::Abs(track0-&gt;GetY()),vectorDT);</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :     Bool_t isOKTrigger=kTRUE;</span>
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :     for (Int_t ic=0; ic&lt;6;ic++) {</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :       if (TMath::Abs(vectorDT[ic])&gt;0) {</span>
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :         if (vectorDT[ic]+vectorDT[6]&lt;0) isOKTrigger=kFALSE;</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :         if (vectorDT[ic]+vectorDT[7]&gt;kMaxTime) isOKTrigger=kFALSE;</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :         if (isOKTrigger){</span>
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :           crossCounter++; </span>
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1316 </span>            :       }
<span class="lineNum">    1317 </span>            :     }
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 :     Double_t deltaTimeCluster=deltaTime;</span>
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :     if ((cosmicType==0 || cosmicType==1) &amp;&amp; crossCounter&gt;0){</span>
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :       deltaTimeCluster=deltaTimeCross;</span>
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :       cosmicType+=8;</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :     if (nclA0*nclC0&gt;0 || nclA1*nclC1&gt;0) cosmicType+=16;  // mixed A side C side - bad for visualization</span>
<span class="lineNum">    1324 </span>            :     //
<span class="lineNum">    1325 </span>            :     // Apply current transformation
<span class="lineNum">    1326 </span>            :     //
<span class="lineNum">    1327 </span>            :     //
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :     for (Int_t irow=0; irow&lt;kMaxRow; irow++){</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :       AliTPCclusterMI *cluster0=seed0-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :       if (cluster0 &amp;&amp;cluster0-&gt;GetX()&gt;10){</span>
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :         Double_t x0[3]={ static_cast&lt;Double_t&gt;(cluster0-&gt;GetRow()),cluster0-&gt;GetPad(),cluster0-&gt;GetTimeBin()+deltaTimeCluster};</span>
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :         Int_t index0[1]={cluster0-&gt;GetDetector()};</span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :         transform-&gt;Transform(x0,index0,0,1);  </span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :         cluster0-&gt;SetX(x0[0]);</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :         cluster0-&gt;SetY(x0[1]);</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :         cluster0-&gt;SetZ(x0[2]);</span>
<span class="lineNum">    1337 </span>            :         //
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :       AliTPCclusterMI *cluster1=seed1-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :       if (cluster1&amp;&amp;cluster1-&gt;GetX()&gt;10){</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :         Double_t x1[3]={ static_cast&lt;Double_t&gt;(cluster1-&gt;GetRow()),cluster1-&gt;GetPad(),cluster1-&gt;GetTimeBin()+deltaTimeCluster};</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :         Int_t index1[1]={cluster1-&gt;GetDetector()};</span>
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :         transform-&gt;Transform(x1,index1,0,1);  </span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :         cluster1-&gt;SetX(x1[0]);</span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :         cluster1-&gt;SetY(x1[1]);</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :         cluster1-&gt;SetZ(x1[2]);</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1348 </span>            :     }
<span class="lineNum">    1349 </span>            :     //
<span class="lineNum">    1350 </span>            :     //
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :     Double_t alpha=track0-&gt;GetAlpha();   // rotation frame</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :     Double_t cos = TMath::Cos(alpha);</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :     Double_t sin = TMath::Sin(alpha);</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :     Double_t mass =  TDatabasePDG::Instance()-&gt;GetParticle(&quot;mu+&quot;)-&gt;Mass();</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :     AliExternalTrackParam  btrack0=*(ftrack0-&gt;GetTPCOut());</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :     AliExternalTrackParam  btrack1=*(ftrack1-&gt;GetTPCOut());</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :     btrack0.Rotate(alpha);</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :     btrack1.Rotate(alpha);</span>
<span class="lineNum">    1359 </span>            :     // change the sign for track 1
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :     Double_t* par1=(Double_t*)btrack0.GetParameter();</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :     par1[3]*=-1;</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :     par1[4]*=-1;</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :     btrack0.AddCovariance(covar);</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :     btrack1.AddCovariance(covar);</span>
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :     btrack0.ResetCovariance(kResetCov);</span>
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :     btrack1.ResetCovariance(kResetCov);</span>
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :     Bool_t isOK=kTRUE;</span>
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :     Bool_t isOKT=kTRUE;</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :     TObjArray tracks0(ncorr+1);</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :     TObjArray tracks1(ncorr+1);</span>
<span class="lineNum">    1371 </span>            :     //    
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :     Double_t dEdx0Tot=seed0-&gt;CookdEdxAnalytical(0.02,0.6,kTRUE);</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :     Double_t dEdx1Tot=seed1-&gt;CookdEdxAnalytical(0.02,0.6,kTRUE);</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :     Double_t dEdx0Max=seed0-&gt;CookdEdxAnalytical(0.02,0.6,kFALSE);</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :     Double_t dEdx1Max=seed1-&gt;CookdEdxAnalytical(0.02,0.6,kFALSE);</span>
<span class="lineNum">    1376 </span>            :     //if (TMath::Abs((dEdx0Max+1)/(dEdx0Tot+1)-1.)&gt;0.1) isOK=kFALSE;
<span class="lineNum">    1377 </span>            :     //if (TMath::Abs((dEdx1Max+1)/(dEdx1Tot+1)-1.)&gt;0.1) isOK=kFALSE;
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :     ncl0=0; ncl1=0;</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :     for (Int_t icorr=-1; icorr&lt;ncorr; icorr++){</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :       AliExternalTrackParam  rtrack0=btrack0;</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :       AliExternalTrackParam  rtrack1=btrack1;</span>
<span class="lineNum">    1382 </span>            :       AliTPCCorrection *corr = 0;
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :       if (icorr&gt;=0) corr = (AliTPCCorrection*)corrArray-&gt;At(icorr);</span>
<span class="lineNum">    1384 </span>            :       //
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :       for (Int_t irow=kMaxRow; irow--;){ </span>
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :         AliTPCclusterMI *cluster=seed0-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :         if (!cluster) continue;</span>
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :         if (!isOKT) break;</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :         Double_t rD[3]={cluster-&gt;GetX(),cluster-&gt;GetY(),cluster-&gt;GetZ()};</span>
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :         transform-&gt;RotatedGlobal2Global(cluster-&gt;GetDetector()%36,rD);  // transform to global</span>
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :         Float_t  r[3]={static_cast&lt;Float_t&gt;(rD[0]),static_cast&lt;Float_t&gt;(rD[1]),static_cast&lt;Float_t&gt;(rD[2])};</span>
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :         if (corr){</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :           corr-&gt;DistortPoint(r, cluster-&gt;GetDetector());</span>
<span class="lineNum">    1394 </span>            :         }
<span class="lineNum">    1395 </span>            :         //
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :         Double_t cov[3]={0.01,0.,0.01}; </span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :         Double_t lx =cos*r[0]+sin*r[1];      </span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :         Double_t ly =-sin*r[0]+cos*r[1];</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :         rD[1]=ly; rD[0]=lx; rD[2]=r[2];  //transform to track local</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :         if (!AliTracker::PropagateTrackToBxByBz(&amp;rtrack0, lx,mass,1.,kFALSE)) isOKT=kFALSE;;</span>
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :         if (!rtrack0.Update(&amp;rD[1],cov)) isOKT =kFALSE;</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :         if (icorr&lt;0) ncl0++;</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1404 </span>            :       //
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :       for (Int_t irow=kMaxRow; irow--;){ </span>
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :         AliTPCclusterMI *cluster=seed1-&gt;GetClusterPointer(irow);</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :         if (!cluster) continue;</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :         if (!isOKT) break;</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :         Double_t rD[3]={cluster-&gt;GetX(),cluster-&gt;GetY(),cluster-&gt;GetZ()};</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :         transform-&gt;RotatedGlobal2Global(cluster-&gt;GetDetector()%36,rD);</span>
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :         Float_t  r[3]={static_cast&lt;Float_t&gt;(rD[0]),static_cast&lt;Float_t&gt;(rD[1]),static_cast&lt;Float_t&gt;(rD[2])};</span>
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :         if (corr){</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :           corr-&gt;DistortPoint(r, cluster-&gt;GetDetector());</span>
<span class="lineNum">    1414 </span>            :         }
<span class="lineNum">    1415 </span>            :         //
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :         Double_t cov[3]={0.01,0.,0.01}; </span>
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :         Double_t lx =cos*r[0]+sin*r[1];      </span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :         Double_t ly =-sin*r[0]+cos*r[1];</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :         rD[1]=ly; rD[0]=lx; rD[2]=r[2];</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :         if (!AliTracker::PropagateTrackToBxByBz(&amp;rtrack1, lx,mass,1.,kFALSE)) isOKT=kFALSE;</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :         if (!rtrack1.Update(&amp;rD[1],cov)) isOKT=kFALSE;</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :         if (icorr&lt;0) ncl1++;</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :       if (!AliTracker::PropagateTrackToBxByBz(&amp;rtrack0, 0,mass,10.,kFALSE)) isOKT=kFALSE;</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :       if (!AliTracker::PropagateTrackToBxByBz(&amp;rtrack1, 0,mass,10.,kFALSE)) isOKT=kFALSE;</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :       if (!AliTracker::PropagateTrackToBxByBz(&amp;rtrack0, 0,mass,1.,kFALSE))  isOKT=kFALSE;</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :       if (!AliTracker::PropagateTrackToBxByBz(&amp;rtrack1, 0,mass,1.,kFALSE))  isOKT=kFALSE;</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :       const Double_t *param0=rtrack0.GetParameter();</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :       const Double_t *param1=rtrack1.GetParameter();</span>
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 :       for (Int_t ipar=0; ipar&lt;4; ipar++){</span>
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :         if (TMath::Abs(param1[ipar]-param0[ipar])&gt;kMaxDelta[ipar]) isOK=kFALSE;</span>
<span class="lineNum">    1432 </span>            :       }
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :       tracks0.AddAt(rtrack0.Clone(), icorr+1);</span>
<span class="lineNum">    1434 </span><span class="lineNoCov">          0 :       tracks1.AddAt(rtrack1.Clone(), icorr+1);</span>
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :       AliExternalTrackParam out0=*(ftrack0-&gt;GetTPCOut());</span>
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :       AliExternalTrackParam out1=*(ftrack1-&gt;GetTPCOut());</span>
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :       Int_t nentries=TMath::Min(ncl0,ncl1);</span>
<span class="lineNum">    1438 </span>            : 
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :       if (icorr&lt;0) {</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :         (*pcstream)&lt;&lt;&quot;cosmic&quot;&lt;&lt;</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :           &quot;isOK=&quot;&lt;&lt;isOK&lt;&lt;              // correct all propagation update and also residuals</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :           &quot;isOKT=&quot;&lt;&lt;isOKT&lt;&lt;            // correct all propagation update</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :           &quot;isOKTrigger=&quot;&lt;&lt;isOKTrigger&lt;&lt; // correct? estimate of trigger offset</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :           &quot;id=&quot;&lt;&lt;cosmicType&lt;&lt;</span>
<span class="lineNum">    1445 </span>            :           //
<span class="lineNum">    1446 </span>            :           //
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :           &quot;cross=&quot;&lt;&lt;crossCounter&lt;&lt;</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :           &quot;vDT.=&quot;&lt;&lt;&amp;vectorDT&lt;&lt;</span>
<span class="lineNum">    1449 </span>            :           //
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :           &quot;dTime=&quot;&lt;&lt;deltaTime&lt;&lt;        // delta time using the A-c side cross</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :           &quot;dTimeCross=&quot;&lt;&lt;deltaTimeCross&lt;&lt; // delta time using missing clusters</span>
<span class="lineNum">    1452 </span>            :           //
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :           &quot;dEdx0Max=&quot;&lt;&lt;dEdx0Max&lt;&lt;</span>
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :           &quot;dEdx0Tot=&quot;&lt;&lt;dEdx0Tot&lt;&lt;</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :           &quot;dEdx1Max=&quot;&lt;&lt;dEdx1Max&lt;&lt;</span>
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :           &quot;dEdx1Tot=&quot;&lt;&lt;dEdx1Tot&lt;&lt;</span>
<span class="lineNum">    1457 </span>            :           //
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :           &quot;track0.=&quot;&lt;&lt;track0&lt;&lt;         // original track 0</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :           &quot;track1.=&quot;&lt;&lt;track1&lt;&lt;         // original track 1</span>
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :           &quot;out0.=&quot;&lt;&lt;&amp;out0&lt;&lt;             // outer track  0</span>
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :           &quot;out1.=&quot;&lt;&lt;&amp;out1&lt;&lt;             // outer track  1</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :           &quot;rtrack0.=&quot;&lt;&lt;&amp;rtrack0&lt;&lt;      // refitted track with current transform</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :           &quot;rtrack1.=&quot;&lt;&lt;&amp;rtrack1&lt;&lt;     //        </span>
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :           &quot;ncl0=&quot;&lt;&lt;ncl0&lt;&lt;</span>
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :           &quot;ncl1=&quot;&lt;&lt;ncl1&lt;&lt;</span>
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 :           &quot;entries=&quot;&lt;&lt;nentries&lt;&lt;       // number of clusters</span>
<span class="lineNum">    1467 </span>            :           &quot;\n&quot;;
<span class="lineNum">    1468 </span>            :       }
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1470 </span>            :     //
<span class="lineNum">    1471 </span>            : 
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :     if (isOK){        </span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :       Int_t nentries=TMath::Min(ncl0,ncl1);    </span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :       for (Int_t ipar=0; ipar&lt;5; ipar++){</span>
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :         for (Int_t icorr=-1; icorr&lt;ncorr; icorr++){</span>
<span class="lineNum">    1476 </span>            :           AliTPCCorrection *corr = 0;
<span class="lineNum">    1477 </span><span class="lineNoCov">          0 :           if (icorr&gt;=0) corr = (AliTPCCorrection*)corrArray-&gt;At(icorr);</span>
<span class="lineNum">    1478 </span>            :           //
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :           AliExternalTrackParam *param0=(AliExternalTrackParam *) tracks0.At(icorr+1);</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :           AliExternalTrackParam *param1=(AliExternalTrackParam *) tracks1.At(icorr+1);</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :           distortions[icorr+1]=param1-&gt;GetParameter()[ipar]-param0-&gt;GetParameter()[ipar];</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :           if (icorr&gt;=0){</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :             distortions[icorr+1]-=distortions[0];</span>
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    1485 </span>            :           //
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :           if (icorr&lt;0){</span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :             Double_t bz=AliTrackerBase::GetBz();</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :             Double_t gxyz[3];</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :             param0-&gt;GetXYZ(gxyz);</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :             Int_t dtype=20;</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :             Double_t theta=param0-&gt;GetParameter()[3];</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :             Double_t phi = alpha;</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :             Double_t snp = track0-&gt;GetInnerParam()-&gt;GetSnp();</span>
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 :             Double_t mean= distortions[0];</span>
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :             Int_t index = param0-&gt;GetIndex(ipar,ipar);</span>
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :             Double_t rms=TMath::Sqrt(param1-&gt;GetCovariance()[index]+param1-&gt;GetCovariance()[index]);</span>
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :             if (crossCounter&lt;1) rms*=1;</span>
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :             Double_t sector=9*phi/TMath::Pi();</span>
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :             Double_t dsec   = sector-TMath::Nint(sector+0.5);</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :             Double_t gx=gxyz[0],gy=gxyz[1],gz=gxyz[2];</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :             Double_t refX=TMath::Sqrt(gx*gx+gy*gy);</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :             Double_t dRrec=0;</span>
<span class="lineNum">    1503 </span>            :             //      Double_t pt=(param0-&gt;GetSigned1Pt()+param1-&gt;GetSigned1Pt())*0.5;
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :             Double_t pt=(param0-&gt;GetSigned1Pt()+param1-&gt;GetSigned1Pt())*0.5;</span>
<span class="lineNum">    1505 </span>            : 
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :             (*pcstream)&lt;&lt;&quot;fit&quot;&lt;&lt;  // dump valus for fit</span>
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :               &quot;run=&quot;&lt;&lt;run&lt;&lt;       //run number</span>
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :               &quot;bz=&quot;&lt;&lt;bz&lt;&lt;         // magnetic filed used</span>
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :               &quot;dtype=&quot;&lt;&lt;dtype&lt;&lt;   // detector match type 20</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :               &quot;ptype=&quot;&lt;&lt;ipar&lt;&lt;   // parameter type</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :               &quot;theta=&quot;&lt;&lt;theta&lt;&lt;   // theta</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :               &quot;phi=&quot;&lt;&lt;phi&lt;&lt;       // phi </span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :               &quot;snp=&quot;&lt;&lt;snp&lt;&lt;       // snp</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :               &quot;mean=&quot;&lt;&lt;mean&lt;&lt;     // mean dist value</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :               &quot;rms=&quot;&lt;&lt;rms&lt;&lt;       // rms</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :               &quot;sector=&quot;&lt;&lt;sector&lt;&lt;</span>
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :               &quot;dsec=&quot;&lt;&lt;dsec&lt;&lt;</span>
<span class="lineNum">    1518 </span>            :               //
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :               &quot;refX=&quot;&lt;&lt;refX&lt;&lt;      // reference radius</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :               &quot;gx=&quot;&lt;&lt;gx&lt;&lt;         // global position</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :               &quot;gy=&quot;&lt;&lt;gy&lt;&lt;         // global position</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :               &quot;gz=&quot;&lt;&lt;gz&lt;&lt;         // global position</span>
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :               &quot;dRrec=&quot;&lt;&lt;dRrec&lt;&lt;      // delta Radius in reconstruction</span>
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :               &quot;pt=&quot;&lt;&lt;pt&lt;&lt;            //1/pt</span>
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :               &quot;id=&quot;&lt;&lt;cosmicType&lt;&lt;     //type of the cosmic used      </span>
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :               &quot;entries=&quot;&lt;&lt;nentries;// number of entries in bin</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :             (*pcstream)&lt;&lt;&quot;cosmicDebug&quot;&lt;&lt;</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :               &quot;p0.=&quot;&lt;&lt;param0&lt;&lt;    // dump distorted track 0</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :               &quot;p1.=&quot;&lt;&lt;param1;    // dump distorted track 1</span>
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :           if (icorr&gt;=0){</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :             (*pcstream)&lt;&lt;&quot;fit&quot;&lt;&lt;</span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :               Form(&quot;%s=&quot;,corr-&gt;GetName())&lt;&lt;distortions[icorr+1];    // dump correction value</span>
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :             (*pcstream)&lt;&lt;&quot;cosmicDebug&quot;&lt;&lt;</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :               Form(&quot;%s=&quot;,corr-&gt;GetName())&lt;&lt;distortions[icorr+1]&lt;&lt;    // dump correction value</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :               Form(&quot;%sp0.=&quot;,corr-&gt;GetName())&lt;&lt;param0&lt;&lt;    // dump distorted track 0</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :               Form(&quot;%sp1.=&quot;,corr-&gt;GetName())&lt;&lt;param1;    // dump distorted track 1</span>
<span class="lineNum">    1538 </span>            :           }
<span class="lineNum">    1539 </span>            :         } //loop corrections      
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :         (*pcstream)&lt;&lt;&quot;fit&quot;&lt;&lt;&quot;isOK=&quot;&lt;&lt;isOK&lt;&lt;&quot;\n&quot;;</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :         (*pcstream)&lt;&lt;&quot;cosmicDebug&quot;&lt;&lt;&quot;isOK=&quot;&lt;&lt;isOK&lt;&lt;&quot;\n&quot;;</span>
<span class="lineNum">    1542 </span>            :       } //loop over parameters
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :     } // dump results</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :   }//loop tracks</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :   delete [] distortions;</span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1547 </span>            : 
<a name="1548"><span class="lineNum">    1548 </span>            : </a>
<span class="lineNum">    1549 </span>            : 
<span class="lineNum">    1550 </span>            : Double_t AliTPCcalibCosmic::GetDeltaTime(Double_t rmin0, Double_t rmax0, Double_t rmin1, Double_t rmax1, Double_t tmin0, Double_t tmax0, Double_t tmin1, Double_t tmax1, Double_t dcaR, TVectorD &amp;vectorDT)
<span class="lineNum">    1551 </span>            : {
<span class="lineNum">    1552 </span>            :   //
<span class="lineNum">    1553 </span>            :   // Estimate trigger offset between random cosmic event and &quot;physics&quot; trigger
<span class="lineNum">    1554 </span>            :   // Efficiency about 50 % of cases:
<span class="lineNum">    1555 </span>            :   // Cases:
<span class="lineNum">    1556 </span>            :   // 0. Tracks crossing A side and C side - no match in z - 30 % of cases
<span class="lineNum">    1557 </span>            :   // 1. Track only on one side and  dissapear at small or at high radiuses - 50 % of cases
<span class="lineNum">    1558 </span>            :   //    1.a) rmax&lt;Rc    &amp;&amp; tmax&lt;Tcmax &amp;&amp; tmax&gt;tmin    =&gt; deltaT=Tcmax-tmax 
<span class="lineNum">    1559 </span>            :   //    1.b) rmin&gt;Rcmin &amp;&amp; tmin&lt;Tcmax &amp;&amp; tmin&gt;tmax    =&gt; deltaT=Tcmax-tmin  
<span class="lineNum">    1560 </span>            :   //                      // case the z matching gives proper time
<span class="lineNum">    1561 </span>            :   //    1.c) rmax&lt;Rc    &amp;&amp; tmax&gt;Tcmin &amp;&amp; tmax&lt;tmin    =&gt; deltaT=-tmax
<span class="lineNum">    1562 </span>            :   //
<span class="lineNum">    1563 </span>            :   // check algorithm:
<span class="lineNum">    1564 </span>            :   //    TCut cutStop = &quot;(min(rmax0,rmax1)&lt;235||abs(rmin0-rmin1)&gt;10)&quot;; // tracks not registered for full time
<span class="lineNum">    1565 </span>            : 
<span class="lineNum">    1566 </span>            :   // Combinations:
<span class="lineNum">    1567 </span>            :   // 0-1 - forbidden
<span class="lineNum">    1568 </span>            :   // 0-2 - forbidden
<span class="lineNum">    1569 </span>            :   // 0-3 - occur - wrong correlation
<span class="lineNum">    1570 </span>            :   // 1-2 - occur - wrong correlation
<span class="lineNum">    1571 </span>            :   // 1-3 - forbidden
<span class="lineNum">    1572 </span>            :   // 2-3 - occur - small number of outlyers -20%
<span class="lineNum">    1573 </span>            :   // Frequency:
<span class="lineNum">    1574 </span>            :   //   0 - 106
<span class="lineNum">    1575 </span>            :   //   1 - 265
<span class="lineNum">    1576 </span>            :   //   2 - 206
<span class="lineNum">    1577 </span>            :   //   3 - 367
<span class="lineNum">    1578 </span>            :   //
<span class="lineNum">    1579 </span>            :   const Double_t kMaxRCut=235;  // max radius
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :   const Double_t kMinRCut=TMath::Max(dcaR,90.);  // min radius</span>
<span class="lineNum">    1581 </span>            :   const Double_t kMaxDCut=30;   // max distance for minimal radius
<span class="lineNum">    1582 </span>            :   const Double_t kMinTime=110;
<span class="lineNum">    1583 </span>            :   const Double_t kMaxTime=950;  
<span class="lineNum">    1584 </span>            :   Double_t deltaT=0;
<span class="lineNum">    1585 </span>            :   Int_t counter=0;
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :   vectorDT[6]=TMath::Min(TMath::Min(tmin0,tmin1),TMath::Min(tmax0,tmax1));</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :   vectorDT[7]=TMath::Max(TMath::Max(tmin0,tmin1),TMath::Max(tmax0,tmax1));</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :   if (TMath::Min(rmax0,rmax1)&lt;kMaxRCut){</span>
<span class="lineNum">    1589 </span>            :     // max cross - deltaT&gt;0
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :     if (rmax0&lt;kMaxRCut &amp;&amp; tmax0 &lt;kMaxTime &amp;&amp; tmax0&gt;tmin0) vectorDT[0]=kMaxTime-tmax0; // disapear at CE</span>
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :     if (rmax1&lt;kMaxRCut &amp;&amp; tmax1 &lt;kMaxTime &amp;&amp; tmax1&gt;tmin1) vectorDT[1]=kMaxTime-tmax1; // disapear at CE</span>
<span class="lineNum">    1592 </span>            :     // min cross - deltaT&lt;0 - OK they are correlated
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :     if (rmax0&lt;kMaxRCut &amp;&amp; tmax0 &gt;kMinTime &amp;&amp; tmax0&lt;tmin0) vectorDT[2]=-tmax0;         // disapear at ROC</span>
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :     if (rmax1&lt;kMaxRCut &amp;&amp; tmax1 &gt;kMinTime &amp;&amp; tmax1&lt;tmin1) vectorDT[3]=-tmax1;         // disapear at ROC</span>
<span class="lineNum">    1595 </span>            :   }  
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :   if (rmin0&gt; kMinRCut+kMaxDCut &amp;&amp; tmin0 &lt;kMaxTime &amp;&amp; tmin0&gt;tmax0) vectorDT[4]=kMaxTime-tmin0;</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :   if (rmin1&gt; kMinRCut+kMaxDCut &amp;&amp; tmin1 &lt;kMaxTime &amp;&amp; tmin1&gt;tmax1) vectorDT[5]=kMaxTime-tmin1;</span>
<span class="lineNum">    1598 </span>            :   Bool_t isOK=kTRUE;
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;6;i++) {</span>
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :     if (TMath::Abs(vectorDT[i])&gt;0) {</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :       counter++; </span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :       if (vectorDT[i]+vectorDT[6]&lt;0) isOK=kFALSE;</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :       if (vectorDT[i]+vectorDT[7]&gt;kMaxTime) isOK=kFALSE;</span>
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :       if (isOK) deltaT=vectorDT[i];</span>
<span class="lineNum">    1605 </span>            :     }
<span class="lineNum">    1606 </span>            :   }
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :   return deltaT;  </span>
<span class="lineNum">    1608 </span>            : }
<span class="lineNum">    1609 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
