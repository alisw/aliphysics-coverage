<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - TPC/TPCbase/AliTPCcalibDB.cxx</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">TPC/TPCbase</a> - AliTPCcalibDB.cxx<span style="font-size: 80%;"> (source / <a href="AliTPCcalibDB.cxx.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">384</td>
            <td class="headerCovTableEntry">1549</td>
            <td class="headerCovTableEntryLo">24.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-14 17:26:59</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">32</td>
            <td class="headerCovTableEntry">78</td>
            <td class="headerCovTableEntryLo">41.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**************************************************************************</a>
<span class="lineNum">       2 </span>            :  * Copyright(c) 1998-1999, ALICE Experiment at CERN, All rights reserved. *
<span class="lineNum">       3 </span>            :  *                                                                        *
<span class="lineNum">       4 </span>            :  * Author: The ALICE Off-line Project.                                    *
<span class="lineNum">       5 </span>            :  * Contributors are mentioned in the code where appropriate.              *
<span class="lineNum">       6 </span>            :  *                                                                        *
<span class="lineNum">       7 </span>            :  * Permission to use, copy, modify and distribute this software and its   *
<span class="lineNum">       8 </span>            :  * documentation strictly for non-commercial purposes is hereby granted   *
<span class="lineNum">       9 </span>            :  * without fee, provided that the above copyright notice appears in all   *
<span class="lineNum">      10 </span>            :  * copies and that both the copyright notice and this permission notice   *
<span class="lineNum">      11 </span>            :  * appear in the supporting documentation. The authors make no claims     *
<span class="lineNum">      12 </span>            :  * about the suitability of this software for any purpose. It is          *
<span class="lineNum">      13 </span>            :  * provided &quot;as is&quot; without express or implied warranty.                  *
<span class="lineNum">      14 </span>            :  **************************************************************************/
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : /// \class AliTPCcalibDB
<span class="lineNum">      17 </span>            : /// \brief Class providing the calibration parameters by accessing the CDB
<span class="lineNum">      18 </span>            : ///
<span class="lineNum">      19 </span>            : /// Request an instance with AliTPCcalibDB::Instance()
<span class="lineNum">      20 </span>            : /// If a new event is processed set the event number with SetRun
<span class="lineNum">      21 </span>            : /// Then request the calibration data
<span class="lineNum">      22 </span>            : ///
<span class="lineNum">      23 </span>            : /// Calibration data:
<span class="lineNum">      24 </span>            : /// 0.)  Altro mapping
<span class="lineNum">      25 </span>            : ///          Simulation      - not yet
<span class="lineNum">      26 </span>            : ///          Reconstruction  - AliTPCclusterer::Digits2Clusters(AliRawReader* rawReader)
<span class="lineNum">      27 </span>            : ///
<span class="lineNum">      28 </span>            : /// 1.)  pad by pad calibration -  AliTPCCalPad
<span class="lineNum">      29 </span>            : ///
<span class="lineNum">      30 </span>            : ///      a.) fPadGainFactor
<span class="lineNum">      31 </span>            : ///          Simulation: AliTPCDigitizer::ExecFast - Multiply by gain
<span class="lineNum">      32 </span>            : ///          Reconstruction : AliTPCclusterer::Digits2Clusters - Divide by gain
<span class="lineNum">      33 </span>            : ///
<span class="lineNum">      34 </span>            : ///      b.) fPadNoise -
<span class="lineNum">      35 </span>            : ///          Simulation:        AliTPCDigitizer::ExecFast
<span class="lineNum">      36 </span>            : ///          Reconstruction:    AliTPCclusterer::FindClusters(AliTPCCalROC * noiseROC)
<span class="lineNum">      37 </span>            : ///                             Noise depending cut on clusters charge (n sigma)
<span class="lineNum">      38 </span>            : ///      c.) fPedestal:
<span class="lineNum">      39 </span>            : ///          Simulation:     Not used yet - To be impleneted - Rounding to the nearest integer
<span class="lineNum">      40 </span>            : ///          Reconstruction: Used in AliTPCclusterer::Digits2Clusters(AliRawReader* rawReader)
<span class="lineNum">      41 </span>            : ///                          if data taken without zero suppression
<span class="lineNum">      42 </span>            : ///                          Currently switch in  fRecoParam-&gt;GetCalcPedestal();
<span class="lineNum">      43 </span>            : ///
<span class="lineNum">      44 </span>            : ///      d.) fPadTime0
<span class="lineNum">      45 </span>            : ///          Simulation:      applied in the AliTPC::MakeSector - adding offset
<span class="lineNum">      46 </span>            : ///          Reconstruction:  AliTPCTransform::Transform() - remove offset
<span class="lineNum">      47 </span>            : ///                           AliTPCTransform::Transform() - to be called
<span class="lineNum">      48 </span>            : ///                           in AliTPCtracker::Transform()
<span class="lineNum">      49 </span>            : ///
<span class="lineNum">      50 </span>            : /// 2.)  Space points transformation:
<span class="lineNum">      51 </span>            : ///
<span class="lineNum">      52 </span>            : ///      a.) General coordinate tranformation - AliTPCtransform (see $ALICE_ROOT/TPC/AliTPCtransform.cxx)
<span class="lineNum">      53 </span>            : ///          Created on fly - use the other calibration components
<span class="lineNum">      54 </span>            : ///                 Unisochronity  - (substract time0 - pad by pad)
<span class="lineNum">      55 </span>            : ///                 Drift velocity - Currently common drift velocity - functionality of AliTPCParam
<span class="lineNum">      56 </span>            : ///                 ExB effect
<span class="lineNum">      57 </span>            : ///          Simulation     - Not used directly (the effects are applied one by one (see AliTPC::MakeSector)
<span class="lineNum">      58 </span>            : ///          Reconstruction -
<span class="lineNum">      59 </span>            : ///                           AliTPCclusterer::AddCluster
<span class="lineNum">      60 </span>            : ///                           AliTPCtracker::Transform
<span class="lineNum">      61 </span>            : ///      b.) ExB effect calibration -
<span class="lineNum">      62 </span>            : ///             classes (base class AliTPCExB, implementation- AliTPCExBExact.h  AliTPCExBFirst.h)
<span class="lineNum">      63 </span>            : ///             a.a) Simulation:   applied in the AliTPC::MakeSector -
<span class="lineNum">      64 </span>            : ///                                calib-&gt;GetExB()-&gt;CorrectInverse(dxyz0,dxyz1);
<span class="lineNum">      65 </span>            : ///             a.b) Reconstruction -
<span class="lineNum">      66 </span>            : ///
<span class="lineNum">      67 </span>            : ///                  in AliTPCtransform::Correct() - called calib-&gt;GetExB()-&gt;Correct(dxyz0,dxyz1)
<span class="lineNum">      68 </span>            : ///
<span class="lineNum">      69 </span>            : ///  3.)   cluster error, shape and Q parameterization
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            : #include &lt;iostream&gt;
<span class="lineNum">      72 </span>            : #include &lt;fstream&gt;
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            : #include &lt;AliCDBManager.h&gt;
<span class="lineNum">      76 </span>            : #include &lt;AliCDBEntry.h&gt;
<span class="lineNum">      77 </span>            : #include &lt;AliCDBId.h&gt;
<span class="lineNum">      78 </span>            : #include &lt;AliLog.h&gt;
<span class="lineNum">      79 </span>            : #include &lt;AliMagF.h&gt;
<span class="lineNum">      80 </span>            : #include &lt;AliSplineFit.h&gt;
<span class="lineNum">      81 </span>            : #include &lt;AliCTPTimeParams.h&gt;
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            : #include &quot;TGraphErrors.h&quot;
<span class="lineNum">      84 </span>            : #include &quot;AliTPCcalibDB.h&quot;
<span class="lineNum">      85 </span>            : #include &quot;AliTPCdataQA.h&quot;
<span class="lineNum">      86 </span>            : #include &quot;AliTPCcalibDButil.h&quot;
<span class="lineNum">      87 </span>            : #include &quot;AliTPCAltroMapping.h&quot;
<span class="lineNum">      88 </span>            : #include &quot;AliTPCExB.h&quot;
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            : #include &quot;AliTPCCalROC.h&quot;
<span class="lineNum">      91 </span>            : #include &quot;AliTPCCalPad.h&quot;
<span class="lineNum">      92 </span>            : #include &quot;AliTPCSensorTempArray.h&quot;
<span class="lineNum">      93 </span>            : #include &quot;AliGRPObject.h&quot;
<span class="lineNum">      94 </span>            : #include &quot;AliTPCTransform.h&quot;
<span class="lineNum">      95 </span>            : #include &quot;AliTPCmapper.h&quot;
<span class="lineNum">      96 </span>            : #include &quot;AliTPCclusterMI.h&quot;
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            : class AliCDBStorage;
<span class="lineNum">      99 </span>            : class AliTPCCalDet;
<span class="lineNum">     100 </span>            : //
<span class="lineNum">     101 </span>            : //
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span>            : #include &quot;TFile.h&quot;
<span class="lineNum">     104 </span>            : #include &quot;TKey.h&quot;
<span class="lineNum">     105 </span>            : #include &quot;TGraphErrors.h&quot;
<span class="lineNum">     106 </span>            : #include &quot;TGeoGlobalMagField.h&quot;
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span>            : #include &quot;TObjArray.h&quot;
<span class="lineNum">     109 </span>            : #include &quot;TObjString.h&quot;
<span class="lineNum">     110 </span>            : #include &quot;TString.h&quot;
<span class="lineNum">     111 </span>            : #include &quot;TDirectory.h&quot;
<span class="lineNum">     112 </span>            : #include &quot;TArrayI.h&quot;
<span class="lineNum">     113 </span>            : #include &quot;AliTPCCalPad.h&quot;
<span class="lineNum">     114 </span>            : #include &quot;AliTPCCalibPulser.h&quot;
<span class="lineNum">     115 </span>            : #include &quot;AliTPCCalibPedestal.h&quot;
<span class="lineNum">     116 </span>            : #include &quot;AliTPCCalibCE.h&quot;
<span class="lineNum">     117 </span>            : #include &quot;AliTPCExBFirst.h&quot;
<span class="lineNum">     118 </span>            : #include &quot;AliTPCTempMap.h&quot;
<span class="lineNum">     119 </span>            : #include &quot;AliTPCCalibVdrift.h&quot;
<span class="lineNum">     120 </span>            : #include &quot;AliTPCCalibRaw.h&quot;
<span class="lineNum">     121 </span>            : #include &quot;AliTPCParam.h&quot;
<span class="lineNum">     122 </span>            : #include &quot;AliTPCCorrection.h&quot;
<span class="lineNum">     123 </span>            : #include &quot;AliTPCComposedCorrection.h&quot;
<span class="lineNum">     124 </span>            : #include &quot;AliTPCPreprocessorOnline.h&quot;
<span class="lineNum">     125 </span>            : #include &quot;AliTimeStamp.h&quot;
<span class="lineNum">     126 </span>            : #include &quot;AliTriggerRunScalers.h&quot;
<span class="lineNum">     127 </span>            : #include &quot;AliTriggerScalers.h&quot;
<span class="lineNum">     128 </span>            : #include &quot;AliTriggerScalersRecord.h&quot;
<span class="lineNum">     129 </span>            : #include &quot;AliDAQ.h&quot;
<a name="130"><span class="lineNum">     130 </span>            : #include &quot;AliTPCRecoParam.h&quot;</a>
<span class="lineNum">     131 </span>            : /// \cond CLASSIMP
<span class="lineNum">     132 </span><span class="lineCov">         24 : ClassImp(AliTPCcalibDB)</span>
<span class="lineNum">     133 </span>            : /// \endcond
<span class="lineNum">     134 </span>            : 
<a name="135"><span class="lineNum">     135 </span>            : AliTPCcalibDB* AliTPCcalibDB::fgInstance = 0;</a>
<span class="lineNum">     136 </span>            : Bool_t AliTPCcalibDB::fgTerminated = kFALSE;
<span class="lineNum">     137 </span><span class="lineCov">         24 : TObjArray    AliTPCcalibDB::fgExBArray;    ///&lt; array of ExB corrections</span>
<span class="lineNum">     138 </span>            : 
<a name="139"><span class="lineNum">     139 </span>            : </a>
<span class="lineNum">     140 </span>            : //_ singleton implementation __________________________________________________
<span class="lineNum">     141 </span>            : AliTPCcalibDB* AliTPCcalibDB::Instance()
<span class="lineNum">     142 </span>            : {
<span class="lineNum">     143 </span>            :   /// Singleton implementation
<span class="lineNum">     144 </span>            :   /// Returns an instance of this class, it is created if necessary
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span><span class="lineCov">    6494534 :   if (fgTerminated != kFALSE)</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span><span class="lineCov">    3247267 :   if (fgInstance == 0)</span>
<span class="lineNum">     150 </span><span class="lineCov">          6 :     fgInstance = new AliTPCcalibDB();</span>
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span><span class="lineCov">    3247267 :   return fgInstance;</span>
<a name="153"><span class="lineNum">     153 </span><span class="lineCov">    3247267 : }</span></a>
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span>            : void AliTPCcalibDB::Terminate()
<span class="lineNum">     156 </span>            : {
<span class="lineNum">     157 </span>            :   /// Singleton implementation
<span class="lineNum">     158 </span>            :   /// Deletes the instance of this class and sets the terminated flag, instances cannot be requested anymore
<span class="lineNum">     159 </span>            :   /// This function can be called several times.
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :   fgTerminated = kTRUE;</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :   if (fgInstance != 0)</span>
<span class="lineNum">     164 </span>            :   {
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     delete fgInstance;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :     fgInstance = 0;</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 : }</span>
<a name="169"><span class="lineNum">     169 </span>            : </a>
<span class="lineNum">     170 </span>            : //_____________________________________________________________________________
<span class="lineNum">     171 </span>            : AliTPCcalibDB::AliTPCcalibDB():
<span class="lineNum">     172 </span><span class="lineCov">          3 :   TObject(),</span>
<span class="lineNum">     173 </span><span class="lineCov">          3 :   fRun(-1),</span>
<span class="lineNum">     174 </span><span class="lineCov">          3 :   fTransform(0),</span>
<span class="lineNum">     175 </span><span class="lineCov">          3 :   fExB(0),</span>
<span class="lineNum">     176 </span><span class="lineCov">          3 :   fPadGainFactor(0),</span>
<span class="lineNum">     177 </span><span class="lineCov">          3 :   fActiveChannelMap(0),</span>
<span class="lineNum">     178 </span><span class="lineCov">          3 :   fDedxGainFactor(0),</span>
<span class="lineNum">     179 </span><span class="lineCov">          3 :   fPadTime0(0),</span>
<span class="lineNum">     180 </span><span class="lineCov">          3 :   fDistortionMap(0),</span>
<span class="lineNum">     181 </span><span class="lineCov">          3 :   fComposedCorrection(0),</span>
<span class="lineNum">     182 </span><span class="lineCov">          3 :   fComposedCorrectionArray(0),</span>
<span class="lineNum">     183 </span><span class="lineCov">          3 :   fCorrectionMaps(0),</span>
<span class="lineNum">     184 </span><span class="lineCov">          3 :   fPadNoise(0),</span>
<span class="lineNum">     185 </span><span class="lineCov">          3 :   fPedestals(0),</span>
<span class="lineNum">     186 </span><span class="lineCov">          3 :   fCalibRaw(0),</span>
<span class="lineNum">     187 </span><span class="lineCov">          3 :   fDataQA(0),</span>
<span class="lineNum">     188 </span><span class="lineCov">          3 :   fALTROConfigData(0),</span>
<span class="lineNum">     189 </span><span class="lineCov">          3 :   fIonTailArray(0),</span>
<span class="lineNum">     190 </span><span class="lineCov">          3 :   fPulserData(0),</span>
<span class="lineNum">     191 </span><span class="lineCov">          3 :   fCEData(0),</span>
<span class="lineNum">     192 </span><span class="lineCov">          3 :   fMaxTimeBinAllPads(-1),</span>
<span class="lineNum">     193 </span><span class="lineCov">          3 :   fHVsensors(),</span>
<span class="lineNum">     194 </span><span class="lineCov">          3 :   fGrRunState(0x0),</span>
<span class="lineNum">     195 </span><span class="lineCov">          3 :   fTemperature(0),</span>
<span class="lineNum">     196 </span><span class="lineCov">          3 :   fMapping(0),</span>
<span class="lineNum">     197 </span><span class="lineCov">          3 :   fParam(0),</span>
<span class="lineNum">     198 </span><span class="lineCov">          3 :   fClusterParam(0),</span>
<span class="lineNum">     199 </span><span class="lineCov">          3 :   fRecoParamList(0),</span>
<span class="lineNum">     200 </span><span class="lineCov">          3 :   fTimeGainSplines(0),</span>
<span class="lineNum">     201 </span><span class="lineCov">          3 :   fTimeGainSplinesArray(1),</span>
<span class="lineNum">     202 </span><span class="lineCov">          3 :   fGRPArray(1),            //! array of GRPs  -  per run  - JUST for calibration studies</span>
<span class="lineNum">     203 </span><span class="lineCov">          3 :   fGRPMaps(1),            //! array of GRPs  -  per run  - JUST for calibration studies</span>
<span class="lineNum">     204 </span><span class="lineCov">          3 :   fGoofieArray(1),         //! array of GOOFIE values -per run - Just for calibration studies</span>
<span class="lineNum">     205 </span><span class="lineCov">          3 :   fVoltageArray(1),</span>
<span class="lineNum">     206 </span><span class="lineCov">          3 :   fTemperatureArray(1),    //! array of temperature sensors - per run - Just for calibration studies</span>
<span class="lineNum">     207 </span><span class="lineCov">          3 :   fVdriftArray(1),                 //! array of v drift interfaces</span>
<span class="lineNum">     208 </span><span class="lineCov">          3 :   fDriftCorrectionArray(1),  //! array of drift correction</span>
<span class="lineNum">     209 </span><span class="lineCov">          3 :   fRunList(1),              //! run list - indicates try to get the run param</span>
<span class="lineNum">     210 </span><span class="lineCov">          3 :   fBHasAlignmentOCDB(kFALSE),    // Flag  - has the alignment on the composed correction ?</span>
<span class="lineNum">     211 </span><span class="lineCov">          3 :   fDButil(0),</span>
<span class="lineNum">     212 </span><span class="lineCov">          3 :   fCTPTimeParams(0),</span>
<span class="lineNum">     213 </span><span class="lineCov">          3 :   fMode(-1)</span>
<span class="lineNum">     214 </span><span class="lineCov">         15 : {</span>
<span class="lineNum">     215 </span>            :   /// constructor
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineCov">          3 :   fgInstance=this;</span>
<span class="lineNum">     218 </span><span class="lineCov">        438 :   for (Int_t i=0;i&lt;72;++i){</span>
<span class="lineNum">     219 </span><span class="lineCov">        216 :     fChamberHVStatus[i]=kTRUE;</span>
<span class="lineNum">     220 </span><span class="lineCov">        216 :     fChamberHVmedian[i]=-1;</span>
<span class="lineNum">     221 </span><span class="lineCov">        216 :     fCurrentNominalVoltage[i]=0.;</span>
<span class="lineNum">     222 </span><span class="lineCov">        216 :     fChamberHVgoodFraction[i]=0.;</span>
<span class="lineNum">     223 </span>            :   }
<span class="lineNum">     224 </span><span class="lineCov">          3 :   Update();    // temporary</span>
<span class="lineNum">     225 </span><span class="lineCov">          3 :   fTimeGainSplinesArray.SetOwner(); //own the keys</span>
<span class="lineNum">     226 </span><span class="lineCov">          3 :   fGRPArray.SetOwner(); //own the keys</span>
<span class="lineNum">     227 </span><span class="lineCov">          3 :   fGRPMaps.SetOwner(); //own the keys</span>
<span class="lineNum">     228 </span><span class="lineCov">          3 :   fGoofieArray.SetOwner(); //own the keys</span>
<span class="lineNum">     229 </span><span class="lineCov">          3 :   fVoltageArray.SetOwner(); //own the keys</span>
<span class="lineNum">     230 </span><span class="lineCov">          3 :   fTemperatureArray.SetOwner(); //own the keys</span>
<span class="lineNum">     231 </span><span class="lineCov">          3 :   fVdriftArray.SetOwner(); //own the keys</span>
<span class="lineNum">     232 </span><span class="lineCov">          3 :   fDriftCorrectionArray.SetOwner(); //own the keys</span>
<a name="233"><span class="lineNum">     233 </span><span class="lineCov">          6 : }</span></a>
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            : AliTPCcalibDB::AliTPCcalibDB(const AliTPCcalibDB&amp; ):
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :   TObject(),</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :   fRun(-1),</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :   fTransform(0),</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :   fExB(0),</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :   fPadGainFactor(0),</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :   fActiveChannelMap(0),</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :   fDedxGainFactor(0),</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :   fPadTime0(0),</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :   fDistortionMap(0),</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :   fComposedCorrection(0),</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :   fComposedCorrectionArray(0),</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :   fCorrectionMaps(0),</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :   fPadNoise(0),</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :   fPedestals(0),</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :   fCalibRaw(0),</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :   fDataQA(0),</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :   fALTROConfigData(0),</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :   fIonTailArray(0),</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :   fPulserData(0),</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :   fCEData(0),</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :   fMaxTimeBinAllPads(-1),</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :   fHVsensors(),</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :   fGrRunState(0x0),</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :   fTemperature(0),</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :   fMapping(0),</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :   fParam(0),</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :   fClusterParam(0),</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :   fRecoParamList(0),</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :   fTimeGainSplines(0),</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :   fTimeGainSplinesArray(1),</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :   fGRPArray(0),          //! array of GRPs  -  per run  - JUST for calibration studies</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :   fGRPMaps(0),          //! array of GRPs  -  per run  - JUST for calibration studies</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :   fGoofieArray(0),        //! array of GOOFIE values -per run - Just for calibration studies</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :   fVoltageArray(0),</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :   fTemperatureArray(0),   //! array of temperature sensors - per run - Just for calibration studies</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :   fVdriftArray(0),         //! array of v drift interfaces</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :   fDriftCorrectionArray(0), //! array of v drift corrections</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :   fRunList(0),              //! run list - indicates try to get the run param</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :   fBHasAlignmentOCDB(kFALSE),    // Flag  - has the alignment on the composed correction ?</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :   fDButil(0),</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :   fCTPTimeParams(0),</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :   fMode(-1)</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 : {</span>
<span class="lineNum">     279 </span>            :   /// Copy constructor invalid -- singleton implementation
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :   Error(&quot;copy constructor&quot;,&quot;invalid -- singleton implementation&quot;);</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;72;++i){</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     fChamberHVStatus[i]=kTRUE;</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     fChamberHVmedian[i]=-1;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     fCurrentNominalVoltage[i]=0.;</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     fChamberHVgoodFraction[i]=0.;</span>
<span class="lineNum">     287 </span>            :   }
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   fTimeGainSplinesArray.SetOwner(); //own the keys</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   fGRPArray.SetOwner(); //own the keys</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :   fGRPMaps.SetOwner(); //own the keys</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :   fGoofieArray.SetOwner(); //own the keys</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :   fVoltageArray.SetOwner(); //own the keys</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :   fTemperatureArray.SetOwner(); //own the keys</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :   fVdriftArray.SetOwner(); //own the keys</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :   fDriftCorrectionArray.SetOwner(); //own the keys</span>
<a name="296"><span class="lineNum">     296 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span>            : AliTPCcalibDB&amp; AliTPCcalibDB::operator= (const AliTPCcalibDB&amp; )
<span class="lineNum">     299 </span>            : {
<span class="lineNum">     300 </span>            : /// Singleton implementation - no assignment operator
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :   Error(&quot;operator =&quot;, &quot;assignment operator not implemented&quot;);</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :   return *this;</span>
<span class="lineNum">     304 </span>            : }
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span>            : 
<a name="307"><span class="lineNum">     307 </span>            : </a>
<span class="lineNum">     308 </span>            : //_____________________________________________________________________________
<span class="lineNum">     309 </span>            : AliTPCcalibDB::~AliTPCcalibDB()
<span class="lineNum">     310 </span><span class="lineCov">         12 : {</span>
<span class="lineNum">     311 </span>            :   /// destructor
<span class="lineNum">     312 </span>            :   ///
<span class="lineNum">     313 </span>            :   /// delete fIonTailArray;
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineCov">          4 :   delete fActiveChannelMap;</span>
<span class="lineNum">     316 </span><span class="lineCov">          2 :   delete fGrRunState;</span>
<span class="lineNum">     317 </span><span class="lineCov">          2 :   fgInstance = 0;</span>
<a name="318"><span class="lineNum">     318 </span><span class="lineCov">          6 : }</span></a>
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span>            : AliTPCCalPad* AliTPCcalibDB::GetDistortionMap(Int_t i) const {
<span class="lineNum">     321 </span>            :   /// get distortion map - due E field distortions
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :   return (fDistortionMap) ? (AliTPCCalPad*)fDistortionMap-&gt;At(i):0;</span>
<a name="324"><span class="lineNum">     324 </span>            : }</a>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span>            : AliTPCRecoParam* AliTPCcalibDB::GetRecoParam(Int_t i) const {
<span class="lineNum">     327 </span><span class="lineCov">       1204 :   return (fRecoParamList) ? (AliTPCRecoParam*)fRecoParamList-&gt;At(i):0;</span>
<span class="lineNum">     328 </span>            : }
<a name="329"><span class="lineNum">     329 </span>            : </a>
<span class="lineNum">     330 </span>            : //_____________________________________________________________________________
<span class="lineNum">     331 </span>            : AliCDBEntry* AliTPCcalibDB::GetCDBEntry(const char* cdbPath)
<span class="lineNum">     332 </span>            : {
<span class="lineNum">     333 </span>            :   /// Retrieves an entry with path &lt;cdbPath&gt; from the CDB.
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span><span class="lineCov">        108 :   char chinfo[1000];</span>
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span><span class="lineCov">        108 :   AliCDBEntry* entry = AliCDBManager::Instance()-&gt;Get(cdbPath, fRun);</span>
<span class="lineNum">     338 </span><span class="lineCov">         54 :   if (!entry)</span>
<span class="lineNum">     339 </span>            :   {
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     snprintf(chinfo,1000,&quot;AliTPCcalibDB: Failed to get entry:\t%s &quot;, cdbPath);</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :     AliError(chinfo);</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     343 </span>            :   }
<span class="lineNum">     344 </span><span class="lineCov">         54 :   return entry;</span>
<span class="lineNum">     345 </span><span class="lineCov">         54 : }</span>
<span class="lineNum">     346 </span>            : 
<a name="347"><span class="lineNum">     347 </span>            : </a>
<span class="lineNum">     348 </span>            : //_____________________________________________________________________________
<span class="lineNum">     349 </span>            : void AliTPCcalibDB::SetRun(Long64_t run)
<span class="lineNum">     350 </span>            : {
<span class="lineNum">     351 </span>            :   /// Sets current run number. Calibration data is read from the corresponding file.
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span><span class="lineCov">         16 :   if (fRun == run)</span>
<span class="lineNum">     354 </span>            :     return;
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :         fRun = run;</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :   Update();</span>
<span class="lineNum">     357 </span><span class="lineCov">          8 : }</span>
<span class="lineNum">     358 </span>            : 
<a name="359"><span class="lineNum">     359 </span>            : </a>
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span>            : void AliTPCcalibDB::Update(){
<span class="lineNum">     362 </span>            :   /// cache the OCDB entries for simulation, reconstruction, calibration
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span>            :   AliCDBEntry * entry=0x0;
<span class="lineNum">     366 </span><span class="lineCov">          6 :   Bool_t cdbCache = AliCDBManager::Instance()-&gt;GetCacheFlag(); // save cache status</span>
<span class="lineNum">     367 </span><span class="lineCov">          3 :   AliCDBManager::Instance()-&gt;SetCacheFlag(kTRUE); // activate CDB cache</span>
<span class="lineNum">     368 </span><span class="lineCov">          6 :   fDButil = new AliTPCcalibDButil;</span>
<span class="lineNum">     369 </span>            :   //
<span class="lineNum">     370 </span><span class="lineCov">          3 :   fRun = AliCDBManager::Instance()-&gt;GetRun();</span>
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span>            :   //RS: new TPC correction map (array of AliTPCChebCorr) will be loaded on demand
<span class="lineNum">     373 </span><span class="lineCov">          3 :   fCorrectionMaps = 0; // assuming that the object is managed by the OCDB</span>
<span class="lineNum">     374 </span>            :   //
<span class="lineNum">     375 </span>            :   
<span class="lineNum">     376 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/Parameters&quot;);</span>
<span class="lineNum">     377 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     378 </span>            :     //if (fPadNoise) delete fPadNoise;
<span class="lineNum">     379 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     380 </span><span class="lineCov">          3 :     fParam = (AliTPCParam*)(entry-&gt;GetObject());</span>
<span class="lineNum">     381 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry TPC/Calib/Parameters&quot;);</span>
<span class="lineNum">     383 </span>            :   }
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span>            :   //
<span class="lineNum">     386 </span>            :   // check the presence of the detectors
<span class="lineNum">     387 </span>            :   try {
<span class="lineNum">     388 </span><span class="lineCov">         12 :     entry = AliCDBManager::Instance()-&gt;Get(&quot;GRP/GRP/Data&quot;);</span>
<span class="lineNum">     389 </span><span class="lineCov">          3 :   } catch(...) {</span>
<span class="lineNum">     390 </span><span class="lineCov">          2 :     AliInfo(&quot;No GRP entry found&quot;);</span>
<span class="lineNum">     391 </span>            :     entry = 0x0;
<span class="lineNum">     392 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     393 </span><span class="lineCov">          3 :   if (entry) {</span>
<span class="lineNum">     394 </span><span class="lineCov">          6 :     AliGRPObject* grpData = dynamic_cast&lt;AliGRPObject*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     395 </span><span class="lineCov">          2 :     if (!grpData) {printf(&quot;Failed to get GRP data for run %d\n&quot;,fRun); return;}</span>
<span class="lineNum">     396 </span><span class="lineCov">          2 :     Int_t activeDetectors = grpData-&gt;GetDetectorMask();</span>
<span class="lineNum">     397 </span><span class="lineCov">          2 :     TString detStr = AliDAQ::ListOfTriggeredDetectors(activeDetectors);</span>
<span class="lineNum">     398 </span>            :     //printf(&quot;Detectors in the data:\n%s\n&quot;,detStr.Data());
<span class="lineNum">     399 </span><span class="lineCov">          4 :     if ( detStr.Contains(&quot;TPC&quot;)==0){</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :       AliInfo(&quot;TPC not present in the run&quot;);</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     402 </span>            :     }
<span class="lineNum">     403 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span>            :  
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span>            : 
<span class="lineNum">     408 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/PadGainFactor&quot;);</span>
<span class="lineNum">     409 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     410 </span>            :     //if (fPadGainFactor) delete fPadGainFactor;
<span class="lineNum">     411 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     412 </span><span class="lineCov">          3 :     fPadGainFactor = (AliTPCCalPad*)entry-&gt;GetObject();</span>
<span class="lineNum">     413 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry TPC/Calib/PadGainFactor&quot;);</span>
<span class="lineNum">     415 </span>            :   }
<span class="lineNum">     416 </span>            :   //
<span class="lineNum">     417 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/TimeGain&quot;);</span>
<span class="lineNum">     418 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     419 </span>            :     //if (fTimeGainSplines) delete fTimeGainSplines;
<span class="lineNum">     420 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     421 </span><span class="lineCov">          3 :     fTimeGainSplines = (TObjArray*)entry-&gt;GetObject();</span>
<span class="lineNum">     422 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry TPC/Calib/Timegain&quot;);</span>
<span class="lineNum">     424 </span>            :   }
<span class="lineNum">     425 </span>            :   //
<span class="lineNum">     426 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/GainFactorDedx&quot;);</span>
<span class="lineNum">     427 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     428 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     429 </span><span class="lineCov">          3 :     fDedxGainFactor = (AliTPCCalPad*)entry-&gt;GetObject();</span>
<span class="lineNum">     430 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry TPC/Calib/gainFactordEdx&quot;);</span>
<span class="lineNum">     432 </span>            :   }
<span class="lineNum">     433 </span>            :   //
<span class="lineNum">     434 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/PadTime0&quot;);</span>
<span class="lineNum">     435 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     436 </span>            :     //if (fPadTime0) delete fPadTime0;
<span class="lineNum">     437 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     438 </span><span class="lineCov">          3 :     fPadTime0 = (AliTPCCalPad*)entry-&gt;GetObject();</span>
<span class="lineNum">     439 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry&quot;);</span>
<span class="lineNum">     441 </span>            :   }
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/Distortion&quot;);</span>
<span class="lineNum">     444 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     445 </span>            :     //if (fPadTime0) delete fPadTime0;
<span class="lineNum">     446 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     447 </span><span class="lineCov">          9 :     fDistortionMap =dynamic_cast&lt;TObjArray*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     448 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     449 </span>            :     //AliFatal(&quot;TPC - Missing calibration entry&quot;)
<span class="lineNum">     450 </span>            :   }
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            :   //
<span class="lineNum">     454 </span>            :   //
<span class="lineNum">     455 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/PadNoise&quot;);</span>
<span class="lineNum">     456 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     457 </span>            :     //if (fPadNoise) delete fPadNoise;
<span class="lineNum">     458 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     459 </span><span class="lineCov">          3 :     fPadNoise = (AliTPCCalPad*)entry-&gt;GetObject();</span>
<span class="lineNum">     460 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry&quot;);</span>
<span class="lineNum">     462 </span>            :   }
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/Pedestals&quot;);</span>
<span class="lineNum">     465 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     466 </span>            :     //if (fPedestals) delete fPedestals;
<span class="lineNum">     467 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     468 </span><span class="lineCov">          3 :     fPedestals = (AliTPCCalPad*)entry-&gt;GetObject();</span>
<span class="lineNum">     469 </span><span class="lineCov">          3 :   }</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/Temperature&quot;);</span>
<span class="lineNum">     472 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     473 </span>            :     //if (fTemperature) delete fTemperature;
<span class="lineNum">     474 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     475 </span><span class="lineCov">          3 :     fTemperature = (AliTPCSensorTempArray*)entry-&gt;GetObject();</span>
<span class="lineNum">     476 </span><span class="lineCov">          3 :   }</span>
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span>            :  
<span class="lineNum">     479 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/ClusterParam&quot;);</span>
<span class="lineNum">     480 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     481 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     482 </span><span class="lineCov">          3 :     fClusterParam = (AliTPCClusterParam*)(entry-&gt;GetObject());</span>
<span class="lineNum">     483 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry&quot;);</span>
<span class="lineNum">     485 </span>            :   }
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/RecoParam&quot;);</span>
<span class="lineNum">     488 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     489 </span>            :     //PH    entry-&gt;SetOwner(kTRUE);
<span class="lineNum">     490 </span><span class="lineCov">          9 :     fRecoParamList = dynamic_cast&lt;TObjArray*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry TPC/Calib/RecoParam&quot;);</span>
<span class="lineNum">     494 </span>            :   }
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span>            :   //ALTRO configuration data
<span class="lineNum">     498 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/AltroConfig&quot;);</span>
<span class="lineNum">     499 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     500 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     501 </span><span class="lineCov">          3 :     fALTROConfigData=(TObjArray*)(entry-&gt;GetObject());</span>
<span class="lineNum">     502 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry&quot;);</span>
<span class="lineNum">     504 </span>            :   }
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span>            :   //Calibration Pulser data
<span class="lineNum">     507 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/Pulser&quot;);</span>
<span class="lineNum">     508 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     509 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     510 </span><span class="lineCov">          3 :     fPulserData=(TObjArray*)(entry-&gt;GetObject());</span>
<span class="lineNum">     511 </span><span class="lineCov">          3 :   }</span>
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span>            :   //Calibration ION tail data
<span class="lineNum">     514 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/IonTail&quot;);</span>
<span class="lineNum">     515 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     516 </span>            :     //delete fIonTailArray; fIonTailArray=NULL;
<span class="lineNum">     517 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     518 </span><span class="lineCov">          3 :      fIonTailArray=(TObjArray*)(entry-&gt;GetObject());</span>
<span class="lineNum">     519 </span><span class="lineCov">          3 :      fIonTailArray-&gt;SetOwner(); //own the keys</span>
<span class="lineNum">     520 </span><span class="lineCov">          3 :   }</span>
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span>            :   //CE data
<span class="lineNum">     523 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/CE&quot;);</span>
<span class="lineNum">     524 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     525 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     526 </span><span class="lineCov">          3 :     fCEData=(TObjArray*)(entry-&gt;GetObject());</span>
<span class="lineNum">     527 </span><span class="lineCov">          3 :   }</span>
<span class="lineNum">     528 </span>            :   //RAW calibration data
<span class="lineNum">     529 </span>            :  //  entry          = GetCDBEntry(&quot;TPC/Calib/Raw&quot;);
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/Mapping&quot;);</span>
<span class="lineNum">     532 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     533 </span>            :     //if (fPadNoise) delete fPadNoise;
<span class="lineNum">     534 </span><span class="lineCov">          3 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     535 </span><span class="lineCov">          9 :     TObjArray * array = dynamic_cast&lt;TObjArray*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     536 </span><span class="lineCov">          6 :     if (array &amp;&amp; array-&gt;GetEntriesFast()==6){</span>
<span class="lineNum">     537 </span><span class="lineCov">          3 :       fMapping = new AliTPCAltroMapping*[6];</span>
<span class="lineNum">     538 </span><span class="lineCov">         42 :       for (Int_t i=0; i&lt;6; i++){</span>
<span class="lineNum">     539 </span><span class="lineCov">         54 :         fMapping[i] =  dynamic_cast&lt;AliTPCAltroMapping*&gt;(array-&gt;At(i));</span>
<span class="lineNum">     540 </span>            :       }
<span class="lineNum">     541 </span><span class="lineCov">          3 :     }</span>
<span class="lineNum">     542 </span><span class="lineCov">          3 :   }</span>
<span class="lineNum">     543 </span>            : 
<span class="lineNum">     544 </span>            :   //CTP calibration data
<span class="lineNum">     545 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;GRP/CTP/CTPtiming&quot;);</span>
<span class="lineNum">     546 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     547 </span>            :     //entry-&gt;SetOwner(kTRUE);
<span class="lineNum">     548 </span><span class="lineCov">          9 :     fCTPTimeParams=dynamic_cast&lt;AliCTPTimeParams*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     549 </span><span class="lineCov">          3 :   }else{</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :     AliError(&quot;TPC - Missing calibration entry&quot;);</span>
<span class="lineNum">     551 </span>            :   }
<span class="lineNum">     552 </span>            :   //TPC space point correction data
<span class="lineNum">     553 </span><span class="lineCov">          3 :   entry          = GetCDBEntry(&quot;TPC/Calib/Correction&quot;);</span>
<span class="lineNum">     554 </span><span class="lineCov">          3 :   if (entry){</span>
<span class="lineNum">     555 </span>            :     //entry-&gt;SetOwner(kTRUE);
<span class="lineNum">     556 </span><span class="lineCov">          9 :     fComposedCorrection=dynamic_cast&lt;AliTPCCorrection*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     557 </span><span class="lineCov">          3 :     if (fComposedCorrection) fComposedCorrection-&gt;Init();</span>
<span class="lineNum">     558 </span><span class="lineCov">          9 :     fComposedCorrectionArray=dynamic_cast&lt;TObjArray*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     559 </span><span class="lineCov">          3 :     if (fComposedCorrectionArray){</span>
<span class="lineNum">     560 </span><span class="lineCov">         24 :       for (Int_t i=0; i&lt;fComposedCorrectionArray-&gt;GetEntries(); i++){</span>
<span class="lineNum">     561 </span><span class="lineCov">         27 :         AliTPCComposedCorrection* composedCorrection= dynamic_cast&lt;AliTPCComposedCorrection*&gt;(fComposedCorrectionArray-&gt;At(i));</span>
<span class="lineNum">     562 </span><span class="lineCov">          9 :         if (composedCorrection) {</span>
<span class="lineNum">     563 </span><span class="lineCov">          9 :           composedCorrection-&gt;Init();</span>
<span class="lineNum">     564 </span><span class="lineCov">          9 :           if (composedCorrection-&gt;GetCorrections()){</span>
<span class="lineNum">     565 </span><span class="lineCov">          9 :             if (composedCorrection-&gt;GetCorrections()-&gt;FindObject(&quot;FitAlignTPC&quot;)){</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :               fBHasAlignmentOCDB=kTRUE;</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     568 </span>            :           }
<span class="lineNum">     569 </span>            :         }
<span class="lineNum">     570 </span>            :       }
<span class="lineNum">     571 </span><span class="lineCov">          3 :     }</span>
<span class="lineNum">     572 </span>            :   }else{
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :     AliError(&quot;TPC - Missing calibration entry-  TPC/Calib/Correction&quot;);</span>
<span class="lineNum">     574 </span>            :   }
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span>            :   //RCU trigger config mode
<span class="lineNum">     577 </span><span class="lineCov">          3 :   fMode=GetRCUTriggerConfig();</span>
<span class="lineNum">     578 </span>            :   //
<span class="lineNum">     579 </span><span class="lineCov">          3 :   if (!fTransform) {</span>
<span class="lineNum">     580 </span><span class="lineCov">          6 :     fTransform=new AliTPCTransform();</span>
<span class="lineNum">     581 </span><span class="lineCov">          3 :     fTransform-&gt;SetCurrentRun(AliCDBManager::Instance()-&gt;GetRun());</span>
<span class="lineNum">     582 </span><span class="lineCov">          3 :   }</span>
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span>            :   // Chamber HV data
<span class="lineNum">     585 </span>            :   // needs to be called before InitDeadMap
<span class="lineNum">     586 </span><span class="lineCov">          3 :   UpdateChamberHighVoltageData();</span>
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span>            :   // Create Dead Channel Map
<span class="lineNum">     589 </span><span class="lineCov">          3 :   InitDeadMap();</span>
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span>            :   // Calculate derived ALTRO information
<span class="lineNum">     592 </span><span class="lineCov">          3 :   InitAltroData();</span>
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span>            :   //
<span class="lineNum">     595 </span><span class="lineCov">          3 :   AliCDBManager::Instance()-&gt;SetCacheFlag(cdbCache); // reset original CDB cache</span>
<span class="lineNum">     596 </span><span class="lineCov">          7 : }</span>
<a name="597"><span class="lineNum">     597 </span>            : </a>
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span>            : void AliTPCcalibDB::LoadCorrectionMaps()
<span class="lineNum">     600 </span>            : {
<span class="lineNum">     601 </span>            :   // TPC fast Chebyshev correction map, loaded on 1st demand
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :   AliCDBEntry* entry = GetCDBEntry(&quot;TPC/Calib/CorrectionMaps&quot;);</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :   if (entry) {</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :     fCorrectionMaps = dynamic_cast&lt;TObjArray*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     606 </span>            :   else{
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     AliError(&quot;TPC - Missing calibration entry-  TPC/Calib/CorrectionMaps&quot;);</span>
<span class="lineNum">     608 </span>            :   }
<a name="609"><span class="lineNum">     609 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span>            : void AliTPCcalibDB::UpdateNonRec(){
<span class="lineNum">     612 </span>            :   /// Update/Load the parameters which are important for QA studies
<span class="lineNum">     613 </span>            :   /// and not used yet for the reconstruction
<span class="lineNum">     614 </span>            :   ///
<span class="lineNum">     615 </span>            :   /// RAW calibration data
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            :   AliCDBEntry * entry=0;
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :   entry          = GetCDBEntry(&quot;TPC/Calib/Raw&quot;);</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :   if (entry){</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :     TObjArray *arr=dynamic_cast&lt;TObjArray*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :     if (arr) fCalibRaw=(AliTPCCalibRaw*)arr-&gt;At(0);</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :     else fCalibRaw = (AliTPCCalibRaw*)(entry-&gt;GetObject());</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     625 </span>            :   //QA calibration data
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :   entry          = GetCDBEntry(&quot;TPC/Calib/QA&quot;);</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :   if (entry){</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :     entry-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :     fDataQA=dynamic_cast&lt;AliTPCdataQA*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     631 </span>            :   // High voltage
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :   if (fRun&gt;=0 &amp;&amp; !fVoltageArray.GetValue(Form(&quot;%i&quot;,fRun))){</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :     entry = AliCDBManager::Instance()-&gt;Get(&quot;TPC/Calib/HighVoltage&quot;,fRun);</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :     if (entry)  {</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :       fVoltageArray.Add(new TObjString(Form(&quot;%i&quot;,fRun)),entry-&gt;GetObject());</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     637 </span>            :   }
<span class="lineNum">     638 </span>            : 
<a name="639"><span class="lineNum">     639 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            : Bool_t AliTPCcalibDB::GetTailcancelationGraphs(Int_t sector, TGraphErrors ** graphRes, Float_t * indexAmpGraphs){
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span>            : ///   Read OCDB entry object of Iontail (TObjArray of TGraphErrors of TRFs)
<span class="lineNum">     644 </span>            : ///   Naming of the TRF objects is: &quot;gr_&lt;chamber_type&gt;_&lt;voltage&gt;_&lt;laser_track_angle&gt;_&lt;distance_to_COG&gt;&quot; --&gt; &quot;gr_iroc_1240_1_1&quot;
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span>            :   //Int_t run = fTransform-&gt;GetCurrentRunNumber();
<span class="lineNum">     647 </span>            :   //SetRun(run);
<span class="lineNum">     648 </span>            :   //Float_t rocVoltage = GetChamberHighVoltage(run,sector, -1);      // Get the voltage from OCDB with a getter (old function)
<span class="lineNum">     649 </span>            : //   Float_t rocVoltage=GetChamberHighVoltageMedian(sector);                      // Get the voltage from OCDB, new function from Jens
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :   Int_t nominalVoltage = (sector&lt;36) ? 1240 : 1470 ;     // nominal voltage of 2012 when the TRF functions were produced</span>
<span class="lineNum">     652 </span>            : 
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :   Float_t rocVoltage = nominalVoltage;</span>
<span class="lineNum">     654 </span>            : 
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :   if ( rocVoltage &lt; nominalVoltage/2. || rocVoltage &gt; nominalVoltage*2. )</span>
<span class="lineNum">     656 </span>            :   {
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :     AliInfo(Form(&quot;rocVoltage out of range: roc: %.2f, nominal: %i&quot;, rocVoltage, nominalVoltage));</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">     659 </span>            :   }
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span>            :   Int_t tempVoltage = 0;
<span class="lineNum">     662 </span>            :   Int_t trackAngle  = 4;                                 // (1=first, 2=second, 3=third, 4=first+second, 5=all tracks) note: 3rd is distorted by low freq
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :   TString rocType   = (sector&lt;36) ? &quot;iroc&quot; : &quot;oroc&quot;;</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :   const Int_t ngraph=fIonTailArray-&gt;GetLast();</span>
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span>            :   // create array of voltages in order to select the proper TRF with closest voltage
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :   Int_t voltages[ngraph];     // array of voltages</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;ngraph; i++){</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :     voltages[i]=0;</span>
<span class="lineNum">     670 </span>            :   }
<span class="lineNum">     671 </span>            : 
<span class="lineNum">     672 </span>            :   // loop over response functions in the TObjarray
<span class="lineNum">     673 </span>            :   Int_t nvoltages=0;
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :   for (Int_t i=0;i&lt;=ngraph;i++){</span>
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span>            :     // read the TRF object name in order to select proper TRF for the given sector
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :     TString objname(fIonTailArray-&gt;At(i)-&gt;GetName());</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :     if (!objname.Contains(rocType)) continue;</span>
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :     TObjArray *objArr = objname.Tokenize(&quot;_&quot;);</span>
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span>            :     // select the roc type (IROC or OROC) and the trackAngle
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :     if ( atoi(static_cast&lt;TObjString*&gt;(objArr-&gt;At(3))-&gt;GetName())==trackAngle )</span>
<span class="lineNum">     684 </span>            :     {
<span class="lineNum">     685 </span>            :       // Create the voltage array for proper voltage value selection
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :       voltages[nvoltages]=atoi(static_cast&lt;TObjString*&gt;(objArr-&gt;At(2))-&gt;GetName());</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :       nvoltages++;</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :     delete objArr;</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     691 </span>            : 
<span class="lineNum">     692 </span>            :   // find closest voltage value to ROC voltage (among the TRF' voltage array --&gt; to select proper t.r.f.)
<span class="lineNum">     693 </span>            :   Int_t ampIndex     = 0;
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :   Int_t diffVoltage  = TMath::Abs(rocVoltage - voltages[0]);</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :   for (Int_t k=0;k&lt;ngraph;k++) {</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :     if (diffVoltage &gt;= TMath::Abs(rocVoltage-voltages[k]) &amp;&amp; voltages[k]!=0)</span>
<span class="lineNum">     697 </span>            :       {
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :         diffVoltage    = TMath::Abs(rocVoltage-voltages[k]);</span>
<span class="lineNum">     699 </span>            :         ampIndex   = k;
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     701 </span>            :   }
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :   tempVoltage = voltages[ampIndex];    // use closest voltage to current voltage</span>
<span class="lineNum">     703 </span>            :   //if (run&lt;140000) tempVoltage = nominalVoltage;    // for 2010 data
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span>            :   // assign TGraphErrors
<span class="lineNum">     706 </span>            :   Int_t igraph=0;
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;=ngraph; i++){</span>
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span>            :     // read TRFs for TObjArray and select the roc type (IROC or OROC) and the trackAngle
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :     TGraphErrors * trfObj = static_cast&lt;TGraphErrors*&gt;(fIonTailArray-&gt;At(i));</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :     TString objname(trfObj-&gt;GetName());</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :     if (!objname.Contains(rocType)) continue; //choose ROC type</span>
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :     TObjArray *objArr1 = objname.Tokenize(&quot;_&quot;);</span>
<span class="lineNum">     715 </span>            : 
<span class="lineNum">     716 </span>            :     // TRF eleminations
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :     TObjString* angleString = static_cast&lt;TObjString*&gt;(objArr1-&gt;At(3));</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :     TObjString* voltageString = static_cast&lt;TObjString*&gt;(objArr1-&gt;At(2));</span>
<span class="lineNum">     719 </span>            :     //choose angle and voltage
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :     if ((atoi(angleString-&gt;GetName())==trackAngle) &amp;&amp; (atoi(voltageString-&gt;GetName())==tempVoltage) )</span>
<span class="lineNum">     721 </span>            :     {
<span class="lineNum">     722 </span>            :       // Apply Voltage scaling
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :       Int_t voltage       = atoi(voltageString-&gt;GetName());</span>
<span class="lineNum">     724 </span>            :       Double_t voltageScaled = 1;
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :       if (rocVoltage&gt;0)  voltageScaled = Double_t(voltage)/Double_t(rocVoltage); // for jens how it can happen that we have clusters at 0 HV ?</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :       const Int_t nScaled          = TMath::Nint(voltageScaled*trfObj-&gt;GetN())-1;</span>
<span class="lineNum">     727 </span>            :       Double_t x;
<span class="lineNum">     728 </span>            :       Double_t y;
<span class="lineNum">     729 </span>            : 
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :       delete graphRes[igraph];</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :       graphRes[igraph]       = new TGraphErrors(nScaled);</span>
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :       for (Int_t j=0; j&lt;nScaled; j++){</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :         x = TMath::Nint(j*(voltageScaled));</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :         y = (j&lt;trfObj-&gt;GetN()) ? (1./voltageScaled)*trfObj-&gt;GetY()[j] : 0.;</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :         graphRes[igraph]-&gt;SetPoint(j,x,y);</span>
<span class="lineNum">     737 </span>            :       }
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span>            :       // fill arrays for proper position and amplitude selections
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :       TObjString* distanceToCenterOfGravity = static_cast&lt;TObjString*&gt;(objArr1-&gt;At(4));</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :       indexAmpGraphs[igraph] = (distanceToCenterOfGravity-&gt;GetString().Atof())/10.;</span>
<span class="lineNum">     742 </span>            :       // smooth voltage scaled graph
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :       for (Int_t m=1; m&lt;nScaled;m++){</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :         if (graphRes[igraph]-&gt;GetY()[m]==0) graphRes[igraph]-&gt;GetY()[m] = graphRes[igraph]-&gt;GetY()[m-1];</span>
<span class="lineNum">     745 </span>            :       }
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :       igraph++;</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :   delete objArr1;</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     750 </span>            :   return kTRUE;
<a name="751"><span class="lineNum">     751 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     752 </span>            : 
<span class="lineNum">     753 </span>            : void AliTPCcalibDB::CreateObjectList(const Char_t *filename, TObjArray *calibObjects)
<span class="lineNum">     754 </span>            : {
<span class="lineNum">     755 </span>            : /// Create calibration objects and read contents from OCDB
<span class="lineNum">     756 </span>            : 
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :    if ( calibObjects == 0x0 ) return;</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :    ifstream in;</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :    in.open(filename);</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :    if ( !in.is_open() ){</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :       fprintf(stderr,&quot;Error: cannot open list file '%s'&quot;, filename);</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     763 </span>            :    }
<span class="lineNum">     764 </span>            : 
<span class="lineNum">     765 </span>            :    AliTPCCalPad *calPad=0x0;
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :    TString sFile;</span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :    sFile.ReadFile(in);</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :    in.close();</span>
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :    TObjArray *arrFileLine = sFile.Tokenize(&quot;\n&quot;);</span>
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :    TIter nextLine(arrFileLine);</span>
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span>            :    TObjString *sObjLine=0x0;
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :    while ( (sObjLine = (TObjString*)nextLine()) ){</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :       TString sLine(sObjLine-&gt;GetString());</span>
<span class="lineNum">     778 </span>            : 
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :       TObjArray *arrNextCol = sLine.Tokenize(&quot;\t&quot;);</span>
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :       TObjString *sObjType     = (TObjString*)(arrNextCol-&gt;At(0));</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :       TObjString *sObjFileName = (TObjString*)(arrNextCol-&gt;At(1));</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :       delete arrNextCol;</span>
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :       if ( !sObjType || ! sObjFileName ) continue;</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :       TString sType(sObjType-&gt;GetString());</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :       TString sFileName(sObjFileName-&gt;GetString());</span>
<span class="lineNum">     788 </span>            : //       printf(&quot;%s\t%s\n&quot;,sType.Data(),sFileName.Data());
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :       TFile *fIn = TFile::Open(sFileName);</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :       if ( !fIn ){</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :          fprintf(stderr,&quot;File not found: '%s'&quot;, sFileName.Data());</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :          continue;</span>
<span class="lineNum">     794 </span>            :       }
<span class="lineNum">     795 </span>            : 
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :       if ( sType == &quot;CE&quot; ){</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :          AliTPCCalibCE *ce = (AliTPCCalibCE*)fIn-&gt;Get(&quot;AliTPCCalibCE&quot;);</span>
<span class="lineNum">     798 </span>            : 
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :          calPad = new AliTPCCalPad((TObjArray*)ce-&gt;GetCalPadT0());</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :          calPad-&gt;SetNameTitle(&quot;CETmean&quot;,&quot;CETmean&quot;);</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :          calibObjects-&gt;Add(calPad);</span>
<span class="lineNum">     802 </span>            : 
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :          calPad = new AliTPCCalPad((TObjArray*)ce-&gt;GetCalPadQ());</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :          calPad-&gt;SetNameTitle(&quot;CEQmean&quot;,&quot;CEQmean&quot;);</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :          calibObjects-&gt;Add(calPad);</span>
<span class="lineNum">     806 </span>            : 
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :          calPad = new AliTPCCalPad((TObjArray*)ce-&gt;GetCalPadRMS());</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :          calPad-&gt;SetNameTitle(&quot;CETrms&quot;,&quot;CETrms&quot;);</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :          calibObjects-&gt;Add(calPad);</span>
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :       } else if ( sType == &quot;Pulser&quot;) {</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :          AliTPCCalibPulser *sig = (AliTPCCalibPulser*)fIn-&gt;Get(&quot;AliTPCCalibPulser&quot;);</span>
<span class="lineNum">     813 </span>            : 
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :          calPad = new AliTPCCalPad((TObjArray*)sig-&gt;GetCalPadT0());</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :          calPad-&gt;SetNameTitle(&quot;PulserTmean&quot;,&quot;PulserTmean&quot;);</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :          calibObjects-&gt;Add(calPad);</span>
<span class="lineNum">     817 </span>            : 
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :          calPad = new AliTPCCalPad((TObjArray*)sig-&gt;GetCalPadQ());</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :          calPad-&gt;SetNameTitle(&quot;PulserQmean&quot;,&quot;PulserQmean&quot;);</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :          calibObjects-&gt;Add(calPad);</span>
<span class="lineNum">     821 </span>            : 
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :          calPad = new AliTPCCalPad((TObjArray*)sig-&gt;GetCalPadRMS());</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :          calPad-&gt;SetNameTitle(&quot;PulserTrms&quot;,&quot;PulserTrms&quot;);</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :          calibObjects-&gt;Add(calPad);</span>
<span class="lineNum">     825 </span>            : 
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :       } else if ( sType == &quot;Pedestals&quot;) {</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :          AliTPCCalibPedestal *ped = (AliTPCCalibPedestal*)fIn-&gt;Get(&quot;AliTPCCalibPedestal&quot;);</span>
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :          calPad = new AliTPCCalPad((TObjArray*)ped-&gt;GetCalPadPedestal());</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :          calPad-&gt;SetNameTitle(&quot;Pedestals&quot;,&quot;Pedestals&quot;);</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :          calibObjects-&gt;Add(calPad);</span>
<span class="lineNum">     832 </span>            : 
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :          calPad = new AliTPCCalPad((TObjArray*)ped-&gt;GetCalPadRMS());</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :          calPad-&gt;SetNameTitle(&quot;Noise&quot;,&quot;Noise&quot;);</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :          calibObjects-&gt;Add(calPad);</span>
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :       } else {</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :          fprintf(stderr,&quot;Undefined Type: '%s'&quot;,sType.Data());</span>
<span class="lineNum">     839 </span>            : 
<span class="lineNum">     840 </span>            :       }
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :       delete fIn;</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :    delete arrFileLine;</span>
<a name="844"><span class="lineNum">     844 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     845 </span>            : 
<span class="lineNum">     846 </span>            : Int_t AliTPCcalibDB::InitDeadMap()
<span class="lineNum">     847 </span>            : {
<span class="lineNum">     848 </span>            :   /// Initialize DeadChannel Map
<span class="lineNum">     849 </span>            :   /// Source of information:
<span class="lineNum">     850 </span>            :   /// -  HV (see UpdateChamberHighVoltageData())
<span class="lineNum">     851 </span>            :   /// -  Altro disabled channels. Noisy channels.
<span class="lineNum">     852 </span>            :   /// -  DDL list
<span class="lineNum">     853 </span>            :   ///
<span class="lineNum">     854 </span>            :   /// List of required OCDB Entries (See also UpdateChamberHighVoltageData())
<span class="lineNum">     855 </span>            :   /// - TPC/Calib/AltroConfig
<span class="lineNum">     856 </span>            :   /// - TPC/Calib/HighVoltage
<span class="lineNum">     857 </span>            : 
<span class="lineNum">     858 </span>            :   // check necessary information
<span class="lineNum">     859 </span><span class="lineCov">          6 :   const Int_t run=GetRun();</span>
<span class="lineNum">     860 </span><span class="lineCov">          3 :   if (run&lt;0){</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :     AliError(&quot;run not set in CDB manager. Cannot create active channel map&quot;);</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     863 </span>            :   }
<span class="lineNum">     864 </span><span class="lineCov">          3 :   AliDCSSensorArray* voltageArray = GetVoltageSensors(run);</span>
<span class="lineNum">     865 </span><span class="lineCov">          3 :   AliTPCCalPad*          altroMap = GetALTROMasked();</span>
<span class="lineNum">     866 </span><span class="lineCov">          3 :   TMap*                    mapddl = GetDDLMap();</span>
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span><span class="lineCov">          3 :   if (!voltageArray &amp;&amp; !altroMap &amp;&amp; !mapddl) {</span>
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :     AliError(&quot;All necessary information to create the activate channel are map missing.&quot;);</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     AliError(&quot; -&gt; Check existance of the OCDB entries: 'TPC/Calib/AltroConfig', 'TPC/Calib/HighVoltage'&quot;);</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     872 </span>            :   }
<span class="lineNum">     873 </span>            : 
<span class="lineNum">     874 </span>            :   // mapping handler
<span class="lineNum">     875 </span><span class="lineCov">          3 :   AliTPCmapper map(gSystem-&gt;ExpandPathName(&quot;$ALICE_ROOT/TPC/mapping/&quot;));</span>
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span>            :   //=============================================================
<span class="lineNum">     878 </span>            :   // Setup DDL map
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span><span class="lineCov">          3 :   Bool_t ddlMap[216]={0};</span>
<span class="lineNum">     881 </span><span class="lineCov">       1302 :   for (Int_t iddl=0; iddl&lt;216; ++iddl) ddlMap[iddl]=1;</span>
<span class="lineNum">     882 </span><span class="lineCov">          3 :   if (mapddl){</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :     TObjString *s = (TObjString*)mapddl-&gt;GetValue(&quot;DDLArray&quot;);</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     if (s){</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :       for (Int_t iddl=0; iddl&lt;216; ++iddl) {</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :         ddlMap[iddl]=TString(s-&gt;GetString()(iddl))!=&quot;0&quot;;</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :         if (!ddlMap[iddl]) {</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :           Int_t roc = map.GetRocFromEquipmentID(iddl+768);</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :           AliWarning(Form(&quot;Inactive DDL (#%d, ROC %2d) detected based on the 'DDLArray' in 'TPC/Calib/AltroConfig'. This will deactivate many channels.&quot;, iddl, roc));</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     891 </span>            :       }
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">     894 </span><span class="lineCov">          6 :     AliError(&quot;DDL map missing. ActiveChannelMap can only be created with parts of the information.&quot;);</span>
<span class="lineNum">     895 </span><span class="lineCov">          6 :     AliError(&quot; -&gt; Check existance of 'DDLArray' in the OCDB entry: 'TPC/Calib/AltroConfig'&quot;);</span>
<span class="lineNum">     896 </span>            :   }
<span class="lineNum">     897 </span>            :   // Setup DDL map done
<span class="lineNum">     898 </span>            :   // ============================================================
<span class="lineNum">     899 </span>            : 
<span class="lineNum">     900 </span>            :   // ============================================================
<span class="lineNum">     901 </span>            :   // Set up channel masking from correction maps
<span class="lineNum">     902 </span>            : 
<span class="lineNum">     903 </span><span class="lineCov">        435 :   TBits maskedPads[72];</span>
<span class="lineNum">     904 </span><span class="lineCov">          3 :   GetMaskedChannelsFromCorrectionMaps(maskedPads);</span>
<span class="lineNum">     905 </span>            : 
<span class="lineNum">     906 </span>            :   // channel masking done
<span class="lineNum">     907 </span>            :   // ============================================================
<span class="lineNum">     908 </span>            : 
<span class="lineNum">     909 </span>            :   //=============================================================
<span class="lineNum">     910 </span>            :   // Setup active chnnel map
<span class="lineNum">     911 </span>            :   //
<span class="lineNum">     912 </span>            : 
<span class="lineNum">     913 </span><span class="lineCov">         12 :   if (!fActiveChannelMap) fActiveChannelMap=new AliTPCCalPad(&quot;ActiveChannelMap&quot;,&quot;ActiveChannelMap&quot;);</span>
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span><span class="lineCov">          3 :   if (!altroMap) {</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :     AliError(&quot;ALTRO dead channel map missing. ActiveChannelMap can only be created with parts of the information.&quot;);</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :     AliError(&quot; -&gt; Check existance of 'Masked' in the OCDB entry: 'TPC/Calib/AltroConfig'&quot;);</span>
<span class="lineNum">     918 </span>            :   }
<span class="lineNum">     919 </span>            : 
<span class="lineNum">     920 </span><span class="lineCov">          3 :   AliTPCROC* tpcROC = AliTPCROC::Instance();</span>
<span class="lineNum">     921 </span>            : 
<span class="lineNum">     922 </span><span class="lineCov">        438 :   for (Int_t iROC=0;iROC&lt;AliTPCCalPad::kNsec;++iROC){</span>
<span class="lineNum">     923 </span><span class="lineCov">        216 :     AliTPCCalROC *roc=fActiveChannelMap-&gt;GetCalROC(iROC);</span>
<span class="lineNum">     924 </span><span class="lineCov">        216 :     if (!roc){</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :       AliError(Form(&quot;No ROC %d in active channel map&quot;,iROC));</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     927 </span>            :     }
<span class="lineNum">     928 </span>            : 
<span class="lineNum">     929 </span>            :     // check for bad voltage
<span class="lineNum">     930 </span>            :     // see UpdateChamberHighVoltageData()
<span class="lineNum">     931 </span><span class="lineCov">        216 :     if (!fChamberHVStatus[iROC]){</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :       roc-&gt;Multiply(0.);</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot;Turning off all channels of ROC %2d due to a bad HV status&quot;, iROC));</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :       AliWarning(&quot; -&gt; Check messages in UpdateChamberHighVoltageData()&quot;);</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     936 </span>            :     }
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span>            :     AliTPCCalROC *masked=0x0;
<span class="lineNum">     939 </span><span class="lineCov">        432 :     if (altroMap) masked=altroMap-&gt;GetCalROC(iROC);</span>
<span class="lineNum">     940 </span>            : 
<span class="lineNum">     941 </span>            :     Int_t numberOfDeactivatedChannels=0;
<span class="lineNum">     942 </span><span class="lineCov">      34776 :     for (UInt_t irow=0; irow&lt;roc-&gt;GetNrows(); ++irow){</span>
<span class="lineNum">     943 </span>            :       // first channel in row
<span class="lineNum">     944 </span><span class="lineCov">      17172 :       const Int_t channel0 = tpcROC-&gt;GetRowIndexes(iROC)[irow];</span>
<span class="lineNum">     945 </span>            : 
<span class="lineNum">     946 </span><span class="lineCov">    5069628 :       for (UInt_t ipad=0; ipad&lt;roc-&gt;GetNPads(irow); ++ipad){</span>
<span class="lineNum">     947 </span>            :         //per default the channel is on
<span class="lineNum">     948 </span><span class="lineCov">    1672704 :         roc-&gt;SetValue(irow,ipad,1);</span>
<span class="lineNum">     949 </span>            : 
<span class="lineNum">     950 </span>            :         // apply altro dead channel mask (inverse logik, it is not active, but inactive channles)
<span class="lineNum">     951 </span><span class="lineCov">    3347646 :         if (masked &amp;&amp; masked-&gt;GetValue(irow, ipad)) roc-&gt;SetValue(irow, ipad ,0);</span>
<span class="lineNum">     952 </span>            : 
<span class="lineNum">     953 </span>            :         // mask channels if a DDL is inactive
<span class="lineNum">     954 </span><span class="lineCov">    3345408 :         Int_t ddlId=map.GetEquipmentID(iROC, irow, ipad)-768;</span>
<span class="lineNum">     955 </span><span class="lineCov">    3345408 :         if (ddlId&gt;=0 &amp;&amp; !ddlMap[ddlId]) roc-&gt;SetValue(irow, ipad ,0);</span>
<span class="lineNum">     956 </span>            : 
<span class="lineNum">     957 </span>            :         // mask channels if error on space point coorection is too large
<span class="lineNum">     958 </span><span class="lineCov">    1672704 :         if (maskedPads &amp;&amp; maskedPads[iROC].TestBitNumber(channel0+ipad)) roc-&gt;SetValue(irow, ipad ,0);</span>
<span class="lineNum">     959 </span>            : 
<span class="lineNum">     960 </span><span class="lineCov">    1672704 :         if (roc-&gt;GetValue(irow, ipad)&lt;0.0001) {</span>
<span class="lineNum">     961 </span><span class="lineCov">       2238 :           ++numberOfDeactivatedChannels;</span>
<span class="lineNum">     962 </span><span class="lineCov">       2238 :         }</span>
<span class="lineNum">     963 </span>            :       }
<span class="lineNum">     964 </span>            :     }
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span><span class="lineCov">        216 :     if (numberOfDeactivatedChannels&gt;0) {</span>
<span class="lineNum">     967 </span><span class="lineCov">        621 :       AliInfo(Form(&quot;Deactivated %4d channels in ROC %2d due to altro and DDL map states&quot;,</span>
<span class="lineNum">     968 </span>            :                    numberOfDeactivatedChannels, iROC));
<span class="lineNum">     969 </span>            :     }
<span class="lineNum">     970 </span><span class="lineCov">        216 :   }</span>
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span>            :   return 1;
<a name="973"><span class="lineNum">     973 </span><span class="lineCov">        225 : }</span></a>
<span class="lineNum">     974 </span>            : 
<span class="lineNum">     975 </span>            : void AliTPCcalibDB::InitAltroData()
<span class="lineNum">     976 </span>            : {
<span class="lineNum">     977 </span>            :   /// Initialise derived ALTRO data
<span class="lineNum">     978 </span>            :   ///
<span class="lineNum">     979 </span>            :   /// List of required OCDB Entries
<span class="lineNum">     980 </span>            :   /// - TPC/Calib/AltroConfig
<span class="lineNum">     981 </span>            :   /// - TPC/Calib/Parameters
<span class="lineNum">     982 </span>            : 
<span class="lineNum">     983 </span>            :   // ===| Maximum time bin |====================================================
<span class="lineNum">     984 </span>            :   //
<span class="lineNum">     985 </span>            :   // Calculate the maximum time using the 'AcqStart' cal pad object from
<span class="lineNum">     986 </span>            :   // TPC/Calib/AltroConfig
<span class="lineNum">     987 </span>            :   // if this object is not available, the value will return the max time bin
<span class="lineNum">     988 </span>            :   // stored in the AliTPCParam object from TPC/Calib/Parameters
<span class="lineNum">     989 </span>            : 
<span class="lineNum">     990 </span><span class="lineCov">          6 :   fMaxTimeBinAllPads=-1;</span>
<span class="lineNum">     991 </span>            : 
<span class="lineNum">     992 </span><span class="lineCov">          3 :   const AliTPCCalPad *calPadAcqStop = GetALTROAcqStop();</span>
<span class="lineNum">     993 </span>            : 
<span class="lineNum">     994 </span><span class="lineCov">          3 :   if (calPadAcqStop) {</span>
<span class="lineNum">     995 </span>            :     //find max elememt
<span class="lineNum">     996 </span>            :     // TODO: change this once the GetMaxElement function is implemented in AliTPCCalPad
<span class="lineNum">     997 </span>            :     Float_t maxBin=-1;
<span class="lineNum">     998 </span><span class="lineCov">        438 :     for (Int_t iroc=0; iroc&lt;AliTPCCalPad::kNsec; ++iroc) {</span>
<span class="lineNum">     999 </span><span class="lineCov">        216 :       const AliTPCCalROC *roc = calPadAcqStop-&gt;GetCalROC(iroc);</span>
<span class="lineNum">    1000 </span><span class="lineCov">        216 :       if (!roc) continue;</span>
<span class="lineNum">    1001 </span><span class="lineCov">    3345840 :       for (Int_t ichannel=0; ichannel&lt;roc-&gt;GetNchannels(); ++ichannel) {</span>
<span class="lineNum">    1002 </span><span class="lineCov">    1672704 :         const Float_t val=roc-&gt;GetValue(ichannel);</span>
<span class="lineNum">    1003 </span><span class="lineCov">    1672707 :         if (val&gt;maxBin) maxBin=val;</span>
<span class="lineNum">    1004 </span>            :       }
<span class="lineNum">    1005 </span><span class="lineCov">        216 :     }</span>
<span class="lineNum">    1006 </span><span class="lineCov">          3 :     fMaxTimeBinAllPads = TMath::Nint(maxBin);</span>
<span class="lineNum">    1007 </span><span class="lineCov">          3 :   }</span>
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineCov">          3 :   if (fMaxTimeBinAllPads&lt;0) {</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :     if (fParam) {</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :       AliWarning(&quot;Could not access 'AcqStop' map from AltroConfig or invalid max time bine. fMaxTimeBinAllPads will be set from AliTPCParam.&quot;);</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :       fMaxTimeBinAllPads = fParam-&gt;GetMaxTBin();</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">    1014 </span>            :       // last fallback
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :       AliWarning(&quot;Could neither access 'Parameters' nor 'AcqStop' map from AltroConfig. fMaxTimeBinAllPads will be set to 1000.&quot;);</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :       fMaxTimeBinAllPads=1000;</span>
<span class="lineNum">    1017 </span>            :     }
<span class="lineNum">    1018 </span>            :   }
<span class="lineNum">    1019 </span>            : 
<span class="lineNum">    1020 </span><span class="lineCov">         12 :   AliInfo(TString::Format(&quot;fMaxTimeBinAllPads set to %d&quot;, fMaxTimeBinAllPads).Data());</span>
<a name="1021"><span class="lineNum">    1021 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span>            : void AliTPCcalibDB::MakeTree(const char * fileName, TObjArray * array, const char * mapFileName, AliTPCCalPad* outlierPad, Float_t ltmFraction) {
<span class="lineNum">    1024 </span>            :   /// Write a tree with all available information
<span class="lineNum">    1025 </span>            :   /// if mapFileName is specified, the Map information are also written to the tree
<span class="lineNum">    1026 </span>            :   /// pads specified in outlierPad are not used for calculating statistics
<span class="lineNum">    1027 </span>            :   ///  - the same function as AliTPCCalPad::MakeTree -
<span class="lineNum">    1028 </span>            : 
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :    AliTPCROC* tpcROCinstance = AliTPCROC::Instance();</span>
<span class="lineNum">    1030 </span>            : 
<span class="lineNum">    1031 </span>            :    TObjArray* mapIROCs = 0;
<span class="lineNum">    1032 </span>            :    TObjArray* mapOROCs = 0;
<span class="lineNum">    1033 </span>            :    TVectorF *mapIROCArray = 0;
<span class="lineNum">    1034 </span>            :    TVectorF *mapOROCArray = 0;
<span class="lineNum">    1035 </span>            :    Int_t mapEntries = 0;
<span class="lineNum">    1036 </span>            :    TString* mapNames = 0;
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :    if (mapFileName) {</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :       TFile mapFile(mapFileName, &quot;read&quot;);</span>
<span class="lineNum">    1040 </span>            : 
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :       TList* listOfROCs = mapFile.GetListOfKeys();</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :       mapEntries = listOfROCs-&gt;GetEntries()/2;</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :       mapIROCs = new TObjArray(mapEntries*2);</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :       mapOROCs = new TObjArray(mapEntries*2);</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :       mapIROCArray = new TVectorF[mapEntries];</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :       mapOROCArray = new TVectorF[mapEntries];</span>
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :       mapNames = new TString[mapEntries];</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :       for (Int_t ivalue = 0; ivalue &lt; mapEntries; ivalue++) {</span>
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :         TString nameROC(((TKey*)(listOfROCs-&gt;At(ivalue*2)))-&gt;GetName());</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :          nameROC.Remove(nameROC.Length()-4, 4);</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :          mapIROCs-&gt;AddAt((AliTPCCalROC*)mapFile.Get((nameROC + &quot;IROC&quot;).Data()), ivalue);</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :          mapOROCs-&gt;AddAt((AliTPCCalROC*)mapFile.Get((nameROC + &quot;OROC&quot;).Data()), ivalue);</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :          mapNames[ivalue].Append(nameROC);</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :       for (Int_t ivalue = 0; ivalue &lt; mapEntries; ivalue++) {</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :          mapIROCArray[ivalue].ResizeTo(tpcROCinstance-&gt;GetNChannels(0));</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :          mapOROCArray[ivalue].ResizeTo(tpcROCinstance-&gt;GetNChannels(36));</span>
<span class="lineNum">    1060 </span>            : 
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :          for (UInt_t ichannel = 0; ichannel &lt; tpcROCinstance-&gt;GetNChannels(0); ichannel++)</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :             (mapIROCArray[ivalue])[ichannel] = ((AliTPCCalROC*)(mapIROCs-&gt;At(ivalue)))-&gt;GetValue(ichannel);</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :          for (UInt_t ichannel = 0; ichannel &lt; tpcROCinstance-&gt;GetNChannels(36); ichannel++)</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :             (mapOROCArray[ivalue])[ichannel] = ((AliTPCCalROC*)(mapOROCs-&gt;At(ivalue)))-&gt;GetValue(ichannel);</span>
<span class="lineNum">    1065 </span>            :       }
<span class="lineNum">    1066 </span>            : 
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :    } //  if (mapFileName)</span>
<span class="lineNum">    1068 </span>            : 
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :    TTreeSRedirector cstream(fileName);</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :    Int_t arrayEntries = array-&gt;GetEntries();</span>
<span class="lineNum">    1071 </span>            : 
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :    TString* names = new TString[arrayEntries];</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :    for (Int_t ivalue = 0; ivalue &lt; arrayEntries; ivalue++)</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :       names[ivalue].Append(((AliTPCCalPad*)array-&gt;At(ivalue))-&gt;GetName());</span>
<span class="lineNum">    1075 </span>            : 
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :    for (UInt_t isector = 0; isector &lt; tpcROCinstance-&gt;GetNSectors(); isector++) {</span>
<span class="lineNum">    1077 </span>            :       //
<span class="lineNum">    1078 </span>            :       // get statistic for given sector
<span class="lineNum">    1079 </span>            :       //
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :       TVectorF median(arrayEntries);</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :       TVectorF mean(arrayEntries);</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :       TVectorF rms(arrayEntries);</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :       TVectorF ltm(arrayEntries);</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :       TVectorF ltmrms(arrayEntries);</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :       TVectorF medianWithOut(arrayEntries);</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :       TVectorF meanWithOut(arrayEntries);</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :       TVectorF rmsWithOut(arrayEntries);</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :       TVectorF ltmWithOut(arrayEntries);</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :       TVectorF ltmrmsWithOut(arrayEntries);</span>
<span class="lineNum">    1090 </span>            : 
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :       TVectorF *vectorArray = new TVectorF[arrayEntries];</span>
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :       for (Int_t ivalue = 0; ivalue &lt; arrayEntries; ivalue++)</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :          vectorArray[ivalue].ResizeTo(tpcROCinstance-&gt;GetNChannels(isector));</span>
<span class="lineNum">    1094 </span>            : 
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :       for (Int_t ivalue = 0; ivalue &lt; arrayEntries; ivalue++) {</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :          AliTPCCalPad* calPad = (AliTPCCalPad*) array-&gt;At(ivalue);</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :          AliTPCCalROC* calROC = calPad-&gt;GetCalROC(isector);</span>
<span class="lineNum">    1098 </span>            :          AliTPCCalROC* outlierROC = 0;
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :          if (outlierPad) outlierROC = outlierPad-&gt;GetCalROC(isector);</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :          if (calROC) {</span>
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :             median[ivalue] = calROC-&gt;GetMedian();</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :             mean[ivalue] = calROC-&gt;GetMean();</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :             rms[ivalue] = calROC-&gt;GetRMS();</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :             Double_t ltmrmsValue = 0;</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :             ltm[ivalue] = calROC-&gt;GetLTM(&amp;ltmrmsValue, ltmFraction);</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :             ltmrms[ivalue] = ltmrmsValue;</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :             if (outlierROC) {</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :                medianWithOut[ivalue] = calROC-&gt;GetMedian(outlierROC);</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :                meanWithOut[ivalue] = calROC-&gt;GetMean(outlierROC);</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :                rmsWithOut[ivalue] = calROC-&gt;GetRMS(outlierROC);</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :                ltmrmsValue = 0;</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :                ltmWithOut[ivalue] = calROC-&gt;GetLTM(&amp;ltmrmsValue, ltmFraction, outlierROC);</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :                ltmrmsWithOut[ivalue] = ltmrmsValue;</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    1116 </span>            :          else {
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :             median[ivalue] = 0.;</span>
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :             mean[ivalue] = 0.;</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :             rms[ivalue] = 0.;</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :             ltm[ivalue] = 0.;</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :             ltmrms[ivalue] = 0.;</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :             medianWithOut[ivalue] = 0.;</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :             meanWithOut[ivalue] = 0.;</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :             rmsWithOut[ivalue] = 0.;</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :             ltmWithOut[ivalue] = 0.;</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :             ltmrmsWithOut[ivalue] = 0.;</span>
<span class="lineNum">    1127 </span>            :          }
<span class="lineNum">    1128 </span>            :       }
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span>            :       //
<span class="lineNum">    1131 </span>            :       // fill vectors of variable per pad
<span class="lineNum">    1132 </span>            :       //
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :       TVectorF *posArray = new TVectorF[8];</span>
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :       for (Int_t ivalue = 0; ivalue &lt; 8; ivalue++)</span>
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :          posArray[ivalue].ResizeTo(tpcROCinstance-&gt;GetNChannels(isector));</span>
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :       Float_t posG[3] = {0};</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :       Float_t posL[3] = {0};</span>
<span class="lineNum">    1139 </span>            :       Int_t ichannel = 0;
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :       for (UInt_t irow = 0; irow &lt; tpcROCinstance-&gt;GetNRows(isector); irow++) {</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :          for (UInt_t ipad = 0; ipad &lt; tpcROCinstance-&gt;GetNPads(isector, irow); ipad++) {</span>
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :             tpcROCinstance-&gt;GetPositionLocal(isector, irow, ipad, posL);</span>
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :             tpcROCinstance-&gt;GetPositionGlobal(isector, irow, ipad, posG);</span>
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :             posArray[0][ichannel] = irow;</span>
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :             posArray[1][ichannel] = ipad;</span>
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :             posArray[2][ichannel] = posL[0];</span>
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :             posArray[3][ichannel] = posL[1];</span>
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :             posArray[4][ichannel] = posG[0];</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :             posArray[5][ichannel] = posG[1];</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :             posArray[6][ichannel] = (Int_t)(ipad - (Double_t)(tpcROCinstance-&gt;GetNPads(isector, irow))/2);</span>
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :             posArray[7][ichannel] = ichannel;</span>
<span class="lineNum">    1152 </span>            : 
<span class="lineNum">    1153 </span>            :             // loop over array containing AliTPCCalPads
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :             for (Int_t ivalue = 0; ivalue &lt; arrayEntries; ivalue++) {</span>
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :                AliTPCCalPad* calPad = (AliTPCCalPad*) array-&gt;At(ivalue);</span>
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :                AliTPCCalROC* calROC = calPad-&gt;GetCalROC(isector);</span>
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :                if (calROC)</span>
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :                   (vectorArray[ivalue])[ichannel] = calROC-&gt;GetValue(irow, ipad);</span>
<span class="lineNum">    1159 </span>            :                else
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :                   (vectorArray[ivalue])[ichannel] = 0;</span>
<span class="lineNum">    1161 </span>            :             }
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :             ichannel++;</span>
<span class="lineNum">    1163 </span>            :          }
<span class="lineNum">    1164 </span>            :       }
<span class="lineNum">    1165 </span>            : 
<span class="lineNum">    1166 </span><span class="lineNoCov">          0 :       cstream &lt;&lt; &quot;calPads&quot; &lt;&lt;</span>
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :          &quot;sector=&quot; &lt;&lt; isector;</span>
<span class="lineNum">    1168 </span>            : 
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :       for  (Int_t ivalue = 0; ivalue &lt; arrayEntries; ivalue++) {</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :          cstream &lt;&lt; &quot;calPads&quot; &lt;&lt;</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :             (Char_t*)((names[ivalue] + &quot;_Median=&quot;).Data()) &lt;&lt; median[ivalue] &lt;&lt;</span>
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 :             (Char_t*)((names[ivalue] + &quot;_Mean=&quot;).Data()) &lt;&lt; mean[ivalue] &lt;&lt;</span>
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :             (Char_t*)((names[ivalue] + &quot;_RMS=&quot;).Data()) &lt;&lt; rms[ivalue] &lt;&lt;</span>
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :             (Char_t*)((names[ivalue] + &quot;_LTM=&quot;).Data()) &lt;&lt; ltm[ivalue] &lt;&lt;</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :             (Char_t*)((names[ivalue] + &quot;_RMS_LTM=&quot;).Data()) &lt;&lt; ltmrms[ivalue];</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :          if (outlierPad) {</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :             cstream &lt;&lt; &quot;calPads&quot; &lt;&lt;</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :                (Char_t*)((names[ivalue] + &quot;_Median_OutlierCutted=&quot;).Data()) &lt;&lt; medianWithOut[ivalue] &lt;&lt;</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :                (Char_t*)((names[ivalue] + &quot;_Mean_OutlierCutted=&quot;).Data()) &lt;&lt; meanWithOut[ivalue] &lt;&lt;</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :                (Char_t*)((names[ivalue] + &quot;_RMS_OutlierCutted=&quot;).Data()) &lt;&lt; rmsWithOut[ivalue] &lt;&lt;</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :                (Char_t*)((names[ivalue] + &quot;_LTM_OutlierCutted=&quot;).Data()) &lt;&lt; ltmWithOut[ivalue] &lt;&lt;</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :                (Char_t*)((names[ivalue] + &quot;_RMS_LTM_OutlierCutted=&quot;).Data()) &lt;&lt; ltmrmsWithOut[ivalue];</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :          }</span>
<span class="lineNum">    1184 </span>            :       }
<span class="lineNum">    1185 </span>            : 
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :       for  (Int_t ivalue = 0; ivalue &lt; arrayEntries; ivalue++) {</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :          cstream &lt;&lt; &quot;calPads&quot; &lt;&lt;</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :             (Char_t*)((names[ivalue] + &quot;.=&quot;).Data()) &lt;&lt; &amp;vectorArray[ivalue];</span>
<span class="lineNum">    1189 </span>            :       }
<span class="lineNum">    1190 </span>            : 
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :       if (mapFileName) {</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :          for  (Int_t ivalue = 0; ivalue &lt; mapEntries; ivalue++) {</span>
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :             if (isector &lt; 36)</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :                cstream &lt;&lt; &quot;calPads&quot; &lt;&lt;</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :                   (Char_t*)((mapNames[ivalue] + &quot;.=&quot;).Data()) &lt;&lt; &amp;mapIROCArray[ivalue];</span>
<span class="lineNum">    1196 </span>            :             else
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :                cstream &lt;&lt; &quot;calPads&quot; &lt;&lt;</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                   (Char_t*)((mapNames[ivalue] + &quot;.=&quot;).Data()) &lt;&lt; &amp;mapOROCArray[ivalue];</span>
<span class="lineNum">    1199 </span>            :          }
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1201 </span>            : 
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :       cstream &lt;&lt; &quot;calPads&quot; &lt;&lt;</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :          &quot;row.=&quot; &lt;&lt; &amp;posArray[0] &lt;&lt;</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :          &quot;pad.=&quot; &lt;&lt; &amp;posArray[1] &lt;&lt;</span>
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :          &quot;lx.=&quot; &lt;&lt; &amp;posArray[2] &lt;&lt;</span>
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :          &quot;ly.=&quot; &lt;&lt; &amp;posArray[3] &lt;&lt;</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :          &quot;gx.=&quot; &lt;&lt; &amp;posArray[4] &lt;&lt;</span>
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :          &quot;gy.=&quot; &lt;&lt; &amp;posArray[5] &lt;&lt;</span>
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :          &quot;rpad.=&quot; &lt;&lt; &amp;posArray[6] &lt;&lt;</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :          &quot;channel.=&quot; &lt;&lt; &amp;posArray[7];</span>
<span class="lineNum">    1211 </span>            : 
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :       cstream &lt;&lt; &quot;calPads&quot; &lt;&lt;</span>
<span class="lineNum">    1213 </span>            :          &quot;\n&quot;;
<span class="lineNum">    1214 </span>            : 
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :       delete[] posArray;</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :       delete[] vectorArray;</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :    }</span>
<span class="lineNum">    1218 </span>            : 
<span class="lineNum">    1219 </span>            : 
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :    delete[] names;</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :    if (mapFileName) {</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :       delete mapIROCs;</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :       delete mapOROCs;</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :       delete[] mapIROCArray;</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :       delete[] mapOROCArray;</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :       delete[] mapNames;</span>
<span class="lineNum">    1227 </span>            :    }
<a name="1228"><span class="lineNum">    1228 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1229 </span>            : 
<span class="lineNum">    1230 </span>            : Int_t AliTPCcalibDB::GetRCUTriggerConfig() const
<span class="lineNum">    1231 </span>            : {
<span class="lineNum">    1232 </span>            :   /// return the RCU trigger configuration register
<span class="lineNum">    1233 </span>            : 
<span class="lineNum">    1234 </span><span class="lineCov">          6 :   TMap *map=GetRCUconfig();</span>
<span class="lineNum">    1235 </span><span class="lineCov">          6 :   if (!map) return -1;</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :   TVectorF *v=(TVectorF*)map-&gt;GetValue(&quot;TRGCONF_TRG_MODE&quot;);</span>
<span class="lineNum">    1237 </span>            :   Float_t mode=-1;
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;v-&gt;GetNrows(); ++i){</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :     Float_t newmode=v-&gt;GetMatrixArray()[i];</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :     if (newmode&gt;-1){</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :       if (mode&gt;-1&amp;&amp;newmode!=mode) AliWarning(&quot;Found different RCU trigger configurations!!!&quot;);</span>
<span class="lineNum">    1242 </span>            :       mode=newmode;
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1244 </span>            :   }
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :   return (Int_t)mode;</span>
<a name="1246"><span class="lineNum">    1246 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">    1247 </span>            : 
<span class="lineNum">    1248 </span>            : Bool_t AliTPCcalibDB::IsTrgL0()
<span class="lineNum">    1249 </span>            : {
<span class="lineNum">    1250 </span>            :   /// return if the FEE readout was triggered on L0
<span class="lineNum">    1251 </span>            : 
<span class="lineNum">    1252 </span><span class="lineCov">    5478384 :   if (fMode&lt;0) return kFALSE;</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :   return (fMode==1);</span>
<a name="1254"><span class="lineNum">    1254 </span><span class="lineCov">    1826128 : }</span></a>
<span class="lineNum">    1255 </span>            : 
<span class="lineNum">    1256 </span>            : Bool_t AliTPCcalibDB::IsTrgL1()
<span class="lineNum">    1257 </span>            : {
<span class="lineNum">    1258 </span>            :   /// return if the FEE readout was triggered on L1
<span class="lineNum">    1259 </span>            : 
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :   if (fMode&lt;0) return kFALSE;</span>
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :   return (fMode==0);</span>
<a name="1262"><span class="lineNum">    1262 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1263 </span>            : 
<span class="lineNum">    1264 </span>            : void AliTPCcalibDB::RegisterExB(Int_t index, Float_t bz, Bool_t bdelete){
<span class="lineNum">    1265 </span>            :   /// Register static ExB correction map
<span class="lineNum">    1266 </span>            :   /// index - registration index - used for visualization
<span class="lineNum">    1267 </span>            :   /// bz    - bz field in kGaus
<span class="lineNum">    1268 </span>            : 
<span class="lineNum">    1269 </span>            :   //  Float_t factor =  bz/(-5.);  // default b filed in Cheb with minus sign
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :   Float_t factor =  bz/(5.);  // default b filed in Cheb with minus sign</span>
<span class="lineNum">    1271 </span>            :                               // was chenged in the Revision ???? (Ruben can you add here number)
<span class="lineNum">    1272 </span>            : 
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :   AliMagF*   bmap = new AliMagF(&quot;MapsExB&quot;,&quot;MapsExB&quot;, factor,TMath::Sign(1.f,factor),AliMagF::k5kG);</span>
<span class="lineNum">    1274 </span>            : 
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :   AliTPCExBFirst *exb  = new  AliTPCExBFirst(bmap,0.88*2.6400e+04,50,50,50);</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :   AliTPCExB::SetInstance(exb);</span>
<span class="lineNum">    1277 </span>            : 
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :   if (bdelete){</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :     delete bmap;</span>
<span class="lineNum">    1280 </span>            :   }else{
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :     AliTPCExB::RegisterField(index,bmap);</span>
<span class="lineNum">    1282 </span>            :   }
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :   if (index&gt;=fgExBArray.GetEntries()) fgExBArray.Expand((index+1)*2+11);</span>
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :   fgExBArray.AddAt(exb,index);</span>
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 : }</span>
<a name="1286"><span class="lineNum">    1286 </span>            : </a>
<span class="lineNum">    1287 </span>            : 
<span class="lineNum">    1288 </span>            : AliTPCExB*    AliTPCcalibDB::GetExB(Float_t bz, Bool_t deleteB) {
<span class="lineNum">    1289 </span>            :   /// bz filed in KGaus not in tesla
<span class="lineNum">    1290 </span>            :   /// Get ExB correction map
<span class="lineNum">    1291 </span>            :   /// if doesn't exist - create it
<span class="lineNum">    1292 </span>            : 
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :   Int_t index = TMath::Nint(5+bz);</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :   if (index&gt;fgExBArray.GetEntries()) fgExBArray.Expand((index+1)*2+11);</span>
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :   if (!fgExBArray.At(index)) AliTPCcalibDB::RegisterExB(index,bz,deleteB);</span>
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :   return (AliTPCExB*)fgExBArray.At(index);</span>
<span class="lineNum">    1297 </span>            : }
<a name="1298"><span class="lineNum">    1298 </span>            : </a>
<span class="lineNum">    1299 </span>            : 
<span class="lineNum">    1300 </span>            : void  AliTPCcalibDB::SetExBField(Float_t bz){
<span class="lineNum">    1301 </span>            :   /// Set magnetic filed for ExB correction
<span class="lineNum">    1302 </span>            : 
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :   fExB = GetExB(bz,kFALSE);</span>
<a name="1304"><span class="lineNum">    1304 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span>            : void  AliTPCcalibDB::SetExBField(const AliMagF*   bmap){
<span class="lineNum">    1307 </span>            :   /// Set magnetic field for ExB correction
<span class="lineNum">    1308 </span>            : 
<span class="lineNum">    1309 </span><span class="lineCov">          6 :   AliTPCExBFirst *exb  = new  AliTPCExBFirst(bmap,0.88*2.6400e+04,50,50,50);</span>
<span class="lineNum">    1310 </span><span class="lineCov">          3 :   AliTPCExB::SetInstance(exb);</span>
<span class="lineNum">    1311 </span><span class="lineCov">          3 :   fExB=exb;</span>
<span class="lineNum">    1312 </span><span class="lineCov">          3 : }</span>
<span class="lineNum">    1313 </span>            : 
<a name="1314"><span class="lineNum">    1314 </span>            : </a>
<span class="lineNum">    1315 </span>            : 
<span class="lineNum">    1316 </span>            : void AliTPCcalibDB::UpdateRunInformations( Int_t run, Bool_t force){
<span class="lineNum">    1317 </span>            :   /// - &gt; Don't use it for reconstruction - Only for Calibration studies
<span class="lineNum">    1318 </span>            : 
<span class="lineNum">    1319 </span><span class="lineCov">     135225 :   if (run&lt;=0) return;</span>
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :   TObjString runstr(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :   fRun=run;</span>
<span class="lineNum">    1322 </span>            :   AliCDBEntry * entry = 0;
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :   if (run&gt;= fRunList.fN){</span>
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :     fRunList.Set(run*2+1);</span>
<span class="lineNum">    1325 </span>            :     //
<span class="lineNum">    1326 </span>            :     //
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :     fALTROConfigData-&gt;Expand(run*2+1);    // ALTRO configuration data</span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :     fPulserData-&gt;Expand(run*2+1);         // Calibration Pulser data</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :     fCEData-&gt;Expand(run*2+1);             // CE data</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :     if (!fTimeGainSplines) fTimeGainSplines = new TObjArray(run*2+1);</span>
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :     fTimeGainSplines-&gt;Expand(run*2+1); // Array of AliSplineFits: at 0 MIP position in</span>
<span class="lineNum">    1332 </span>            :   }
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :   if (fRunList[run]&gt;0 &amp;&amp;force==kFALSE) return;</span>
<span class="lineNum">    1334 </span>            : 
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :   fRunList[run]=1;  // sign as used</span>
<span class="lineNum">    1336 </span>            : 
<span class="lineNum">    1337 </span>            :   //
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :   entry = AliCDBManager::Instance()-&gt;Get(&quot;GRP/GRP/Data&quot;,run);</span>
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :   if (entry)  {</span>
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :     AliGRPObject * grpRun = dynamic_cast&lt;AliGRPObject*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :     if (!grpRun){</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :       TMap* map = dynamic_cast&lt;TMap*&gt;(entry-&gt;GetObject());</span>
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :       if (map){</span>
<span class="lineNum">    1344 </span>            :         //grpRun = new AliGRPObject;
<span class="lineNum">    1345 </span>            :         //grpRun-&gt;ReadValuesFromMap(map);
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :         grpRun =  MakeGRPObjectFromMap(map);</span>
<span class="lineNum">    1347 </span>            : 
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :         fGRPMaps.Add(new TObjString(runstr),map);</span>
<span class="lineNum">    1349 </span>            :       }
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :     fGRPArray.Add(new TObjString(runstr),(AliGRPObject*)grpRun-&gt;Clone());</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :   entry = AliCDBManager::Instance()-&gt;Get(&quot;TPC/Calib/Goofie&quot;,run);</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :   if (entry){</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :     fGoofieArray.Add(new TObjString(runstr),entry-&gt;GetObject());</span>
<span class="lineNum">    1356 </span>            :   }
<span class="lineNum">    1357 </span>            :   //
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span>            :   //
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :   entry = AliCDBManager::Instance()-&gt;Get(&quot;TPC/Calib/TimeGain&quot;,run);</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :   if (entry)  {</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :     fTimeGainSplinesArray.Add(new TObjString(runstr),entry-&gt;GetObject());</span>
<span class="lineNum">    1363 </span>            :   }else{
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry TimeGain&quot;);</span>
<span class="lineNum">    1365 </span>            :   }
<span class="lineNum">    1366 </span>            :   //
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :   entry = AliCDBManager::Instance()-&gt;Get(&quot;TPC/Calib/TimeDrift&quot;,run);</span>
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :   if (entry)  {</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :     TObjArray * timeArray = (TObjArray*)entry-&gt;GetObject();</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :     fDriftCorrectionArray.Add(new TObjString(runstr),entry-&gt;GetObject());</span>
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :     AliTPCCorrection * correctionTime = (AliTPCCorrection *)timeArray-&gt;FindObject(&quot;FitCorrectionTime&quot;);</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :     if (correctionTime &amp;&amp; fComposedCorrectionArray){</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :       correctionTime-&gt;Init();</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :       if (fComposedCorrectionArray-&gt;GetEntriesFast()&lt;4) fComposedCorrectionArray-&gt;Expand(40);</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :       fComposedCorrectionArray-&gt;AddAt(correctionTime,4); //add time dependent correction to the list of available corrections</span>
<span class="lineNum">    1376 </span>            :     }
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :   }else{</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :     AliFatal(&quot;TPC - Missing calibration entry TimeDrift&quot;);</span>
<span class="lineNum">    1379 </span>            :   }
<span class="lineNum">    1380 </span>            :   //
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :   entry = AliCDBManager::Instance()-&gt;Get(&quot;TPC/Calib/Temperature&quot;,run);</span>
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :   if (entry)  {</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :     fTemperatureArray.Add(new TObjString(runstr),entry-&gt;GetObject());</span>
<span class="lineNum">    1384 </span>            :   }
<span class="lineNum">    1385 </span>            : 
<span class="lineNum">    1386 </span>            :   // High voltage
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :   entry = AliCDBManager::Instance()-&gt;Get(&quot;TPC/Calib/HighVoltage&quot;,run);</span>
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :   if (!fVoltageArray.GetValue(runstr.GetName()) &amp;&amp; entry)  {</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :     fVoltageArray.Add(new TObjString(runstr),entry-&gt;GetObject());</span>
<span class="lineNum">    1390 </span>            :   }
<span class="lineNum">    1391 </span>            : 
<span class="lineNum">    1392 </span>            :   //apply fDButil filters
<span class="lineNum">    1393 </span>            : 
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :   fDButil-&gt;UpdateFromCalibDB();</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :   if (fTemperature) fDButil-&gt;FilterTemperature(fTemperature);</span>
<span class="lineNum">    1396 </span>            : 
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :   AliDCSSensor * press = GetPressureSensor(run,0);</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :   AliTPCSensorTempArray * temp = GetTemperatureSensor(run);</span>
<span class="lineNum">    1399 </span>            :   Bool_t accept=kTRUE;
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :   if (temp) {</span>
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :     accept = fDButil-&gt;FilterTemperature(temp)&gt;0.1;</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :   if (press) {</span>
<span class="lineNum">    1404 </span>            :     const Double_t kMinP=900.;
<span class="lineNum">    1405 </span>            :     const Double_t kMaxP=1050.;
<span class="lineNum">    1406 </span>            :     const Double_t kMaxdP=10.;
<span class="lineNum">    1407 </span>            :     const Double_t kSigmaCut=4.;
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :     fDButil-&gt;FilterSensor(press,kMinP,kMaxP,kMaxdP,kSigmaCut);</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :     if (press-&gt;GetFit()==0) accept=kFALSE;</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1411 </span>            : 
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :   if (press &amp;&amp; temp &amp;&amp;accept){</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :     AliTPCCalibVdrift * vdrift = new AliTPCCalibVdrift(temp, press,0);</span>
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :     fVdriftArray.Add(new TObjString(runstr),vdrift);</span>
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1416 </span>            : 
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :   fDButil-&gt;FilterCE(120., 3., 4.,0);</span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :   fDButil-&gt;FilterTracks(run, 10.,0);</span>
<span class="lineNum">    1419 </span>            : 
<span class="lineNum">    1420 </span><span class="lineCov">     135225 : }</span>
<a name="1421"><span class="lineNum">    1421 </span>            : </a>
<span class="lineNum">    1422 </span>            : 
<span class="lineNum">    1423 </span>            : Float_t AliTPCcalibDB::GetGain(Int_t sector, Int_t row, Int_t pad){
<span class="lineNum">    1424 </span>            :   /// Get Gain factor for given pad
<span class="lineNum">    1425 </span>            : 
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :   AliTPCCalPad *calPad = Instance()-&gt;fDedxGainFactor;;</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :   if (!calPad) return 0;</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :   return calPad-&gt;GetCalROC(sector)-&gt;GetValue(row,pad);</span>
<a name="1429"><span class="lineNum">    1429 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1430 </span>            : 
<span class="lineNum">    1431 </span>            : AliSplineFit* AliTPCcalibDB::GetVdriftSplineFit(const char* name, Int_t run){
<span class="lineNum">    1432 </span>            :   /// GetDrift velocity spline fit
<span class="lineNum">    1433 </span>            : 
<span class="lineNum">    1434 </span><span class="lineNoCov">          0 :   TObjArray *arr=GetTimeVdriftSplineRun(run);</span>
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :   if (!arr) return 0;</span>
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :   return dynamic_cast&lt;AliSplineFit*&gt;(arr-&gt;FindObject(name));</span>
<a name="1437"><span class="lineNum">    1437 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1438 </span>            : 
<span class="lineNum">    1439 </span>            : AliSplineFit* AliTPCcalibDB::CreateVdriftSplineFit(const char* graphName, Int_t run){
<span class="lineNum">    1440 </span>            :   /// create spline fit from the drift time graph in TimeDrift
<span class="lineNum">    1441 </span>            : 
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :   TObjArray *arr=GetTimeVdriftSplineRun(run);</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :   if (!arr) return 0;</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :   TGraph *graph=dynamic_cast&lt;TGraph*&gt;(arr-&gt;FindObject(graphName));</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :   if (!graph) return 0;</span>
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :   AliSplineFit *fit = new AliSplineFit();</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :   fit-&gt;SetGraph(graph);</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :   fit-&gt;SetMinPoints(graph-&gt;GetN()+1);</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :   fit-&gt;InitKnots(graph,2,0,0.001);</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :   fit-&gt;SplineFit(0);</span>
<span class="lineNum">    1451 </span>            :   return fit;
<a name="1452"><span class="lineNum">    1452 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1453 </span>            : 
<span class="lineNum">    1454 </span>            : AliGRPObject *AliTPCcalibDB::GetGRP(Int_t run){
<span class="lineNum">    1455 </span>            :   /// Get GRP object for given run
<span class="lineNum">    1456 </span>            : 
<span class="lineNum">    1457 </span><span class="lineCov">          9 :   AliGRPObject * grpRun = dynamic_cast&lt;AliGRPObject *&gt;((Instance()-&gt;fGRPArray).GetValue(Form(&quot;%i&quot;,run)));</span>
<span class="lineNum">    1458 </span><span class="lineCov">          3 :   if (!grpRun) {</span>
<span class="lineNum">    1459 </span><span class="lineCov">          3 :     Instance()-&gt;UpdateRunInformations(run);</span>
<span class="lineNum">    1460 </span><span class="lineCov">          6 :     grpRun = dynamic_cast&lt;AliGRPObject *&gt;(Instance()-&gt;fGRPArray.GetValue(Form(&quot;%i&quot;,run)));</span>
<span class="lineNum">    1461 </span><span class="lineCov">          6 :     if (!grpRun) return 0;</span>
<span class="lineNum">    1462 </span>            :   }
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :   return grpRun;</span>
<a name="1464"><span class="lineNum">    1464 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">    1465 </span>            : 
<span class="lineNum">    1466 </span>            : TMap *  AliTPCcalibDB::GetGRPMap(Int_t run){
<span class="lineNum">    1467 </span>            :   /// Get GRP map for given run
<span class="lineNum">    1468 </span>            : 
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :   TMap * grpRun = dynamic_cast&lt;TMap *&gt;((Instance()-&gt;fGRPMaps).GetValue(Form(&quot;%i&quot;,run)));</span>
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :   if (!grpRun) {</span>
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :     Instance()-&gt;UpdateRunInformations(run);</span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :     grpRun = dynamic_cast&lt;TMap *&gt;(Instance()-&gt;fGRPMaps.GetValue(Form(&quot;%i&quot;,run)));</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :     if (!grpRun) return 0;</span>
<span class="lineNum">    1474 </span>            :   }
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :   return grpRun;</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 : }</span>
<a name="1477"><span class="lineNum">    1477 </span>            : </a>
<span class="lineNum">    1478 </span>            : 
<span class="lineNum">    1479 </span>            : AliDCSSensor * AliTPCcalibDB::GetPressureSensor(Int_t run, Int_t type){
<span class="lineNum">    1480 </span>            :   /// Get Pressure sensor
<span class="lineNum">    1481 </span>            :   /// run  = run number
<span class="lineNum">    1482 </span>            :   /// type = 0 - Cavern pressure
<span class="lineNum">    1483 </span>            :   ///        1 - Suface pressure
<span class="lineNum">    1484 </span>            :   /// First try to get if trom map - if existing  (Old format of data storing)
<span class="lineNum">    1485 </span>            : 
<span class="lineNum">    1486 </span>            : 
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :   TMap *map = GetGRPMap(run);</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :   if (map){</span>
<span class="lineNum">    1489 </span>            :     AliDCSSensor * sensor = 0;
<span class="lineNum">    1490 </span>            :     TObject *osensor=0;
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :     if (type==0) osensor = ((*map)(&quot;fCavernPressure&quot;));</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :     if (type==1) osensor = ((*map)(&quot;fP2Pressure&quot;));</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :     sensor =dynamic_cast&lt;AliDCSSensor *&gt;(osensor);</span>
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 :     if (sensor) return sensor;</span>
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1496 </span>            :   //
<span class="lineNum">    1497 </span>            :   // If not map try to get it from the GRPObject
<span class="lineNum">    1498 </span>            :   //
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :   AliGRPObject * grpRun = dynamic_cast&lt;AliGRPObject *&gt;(fGRPArray.GetValue(Form(&quot;%i&quot;,run)));</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :   if (!grpRun) {</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :     UpdateRunInformations(run);</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :     grpRun = dynamic_cast&lt;AliGRPObject *&gt;(fGRPArray.GetValue(Form(&quot;%i&quot;,run)));</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :     if (!grpRun) return 0;</span>
<span class="lineNum">    1504 </span>            :   }
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :   AliDCSSensor * sensor = grpRun-&gt;GetCavernAtmosPressure();</span>
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :   if (type==1) sensor = grpRun-&gt;GetSurfaceAtmosPressure();</span>
<span class="lineNum">    1507 </span>            :   return sensor;
<a name="1508"><span class="lineNum">    1508 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1509 </span>            : 
<span class="lineNum">    1510 </span>            : AliTPCSensorTempArray * AliTPCcalibDB::GetTemperatureSensor(Int_t run){
<span class="lineNum">    1511 </span>            :   /// Get temperature sensor array
<span class="lineNum">    1512 </span>            : 
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :   AliTPCSensorTempArray * tempArray = (AliTPCSensorTempArray *)fTemperatureArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :   if (!tempArray) {</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :     UpdateRunInformations(run);</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :     tempArray = (AliTPCSensorTempArray *)fTemperatureArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :   return tempArray;</span>
<span class="lineNum">    1519 </span>            : }
<a name="1520"><span class="lineNum">    1520 </span>            : </a>
<span class="lineNum">    1521 </span>            : 
<span class="lineNum">    1522 </span>            : TObjArray * AliTPCcalibDB::GetTimeGainSplinesRun(Int_t run){
<span class="lineNum">    1523 </span>            :   /// Get temperature sensor array
<span class="lineNum">    1524 </span>            : 
<span class="lineNum">    1525 </span><span class="lineCov">       9742 :   TObjArray * gainSplines = (TObjArray *)fTimeGainSplinesArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1526 </span><span class="lineCov">       4871 :   if (!gainSplines) {</span>
<span class="lineNum">    1527 </span><span class="lineCov">       4871 :     UpdateRunInformations(run);</span>
<span class="lineNum">    1528 </span><span class="lineCov">       4871 :     gainSplines = (TObjArray *)fTimeGainSplinesArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1529 </span><span class="lineCov">       4871 :   }</span>
<span class="lineNum">    1530 </span><span class="lineCov">       4871 :   return gainSplines;</span>
<a name="1531"><span class="lineNum">    1531 </span>            : }</a>
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span>            : TObjArray * AliTPCcalibDB::GetTimeVdriftSplineRun(Int_t run){
<span class="lineNum">    1534 </span>            :   /// Get drift spline array
<span class="lineNum">    1535 </span>            : 
<span class="lineNum">    1536 </span><span class="lineCov">         28 :   TObjArray * driftSplines = (TObjArray *)fDriftCorrectionArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1537 </span><span class="lineCov">         14 :   if (!driftSplines) {</span>
<span class="lineNum">    1538 </span><span class="lineCov">         14 :     UpdateRunInformations(run);</span>
<span class="lineNum">    1539 </span><span class="lineCov">         14 :     driftSplines = (TObjArray *)fDriftCorrectionArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1540 </span><span class="lineCov">         14 :   }</span>
<span class="lineNum">    1541 </span><span class="lineCov">         14 :   return driftSplines;</span>
<a name="1542"><span class="lineNum">    1542 </span>            : }</a>
<span class="lineNum">    1543 </span>            : 
<span class="lineNum">    1544 </span>            : AliDCSSensorArray * AliTPCcalibDB::GetVoltageSensors(Int_t run){
<span class="lineNum">    1545 </span>            :   /// Get temperature sensor array
<span class="lineNum">    1546 </span>            : 
<span class="lineNum">    1547 </span><span class="lineCov">        438 :   AliDCSSensorArray * voltageArray = (AliDCSSensorArray *)fVoltageArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1548 </span><span class="lineCov">        219 :   if (!voltageArray) {</span>
<span class="lineNum">    1549 </span><span class="lineCov">        219 :     UpdateRunInformations(run);</span>
<span class="lineNum">    1550 </span><span class="lineCov">        219 :     voltageArray = (AliDCSSensorArray *)fVoltageArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1551 </span><span class="lineCov">        219 :   }</span>
<span class="lineNum">    1552 </span><span class="lineCov">        219 :   return voltageArray;</span>
<a name="1553"><span class="lineNum">    1553 </span>            : }</a>
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span>            : AliDCSSensorArray * AliTPCcalibDB::GetGoofieSensors(Int_t run){
<span class="lineNum">    1556 </span>            :   /// Get temperature sensor array
<span class="lineNum">    1557 </span>            : 
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :   AliDCSSensorArray * goofieArray = (AliDCSSensorArray *)fGoofieArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 :   if (!goofieArray) {</span>
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :     UpdateRunInformations(run);</span>
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :     goofieArray = (AliDCSSensorArray *)fGoofieArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1563 </span><span class="lineNoCov">          0 :   return goofieArray;</span>
<span class="lineNum">    1564 </span>            : }
<span class="lineNum">    1565 </span>            : 
<a name="1566"><span class="lineNum">    1566 </span>            : </a>
<span class="lineNum">    1567 </span>            : 
<span class="lineNum">    1568 </span>            : AliTPCCalibVdrift *     AliTPCcalibDB::GetVdrift(Int_t run){
<span class="lineNum">    1569 </span>            :   /// Get the interface to the the vdrift
<span class="lineNum">    1570 </span>            : 
<span class="lineNum">    1571 </span><span class="lineCov">     260224 :   AliTPCCalibVdrift  * vdrift = (AliTPCCalibVdrift*)fVdriftArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1572 </span><span class="lineCov">     130112 :   if (!vdrift) {</span>
<span class="lineNum">    1573 </span><span class="lineCov">     130112 :     UpdateRunInformations(run);</span>
<span class="lineNum">    1574 </span><span class="lineCov">     130112 :     vdrift= (AliTPCCalibVdrift*)fVdriftArray.GetValue(Form(&quot;%i&quot;,run));</span>
<span class="lineNum">    1575 </span><span class="lineCov">     130112 :   }</span>
<span class="lineNum">    1576 </span><span class="lineCov">     130112 :   return vdrift;</span>
<a name="1577"><span class="lineNum">    1577 </span>            : }</a>
<span class="lineNum">    1578 </span>            : 
<span class="lineNum">    1579 </span>            : Float_t AliTPCcalibDB::GetCEdriftTime(Int_t run, Int_t sector, Double_t timeStamp, Int_t *entries)
<span class="lineNum">    1580 </span>            : {
<span class="lineNum">    1581 </span>            :   /// GetCE drift time information for 'sector'
<span class="lineNum">    1582 </span>            :   /// sector 72 is the mean drift time of the A-Side
<span class="lineNum">    1583 </span>            :   /// sector 73 is the mean drift time of the C-Side
<span class="lineNum">    1584 </span>            :   /// it timestamp==-1 return mean value
<span class="lineNum">    1585 </span>            : 
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :   AliTPCcalibDB::Instance()-&gt;SetRun(run);</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :   TGraph *gr=AliTPCcalibDB::Instance()-&gt;GetCErocTgraph(sector);</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :   if (!gr||sector&lt;0||sector&gt;73) {</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :     if (entries) *entries=0;</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :     return 0.;</span>
<span class="lineNum">    1591 </span>            :   }
<span class="lineNum">    1592 </span>            :   Float_t val=0.;
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :   if (timeStamp==-1.){</span>
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :     val=gr-&gt;GetMean(2);</span>
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :   }else{</span>
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :     for (Int_t ipoint=0;ipoint&lt;gr-&gt;GetN();++ipoint){</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :       Double_t x,y;</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :       gr-&gt;GetPoint(ipoint,x,y);</span>
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :       if (x&lt;timeStamp) continue;</span>
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :       val=y;</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1603 </span>            :   }
<span class="lineNum">    1604 </span>            :   return val;
<a name="1605"><span class="lineNum">    1605 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1606 </span>            : 
<span class="lineNum">    1607 </span>            : Float_t AliTPCcalibDB::GetCEchargeTime(Int_t run, Int_t sector, Double_t timeStamp, Int_t *entries)
<span class="lineNum">    1608 </span>            : {
<span class="lineNum">    1609 </span>            :   /// GetCE mean charge for 'sector'
<span class="lineNum">    1610 </span>            :   /// it timestamp==-1 return mean value
<span class="lineNum">    1611 </span>            : 
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :   AliTPCcalibDB::Instance()-&gt;SetRun(run);</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :   TGraph *gr=AliTPCcalibDB::Instance()-&gt;GetCErocQgraph(sector);</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :   if (!gr||sector&lt;0||sector&gt;71) {</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :     if (entries) *entries=0;</span>
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :     return 0.;</span>
<span class="lineNum">    1617 </span>            :   }
<span class="lineNum">    1618 </span>            :   Float_t val=0.;
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :   if (timeStamp==-1.){</span>
<span class="lineNum">    1620 </span><span class="lineNoCov">          0 :     val=gr-&gt;GetMean(2);</span>
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :   }else{</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :     for (Int_t ipoint=0;ipoint&lt;gr-&gt;GetN();++ipoint){</span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :       Double_t x,y;</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :       gr-&gt;GetPoint(ipoint,x,y);</span>
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :       if (x&lt;timeStamp) continue;</span>
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :       val=y;</span>
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1629 </span>            :   }
<span class="lineNum">    1630 </span>            :   return val;
<a name="1631"><span class="lineNum">    1631 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1632 </span>            : 
<span class="lineNum">    1633 </span>            : Float_t AliTPCcalibDB::GetDCSSensorValue(AliDCSSensorArray *arr, Int_t timeStamp, const char * sensorName, Int_t sigDigits)
<span class="lineNum">    1634 </span>            : {
<span class="lineNum">    1635 </span>            :   /// Get Value for a DCS sensor 'sensorName', run 'run' at time 'timeStamp'
<span class="lineNum">    1636 </span>            : 
<span class="lineNum">    1637 </span>            :   Float_t val=0;
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :   const TString sensorNameString(sensorName);</span>
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :   AliDCSSensor *sensor = arr-&gt;GetSensor(sensorNameString);</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :   const Int_t startTime = Int_t(sensor-&gt;GetStartTime());</span>
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :   const Int_t endTime   = Int_t(sensor-&gt;GetEndTime());</span>
<span class="lineNum">    1642 </span>            : 
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :   if (!sensor) return val;</span>
<span class="lineNum">    1644 </span>            :   //use the dcs graph if possible
<span class="lineNum">    1645 </span><span class="lineNoCov">          0 :   TGraph *gr=sensor-&gt;GetGraph();</span>
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :   if (gr){</span>
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :     for (Int_t ipoint=0;ipoint&lt;gr-&gt;GetN();++ipoint){</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :       Double_t x,y;</span>
<span class="lineNum">    1649 </span><span class="lineNoCov">          0 :       gr-&gt;GetPoint(ipoint,x,y);</span>
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :       const Int_t time=TMath::Nint(startTime+x*3600.); //time in graph is hours</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :       if (time&lt;=timeStamp &amp;&amp; timeStamp&lt;=endTime) {</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :         val=y;</span>
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    1654 </span>            :       }
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1657 </span>            :     //if val is still 0, test if if the requested time is within 5min of the first/last
<span class="lineNum">    1658 </span>            :     //data point or start/end time of the sensor. If this is the case return the firs/last entry
<span class="lineNum">    1659 </span>            :     //the timestamps might not be syncronised for all calibration types, sometimes a 'pre'
<span class="lineNum">    1660 </span>            :     //and 'pos' period is requested. Especially to the HV this is not the case!
<span class="lineNum">    1661 </span>            :     //first point
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :     if (val==0 ){</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :       Double_t x,y;</span>
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 :       gr-&gt;GetPoint(0,x,y);</span>
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :       const Int_t time=TMath::Min(TMath::Nint(startTime+x*3600.), startTime); //time in graph is hours</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :       const Int_t dtime=time-timeStamp;</span>
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :       if ( (dtime&gt;=0) &amp;&amp; (dtime&lt;5*60) ) val=y;</span>
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1669 </span>            :     //last point
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :     if (val==0 ){</span>
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :       Double_t x,y;</span>
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :       gr-&gt;GetPoint(gr-&gt;GetN()-1,x,y);</span>
<span class="lineNum">    1673 </span><span class="lineNoCov">          0 :       const Int_t time=TMath::Max(TMath::Nint(startTime+x*3600.), endTime); //time in graph is hours</span>
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :       const Int_t dtime=timeStamp-time;</span>
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :       if ( (dtime&gt;=0) &amp;&amp; (dtime&lt;5*60) ) val=y;</span>
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1677 </span>            :   } else {
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 :     val=sensor-&gt;GetValue(timeStamp);</span>
<span class="lineNum">    1679 </span>            :   }
<span class="lineNum">    1680 </span><span class="lineNoCov">          0 :   if (sigDigits&gt;=0){</span>
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 :     val=(Float_t)TMath::Floor(val * TMath::Power(10., sigDigits) + .5) / TMath::Power(10., sigDigits);</span>
<span class="lineNum">    1682 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1683 </span>            :   return val;
<a name="1684"><span class="lineNum">    1684 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1685 </span>            : 
<span class="lineNum">    1686 </span>            : Float_t AliTPCcalibDB::GetDCSSensorMeanValue(AliDCSSensorArray *arr, const char * sensorName, Int_t sigDigits)
<span class="lineNum">    1687 </span>            : {
<span class="lineNum">    1688 </span>            :   /// Get mean Value for a DCS sensor 'sensorName' during run 'run'
<span class="lineNum">    1689 </span>            : 
<span class="lineNum">    1690 </span>            :   Float_t val=0;
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :   const TString sensorNameString(sensorName);</span>
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :   AliDCSSensor *sensor = arr-&gt;GetSensor(sensorNameString);</span>
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :   if (!sensor) return val;</span>
<span class="lineNum">    1694 </span>            : 
<span class="lineNum">    1695 </span>            :   //use dcs graph if it exists
<span class="lineNum">    1696 </span><span class="lineNoCov">          0 :   TGraph *gr=sensor-&gt;GetGraph();</span>
<span class="lineNum">    1697 </span><span class="lineNoCov">          0 :   if (gr){</span>
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :     val=gr-&gt;GetMean(2);</span>
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    1700 </span>            :     //if we don't have the dcs graph, try to get some meaningful information
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 :     if (!sensor-&gt;GetFit()) return val;</span>
<span class="lineNum">    1702 </span><span class="lineNoCov">          0 :     Int_t nKnots=sensor-&gt;GetFit()-&gt;GetKnots();</span>
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :     Double_t tMid=(sensor-&gt;GetEndTime()-sensor-&gt;GetStartTime())/2.;</span>
<span class="lineNum">    1704 </span><span class="lineNoCov">          0 :     for (Int_t iKnot=0;iKnot&lt;nKnots;++iKnot){</span>
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :       if (sensor-&gt;GetFit()-&gt;GetX()[iKnot]&gt;tMid/3600.) break;</span>
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :       val=(Float_t)sensor-&gt;GetFit()-&gt;GetY0()[iKnot];</span>
<span class="lineNum">    1707 </span>            :     }
<span class="lineNum">    1708 </span>            :   }
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :   if (sigDigits&gt;=0){</span>
<span class="lineNum">    1710 </span>            :     // val/=10;
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :     val=(Float_t)TMath::Floor(val * TMath::Power(10., sigDigits) + .5) / TMath::Power(10., sigDigits);</span>
<span class="lineNum">    1712 </span>            :     //    val*=10;
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1714 </span><span class="lineNoCov">          0 :   return val;</span>
<a name="1715"><span class="lineNum">    1715 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1716 </span>            : 
<span class="lineNum">    1717 </span>            : Int_t AliTPCcalibDB::GetMaskedChannelsFromCorrectionMaps(TBits maskedPads[72])
<span class="lineNum">    1718 </span>            : {
<span class="lineNum">    1719 </span>            :   // set bits for masked pads
<span class="lineNum">    1720 </span>            :   int nrowsMasked=0,npadsMasked=0,npadsTotMasked=0;
<span class="lineNum">    1721 </span><span class="lineCov">          6 :   if (AliTPCRecoParam::GetPrimaryDCACut()) {</span>
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 :     AliInfo(&quot;Special reconstruction for residuals extraction, masking is disabled&quot;);</span>
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">    1724 </span>            :   }
<span class="lineNum">    1725 </span><span class="lineCov">          3 :   AliCDBManager* man = AliCDBManager::Instance();</span>
<span class="lineNum">    1726 </span><span class="lineCov">          3 :   AliMagF* fld = (AliMagF*)TGeoGlobalMagField::Instance()-&gt;GetField();</span>
<span class="lineNum">    1727 </span><span class="lineCov">          9 :   if (!fld || !man-&gt;IsDefaultStorageSet() || man-&gt;GetRun()&lt;0) {</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :     AliFatal(&quot;OCDB of B-field is not initialized&quot;);</span>
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1730 </span><span class="lineCov">          3 :   const int run = GetRun();</span>
<span class="lineNum">    1731 </span>            :   // pick the recoparam matching to field (as low or high flux)
<span class="lineNum">    1732 </span><span class="lineCov">          3 :   AliRecoParam::EventSpecie_t spec = fld-&gt;GetBeamType()==AliMagF::kBeamTypeAA ? AliRecoParam::kHighMult : AliRecoParam::kLowMult;</span>
<span class="lineNum">    1733 </span>            :   AliTPCRecoParam* param = 0;
<span class="lineNum">    1734 </span>            :   int parID=0;
<span class="lineNum">    1735 </span><span class="lineCov">         11 :   while( (param=GetRecoParam(parID++)) ) { if (param-&gt;GetEventSpecie()&amp;spec) break;}</span>
<span class="lineNum">    1736 </span><span class="lineCov">          3 :   if (!param) AliFatal(&quot;Failed to extract recoparam&quot;);</span>
<span class="lineNum">    1737 </span>            :   //
<span class="lineNum">    1738 </span><span class="lineCov">          3 :   if (!param-&gt;GetUseCorrectionMap()) {</span>
<span class="lineNum">    1739 </span><span class="lineCov">          3 :     AliInfo(&quot;Residual correction maps are not used, no masking needed&quot;);</span>
<span class="lineNum">    1740 </span><span class="lineCov">          3 :     return 0;</span>
<span class="lineNum">    1741 </span>            :   }
<span class="lineNum">    1742 </span>            : 
<span class="lineNum">    1743 </span><span class="lineNoCov">          0 :   AliTPCTransform* transform = GetTransform();</span>
<span class="lineNum">    1744 </span><span class="lineNoCov">          0 :   if (!transform) AliFatal(&quot;Failed to extract Transform&quot;);</span>
<span class="lineNum">    1745 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentRecoParam(param);</span>
<span class="lineNum">    1746 </span>            : 
<span class="lineNum">    1747 </span>            :   // Load maps covering the run and build masks for disable full rows
<span class="lineNum">    1748 </span>            :   //
<span class="lineNum">    1749 </span>            :   // get reference map
<span class="lineNum">    1750 </span><span class="lineNoCov">          0 :   AliTPCChebCorr *mapRef = AliTPCTransform::LoadFieldDependendStaticCorrectionMap(kTRUE);</span>
<span class="lineNum">    1751 </span>            :   //
<span class="lineNum">    1752 </span>            :   // get correction maps
<span class="lineNum">    1753 </span><span class="lineNoCov">          0 :   TObjArray* arrMaps = AliTPCTransform::LoadCorrectionMaps(kFALSE);</span>
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :   arrMaps-&gt;SetOwner(kTRUE);</span>
<span class="lineNum">    1755 </span><span class="lineNoCov">          0 :   if (!((AliTPCChebCorr*)arrMaps-&gt;UncheckedAt(0))-&gt;GetTimeDependent()) {</span>
<span class="lineNum">    1756 </span>            :     // static maps are field-dependent
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :     AliTPCChebCorr* mapKeep = AliTPCTransform::LoadFieldDependendStaticCorrectionMap(kFALSE,arrMaps);</span>
<span class="lineNum">    1758 </span><span class="lineNoCov">          0 :     arrMaps-&gt;Remove((TObject*)mapKeep);</span>
<span class="lineNum">    1759 </span><span class="lineNoCov">          0 :     arrMaps-&gt;Delete();</span>
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :     arrMaps-&gt;Add(mapKeep);  // leave only maps needed for this run if the object was default one</span>
<span class="lineNum">    1761 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :   int nMaps = arrMaps-&gt;GetEntriesFast();</span>
<span class="lineNum">    1763 </span>            : 
<span class="lineNum">    1764 </span>            :   // mask full rows disabled in at least one of the maps
<span class="lineNum">    1765 </span><span class="lineNoCov">          0 :   TBits maskedRows[72];</span>
<span class="lineNum">    1766 </span><span class="lineNoCov">          0 :   for (int isec=72;isec--;) {  // flag masked full rows</span>
<span class="lineNum">    1767 </span><span class="lineNoCov">          0 :     mapRef-&gt;GetNMaskedRows(isec,&amp;maskedRows[isec]);</span>
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :     for (int imap=nMaps;imap--;) ((AliTPCChebCorr*)arrMaps-&gt;UncheckedAt(imap))-&gt;GetNMaskedRows(isec,&amp;maskedRows[isec]);</span>
<span class="lineNum">    1769 </span><span class="lineNoCov">          0 :     nrowsMasked += maskedRows[isec].CountBits();</span>
<span class="lineNum">    1770 </span>            :     //       printf(&quot;ROC%d masked %d rows\n&quot;,isec,maskedRows[isec].CountBits());
<span class="lineNum">    1771 </span>            :   }
<span class="lineNum">    1772 </span>            :   //
<span class="lineNum">    1773 </span>            :   // Now we need to mask individual pads where the assigned errors or distortions are too large
<span class="lineNum">    1774 </span>            :   // Since &gt;1 map may cover the run, we query all off them in their central time stamps
<span class="lineNum">    1775 </span>            :   // 1) Make sure the maps are unique for this run
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :   AliGRPObject* grp = GetGRP(run);</span>
<span class="lineNum">    1777 </span><span class="lineNoCov">          0 :   time_t tGRPmin = grp-&gt;GetTimeStart();</span>
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :   time_t tGRPmax = grp-&gt;GetTimeEnd();</span>
<span class="lineNum">    1779 </span><span class="lineNoCov">          0 :   time_t tCentGRP = (tGRPmin+tGRPmax)/2;  // center of the run according to grp</span>
<span class="lineNum">    1780 </span>            :   //
<span class="lineNum">    1781 </span><span class="lineNoCov">          0 :   time_t mapsT[nMaps];</span>
<span class="lineNum">    1782 </span><span class="lineNoCov">          0 :   for (int i=0;i&lt;nMaps;i++) {</span>
<span class="lineNum">    1783 </span><span class="lineNoCov">          0 :     mapsT[i] = ((AliTPCChebCorr*)arrMaps-&gt;At(i))-&gt;GetTimeStampCenter();</span>
<span class="lineNum">    1784 </span><span class="lineNoCov">          0 :     if (mapsT[i]&lt;tGRPmin || mapsT[i]&gt;tCentGRP) mapsT[i] = tCentGRP;</span>
<span class="lineNum">    1785 </span>            :   }
<span class="lineNum">    1786 </span>            :   //
<span class="lineNum">    1787 </span><span class="lineNoCov">          0 :   delete arrMaps; // we don't need anymore these maps, Transform will load according to time stamp</span>
<span class="lineNum">    1788 </span><span class="lineNoCov">          0 :   delete mapRef;</span>
<span class="lineNum">    1789 </span>            :   //
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 :   AliTPCROC* roc = AliTPCROC::Instance();</span>
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :   double testv[3]={0.};</span>
<span class="lineNum">    1792 </span>            : 
<span class="lineNum">    1793 </span>            :   // determine ranges for time-bin to be assigned to test cluster
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :   transform-&gt;SetCurrentTimeStamp(mapsT[0]);</span>
<span class="lineNum">    1795 </span>            :   const double tbinMin=0.,tbinMax=800.0;
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :   testv[0] = 62.; testv[1] = 0.; testv[2] = tbinMin; // at highest pad of IROC, min drift-time</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :   transform-&gt;Local2RotatedGlobal(0,testv);</span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :   const double ztMin = testv[2];</span>
<span class="lineNum">    1799 </span><span class="lineNoCov">          0 :   testv[0] = 62.; testv[1] = 0.; testv[2] = tbinMax; // at highest pad of IROC, max drift-time</span>
<span class="lineNum">    1800 </span><span class="lineNoCov">          0 :   transform-&gt;Local2RotatedGlobal(0,testv);</span>
<span class="lineNum">    1801 </span><span class="lineNoCov">          0 :   const double ztMax = testv[2];</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :   const double tzSlope = (tbinMax-tbinMin)/(ztMax-ztMin);</span>
<span class="lineNum">    1803 </span>            :   //
<span class="lineNum">    1804 </span>            :   // for test only &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
<span class="lineNum">    1805 </span>            :   //  double *mxdist = (double*)param-&gt;GetBadPadMaxDistXYZ();
<span class="lineNum">    1806 </span>            :   //  double *mxerr  = (double*)param-&gt;GetBadPadMaxErrYZ();
<span class="lineNum">    1807 </span>            :   //  mxdist[0] = 7.; mxdist[1] = 7.; mxdist[2] = 7.;
<span class="lineNum">    1808 </span>            :   //  mxerr[0] = 2.; mxerr[1] = 2.;
<span class="lineNum">    1809 </span>            :   // for test only &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :   const double *padMaxDist = param-&gt;GetBadPadMaxDistXYZ();</span>
<span class="lineNum">    1811 </span><span class="lineNoCov">          0 :   const double *padMaxErr  = param-&gt;GetBadPadMaxErrYZ();</span>
<span class="lineNum">    1812 </span><span class="lineNoCov">          0 :   const double maxErrY2    = padMaxErr[0]&gt;0 ? padMaxErr[0]*padMaxErr[0] : -1.;</span>
<span class="lineNum">    1813 </span><span class="lineNoCov">          0 :   const double maxErrZ2    = padMaxErr[1]&gt;0 ? padMaxErr[1]*padMaxErr[1] : -1.;</span>
<span class="lineNum">    1814 </span>            :   //
<span class="lineNum">    1815 </span>            :   const float tgLabTest = 0.4f; // check distortions/errors for this pad for high pt track at tgLab=0.4
<span class="lineNum">    1816 </span><span class="lineNoCov">          0 :   AliTPCclusterMI clProbe;</span>
<span class="lineNum">    1817 </span><span class="lineNoCov">          0 :   for (int imap=0;imap&lt;nMaps;imap++) {</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :     AliInfoF(&quot;Querying maps at time %ld&quot;,mapsT[imap]);</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :     transform-&gt;SetCurrentTimeStamp(mapsT[imap]);</span>
<span class="lineNum">    1820 </span>            :     //
<span class="lineNum">    1821 </span><span class="lineNoCov">          0 :     for (int isec=72;isec--;) {</span>
<span class="lineNum">    1822 </span><span class="lineNoCov">          0 :       TBits&amp; padStatus = maskedPads[isec];</span>
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :       for (int irow=roc-&gt;GetNRows(isec);irow--;) {</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :         const int npads = roc-&gt;GetNPads(isec, irow), channel0 = roc-&gt;GetRowIndexes(isec)[irow];</span>
<span class="lineNum">    1825 </span><span class="lineNoCov">          0 :         if (maskedRows[isec].TestBitNumber(irow)) { // full row is masked</span>
<span class="lineNum">    1826 </span><span class="lineNoCov">          0 :           for (int ipad=npads;ipad--;) padStatus.SetBitNumber(channel0+ipad); // mask all pads of the row</span>
<span class="lineNum">    1827 </span>            :           //printf(&quot;ROC%d masked %d pads of full row %d\n&quot;,isec,npads,irow);
<span class="lineNum">    1828 </span><span class="lineNoCov">          0 :           npadsTotMasked += npads;</span>
<span class="lineNum">    1829 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">    1830 </span>            :         }
<span class="lineNum">    1831 </span><span class="lineNoCov">          0 :         const double xRow = roc-&gt;GetPadRowRadii(isec,irow), zTest = xRow*tgLabTest;</span>
<span class="lineNum">    1832 </span><span class="lineNoCov">          0 :         const double tbinTest = tbinMin+(zTest-ztMin)*tzSlope; // define tbin at which distortions/errors will be evaluated</span>
<span class="lineNum">    1833 </span><span class="lineNoCov">          0 :         for (int ipad=npads;ipad--;) {</span>
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :           testv[0] = irow;</span>
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :           testv[1] = 0.5+ipad; // pad center</span>
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :           testv[2] = tbinTest;</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :           transform-&gt;Transform(testv,&amp;isec,0,0);</span>
<span class="lineNum">    1838 </span><span class="lineNoCov">          0 :           const float* clCorr    = transform-&gt;GetLastMapCorrection();</span>
<span class="lineNum">    1839 </span><span class="lineNoCov">          0 :           const float* clCorrRef = transform-&gt;GetLastMapCorrectionRef();</span>
<span class="lineNum">    1840 </span>            :           Bool_t bad = kFALSE;
<span class="lineNum">    1841 </span>            : 
<span class="lineNum">    1842 </span>            :           // does the distortion exceed max.allowed?
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 :           for (int dir=3;dir--;) if (padMaxDist[dir]&gt;0. &amp;&amp; TMath::Abs(clCorr[dir])&gt;padMaxDist[dir]) {</span>
<span class="lineNum">    1844 </span>            :             bad=kTRUE;
<span class="lineNum">    1845 </span>            :             // printf(&quot;ROC%2d row%2d pad%2d bad: distortion[%d]=%.2f exceeds threshold %.2f\n&quot;,
<span class="lineNum">    1846 </span>            :             //       isec,npads,irow,dir,clCorr[dir],padMaxDist[dir]);
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1848 </span>            :           }
<span class="lineNum">    1849 </span>            : 
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :           if (!bad) { // check errors assigned to such cluster</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :             clProbe.SetDetector(isec);</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :             clProbe.SetX(testv[0]); // store coordinates</span>
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :             clProbe.SetY(testv[1]);</span>
<span class="lineNum">    1854 </span><span class="lineNoCov">          0 :             clProbe.SetZ(testv[2]);</span>
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :             clProbe.SetDistortions(clCorr[0]-clCorrRef[0],clCorr[1]-clCorrRef[1],clCorr[2]-clCorrRef[2]);</span>
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :             clProbe.SetDistortionDispersion(clCorr[3]); // store distortions wrt ref and dispersion (ref already subtracted)</span>
<span class="lineNum">    1857 </span><span class="lineNoCov">          0 :             const double errY2 = transform-&gt;ErrY2Syst(&amp;clProbe,testv[1]/testv[0]);</span>
<span class="lineNum">    1858 </span><span class="lineNoCov">          0 :             const double errZ2 = transform-&gt;ErrZ2Syst(&amp;clProbe,testv[2]/testv[0]);</span>
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 :             if ( (maxErrY2&gt;0 &amp;&amp; errY2&gt;maxErrY2) || (maxErrZ2&gt;0 &amp;&amp; errZ2&gt;maxErrZ2) ) {</span>
<span class="lineNum">    1860 </span>            :               bad=kTRUE;
<span class="lineNum">    1861 </span>            :               //printf(&quot;ROC%2d row%2d pad%2d bad: Errors^2 for Y:%.3e or Z:%.3e exceeds threshold %.3e|%.3e\n&quot;,
<span class="lineNum">    1862 </span>            :               //     isec,npads,irow,errY2,errZ2,maxErrY2,maxErrZ2);
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1864 </span><span class="lineNoCov">          0 :           }</span>
<span class="lineNum">    1865 </span>            :           //
<span class="lineNum">    1866 </span><span class="lineNoCov">          0 :           if (bad) {</span>
<span class="lineNum">    1867 </span><span class="lineNoCov">          0 :             if (!padStatus.TestBitNumber(channel0+ipad)) npadsMasked++;</span>
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :             padStatus.SetBitNumber(channel0+ipad);</span>
<span class="lineNum">    1869 </span>            :           }
<span class="lineNum">    1870 </span>            :         } // loop over all pads of the row
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :       } // loop over all rows of the ROC</span>
<span class="lineNum">    1872 </span>            :     } // loop over all ROCs
<span class="lineNum">    1873 </span>            :   } // loop over all maps
<span class="lineNum">    1874 </span>            :   //
<span class="lineNum">    1875 </span><span class="lineNoCov">          0 :   npadsTotMasked += npadsMasked;</span>
<span class="lineNum">    1876 </span><span class="lineNoCov">          0 :   AliInfoF(&quot;masked %d pads (%d full padrows, %d individual pads)&quot;,</span>
<span class="lineNum">    1877 </span>            :            npadsTotMasked,nrowsMasked,npadsMasked);
<span class="lineNum">    1878 </span>            :   return npadsTotMasked;
<span class="lineNum">    1879 </span>            :   //
<a name="1880"><span class="lineNum">    1880 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">    1881 </span>            : 
<span class="lineNum">    1882 </span>            : Bool_t AliTPCcalibDB::IsDataTakingActive(time_t timeStamp)
<span class="lineNum">    1883 </span>            : {
<span class="lineNum">    1884 </span>            :   //
<span class="lineNum">    1885 </span>            :   // Check if the data taking is active.
<span class="lineNum">    1886 </span>            :   // This information ist based on the trigger scalers and calculated in UpdateChamberHighVoltageData() below.
<span class="lineNum">    1887 </span>            :   // in case there is no GRP object or no trigger scalers fGrRunState should be a NULL pointer
<span class="lineNum">    1888 </span>            :   //   if this is the case we assume by default that the data taking is active
<span class="lineNum">    1889 </span>            :   // NOTE: The logik changed. Before v5-06-03-79-gc804e5a we assumed by default the data taking is inactive
<span class="lineNum">    1890 </span>            :   //
<span class="lineNum">    1891 </span><span class="lineNoCov">          0 :   if (!fGrRunState) return kTRUE;</span>
<span class="lineNum">    1892 </span><span class="lineNoCov">          0 :   Double_t time=Double_t(timeStamp);</span>
<span class="lineNum">    1893 </span>            :   Int_t currentPoint=0;
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :   Bool_t currentVal=fGrRunState-&gt;GetY()[currentPoint]&gt;0.5;</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :   Bool_t retVal=currentVal;</span>
<span class="lineNum">    1896 </span><span class="lineNoCov">          0 :   Double_t currentTime=fGrRunState-&gt;GetX()[currentPoint];</span>
<span class="lineNum">    1897 </span>            : 
<span class="lineNum">    1898 </span><span class="lineNoCov">          0 :   while (time&gt;currentTime){</span>
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :     retVal=currentVal;</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :     if (currentPoint==fGrRunState-&gt;GetN()) break;</span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :     currentVal=fGrRunState-&gt;GetY()[currentPoint]&gt;0.5;</span>
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :     currentTime=fGrRunState-&gt;GetX()[currentPoint];</span>
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :     ++currentPoint;</span>
<span class="lineNum">    1904 </span>            :   }
<span class="lineNum">    1905 </span>            : 
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :   return retVal;</span>
<a name="1907"><span class="lineNum">    1907 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1908 </span>            : 
<span class="lineNum">    1909 </span>            : void AliTPCcalibDB::UpdateChamberHighVoltageData()
<span class="lineNum">    1910 </span>            : {
<span class="lineNum">    1911 </span>            :   /// set chamber high voltage data
<span class="lineNum">    1912 </span>            :   /// 1. Robust median (sampling the hv graphs over time)
<span class="lineNum">    1913 </span>            :   /// 2. Current nominal voltages (nominal voltage corrected for common HV offset)
<span class="lineNum">    1914 </span>            :   /// 3. Fraction of good HV values over time (deviation from robust median)
<span class="lineNum">    1915 </span>            :   /// 4. HV status, based on the above
<span class="lineNum">    1916 </span>            :   ///
<span class="lineNum">    1917 </span>            :   /// List of required OCDB Entries
<span class="lineNum">    1918 </span>            :   /// - GRP/GRP/Data
<span class="lineNum">    1919 </span>            :   /// - GRP/CTP/Scalers
<span class="lineNum">    1920 </span>            :   /// - TPC/Calib/HighVoltage
<span class="lineNum">    1921 </span>            :   /// - TPC/Calib/Parameters
<span class="lineNum">    1922 </span>            : 
<span class="lineNum">    1923 </span>            :   // reset active run state graph
<span class="lineNum">    1924 </span><span class="lineCov">          6 :   delete fGrRunState;</span>
<span class="lineNum">    1925 </span><span class="lineCov">          3 :   fGrRunState=0x0;</span>
<span class="lineNum">    1926 </span>            : 
<span class="lineNum">    1927 </span>            :   // start and end time of the run
<span class="lineNum">    1928 </span><span class="lineCov">          3 :   const Int_t run=GetRun();</span>
<span class="lineNum">    1929 </span><span class="lineCov">          3 :   if (run&lt;0) return;</span>
<span class="lineNum">    1930 </span>            : 
<span class="lineNum">    1931 </span>            :   // if no valid run information - return
<span class="lineNum">    1932 </span><span class="lineCov">          3 :   AliGRPObject* grp = GetGRP(run);</span>
<span class="lineNum">    1933 </span><span class="lineCov">          6 :   if (!grp) return;</span>
<span class="lineNum">    1934 </span>            : 
<span class="lineNum">    1935 </span><span class="lineNoCov">          0 :   const Int_t startTimeGRP = grp-&gt;GetTimeStart();</span>
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 :   const Int_t stopTimeGRP  = grp-&gt;GetTimeEnd();</span>
<span class="lineNum">    1937 </span>            : 
<span class="lineNum">    1938 </span>            :   //
<span class="lineNum">    1939 </span>            :   // In case we use a generated GRP we cannot make use of the start time and end time information
<span class="lineNum">    1940 </span>            :   // therefore we cannot calculate proper HV information and will skip this
<span class="lineNum">    1941 </span>            :   //
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :   if (startTimeGRP==0 &amp;&amp; stopTimeGRP==0) {</span>
<span class="lineNum">    1943 </span><span class="lineNoCov">          0 :     AliWarning(&quot;Using a generated GRP with 'GetTimeStart()' and 'GetTimeEnd()' == 0. Cannot calculate HV information.&quot;);</span>
<span class="lineNum">    1944 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1945 </span>            :   }
<span class="lineNum">    1946 </span>            : 
<span class="lineNum">    1947 </span>            :   //
<span class="lineNum">    1948 </span>            :   // check active state by analysing the scalers
<span class="lineNum">    1949 </span>            :   //
<span class="lineNum">    1950 </span>            :   // initialise graph with active running
<span class="lineNum">    1951 </span>            :   const char* hltMode = NULL;
<span class="lineNum">    1952 </span><span class="lineNoCov">          0 :   hltMode = gSystem-&gt;Getenv(&quot;HLT_ONLINE_MODE&quot;);</span>
<span class="lineNum">    1953 </span>            : 
<span class="lineNum">    1954 </span>            :   AliCDBEntry *entry = NULL;
<span class="lineNum">    1955 </span><span class="lineNoCov">          0 :   if (!hltMode) entry = GetCDBEntry(&quot;GRP/CTP/Scalers&quot;);</span>
<span class="lineNum">    1956 </span><span class="lineNoCov">          0 :   if (entry) {</span>
<span class="lineNum">    1957 </span>            :     // entry-&gt;SetOwner(kTRUE);
<span class="lineNum">    1958 </span><span class="lineNoCov">          0 :     AliTriggerRunScalers *sca = (AliTriggerRunScalers*)entry-&gt;GetObject();</span>
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :     Int_t nchannels = sca-&gt;GetNumClasses(); // number of scaler channels (i.e. trigger classes)</span>
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :     Int_t npoints = sca-&gt;GetScalersRecords()-&gt;GetEntries(); // number of samples</span>
<span class="lineNum">    1961 </span>            : 
<span class="lineNum">    1962 </span>            :     // require at least two points from the scalers.
<span class="lineNum">    1963 </span><span class="lineNoCov">          0 :     if (npoints&gt;1) {</span>
<span class="lineNum">    1964 </span><span class="lineNoCov">          0 :       fGrRunState=new TGraph;</span>
<span class="lineNum">    1965 </span><span class="lineNoCov">          0 :       fGrRunState-&gt;SetPoint(fGrRunState-&gt;GetN(),Double_t(startTimeGRP)-.001,0);</span>
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :       fGrRunState-&gt;SetPoint(fGrRunState-&gt;GetN(),Double_t(startTimeGRP),1);</span>
<span class="lineNum">    1967 </span>            :       ULong64_t lastSum=0;
<span class="lineNum">    1968 </span>            :       Double_t timeLast=Double_t(startTimeGRP);
<span class="lineNum">    1969 </span>            :       Bool_t active=kTRUE;
<span class="lineNum">    1970 </span><span class="lineNoCov">          0 :       for (int i=0; i&lt;npoints; i++) {</span>
<span class="lineNum">    1971 </span><span class="lineNoCov">          0 :         AliTriggerScalersRecord *rec = (AliTriggerScalersRecord *) sca-&gt;GetScalersRecord(i);</span>
<span class="lineNum">    1972 </span><span class="lineNoCov">          0 :         Double_t time = ((AliTimeStamp*) rec-&gt;GetTimeStamp())-&gt;GetSeconds();</span>
<span class="lineNum">    1973 </span>            :         // check if time is inside the grp times. For dummy scaler entries the time might be compatible with 0
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 :         if ( time&lt;startTimeGRP || time&gt;stopTimeGRP ){</span>
<span class="lineNum">    1975 </span><span class="lineNoCov">          0 :           AliWarning(Form(&quot;Time of scaler record %d: %.0f is outside the GRP times (%d, %d). Skipping this record.&quot;, i, time, startTimeGRP, stopTimeGRP));</span>
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">    1977 </span>            :         }
<span class="lineNum">    1978 </span>            :         ULong64_t sum=0;
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 :         for (int j=0; j&lt;nchannels; j++) sum += ((AliTriggerScalers*) rec-&gt;GetTriggerScalers()-&gt;At(j))-&gt;GetL2CA();</span>
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :         if (TMath::Abs(time-timeLast)&lt;.001 &amp;&amp; sum==lastSum ) continue;</span>
<span class="lineNum">    1981 </span><span class="lineNoCov">          0 :         if (active &amp;&amp; sum==lastSum){</span>
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :           fGrRunState-&gt;SetPoint(fGrRunState-&gt;GetN(),timeLast-.01,1);</span>
<span class="lineNum">    1983 </span><span class="lineNoCov">          0 :           fGrRunState-&gt;SetPoint(fGrRunState-&gt;GetN(),timeLast,0);</span>
<span class="lineNum">    1984 </span>            :           active=kFALSE;
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :         } else if (!active &amp;&amp; sum&gt;lastSum ){</span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :           fGrRunState-&gt;SetPoint(fGrRunState-&gt;GetN(),timeLast-.01,0);</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :           fGrRunState-&gt;SetPoint(fGrRunState-&gt;GetN(),timeLast,1);</span>
<span class="lineNum">    1988 </span>            :           active=kTRUE;
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1990 </span>            :         lastSum=sum;
<span class="lineNum">    1991 </span>            :         timeLast=time;
<span class="lineNum">    1992 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    1993 </span><span class="lineNoCov">          0 :       fGrRunState-&gt;SetPoint(fGrRunState-&gt;GetN(),Double_t(stopTimeGRP),active);</span>
<span class="lineNum">    1994 </span><span class="lineNoCov">          0 :       fGrRunState-&gt;SetPoint(fGrRunState-&gt;GetN(),Double_t(stopTimeGRP)+.001,0);</span>
<span class="lineNum">    1995 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">    1996 </span><span class="lineNoCov">          0 :       AliWarning(&quot;Only one entry found in the trigger scalers. Most probably this is a dummy entry. Scaler information will not be used!&quot;);</span>
<span class="lineNum">    1997 </span>            :     }
<span class="lineNum">    1998 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1999 </span>            : 
<span class="lineNum">    2000 </span>            : 
<span class="lineNum">    2001 </span>            :   // reset all values
<span class="lineNum">    2002 </span><span class="lineNoCov">          0 :   for (Int_t iROC=0;iROC&lt;72;++iROC) {</span>
<span class="lineNum">    2003 </span><span class="lineNoCov">          0 :     fChamberHVmedian[iROC]       = -1;</span>
<span class="lineNum">    2004 </span><span class="lineNoCov">          0 :     fChamberHVgoodFraction[iROC] = 0.;</span>
<span class="lineNum">    2005 </span><span class="lineNoCov">          0 :     fCurrentNominalVoltage[iROC] = -999.;</span>
<span class="lineNum">    2006 </span><span class="lineNoCov">          0 :     fChamberHVStatus[iROC]       = kFALSE;</span>
<span class="lineNum">    2007 </span>            :   }
<span class="lineNum">    2008 </span>            : 
<span class="lineNum">    2009 </span><span class="lineNoCov">          0 :   AliDCSSensorArray* voltageArray = GetVoltageSensors(run);</span>
<span class="lineNum">    2010 </span><span class="lineNoCov">          0 :   if (!voltageArray) {</span>
<span class="lineNum">    2011 </span><span class="lineNoCov">          0 :     AliError(&quot;Voltage Array missing. Cannot calculate HV information!&quot;);</span>
<span class="lineNum">    2012 </span><span class="lineNoCov">          0 :     AliError(&quot; -&gt; Check OCDB entry: 'TPC/Calib/HighVoltage'&quot;);</span>
<span class="lineNum">    2013 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    2014 </span>            :   }
<span class="lineNum">    2015 </span>            : 
<span class="lineNum">    2016 </span>            :   // max HV diffs before a chamber is masked
<span class="lineNum">    2017 </span><span class="lineNoCov">          0 :   const Float_t maxVdiff      = fParam-&gt;GetMaxVoltageDeviation();</span>
<span class="lineNum">    2018 </span><span class="lineNoCov">          0 :   const Float_t maxDipVoltage = fParam-&gt;GetMaxDipVoltage();</span>
<span class="lineNum">    2019 </span><span class="lineNoCov">          0 :   const Float_t maxFracHVbad  = fParam-&gt;GetMaxFractionHVbad();</span>
<span class="lineNum">    2020 </span>            : 
<span class="lineNum">    2021 </span>            :   const Int_t samplingPeriod=1;
<span class="lineNum">    2022 </span>            : 
<span class="lineNum">    2023 </span>            :   // array with sampled voltages
<span class="lineNum">    2024 </span><span class="lineNoCov">          0 :   const Int_t maxSamples=(stopTimeGRP-startTimeGRP)/samplingPeriod + 10*samplingPeriod;</span>
<span class="lineNum">    2025 </span><span class="lineNoCov">          0 :   Float_t *vSampled = new Float_t[maxSamples];</span>
<span class="lineNum">    2026 </span>            : 
<span class="lineNum">    2027 </span>            :   // deviation of the median from the nominal voltage
<span class="lineNum">    2028 </span><span class="lineNoCov">          0 :   Double_t chamberMedianDeviation[72]={0.};</span>
<span class="lineNum">    2029 </span>            : 
<span class="lineNum">    2030 </span><span class="lineNoCov">          0 :   for (Int_t iROC=0; iROC&lt;72; ++iROC){</span>
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :     chamberMedianDeviation[iROC]=0.;</span>
<span class="lineNum">    2032 </span><span class="lineNoCov">          0 :     TString sensorName=&quot;&quot;;</span>
<span class="lineNum">    2033 </span>            :     Char_t sideName='A';
<span class="lineNum">    2034 </span><span class="lineNoCov">          0 :     if ((iROC/18)%2==1) sideName='C';</span>
<span class="lineNum">    2035 </span><span class="lineNoCov">          0 :     if (iROC&lt;36) sensorName=Form(&quot;TPC_ANODE_I_%c%02d_VMEAS&quot;,sideName,iROC%18);</span>
<span class="lineNum">    2036 </span><span class="lineNoCov">          0 :     else        sensorName=Form(&quot;TPC_ANODE_O_%c%02d_0_VMEAS&quot;,sideName,iROC%18);</span>
<span class="lineNum">    2037 </span>            : 
<span class="lineNum">    2038 </span><span class="lineNoCov">          0 :     AliDCSSensor *sensor = voltageArray-&gt;GetSensor(sensorName);</span>
<span class="lineNum">    2039 </span>            : 
<span class="lineNum">    2040 </span><span class="lineNoCov">          0 :     fHVsensors[iROC]=sensor;</span>
<span class="lineNum">    2041 </span><span class="lineNoCov">          0 :     if (!sensor) continue;</span>
<span class="lineNum">    2042 </span>            : 
<span class="lineNum">    2043 </span>            :     Int_t nPointsSampled=0;
<span class="lineNum">    2044 </span>            : 
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :     TGraph *gr=sensor-&gt;GetGraph();</span>
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 :     if ( gr &amp;&amp; gr-&gt;GetN()&gt;0 ){</span>
<span class="lineNum">    2047 </span>            :       //1. sample voltage over time
<span class="lineNum">    2048 </span>            :       //   get a robust median
<span class="lineNum">    2049 </span>            :       //   buffer sampled voltages
<span class="lineNum">    2050 </span>            : 
<span class="lineNum">    2051 </span>            :       // current sampling time
<span class="lineNum">    2052 </span>            :       Int_t time=startTimeGRP;
<span class="lineNum">    2053 </span>            : 
<span class="lineNum">    2054 </span>            :       // input graph sampling point
<span class="lineNum">    2055 </span><span class="lineNoCov">          0 :       const Int_t nGraph=gr-&gt;GetN();</span>
<span class="lineNum">    2056 </span>            :       Int_t pointGraph=0;
<span class="lineNum">    2057 </span>            : 
<span class="lineNum">    2058 </span>            :       //initialise graph information
<span class="lineNum">    2059 </span>            :       Int_t timeGraph=stopTimeGRP;
<span class="lineNum">    2060 </span><span class="lineNoCov">          0 :       if (gr-&gt;GetN()&gt;1) timeGraph=TMath::Nint(gr-&gt;GetX()[pointGraph+1]*3600+sensor-&gt;GetStartTime());</span>
<span class="lineNum">    2061 </span><span class="lineNoCov">          0 :       Double_t sampledHV=gr-&gt;GetY()[pointGraph++];</span>
<span class="lineNum">    2062 </span>            : 
<span class="lineNum">    2063 </span><span class="lineNoCov">          0 :       while (time&lt;stopTimeGRP){</span>
<span class="lineNum">    2064 </span><span class="lineNoCov">          0 :         while (timeGraph&lt;=time &amp;&amp; pointGraph+1&lt;nGraph){</span>
<span class="lineNum">    2065 </span><span class="lineNoCov">          0 :           timeGraph=TMath::Nint(gr-&gt;GetX()[pointGraph+1]*3600+sensor-&gt;GetStartTime());</span>
<span class="lineNum">    2066 </span><span class="lineNoCov">          0 :           sampledHV=gr-&gt;GetY()[pointGraph++];</span>
<span class="lineNum">    2067 </span>            :         }
<span class="lineNum">    2068 </span><span class="lineNoCov">          0 :         time+=samplingPeriod;</span>
<span class="lineNum">    2069 </span><span class="lineNoCov">          0 :         if (!IsDataTakingActive(time-samplingPeriod)) continue;</span>
<span class="lineNum">    2070 </span><span class="lineNoCov">          0 :         vSampled[nPointsSampled++]=sampledHV;</span>
<span class="lineNum">    2071 </span>            :       }
<span class="lineNum">    2072 </span>            : 
<span class="lineNum">    2073 </span><span class="lineNoCov">          0 :       if (nPointsSampled&lt;1) continue;</span>
<span class="lineNum">    2074 </span>            : 
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 :       fChamberHVmedian[iROC]=TMath::Median(nPointsSampled,vSampled);</span>
<span class="lineNum">    2076 </span><span class="lineNoCov">          0 :       chamberMedianDeviation[iROC]=fChamberHVmedian[iROC]-fParam-&gt;GetNominalVoltage(iROC);</span>
<span class="lineNum">    2077 </span>            : 
<span class="lineNum">    2078 </span>            :       //2. calculate good HV fraction
<span class="lineNum">    2079 </span>            :       Int_t ngood=0;
<span class="lineNum">    2080 </span><span class="lineNoCov">          0 :       for (Int_t ipoint=0; ipoint&lt;nPointsSampled; ++ipoint) {</span>
<span class="lineNum">    2081 </span><span class="lineNoCov">          0 :         if (TMath::Abs(vSampled[ipoint]-fChamberHVmedian[iROC])&lt;maxDipVoltage) ++ngood;</span>
<span class="lineNum">    2082 </span>            :       }
<span class="lineNum">    2083 </span>            : 
<span class="lineNum">    2084 </span><span class="lineNoCov">          0 :       fChamberHVgoodFraction[iROC]=Float_t(ngood)/Float_t(nPointsSampled);</span>
<span class="lineNum">    2085 </span><span class="lineNoCov">          0 :     } else if (!gr &amp;&amp; !sensor-&gt;GetFit() ){</span>
<span class="lineNum">    2086 </span>            :       // This is an exception handling.
<span class="lineNum">    2087 </span>            :       // It was observed that for some rund in the 2010 data taking no HV info is available
<span class="lineNum">    2088 </span>            :       //    for some sectors. However they were active. So take care about this
<span class="lineNum">    2089 </span><span class="lineNoCov">          0 :       fChamberHVmedian[iROC]       = fParam-&gt;GetNominalVoltage(iROC);</span>
<span class="lineNum">    2090 </span><span class="lineNoCov">          0 :       fChamberHVgoodFraction[iROC] = 1.;</span>
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot;ROC %d detected without HV Splines and HV graph. Will set median HV to nominal voltage&quot;,iROC));</span>
<span class="lineNum">    2092 </span>            :     } else {
<span class="lineNum">    2093 </span><span class="lineNoCov">          0 :       AliError(Form(&quot;No Graph or graph without points found for HV sensor of ROC %d&quot;,iROC));</span>
<span class="lineNum">    2094 </span>            :     }
<span class="lineNum">    2095 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2096 </span>            : 
<span class="lineNum">    2097 </span><span class="lineNoCov">          0 :   delete [] vSampled;</span>
<span class="lineNum">    2098 </span>            :   vSampled=0x0;
<span class="lineNum">    2099 </span>            : 
<span class="lineNum">    2100 </span>            :   // get median deviation from all chambers (detect e.g. -50V)
<span class="lineNum">    2101 </span><span class="lineNoCov">          0 :   const Double_t medianIROC=TMath::Median( 36, chamberMedianDeviation );</span>
<span class="lineNum">    2102 </span><span class="lineNoCov">          0 :   const Double_t medianOROC=TMath::Median( 36, chamberMedianDeviation+36 );</span>
<span class="lineNum">    2103 </span>            : 
<span class="lineNum">    2104 </span>            :   // Define current default voltages
<span class="lineNum">    2105 </span><span class="lineNoCov">          0 :   for (Int_t iROC=0;iROC&lt;72/*AliTPCCalPad::kNsec*/;++iROC){</span>
<span class="lineNum">    2106 </span><span class="lineNoCov">          0 :     const Float_t averageDeviation=(iROC&lt;36)?medianIROC:medianOROC;</span>
<span class="lineNum">    2107 </span><span class="lineNoCov">          0 :     fCurrentNominalVoltage[iROC]=fParam-&gt;GetNominalVoltage(iROC)+averageDeviation;</span>
<span class="lineNum">    2108 </span>            :   }
<span class="lineNum">    2109 </span>            : 
<span class="lineNum">    2110 </span>            :   //
<span class="lineNum">    2111 </span>            :   // Check HV status
<span class="lineNum">    2112 </span>            :   //
<span class="lineNum">    2113 </span>            :   Int_t nbad=0;
<span class="lineNum">    2114 </span><span class="lineNoCov">          0 :   for (Int_t iROC=0;iROC&lt;72/*AliTPCCalPad::kNsec*/;++iROC){</span>
<span class="lineNum">    2115 </span><span class="lineNoCov">          0 :     fChamberHVStatus[iROC]=kTRUE;</span>
<span class="lineNum">    2116 </span><span class="lineNoCov">          0 :     const Float_t averageDeviation=(iROC&lt;36)?medianIROC:medianOROC;</span>
<span class="lineNum">    2117 </span>            : 
<span class="lineNum">    2118 </span>            :     //a. Deviation of median from current nominal voltage
<span class="lineNum">    2119 </span>            :     //   allow larger than nominal voltages
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :     if (fCurrentNominalVoltage[iROC]-fChamberHVmedian[iROC] &gt;  maxVdiff) {</span>
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot;Low voltage detected for ROC %2d&quot;,iROC));</span>
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot; -&gt; Based on nominal voltage: %.2f + averge deviation: %.2f = current nominal voltage: %.2f - meadian HV: %.2f &gt; max diff: %.2f&quot;,</span>
<span class="lineNum">    2123 </span>            :                       fParam-&gt;GetNominalVoltage(iROC), averageDeviation, fCurrentNominalVoltage[iROC], fChamberHVmedian[iROC],  maxVdiff));
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :       AliWarning(&quot; -&gt; Check consistent usage of HV information in the OCDB entry: 'TPC/Calib/HighVoltage'&quot;);</span>
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :       AliWarning(&quot; -&gt;                 and the nominal voltages in the OCDB entry: 'TPC/Calib/Parameters'&quot;);</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :       fChamberHVStatus[iROC]=kFALSE;</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2128 </span>            : 
<span class="lineNum">    2129 </span>            :     //b. Fraction of bad hv values
<span class="lineNum">    2130 </span><span class="lineNoCov">          0 :     if ( 1.-fChamberHVgoodFraction[iROC] &gt; maxFracHVbad ) {</span>
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot;Large fraction of low HV readings detected in ROC %2d: %.2f &gt; %.2f&quot;,</span>
<span class="lineNum">    2132 </span>            :                    iROC, 1.-fChamberHVgoodFraction[iROC], maxFracHVbad));
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :       AliWarning(Form(&quot; -&gt; Based on HV information from OCDB entry: 'TPC/Calib/HighVoltage' with median voltage: %.2f&quot;, fChamberHVmedian[iROC]));</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :       AliWarning(     &quot; -&gt; Check with experts if this chamber had HV problems in this run&quot;);</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :       fChamberHVStatus[iROC]=kFALSE;</span>
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2137 </span>            : 
<span class="lineNum">    2138 </span><span class="lineNoCov">          0 :     if (!fChamberHVStatus[iROC]) {</span>
<span class="lineNum">    2139 </span><span class="lineNoCov">          0 :       ++nbad;</span>
<span class="lineNum">    2140 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2141 </span>            :   }
<span class="lineNum">    2142 </span>            : 
<span class="lineNum">    2143 </span>            :   // check if all chamber are off
<span class="lineNum">    2144 </span><span class="lineNoCov">          0 :   if (nbad==72) {</span>
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :     AliFatal(&quot;Something went wrong in the chamber HV status calculation. Check warning messages above. All chambers would be deactivated!&quot;);</span>
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 :   }</span>
<a name="2147"><span class="lineNum">    2147 </span><span class="lineCov">          3 : }</span></a>
<span class="lineNum">    2148 </span>            : 
<span class="lineNum">    2149 </span>            : Float_t AliTPCcalibDB::GetChamberHighVoltage(Int_t run, Int_t sector, Int_t timeStamp, Int_t sigDigits, Bool_t current) {
<span class="lineNum">    2150 </span>            :   /// return the chamber HV for given run and time: 0-35 IROC, 36-72 OROC
<span class="lineNum">    2151 </span>            :   /// if timeStamp==-1 return mean value
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span>            :   Float_t val=0;
<span class="lineNum">    2154 </span><span class="lineCov">        216 :   TString sensorName=&quot;&quot;;</span>
<span class="lineNum">    2155 </span><span class="lineCov">        216 :   TTimeStamp stamp(timeStamp);</span>
<span class="lineNum">    2156 </span><span class="lineCov">        432 :   AliDCSSensorArray* voltageArray = AliTPCcalibDB::Instance()-&gt;GetVoltageSensors(run);</span>
<span class="lineNum">    2157 </span><span class="lineCov">        432 :   if (!voltageArray || (sector&lt;0) || (sector&gt;71)) return val;</span>
<span class="lineNum">    2158 </span>            :   Char_t sideName='A';
<span class="lineNum">    2159 </span><span class="lineNoCov">          0 :   if ((sector/18)%2==1) sideName='C';</span>
<span class="lineNum">    2160 </span><span class="lineNoCov">          0 :   if (sector&lt;36){</span>
<span class="lineNum">    2161 </span>            :     //IROC
<span class="lineNum">    2162 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_ANODE_I_%c%02d_VMEAS&quot;,sideName,sector%18);</span>
<span class="lineNum">    2163 </span>            :   }else{
<span class="lineNum">    2164 </span>            :     //OROC
<span class="lineNum">    2165 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_ANODE_O_%c%02d_0_VMEAS&quot;,sideName,sector%18);</span>
<span class="lineNum">    2166 </span>            :   }
<span class="lineNum">    2167 </span><span class="lineNoCov">          0 :   if (current){</span>
<span class="lineNum">    2168 </span><span class="lineNoCov">          0 :     if (sector&lt;36){</span>
<span class="lineNum">    2169 </span>            :       //IROC
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :       sensorName=Form(&quot;TPC_ANODE_I_%c%02d_IMEAS&quot;,sideName,sector%18);</span>
<span class="lineNum">    2171 </span>            :     }else{
<span class="lineNum">    2172 </span>            :       //OROC
<span class="lineNum">    2173 </span><span class="lineNoCov">          0 :       sensorName=Form(&quot;TPC_ANODE_O_%c%02d_0_IMEAS&quot;,sideName,sector%18);</span>
<span class="lineNum">    2174 </span>            :     }
<span class="lineNum">    2175 </span>            : 
<span class="lineNum">    2176 </span>            :   }
<span class="lineNum">    2177 </span><span class="lineNoCov">          0 :   if (timeStamp==-1){</span>
<span class="lineNum">    2178 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorMeanValue(voltageArray, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2179 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    2180 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorValue(voltageArray, timeStamp, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2181 </span>            :   }
<a name="2182"><span class="lineNum">    2182 </span>            :   return val;</a>
<span class="lineNum">    2183 </span><span class="lineCov">        216 : }</span>
<span class="lineNum">    2184 </span>            : Float_t AliTPCcalibDB::GetSkirtVoltage(Int_t run, Int_t sector, Int_t timeStamp, Int_t sigDigits)
<span class="lineNum">    2185 </span>            : {
<span class="lineNum">    2186 </span>            :   /// Get the skirt voltage for 'run' at 'timeStamp' and 'sector': 0-35 IROC, 36-72 OROC
<span class="lineNum">    2187 </span>            :   /// type corresponds to the following: 0 - IROC A-Side; 1 - IROC C-Side; 2 - OROC A-Side; 3 - OROC C-Side
<span class="lineNum">    2188 </span>            :   /// if timeStamp==-1 return the mean value for the run
<span class="lineNum">    2189 </span>            : 
<span class="lineNum">    2190 </span>            :   Float_t val=0;
<span class="lineNum">    2191 </span><span class="lineNoCov">          0 :   TString sensorName=&quot;&quot;;</span>
<span class="lineNum">    2192 </span><span class="lineNoCov">          0 :   TTimeStamp stamp(timeStamp);</span>
<span class="lineNum">    2193 </span><span class="lineNoCov">          0 :   AliDCSSensorArray* voltageArray = AliTPCcalibDB::Instance()-&gt;GetVoltageSensors(run);</span>
<span class="lineNum">    2194 </span><span class="lineNoCov">          0 :   if (!voltageArray || (sector&lt;0) || (sector&gt;71)) return val;</span>
<span class="lineNum">    2195 </span>            :   Char_t sideName='A';
<span class="lineNum">    2196 </span><span class="lineNoCov">          0 :   if ((sector/18)%2==1) sideName='C';</span>
<span class="lineNum">    2197 </span><span class="lineNoCov">          0 :   sensorName=Form(&quot;TPC_SKIRT_%c_VMEAS&quot;,sideName);</span>
<span class="lineNum">    2198 </span><span class="lineNoCov">          0 :   if (timeStamp==-1){</span>
<span class="lineNum">    2199 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorMeanValue(voltageArray, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2200 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    2201 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorValue(voltageArray, timeStamp, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2202 </span>            :   }
<span class="lineNum">    2203 </span>            :   return val;
<a name="2204"><span class="lineNum">    2204 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2205 </span>            : 
<span class="lineNum">    2206 </span>            : Float_t AliTPCcalibDB::GetCoverVoltage(Int_t run, Int_t sector, Int_t timeStamp, Int_t sigDigits)
<span class="lineNum">    2207 </span>            : {
<span class="lineNum">    2208 </span>            :   /// Get the cover voltage for run 'run' at time 'timeStamp'
<span class="lineNum">    2209 </span>            :   /// type corresponds to the following: 0 - IROC A-Side; 1 - IROC C-Side; 2 - OROC A-Side; 3 - OROC C-Side
<span class="lineNum">    2210 </span>            :   /// if timeStamp==-1 return the mean value for the run
<span class="lineNum">    2211 </span>            : 
<span class="lineNum">    2212 </span>            :   Float_t val=0;
<span class="lineNum">    2213 </span><span class="lineNoCov">          0 :   TString sensorName=&quot;&quot;;</span>
<span class="lineNum">    2214 </span><span class="lineNoCov">          0 :   TTimeStamp stamp(timeStamp);</span>
<span class="lineNum">    2215 </span><span class="lineNoCov">          0 :   AliDCSSensorArray* voltageArray = AliTPCcalibDB::Instance()-&gt;GetVoltageSensors(run);</span>
<span class="lineNum">    2216 </span><span class="lineNoCov">          0 :   if (!voltageArray || (sector&lt;0) || (sector&gt;71)) return val;</span>
<span class="lineNum">    2217 </span>            :   Char_t sideName='A';
<span class="lineNum">    2218 </span><span class="lineNoCov">          0 :   if ((sector/18)%2==1) sideName='C';</span>
<span class="lineNum">    2219 </span><span class="lineNoCov">          0 :   if (sector&lt;36){</span>
<span class="lineNum">    2220 </span>            :     //IROC
<span class="lineNum">    2221 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_COVER_I_%c_VMEAS&quot;,sideName);</span>
<span class="lineNum">    2222 </span>            :   }else{
<span class="lineNum">    2223 </span>            :     //OROC
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_COVER_O_%c_VMEAS&quot;,sideName);</span>
<span class="lineNum">    2225 </span>            :   }
<span class="lineNum">    2226 </span><span class="lineNoCov">          0 :   if (timeStamp==-1){</span>
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorMeanValue(voltageArray, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2228 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    2229 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorValue(voltageArray, timeStamp, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2230 </span>            :   }
<span class="lineNum">    2231 </span>            :   return val;
<a name="2232"><span class="lineNum">    2232 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2233 </span>            : 
<span class="lineNum">    2234 </span>            : Float_t AliTPCcalibDB::GetGGoffsetVoltage(Int_t run, Int_t sector, Int_t timeStamp, Int_t sigDigits)
<span class="lineNum">    2235 </span>            : {
<span class="lineNum">    2236 </span>            :   /// Get the GG offset voltage for run 'run' at time 'timeStamp'
<span class="lineNum">    2237 </span>            :   /// type corresponds to the following: 0 - IROC A-Side; 1 - IROC C-Side; 2 - OROC A-Side; 3 - OROC C-Side
<span class="lineNum">    2238 </span>            :   /// if timeStamp==-1 return the mean value for the run
<span class="lineNum">    2239 </span>            : 
<span class="lineNum">    2240 </span>            :   Float_t val=0;
<span class="lineNum">    2241 </span><span class="lineNoCov">          0 :   TString sensorName=&quot;&quot;;</span>
<span class="lineNum">    2242 </span><span class="lineNoCov">          0 :   TTimeStamp stamp(timeStamp);</span>
<span class="lineNum">    2243 </span><span class="lineNoCov">          0 :   AliDCSSensorArray* voltageArray = AliTPCcalibDB::Instance()-&gt;GetVoltageSensors(run);</span>
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :   if (!voltageArray || (sector&lt;0) || (sector&gt;71)) return val;</span>
<span class="lineNum">    2245 </span>            :   Char_t sideName='A';
<span class="lineNum">    2246 </span><span class="lineNoCov">          0 :   if ((sector/18)%2==1) sideName='C';</span>
<span class="lineNum">    2247 </span><span class="lineNoCov">          0 :   if (sector&lt;36){</span>
<span class="lineNum">    2248 </span>            :     //IROC
<span class="lineNum">    2249 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_GATE_I_%c_OFF_VMEAS&quot;,sideName);</span>
<span class="lineNum">    2250 </span>            :   }else{
<span class="lineNum">    2251 </span>            :     //OROC
<span class="lineNum">    2252 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_GATE_O_%c_OFF_VMEAS&quot;,sideName);</span>
<span class="lineNum">    2253 </span>            :   }
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 :   if (timeStamp==-1){</span>
<span class="lineNum">    2255 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorMeanValue(voltageArray, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2256 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    2257 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorValue(voltageArray, timeStamp, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2258 </span>            :   }
<span class="lineNum">    2259 </span>            :   return val;
<a name="2260"><span class="lineNum">    2260 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2261 </span>            : 
<span class="lineNum">    2262 </span>            : Float_t AliTPCcalibDB::GetGGnegVoltage(Int_t run, Int_t sector, Int_t timeStamp, Int_t sigDigits)
<span class="lineNum">    2263 </span>            : {
<span class="lineNum">    2264 </span>            :   /// Get the GG offset voltage for run 'run' at time 'timeStamp'
<span class="lineNum">    2265 </span>            :   /// type corresponds to the following: 0 - IROC A-Side; 1 - IROC C-Side; 2 - OROC A-Side; 3 - OROC C-Side
<span class="lineNum">    2266 </span>            :   /// if timeStamp==-1 return the mean value for the run
<span class="lineNum">    2267 </span>            : 
<span class="lineNum">    2268 </span>            :   Float_t val=0;
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :   TString sensorName=&quot;&quot;;</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :   TTimeStamp stamp(timeStamp);</span>
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 :   AliDCSSensorArray* voltageArray = AliTPCcalibDB::Instance()-&gt;GetVoltageSensors(run);</span>
<span class="lineNum">    2272 </span><span class="lineNoCov">          0 :   if (!voltageArray || (sector&lt;0) || (sector&gt;71)) return val;</span>
<span class="lineNum">    2273 </span>            :   Char_t sideName='A';
<span class="lineNum">    2274 </span><span class="lineNoCov">          0 :   if ((sector/18)%2==1) sideName='C';</span>
<span class="lineNum">    2275 </span><span class="lineNoCov">          0 :   if (sector&lt;36){</span>
<span class="lineNum">    2276 </span>            :     //IROC
<span class="lineNum">    2277 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_GATE_I_%c_NEG_VMEAS&quot;,sideName);</span>
<span class="lineNum">    2278 </span>            :   }else{
<span class="lineNum">    2279 </span>            :     //OROC
<span class="lineNum">    2280 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_GATE_O_%c_NEG_VMEAS&quot;,sideName);</span>
<span class="lineNum">    2281 </span>            :   }
<span class="lineNum">    2282 </span><span class="lineNoCov">          0 :   if (timeStamp==-1){</span>
<span class="lineNum">    2283 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorMeanValue(voltageArray, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2284 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    2285 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorValue(voltageArray, timeStamp, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2286 </span>            :   }
<span class="lineNum">    2287 </span>            :   return val;
<a name="2288"><span class="lineNum">    2288 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2289 </span>            : 
<span class="lineNum">    2290 </span>            : Float_t AliTPCcalibDB::GetGGposVoltage(Int_t run, Int_t sector, Int_t timeStamp, Int_t sigDigits)
<span class="lineNum">    2291 </span>            : {
<span class="lineNum">    2292 </span>            :   /// Get the GG offset voltage for run 'run' at time 'timeStamp'
<span class="lineNum">    2293 </span>            :   /// type corresponds to the following: 0 - IROC A-Side; 1 - IROC C-Side; 2 - OROC A-Side; 3 - OROC C-Side
<span class="lineNum">    2294 </span>            :   /// if timeStamp==-1 return the mean value for the run
<span class="lineNum">    2295 </span>            : 
<span class="lineNum">    2296 </span>            :   Float_t val=0;
<span class="lineNum">    2297 </span><span class="lineNoCov">          0 :   TString sensorName=&quot;&quot;;</span>
<span class="lineNum">    2298 </span><span class="lineNoCov">          0 :   TTimeStamp stamp(timeStamp);</span>
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :   AliDCSSensorArray* voltageArray = AliTPCcalibDB::Instance()-&gt;GetVoltageSensors(run);</span>
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :   if (!voltageArray || (sector&lt;0) || (sector&gt;71)) return val;</span>
<span class="lineNum">    2301 </span>            :   Char_t sideName='A';
<span class="lineNum">    2302 </span><span class="lineNoCov">          0 :   if ((sector/18)%2==1) sideName='C';</span>
<span class="lineNum">    2303 </span><span class="lineNoCov">          0 :   if (sector&lt;36){</span>
<span class="lineNum">    2304 </span>            :     //IROC
<span class="lineNum">    2305 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_GATE_I_%c_POS_VMEAS&quot;,sideName);</span>
<span class="lineNum">    2306 </span>            :   }else{
<span class="lineNum">    2307 </span>            :     //OROC
<span class="lineNum">    2308 </span><span class="lineNoCov">          0 :     sensorName=Form(&quot;TPC_GATE_O_%c_POS_VMEAS&quot;,sideName);</span>
<span class="lineNum">    2309 </span>            :   }
<span class="lineNum">    2310 </span><span class="lineNoCov">          0 :   if (timeStamp==-1){</span>
<span class="lineNum">    2311 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorMeanValue(voltageArray, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2312 </span><span class="lineNoCov">          0 :   } else {</span>
<span class="lineNum">    2313 </span><span class="lineNoCov">          0 :     val=AliTPCcalibDB::GetDCSSensorValue(voltageArray, timeStamp, sensorName.Data(),sigDigits);</span>
<span class="lineNum">    2314 </span>            :   }
<span class="lineNum">    2315 </span>            :   return val;
<a name="2316"><span class="lineNum">    2316 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2317 </span>            : 
<span class="lineNum">    2318 </span>            : Float_t AliTPCcalibDB::GetPressure(Int_t timeStamp, Int_t run, Int_t type){
<span class="lineNum">    2319 </span>            :   /// GetPressure for given time stamp and runt
<span class="lineNum">    2320 </span>            : 
<span class="lineNum">    2321 </span><span class="lineNoCov">          0 :   TTimeStamp stamp(timeStamp);</span>
<span class="lineNum">    2322 </span><span class="lineNoCov">          0 :   AliDCSSensor * sensor = Instance()-&gt;GetPressureSensor(run,type);</span>
<span class="lineNum">    2323 </span><span class="lineNoCov">          0 :   if (!sensor) return 0;</span>
<span class="lineNum">    2324 </span><span class="lineNoCov">          0 :   return sensor-&gt;GetValue(stamp);</span>
<a name="2325"><span class="lineNum">    2325 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2326 </span>            : 
<span class="lineNum">    2327 </span>            : Float_t AliTPCcalibDB::GetL3Current(Int_t run, Int_t statType){
<span class="lineNum">    2328 </span>            :   /// return L3 current
<span class="lineNum">    2329 </span>            :   /// stat type is: AliGRPObject::Stats: kMean = 0, kTruncMean = 1, kMedian = 2, kSDMean = 3, kSDMedian = 4
<span class="lineNum">    2330 </span>            : 
<span class="lineNum">    2331 </span>            :   Float_t current=-1;
<span class="lineNum">    2332 </span><span class="lineNoCov">          0 :   AliGRPObject *grp=AliTPCcalibDB::GetGRP(run);</span>
<span class="lineNum">    2333 </span><span class="lineNoCov">          0 :   if (grp) current=grp-&gt;GetL3Current((AliGRPObject::Stats)statType);</span>
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :   return current;</span>
<a name="2335"><span class="lineNum">    2335 </span>            : }</a>
<span class="lineNum">    2336 </span>            : 
<span class="lineNum">    2337 </span>            : Float_t AliTPCcalibDB::GetBz(Int_t run){
<span class="lineNum">    2338 </span>            :   /// calculate BZ in T from L3 current
<span class="lineNum">    2339 </span>            : 
<span class="lineNum">    2340 </span>            :   Float_t bz=-1;
<span class="lineNum">    2341 </span><span class="lineNoCov">          0 :   Float_t current=AliTPCcalibDB::GetL3Current(run);</span>
<span class="lineNum">    2342 </span><span class="lineNoCov">          0 :   if (current&gt;-1) bz=5*current/30000.*.1;</span>
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :   return bz;</span>
<a name="2344"><span class="lineNum">    2344 </span>            : }</a>
<span class="lineNum">    2345 </span>            : 
<span class="lineNum">    2346 </span>            : Char_t  AliTPCcalibDB::GetL3Polarity(Int_t run) {
<span class="lineNum">    2347 </span>            :   /// get l3 polarity from GRP
<span class="lineNum">    2348 </span>            : 
<span class="lineNum">    2349 </span>            :   Char_t pol=-100;
<span class="lineNum">    2350 </span><span class="lineNoCov">          0 :   AliGRPObject *grp=AliTPCcalibDB::GetGRP(run);</span>
<span class="lineNum">    2351 </span><span class="lineNoCov">          0 :   if (grp) pol=grp-&gt;GetL3Polarity();</span>
<span class="lineNum">    2352 </span><span class="lineNoCov">          0 :   return pol;</span>
<a name="2353"><span class="lineNum">    2353 </span>            : }</a>
<span class="lineNum">    2354 </span>            : 
<span class="lineNum">    2355 </span>            : TString AliTPCcalibDB::GetRunType(Int_t run){
<span class="lineNum">    2356 </span>            :   /// return run type from grp
<span class="lineNum">    2357 </span>            : 
<span class="lineNum">    2358 </span>            : //   TString type(&quot;UNKNOWN&quot;);
<span class="lineNum">    2359 </span><span class="lineNoCov">          0 :   AliGRPObject *grp=AliTPCcalibDB::GetGRP(run);</span>
<span class="lineNum">    2360 </span><span class="lineNoCov">          0 :   if (grp) return grp-&gt;GetRunType();</span>
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :   return &quot;UNKNOWN&quot;;</span>
<a name="2362"><span class="lineNum">    2362 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2363 </span>            : 
<span class="lineNum">    2364 </span>            : Float_t AliTPCcalibDB::GetValueGoofie(Int_t timeStamp, Int_t run, Int_t type){
<span class="lineNum">    2365 </span>            :   /// GetPressure for given time stamp and runt
<span class="lineNum">    2366 </span>            : 
<span class="lineNum">    2367 </span><span class="lineNoCov">          0 :   TTimeStamp stamp(timeStamp);</span>
<span class="lineNum">    2368 </span><span class="lineNoCov">          0 :   AliDCSSensorArray* goofieArray = AliTPCcalibDB::Instance()-&gt;GetGoofieSensors(run);</span>
<span class="lineNum">    2369 </span><span class="lineNoCov">          0 :   if (!goofieArray) return 0;</span>
<span class="lineNum">    2370 </span><span class="lineNoCov">          0 :   AliDCSSensor *sensor = goofieArray-&gt;GetSensor(type);</span>
<span class="lineNum">    2371 </span><span class="lineNoCov">          0 :   return sensor-&gt;GetValue(stamp);</span>
<span class="lineNum">    2372 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2373 </span>            : 
<span class="lineNum">    2374 </span>            : 
<span class="lineNum">    2375 </span>            : 
<span class="lineNum">    2376 </span>            : 
<a name="2377"><span class="lineNum">    2377 </span>            : </a>
<span class="lineNum">    2378 </span>            : 
<span class="lineNum">    2379 </span>            : Bool_t  AliTPCcalibDB::GetTemperatureFit(Int_t timeStamp, Int_t run, Int_t side,TVectorD&amp; fit){
<span class="lineNum">    2380 </span>            :   /// GetTmeparature fit at parameter for given time stamp
<span class="lineNum">    2381 </span>            : 
<span class="lineNum">    2382 </span><span class="lineNoCov">          0 :   TTimeStamp tstamp(timeStamp);</span>
<span class="lineNum">    2383 </span><span class="lineNoCov">          0 :   AliTPCSensorTempArray* tempArray  = Instance()-&gt;GetTemperatureSensor(run);</span>
<span class="lineNum">    2384 </span><span class="lineNoCov">          0 :   if (! tempArray) return kFALSE;</span>
<span class="lineNum">    2385 </span><span class="lineNoCov">          0 :   AliTPCTempMap * tempMap = new AliTPCTempMap(tempArray);</span>
<span class="lineNum">    2386 </span><span class="lineNoCov">          0 :   TLinearFitter * fitter = tempMap-&gt;GetLinearFitter(3,side,tstamp);</span>
<span class="lineNum">    2387 </span><span class="lineNoCov">          0 :   if (fitter){</span>
<span class="lineNum">    2388 </span><span class="lineNoCov">          0 :     fitter-&gt;Eval();</span>
<span class="lineNum">    2389 </span><span class="lineNoCov">          0 :     fitter-&gt;GetParameters(fit);</span>
<span class="lineNum">    2390 </span>            :   }
<span class="lineNum">    2391 </span><span class="lineNoCov">          0 :   delete fitter;</span>
<span class="lineNum">    2392 </span><span class="lineNoCov">          0 :   delete tempMap;</span>
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :   if (!fitter) return kFALSE;</span>
<span class="lineNum">    2394 </span><span class="lineNoCov">          0 :   return kTRUE;</span>
<a name="2395"><span class="lineNum">    2395 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2396 </span>            : 
<span class="lineNum">    2397 </span>            : Float_t AliTPCcalibDB::GetTemperature(Int_t timeStamp, Int_t run, Int_t side){
<span class="lineNum">    2398 </span>            :   /// Get mean temperature
<span class="lineNum">    2399 </span>            : 
<span class="lineNum">    2400 </span><span class="lineNoCov">          0 :   TVectorD vec(5);</span>
<span class="lineNum">    2401 </span><span class="lineNoCov">          0 :   if (side==0) {</span>
<span class="lineNum">    2402 </span><span class="lineNoCov">          0 :     GetTemperatureFit(timeStamp,run,0,vec);</span>
<span class="lineNum">    2403 </span><span class="lineNoCov">          0 :     return vec[0];</span>
<span class="lineNum">    2404 </span>            :   }
<span class="lineNum">    2405 </span><span class="lineNoCov">          0 :   if (side==1){</span>
<span class="lineNum">    2406 </span><span class="lineNoCov">          0 :     GetTemperatureFit(timeStamp,run,0,vec);</span>
<span class="lineNum">    2407 </span><span class="lineNoCov">          0 :     return vec[0];</span>
<span class="lineNum">    2408 </span>            :   }
<span class="lineNum">    2409 </span><span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">    2410 </span><span class="lineNoCov">          0 : }</span>
<a name="2411"><span class="lineNum">    2411 </span>            : </a>
<span class="lineNum">    2412 </span>            : 
<span class="lineNum">    2413 </span>            : Double_t AliTPCcalibDB::GetPTRelative(UInt_t timeSec, Int_t run, Int_t side){
<span class="lineNum">    2414 </span>            :   /// Get relative P/T
<span class="lineNum">    2415 </span>            :   /// time - absolute time
<span class="lineNum">    2416 </span>            :   /// run  - run number
<span class="lineNum">    2417 </span>            :   /// side - 0 - A side   1-C side
<span class="lineNum">    2418 </span>            : 
<span class="lineNum">    2419 </span><span class="lineCov">        432 :   AliTPCCalibVdrift * vdrift =  Instance()-&gt;GetVdrift(run);</span>
<span class="lineNum">    2420 </span><span class="lineCov">        432 :   if (!vdrift) return 0;</span>
<span class="lineNum">    2421 </span><span class="lineNoCov">          0 :   return vdrift-&gt;GetPTRelative(timeSec,side);</span>
<a name="2422"><span class="lineNum">    2422 </span><span class="lineCov">        216 : }</span></a>
<span class="lineNum">    2423 </span>            : 
<span class="lineNum">    2424 </span>            : AliGRPObject * AliTPCcalibDB::MakeGRPObjectFromMap(TMap *map){
<span class="lineNum">    2425 </span>            :   /// Function to covert old GRP run information from TMap to GRPObject
<span class="lineNum">    2426 </span>            :   ///
<span class="lineNum">    2427 </span>            :   ///  TMap * map = AliTPCcalibDB::GetGRPMap(52406);
<span class="lineNum">    2428 </span>            : 
<span class="lineNum">    2429 </span><span class="lineNoCov">          0 :   if (!map) return 0;</span>
<span class="lineNum">    2430 </span>            :   AliDCSSensor * sensor = 0;
<span class="lineNum">    2431 </span>            :   TObject *osensor=0;
<span class="lineNum">    2432 </span><span class="lineNoCov">          0 :   osensor = ((*map)(&quot;fP2Pressure&quot;));</span>
<span class="lineNum">    2433 </span><span class="lineNoCov">          0 :   sensor  =dynamic_cast&lt;AliDCSSensor *&gt;(osensor);</span>
<span class="lineNum">    2434 </span>            :   //
<span class="lineNum">    2435 </span><span class="lineNoCov">          0 :   if (!sensor) return 0;</span>
<span class="lineNum">    2436 </span>            :   //
<span class="lineNum">    2437 </span><span class="lineNoCov">          0 :   AliDCSSensor * sensor2 = new AliDCSSensor(*sensor);</span>
<span class="lineNum">    2438 </span><span class="lineNoCov">          0 :   osensor = ((*map)(&quot;fCavernPressure&quot;));</span>
<span class="lineNum">    2439 </span><span class="lineNoCov">          0 :   TGraph * gr = new TGraph(2);</span>
<span class="lineNum">    2440 </span><span class="lineNoCov">          0 :   gr-&gt;GetX()[0]= -100000.;</span>
<span class="lineNum">    2441 </span><span class="lineNoCov">          0 :   gr-&gt;GetX()[1]= 1000000.;</span>
<span class="lineNum">    2442 </span><span class="lineNoCov">          0 :   gr-&gt;GetY()[0]= atof(osensor-&gt;GetName());</span>
<span class="lineNum">    2443 </span><span class="lineNoCov">          0 :   gr-&gt;GetY()[1]= atof(osensor-&gt;GetName());</span>
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 :   sensor2-&gt;SetGraph(gr);</span>
<span class="lineNum">    2445 </span><span class="lineNoCov">          0 :   sensor2-&gt;SetFit(0);</span>
<span class="lineNum">    2446 </span>            : 
<span class="lineNum">    2447 </span>            : 
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :   AliGRPObject *grpRun = new AliGRPObject;</span>
<span class="lineNum">    2449 </span><span class="lineNoCov">          0 :   grpRun-&gt;ReadValuesFromMap(map);</span>
<span class="lineNum">    2450 </span><span class="lineNoCov">          0 :   grpRun-&gt;SetCavernAtmosPressure(sensor2);</span>
<span class="lineNum">    2451 </span><span class="lineNoCov">          0 :   grpRun-&gt;SetCavernAtmosPressure(sensor2);</span>
<span class="lineNum">    2452 </span><span class="lineNoCov">          0 :   grpRun-&gt;SetSurfaceAtmosPressure(sensor);</span>
<span class="lineNum">    2453 </span>            :   return grpRun;
<a name="2454"><span class="lineNum">    2454 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2455 </span>            : 
<span class="lineNum">    2456 </span>            : Bool_t AliTPCcalibDB::CreateGUITree(Int_t run, const char* filename)
<span class="lineNum">    2457 </span>            : {
<span class="lineNum">    2458 </span>            :   /// Create a gui tree for run number 'run'
<span class="lineNum">    2459 </span>            : 
<span class="lineNum">    2460 </span><span class="lineNoCov">          0 :   if (!AliCDBManager::Instance()-&gt;GetDefaultStorage()){</span>
<span class="lineNum">    2461 </span><span class="lineNoCov">          0 :     AliLog::Message(AliLog::kError, &quot;Default Storage not set. Cannot create Calibration Tree!&quot;,</span>
<span class="lineNum">    2462 </span>            :                     MODULENAME(), &quot;AliTPCcalibDB&quot;, FUNCTIONNAME(), __FILE__, __LINE__);
<span class="lineNum">    2463 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">    2464 </span>            :   }
<span class="lineNum">    2465 </span>            :   //db instance
<span class="lineNum">    2466 </span><span class="lineNoCov">          0 :   AliTPCcalibDB *db=AliTPCcalibDB::Instance();</span>
<span class="lineNum">    2467 </span>            :   // retrieve cal pad objects
<span class="lineNum">    2468 </span><span class="lineNoCov">          0 :   db-&gt;SetRun(run);</span>
<span class="lineNum">    2469 </span><span class="lineNoCov">          0 :   db-&gt;CreateGUITree(filename);</span>
<span class="lineNum">    2470 </span>            :   return kTRUE;
<a name="2471"><span class="lineNum">    2471 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2472 </span>            : 
<span class="lineNum">    2473 </span>            : Bool_t AliTPCcalibDB::CreateGUITree(const char* filename){
<span class="lineNum">    2474 </span>            :   ///
<span class="lineNum">    2475 </span>            : 
<span class="lineNum">    2476 </span><span class="lineNoCov">          0 :   if (!AliCDBManager::Instance()-&gt;GetDefaultStorage()){</span>
<span class="lineNum">    2477 </span><span class="lineNoCov">          0 :     AliError(&quot;Default Storage not set. Cannot create calibration Tree!&quot;);</span>
<span class="lineNum">    2478 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">    2479 </span>            :   }
<span class="lineNum">    2480 </span><span class="lineNoCov">          0 :   UpdateNonRec();  // load all infromation now</span>
<span class="lineNum">    2481 </span>            : 
<span class="lineNum">    2482 </span><span class="lineNoCov">          0 :   AliTPCPreprocessorOnline prep;</span>
<span class="lineNum">    2483 </span><span class="lineNoCov">          0 :   if (GetActiveChannelMap()) prep.AddComponent(new AliTPCCalPad(*GetActiveChannelMap()));</span>
<span class="lineNum">    2484 </span>            : 
<span class="lineNum">    2485 </span>            :   // gain map
<span class="lineNum">    2486 </span><span class="lineNoCov">          0 :   if (GetDedxGainFactor()) prep.AddComponent(new AliTPCCalPad(*GetDedxGainFactor()));</span>
<span class="lineNum">    2487 </span>            :   //noise and pedestals
<span class="lineNum">    2488 </span><span class="lineNoCov">          0 :   if (GetPedestals()) prep.AddComponent(new AliTPCCalPad(*(GetPedestals())));</span>
<span class="lineNum">    2489 </span><span class="lineNoCov">          0 :   if (GetPadNoise() ) prep.AddComponent(new AliTPCCalPad(*(GetPadNoise())));</span>
<span class="lineNum">    2490 </span>            :   //pulser data
<span class="lineNum">    2491 </span><span class="lineNoCov">          0 :   if (GetPulserTmean()) prep.AddComponent(new AliTPCCalPad(*(GetPulserTmean())));</span>
<span class="lineNum">    2492 </span><span class="lineNoCov">          0 :   if (GetPulserTrms() ) prep.AddComponent(new AliTPCCalPad(*(GetPulserTrms())));</span>
<span class="lineNum">    2493 </span><span class="lineNoCov">          0 :   if (GetPulserQmean()) prep.AddComponent(new AliTPCCalPad(*(GetPulserQmean())));</span>
<span class="lineNum">    2494 </span>            :   //CE data
<span class="lineNum">    2495 </span><span class="lineNoCov">          0 :   if (GetCETmean()) prep.AddComponent(new AliTPCCalPad(*(GetCETmean())));</span>
<span class="lineNum">    2496 </span><span class="lineNoCov">          0 :   if (GetCETrms() ) prep.AddComponent(new AliTPCCalPad(*(GetCETrms())));</span>
<span class="lineNum">    2497 </span><span class="lineNoCov">          0 :   if (GetCEQmean()) prep.AddComponent(new AliTPCCalPad(*(GetCEQmean())));</span>
<span class="lineNum">    2498 </span>            :   //Altro data
<span class="lineNum">    2499 </span><span class="lineNoCov">          0 :   if (GetALTROAcqStart() ) prep.AddComponent(new AliTPCCalPad(*(GetALTROAcqStart() )));</span>
<span class="lineNum">    2500 </span><span class="lineNoCov">          0 :   if (GetALTROZsThr()    ) prep.AddComponent(new AliTPCCalPad(*(GetALTROZsThr()    )));</span>
<span class="lineNum">    2501 </span><span class="lineNoCov">          0 :   if (GetALTROFPED()     ) prep.AddComponent(new AliTPCCalPad(*(GetALTROFPED()     )));</span>
<span class="lineNum">    2502 </span><span class="lineNoCov">          0 :   if (GetALTROAcqStop()  ) prep.AddComponent(new AliTPCCalPad(*(GetALTROAcqStop()  )));</span>
<span class="lineNum">    2503 </span><span class="lineNoCov">          0 :   if (GetALTROMasked()   ) prep.AddComponent(new AliTPCCalPad(*(GetALTROMasked()   )));</span>
<span class="lineNum">    2504 </span>            :   //QA
<span class="lineNum">    2505 </span><span class="lineNoCov">          0 :   AliTPCdataQA *dataQA=GetDataQA();</span>
<span class="lineNum">    2506 </span><span class="lineNoCov">          0 :   if (dataQA) {</span>
<span class="lineNum">    2507 </span><span class="lineNoCov">          0 :     if (dataQA-&gt;GetNLocalMaxima())</span>
<span class="lineNum">    2508 </span><span class="lineNoCov">          0 :       prep.AddComponent(new AliTPCCalPad(*(dataQA-&gt;GetNLocalMaxima())));</span>
<span class="lineNum">    2509 </span><span class="lineNoCov">          0 :     if (dataQA-&gt;GetMaxCharge())</span>
<span class="lineNum">    2510 </span><span class="lineNoCov">          0 :       prep.AddComponent(new AliTPCCalPad(*(dataQA-&gt;GetMaxCharge())));</span>
<span class="lineNum">    2511 </span><span class="lineNoCov">          0 :     if (dataQA-&gt;GetMeanCharge())</span>
<span class="lineNum">    2512 </span><span class="lineNoCov">          0 :       prep.AddComponent(new AliTPCCalPad(*(dataQA-&gt;GetMeanCharge())));</span>
<span class="lineNum">    2513 </span><span class="lineNoCov">          0 :     if (dataQA-&gt;GetNoThreshold())</span>
<span class="lineNum">    2514 </span><span class="lineNoCov">          0 :       prep.AddComponent(new AliTPCCalPad(*(dataQA-&gt;GetNoThreshold())));</span>
<span class="lineNum">    2515 </span><span class="lineNoCov">          0 :     if (dataQA-&gt;GetNTimeBins())</span>
<span class="lineNum">    2516 </span><span class="lineNoCov">          0 :       prep.AddComponent(new AliTPCCalPad(*(dataQA-&gt;GetNTimeBins())));</span>
<span class="lineNum">    2517 </span><span class="lineNoCov">          0 :     if (dataQA-&gt;GetNPads())</span>
<span class="lineNum">    2518 </span><span class="lineNoCov">          0 :       prep.AddComponent(new AliTPCCalPad(*(dataQA-&gt;GetNPads())));</span>
<span class="lineNum">    2519 </span><span class="lineNoCov">          0 :     if (dataQA-&gt;GetTimePosition())</span>
<span class="lineNum">    2520 </span><span class="lineNoCov">          0 :       prep.AddComponent(new AliTPCCalPad(*(dataQA-&gt;GetTimePosition())));</span>
<span class="lineNum">    2521 </span>            :   }
<span class="lineNum">    2522 </span>            : 
<span class="lineNum">    2523 </span>            :   //
<span class="lineNum">    2524 </span><span class="lineNoCov">          0 :   TString file(filename);</span>
<span class="lineNum">    2525 </span><span class="lineNoCov">          0 :   if (file.IsNull()) file=Form(&quot;guiTreeRun_%i.root&quot;,fRun);</span>
<span class="lineNum">    2526 </span><span class="lineNoCov">          0 :   prep.DumpToFile(file.Data());</span>
<span class="lineNum">    2527 </span>            :   return kTRUE;
<a name="2528"><span class="lineNum">    2528 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2529 </span>            : 
<span class="lineNum">    2530 </span>            : Bool_t AliTPCcalibDB::CreateRefFile(Int_t run, const char* filename)
<span class="lineNum">    2531 </span>            : {
<span class="lineNum">    2532 </span>            :   /// Create a gui tree for run number 'run'
<span class="lineNum">    2533 </span>            : 
<span class="lineNum">    2534 </span><span class="lineNoCov">          0 :   if (!AliCDBManager::Instance()-&gt;GetDefaultStorage()){</span>
<span class="lineNum">    2535 </span><span class="lineNoCov">          0 :     AliLog::Message(AliLog::kError, &quot;Default Storage not set. Cannot create Calibration Tree!&quot;,</span>
<span class="lineNum">    2536 </span>            :                     MODULENAME(), &quot;AliTPCcalibDB&quot;, FUNCTIONNAME(), __FILE__, __LINE__);
<span class="lineNum">    2537 </span><span class="lineNoCov">          0 :     return kFALSE;</span>
<span class="lineNum">    2538 </span>            :   }
<span class="lineNum">    2539 </span><span class="lineNoCov">          0 :   TString file(filename);</span>
<span class="lineNum">    2540 </span><span class="lineNoCov">          0 :   if (file.IsNull()) file=Form(&quot;RefCalPads_%d.root&quot;,run);</span>
<span class="lineNum">    2541 </span><span class="lineNoCov">          0 :   TDirectory *currDir=gDirectory;</span>
<span class="lineNum">    2542 </span>            :   //db instance
<span class="lineNum">    2543 </span><span class="lineNoCov">          0 :   AliTPCcalibDB *db=AliTPCcalibDB::Instance();</span>
<span class="lineNum">    2544 </span>            :   // retrieve cal pad objects
<span class="lineNum">    2545 </span><span class="lineNoCov">          0 :   db-&gt;SetRun(run);</span>
<span class="lineNum">    2546 </span>            :   //open file
<span class="lineNum">    2547 </span><span class="lineNoCov">          0 :   TFile f(file.Data(),&quot;recreate&quot;);</span>
<span class="lineNum">    2548 </span>            :   //noise and pedestals
<span class="lineNum">    2549 </span><span class="lineNoCov">          0 :   db-&gt;GetPedestals()-&gt;Write(&quot;Pedestals&quot;);</span>
<span class="lineNum">    2550 </span><span class="lineNoCov">          0 :   db-&gt;GetPadNoise()-&gt;Write(&quot;PadNoise&quot;);</span>
<span class="lineNum">    2551 </span>            :   //pulser data
<span class="lineNum">    2552 </span><span class="lineNoCov">          0 :   db-&gt;GetPulserTmean()-&gt;Write(&quot;PulserTmean&quot;);</span>
<span class="lineNum">    2553 </span><span class="lineNoCov">          0 :   db-&gt;GetPulserTrms()-&gt;Write(&quot;PulserTrms&quot;);</span>
<span class="lineNum">    2554 </span><span class="lineNoCov">          0 :   db-&gt;GetPulserQmean()-&gt;Write(&quot;PulserQmean&quot;);</span>
<span class="lineNum">    2555 </span>            :   //CE data
<span class="lineNum">    2556 </span><span class="lineNoCov">          0 :   db-&gt;GetCETmean()-&gt;Write(&quot;CETmean&quot;);</span>
<span class="lineNum">    2557 </span><span class="lineNoCov">          0 :   db-&gt;GetCETrms()-&gt;Write(&quot;CETrms&quot;);</span>
<span class="lineNum">    2558 </span><span class="lineNoCov">          0 :   db-&gt;GetCEQmean()-&gt;Write(&quot;CEQmean&quot;);</span>
<span class="lineNum">    2559 </span>            :   //Altro data
<span class="lineNum">    2560 </span><span class="lineNoCov">          0 :   db-&gt;GetALTROAcqStart() -&gt;Write(&quot;ALTROAcqStart&quot;);</span>
<span class="lineNum">    2561 </span><span class="lineNoCov">          0 :   db-&gt;GetALTROZsThr()    -&gt;Write(&quot;ALTROZsThr&quot;);</span>
<span class="lineNum">    2562 </span><span class="lineNoCov">          0 :   db-&gt;GetALTROFPED()     -&gt;Write(&quot;ALTROFPED&quot;);</span>
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 :   db-&gt;GetALTROAcqStop()  -&gt;Write(&quot;ALTROAcqStop&quot;);</span>
<span class="lineNum">    2564 </span><span class="lineNoCov">          0 :   db-&gt;GetALTROMasked()   -&gt;Write(&quot;ALTROMasked&quot;);</span>
<span class="lineNum">    2565 </span>            :   //
<span class="lineNum">    2566 </span><span class="lineNoCov">          0 :   f.Close();</span>
<span class="lineNum">    2567 </span><span class="lineNoCov">          0 :   currDir-&gt;cd();</span>
<span class="lineNum">    2568 </span>            :   return kTRUE;
<span class="lineNum">    2569 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2570 </span>            : 
<a name="2571"><span class="lineNum">    2571 </span>            : </a>
<span class="lineNum">    2572 </span>            : 
<span class="lineNum">    2573 </span>            : Double_t AliTPCcalibDB::GetVDriftCorrectionTime(Int_t timeStamp, Int_t run, Int_t /*side*/, Int_t mode){
<span class="lineNum">    2574 </span>            :   /// Get time dependent drift velocity correction
<span class="lineNum">    2575 </span>            :   /// multiplication factor        vd = vdnom *(1+vdriftcorr)
<span class="lineNum">    2576 </span>            :   /// Arguments:
<span class="lineNum">    2577 </span>            :   /// mode determines the algorith how to combine the Laser Track, LaserCE and physics tracks
<span class="lineNum">    2578 </span>            :   /// timestamp - timestamp
<span class="lineNum">    2579 </span>            :   /// run       - run number
<span class="lineNum">    2580 </span>            :   /// side      - the drift velocity per side (possible for laser and CE)
<span class="lineNum">    2581 </span>            :   ///
<span class="lineNum">    2582 </span>            :   /// Notice - Extrapolation outside of calibration range  - using constant function
<span class="lineNum">    2583 </span>            : 
<span class="lineNum">    2584 </span>            :   Double_t result=0;
<span class="lineNum">    2585 </span>            :   // mode 1  automatic mode - according to the distance to the valid calibration
<span class="lineNum">    2586 </span>            :   //                        -
<span class="lineNum">    2587 </span><span class="lineCov">          4 :   Double_t deltaP=0,  driftP=0,      wP  = 0.;</span>
<span class="lineNum">    2588 </span><span class="lineCov">          2 :   Double_t deltaITS=0,driftITS=0,    wITS= 0.;</span>
<span class="lineNum">    2589 </span><span class="lineCov">          2 :   Double_t deltaLT=0, driftLT=0,     wLT = 0.;</span>
<span class="lineNum">    2590 </span><span class="lineCov">          2 :   Double_t deltaCE=0, driftCE=0,     wCE = 0.;</span>
<span class="lineNum">    2591 </span><span class="lineCov">          2 :   driftP  = fDButil-&gt;GetVDriftTPC(deltaP,run,timeStamp);</span>
<span class="lineNum">    2592 </span><span class="lineCov">          2 :   driftITS= fDButil-&gt;GetVDriftTPCITS(deltaITS,run,timeStamp);</span>
<span class="lineNum">    2593 </span><span class="lineCov">          2 :   driftCE = fDButil-&gt;GetVDriftTPCCE(deltaCE, run,timeStamp,36000,2);</span>
<span class="lineNum">    2594 </span><span class="lineCov">          2 :   driftLT = fDButil-&gt;GetVDriftTPCLaserTracks(deltaLT,run,timeStamp,36000,2);</span>
<span class="lineNum">    2595 </span><span class="lineCov">          2 :   deltaITS = TMath::Abs(deltaITS);</span>
<span class="lineNum">    2596 </span><span class="lineCov">          2 :   deltaP   = TMath::Abs(deltaP);</span>
<span class="lineNum">    2597 </span><span class="lineCov">          2 :   deltaLT  = TMath::Abs(deltaLT);</span>
<span class="lineNum">    2598 </span><span class="lineCov">          2 :   deltaCE  = TMath::Abs(deltaCE);</span>
<span class="lineNum">    2599 </span><span class="lineCov">          2 :   if (mode==1) {</span>
<span class="lineNum">    2600 </span>            :     const Double_t kEpsilon=0.00000000001;
<span class="lineNum">    2601 </span>            :     const Double_t kdeltaT=360.; // 10 minutes
<span class="lineNum">    2602 </span><span class="lineCov">          2 :     if(TMath::Abs(deltaITS) &lt; 12*kdeltaT) {</span>
<span class="lineNum">    2603 </span>            :       result = driftITS;
<span class="lineNum">    2604 </span><span class="lineCov">          2 :     } else {</span>
<span class="lineNum">    2605 </span><span class="lineNoCov">          0 :     wITS  = 64.*kdeltaT/(deltaITS +kdeltaT);</span>
<span class="lineNum">    2606 </span><span class="lineNoCov">          0 :     wLT   = 16.*kdeltaT/(deltaLT  +kdeltaT);</span>
<span class="lineNum">    2607 </span><span class="lineNoCov">          0 :     wP    = 0. *kdeltaT/(deltaP   +kdeltaT);</span>
<span class="lineNum">    2608 </span><span class="lineNoCov">          0 :     wCE   = 1. *kdeltaT/(deltaCE  +kdeltaT);</span>
<span class="lineNum">    2609 </span>            :     //
<span class="lineNum">    2610 </span>            :     //
<span class="lineNum">    2611 </span><span class="lineNoCov">          0 :     if (TMath::Abs(driftP)&lt;kEpsilon)  wP=0;  // invalid calibration</span>
<span class="lineNum">    2612 </span><span class="lineNoCov">          0 :     if (TMath::Abs(driftITS)&lt;kEpsilon)wITS=0;  // invalid calibration</span>
<span class="lineNum">    2613 </span><span class="lineNoCov">          0 :     if (TMath::Abs(driftLT)&lt;kEpsilon) wLT=0;  // invalid calibration</span>
<span class="lineNum">    2614 </span><span class="lineNoCov">          0 :     if (TMath::Abs(driftCE)&lt;kEpsilon) wCE=0;  // invalid calibration</span>
<span class="lineNum">    2615 </span><span class="lineNoCov">          0 :     if (wP+wITS+wLT+wCE&lt;kEpsilon) return 0;</span>
<span class="lineNum">    2616 </span><span class="lineNoCov">          0 :     result = (driftP*wP+driftITS*wITS+driftLT*wLT+driftCE*wCE)/(wP+wITS+wLT+wCE);</span>
<span class="lineNum">    2617 </span>            :    }
<span class="lineNum">    2618 </span>            : 
<span class="lineNum">    2619 </span>            : 
<span class="lineNum">    2620 </span><span class="lineCov">          2 :   }</span>
<span class="lineNum">    2621 </span>            : 
<span class="lineNum">    2622 </span><span class="lineCov">          2 :   return result;</span>
<a name="2623"><span class="lineNum">    2623 </span><span class="lineCov">          2 : }</span></a>
<span class="lineNum">    2624 </span>            : 
<span class="lineNum">    2625 </span>            : Double_t AliTPCcalibDB::GetTime0CorrectionTime(Int_t timeStamp, Int_t run, Int_t /*side*/, Int_t mode){
<span class="lineNum">    2626 </span>            :   /// Get time dependent time 0 (trigger delay in cm) correction
<span class="lineNum">    2627 </span>            :   /// additive correction        time0 = time0+ GetTime0CorrectionTime
<span class="lineNum">    2628 </span>            :   /// Value etracted combining the vdrift correction using laser tracks and CE and the physics track matchin
<span class="lineNum">    2629 </span>            :   /// Arguments:
<span class="lineNum">    2630 </span>            :   /// mode determines the algorith how to combine the Laser Track and physics tracks
<span class="lineNum">    2631 </span>            :   /// timestamp - timestamp
<span class="lineNum">    2632 </span>            :   /// run       - run number
<span class="lineNum">    2633 </span>            :   /// side      - the drift velocity per side (possible for laser and CE)
<span class="lineNum">    2634 </span>            :   ///
<span class="lineNum">    2635 </span>            :   /// Notice - Extrapolation outside of calibration range  - using constant function
<span class="lineNum">    2636 </span>            : 
<span class="lineNum">    2637 </span>            :   Double_t result=0;
<span class="lineNum">    2638 </span><span class="lineCov">          4 :   if (mode==2) {</span>
<span class="lineNum">    2639 </span>            :     // TPC-TPC mode
<span class="lineNum">    2640 </span><span class="lineNoCov">          0 :     result=fDButil-&gt;GetTriggerOffsetTPC(run,timeStamp);</span>
<span class="lineNum">    2641 </span><span class="lineNoCov">          0 :     result  *=fParam-&gt;GetZLength();</span>
<span class="lineNum">    2642 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2643 </span><span class="lineCov">          2 :   if (mode==1){</span>
<span class="lineNum">    2644 </span>            :     // TPC-ITS mode
<span class="lineNum">    2645 </span><span class="lineCov">          2 :     Double_t dist=0;</span>
<span class="lineNum">    2646 </span><span class="lineCov">          2 :     result= -fDButil-&gt;GetTime0TPCITS(dist, run, timeStamp)*fParam-&gt;GetDriftV()/1000000.;</span>
<span class="lineNum">    2647 </span><span class="lineCov">          2 :   }</span>
<span class="lineNum">    2648 </span><span class="lineCov">          2 :   return result;</span>
<span class="lineNum">    2649 </span>            : 
<span class="lineNum">    2650 </span>            : }
<span class="lineNum">    2651 </span>            : 
<span class="lineNum">    2652 </span>            : 
<a name="2653"><span class="lineNum">    2653 </span>            : </a>
<span class="lineNum">    2654 </span>            : 
<span class="lineNum">    2655 </span>            : Double_t AliTPCcalibDB::GetVDriftCorrectionGy(Int_t timeStamp, Int_t run, Int_t side, Int_t /*mode*/){
<span class="lineNum">    2656 </span>            :   /// Get global y correction drift velocity correction factor
<span class="lineNum">    2657 </span>            :   /// additive factor        vd = vdnom*(1+GetVDriftCorrectionGy *gy)
<span class="lineNum">    2658 </span>            :   /// Value etracted combining the vdrift correction using laser tracks and CE or TPC-ITS
<span class="lineNum">    2659 </span>            :   /// Arguments:
<span class="lineNum">    2660 </span>            :   /// mode determines the algorith how to combine the Laser Track, LaserCE or TPC-ITS
<span class="lineNum">    2661 </span>            :   /// timestamp - timestamp
<span class="lineNum">    2662 </span>            :   /// run       - run number
<span class="lineNum">    2663 </span>            :   /// side      - the drift velocity gy correction per side (CE and Laser tracks)
<span class="lineNum">    2664 </span>            :   ///
<span class="lineNum">    2665 </span>            :   /// Notice - Extrapolation outside of calibration range  - using constant function
<span class="lineNum">    2666 </span>            : 
<span class="lineNum">    2667 </span><span class="lineCov">          8 :   if (run&lt;=0 &amp;&amp; fTransform) run = fTransform-&gt;GetCurrentRunNumber();</span>
<span class="lineNum">    2668 </span><span class="lineCov">          2 :   UpdateRunInformations(run,kFALSE);</span>
<span class="lineNum">    2669 </span><span class="lineCov">          2 :   TObjArray *array =AliTPCcalibDB::Instance()-&gt;GetTimeVdriftSplineRun(run);</span>
<span class="lineNum">    2670 </span><span class="lineCov">          4 :   if (!array) return 0;</span>
<span class="lineNum">    2671 </span>            :   Double_t result=0;
<span class="lineNum">    2672 </span>            : 
<span class="lineNum">    2673 </span>            :   // use TPC-ITS if present
<span class="lineNum">    2674 </span><span class="lineNoCov">          0 :   TGraphErrors *gr= (TGraphErrors*)array-&gt;FindObject(&quot;ALIGN_ITSB_TPC_VDGY&quot;);</span>
<span class="lineNum">    2675 </span><span class="lineNoCov">          0 :   if (!gr) gr = (TGraphErrors*)array-&gt;FindObject(&quot;ALIGN_TOFB_TPC_VDGY&quot;);</span>
<span class="lineNum">    2676 </span><span class="lineNoCov">          0 :   if(gr) {</span>
<span class="lineNum">    2677 </span><span class="lineNoCov">          0 :     result = AliTPCcalibDButil::EvalGraphConst(gr,timeStamp);</span>
<span class="lineNum">    2678 </span>            : 
<span class="lineNum">    2679 </span>            :     // transform from [(cm/mus)/ m] to [1/cm]
<span class="lineNum">    2680 </span><span class="lineNoCov">          0 :     result /= (fParam-&gt;GetDriftV()/1000000.);</span>
<span class="lineNum">    2681 </span><span class="lineNoCov">          0 :     result /= 100.;</span>
<span class="lineNum">    2682 </span>            : 
<span class="lineNum">    2683 </span>            :     //printf(&quot;result %e \n&quot;, result);
<span class="lineNum">    2684 </span><span class="lineNoCov">          0 :     return result;</span>
<span class="lineNum">    2685 </span>            :   }
<span class="lineNum">    2686 </span>            : 
<span class="lineNum">    2687 </span>            :   // use laser if ITS-TPC not present
<span class="lineNum">    2688 </span><span class="lineNoCov">          0 :   TGraphErrors *laserA= (TGraphErrors*)array-&gt;FindObject(&quot;GRAPH_MEAN_GLOBALYGRADIENT_LASER_ALL_A&quot;);</span>
<span class="lineNum">    2689 </span><span class="lineNoCov">          0 :   TGraphErrors *laserC= (TGraphErrors*)array-&gt;FindObject(&quot;GRAPH_MEAN_GLOBALYGRADIENT_LASER_ALL_C&quot;);</span>
<span class="lineNum">    2690 </span>            : 
<span class="lineNum">    2691 </span><span class="lineNoCov">          0 :   if (laserA &amp;&amp; laserC){</span>
<span class="lineNum">    2692 </span><span class="lineNoCov">          0 :    result= (laserA-&gt;Eval(timeStamp)+laserC-&gt;Eval(timeStamp))*0.5;</span>
<span class="lineNum">    2693 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2694 </span><span class="lineNoCov">          0 :   if (laserA &amp;&amp; side==0){</span>
<span class="lineNum">    2695 </span><span class="lineNoCov">          0 :     result = (laserA-&gt;Eval(timeStamp));</span>
<span class="lineNum">    2696 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2697 </span><span class="lineNoCov">          0 :   if (laserC &amp;&amp;side==1){</span>
<span class="lineNum">    2698 </span><span class="lineNoCov">          0 :     result = (laserC-&gt;Eval(timeStamp));</span>
<span class="lineNum">    2699 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2700 </span>            :   //printf(&quot;laser result %e \n&quot;, -result/250.);
<span class="lineNum">    2701 </span>            : 
<span class="lineNum">    2702 </span><span class="lineNoCov">          0 :   return -result/250.; //normalized before</span>
<span class="lineNum">    2703 </span><span class="lineCov">          2 : }</span>
<a name="2704"><span class="lineNum">    2704 </span>            : </a>
<span class="lineNum">    2705 </span>            : 
<span class="lineNum">    2706 </span>            : Double_t AliTPCcalibDB::GetVDriftCorrectionDeltaZ(Int_t /*timeStamp*/, Int_t run, Int_t /*side*/, Int_t /*mode*/){
<span class="lineNum">    2707 </span>            :   /// Get deltaZ run/by/run  correction - as fitted together with drift velocity
<span class="lineNum">    2708 </span>            :   /// Value extracted  form the TPC-ITS, mean value is used
<span class="lineNum">    2709 </span>            : 
<span class="lineNum">    2710 </span>            :   // Arguments:
<span class="lineNum">    2711 </span>            :   // mode determines the algorith how to combine the Laser Track, LaserCE or TPC-ITS
<span class="lineNum">    2712 </span>            :   // timestamp - not used
<span class="lineNum">    2713 </span>            :   // run       - run number
<span class="lineNum">    2714 </span>            :   // side      - common for boith sides
<span class="lineNum">    2715 </span>            :   //
<span class="lineNum">    2716 </span><span class="lineCov">          8 :   if (run&lt;=0 &amp;&amp; fTransform) run = fTransform-&gt;GetCurrentRunNumber();</span>
<span class="lineNum">    2717 </span><span class="lineCov">          2 :   UpdateRunInformations(run,kFALSE);</span>
<span class="lineNum">    2718 </span><span class="lineCov">          2 :   TObjArray *array =AliTPCcalibDB::Instance()-&gt;GetTimeVdriftSplineRun(run);</span>
<span class="lineNum">    2719 </span><span class="lineCov">          4 :   if (!array) return 0;</span>
<span class="lineNum">    2720 </span>            :   Double_t result=0;
<span class="lineNum">    2721 </span>            : 
<span class="lineNum">    2722 </span>            :   // use TPC-ITS if present
<span class="lineNum">    2723 </span><span class="lineNoCov">          0 :   TGraphErrors *gr= (TGraphErrors*)array-&gt;FindObject(&quot;ALIGN_ITSB_TPC_DELTAZ&quot;);</span>
<span class="lineNum">    2724 </span><span class="lineNoCov">          0 :   if(gr) {</span>
<span class="lineNum">    2725 </span><span class="lineNoCov">          0 :     result = TMath::Mean(gr-&gt;GetN(), gr-&gt;GetY());</span>
<span class="lineNum">    2726 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2727 </span>            :   return result;
<span class="lineNum">    2728 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    2729 </span>            : 
<span class="lineNum">    2730 </span>            : 
<a name="2731"><span class="lineNum">    2731 </span>            : </a>
<span class="lineNum">    2732 </span>            : 
<span class="lineNum">    2733 </span>            : AliTPCCalPad* AliTPCcalibDB::MakeDeadMap(Double_t notInMap, const char* nameMappingFile) {
<span class="lineNum">    2734 </span>            : ///   Read list of active DDLs from OCDB entry
<span class="lineNum">    2735 </span>            : ///   Generate and return AliTPCCalPad containing 1 for all pads in active DDLs,
<span class="lineNum">    2736 </span>            : ///   0 for all pads in non-active DDLs.
<span class="lineNum">    2737 </span>            : ///   For DDLs with missing status information (no DCS input point to Shuttle),
<span class="lineNum">    2738 </span>            : ///     the value of the AliTPCCalPad entry is determined by the parameter
<span class="lineNum">    2739 </span>            : ///     notInMap (default value 1)
<span class="lineNum">    2740 </span>            : 
<span class="lineNum">    2741 </span><span class="lineNoCov">          0 :   char chinfo[1000];</span>
<span class="lineNum">    2742 </span>            : 
<span class="lineNum">    2743 </span><span class="lineNoCov">          0 :   TFile *fileMapping = new TFile(nameMappingFile, &quot;read&quot;);</span>
<span class="lineNum">    2744 </span><span class="lineNoCov">          0 :   AliTPCmapper *mapping = (AliTPCmapper*) fileMapping-&gt;Get(&quot;tpcMapping&quot;);</span>
<span class="lineNum">    2745 </span><span class="lineNoCov">          0 :   if (!mapping) {</span>
<span class="lineNum">    2746 </span><span class="lineNoCov">          0 :     snprintf(chinfo,1000,&quot;Failed to get mapping object from %s.  ...\n&quot;, nameMappingFile);</span>
<span class="lineNum">    2747 </span><span class="lineNoCov">          0 :     AliError (chinfo);</span>
<span class="lineNum">    2748 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">    2749 </span>            :   }
<span class="lineNum">    2750 </span>            : 
<span class="lineNum">    2751 </span><span class="lineNoCov">          0 :   AliTPCCalPad *deadMap = new AliTPCCalPad(&quot;deadMap&quot;,&quot;deadMap&quot;);</span>
<span class="lineNum">    2752 </span><span class="lineNoCov">          0 :   if (!deadMap) {</span>
<span class="lineNum">    2753 </span><span class="lineNoCov">          0 :      AliError(&quot;Failed to allocate dead map AliTPCCalPad&quot;);</span>
<span class="lineNum">    2754 </span><span class="lineNoCov">          0 :      return 0;</span>
<span class="lineNum">    2755 </span>            :   }
<span class="lineNum">    2756 </span>            : 
<span class="lineNum">    2757 </span>            :   /// get list of active DDLs from OCDB entry
<span class="lineNum">    2758 </span>            :   Int_t idDDL=0;
<span class="lineNum">    2759 </span><span class="lineNoCov">          0 :   if (!fALTROConfigData ) {</span>
<span class="lineNum">    2760 </span><span class="lineNoCov">          0 :      AliError(&quot;No ALTRO config OCDB entry available&quot;);</span>
<span class="lineNum">    2761 </span><span class="lineNoCov">          0 :      return 0;</span>
<span class="lineNum">    2762 </span>            :   }
<span class="lineNum">    2763 </span><span class="lineNoCov">          0 :   TMap *activeDDL = (TMap*)fALTROConfigData-&gt;FindObject(&quot;DDLArray&quot;);</span>
<span class="lineNum">    2764 </span>            :   TObjString *ddlArray=0;
<span class="lineNum">    2765 </span><span class="lineNoCov">          0 :   if (activeDDL) {</span>
<span class="lineNum">    2766 </span><span class="lineNoCov">          0 :     ddlArray = (TObjString*)activeDDL-&gt;GetValue(&quot;DDLArray&quot;);</span>
<span class="lineNum">    2767 </span><span class="lineNoCov">          0 :     if (!ddlArray) {</span>
<span class="lineNum">    2768 </span><span class="lineNoCov">          0 :       AliError(&quot;Empty list of active DDLs in OCDB entry&quot;);</span>
<span class="lineNum">    2769 </span><span class="lineNoCov">          0 :       return 0;</span>
<span class="lineNum">    2770 </span>            :     }
<span class="lineNum">    2771 </span>            :   } else {
<span class="lineNum">    2772 </span><span class="lineNoCov">          0 :     AliError(&quot;List of active DDLs not available in OCDB entry&quot;);</span>
<span class="lineNum">    2773 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">    2774 </span>            :   }
<span class="lineNum">    2775 </span><span class="lineNoCov">          0 :   TString arrDDL=ddlArray-&gt;GetString();</span>
<span class="lineNum">    2776 </span><span class="lineNoCov">          0 :   Int_t offset = mapping-&gt;GetTpcDdlOffset();</span>
<span class="lineNum">    2777 </span>            :   Double_t active;
<span class="lineNum">    2778 </span><span class="lineNoCov">          0 :   for (Int_t i=0; i&lt;mapping-&gt;GetNumDdl(); i++) {</span>
<span class="lineNum">    2779 </span><span class="lineNoCov">          0 :     idDDL= i+offset;</span>
<span class="lineNum">    2780 </span><span class="lineNoCov">          0 :     if (idDDL&lt;0) continue;</span>
<span class="lineNum">    2781 </span><span class="lineNoCov">          0 :     Int_t patch = mapping-&gt;GetPatchFromEquipmentID(idDDL);</span>
<span class="lineNum">    2782 </span><span class="lineNoCov">          0 :     if (patch&lt;0) continue;</span>
<span class="lineNum">    2783 </span><span class="lineNoCov">          0 :     Int_t roc=mapping-&gt;GetRocFromEquipmentID(idDDL);</span>
<span class="lineNum">    2784 </span><span class="lineNoCov">          0 :     if (roc&lt;0) continue;</span>
<span class="lineNum">    2785 </span><span class="lineNoCov">          0 :     AliTPCCalROC *calRoc=deadMap-&gt;GetCalROC(roc);</span>
<span class="lineNum">    2786 </span><span class="lineNoCov">          0 :     if (calRoc) {</span>
<span class="lineNum">    2787 </span><span class="lineNoCov">          0 :      for ( Int_t branch = 0; branch &lt; 2; branch++ ) {</span>
<span class="lineNum">    2788 </span><span class="lineNoCov">          0 :       for ( Int_t fec = 0; fec &lt; mapping-&gt;GetNfec(patch, branch); fec++ ) {</span>
<span class="lineNum">    2789 </span><span class="lineNoCov">          0 :         for ( Int_t altro = 0; altro &lt; 8; altro++ ) {</span>
<span class="lineNum">    2790 </span><span class="lineNoCov">          0 :          for ( Int_t channel = 0; channel &lt; 16; channel++ ) {</span>
<span class="lineNum">    2791 </span><span class="lineNoCov">          0 :            Int_t hwadd     = mapping-&gt;CodeHWAddress(branch, fec, altro, channel);</span>
<span class="lineNum">    2792 </span><span class="lineNoCov">          0 :            Int_t row       = mapping-&gt;GetPadRow(patch, hwadd);        // row in a ROC (IROC or OROC)</span>
<span class="lineNum">    2793 </span>            : //              Int_t globalrow = mapping.GetGlobalPadRow(patch, hwadd);  // row in full sector (IROC plus OROC)
<span class="lineNum">    2794 </span><span class="lineNoCov">          0 :            Int_t pad       = mapping-&gt;GetPad(patch, hwadd);</span>
<span class="lineNum">    2795 </span><span class="lineNoCov">          0 :            if (!TString(arrDDL[i]).IsDigit()) {</span>
<span class="lineNum">    2796 </span>            :               active = notInMap;
<span class="lineNum">    2797 </span><span class="lineNoCov">          0 :            } else {</span>
<span class="lineNum">    2798 </span><span class="lineNoCov">          0 :               active=TString(arrDDL[i]).Atof();</span>
<span class="lineNum">    2799 </span>            :            }
<span class="lineNum">    2800 </span><span class="lineNoCov">          0 :            calRoc-&gt;SetValue(row,pad,active);</span>
<span class="lineNum">    2801 </span>            :          } // end channel for loop
<span class="lineNum">    2802 </span>            :         } // end altro for loop
<span class="lineNum">    2803 </span>            :       } // end fec for loop
<span class="lineNum">    2804 </span>            :      } // end branch for loop
<span class="lineNum">    2805 </span><span class="lineNoCov">          0 :     } // valid calROC</span>
<span class="lineNum">    2806 </span><span class="lineNoCov">          0 :    } // end loop on active DDLs</span>
<span class="lineNum">    2807 </span>            :    return deadMap;
<span class="lineNum">    2808 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2809 </span>            : 
<a name="2810"><span class="lineNum">    2810 </span>            : </a>
<span class="lineNum">    2811 </span>            : 
<span class="lineNum">    2812 </span>            : AliTPCCorrection * AliTPCcalibDB::GetTPCComposedCorrection(Float_t field) const{
<span class="lineNum">    2813 </span>            :   /// GetComposed correction for given field setting
<span class="lineNum">    2814 </span>            :   /// If not specific correction for field used return correction for all field
<span class="lineNum">    2815 </span>            :   ///        - Complication needed to gaurantee OCDB back compatibility
<span class="lineNum">    2816 </span>            :   ///        - Not neeeded for the new space point correction
<span class="lineNum">    2817 </span>            : 
<span class="lineNum">    2818 </span><span class="lineNoCov">          0 :   if (!fComposedCorrectionArray) return 0;</span>
<span class="lineNum">    2819 </span><span class="lineNoCov">          0 :   if (field&gt;0.1 &amp;&amp; fComposedCorrectionArray-&gt;At(1)) {</span>
<span class="lineNum">    2820 </span><span class="lineNoCov">          0 :     return (AliTPCCorrection *)fComposedCorrectionArray-&gt;At(1);</span>
<span class="lineNum">    2821 </span>            :   }
<span class="lineNum">    2822 </span><span class="lineNoCov">          0 :   if (field&lt;-0.1 &amp;&amp;fComposedCorrectionArray-&gt;At(2)) {</span>
<span class="lineNum">    2823 </span><span class="lineNoCov">          0 :     return (AliTPCCorrection *)fComposedCorrectionArray-&gt;At(2);</span>
<span class="lineNum">    2824 </span>            :   }
<span class="lineNum">    2825 </span><span class="lineNoCov">          0 :   return (AliTPCCorrection *)fComposedCorrectionArray-&gt;At(0);</span>
<span class="lineNum">    2826 </span>            : 
<span class="lineNum">    2827 </span><span class="lineNoCov">          0 : }</span>
<a name="2828"><span class="lineNum">    2828 </span>            : </a>
<span class="lineNum">    2829 </span>            : 
<span class="lineNum">    2830 </span>            : AliTPCCorrection * AliTPCcalibDB::GetTPCComposedCorrectionDelta() const{
<span class="lineNum">    2831 </span>            :   /// GetComposedCorrection delta
<span class="lineNum">    2832 </span>            :   /// Delta is time dependent - taken form the CalibTime OCDB entry
<span class="lineNum">    2833 </span>            : 
<span class="lineNum">    2834 </span><span class="lineNoCov">          0 :   if (!fComposedCorrectionArray) return 0;</span>
<span class="lineNum">    2835 </span><span class="lineNoCov">          0 :   if (fRun&lt;0) return 0;</span>
<span class="lineNum">    2836 </span><span class="lineNoCov">          0 :   if (fDriftCorrectionArray.GetValue(Form(&quot;%i&quot;,fRun))==0) return 0;</span>
<span class="lineNum">    2837 </span><span class="lineNoCov">          0 :   if (fComposedCorrectionArray-&gt;GetEntriesFast()&lt;=4) {</span>
<span class="lineNum">    2838 </span><span class="lineNoCov">          0 :     fComposedCorrectionArray-&gt;Expand(5);</span>
<span class="lineNum">    2839 </span><span class="lineNoCov">          0 :     TObjArray * timeArray =(TObjArray*)(fDriftCorrectionArray.GetValue(Form(&quot;%i&quot;,fRun)));</span>
<span class="lineNum">    2840 </span><span class="lineNoCov">          0 :      AliTPCCorrection * correctionTime = (AliTPCCorrection *)timeArray-&gt;FindObject(&quot;FitCorrectionTime&quot;);</span>
<span class="lineNum">    2841 </span><span class="lineNoCov">          0 :      if (correctionTime){</span>
<span class="lineNum">    2842 </span><span class="lineNoCov">          0 :        correctionTime-&gt;Init();</span>
<span class="lineNum">    2843 </span><span class="lineNoCov">          0 :        fComposedCorrectionArray-&gt;AddAt(correctionTime,4); //add time dependent c</span>
<span class="lineNum">    2844 </span><span class="lineNoCov">          0 :      }</span>
<span class="lineNum">    2845 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    2846 </span><span class="lineNoCov">          0 :   return (AliTPCCorrection *)fComposedCorrectionArray-&gt;At(4);  //</span>
<a name="2847"><span class="lineNum">    2847 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2848 </span>            : 
<span class="lineNum">    2849 </span>            : Double_t AliTPCcalibDB::GetGainCorrectionHVandPT(Int_t timeStamp, Int_t run, Int_t sector, Int_t deltaCache, Int_t mode){
<span class="lineNum">    2850 </span>            :   /// Correction for  changes of gain caused by change of the HV and by relative change of the gas density
<span class="lineNum">    2851 </span>            :   /// Function is slow some kind of caching needed
<span class="lineNum">    2852 </span>            :   /// Cache implemented using the static TVectorD
<span class="lineNum">    2853 </span>            :   ///
<span class="lineNum">    2854 </span>            :   /// Input paremeters:
<span class="lineNum">    2855 </span>            :   ///  deltaCache - maximal time differnce above which the cache is recaclulated
<span class="lineNum">    2856 </span>            :   ///  mode       - mode==0 by default return combined correction
<span class="lineNum">    2857 </span>            :   ///                       actual HV and Pt correction has to be present in the run calibration otherwise it is ignored.
<span class="lineNum">    2858 </span>            :   ///                       (retrun value differnt than 1 only in case calibration present in the OCDB entry CalibTimeGain
<span class="lineNum">    2859 </span>            :   ///               mode==1 return combined correction ( important for calibration pass)
<span class="lineNum">    2860 </span>            :   ///                       (in case thereis  no calibration in  CalibTimeGain, default value from the AliTPCParam (Parameters) is used
<span class="lineNum">    2861 </span>            :   ///                       this mode is used in the CPass0
<span class="lineNum">    2862 </span>            :   ///               mode==2 return HV correction
<span class="lineNum">    2863 </span>            :   ///               mode==3 return P/T correction
<span class="lineNum">    2864 </span>            :   ///  Usage in the simulation/reconstruction
<span class="lineNum">    2865 </span>            :   ///  MC:     Qcorr  = Qorig*GetGainCorrectionHVandPT   ( in AliTPC.cxx )
<span class="lineNum">    2866 </span>            :   ///  Rec:    dEdx   = dEdx/GetGainCorrectionHVandPT    ( in aliTPCseed.cxx )
<span class="lineNum">    2867 </span>            : 
<span class="lineNum">    2868 </span>            :   static Float_t gGainCorrection[72];
<span class="lineNum">    2869 </span>            :   static Float_t gGainCorrectionPT[72];
<span class="lineNum">    2870 </span>            :   static Float_t gGainCorrectionHV[72];
<span class="lineNum">    2871 </span>            :   static Int_t    gTimeStamp=-99999999;
<span class="lineNum">    2872 </span>            :   static Bool_t   hasTimeDependent=kFALSE;
<span class="lineNum">    2873 </span><span class="lineCov">     265872 :   if ( TMath::Abs(timeStamp-gTimeStamp)&gt; deltaCache){</span>
<span class="lineNum">    2874 </span>            :     //
<span class="lineNum">    2875 </span>            :     TGraphErrors * graphGHV = 0;
<span class="lineNum">    2876 </span>            :     TGraphErrors * graphGPT = 0;
<span class="lineNum">    2877 </span><span class="lineCov">          3 :     TObjArray *timeGainSplines = GetTimeGainSplinesRun(run);</span>
<span class="lineNum">    2878 </span><span class="lineCov">          3 :     if (timeGainSplines){</span>
<span class="lineNum">    2879 </span><span class="lineNoCov">          0 :       graphGHV  = (TGraphErrors*) timeGainSplines-&gt;FindObject(&quot;GainSlopesHV&quot;);</span>
<span class="lineNum">    2880 </span><span class="lineNoCov">          0 :       graphGPT  = (TGraphErrors*) timeGainSplines-&gt;FindObject(&quot;GainSlopesPT&quot;);</span>
<span class="lineNum">    2881 </span><span class="lineNoCov">          0 :       if (graphGHV) hasTimeDependent=kTRUE;</span>
<span class="lineNum">    2882 </span>            :     }
<span class="lineNum">    2883 </span><span class="lineCov">          6 :     if (!graphGHV) graphGHV = fParam-&gt;GetGainSlopesHV();</span>
<span class="lineNum">    2884 </span><span class="lineCov">          6 :     if (!graphGPT) graphGPT = fParam-&gt;GetGainSlopesPT();</span>
<span class="lineNum">    2885 </span>            :     //
<span class="lineNum">    2886 </span><span class="lineCov">        438 :     for (Int_t isec=0; isec&lt;72; isec++){</span>
<span class="lineNum">    2887 </span><span class="lineCov">        216 :       Double_t HV= GetChamberHighVoltage(run,isec, timeStamp);</span>
<span class="lineNum">    2888 </span><span class="lineCov">        216 :       if (HV&lt;=0){ // check if the HV was available</span>
<span class="lineNum">    2889 </span><span class="lineCov">        216 :         HV=GetChamberCurrentNominalHighVoltage(isec);</span>
<span class="lineNum">    2890 </span><span class="lineCov">       1080 :         AliWarningF(&quot;Could not get proper HV for run,sec,time (%d, %2d, %d), using current nominal voltage: %.2f&quot;, run, isec, timeStamp, HV);</span>
<span class="lineNum">    2891 </span>            : //         AliDCSSensor* sensor = GetChamberHVSensor(isec);
<span class="lineNum">    2892 </span>            : //         if (sensor &amp;&amp; sensor-&gt;GetGraph()==NULL &amp;&amp;  sensor-&gt;GetFit()==NULL){
<span class="lineNum">    2893 </span>            : //           HV=fParam-&gt;GetNominalVoltage(isec);
<span class="lineNum">    2894 </span>            : //         }
<span class="lineNum">    2895 </span><span class="lineCov">        216 :       }</span>
<span class="lineNum">    2896 </span><span class="lineCov">        216 :       Double_t deltaHV= HV - fParam-&gt;GetNominalVoltage(isec);</span>
<span class="lineNum">    2897 </span>            :       Double_t deltaGHV=0;
<span class="lineNum">    2898 </span>            :       Double_t deltaGPT=0;
<span class="lineNum">    2899 </span><span class="lineCov">        432 :       if (graphGHV) deltaGHV = graphGHV-&gt;GetY()[isec]*deltaHV;</span>
<span class="lineNum">    2900 </span><span class="lineCov">        432 :       if (graphGPT) deltaGPT = graphGPT-&gt;GetY()[isec]*GetPTRelative(timeStamp,run,0);</span>
<span class="lineNum">    2901 </span><span class="lineCov">        216 :       gGainCorrection[isec]=(1.+deltaGHV)*(1.+deltaGPT);</span>
<span class="lineNum">    2902 </span><span class="lineCov">        216 :       gGainCorrectionPT[isec]=1+deltaGPT;</span>
<span class="lineNum">    2903 </span><span class="lineCov">        216 :       gGainCorrectionHV[isec]=1+deltaGHV;</span>
<span class="lineNum">    2904 </span>            :     }
<span class="lineNum">    2905 </span><span class="lineCov">          3 :     gTimeStamp=timeStamp;</span>
<span class="lineNum">    2906 </span><span class="lineCov">          3 :   }</span>
<span class="lineNum">    2907 </span><span class="lineCov">     132936 :   if (mode==0){</span>
<span class="lineNum">    2908 </span><span class="lineCov">     132936 :     if (hasTimeDependent) return gGainCorrection[sector];</span>
<span class="lineNum">    2909 </span><span class="lineCov">     265872 :     if (!hasTimeDependent) return 1;</span>
<span class="lineNum">    2910 </span>            :   }
<span class="lineNum">    2911 </span><span class="lineNoCov">          0 :   if (mode==1) return gGainCorrection[sector];</span>
<span class="lineNum">    2912 </span><span class="lineNoCov">          0 :   if (mode==2) return gGainCorrectionPT[sector];</span>
<span class="lineNum">    2913 </span><span class="lineNoCov">          0 :   if (mode==3) return gGainCorrectionHV[sector];</span>
<span class="lineNum">    2914 </span><span class="lineNoCov">          0 :   return 1;</span>
<span class="lineNum">    2915 </span><span class="lineCov">     132936 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
